'From MIT Squeak 0.9.4 (June 1, 2003) [No updates present.] on 23 September 2016 at 8:49:34 pm'!Object subclass: #ColorClock	instanceVariableNames: 'red green blue onoff isSounding buzzerStartTime buzzerDuration '	classVariableNames: ''	poolDictionaries: ''	category: 'Studuino'!Object subclass: #ErrorMessage	instanceVariableNames: ''	classVariableNames: ''	poolDictionaries: ''	category: 'Studuino'!Morph subclass: #ConfigureBoardMorph	instanceVariableNames: 'column titleMorph portName port readouts sensorValues currentState highByte useGoGoProtocol scratchBoardV3 reportRaw scanPorts scanState scanStartMSecs lastPollMSecs '	classVariableNames: ''	poolDictionaries: ''	category: 'Scratch-UI-Panes'!ImageFrameMorph subclass: #DividedImageFrameMorph	instanceVariableNames: 'topSectionHeight middleBarForm leftJointForm rightJointForm leftMargin rightMargin '	classVariableNames: ''	poolDictionaries: ''	category: 'Scratch-UI-Support'!Object subclass: #NotificationMessage	instanceVariableNames: ''	classVariableNames: ''	poolDictionaries: ''	category: 'Studuino'!ExpressionArgMorph subclass: #NumericUpDownMorph	instanceVariableNames: 'menuMorph getMenuSelector specialValue downMorph valid upMorph minimum maximum upButtonOn downButtonOn '	classVariableNames: 'DownForm UpForm '	poolDictionaries: ''	category: 'Scratch-Blocks'!NumericUpDownMorph class	instanceVariableNames: ''!Morph subclass: #ScratchFrameMorph	instanceVariableNames: 'topPane viewerPane scriptsPane stageFrame workPane titlePane libraryPane menuPanel stageButtonsPanel readoutPane logoMorph projectTitleMorph flagButton fillScreenFlag paintingInProgress projectDirectory projectName projectInfo author loginName loginPassword watcherPositions shuffledCostumeNames justSaved viewModeButtons viewMode lastViewMode viewModeButtonsPanel toolbarPanel lastWeDoPoll versionConflict '	classVariableNames: 'BoardStatus COMPort Clipboard DefaultNotes DefaultSprite Fonts FontsXO IsXO LangDic NewScratchProject ScratchServers ScratchSkin ScratchSkinXO TakeOverScreen UseErrorCatcher Version VersionDate VisibleDrives WorkpaneExtent '	poolDictionaries: ''	category: 'Scratch-UI-Panes'!StringMorph subclass: #ScratchMenuTitleMorph	instanceVariableNames: 'target selector '	classVariableNames: 'Enable MenuBarIsActive MenuEnable '	poolDictionaries: ''	category: 'Scratch-UI-Support'!DividedImageFrameMorph subclass: #ScratchScriptEditorMorph	instanceVariableNames: 'thumbnailMorph nameMorph pageViewerMorph rotationButtons lockButton readoutMorphs penReadout currentCategory tabPaneMorph deleteButton '	classVariableNames: ''	poolDictionaries: ''	category: 'Scratch-UI-Panes'!!ScratchScriptEditorMorph commentStamp: '<historical>' prior: 0!I am a viewer for the scripts and media closet of a Scratch object. I have a heading row containing the object name (editable) and a drop-down menu icon. Below that is a scrollable content area.!ScriptableScratchMorph subclass: #ScratchStageMorph	instanceVariableNames: 'zoom hPan vPan penTrailsForm lastPenPositions runningBlocks inProcessStep sensorBoard midiPortNum midiPort notePlayerDict obsoleteSavedState sprites scratchServer isQuarterSize cachedForm showMotorBlocks servoCalibrationBoard '	classVariableNames: ''	poolDictionaries: ''	category: 'Scratch-Objects'!Morph subclass: #SensorBoardMorph	instanceVariableNames: 'column titleMorph portName port readouts sensorValues currentState highByte useGoGoProtocol scratchBoardV3 reportRaw scanPorts scanState scanStartMSecs lastPollMSecs disconnected socketCommand clock socket '	classVariableNames: ''	poolDictionaries: ''	category: 'Scratch-UI-Panes'!Morph subclass: #ServoCalibrateMorph	instanceVariableNames: 'column titleMorph portName port readouts sensorValues currentState highByte useGoGoProtocol scratchBoardV3 reportRaw scanPorts scanState scanStartMSecs lastPollMSecs '	classVariableNames: ''	poolDictionaries: ''	category: 'Scratch-UI-Panes'!DialogBoxMorph subclass: #StringDialog	instanceVariableNames: 'typeinMorph '	classVariableNames: 'ValueOrListName '	poolDictionaries: ''	category: 'Scratch-UI-Dialogs'!StringFieldMorph subclass: #AlphamericFieldMorph	instanceVariableNames: ''	classVariableNames: ''	poolDictionaries: ''	category: 'Scratch-UI-Dialogs'!!Object methodsFor: 'error handling' stamp: 'KK 10/8/2013 19:19'!doesNotUnderstand: aMessage 	 "Error: an attempt was made to send the given message but the receiver does not understand this message. This message is sent by the virtual machine when a message is sent to an object that does not define a method for the message selector."	"Example: 3 width"	(aMessage selector = #flushInputBuffer) ifTrue: [		^ -1.	].	(aMessage selector = #readByteArray) ifTrue: [		^ nil.	]	ifFalse: [		self error: 'Message not understood: ', aMessage selector.		^ aMessage sentTo: self	].! !!ColorClock methodsFor: 'initialization' stamp: 'sk 4/25/2016 14:49'!initialize	"comment stating purpose of message"	red _ 15.	green _ 15.	blue _ 15.	onoff _ 0.	isSounding _ false.! !!ColorClock methodsFor: 'initialization' stamp: 'sk 4/25/2016 18:34'!isElapsed	(buzzerDuration < ((Time millisecondClockValue) - buzzerStartTime)) ifTrue: [		isSounding _ false.		^ true].	^ false! !!ColorClock methodsFor: 'initialization' stamp: 'sk 4/25/2016 15:54'!isSounding	^ isSounding! !!ColorClock methodsFor: 'initialization' stamp: 'sk 4/25/2016 11:54'!onoff: val	"comment stating purpose of message"	onoff _ val.	^ self testModeData! !!ColorClock methodsFor: 'initialization' stamp: 'sk 4/25/2016 11:54'!red: rVal green: gVal blue: bVal	"comment stating purpose of message"	red _ rVal.	green _ gVal.	blue _ bVal.	^ self testModeData! !!ColorClock methodsFor: 'initialization' stamp: 'sk 4/25/2016 14:51'!startBuzzer	"comment stating purpose of message"	isSounding _ true.	buzzerStartTime _ Time millisecondClockValue.! !!ColorClock methodsFor: 'initialization' stamp: 'sk 4/25/2016 18:31'!startBuzzerFor: time	"comment stating purpose of message"	isSounding _ true.	buzzerStartTime _ Time millisecondClockValue.	buzzerDuration _ time * 1000.! !!ColorClock methodsFor: 'initialization' stamp: 'sk 4/25/2016 12:47'!testModeData	"comment stating purpose of message"Transcript show: 'ONOFF: '; show: onoff; cr.	^ (onoff bitShift: 15) + (green bitShift: 8) + (red bitShift: 4)  + blue.! !!CustomMenu methodsFor: 'private' stamp: 'KK 9/14/2013 14:36'!preSelect: action	"Pre-select and highlight the menu item associated with the given action."	| i |	i _ selections indexOf: action ifAbsent: [^ self].	marker ifNil: [self computeForm].	marker _ marker		align: marker topLeft		with: (marker left)@(frame inside top + (marker height * (i - 1))).	selection _ i.! !!ErrorMessage class methodsFor: 'private' stamp: 'sk 9/17/2016 15:18'!show: msgID	"Displaying an error message for a given number."	| dialogBox title message errNo |	title _ 'Undifined error number.'.	message _ 'Unknown error.'.	(msgID = 0) ifTrue: [		title _ 'Could not access localhost'.		message _ 'Please save your project and restart this software.'.	].	(msgID = 1) ifTrue: [		title _ 'Could not access to Studuino'.		message _ 'Make sure Studuino is connected to the PC.'.	].	(msgID = 2) ifTrue: [		title _ 'Could not access to Studuino'.		message _ 'Serial port already in use.', String cr,			'Try quiting any programs that may be using it.'.	].	(msgID = 3) ifTrue: [		title _ 'Could not access to Studuino'.		message _ 'Studuino and PC failed to sync.', String cr,			'Save your project, exit this software, ', String cr,			'reset Studuino, and restart this software.'.	].	(msgID = 4) ifTrue: [		title _ 'Could not access to Studuino'.		message _ 'Disconnected.'.	].	(msgID = 5) ifTrue: [		title _ 'System error'.		message _ 'System file is corrupted.', String cr,			'Save your project, exit this software, ', String cr,			'reinstall Studuino programming environment.'.	].	(msgID = 6) ifTrue: [		title _ 'Could not access to Studuino'.		message _ 'COM port error.'.	].	(msgID = 7) ifTrue: [		title _ 'Build error'.		message _ 'Main function is not defined.'.	].	(msgID = 8) ifTrue: [		title _ 'Build error'.		message _ 'Script too big.'.	].	(msgID = 9) ifTrue: [		title _ 'Build error'.		message _ 'An error has occurred in the archiving process. Please re-install.'.	].	(msgID = 10) ifTrue: [		title _ 'Build error'.		message _ 'An error has occurred in the object copy1 process. Please re-install.'.	].	(msgID = 11) ifTrue: [		title _ 'Build error'.		message _ 'An error has occurred in the object copy2 process. Please re-install.'.	].	(msgID > 16) & (msgID < 24) ifTrue: [		errNo _ msgID bitAnd: 7.		"Mask error category"		title _ 'Build error'.		message _ nil.		(errNo bitAnd: 16r01) = 1 ifTrue: [			message isNil ifTrue: [				message _ 'Undefined function.']			ifFalse: [				message _ message, String cr, 'Undefined function.']].		((errNo bitShift: -1) bitAnd: 16r01) = 1 ifTrue: [			message isNil ifTrue: [				message _ 'Multiple functions with same name.']			ifFalse: [				message _ message, String cr, 'Multiple functions with same name.']].		((errNo bitShift: -2) bitAnd: 16r01) = 1 ifTrue: [			message isNil ifTrue: [				message _ 'Unknown error.']			ifFalse: [				message _ message, String cr, 'Unknown error.']]].	(msgID = 100) ifTrue: [		title _ 'Transfer failed'.		message _ 'Failed to transfer a program. Please retry.'].	(msgID = 101) ifTrue: [		title _ 'Time out error.'.		message _ 'Operation timed out.'].	dialogBox _ DialogBoxMorph new.	dialogBox withButtonsForYes: false no: false okay: true cancel: false.	dialogBox title: title.	dialogBox message: message.	dialogBox openInWorld.		" Display Dialogbox "	dialogBox centerOnScreen.	" Set center position "	dialogBox world doOneCycle.! !!Morph methodsFor: 'initialization' stamp: 'KK 1/11/2013 14:01'!initialize	bounds _ 0@0 corner: 50@40.	owner _ nil.	submorphs _ Array empty.	fullBounds _ nil.	color _ Color blue.	flags _ 0.	properties _ nil.! !!BlockMorph methodsFor: 'accessing' stamp: 'KK 8/20/2014 11:51'!closestAttachTargetIn: newOwner	"Answer the closest block attachment point among the blocks and stack submorphs of the given morph. Answer nil if there are no blocks close enough to attach myself to."	| xThresh yThresh attachPoints best bestDist targetP dist ref topUsed bottomUsed target targetOwner connectionY |	xThresh _ 65.	((self isKindOf: CBlockMorph) and: [(self nestedBlockAt: (self top + self topBarHeight)) isNil])		ifTrue: [yThresh _ 25]		ifFalse: [yThresh _ 14].	topUsed _ false.	bottomUsed _ false.	attachPoints _ OrderedCollection new:100.	newOwner submorphsDo: [:m |		((m ~~ self) and:		 [(m ~~ (self bottomBlock)) and:		 [(m ~~ (self topBlock)) and:		 [(m ~~ (self owner)) and:		 [(m isKindOf: BlockMorph) and:		 [m isReporter not]]]]]) ifTrue: [			m blockAttachPoints: attachPoints]].	((self isKindOf: HatBlockMorph) or: [(self ownerThatIsA: HatBlockMorph) ~= nil]) ifTrue: [		"if I am a HatBlock or the bottom block of a HatBlock stack, I can only attach to the top block of a stack"		attachPoints _ attachPoints select: [:assoc |			(assoc value owner = newOwner) and:			[assoc key y = assoc value top]]].	(self isStop or:[self bottomBlock isStop]) ifTrue: [		"I am a stop block; I can't attach to the top of a stack"		attachPoints _ attachPoints select: [:assoc |			assoc key y ~= assoc value top]].	(self topBlock isForever not and: [self bottomBlock isForever]) ifTrue: [		"My bottom block is a forever; I can't attach to the top of a stack"		attachPoints _ attachPoints select: [:assoc |			assoc key y ~= assoc value top]].	best _ nil.	bestDist _ 10000.	attachPoints do: [:assoc |		targetP _ assoc key.		ScratchTranslator isRTL			ifTrue: [ref _ self right]			ifFalse: [ref _ self left].		((ref - targetP x) abs < xThresh)			ifTrue: [				(((self top - targetP y) abs < yThresh) or: [self nextBlock isNil and: [(self bottom - targetP y) abs < yThresh]])					ifTrue: [  "targetP is within sticking range"						ScratchTranslator isRTL							ifTrue: [dist _ (self topRight - targetP) r]							ifFalse: [dist _ (self position - targetP) r].						dist < bestDist ifTrue: [							((self top - targetP y) abs < yThresh) ifTrue: [topUsed _ true. bottomUsed _ false].							(self nextBlock isNil and: [(self bottom - targetP y) abs < yThresh]) ifTrue: [topUsed _ false. bottomUsed _ true].							best _ assoc.							bestDist _ dist]]]].	"special case for the servomotor blocks"	(self isKindOf: CommandBlockMorph) ifTrue: [	best ifNotNil: [		(self selector = #motorNo:degree:) ifTrue: [		" Top block is servomotor block "			(self isOnlyServo: self) ifFalse: [				" include other blocks. "				target _ best value.				(target isKindOf: CommandBlockMorph) ifTrue: [					(target selector = #motorNo:degree:) ifTrue: [					" Target block is servomotor block "						(targetOwner _ target ownerThatIsA: CBlockMorph) ifNotNil: [							((targetOwner selector = #doSvmSyncMotion) | (targetOwner selector = #doSvmSyncMotion2)) ifTrue: [	" included synchro-servo block "								(target position x = targetOwner position x) ifFalse: [									best _ nil.				" DnD invalid. "								].							].						].					].					((target selector = #doSvmSyncMotion) | (target selector = #doSvmSyncMotion2)) ifTrue: [						connectionY _ best key y.						((connectionY ~= target top) & (connectionY ~= target bottom)) ifTrue: [							best _ nil.				" DnD invalid. "						].					].				].			].		]		ifFalse: [										" Top block is not servomotor block "			target _ best value.			(target isKindOf: CommandBlockMorph) ifTrue: [				(target selector = #motorNo:degree:) ifTrue: [					" Target block is servomotor block "					(targetOwner _ target ownerThatIsA: CBlockMorph) ifNotNil: [						((targetOwner selector = #doSvmSyncMotion)  | (targetOwner selector = #doSvmSyncMotion2)) ifTrue: [	" included synchro-servo block "							(target position x = targetOwner position x) ifFalse: [								best _ nil.				" DnD invalid. "							].						].					].				].				((target selector = #doSvmSyncMotion) | (target selector = #doSvmSyncMotion2)) ifTrue: [					connectionY _ best key y.					((connectionY ~= target top) & (connectionY ~= target bottom)) ifTrue: [						best _ nil.				" DnD invalid. "					].				].			].		].	]].	"special case for the auto-wrapping of c-shaped/if-else blocks"	(self isKindOf: CBlockMorph) ifTrue: [	best ifNotNil: [		bottomUsed ifTrue: [				(best value owner isKindOf: BlockMorph) ifTrue: [				self stretchHeight: 0. ^ best _ nil]].		(self isStopOrForever or:[self bottomBlock isStopOrForever]) ifTrue: [			bottomUsed ifTrue: [					self stretchHeight: 0.					^ best _ nil]].		((best key y = best value top) and: [((self isForever or:[self bottomBlock isForever])) and: [(self nestedBlockAt: (best key y)) isNil not]])					ifTrue: [self stretchHeight: 0. ^ best _ nil].		(self nestedBlockAt: (best key y)) ifNil: [			bottomUsed ifTrue: [					self stretchHeight: 0.					(best key y = best value bottom) ifTrue: [^ best _ nil].					((best key y = best value top) and: [(best value owner isKindOf: BlockMorph)]) ifTrue: [^ best _ nil].					((best key y = best value bottom) and: [(best value owner isKindOf: BlockMorph) not]) ifTrue: [^ best _ nil]].			topUsed ifTrue: [				((best key y = best value bottom) and: [best value nextBlock isNil not]) ifTrue: [self stretchHeight: 0. ^ best _ nil].				"((best key y = best value top) and: [(best value owner isKindOf: BlockMorph)]) ifTrue: [self stretchHeight: 0. ^ best _ nil]."				(best key y = best value top) ifTrue: [					" If I am synchro motion morph... "					((self selector = #doSvmSyncMotion) | (self selector = #doSvmSyncMotion2)) ifTrue: [						(best value selector = #motorNo:degree:) ifFalse: [	" The bounded morph is not servomotor block. "							^ best _ nil.						]						ifTrue: [	" The bounded morph is servomotor block "							(best value isOnlyServo: best value) ifFalse: [	" with other block "								^ best _ nil.							]						].					].					self stretchHeight: best value fullBounds height - 17. ^ best				]			].			self stretchHeight: 0]].	best ifNil: [		self stretchHeight: 0]].	 ^ best! !!BlockMorph methodsFor: 'drawing' stamp: 'KK 8/29/2013 15:41'!drawOn: aCanvas 	| c |	self computeHighlightColors.	c _ FormCanvas extent: self extent depth: 32.	c _ c copyOffset: self topLeft negated.	self isReporter ifTrue: [		self drawSmoothTopEdgeOn: c.		self drawReporterBodyOn: c.		self drawSmoothBottomEdgeOn: c.		^ self].	self isStop ifTrue: [		self drawTopEdgeOn: c.		self drawStopBodyOn: c.		self drawSmoothBottomEdgeOn: c.		self drawFinalOn: aCanvas fromCanvas: c.		^ self].	self drawTopEdgeOn: c.	self drawBodyOn: c.	self drawBottomEdgeOn: c.	self drawFinalOn: aCanvas fromCanvas: c.! !!BlockMorph methodsFor: 'dropping/grabbing' stamp: 'KK 4/30/2014 10:57'!justDroppedInto: newOwner event: evt	"Handle being dropped into a new situation."	| frame targetAssoc targetP targetBlock bottomBlockUsed upperBlock |	bottomBlockUsed _ false.	(frame _ newOwner ownerThatIsA: ScratchFrameMorph)		ifNotNil: [frame projectModified].	((self ownerThatIsA: ScratchViewerMorph) notNil) ifTrue: [		"delete myself when dropped in the blocks palette area"		self delete.		self receiver blocksBin changed.		^ self].	"blocks cannot be dropped onto the stage"	(owner isKindOf: ScratchStageMorph) ifTrue: [		^ self rejectDropEvent: evt].	"okay to drop blocks into the world during development"	((owner == World) and: [Preferences noviceMode not]) ifTrue: [^ self].	((owner isKindOf: ScratchScriptsMorph) or:	 [(owner isKindOf: BlockMorph) or:	 [(owner isKindOf: ScratchStageMorph) and: [self isReporter]]]) ifFalse: [		^ self rejectDropEvent: evt].	self isReporter ifTrue: [^ self handleReporterDrop].	targetAssoc _ self closestAttachTargetIn: newOwner.	targetAssoc ifNil: [		(self bottomBlock isKindOf: CBlockMorph) ifFalse: [			targetAssoc _ self bottomBlock closestAttachTargetIn: newOwner.			targetAssoc ifNotNil:[				bottomBlockUsed _ true.				(targetAssoc value owner isKindOf: BlockMorph) ifTrue:[					targetAssoc _ nil]]]].	targetAssoc ifNil: [^ self].	"make sure no processes are running"	self = self topBlock ifTrue: [self stop].	targetP _ targetAssoc key.	targetBlock _ targetAssoc value.	targetP y = targetBlock top		ifTrue: [			"c-shaped block should nest the target block"			"((bottomBlockUsed not) and: [((targetBlock owner isKindOf: BlockMorph) not) and: [(self isKindOf: CBlockMorph)]]) ifTrue:["			((bottomBlockUsed not) and: [(self isKindOf: CBlockMorph)]) ifTrue:[				(targetBlock owner isKindOf: BlockMorph)					ifTrue: [(targetBlock owner) attachBlock: self]					ifFalse: [self position: (targetP x - self bracketThickness)@(targetP y - self topBarHeight - 3)].				self attachBlockNested: targetBlock. ^ self].			"for all other non-c-shaped blocks"			(bottomBlockUsed or:[((targetBlock owner isKindOf: BlockMorph) not) and: [(self isKindOf: CBlockMorph) not]]) ifTrue:[				ScratchTranslator isRTL					ifTrue: [self bottomBlock position: (targetP x - self bottomBlock width) @ (targetP y - (self bottomBlock height - 4))]					ifFalse: [self bottomBlock position: targetP x @ (targetP y - (self bottomBlock height - 4))].				upperBlock _ self bottomBlock owner.				[upperBlock isKindOf: BlockMorph] whileTrue: [					upperBlock nextBlock ifNotNil:[						ScratchTranslator isRTL							ifTrue: [upperBlock position: (targetP x - upperBlock width) @ (upperBlock nextBlock position y - (upperBlock height - 4))]							ifFalse: [upperBlock position: targetP x @ (upperBlock nextBlock position y - (upperBlock height - 4))].						upperBlock _ upperBlock owner]]].			((bottomBlockUsed not) and: [targetBlock owner isKindOf: BlockMorph]) ifTrue:[				ScratchTranslator isRTL					ifTrue: [self position: (targetP x - self width) @ (targetP y - (self height - 4))]					ifFalse: [self position: targetP x @ (targetP y - (self height - 4))]].			(targetBlock owner isKindOf: BlockMorph) ifTrue:[				ScratchTranslator isRTL					ifTrue: [self topBlock position: (targetP x - self topBlock width) @ targetP y]					ifFalse: [self topBlock position: targetP x @ targetP y].				targetBlock owner attachBlock: self topBlock].			ScratchTranslator isRTL				ifTrue: [targetBlock position: (targetP x - targetBlock width) @ (self bottomBlock position y + self bottomBlock height + 4)]				ifFalse: [targetBlock position: targetP x @ (self bottomBlock position y + self bottomBlock height + 4)].			((bottomBlockUsed not) and: [((targetBlock owner isKindOf: BlockMorph) not) and: [(self isKindOf: CBlockMorph)]]) ifFalse:[				self bottomBlock attachBlock: targetBlock]]		ifFalse: [			self assert: [(self isKindOf: HatBlockMorph) not].  "I am not a HatBlockMorph"			ScratchTranslator isRTL				ifTrue: [self position: (targetP - (self width @0))]				ifFalse: [self position: targetP].			targetBlock attachBlock: self].! !!BlockMorph methodsFor: 'event handling' stamp: 'KK 10/9/2013 11:17'!rightButtonMenu	| menu |	menu _ CustomMenu new."	menu add: 'help' action: #presentHelpScreen."	(owner isKindOf: ScratchBlockPaletteMorph) ifFalse: [		menu addLine.		menu add: 'duplicate' action: #duplicate.			(self owner isKindOf: BlockMorph) ifFalse: [  "we can't yet delete a blocks inside a script"			menu add: 'delete' action: #delete]].	DebugMenu ifTrue: [		menu addLine.		menu add: 'show tuples' action: #showTuples].		menu localize; invokeOn: self.! !!BlockMorph methodsFor: 'event handling' stamp: 'sk 3/9/2016 17:17'!startDrag: evt	"ArTeC: If owner is ScratchBlockPaletteMorph then I check IOPort Array and decide DragNDrop. "	| startEvt rootForGrab partsID |	(owner isKindOf: ScratchBlockPaletteMorph) ifTrue:[		(self isKindOf: EventHatMorph) ifFalse: [(self color = (Color r: 0.6 g: 0.6 b: 0.6)) ifTrue: [^ self.].			((self selector = 'motorNo:degree:') | 			 (self selector = 'motorNo:power:') | 			 (self selector = 'motorNo:dcMotorOn:') |			 (self selector = 'motorNo:dcMotorOff:') |			 (self selector = 'buzzerPin:freq:') |			 (self selector = 'buzzerPin:') |			 (self selector = 'ledPin:onOff:') |		 	 (self selector = 'lightSensor:') |		 	 (self selector = 'touchSensor:') |		 	 (self selector = 'soundSensor:') |		 	 (self selector = 'refPhotosensor:') |		 	 (self selector = 'accelerometer:') |		 	 (self selector = 'onBoardButton:')) ifTrue: [				self submorphs do: [ :sub |					(sub isKindOf: ChoiceArgMorph) ifTrue: [						sub choice = '' ifTrue: [							^ self.						]					]				]			].			(self selector = 'ledColor:onOff:') ifTrue: [				partsID _ 16r05.			" 01:DC 02:SV 03:LED 04:BZR 05:CLED 10:LS 11:TS 12:SS 13:IRS 14:3S 15:BTN"				" If colorLED connect with board, IOPort No.12 is sure to set colorLED ID(0x05)"				((IOPort at: 12) ~= partsID) ifTrue: [					^ self.				]			]		]	].	evt hand toolType ifNil: [		startEvt _ evt hand firstClickEvent.		startEvt ifNil: [startEvt _ evt].		rootForGrab _ self rootForGrabOf: self.		rootForGrab ifNil: [^ self].		evt hand grabMorph: rootForGrab.		rootForGrab position: evt hand position + (rootForGrab topLeft - startEvt cursorPoint)].	self handleTool: evt hand toolType hand: evt hand.! !!BlockMorph methodsFor: 'private' stamp: 'KK 8/2/2013 13:05'!printArduCodeOn: aStream indent: indent	"Append a human-readable string for this block on the given stream."	indent timesRepeat: [aStream nextPutAll: '    '].	aStream nextPutAll: self class name; cr.	self nextBlock ifNotNil: [self nextBlock printArduCodeOn: aStream indent: indent].! !!BlockMorph methodsFor: 'private' stamp: 'KK 1/15/2015 11:48'!printArduCodeSubmorph: aMorph on: aStream	(aMorph isKindOf: ArgMorph) ifTrue: [aMorph printArgOn: aStream].	(aMorph isKindOf: BlockMorph) ifTrue: [		aMorph printArduCodeOn: aStream indent: 0.		aStream skip: -1.  "remove carriage return"		].	(aMorph isKindOf: StringMorph) ifTrue: [		((self selector = 'motorNo:degree:') & ServomotorSynchroMotion) ifTrue: ["			Transcript show:aMorph contents;cr."			(aMorph contents = ', SVRANGE(') ifTrue: [				aStream					nextPutAll: 'degree[';					nextPutAll: ((ServomotorNumber-1) asString);					nextPutAll: '] = ';					nextPutAll: 'SVRANGE('.			].			(aMorph contents = '));') ifTrue: [				aStream					nextPutAll: ');'.			].			^ ''		].		((aMorph contents = '?')) " | (aMorph contents = '%'))"			ifTrue: [aStream skip: -1].	"remove space before ? or %"		(aMorph contents = 'else') ifTrue: [ ^ ''].		aStream nextPutAll: aMorph contents.].! !!BlockMorph methodsFor: 'private' stamp: 'KK 1/14/2015 17:56'!printCodeSubmorph: aMorph on: aStream	(aMorph isKindOf: ArgMorph) ifTrue: [aMorph printArgOn: aStream].	(aMorph isKindOf: BlockMorph) ifTrue: [		aStream nextPut: $(.		aMorph printCodeOn: aStream indent: 0.		aStream skip: -1.  "remove carriage return"		aStream nextPut: $)].	(aMorph isKindOf: StringMorph) ifTrue: [		((aMorph contents = '?') | (aMorph contents = '%'))			ifTrue: [aStream skip: -1].	"remove space before ? or %"		aStream nextPutAll: aMorph contents].! !!BorderedMorph methodsFor: 'drawing' stamp: 'KK 4/25/2014 12:59'!drawOn: aCanvas 	"Draw a rectangle with a solid, inset, or raised border.	Note: the raised border color is generated from the receiver's own color,	while the inset border color is generated from the color of its owner.	This behavior is visually more consistent. Thanks to Hans-Martin Mosner."	| insetColor |	borderWidth = 0 ifTrue: [  "no border"		"Note: This is the hook for border styles.			When converting to the new borders we'll just put 0 into the borderWidth"		super drawOn: aCanvas.		^ self].	borderColor == #raised ifTrue: [		"Use a hack for now"		aCanvas fillRectangle: self bounds color: color.		^ aCanvas frameAndFillRectangle: bounds			fillColor: Color transparent			borderWidth: borderWidth			topLeftColor: (borderWidth = 1 ifTrue: [color twiceLighter]										ifFalse: [color lighter])			bottomRightColor: (borderWidth = 1 ifTrue: [color twiceDarker]										ifFalse: [color darker])].	borderColor == #inset ifTrue: [		insetColor _ owner colorForInsets.		aCanvas fillRectangle: self bounds color: color.		^ aCanvas frameAndFillRectangle: bounds			fillColor: Color transparent			borderWidth: borderWidth			topLeftColor: (borderWidth = 1 ifTrue: [insetColor twiceDarker]										ifFalse: [insetColor darker])			bottomRightColor: (borderWidth = 1 ifTrue: [insetColor twiceLighter]										ifFalse: [insetColor lighter])].	"solid color border"	aCanvas fillRectangle: (self bounds insetBy: borderWidth) color: color.	aCanvas frameAndFillRectangle: bounds		fillColor: Color transparent		borderWidth: borderWidth		borderColor: borderColor.! !!ArgMorph methodsFor: 'other' stamp: 'KK 5/1/2014 15:14'!labelMorph	^ labelMorph! !!ArgMorph methodsFor: 'other' stamp: 'KK 8/2/2013 12:58'!printArduArgOn: aStream	"Print this argument morph on the given stream."	| v |	self labelMorph ifNotNil: [		v _ self evaluate.		(v isKindOf: String)			ifTrue: [aStream nextPutAll: '"', v, '"']			ifFalse: [aStream nextPutAll: v asString]].! !!ArgMorph methodsFor: 'other' stamp: 'KK 7/7/2014 10:16'!printArgOn: aStream	"Print this argument morph on the given stream."	| v |	self labelMorph ifNotNil: [		v _ self evaluate.		((owner selector = 'motorNo:degree:') & ServomotorSynchroMotion) ifTrue: [			aStream				nextPutAll: (v asString).		]		ifFalse: [			(v isKindOf: String)				ifTrue: [aStream nextPutAll: v ]				ifFalse: [aStream nextPutAll: v asString]		].	].! !!BooleanArgMorph methodsFor: 'other' stamp: 'KK 8/2/2013 12:58'!printArduArgOn: aStream	"Print this argument morph on the given stream."	aStream nextPutAll: 'false'.! !!ChoiceArgMorph methodsFor: 'event handling' stamp: 'sk 9/21/2016 19:25'!handlesMouseDown: evt	^ evt hand toolType isNil and:		[(self topLeft corner: self bottomRight) containsPoint: evt cursorPoint]! !!ChoiceArgMorph methodsFor: 'other' stamp: 'KK 8/2/2013 12:58'!printArduArgOn: aStream	"Print this argument morph on the given stream."	aStream nextPutAll: '"', self labelMorph contents, '"'.! !!ChoiceArgMorph methodsFor: 'other' stamp: 'KK 7/7/2014 09:11'!printArgOn: aStream	| arg |	"Print this argument morph on the given stream."	arg _ self labelMorph contents.	((owner selector = 'motorNo:degree:') & (ServomotorSynchroMotion)) ifTrue: [		aStream			nextPutAll: 'port[';			nextPutAll: ((ServomotorNumber-1) asString);			nextPutAll: '] = PORT_';			nextPutAll: (arg asString);			nextPutAll: ';';			nextPutAll: String tab.		^ self.	].	((owner selector ~= 'setVar:to:') & (owner selector ~= 'changeVar:by:') &	 (owner selector ~= 'append:toList:') & (owner selector ~= 'deleteLine:ofList:') &	 (owner selector ~= 'insert:at:ofList:') & (owner selector ~= 'setLine:ofList:to:') &	 (owner selector ~= 'getLine:ofList:') & (owner selector ~= 'lineCountOfList:') &	 (owner selector ~= 'list:contains:'))	 ifTrue: [		((arg = 'abs') | (arg = 'sqrt') | (arg = 'sin') | (arg = 'cos') | (arg = 'tan') |		 (arg = 'asin') | (arg = 'acos') | (arg = 'atan') | (arg = 'ln') | (arg = 'log'))		ifTrue: [ arg _ arg asUppercase. ].		(arg = 'e ^') ifTrue:[ arg _ 'POWE'. ].		(arg = '10 ^') ifTrue: [ arg _ 'POW10'. ].		((arg = 'on') | (arg = 'off'))		ifTrue: [ arg _ arg asUppercase. ]."		(arg = 'D0') ifTrue:[ arg _ 'DIG0' ].		(arg = 'D1') ifTrue:[ arg _ 'DIG1' ].		(arg = 'D2') ifTrue:[ arg _ 'DIG2' ].		(arg = 'D3') ifTrue:[ arg _ 'DIG3' ].		(arg = 'D4') ifTrue:[ arg _ 'DIG4' ].		(arg = 'D5') ifTrue:[ arg _ 'DIG5' ].		(arg = 'D6') ifTrue:[ arg _ 'DIG6' ].		(arg = 'D7') ifTrue:[ arg _ 'DIG7' ].		(arg = 'D8') ifTrue:[ arg _ 'DIG8' ].		(arg = 'D9') ifTrue:[ arg _ 'DIG9' ].		(arg = 'D10') ifTrue:[ arg _ 'DIG10' ].		(arg = 'D11') ifTrue:[ arg _ 'DIG11' ].		(arg = 'D12') ifTrue:[ arg _ 'DIG12' ].		(arg = 'D13') ifTrue:[ arg _ 'DIG13' ].		(arg = 'D14') ifTrue:[ arg _ 'DIG14' ].		(arg = 'D15') ifTrue:[ arg _ 'DIG15' ].		(arg = 'D16') ifTrue:[ arg _ 'DIG16' ].		(arg = 'D17') ifTrue:[ arg _ 'DIG17' ].		(arg = 'D18') ifTrue:[ arg _ 'DIG18' ].		(arg = 'D19') ifTrue:[ arg _ 'DIG19' ].		(arg = 'A0') ifTrue:[ arg _ 'ANA0' ].		(arg = 'A1') ifTrue:[ arg _ 'ANA1' ].		(arg = 'A2') ifTrue:[ arg _ 'ANA2' ].		(arg = 'A3') ifTrue:[ arg _ 'ANA3' ].		(arg = 'A4') ifTrue:[ arg _ 'ANA4' ].		(arg = 'A5') ifTrue:[ arg _ 'ANA5' ].		(arg = 'A6') ifTrue:[ arg _ 'ANA6' ].		(arg = 'A7') ifTrue:[ arg _ 'ANA7' ]."	].	aStream nextPutAll: arg.! !!ColorArgMorph methodsFor: 'other' stamp: 'KK 8/2/2013 12:59'!printArduArgOn: aStream	"Print this argument morph on the given stream."	aStream nextPutAll: 'c[',		(self hexFor: color red),		(self hexFor: color green),		(self hexFor: color blue),		']'.! !!ColorArgMorph methodsFor: 'other' stamp: 'KK 8/2/2013 13:02'!printArgOn: aStream	"Print this argument morph on the given stream."	aStream nextPutAll:		(self hexFor: color red),		(self hexFor: color green),		(self hexFor: color blue).! !!CommandBlockMorph methodsFor: 'initialization' stamp: 'KK 9/20/2013 17:58'!initialize	super initialize.	commandSpec _ ''.	argMorphs _ OrderedCollection new.	receiver _ nil.	selector _ nil.	isTimed _ false.! !!CommandBlockMorph methodsFor: 'evaluation' stamp: 'KK 5/1/2014 17:09'!coerceArgs: argList	"Answer an arugments array in which all arguments that should be numbers have been coerced to numbers if necessary."	| args specialCommands numFlags |	args _ argList asArray.	specialCommands _ #(		append:toList: deleteLine:ofList: getLine:ofList: insert:at:ofList: list:contains: setLine:ofList:to:		lookLike: showBackground:		playSound: doPlaySoundAndWait		setVar:to:).	(specialCommands includes: selector) ifFalse: [		"ensure args are numbers where numbers are expected"		numFlags _ self numberArgFlags.		1 to: args size do: [:i |			(numFlags at: i) ifTrue: [args at: i put: (args at: i) asNumberNoError]]].	^ args! !!CommandBlockMorph methodsFor: 'evaluation' stamp: 'KK 5/1/2014 17:11'!evaluateWithArgs: rawArgs	"Evalue this block with the given argument list."	| args |	"special case for math and boolean infix operators"	selector isInfix ifTrue: [^ self evaluateInfixWithArgs: rawArgs].	args _ self coerceArgs: rawArgs..	"special case for unary operators"	(#(abs not rounded sqrt truncated) includes: selector) ifTrue: [^ args first perform: selector].	^ receiver perform: selector withArguments: args! !!CommandBlockMorph methodsFor: 'menus' stamp: 'KK 10/9/2013 11:15'!rightButtonMenu	| menu sFrame choice spec |	menu _ CustomMenu new."	menu add: 'help' action: #presentHelpScreen."	(owner isKindOf: ScratchBlockPaletteMorph) ifFalse: [		menu addLine.		(#(+ - * / \\) includes: selector) ifTrue: [			#(+ - * / mod) with: #(+ - * / \\) do: [:s :op | menu add: s action: op]].		(#(< = >) includes: selector) ifTrue: [			#(< = >) do: [:op | menu add: op action: op]].		(#(& |) includes: selector) ifTrue: [			#(and or) with: #(& |) do: [:s :op | menu add: s action: op]].		menu addLine.		menu add: 'duplicate' action: #duplicate.		(self owner isKindOf: BlockMorph) ifFalse: [  "can't yet delete a blocks inside a script"			menu add: 'delete' action: #delete]].	sFrame _ self ownerThatIsA: ScratchFrameMorph.	(sFrame notNil and: [#(sensor: sensorPressed:) includes: selector]) ifTrue: [		menu addLine.		menu add: 'show ScratchBoard watcher' action: #showSensorBoard."		sFrame workPane scratchServer			ifNil: [menu add: 'enable remote sensor connections' action: #enableRemoteSensors]			ifNotNil: [menu add: 'disable remote sensor connections' action: #exitScratchSession]"	].	DebugMenu ifTrue: [		menu addLine.		menu add: 'show tuples' action: #showTuples].		(choice _ menu localize; startUp) ifNil: [^ self].	(#(presentHelpScreen duplicate delete) includes: choice) ifTrue: [^ self perform: choice].	choice = #showSensorBoard ifTrue: [sFrame showSensorBoard. ^ self].	choice = #enableRemoteSensors ifTrue: [sFrame enableRemoteSensors. ^ self].	choice = #exitScratchSession ifTrue: [sFrame exitScratchSession. ^ self].	choice = #showTuples ifTrue: [^ self showTuples].	"change operator"	spec _ '%n ', choice, ' %n'.	'\\' = choice	ifTrue: [spec _ ScratchTranslator translationFor: '%n mod %n'].	'&' = choice	ifTrue: [spec _ ScratchTranslator translationFor: '%b and %b'].	'|' = choice	ifTrue: [spec _ ScratchTranslator translationFor: '%b or %b'].	self commandSpec: spec.	self selector: choice.! !!CommandBlockMorph methodsFor: 'private' stamp: 'sk 2/8/2016 20:24'!addCommandIcons	"Add additional icons to certain blocks. Do nothing if this isn't one of those blocks."	| f m |	#turnLeft: = selector ifTrue: [		f _ ScratchFrameMorph skinAt: #turnCCW ifAbsent: [^ self].		m _ self firstSubmorph delete.		self addMorphFront: (ImageMorph new form: f).		self addMorphFront: m].	#turnRight: = selector ifTrue: [		f _ ScratchFrameMorph skinAt: #turnCW ifAbsent: [^ self].		m _ self firstSubmorph delete.		self addMorphFront: (ImageMorph new form: f).		self addMorphFront: m].	#stopAll = selector ifTrue: [		f _ ScratchFrameMorph skinAt: #stopButton ifAbsent: [^ self].		self addMorphBack: (ImageMorph new form: f)].	#motorNo:degree: = selector ifTrue: [		f _ ScratchFrameMorph skinAt: #sv ifAbsent: [^ self].		self addMorphFront: (ImageMorph new form: f)].	#setServoSpeed:d2:d4:d7:d8:d9:d10:d11:d12: = selector ifTrue: [		f _ ScratchFrameMorph skinAt: #sv ifAbsent: [^ self].		self addMorphFront: (ImageMorph new form: f)].	#motorNo:power: = selector ifTrue: [		f _ ScratchFrameMorph skinAt: #DC1 ifAbsent: [^ self].		self addMorphFront: (ImageMorph new form: f)].	#motorNo:dcMotorOff: = selector ifTrue: [		f _ ScratchFrameMorph skinAt: #DC3 ifAbsent: [^ self].		self addMorphFront: (ImageMorph new form: f)].	#motorNo:dcMotorOn: = selector ifTrue: [		f _ ScratchFrameMorph skinAt: #DC2 ifAbsent: [^ self].		self addMorphFront: (ImageMorph new form: f)].	#buzzerPin:freq: = selector ifTrue: [		f _ ScratchFrameMorph skinAt: #buzzer ifAbsent: [^ self].		self addMorphFront: (ImageMorph new form: f)].	#buzzerPin: = selector ifTrue: [		f _ ScratchFrameMorph skinAt: #buzzer2 ifAbsent: [^ self].		self addMorphFront: (ImageMorph new form: f)].	#ledPin:onOff: = selector ifTrue: [		f _ ScratchFrameMorph skinAt: #LED1 ifAbsent: [^ self].		self addMorphFront: (ImageMorph new form: f)].	#boardLED:onOff: = selector ifTrue: [		f _ ScratchFrameMorph skinAt: #LED1 ifAbsent: [^ self].		self addMorphFront: (ImageMorph new form: f)].	#ledColor:onOff: = selector ifTrue: [		f _ ScratchFrameMorph skinAt: #LED2 ifAbsent: [^ self].		self addMorphFront: (ImageMorph new form: f)].! !!CommandBlockMorph methodsFor: 'private' stamp: 'KK 9/26/2013 17:23'!argMorphToReplace: aMorph	"Answer a new argument morph to be used to replace the given morph. Answer nil if the given morph is not one of my argMorphs."	| i argSpecs spec argM defaults v |	i _ argMorphs indexOf: aMorph ifAbsent: [^ nil].	argSpecs _ (CommandBlockMorph parseCommandSpec: commandSpec) select: [:s | CommandBlockMorph isArgSpec: s].	i > argSpecs size ifTrue: [^ nil].	argM _ self argMorphFor: (argSpecs at: i).	(#setVar:to: = selector and: [(argSpecs at: i) = '%n']) ifTrue: [		^ argM numExpression: 0].	spec _ ScriptableScratchMorph blockSpecDict at: selector ifAbsent: [^ argM].	defaults _ receiver defaultArgsFor: spec.	i <= defaults size ifTrue: [		v _ defaults at: (argPermutation indexOf: i).		(v isKindOf: String)			ifTrue: [				(argM isKindOf: ExpressionArgMorph)					ifTrue: [argM defaultValueFromSpec: v localized]					ifFalse: [argM defaultValue: v localized]]			ifFalse: [argM defaultValue: v]].	^ argM! !!CommandBlockMorph methodsFor: 'private' stamp: 'KK 8/29/2013 16:47'!canBecomeWatcher	"I determine which blocks can become watchers."	| i |	i _ selector asString findAnySubStr: #('mouse' 'key' 'touching' 'distance') startingAt: 1.	^ (self isReporter) &	   (self argumentCount <= 1) &	   ((#(not atRandom abs rounded lineCountOfList: stringLength:) includes: selector) not) &	   (i > selector asString size)! !!CommandBlockMorph methodsFor: 'private' stamp: 'KK 4/25/2014 16:47'!isOnlyServo: aMorph	" Blocks are mass of servomotor block ?  "	|  nextBlock |	nextBlock _ aMorph submorphs at:1.	" Check next blok is end of block "	(nextBlock isKindOf:CommandBlockMorph) ifTrue: [		" Next block is kind of CommandBlockMorph "		(nextBlock isKindOf: ReporterBlockMorph) ifTrue: [			" But, next block is kind of ReportBlockMorph "			" So, next block is nothing. "			^ true.		]	]	ifFalse: [		" Next block is NOT kind of CommandBlockMorph "		" So, next block is nothing. "		^ true.	].	" Next block is not servomoter "	(nextBlock selector = #motorNo:degree:) ifFalse: [ ^ false. ].	" Next block is servomotor. so, check after the next block... "	^ (self isOnlyServo: nextBlock).	! !!CommandBlockMorph methodsFor: 'private' stamp: 'KK 7/7/2014 09:19'!printArduCodeOn: aStream indent: indent	"Append a human-readable string for this block on the given stream."	| nextB hasFinalSpace |	indent timesRepeat: [aStream nextPutAll: '    '].	nextB _ self nextBlock.	hasFinalSpace _ false.	(self selector = 'contentsOfList:') ifTrue: [ aStream nextPutAll: 'listItem(&ARLIST_'. ].	(self isKindOf: VariableBlockMorph) ifTrue: [ aStream nextPutAll: 'ARVAL_'. ].	" To add offset degree info, copy PIN name to new ChoiceArgMorph "	(self selector = 'motorNo:degree:') ifTrue: [		ServomotorSynchroMotion ifTrue: [			ServomotorNumber _ ServomotorNumber + 1.		].	].	submorphs do: [:m |		m ~~ nextB ifTrue: [			self printArduCodeSubmorph: m on: aStream.			hasFinalSpace _ true.			"aStream space"]].	"hasFinalSpace ifTrue: [aStream skip: -1]."	(self selector = 'contentsOfList:') ifTrue: [ aStream nextPutAll: ',1)'. ].	(selector = 'ledColor:onOff:')	ifTrue: [		((IOPort at: 11) = 5) ifTrue: [ aStream nextPutAll: ', 0);' ]		ifFalse: [ aStream nextPutAll: ', 1);' ].	].		aStream cr.	self nextBlock ifNotNil: [self nextBlock printArduCodeOn: aStream indent: indent].! !!CommandBlockMorph methodsFor: 'private' stamp: 'sk 2/18/2016 10:11'!uncoloredArgMorphFor: t1 	| t2 |	" Check if a single character or a string."	(t1 size = 2) ifTrue: [		t2 _ t1 at: 2.	]	ifFalse: [		t2 _ t1 copyFrom: 2 to: (t1 size).].	$a = t2 ifTrue: [^ AttributeArgMorph new choice: 'volume'].	$b = t2 ifTrue: [^ BooleanArgMorph new].	$B = t2 ifTrue: [^ ChoiceArgMorph new getOptionsSelector: #bzrPinNo;		 choice: 'A0'].	$c = t2 ifTrue: [^ ColorArgMorph new showPalette: true].	$C = t2 ifTrue: [^ ColorArgMorph new showPalette: false].	$d = t2 ifTrue: [^ ExpressionArgMorphWithMenu new numExpression: '0';		 menuSelector: #directionMenu].	$D = t2 ifTrue: [^ ExpressionArgMorphWithMenu new numExpression: '48';		 menuSelector: #midiDrumMenu].	$e = t2 ifTrue: [^ EventTitleMorph new].	$E = t2 ifTrue: [^ NumericUpDownMorph new  setDefault:10 min:0 max:20 width:15 isEdit:false].	$f = t2 ifTrue: [^ ChoiceArgMorph new getOptionsSelector: #mathFunctionNames;		 choice: 'sqrt'].	$F = t2 ifTrue: [^ NumericUpDownMorph new  setDefault:90 min:0 max:180 width:20 isEdit:true].	$g = t2 ifTrue: [^ ChoiceArgMorph new getOptionsSelector: #graphicEffectNames;		 choice: 'color'].	$H = t2 ifTrue: [^ ChoiceArgMorph new getOptionsSelector: #hookupSensorNames].	$h = t2 ifTrue: [^ ChoiceArgMorph new getOptionsSelector: #hookupBooleanSensorNames].	$I = t2 ifTrue: [^ ExpressionArgMorphWithMenu new numExpression: '1';		 menuSelector: #midiInstrumentMenu]."	$i = t2 ifTrue: [^ ExpressionArgMorphWithMenu new numExpression: '1';		 menuSelector: #listIndexMenu]."	$i = t2 ifTrue: [^ ExpressionArgMorph new numExpression: '10'].	$j = t2 ifTrue: [^ ChoiceArgMorph new getOptionsSelector: #dcMotorNo;		 choice: 'PIN'].	$J = t2 ifTrue: [^ ChoiceArgMorph new getOptionsSelector: #svMotorNo;		 choice: 'PIN'].	$k = t2 ifTrue: [^ ChoiceArgMorph new getOptionsSelector: #keyNames;		 choice: 'space'].	$L = t2 ifTrue: [^ ChoiceArgMorph new getOptionsSelector: #listVarMenu].	$l = t2 ifTrue: [^ ChoiceOrExpressionArgMorph new getOptionsSelector: #costumeNames;		 choice: 'costume1'].	$m = t2 ifTrue: [^ SpriteArgMorph new].	$M = t2 ifTrue: [^ ChoiceArgMorph new getOptionsSelector: #motorNames].	$n = t2 ifTrue: [^ ExpressionArgMorph new numExpression: '10'].	$N = t2 ifTrue: [^ ExpressionArgMorphWithMenu new numExpression: '60';		 menuSelector: #noteSelector].	$o = t2 ifTrue: [^ ChoiceArgMorph new getOptionsSelector: #ledOnOff;		 choice: 'on'].	$O = t2 ifTrue: [^ ChoiceArgMorph new getOptionsSelector: #hookupSoundPin].	$p = t2 ifTrue: [^ ChoiceArgMorph new getOptionsSelector: #ledPinNo;		 choice: 'A0'].	'p1' = t2 ifTrue: [^ ChoiceArgMorph new getOptionsSelector: #boardLED;			choice: 'Red(D5)'.].	$P = t2 ifTrue: [^ ChoiceArgMorph new getOptionsSelector: #hookupLightPin].	$q = t2 ifTrue: [^ ChoiceArgMorph new getOptionsSelector: #moveDirection;		 choice: 'Forward'].	$s = t2 ifTrue: [^ ExpressionArgMorph new stringExpression: ''].	$S = t2 ifTrue: [^ ChoiceOrExpressionArgMorph new getOptionsSelector: #soundNames;		 choice: 'pop'].	$t = t2 ifTrue: [^ ChoiceArgMorph new getOptionsSelector: #dcMotorOn;		 choice: 'cw.'].	$T = t2 ifTrue: [^ ChoiceArgMorph new getOptionsSelector: #dcMotorOff;		 choice: 'Brake'].	$v = t2 ifTrue: [^ ChoiceArgMorph new getOptionsSelector: #varNamesMenu;		 choice: ''].	$V = t2 ifTrue: [^ ChoiceArgMorph new getOptionsSelector: #hookupTouchPin].	$w = t2 ifTrue: [^ ChoiceArgMorph new getOptionsSelector: #ledColor;		 choice: 'White'].	$W = t2 ifTrue: [^ ChoiceArgMorph new getOptionsSelector: #motorDirection].	$x = t2 ifTrue: [^ ChoiceOrExpressionArgMorph new getOptionsSelector: #sceneNames;		 choice: ''].	$X = t2 ifTrue: [^ ChoiceArgMorph new getOptionsSelector: #hookupARButton]."	$y = t2 ifTrue: [^ ExpressionArgMorphWithMenu new numExpression: '1';		 menuSelector: #listIndexForDeleteMenu]."	$y = t2 ifTrue: [^ ExpressionArgMorph new numExpression: '10'].	$Y = t2 ifTrue: [^ ChoiceArgMorph new getOptionsSelector: #hookupARSensorXYZ].	$z = t2 ifTrue: [^ ChoiceArgMorph new getOptionsSelector: #hookupARSensorNames].	$Z = t2 ifTrue: [^ ChoiceArgMorph new getOptionsSelector: #hookupIRPin].	'Z1' = t2 ifTrue: [^ ChoiceArgMorph new getOptionsSelector: #clockVars].^ ExpressionArgMorph new numExpression: '10'! !!CBlockMorph methodsFor: 'drawing' stamp: 'KK 2/27/2015 13:55'!drawOn: aCanvas 	| c |	topBarBottom _ self top + self topBarHeight.	self isForever		ifTrue: [blockBottom _ self bottom - 3]		ifFalse: [blockBottom _ self bottom - 7].	self computeHighlightColors.	c _ FormCanvas extent: self extent depth: 32.	c _ c copyOffset: self topLeft negated.	self drawTopEdgeOn: c.	self drawTopBarOn: c.	self drawVerticalBarOn: c.	self drawBottomBarOn: c.	self drawFinalOn: aCanvas fromCanvas: c.! !!CBlockMorph methodsFor: 'private' stamp: 'KK 8/20/2014 11:46'!attachBlock: aBlockMorph	"Attach the given block to me. Assume the block has been positioned correctly."	aBlockMorph top >= (self bottom - CBlockBracketThickness)		ifTrue: [			self addMorph: aBlockMorph.			nextBlock _ aBlockMorph.		]		ifFalse: [			((self selector = #doSvmSyncMotion) | (self selector = #doSvmSyncMotion2)) ifTrue: [				" self is Servomotor synchro motion block. "				(aBlockMorph selector = #motorNo:degree:) ifTrue: [					" aBlockMorph is servomotor block. "					(self isOnlyServo: aBlockMorph) ifTrue: [						self addMorph: aBlockMorph.						nestedBlock _ aBlockMorph.					].				].			]			ifFalse: [				self addMorph: aBlockMorph.				nestedBlock _ aBlockMorph.			]		].! !!CBlockMorph methodsFor: 'private' stamp: 'sk 5/20/2016 21:21'!printArduCodeOn: aStream indent: indent	| localIndent localArg strDelayMsecPerDeg |	"Append a human-readable string for this block on the given stream."	indent timesRepeat: [aStream nextPutAll: '    '].	localIndent _ indent.	"if (T/F) for(;;)"	(selector = 'doForeverIf')	ifTrue: [		aStream nextPutAll: 'for(;;) {'.		aStream cr.		localIndent _ localIndent + 1.		(localIndent) timesRepeat: [aStream nextPutAll: '    '].	].	((selector = 'doSvmSyncMotion') | (selector = 'doSvmSyncMotion2'))	ifTrue: [		submorphs do: [:m |			(m ~~ nestedBlock) & (m ~~ nextBlock) & ((m isKindOf: StringMorph) not) ifTrue:	[				(m isKindOf: NumericUpDownMorph) ifTrue: [					ServomotorNumber _ 0.					ServomotorSynchroMotion _ true.					strDelayMsecPerDeg _ m labelMorph contents.				] ifFalse: [					localArg _ WriteStream on: (String new: 10000).					self printArduCodeSubmorph: m on: localArg.					strDelayMsecPerDeg _ localArg contents.					ServomotorNumber _ 0.					ServomotorSynchroMotion _ true.				].			].		].	] ifFalse: [		(selector = 'doRepeat') ifTrue: [			FirstSubMorphOfdoRepeat _ true.		" First sub morph? "			aStream nextPutAll: 'int loopCounter'.			aStream nextPutAll: NumberOfdoRepeat asString.			aStream nextPutAll: ' = '.			submorphs do: [:m |				(m ~~ nestedBlock) & (m ~~ nextBlock) ifTrue: [					self printArduCodeSubmorph: m on: aStream.					(FirstSubMorphOfdoRepeat) ifTrue: [						aStream nextPutAll: ';';cr.						indent timesRepeat: [aStream nextPutAll: '    '].						FirstSubMorphOfdoRepeat _ false.					].				].			].			" aStream is {for (int i = 0; i <} "			aStream nextPutAll: 'loopCounter'.			aStream nextPutAll: NumberOfdoRepeat asString.			aStream nextPutAll: '; i++) {'.			" Increment number of doRepeat Block "			NumberOfdoRepeat _ NumberOfdoRepeat + 1.			localIndent _ localIndent + 1.		]		ifFalse: [			submorphs do: [:m |				(m ~~ nestedBlock) & (m ~~ nextBlock) ifTrue: [					self printArduCodeSubmorph: m on: aStream.					aStream space ]].			localIndent _ localIndent + 1.		].	].	aStream cr.	nestedBlock ifNotNil: [nestedBlock printArduCodeOn: aStream indent: localIndent].	"if (T/F) for(;;)"	(selector = 'doForeverIf')	ifTrue: [		localIndent _ localIndent - 1.		(localIndent) timesRepeat: [aStream nextPutAll: '    '].		aStream nextPutAll: '}'; cr.	].	" For Studuino mini Clock. "	(BoardType = 1) ifTrue: [	((selector = 'doForever') & ((IOPort at: 19) = 6)) ifTrue: [		localIndent timesRepeat: [aStream nextPutAll: '    '].		aStream nextPutAll: 'board.sleep();'; cr.].].	"for(;;) / for(int i = 0;i < N;i++) / if (T/F) for(;;) / if(T/F) / while(T/F)"	((selector = 'doForever') | (selector = 'doRepeat') | (selector = 'doForeverIf') | (selector = 'doIf') | (selector = 'doUntil'))	ifTrue: [		localIndent _ localIndent - 1.		(localIndent) timesRepeat: [aStream nextPutAll: '    '].		aStream nextPutAll: '}'; cr.	].	(selector = 'doSvmSyncMotion')	ifTrue: [		ServomotorSynchroMotion _ false.		(localIndent) timesRepeat: [aStream nextPutAll: '    '].		aStream			nextPutAll: 'board.SyncServomotors(port, degree, ';			nextPutAll: ServomotorNumber asString;			nextPutAll: ', SYNCSVRANGE(scratchRound(';			nextPutAll: strDelayMsecPerDeg asString;			nextPutAll: '))+3);'; cr.	].	(selector = 'doSvmSyncMotion2')	ifTrue: [		ServomotorSynchroMotion _ false.		(localIndent) timesRepeat: [aStream nextPutAll: '    '].		aStream			nextPutAll: 'board.SyncServomotors(port, degree, ';			nextPutAll: ServomotorNumber asString;			nextPutAll: ', SYNCSVRANGE(scratchRound(20-';			nextPutAll: strDelayMsecPerDeg asString;			nextPutAll: '))+3);'; cr.	].	nextBlock ifNotNil: [nextBlock printArduCodeOn: aStream indent: indent].! !!CBlockMorph methodsFor: 'evaluation' stamp: 'KK 5/1/2014 17:12'!evaluateWithArgs: rawArgs	| |	^ receiver doSvmSyncMotion: rawArgs.! !!ConfigureBoardMorph methodsFor: 'initialization' stamp: 'KK 8/16/2013 17:29'!addReadoutLabeled: aString	"Add a readout row with the given label. Answer the stringmorph that's the readout."	| row box readout |	row _ AlignmentMorph newRow color: column color; inset: 2.	row addMorphBack: (Morph new color: column color; extent: 1@3). "spacer"	row addMorphBack: (StringMorph contents: aString capitalized font: (StrikeFont fontName: 'VerdanaBold' size: 10)).	row addMorphBack: (AlignmentMorph new color: column color; extent: 10@1; hResizing: #spaceFill).  "spacer"	box _ WatcherReadoutFrameMorph new		extent: 42@14;		color: (ScriptableScratchMorph blockColorFor: 'sensing').	readout _ StringMorph contents: '0' font: (StrikeFont fontName: 'VerdanaBold' size: 10).	readout color: Color white.	box addMorph: readout.	row addMorphBack: box.	column addMorphBack: row.	^ readout! !!ConfigureBoardMorph methodsFor: 'initialization' stamp: 'KK 8/16/2013 17:29'!addReadouts	| readoutNames |	readoutNames _ #(		'A0'		'A1'		'A2'		'A3'		'A4'		'A5'		'A6'		'A7'	).	column _ AlignmentMorph newColumn		centering: #center;		hResizing: #spaceFill;		vResizing: #shrinkWrap;		color: (Color r: (193/255) g: (196/255) b: (199/255));		borderWidth: 2;		borderColor: (Color r: (148/255) g: (145/255) b: (145/255));		useRoundedCorners;		inset: 3.	titleMorph _ StringMorph		contents: ''		font: (StrikeFont fontName: 'VerdanaBold' size: 10).	column addMorph: titleMorph.	self updateTitle.	column addMorphBack: (Morph new color: column color; extent: 5@3).  "spacer"	self removeAllMorphs.	readouts _ readoutNames collect: [:i |		(i size = 1)			ifTrue:[self addReadoutLabeled: i]			ifFalse:[self addReadoutLabeled: i localized]].	column position: self position - 2.	self addMorph: column.	self extent: column extent - 4.! !!ConfigureBoardMorph methodsFor: 'initialization' stamp: 'KK 8/16/2013 17:29'!data: d msgID: id	"I make message and send it to board."	| mid high low msgh msgl msg carry |"self halt."	mid _ id bitShift: 4.			" mid = id << 4 "	high _ d bitShift: -8.		" high = d >> 8"	carry _ d bitShift: -7.		" low side carry = d >> 7"	carry _ carry bitAnd: 16r01.	" carry = carry & 0x01"	high _ high + carry.		" high = high + carry"	high _ high bitAnd: 16r0F.	" high = high & 0x0F"	low _ d bitAnd: 16r7F.		" low = d & 0x7F"	msgh _ 16r80 + mid + high.	" msgh = 0x80 + mid + high"	msgl _ low.					" msgl = low"	msg _ #(0 0) asByteArray.	msg at: 1 put:msgh.	msg at: 2 put: msgl."Transcriptshow:msgh;show:', ';show:msgl;cr."	port nextPutAll: msg.! !!ConfigureBoardMorph methodsFor: 'initialization' stamp: 'KK 8/16/2013 18:23'!initialize	super initialize.	sensorValues _ Array new: 16 withAll: 0.	currentState _ #idle.	highByte _ 0.	useGoGoProtocol ifNil: [useGoGoProtocol _ false].	scratchBoardV3 _ false.	reportRaw _ false.	scanState _ #off.	self addReadouts.! !!ConfigureBoardMorph methodsFor: 'accessing' stamp: 'KK 8/16/2013 17:29'!isScriptable	"I am not scriptable."	^ false! !!ConfigureBoardMorph methodsFor: 'sensor ops' stamp: 'KK 8/16/2013 17:29'!privateSensor: t1 	| t2 t3 |	t2 _ (t1 asInteger max: 1)				min: 8.	useGoGoProtocol		ifFalse: [scratchBoardV3				ifTrue: [t2 _ #(8 6 7 4 5 3 2 1 ) at: t2]				ifFalse: [t2 _ #(1 2 3 4 5 6 7 8 ) at: t2]]."				ifFalse: [t2 _ #(5 6 7 8 1 2 3 4 ) at: t2]]."	t3 _ sensorValues at: t2.	reportRaw _ true.			" return Rawdata "	reportRaw ifTrue: [^ t3].	scratchBoardV3		ifTrue: 			[t2 = 6 ifTrue: [^ self scaleLight: t3].			t2 = 7 ifTrue: [^ self scaleSound: t3]].	t3 > 1020 ifTrue: [t3 _ 1023].! !!ConfigureBoardMorph methodsFor: 'sensor ops' stamp: 'KK 8/16/2013 17:29'!sensor: sensorIndex	"Answer the value of the virtual sensor with the given index. Sensors are numbered 1-8."	^ self privateSensor: sensorIndex! !!ConfigureBoardMorph methodsFor: 'sensor ops' stamp: 'KK 8/16/2013 17:29'!startReadingData	"Ensure that the serial port is open, turn off all motors and put them into a known state, and begin streaming sensor data."	self portIsOpen ifFalse: [^ self].  "could not open the serial port"	currentState _ #idle.	sensorValues atAllPut: 0.	scratchBoardV3 _ false.	self startStreamingSensors: 0.  "in case board was left in streaming mode"	port flushInputBuffer.	useGoGoProtocol ifTrue: [		1 to: 6 do: [:motor |			self turnOffMotor: motor.			self thisWayMotor: motor.			self setPower: 3 motor: motor.			self turnOffMotor: motor].		self startStreamingSensors: 16rFF].  "all 8 sensors"! !!ConfigureBoardMorph methodsFor: 'sensor ops' stamp: 'KK 8/16/2013 17:29'!stopReadingData	"Turn off all motors, stop streaming data, and close the port."	(port notNil and: [port isOpen]) ifTrue: [		useGoGoProtocol ifTrue: [			1 to: 6 do: [:motor | self turnOffMotor: motor].			self startStreamingSensors: 0]].  "turn off streaming"	self closePort.! !!ConfigureBoardMorph methodsFor: 'motor ops' stamp: 'KK 8/16/2013 17:29'!coastToStopMotor: motorNum	"Let the given motor coast to a stop."	self portIsOpen ifFalse: [^ self].	self selectMotor: motorNum.	port nextPutAll: #(84 254 84) asByteArray.! !!ConfigureBoardMorph methodsFor: 'motor ops' stamp: 'KK 8/16/2013 17:29'!reverseMotor: motorNum	"Reverse the direction of the given motor."	self portIsOpen ifFalse: [^ self].	self selectMotor: motorNum.	port nextPutAll: #(84 254 72) asByteArray.! !!ConfigureBoardMorph methodsFor: 'motor ops' stamp: 'KK 8/16/2013 17:29'!selectMotor: anInteger	"Select the motor to which subsequent motor commands will be addressed. Motors are numbered 1-6."	| motorNum msg |	motorNum _ (anInteger truncated - 1 max: 0) min: 7. "motor bit index"	msg _ #(84 254 128 0) asByteArray.	msg at: 4 put: (1 bitShift: motorNum).	port nextPutAll: msg.! !!ConfigureBoardMorph methodsFor: 'motor ops' stamp: 'KK 8/16/2013 17:29'!setPower: aNumber motor: motorNum	"Set the power of the given motor to 0 to 7."	| power msg |	self portIsOpen ifFalse: [^ self].	self selectMotor: motorNum.	power _ (aNumber truncated max: 0) min: 7.	msg _ #(84 254 0) asByteArray.	msg at: 3 put: 96 + (power bitShift: 2).	port nextPutAll: msg.! !!ConfigureBoardMorph methodsFor: 'motor ops' stamp: 'KK 8/16/2013 17:29'!thatWayMotor: motorNum	"Set motor direction to that way."	self portIsOpen ifFalse: [^ self].	self selectMotor: motorNum.	port nextPutAll: #(84 254 80) asByteArray.! !!ConfigureBoardMorph methodsFor: 'motor ops' stamp: 'KK 8/16/2013 17:29'!thisWayMotor: motorNum	"Set motor direction to this way."	self portIsOpen ifFalse: [^ self].	self selectMotor: motorNum.	port nextPutAll: #(84 254 76) asByteArray.! !!ConfigureBoardMorph methodsFor: 'motor ops' stamp: 'KK 8/16/2013 17:29'!turnOffMotor: motorNum	self portIsOpen ifFalse: [^ self].	self selectMotor: motorNum.	port nextPutAll: #(84 254 68) asByteArray.! !!ConfigureBoardMorph methodsFor: 'motor ops' stamp: 'KK 8/16/2013 17:29'!turnOnMotor: motorNum	self portIsOpen ifFalse: [^ self].	self selectMotor: motorNum.	port nextPutAll: #(84 254 64) asByteArray.! !!ConfigureBoardMorph methodsFor: 'stepping' stamp: 'KK 8/16/2013 17:29'!step	"Update my title and sensor readouts. If scanning for ports, keep scanning."	| frame |"Transcriptshow:'SensorBoardMorph::step';cr."	#checkData = scanState ifTrue: [self scanForPort].	self portIsOpen		ifTrue: [self processIncomingData]		ifFalse: [port _ nil].	self updateTitle.	1 to: 8 do: [:i |		(readouts at: i) contents: (self privateSensor: i) truncated printString.		(scratchBoardV3 and: [i = 4])			ifTrue: [(readouts at: i) contents: ((self privateSensor: i) < 10) printString]. "button"		frame _ (readouts at: i) owner.		(frame respondsTo: #fixLayout) ifTrue: [frame fixLayout]].! !!ConfigureBoardMorph methodsFor: 'stepping' stamp: 'KK 8/16/2013 17:29'!stepTime	^ 50! !!ConfigureBoardMorph methodsFor: 'serial port' stamp: 'KK 8/16/2013 17:29'!closePort	port ifNotNil: [		self data:0 msgID:7.	"Send End of Communication to PC"		port flushInputBuffer.		port close].	port _ nil.	currentState _ #idle.	sensorValues atAllPut: 0.	scratchBoardV3 _ false.	1 to: 8 do: [:i | (readouts at: i) contents: '0'].	scanState _ #off.	self step.! !!ConfigureBoardMorph methodsFor: 'serial port' stamp: 'KK 8/16/2013 17:29'!openPort: aString	"Close the serial port if it is open, then open the port with the given name and initialize streaming of sensor data. Answer true if the operation was successful."	| baudRate portNum numStart |	baudRate _ useGoGoProtocol ifTrue: [9600] ifFalse: [38400].	self closePort.	portName _ aString.	ScratchPlugin serialPortOpsAvailable		ifTrue: [			port _ SerialPort2 new openPortNamed: portName baud: baudRate.			port isOpen ifFalse: [port _ nil. ^ false].			port setOption: 20 to: 1.  "set DTR high"			port setOption: 21 to: 0]  "set RTS low"		ifFalse: [			portNum _ 1.			numStart _ (1 to: portName size) detect: [:i | (portName at: i) isDigit] ifNone: [0].			numStart > 0 ifTrue: [portNum _ (portName copyFrom: numStart to: portName size) asNumber].			port _ SerialPort new				baudRate: baudRate;				inputFlowControlType: 2;				openPort: portNum ifFail: [^ false]].	"initialize polling state"	lastPollMSecs _ Time millisecondClockValue.	^ true! !!ConfigureBoardMorph methodsFor: 'serial port' stamp: 'KK 8/16/2013 17:29'!portIsOpen	^ port notNil and: [port isOpen]! !!ConfigureBoardMorph methodsFor: 'serial port' stamp: 'KK 8/16/2013 17:29'!portNames	"Answer a collection of possible port names for the Scratch sensor board. Filter out modems and PDA cradles."	ScratchPlugin serialPortOpsAvailable ifFalse: [		^ (1 to: 32) collect: [:i | 'COM', i printString]].	^ SerialPort2 portNames reject: [:n |		(n asLowercase includesSubString: 'modem') or:		[n asLowercase includesSubString: 'pda-sync']].! !!ConfigureBoardMorph methodsFor: 'serial port' stamp: 'KK 8/16/2013 17:29'!resetPort	"If the port is closed, do nothing. If it is open, close and reopen it. This can be used to reset the Prolific USB serial driver if it misbehaves."	self portIsOpen ifFalse: [^ self].	portName ifNil: [^ self].	self closePort.	self openPort: portName.	scanState _ #on.	self step.! !!ConfigureBoardMorph methodsFor: 'serial port' stamp: 'KK 8/16/2013 17:29'!scanForPort	"Try to find the serial port that the sensor board is attached to. This is incremental--each time it is called it does the next task."	"Details: scanState is one of: #(off, start, checkData, on). scanPorts is a list of port names to try. Attempt to open each port in turn, then wait for a while and see if Scratch Sensor data of the right form has arrived."	| msecs buf i |	#off = scanState ifTrue: [self scanNextPort].	#on = scanState ifTrue: [  "if port is open, close it and start a new scan"		scanPorts _ nil.		self scanNextPort].	#start = scanState ifTrue: [		(scanPorts isNil or: [scanPorts size = 0]) ifTrue: [			scanPorts _ self portNames asOrderedCollection].		scanPorts size = 0 ifTrue: [^ self scanNextPort].		self openPort: scanPorts removeFirst.		self portIsOpen ifFalse: [^ self].		scanState _ #checkData.		scanStartMSecs _ Time millisecondClockValue.		^ self].	#checkData = scanState ifTrue: [		msecs _ Time millisecondClockValue - scanStartMSecs.		(self portIsOpen not or: [msecs > 4000]) ifTrue: [^ self scanNextPort].		port nextPut: 1.  "send poll byte"		((buf _ port readByteArray) size < 10) ifTrue: [^ self].  "no data yet"		"check that the data is in Scratch Sensor Board format"		i _ (buf first bitAnd: 128) > 0 ifTrue: [1] ifFalse: [2].		[i < (buf size - 1)] whileTrue: [			(((buf at: i) bitAnd: 128) > 0 and:			 [((buf at: i + 1) bitAnd: 128) = 0]) ifFalse: [^ self scanNextPort].			i _ i + 2].		scanState _ #on].! !!ConfigureBoardMorph methodsFor: 'serial port' stamp: 'KK 8/16/2013 17:29'!scanNextPort	"Called during port scanning. The current port does not seem to be a ScratchBoard. Close it and try the next port in the list."	self closePort.	scanState _ #start.! !!ConfigureBoardMorph methodsFor: 'serial port' stamp: 'KK 8/16/2013 17:29'!selectPort	| menu choice |	self stopReadingData.	self portNames size = 0 ifTrue: [^ DialogBoxMorph inform: 'No serial ports found'].	menu _ CustomMenu new.	self portNames do: [:n | menu add: n action: n].	choice _ menu startUp.	choice ifNil: [^ self].	self openPort: choice.	self startReadingData.	scanState _ #on.	ResetCounter _ 0.! !!ConfigureBoardMorph methodsFor: 'serial port' stamp: 'KK 8/16/2013 17:29'!tryToOpenPort	"Attempt to open the port. If successful, or if the port was open already, answer true. Otherwise, answer false."	(port notNil and: [port isOpen and: [scanState = #on]]) ifTrue: [^ true].  "already open"	self scanForPort.	^ port notNil and: [port isOpen]! !!ConfigureBoardMorph methodsFor: 'serial port' stamp: 'KK 8/16/2013 17:29'!useGoGoProtocol	self stopReadingData.	useGoGoProtocol _ true.	scratchBoardV3 _ false.	self startReadingData.! !!ConfigureBoardMorph methodsFor: 'serial port' stamp: 'KK 8/16/2013 17:29'!useScratchboardProtocol	self stopReadingData.	useGoGoProtocol _ false.	self startReadingData.! !!ConfigureBoardMorph methodsFor: 'event handling' stamp: 'KK 8/16/2013 17:29'!handlesMouseDown: evt	^ true! !!ConfigureBoardMorph methodsFor: 'event handling' stamp: 'KK 8/16/2013 17:29'!mouseDown: evt	evt rightButtonPressed | evt shiftPressed		ifTrue: [Sensor waitNoButton. ^ self rightButtonMenu].	evt hand toolType = 'CutTool' ifTrue: [		evt shiftPressed ifFalse: [evt hand toolType: nil].		ScratchFrameMorph putInClipboard: self.		^ self delete].	evt hand waitForClicksOrDrag: self event: evt.! !!ConfigureBoardMorph methodsFor: 'event handling' stamp: 'KK 8/16/2013 17:29'!mouseHold: evt	self rightButtonMenu.! !!ConfigureBoardMorph methodsFor: 'event handling' stamp: 'KK 8/16/2013 17:29'!preemptsMouseDown: evt	^ true! !!ConfigureBoardMorph methodsFor: 'event handling' stamp: 'KK 8/16/2013 17:29'!rightButtonMenu	| menu |	menu _ CustomMenu new.	Sensor shiftPressed		ifTrue: [			reportRaw				ifTrue: [menu add: 'stop reporting raw data' action: #toggleRawMode]				ifFalse: [menu add: 'report raw data' action: #toggleRawMode].			useGoGoProtocol				ifTrue: [menu add: 'use Scratch board' action: #useScratchboardProtocol]				ifFalse: [menu add: 'use GoGo board' action: #useGoGoProtocol]]		ifFalse: [			menu add: 'select serial/USB port' action: #selectPort.			self portIsOpen				ifTrue: [menu add: 'close port' action: #stopReadingData].			menu addLine.			menu add: 'hide' action: #delete].	menu localize; invokeOn: self.! !!ConfigureBoardMorph methodsFor: 'event handling' stamp: 'KK 8/16/2013 17:29'!toggleRawMode	reportRaw _ reportRaw not.! !!ConfigureBoardMorph methodsFor: 'dropping/grabbing' stamp: 'KK 8/16/2013 17:29'!justDroppedInto: newOwner event: evt	"Only allow embedding into the stage; otherwise, float (i.e. be a submorph of the world)."	(newOwner isKindOf: ScratchStageMorph) ifFalse: [ "only embed in the work pane"		self world addMorph: self].! !!ConfigureBoardMorph methodsFor: 'object i/o' stamp: 'KK 8/16/2013 17:29'!fieldsVersion	^ 1! !!ConfigureBoardMorph methodsFor: 'object i/o' stamp: 'KK 8/16/2013 17:29'!initFieldsFrom: anObjStream version: classVersion	super initFieldsFrom: anObjStream version: classVersion.	anObjStream nextField.  "skip old portNum field"	self addReadouts.! !!ConfigureBoardMorph methodsFor: 'object i/o' stamp: 'KK 8/16/2013 17:29'!storeFieldsOn: anObjStream	super storeFieldsOn: anObjStream.	anObjStream putField: 1.  "old portNum instance variable"! !!ConfigureBoardMorph methodsFor: 'private' stamp: 'KK 8/16/2013 17:29'!ping	"Answer true if a GoGoBoard is connected to my serial port."	| buf |	port flushInputBuffer.	port nextPutAll: #(84 254 0) asByteArray.	buf _ port next: 3.	^ buf = #(85 255 170) asByteArray! !!ConfigureBoardMorph methodsFor: 'private' stamp: 'KK 8/16/2013 17:29'!processGoGoByte: aByte	"Process one byte of the incoming data stream from a GoGoBoard."	"Details: This code recognizes three-byte sensor update messages starting with 16r0C using a simple, three-state finite state machine. We assume that sensor updates are always contiguous--that is, replies to motor or other GoGo board commands will not be inserted between the bytes of any given three-byte sensor update message. The sensor number is the top three bits of the byte two. The data value is the bottom two bits of byte two plus all eight bits of byte three."	| sensorNum val |	currentState = #idle ifTrue: [ 		aByte = 16r0C ifTrue: [currentState _ #startByteSeen].		^ self].	currentState = #startByteSeen ifTrue: [		highByte _ aByte.		currentState _ #highByteSeen.		^ self].	currentState = #highByteSeen ifTrue: [		"final byte of message: report the sensor value"		sensorNum _ (highByte bitShift: -5) + 1.		val _ ((highByte bitAnd: 3) bitShift: 8) + aByte.		(sensorNum between: 1 and: 8) ifTrue: [			sensorValues at: sensorNum put: val].		currentState _ #idle].! !!ConfigureBoardMorph methodsFor: 'private' stamp: 'KK 8/16/2013 17:29'!processIncomingData	"Process incoming bytes from the serial port."	"Details: To work around a problem with the Prolific USB-Serial drivers on some Windows machines, a strict turn-taking polling protocol is used. A poll byte is sent, the ScratchBoard sends a response, and after a small delay (to be sure that all the data from the last poll has arrived, another poll is sent. The goal is to never allow more that few bytes to accumulate in the serial input buffer and to avoid sending a poll byte while data is arriving. However, since different versions of the ScratchBoard may send different amounts of data, we don't want to hard-code the number of reply bytes. Thus"	| buf msecsSinceLastPoll |	(self portIsOpen and: [#on = scanState]) ifFalse: [^ self].	useGoGoProtocol ifTrue: [		buf _ port readByteArray.		buf do: [:b | self processGoGoByte: b].		^ self].	msecsSinceLastPoll _ Time millisecondClockValue - lastPollMSecs.	msecsSinceLastPoll < 20 ifTrue: [^ self].	buf _ port readByteArray."Transcriptshow:'SensorBoardMorph::processIncomingData';cr."	" Corresponding disconnection  "	(buf size = 0)	ifTrue: [	" The case of disconnection "Transcriptshow:'reset port : ';show:ResetCounter;cr.		" Increment ResetCounter "		ResetCounter _ (ResetCounter + 1).		(ResetCounter = 10) ifTrue: [				ResetCounter _ 0.	" Initialize ResetCounter "			self resetPort.		" reset port. "		].	]	ifFalse: [ 	" The case of connection "		ResetCounter _ 0.		" Initialize ResetCounter "	].	buf do: [:b | self processScratchByte: b]."	port nextPut: 1."	"send a ScratchBoard V4 poll byte"	lastPollMSecs _ Time millisecondClockValue.! !!ConfigureBoardMorph methodsFor: 'private' stamp: 'KK 8/16/2013 17:29'!processScratchByte: aByte	"Process one byte of the incoming data stream from a Scratch sensor board."	"Sensor messages are two bytes with the following format:		Byte1: <1><sensor number (4 bits)><sensor value high bits (3 bits)>		Byte2: <0><sensor value low bits (7 bits)>"	| sensorNum val |"Transcriptshow:'processScratchByte';cr."	currentState = #idle ifTrue: [  "wait for first byte of message"		(aByte bitAnd: 16r80) > 0 ifTrue: [			currentState _ #firstByteSeen.			highByte _ aByte].		^ self].	currentState = #firstByteSeen ifTrue: [		(aByte bitAnd: 16r80) > 0 ifTrue: [  "must have lost second byte; stay in firstByteSeen state"			highByte _ aByte.			^ self].		"good second byte: report the sensor value"		sensorNum _ ((highByte bitShift: -3) bitAnd: 16rF) + 1.		val _ ((highByte bitAnd: 7) bitShift: 7) + (aByte bitAnd: 16r7F).		sensorNum <= sensorValues size ifTrue: [			sensorValues at: sensorNum put: val.			sensorNum = 16 ifTrue: [				(val == 3) | (val == 4) ifTrue: [					scratchBoardV3 _ true]]].  "ScratchBoard, version 3 or 4"		currentState _ #idle].! !!ConfigureBoardMorph methodsFor: 'private' stamp: 'KK 8/16/2013 17:29'!scaleLight: val	val <= 25 ifTrue: [^ 100 - val].	^ ((1023 - val) * (75.0 / 998)) rounded! !!ConfigureBoardMorph methodsFor: 'private' stamp: 'KK 8/16/2013 17:29'!scaleSound: val	| n |	n _ ((val - 18) max: 0) min: 630.	n < 50 ifTrue: [^ n / 2.0].  "0 to 25"	^ 25.0 + ((n - 50) * (75.0 / 580.0))! !!ConfigureBoardMorph methodsFor: 'private' stamp: 'KK 8/16/2013 17:29'!startStreamingSensors: sensorByte	"Begin streaming data from the set of sensors specified by the bits of the given byte. Invoke this method with 0 to stop streaming. Incoming sensor data is processed by frequent calls to processIncomingData."	| cmd |	useGoGoProtocol ifFalse: [^ self].	port flushInputBuffer.	cmd _ #(84 254 160 0) asByteArray.	cmd at: 4 put: sensorByte.	port nextPutAll: cmd.! !!ConfigureBoardMorph methodsFor: 'private' stamp: 'KK 8/16/2013 17:29'!updateTitle	"Update my title to reflect the current protocol and port number."	| s |	s _ (#on = scanState) ifTrue: ['On' localized] ifFalse: ['Off' localized].	s = titleMorph contents ifFalse: [titleMorph contents: s].! !!DialogBoxMorph methodsFor: 'geometry' stamp: 'KK 9/21/2013 15:08'!fixLayoutForExtent: aPoint	| xPos yPos shortcutWidth |	shortcutColumn ifNil: [^ self].	xPos _ self left + 20.	yPos _ self top + 40.	"position and size the shortcut column"	shortcutColumn position: xPos@yPos.	shortcutWidth _ 0.	shortcutColumn submorphsDo: [: m |		shortcutWidth _ m width max: shortcutWidth].	shortcutColumn submorphsDo: [: m |		m width: shortcutWidth].	"position main column"	mainColumn position: (shortcutColumn right + 5)@yPos.	"position and size the fileInfo column""	fileInfoColumn position: (mainColumn right + 5)@yPos.	fileColumnWidth _ 0.	fileInfoColumn submorphsDo: [: m |		fileColumnWidth _ m width max: fileColumnWidth].	fileInfoColumn submorphsDo: [: m |		(m isKindOf: StringMorph)			ifFalse: [m width: fileColumnWidth]]."	"position and size title"	titleBin left: self left.	titleBin width: shortcutColumn width + mainColumn width + fileInfoColumn width + 55.	"add a bottom spacer to the tallest column"	bottomSpacer ifNil: [		bottomSpacer _ (Morph new extent: (5@22); color: Color transparent).		(shortcutColumn height > mainColumn height)			ifTrue: [shortcutColumn addMorphBack: bottomSpacer]			ifFalse: [(mainColumn height > fileInfoColumn height)				ifTrue: [mainColumn addMorphBack: bottomSpacer]				ifFalse: [fileInfoColumn addMorphBack: bottomSpacer]]].! !!DividedImageFrameMorph methodsFor: 'initialize' stamp: 'KK 4/18/2014 12:38'!initFrontFromForm2: aForm topSectionHeight: aNumber	| w h |	super initFrontFromForm: aForm.	topSectionHeight _ aNumber.	leftMargin _ 0.	rightMargin _ 0.	middleBarForm _ ScratchFrameMorph skinAt: #dividedImageFrameBar2.	w _ (middleBarForm width // 2) + 2.	h _ middleBarForm height.	leftJointForm _ middleBarForm copy: (0@0 extent: w@h).	rightJointForm _ middleBarForm copy: ((middleBarForm width - w) @ 0 extent: w@h).! !!DividedImageFrameMorph methodsFor: 'initialize' stamp: 'KK 4/18/2014 12:31'!initFrontFromForm: aForm topSectionHeight: aNumber	| w h |	super initFrontFromForm: aForm.	topSectionHeight _ aNumber.	leftMargin _ 0.	rightMargin _ 0.	middleBarForm _ ScratchFrameMorph skinAt: #dividedImageFrameBar.	w _ (middleBarForm width // 2) + 2.	h _ middleBarForm height.	leftJointForm _ middleBarForm copy: (0@0 extent: w@h).	rightJointForm _ middleBarForm copy: ((middleBarForm width - w) @ 0 extent: w@h).! !!DividedImageFrameMorph methodsFor: 'accessing' stamp: 'ee 10/30/2008 13:37'!middleBarLeftMargin: aNumber rightMargin: aNumber2	leftMargin _ aNumber.	rightMargin _ aNumber2.! !!DividedImageFrameMorph methodsFor: 'drawing' stamp: 'ee 1/28/2009 16:11'!drawDividerOn: aCanvas	"Draw my divider edge."	| w r f slice |	w _ self width - (leftJointForm width + rightJointForm width) - leftMargin - rightMargin.	r _ ((self left + leftJointForm width + leftMargin) @ (self top + topSectionHeight - 4))		extent: (w @ middleBarForm height).	f _ edgeCache at: 5.	(f isNil or: [f extent ~= r extent]) ifTrue: [		f _ Form extent: r extent depth: 32.		slice _ middleBarForm copy: (((middleBarForm width // 2) @ 0) extent: (1 @ r height)).		0 to: r width by: slice width do: [:x | slice displayOn: f at: x@0 rule: Form blend].		edgeCache at: 5 put: f].	aCanvas translucentImage: f at: r topLeft.! !!DividedImageFrameMorph methodsFor: 'drawing' stamp: 'ee 1/28/2009 16:11'!drawFrameOn: aCanvas	super drawFrameOn: aCanvas.	self drawDividerOn: aCanvas.	"draw middle bar left and right joints"	aCanvas		translucentImage: leftJointForm		at: self topLeft + (leftMargin@(topSectionHeight-4)).	aCanvas		translucentImage: rightJointForm		at: (self right - rightJointForm width - rightMargin) @ (self top + topSectionHeight - 4).! !!EventTitleMorph methodsFor: 'accessing' stamp: 'KK 8/2/2013 12:59'!printArduArgOn: aStream	"Print this argument morph on the given stream."	aStream nextPut: $".	aStream nextPutAll: self labelMorph contents.	aStream nextPut: $".! !!EventTitleMorph methodsFor: 'accessing' stamp: 'KK 8/2/2013 13:00'!printArgOn: aStream	"Print this argument morph on the given stream."	aStream nextPutAll: self labelMorph contents.! !!EventTitleMorph methodsFor: 'queries' stamp: 'sk 9/21/2016 15:59'!acceptsDroppedReporters	"Accept reporter blocks in broadcast blocks but not in 'when I receive' hat block."	^ false! !!EventTitleMorph methodsFor: 'event handling' stamp: 'sk 9/21/2016 19:27'!handlesMouseDown: evt	^ evt hand toolType isNil and:		[(self topLeft corner: self bottomRight) containsPoint: evt cursorPoint]! !!EventTitleMorph methodsFor: 'event handling' stamp: 'KK 9/17/2014 11:30'!presentMenu	"Pop up a menu of choices."	| eventNames sFrame menu choice s |	eventNames _ #().	(sFrame _ self ownerThatIsA: ScratchFrameMorph)		ifNotNil: [eventNames _ sFrame workPane allEventNames].	menu _ CustomMenu new.	eventNames do: [:n | menu add: n action: n asString].	menu addLine.	menu add: ('new' localized, ScratchTranslator ellipsesSuffix) action: #newEvent.	(choice _ menu startUp) ifNil: [^ self].	choice == #newEvent ifTrue: [		ValueOrList _ true.		s _ StringDialog ask: 'Function name:(Only alphanumeric characters are allowed)'.		s size = 0 ifTrue: [^ self].		^ self eventName: s].	self eventName: choice.! !!ExpressionArgMorph methodsFor: 'accessing' stamp: 'KK 9/18/2013 19:15'!defaultValue: anObject	anObject isNumber ifTrue: [self numExpression: anObject].	(anObject isKindOf: String) ifTrue: [self stringExpression: anObject].! !!ExpressionArgMorph methodsFor: 'accessing' stamp: 'KK 5/1/2014 17:10'!numExpression: aNumber	isNumber _ true.	labelMorph isNumeric: true.	aNumber isFloat		ifTrue: [labelMorph contents: aNumber printStringNoExponent]		ifFalse: [labelMorph contents: aNumber asString].	self fixArgLayout.! !!ExpressionArgMorphWithMenu methodsFor: 'private' stamp: 'KK 8/19/2014 11:02'!fixArgLayout	| dx |	dx _ 9.	super fixArgLayout.	menuMorph ifNil: [^ self].	self width: self width + dx.	menuMorph position: (self right - dx - 2)@(self top + (self height // 3)).	(thisContext sender receiver isKindOf: StringFieldMorph) ifTrue: [		"clear only when user edit my label, but not on other arg layout changes"		specialValue _ nil].! !!HatBlockMorph methodsFor: 'private' stamp: 'sk 5/20/2016 21:22'!printArduCodeOn: aStream indent: indent	"Append a human-readable string for this block on the given stream."	indent timesRepeat: [aStream nextPutAll: '    '].	self printArduHatNameOn: aStream.	self nextBlock ifNotNil: [self nextBlock printArduCodeOn: aStream indent: indent + 1].	indent timesRepeat: [aStream nextPutAll: '    '].		(BoardType = 1) ifTrue: [	((IOPort at:19) = 6) ifTrue: [		(indent + 1) timesRepeat: [aStream nextPutAll: '    '].		aStream nextPutAll: 'board.sleep();'; cr].].	aStream nextPutAll: '}'; cr.! !!EventHatMorph methodsFor: 'initialization' stamp: 'KK 10/18/2013 13:34'!forStartEvent	| t1 t2 t3 |	super initialize.	self removeAllMorphs.	t1 _ ScratchTranslator labelPartsFor: '%m Start program'.	t2 _ StringMorph new contents: t1 first;			 font: (ScratchFrameMorph getFont: #Label);			 color: Color white.	self addMorphBack: t2.	t3 _ ImageMorph new form: (ScratchFrameMorph skinAt: #goButton).	self addMorphBack: t3.	t2 _ t2 fullCopy contents: t1 second.	self addMorphBack: t2.	scriptNameMorph _ EventTitleMorph new eventName: 'Scratch-StartClicked'.	self fixBlockLayout! !!EventHatMorph methodsFor: 'initialization' stamp: 'KK 10/18/2013 13:31'!initialize	| parts label |	super initialize.	self removeAllMorphs.	parts _ ScratchTranslator labelPartsFor: '%e function'.	parts first size > 0 ifTrue: [		label _ StringMorph contents: parts first font: (ScratchFrameMorph getFont: #Label).		label color: Color white.		self addMorphBack: label].	scriptNameMorph _ EventTitleMorph new.	self addMorphBack: scriptNameMorph.	parts second size > 0 ifTrue: [		label _ (StringMorph contents: parts second font: (ScratchFrameMorph getFont: #Label)) color: Color white.		self addMorphBack: label].! !!EventHatMorph methodsFor: 'other' stamp: 'KK 9/2/2013 10:23'!printArduHatNameOn: aStream	"Append a human-readable string for this hat block's name to the given stream."	| evtName |	evtName _ self eventName.	evtName = 'Scratch-StartClicked'		ifTrue: [			aStream nextPutAll: '// ---------------------------------------'; cr.			aStream nextPutAll: '// Artec robot mainroutine'; cr.			aStream nextPutAll: '// ---------------------------------------'; cr.			aStream nextPutAll: 'void artecRobotMain() {'		]		ifFalse: [			aStream nextPutAll: '// ---------------------------------------'; cr.			aStream nextPutAll: '// Artec robot subroutine'; cr.			aStream nextPutAll: '// ---------------------------------------'; cr.			aStream nextPutAll: 'void ARSR_', evtName, '() {'		].	aStream cr.! !!EventHatMorph methodsFor: 'event handling' stamp: 'KK 9/23/2013 21:11'!rightButtonMenu	| evtName |	"Handle invalid rightButtonMenu of Start Hat Morph "	evtName _ self eventName.	evtName = 'Scratch-StartClicked'		ifTrue: [	" when green flag clicked ""			super rightButtonMenu."		]		ifFalse: [	" when I receive "			super rightButtonMenu.		].! !!EventHatMorph methodsFor: 'dropping/grabbing' stamp: 'KK 9/23/2013 17:35'!justDroppedInto: newOwner event: evt	| evtName |	"Handle being dropped into a new situation.""Transcript show:'[EventHatMorph::justDroppedInto: event:]';show: newOwner;show: ', ';show: evt;cr."	evtName _ self eventName.	evtName = 'Scratch-StartClicked'		ifTrue: [	" when green flag clicked "			"blocks cannot be dropped onto the palette"			(owner isKindOf: ScratchBlockPaletteMorph) ifTrue: [				self rejectDropEvent: evt			]			ifFalse: [				super justDroppedInto: newOwner event: evt			].		]		ifFalse: [	" when I receive "			super justDroppedInto: newOwner event: evt		].! !!IfElseBlockMorph methodsFor: 'drawing' stamp: 'KK 2/27/2015 13:55'!drawOn: aCanvas 	| c |	topBarBottom _ self top + self topBarHeight.	blockBottom _ self bottom - 7.	self computeHighlightColors.	c _ FormCanvas extent: self extent depth: 32.	c _ c copyOffset: self topLeft negated.	self drawTopEdgeOn: c.	self drawTopBarOn: c.	self drawVerticalBarOn: c.	self drawElseBarOn: c.	self drawBottomBarOn: c.	self drawFinalOn: aCanvas fromCanvas: c.! !!IfElseBlockMorph methodsFor: 'private' stamp: 'KK 8/2/2013 15:08'!printArduCodeOn: aStream indent: indent	"Append a human-readable string for this block on the given stream."	indent timesRepeat: [aStream nextPutAll: '    '].	submorphs do: [:m |		(m ~~ trueBlock) & (m ~~ falseBlock) & (m ~~ nextBlock) ifTrue: [			self printArduCodeSubmorph: m on: aStream.			aStream space].].	aStream cr.	trueBlock ifNotNil: [trueBlock printArduCodeOn: aStream indent: indent + 1].	indent timesRepeat: [aStream nextPutAll: '    '].	aStream nextPutAll: '} else {'; cr.	falseBlock ifNotNil: [falseBlock printArduCodeOn: aStream indent: indent + 1].	indent timesRepeat: [aStream nextPutAll: '    '].	aStream nextPutAll: '}'; cr.	nextBlock ifNotNil: [nextBlock printArduCodeOn: aStream indent: indent].! !!LibraryItemMorph methodsFor: 'drawing' stamp: 'KK 1/21/2013 19:20'!updateNameAndInfo	| w y |	self		setProperty: #balloonText		toValue: ((target objName asUTF8, ' (' asUTF8, 'Scripts' localized, ScratchTranslator colonSuffix, ' ' asUTF8, target scripts size printString asUTF8,')' asUTF8) asUTF8).	nameMorph ifNotNil:[		(target isKindOf: ScriptableScratchMorph) ifFalse: [			nameMorph contents: '<no object>'.			scriptCountMorph contents: ''.			^ self].		nameMorph contents = target objName ifFalse: [			nameMorph contents: self truncatedLabel.			nameMorph left: self left + ((self width - nameMorph width) // 2) + 1]].	scriptCountMorph ifNotNil: [		w _ 0.		target scripts size > 0			ifTrue: [				w > 0 ifTrue: [w _ w + 2].				scriptCountMorph contents: 'Scripts' localized, ScratchTranslator colonSuffix, ' ', target scripts size printString.				w _ w + scriptCountMorph width + 2]			ifFalse: [				scriptCountMorph contents: ''].		"layout info morph row"		y _ nameMorph bottom.		w > 0 ifTrue: [			scriptCountMorph position: (self left + ((self width - (scriptCountMorph width)) // 2))@y]].! !!LibraryItemMorph methodsFor: 'stepping' stamp: 'KK 1/21/2013 19:19'!step	"Optimization: Don't update unless the costume has changed."	| changeTime stage frame |	target ifNil: [		(frame _ (self ownerThatIsA: ScratchFrameMorph)) ifNotNil: [			(stage _ frame workPane) ifNotNil: [				stage updateSpritesList]].		^ self].	target world isNil ifTrue: [target _ nil. ^ self].	changeTime _ target costumeChangeMSecs.	changeTime = lastUpdateMSecs ifFalse: [		self updateThumbnail.		lastUpdateMSecs _ changeTime].	Sensor anyButtonPressed ifFalse: [self updateNameAndInfo].! !!LibraryItemMorph methodsFor: 'private' stamp: 'KK 1/21/2013 19:18'!truncatedLabel	"Answer the label string to used as the name morph."	| ellipses s w n |"	nameMorph contents = target objName ifFalse: [		n _ target objName.		ellipses _ ScratchTranslator ellipsesSuffix asUTF32.		1 to: n size do: [:i |			s _ n copyFrom: 1 to: i.			w _ nameMorph stringWidth: (s asUTF32, ellipses).			w > (self width - 3) ifTrue: [				^ (n copyFrom: 1 to: i - 1) asUTF32, ellipses]]]."	^ target objName! !!NotificationMessage class methodsFor: 'printing' stamp: 'sk 8/23/2016 09:02'!show: msgID	"Displaying a notification message for a given number and returning the dialogbox."	| dialogBox title message |	title _ 'Undifined error number.'.	message _ 'Unknown error.'.	(msgID = 16r10) ifTrue: [		title _ 'Building and updating...'.		message _ 'Do not disconnect Studuino from the PC.'].	(msgID = 16r11) ifTrue: [		title _ 'Shifting to Test mode...'.		message _ 'Do not disconnect Studuino from the PC.'].	(msgID = 16r12) ifTrue: [		title _ 'Shifting to calibration mode...'.		message _ 'Do not disconnect Studuino from the PC.'].	(msgID = 16r20) ifTrue: [		title _ 'Are you ready to transfer your program?'.		message _ 'Push a reset button on a board.'].	(msgID = 16r21) ifTrue: [		title _ 'Are you ready to transfer your program?2'.		message _ 'Push a reset button on a board.'].	dialogBox _ DialogBoxMorph new.	dialogBox title: title.	dialogBox message: message.	dialogBox openInWorld.		" Display Dialogbox "	dialogBox centerOnScreen.	" Set center position "	dialogBox world doOneCycle.	^ dialogBox! !!NumericUpDownMorph methodsFor: 'stepping and presenter' stamp: 'KK 4/24/2014 17:36'!step	| val |	val _ self evaluate.	upButtonOn ifTrue: [		((val + 1) <= maximum) ifTrue: [ val _ val + 1. ].		self numExpression: val.		self notifyOwner: val.	].	downButtonOn ifTrue: [		((val - 1) >= minimum) ifTrue: [ val _ val - 1. ].		self numExpression: val.		self notifyOwner: val.	].	! !!NumericUpDownMorph methodsFor: 'stepping and presenter' stamp: 'KK 4/22/2014 17:37'!stepTime	^ 100.! !!NumericUpDownMorph methodsFor: 'accessing' stamp: 'KK 3/31/2014 16:14'!addUpDownButton	"Add a up and down menu button. "	upMorph _ ImageMorph new form: UpForm.	self addMorphFront: upMorph.	downMorph _ ImageMorph new form: DownForm.	self addMorphFront: downMorph.	self fixArgLayout.! !!NumericUpDownMorph methodsFor: 'accessing' stamp: 'KK 3/31/2014 13:20'!defaultValue: anObject	((#(listIndexMenu listIndexForDeleteMenu) includes: getMenuSelector) and:	 [anObject isKindOf: String])		ifTrue: [self specialValue: anObject]		ifFalse: [super defaultValue: anObject].! !!NumericUpDownMorph methodsFor: 'accessing' stamp: 'KK 3/31/2014 13:20'!menuSelector	^ getMenuSelector! !!NumericUpDownMorph methodsFor: 'accessing' stamp: 'KK 3/31/2014 13:55'!menuSelector: menuSelector	"Add a drop-down menu button with the given selector. The selector should result in a menu whose action items are values that can be put into this type argument, typically numbers or strings."	upMorph _ ImageMorph new form: UpForm.	self addMorphFront: upMorph.	downMorph _ ImageMorph new form: DownForm.	self addMorphFront: downMorph.	self fixArgLayout.! !!NumericUpDownMorph methodsFor: 'accessing' stamp: 'KK 4/28/2014 10:11'!notifyOwner: d	" I notify message to the owner "	" The owner is servomotor calibration board. "	| block frame sb pin ival offset portArg n |	(block _ self ownerThatIsA: CommandBlockMorph).	block ifNotNil: [	" Owner is CommandBlockMorph "		(block selector = #motorNo:degree:) ifTrue: [	" Owner is servomotor block "			portArg _ block findA: ChoiceArgMorph.			n _ portArg choice.			" Check argument. "			n = '' ifTrue: [^self].			" Port is not open, return. "			frame _ self ownerThatIsA: ScratchFrameMorph.			sb  _ frame workPane sensorBoard.			(sb portIsOpen) ifFalse: [ ^ self. ].			offset _ 0.			(n = 'D2') ifTrue: [	" D2 "				pin _ 16r0000.			"b0000 0000 0000 0000"				offset _ SvCalib at:(5).	" Servomotor offset"			].			(n = 'D4') ifTrue: [	" D4 "				pin _ 16r0200.			"b0000 0010 0000 0000"				offset _ SvCalib at:(6).	" Servomotor offset"			].			(n = 'D7') ifTrue: [	" D7 "				pin _ 16r0400.			"b0000 0100 0000 0000"				offset _ SvCalib at:(7).	" Servomotor offset"			].			(n = 'D8') ifTrue: [	" D8 "				pin _ 16r0600.			"b0000 0110 0000 0000"				offset _ SvCalib at:(8).	" Servomotor offset"			].			(n = 'D9') ifTrue: [	" D9 "				pin _ 16r0800.			"b0000 1000 0000 0000"				offset _ SvCalib at:(1).	" Servomotor offset"			].			(n = 'D10') ifTrue: [	" D10 "				pin _ 16r0A00.			"b0000 1010 0000 0000"				offset _ SvCalib at:(2).	" Servomotor offset"			].			(n = 'D11') ifTrue: [	" D11 "				pin _ 16r0C00.			"b0000 1100 0000 0000"				offset _ SvCalib at:(3).	" Servomotor offset"			].			(n = 'D12') ifTrue: [" D12 "				pin _ 16r0E00.			"b0000 1110 0000 0000"				offset _ SvCalib at:(4).	" Servomotor offset"			].			" Convert unsigned to singed "			(offset > 127) ifTrue: [				offset _ offset - 256.			].			ival _ d asNumber.			ival _ ival + offset.	" Calibration "			(ival >= 180)  ifTrue: [ ival _ 180. ].			(ival <= 0)	 ifTrue: [ ival _ 0.   ].			ival _ pin + ival rounded.			"Transcript show:'ScriptableScratchMorph:: motorNo:degree:'; show: ival;cr."			sb data:ival msgID:1.		].	].! !!NumericUpDownMorph methodsFor: 'accessing' stamp: 'KK 3/31/2014 13:20'!specialValue: aString	"A special value is a menu selection such as 'last' for a list index that appears as a string in a number if field. If the user edits the field, then it only accepts numeric input. The argumet is retained in the specialValue instance variable."	isNumber _ true.	labelMorph contents: aString localized.	labelMorph		isNumeric: true;		position: self position + (0@1).	self fixArgLayout.	specialValue _ aString.! !!NumericUpDownMorph methodsFor: 'evaluation' stamp: 'KK 3/31/2014 13:20'!evaluate	"Answer the result of evaluating my expression in the context of the given ScratchProcess."	specialValue ifNotNil: [^ specialValue].	^ super evaluate! !!NumericUpDownMorph methodsFor: 'event handling' stamp: 'KK 4/18/2014 20:14'!handlesKeyboard: evt	^ true.! !!NumericUpDownMorph methodsFor: 'event handling' stamp: 'KK 4/5/2014 14:32'!handlesMouseDown: evt	^ valid.	"	^ ((upMorph notNil) & (downMorph notNil))"! !!NumericUpDownMorph methodsFor: 'event handling' stamp: 'KK 4/22/2014 16:47'!handlesMouseOver: evt	^ valid.	"	^ ((upMorph notNil) & (downMorph notNil))"! !!NumericUpDownMorph methodsFor: 'event handling' stamp: 'KK 5/12/2014 16:53'!keyStroke:evt	| ch |Transcript show:'NumericUpDownMorph:keyStroke:';cr.	ch _ evt unicodeChar.	ch = 0 ifTrue: [ch _ evt keyValue].	(ch = 10) | (ch = 13) ifTrue: [  "cr, lf, or enter key"Transcript show:labelMorph;cr.		evt hand newKeyboardFocus: nil.		^ self].! !!NumericUpDownMorph methodsFor: 'event handling' stamp: 'KK 5/12/2014 17:11'!mouseDown: evt	| choice |	upMorph ifNil: [^ super mouseDown: evt	].	downMorph ifNil: [^ super mouseDown: evt].	(evt cursorPoint x < (upMorph left - 1)) ifTrue: [^ super mouseDown: evt].	choice _ true.	" true:Up, false:Down "	(evt cursorPoint y > (self top + (self height // 2))) ifTrue: [ choice _ false. ].	choice ifTrue: [	" Up button clicked. "		self enterKeyPressed.		evt hand newKeyboardFocus: nil.		upButtonOn _ true.	]	ifFalse: [	" Down Button Clicked. "		self enterKeyPressed.		evt hand newKeyboardFocus: nil.		downButtonOn _ true.	].! !!NumericUpDownMorph methodsFor: 'event handling' stamp: 'KK 4/22/2014 17:55'!mouseLeave: evt	| |	upMorph ifNil: [^ super mouseLeave: evt].	downMorph ifNil: [^ super mouseLeave: evt].	(evt cursorPoint x < (upMorph left - 1)) ifTrue: [^ super mouseLeave: evt].	upButtonOn _ false.	downButtonOn _ false.! !!NumericUpDownMorph methodsFor: 'event handling' stamp: 'KK 4/22/2014 17:55'!mouseMove: evt	| currentPointX currentPointY |	currentPointX _ evt cursorPoint x.	currentPointY _ evt cursorPoint y.	upMorph ifNil: [^ super mouseMove: evt].	downMorph ifNil: [^ super mouseMove: evt].	((currentPointX < (upMorph left - 1)) | (currentPointX > (upMorph right + 1))) ifTrue: [		upButtonOn _ false.		downButtonOn _ false.			^ super mouseMove: evt	].	upButtonOn ifTrue: [		((currentPointY < (upMorph top - 1)) | (currentPointY > (upMorph bottom + 1))) ifTrue: [			upButtonOn _ false.			^ super mouseMove: evt		].	].	downButtonOn ifTrue: [		((currentPointY < (downMorph top - 1)) | (currentPointY > (downMorph bottom + 1))) ifTrue: [			downButtonOn _ false.			^ super mouseMove: evt		].	].! !!NumericUpDownMorph methodsFor: 'event handling' stamp: 'KK 4/22/2014 17:55'!mouseUp: evt	| choice |	upMorph ifNil: [^ super mouseUp: evt].	downMorph ifNil: [^ super mouseUp: evt].	(evt cursorPoint x < (upMorph left - 1)) ifTrue: [^ super mouseUp: evt].	choice _ true.	" true:Up, false:Down "	(evt cursorPoint y > (self top + (self height // 2))) ifTrue: [ choice _ false. ].	choice ifTrue: [	" Up button clicked. "		upButtonOn _ false.	]	ifFalse: [	" Down Button Clicked. "		downButtonOn _ false.	].! !!NumericUpDownMorph methodsFor: 'other' stamp: 'KK 5/12/2014 17:09'!enterKeyPressed	| val |	"Respond to the enter key being pressed in one of my input fields."	val _ labelMorph contents asNumber.	(val > maximum) ifTrue: [ val _ maximum ].	(val < minimum) ifTrue: [ val _ minimum ].	self numExpression: val.	self notifyOwner: val.! !!NumericUpDownMorph methodsFor: 'object i/o' stamp: 'KK 3/31/2014 13:20'!fieldsVersion	^ 2! !!NumericUpDownMorph methodsFor: 'object i/o' stamp: 'KK 3/31/2014 13:20'!initFieldsFrom: anObjStream version: classVersion	super initFieldsFrom: anObjStream version: classVersion.	self initFieldsNamed: #(		menuMorph		getMenuSelector	) from: anObjStream.	classVersion = 1 ifTrue: [^ self].	"field added in version 2"	self initFieldsNamed: #(		specialValue	) from: anObjStream.! !!NumericUpDownMorph methodsFor: 'object i/o' stamp: 'KK 3/31/2014 15:32'!storeFieldsOn: anObjStream	super storeFieldsOn: anObjStream.	self storeFieldsNamed: #(		menuMorph		upMorph		downMorph		getMenuSelector		specialValue	) on: anObjStream.! !!NumericUpDownMorph methodsFor: 'private' stamp: 'KK 8/19/2014 13:04'!fixArgLayout	| dx |	dx _ 9 .	super fixArgLayout.	upMorph ifNil: [^ self].	downMorph ifNil: [ ^ self].	self width: self width + dx + 5.	upMorph position: (self right -dx -2)@(self top + (self height // 4)).	downMorph position: (self right -dx -2)@(self top + (self height // 1.5)).	(thisContext sender receiver isKindOf: StringFieldMorph) ifTrue: [		"clear only when user edit my label, but not on other arg layout changes"		specialValue _ nil].! !!NumericUpDownMorph methodsFor: 'initialization' stamp: 'KK 4/22/2014 16:35'!nitialize	super initialize.	upButtonOn _ false.	downButtonOn _ false.! !!NumericUpDownMorph methodsFor: 'initialization' stamp: 'KK 4/5/2014 11:21'!setDefault: defVal	" Set initial value, minimum value, maximum value, and up/down button. "	self numExpression: defVal.! !!NumericUpDownMorph methodsFor: 'initialization' stamp: 'KK 8/19/2014 13:01'!setDefault: defVal min: minVal max: maxVal	" Set initial value, minimum value, maximum value, and up/down button. "	minimum _ minVal.	maximum _ maxVal.	self numExpression: defVal.	labelMorph width: 30.	labelMorph doResizing: false.	labelMorph rightJustify: true.	labelMorph isEditable: false.	valid _ true.	self addUpDownButton.! !!NumericUpDownMorph methodsFor: 'initialization' stamp: 'KK 8/19/2014 13:02'!setDefault: defVal min: minVal max: maxVal width:w isEdit: e	" Set initial value, minimum value, maximum value, and up/down button. "	minimum _ minVal.	maximum _ maxVal.	self numExpression: defVal.	labelMorph width: (w* (ScratchTranslator renderScale)).	labelMorph doResizing: false.	labelMorph rightJustify: true.	labelMorph isEditable: e.	valid _ true.	upButtonOn _ false.	downButtonOn _ false.	self addUpDownButton.! !!NumericUpDownMorph class methodsFor: 'class initialization' stamp: 'KK 3/31/2014 13:53'!initialize	"self initialize"	DownForm _ Form		extent: 7@4		depth: 1		fromArray: #(4261412864 2080374784 939524096 268435456)		offset: 0@0.	DownForm _ DownForm colorReduced.  "become a ColorForm"	DownForm colors:		(Array with: Color transparent with: (Color gray: 0.25)).	UpForm _ Form		extent: 7@4		depth: 1		fromArray: #(268435456 939524096 2080374784 4261412864)		offset: 0@0.	UpForm _ UpForm colorReduced.  "become a ColorForm"	UpForm colors:		(Array with: Color transparent with: (Color gray: 0.25)).! !!ObjStream class methodsFor: 'class initialization' stamp: 'KK 8/16/2013 17:54'!userClasses	"Answer an array of (<class id>, <class name>) records for all version numbered user classes."	"The following finds obsolete user classes:"	"self initialize. self userClasses reject: [:rec | Smalltalk includesKey: rec second]"	^ #(		"id		class"		(100		Morph)		(101		BorderedMorph)		(102		RectangleMorph)		(103		EllipseMorph)		(104		AlignmentMorph)		(105		StringMorph)		(106		UpdatingStringMorph)		(107		SimpleSliderMorph)		(108		SimpleButtonMorph)		(109		SampledSound)		(110		ImageMorph)		(111		SketchMorph)		"(120	SpriteMorph)"		"(121		SoundMorph)"		"(122	ImageBoxMorph)"		(123		SensorBoardMorph)		(124		ScratchSpriteMorph)		(125		ScratchStageMorph)		(140		ChoiceArgMorph)		(141		ColorArgMorph)		(142		ExpressionArgMorph)		"(143	ParameterReferenceMorph)"		"(144	PositionArgMorph)"		(145		SpriteArgMorph)		"(146	VariableArgMorph)"		(147		BlockMorph)		(148		CommandBlockMorph)		(149		CBlockMorph)		"(150	MethodCallBlockMorph)"		(151		HatBlockMorph)		"(152	ScratchButtonMorph)"		(153		ScratchScriptsMorph)		(154		ScratchSliderMorph)		(155		WatcherMorph)		"(156	ParameterMorph)"		(157		SetterBlockMorph)		(158		EventHatMorph)		"(159	EventArgMorph)"		(160		VariableBlockMorph)		"(161		IACTHatBlock)"		(162		ImageMedia)		(163		MovieMedia)		(164		SoundMedia)		(165		KeyEventHatMorph)		(166		BooleanArgMorph)		(167		EventTitleMorph)		(168		MouseClickEventHatMorph)		(169		ExpressionArgMorphWithMenu)		(170		ReporterBlockMorph)		(171		MultilineStringMorph)		(172		ToggleButton)		(173		WatcherReadoutFrameMorph)		(174		WatcherSliderMorph)		(175		ScratchListMorph)		(176		ScrollingStringMorph)	)! !!PasteUpMorph methodsFor: 'dropping/grabbing' stamp: 'KK 9/23/2013 17:35'!acceptDroppingMorph: aMorph event: evt	aMorph submorphsDo: [:m | (m isKindOf: HaloMorph) ifTrue: [m delete]].	self addMorphFront: aMorph."Transcript show:'[PasteUpMorph::acceptDroppingMorph: event:]';show: aMorph;show: ', ';show: evt;cr."	self isPartsBin		ifTrue: [			aMorph isPartsDonor: true.			aMorph allMorphsDo: [:m | m stopStepping]]		ifFalse: [			self world startSteppingSubmorphsOf: aMorph].! !!ReporterBlockMorph methodsFor: 'watcher' stamp: 'KK 8/19/2014 14:07'!canBecomeWatcher	"I determine which blocks can become watchers."	selector ifNotNil: [		(selector = #timer) ifTrue: [ ^ true.].	].	^ false.! !!ScratchBlockPaletteMorph methodsFor: 'initialization' stamp: 'KK 9/20/2013 17:28'!initialize	super initialize.	borderWidth _ 0.! !!ScratchBlockPaletteMorph methodsFor: 'other' stamp: 'KK 9/20/2013 17:25'!fixLayout	"Right align the blocks in the palette if RTL is set to true. The watcher toggle checkbox buttons are assumed to be about 18 pixels wide."	| offset r |	owner ifNil: [^ self].	ScratchTranslator isRTL ifTrue:[		self submorphs do: [:m |			(m isKindOf: BlockMorph) ifTrue: [				m canBecomeWatcher					ifTrue: [m position: (self right - m width - 18 - 10)@(m position y)]					ifFalse: [m position: (self right - m width - 10)@(m position y)].				m changed].			((m isKindOf: ToggleButton) or: [m isKindOf: ResizableToggleButton2]) ifTrue:[	"watcher checkbox case"				m position: (self right - m width - 10)@(m position y)].			(m isKindOf: ImageMorph) ifTrue: [				m position: (self right - m width - 10)@(m position y)]]].	offset _ self topLeft negated.	r _ 0@0 extent: 1@1.	self submorphsDo: [:m |		r _ r quickMerge: (m fullBounds translateBy: offset) truncated].	self width: (r width max: owner width).! !!ScratchBlockPaletteMorph methodsFor: 'other' stamp: 'KK 9/20/2013 11:35'!updateWatcherButtonsForFrame: frame	"Update the watcher button on this palette."	| reporter sprite selAndArg |	frame ifNil: [^ self].	submorphs do: [:b |		((b isKindOf: ToggleButton) and:		 [b target isKindOf: ReporterBlockMorph]) ifTrue: [			reporter _ b target.			sprite _ reporter getAssociatedSprite.			selAndArg _ reporter selectorAndArg.			(frame watcherShowingFor: sprite selectorAndArg: selAndArg)				ifTrue: [b on; setProperty: #balloonText toValue: 'Remove viewer from stage' localized]				ifFalse: [b off; setProperty: #balloonText toValue: 'View on stage' localized]]].! !!ScratchFileChooserDialog methodsFor: 'initialization' stamp: 'KK 9/21/2013 15:06'!addShortcutButtons	"Add shortcut buttons for my type to the shortcutColumn."	| spacer |	spacer _ Morph new extent: 5@5; color: Color transparent.	shortcutColumn removeAllMorphs.	shortcutColumn addMorphBack: (self shortcutButtonLabel: 'Computer' action: #myComp icon: #folderDiscsIcon).	shortcutColumn addMorphBack: spacer fullCopy.	shortcutColumn addMorphBack: (self shortcutButtonLabel: self labelForHomeFolder action: #myHome icon: #folderHouseIcon).	shortcutColumn addMorphBack: spacer fullCopy.	shortcutColumn addMorphBack: (self shortcutButtonLabel: 'Desktop' action: #myDesktop icon: #folderIcon).	shortcutColumn addMorphBack: spacer fullCopy.	#background = self type ifTrue: [		shortcutColumn addMorphBack:			(self shortcutButtonLabel: 'Backgrounds' action: #scratchBackgrounds icon: #folderCatIcon)].	#costume = self type ifTrue: [		shortcutColumn addMorphBack:			(self shortcutButtonLabel: 'Costumes' action: #scratchCostumes icon: #folderCatIcon)].	#project = self type ifTrue: ["		shortcutColumn addMorphBack:			(self shortcutButtonLabel: 'Examples' action: #sampleProjects icon: #folderCatIcon).		shortcutColumn addMorphBack: spacer fullCopy.		shortcutColumn addMorphBack:			(self shortcutButtonLabel: 'My Projects' action: #userProjects icon: #folderIcon)"].	#sound = self type ifTrue: [		shortcutColumn addMorphBack:			(self shortcutButtonLabel: 'Sounds' action: #scratchSounds icon: #folderCatIcon)].! !!ScratchFileChooserDialog methodsFor: 'initialization' stamp: 'KK 9/21/2013 15:00'!createScratchFileChooserFor: aScratchFrameMorph saving: savingFlag	"Create a Scratch file chooser dialog box with a project thumbnail and info box."	| labelFont contentsFont commentFont thumbnailHolder |	scratchFrame _ aScratchFrameMorph.	readingScratchFile _ savingFlag not.	list _ ScratchFilePicker new extensions: #(scratch bpd).	self removeAllMorphs.	bottomSpacer delete.	bottomSpacer _ nil.	mainColumn addMorphBack: list.	savingFlag ifFalse: [		self title: 'Open Project'.		list scratchInfoClient: self].	labelFont _ (ScratchFrameMorph getFont: #FileChooserLabel).	contentsFont _ (ScratchFrameMorph getFont: #FileChooserContents).	commentFont _ (ScratchFrameMorph getFont: #FileChooserComment).	savingFlag ifTrue: [		self title: 'Save Project'.		newFileTitle _ StringMorph contents: ('New Filename:' localized, ' ') font: labelFont.		newFileTitle color: (Color gray: 0.3).		newFileName _ StringFieldMorph new			contents: scratchFrame projectName;			client: self;			font: contentsFont;			color: (Color r: (211/255) g: (214/255) b: (216/255));			width: 180.		tabFields add: newFileName.		newTitleBin			addMorphBack: newFileTitle;			addMorphBack: (Morph new extent: (5@5); color: Color transparent);			addMorphBack: newFileName;			addMorphBack: (AlignmentMorph newSpacer: Color transparent).		ScratchTranslator isRTL			ifTrue: [newTitleBin submorphs reversed do: [:m |				m delete.				newTitleBin addMorphBack: m]]].	mainColumn		addMorphBack: (Morph new extent: (5@9); color: Color transparent);		addMorphBack: newTitleBin.	thumbnailHolder _ AlignmentMorph newColumn		centering: #center;		color: Color transparent.	thumbnailFrameMorph _ ImageFrameMorph new		initFromForm: (ScratchFrameMorph skinAt: #dialogThumbnailFrame).	thumbnailFrameMorph extent: (170@130).	thumbnailHolder addMorph: thumbnailFrameMorph."	fileInfoColumn		addMorphBack: thumbnailHolder;		addMorphBack: (Morph new extent: (5@6); color: Color transparent)." "spacer"	thumbnailMorph _ ImageMorph new form: (Form extent: 160@120 depth: 1).	thumbnailFrameMorph addMorphFront: (thumbnailMorph position: ((thumbnailFrameMorph position) + (5@5))).	authorLabelMorph _ StringMorph contents: 'Project author:' localized font: labelFont.	authorLabelMorph color: (Color gray: 0.3)."	fileInfoColumn addMorphBack: authorLabelMorph."	savingFlag		ifTrue: [authorMorph _ StringFieldMorph new			useStringFieldFrame;			contents: '';			font: contentsFont.			tabFields add: authorMorph]		ifFalse: [fileInfoColumn addMorphBack: (Morph new extent: (5@6); color: Color transparent). "spacer"			authorMorph _ StringFieldMorph new				color: Color transparent;				borderWidth: 0;				contents: '';				isEditable: false;				font: contentsFont].	fileInfoColumn		addMorphBack: authorMorph;		addMorphBack: (Morph new extent: (5@6); color: Color transparent). "spacer"	commentLabelMorph _ StringMorph contents: 'About this project:' localized font: labelFont.	commentLabelMorph color: authorLabelMorph color."	fileInfoColumn addMorphBack: commentLabelMorph."	commentMorph _ ScrollingStringMorph new		borderWidth: 0;		contents: '';		font: commentFont;		extent: (210@110).	savingFlag		ifTrue: [commentMorph backForm: (ScratchFrameMorph skinAt: #stringFieldFrame).			tabFields add: commentMorph]		ifFalse: [commentMorph isEditable: false]."	fileInfoColumn addMorphBack: commentMorph.""	fileInfoColumn addMorphBack: buttonRow."	mainColumn addMorphBack: buttonRow.	self		addMorphBack: shortcutColumn;		addMorphBack: mainColumn."		addMorphBack: fileInfoColumn."	savingFlag ifTrue: [		self scratchInfo: scratchFrame projectInfo.		thumbnailMorph form: scratchFrame workPane thumbnailForm.		"default author field to login name if known; else author"		(aScratchFrameMorph loginName size > 0)			ifTrue: [authorMorph contents: aScratchFrameMorph loginName]			ifFalse: [authorMorph contents: aScratchFrameMorph author]].! !!ScratchFileChooserDialog methodsFor: 'accessing' stamp: 'KK 9/21/2013 15:03'!createFileChooserLayout: allowNewFile	"Create the file chooser dialog box."	list _ ScratchFilePicker new.	self removeAllMorphs.	bottomSpacer delete.	bottomSpacer _ nil.	mainColumn addMorphBack: list.	self title: 'Open'.	allowNewFile ifTrue: [		self title: 'Save As'.		newFileTitle _ StringMorph new			contents: 'New Filename:' localized, ' ';			color: (Color gray: 0.3);			font: (ScratchFrameMorph getFont: #FileChooserNewFileTitle).		newFileName _ StringFieldMorph new			font: (ScratchFrameMorph getFont: #FileChooserNewFilename);			color: (Color r: (211/255) g: (214/255) b: (216/255));			width: 180.		newTitleBin			addMorphBack: newFileTitle;			addMorphBack: (Morph new extent: (5@5); color: Color transparent);			addMorphBack: newFileName;			addMorphBack: (AlignmentMorph newSpacer: Color transparent).			ScratchTranslator isRTL		ifTrue: [newTitleBin submorphs reversed do: [:m |			m delete.			newTitleBin addMorphBack: m]]].	mainColumn		addMorphBack: newTitleBin;		addMorphBack: buttonRow.	self		addMorphBack: shortcutColumn;		addMorphBack: mainColumn."		addMorphBack: fileInfoColumn."! !!ScratchFileChooserDialog class methodsFor: 'instance creation' stamp: 'KK 9/26/2013 16:00'!saveScratchFileFor: aScratchFrameMorph	"Choose a file for saving the current Scratch project file. Display the thumbnail and info string for the current project and allow the info string to be edited. Answer the full name of the file in which to save the project or #cancelled if the operation is cancelled."	"ScratchFileChooserDialog saveScratchFileFor: nil"	| m result |	ScratchFileChooserDialog deleteDuplicates.	m _ self new		createScratchFileChooserFor: aScratchFrameMorph saving: true;		type: #project;		redirectSavesToSampleFolder.	result _ m getUserResponseForNewFile.	result = #cancelled ifTrue: [^ result].	(result asLowercase endsWith: '.bpd') ifFalse: [result _ result, '.bpd'].	^ result! !!ScratchFileChooserDialog class methodsFor: 'utilities' stamp: 'KK 9/26/2013 16:39'!confirmFileOverwriteIfExisting: aFilename	"If the given file exists, ask the user if they want to overwrite it or pick a different file name."	| response fName |	fName _ aFilename.	(fName endsWith: '.bpd') ifFalse: [fName _ fName, '.bpd'].	(FileDirectory default fileExists: fName) ifFalse: [^ aFilename].	response _ DialogBoxMorph		askWithCancel: 'The file name already exists. Overwrite existing file?'.	response = #cancelled ifTrue: [^ #cancelled].	response ifTrue: [^ fName] ifFalse: [^ false].! !!ScratchFilePicker methodsFor: 'private' stamp: 'KK 9/1/2014 11:57'!newDirectory	"Create a new directory."	| name |	ValueOrList _ false.	name _ StringDialog askWithCancel: 'New folder name:'.	name = '' ifTrue: [^ self].	[self currentDirectory createDirectory: name] ifError: [:err :rcvr |		^ DialogBoxMorph warn: 'Could not create folder.'].	self currentDirectory: self currentDirectory.! !!ScratchFrameMorph methodsFor: 'intialization' stamp: 'sk 6/15/2016 10:41'!createBasicPanes	"Create and add my palette (viewer), script editor, stage, and library panes."	topPane _ ImageFrameMorph new initFromForm: (ScratchFrameMorph skinAt: 'topPane').	viewerPane _ ScratchViewerMorph new rebuildCategorySelectors.		scriptsPane _ ScratchScriptEditorMorph new.	stageFrame _ ImageFrameMorph new initFromForm: (ScratchFrameMorph skinAt: 'spriteLibraryPaneFrameTransparent2').	titlePane _ ImageFrameMorph new initFromForm: (ScratchFrameMorph skinAt: 'titlePane').	workPane _ ScratchStageMorph new extent: WorkpaneExtent.	libraryPane _ ScratchLibraryMorph new.	"make panes sticky so clicking on them doesn't pick up entire frame"	self		addMorph: (topPane isSticky: true);		addMorph: (viewerPane isSticky: true);		addMorph: (scriptsPane isSticky: true);		addMorph: (workPane isSticky: true);		addMorph: (stageFrame isSticky: true);		addMorph: (titlePane isSticky: true);		addMorph: (libraryPane isSticky: true).	self createReadoutPane.	workPane comeToFront.! !!ScratchFrameMorph methodsFor: 'intialization' stamp: 'sk 6/15/2016 11:40'!createLogo	"Create and the Scratch logo."	logoMorph _ SketchMorph withForm: (ScratchFrameMorph skinAt: #studuinoLogo).	logoMorph position: topPane position + (12@8).	topPane addMorph: logoMorph.! !!ScratchFrameMorph methodsFor: 'intialization' stamp: 'KK 9/6/2013 10:48'!createMenuPanel	"Create and add a panel containing the menus and close button."	| menuSpecs m |	"create panel"	menuPanel _ AlignmentMorph new		color: Color transparent;		centering: #center;		inset: 0;		height: 0.	"will grow as needed"	self addShortcutButtonsTo: menuPanel.	"menuSpecs defines the menus"	menuSpecs _ #(		"name			selector"		(File			fileMenu:)		(Edit			editMenu:)		(Run			runMenu:)		(Help			helpMenu:)	).	ScratchMenuTitleMorph setMenuEnable: true.	menuSpecs do: [:spec |		m _ ScratchMenuTitleMorph new			contents: (spec at: 1) localized;			target: self selector: (spec at: 2).		menuPanel addMorphBack: m.		#helpMenu: = (spec at: 2) ifFalse: [			menuPanel addMorphBack: (Morph new color: Color transparent; extent: 12@5)]].	topPane addMorph: menuPanel.! !!ScratchFrameMorph methodsFor: 'intialization' stamp: 'sk 6/15/2016 10:39'!createToolbar	"Create and add the toolbar."	| buttonSpecs bName button |	toolbarPanel _ AlignmentMorph new		hResizing: #shrinkWrap;		vResizing: #shrinkWrap;		color: Color transparent.			buttonSpecs _ #(		"name			selector"			"tooltip""		(copy			copyTool		'Duplicate')		(delete			cutTool			'Delete')		(zoomIn 		zoomInTool		'Grow sprite')		(zoomOut 		zoomOutTool		'Shrink sprite')"	).	buttonSpecs do: [:spec |		bName _ spec at: 1.		button _ ToggleButton			onForm: (ScratchFrameMorph skinAt: (bName, 'ButtonPressed') asSymbol)			offForm: (ScratchFrameMorph skinAt: (bName, 'Button') asSymbol)			overForm: (ScratchFrameMorph skinAt: (bName, 'ButtonOver') asSymbol).		button			target: self;			actionSelector: (spec at: 2);			isMomentary: true;			setProperty: #balloonText toValue: (spec at: 3) localized.		toolbarPanel addMorphBack: button].	self addMorph: toolbarPanel.! !!ScratchFrameMorph methodsFor: 'intialization' stamp: 'KK 9/19/2013 10:23'!createViewModeButtonsPanel	| specs bName button |	viewModeButtonsPanel _ AlignmentMorph newRow		hResizing: #shrinkWrap;		vResizing: #shrinkWrap;		color: Color transparent.	viewModeButtons _ OrderedCollection new.	specs _ OrderedCollection new."	specs add: #(quarter			enterQuarterMode		'Switch to small stage').""	specs add: #(normal			enterNormalMode		'Switch to full stage').""	specs add: #(presentation	enterPresentationMode	'Switch to presentation mode')."	specs do: [:spec |		bName _ spec first.		button _ ToggleButton new			onForm: (ScratchFrameMorph skinAt: bName, 'ViewModeOn')			offForm: (ScratchFrameMorph skinAt: bName, 'ViewMode')			overForm: (ScratchFrameMorph skinAt: bName, 'ViewModeOver').		button			target: self;			actionSelector: (spec at: 2);			alphaOn: true;			setProperty: #balloonText toValue: (spec at: 3) localized.		viewModeButtonsPanel			addMorphBack: button;			addMorphBack: (Morph new extent: 1@5; color: Color transparent).		viewModeButtons add: button].	self addMorph: viewModeButtonsPanel.! !!ScratchFrameMorph methodsFor: 'intialization' stamp: 'sk 6/15/2016 11:41'!initialize	super initialize.	fillScreenFlag _ false.	paintingInProgress _ false.	projectInfo _ Dictionary new.	watcherPositions _ Dictionary new.	justSaved _ false.	author _ ''.	loginName _ ''.	loginPassword _ ''.	viewMode _ #normal.	self createBasicPanes.	self createLogo.	self createMenuPanel.	self createViewModeButtonsPanel.	self createStageButtonsPanel.	self createToolbar.	self extent: 1000@600.	libraryPane isHidden: true.	readoutPane isHidden: true.! !!ScratchFrameMorph methodsFor: 'accessing' stamp: 'KK 12/11/2014 11:41'!importScripts: fileNameOrData	"Read the sprite or project file and merge into the current project."	| data f importedStage defaultForm defaultSound oldName oldPosition sub register |	data _ fileNameOrData.	(data isKindOf: String) ifTrue: [  "read the contents of a local file"		(FileDirectory default fileExists: fileNameOrData) ifFalse: [^ self].		f _ (FileStream readOnlyFileNamed: fileNameOrData) binary.		f ifNil: [^ self].		data _ f contentsOfEntireFile].	[importedStage _ self extractScriptFrom: data] ifError: [^ self].	"fix references to old stage"	importedStage allMorphsDo: [:m |		(m isKindOf: WatcherMorph) ifTrue: [m mapReceiver: importedStage to: workPane].		(m isKindOf: ScriptableScratchMorph) ifTrue: [			m blocksBin submorphs do: [:stack |				(stack isKindOf: BlockMorph) ifTrue: [					stack blockSequence do: [:b | 						" In the case of control start block "						(b isMemberOf: EventHatMorph) ifTrue: [							(b eventName = 'Scratch-StartClicked') ifTrue: [								" Change to the function call block "								sub _ b submorphs.								b initialize.								b eventName:'localScriptStart'.								(sub first isMemberOf: StringMorph) ifFalse: [									b addMorph: sub first.								].							].						].						b mapReceiver: importedStage to: workPane]]]]].	"add global variables from importated stage to my stage"	importedStage varNames do: [:v |		workPane addVariable: v value: (importedStage getVar: v)].	"add imported stage scripts"	importedStage blocksBin submorphs do: [:stack |		" I do not register if the imported script's Control-Start Hat does not have any blocks. "		register _ true.		(stack isMemberOf: EventHatMorph) ifTrue: [			(stack eventName = 'localScriptStart') ifTrue: [				sub _ stack submorphs.				(sub first isMemberOf: EventTitleMorph) ifTrue: [					register _ false.				].			].		].		register ifTrue: [			(stack isKindOf: BlockMorph) ifTrue: [				workPane addStack: stack fullCopy.			].		].	].	"add imported background costumes and scripts to my stage, filtering out default items"	defaultForm _ workPane defaultImageMedia form hibernate.	defaultSound _ SoundMedia new sound.	importedStage media do: [:media |		(media isImage and: [media form hibernate bits ~= defaultForm bits])			ifTrue: [workPane addMediaItem: media].		(media isSound and: [media sound samples ~= defaultSound samples])			ifTrue: [workPane addMediaItem: media]].	importedStage submorphs do: [:m |		(m isKindOf: ScratchSpriteMorph) ifTrue: [			oldName _ m objName.			oldPosition _ m position - m owner position + (47@55).  "jm: I am not sure why this offset is needed. It's the rotation center of the default costume..."			self addAndView: m.  "assigns a new name"			m objName: oldName.			m position: workPane topLeft + oldPosition]].	workPane layoutChanged.! !!ScratchFrameMorph methodsFor: 'menu/button actions' stamp: 'KK 8/20/2014 13:14'!aboutScratch	| dialogBox |	dialogBox _ DialogBoxMorph new		title: 'About Block Programming Environment';		withButtonsForYes: false no: false okay: true cancel: false.	dialogBox		message: 'Based on Scratch from the MIT Media Lab, v', Version, 'Copyright  2014 Artec co., Ltd.All rights reserved.Developed by Artec co., Ltd. with the help of open source software.http://www.artec-kk.co.jp/en/'		font: (ScratchFrameMorph getFont: #AboutScratch).	dialogBox getUserResponse.! !!ScratchFrameMorph methodsFor: 'menu/button actions' stamp: 'sk 8/26/2016 18:10'!calibrateMotor[	ScratchMenuTitleMorph setMenuEnable: false.	(BoardType = 0) ifTrue: [		self shiftToCalibrationMode].	(BoardType = 1) ifTrue: [		self shiftToCalibrationModeMini].	(BoardType = 2) ifTrue: [		self shiftToCalibrationModeMini].	ScratchMenuTitleMorph setMenuEnable: true.] fork.! !!ScratchFrameMorph methodsFor: 'menu/button actions' stamp: 'sk 8/9/2016 16:33'!calibrateSvMotor| notification |[	 | s line |	ScratchMenuTitleMorph setMenuEnable: false.	" Communicate with Board Manager "	s _ self createBMHandle.	s ifNil: [^ self].	" Success in connection "	" -------------------------------------------------------------------- "	" Send message "	" -------------------------------------------------------------------- "	Transcript show: '---------- Sending BM ----------'; cr.	s sendCommand: 'CALIB'.	" -------------------------------------------------------------------- "	" Display Status DialogBox "	" -------------------------------------------------------------------- "	" Shifting ot calibration mode "	notification _ NotificationMessage show: 16r12.	" Wait for program creation and updating to end  "	Transcript show: '---------- Recving BM ----------'; cr.	line _ self waitForBMResponse: s.	(line = '-1') ifTrue: [		notification ifNotNil: [notification no].		^ self].	Transcript show: '---------- Recv message: '; show:line; show:' ----------'; cr.	notification no.	line = 'CALIBRATE' ifFalse: [		" ---------------------------------------------------------------- "		" receive ERR "		" ---------------------------------------------------------------- "		" Get error number "		line _ self waitForBMResponse: s.		(line = '-1') ifTrue: [^ self].		Transcript show: '---------- Recv message: '; show:line; show:' ----------'; cr.		"Wait for finish "		line _ self waitForBMResponse: s.		(line = '-1') ifTrue: [^ self].		Transcript show: '---------- Recv message: '; show:line; show:' ----------'; cr.		" Send message "		Transcript show: '---------- Sending ----------'; cr.		s sendCommand: 'BREAK'.		ErrorMessage show: 1.		s disconnect.		s destroy.	]	ifTrue: [		" ---------------------------------------------------------------- "		" receive CALIBRATE "		" ---------------------------------------------------------------- "		BoardStatus _ 3.		"Wait for finish calibration"		line _ self waitForBMResponse: s For: 36000.		(line = '-1') ifTrue: [^ self].		Transcript show: '---------- Recv message: '; show:line; show:' ----------'; cr.		(line = 'ERR') ifTrue: [			" Disconnect !! "			ErrorMessage show: 1].		" Send message "		Transcript show: '---------- Sending ----------'; cr.		s sendCommand: 'BREAK'.		s disconnect.		s destroy.	].	ScratchMenuTitleMorph setMenuEnable: true.] fork.! !!ScratchFrameMorph methodsFor: 'menu/button actions' stamp: 'KK 10/18/2013 15:23'!displayErrorMessage: erroNo"I display error message by erroNo"| dialogBox |(erroNo = 0) ifTrue: [	"DialogBoxMorph inform: 'Could not access to loaclhost' title: ' Board Manager '"	dialogBox _ DialogBoxMorph new.	dialogBox withButtonsForYes: false no: false okay: true cancel: false.	dialogBox title: 'Could not access localhost'.	dialogBox message: 'Please save your project and restart this software.'.	dialogBox openInWorld.		" Display Dialogbox "	dialogBox centerOnScreen.	" Set center position "	dialogBox world doOneCycle.].(erroNo = 1) ifTrue: [	"DialogBoxMorph inform: 'Could not connect' title: ' Board Manager '"	dialogBox _ DialogBoxMorph new.	dialogBox withButtonsForYes: false no: false okay: true cancel: false.	dialogBox title: 'Could not connect to Studuino'.	dialogBox message: 'Please save your project and restart this software.'.	dialogBox openInWorld.		" Display Dialogbox "	dialogBox centerOnScreen.	" Set center position "	dialogBox world doOneCycle.].! !!ScratchFrameMorph methodsFor: 'menu/button actions' stamp: 'sk 8/26/2016 18:15'!editMenu: t1 	| t2 |	t2 _ CustomMenu new.	t2 add: 'Undelete' action: #undoTool.	t2 addLine.	ScratchProcess blockHighlightMSecs <= 1		ifTrue: [t2 add: 'Start Single Stepping' action: #toggleSingleStepping]		ifFalse: [t2 add: 'Stop Single Stepping' action: #toggleSingleStepping].	t2 add: 'Set Single Stepping' action: #setSingleStepping.	t2 addLine.	t2 add: 'Export Arduino Language' action: #translateArduLang.	t2 addLine.	(DuringTest = true)	" During a test ? "	ifTrue: [ 	" yes -> hide "		t2 add: 'Port Settings' action: #setBoardIO.		"t2 add: 'Board selection' action: #selectBoardType." "Uncomment if Board selection is needed."		t2 localize.		#(3 4 5) do: [:t3 | t2 labels at: t3 put: ((t2 labels at: t3)					copyFrom: 1 to: (t2 labels at: t3) size - 1)					, ScratchTranslator ellipsesSuffix].	]	ifFalse: [	" no -> show "		t2 add: 'Motor Calibration' action: #calibrateMotor.		t2 add: 'Port Settings' action: #setBoardIO.		"t2 add: 'Board selection' action: #selectBoardType." "Uncomment if Board selection is needed."		t2 localize.		#(3 4 5 6) do: [:t3 | t2 labels at: t3 put: ((t2 labels at: t3)					copyFrom: 1 to: (t2 labels at: t3) size - 1)					, ScratchTranslator ellipsesSuffix].	].	t2 invokeOn: self at: t1 bottomLeft + (0 @ 10)! !!ScratchFrameMorph methodsFor: 'menu/button actions' stamp: 'KK 8/21/2013 10:31'!enableRemoteSensors	| t1 |	workPane scratchServer		ifNil: 			[t1 _ ScratchServer new userName: 'Scratch'.			t1 stage: workPane.			workPane scratchServer: t1].	workPane scratchServer startHosting.	DialogBoxMorph inform: 'Remote sensor connections enabled' localized! !!ScratchFrameMorph methodsFor: 'menu/button actions' stamp: 'KK 12/10/2014 10:51'!fileMenu: aMenuTitleMorph	| menu |	menu _ CustomMenu new.	menu add: 'New' action: #newScratchProject.	menu add: 'Open' action: #openScratchProject.	menu add: 'Save' action: #saveScratchProjectNoDialog.	menu add: 'Save As' action: #saveScratchProject.	menu addLine.	menu add: 'Import Scripts' action: #importScripts."	menu add: 'Export Sprite' action: #exportSprite.	menu addLine.	menu add: 'Project Notes' action: #editNotes."	Sensor shiftPressed ifTrue: [  "developer menu""		menu addLine.		menu add: 'Write Project Summary' action: #writeSummaryFile.		menu add: 'Write Multiple Project Summaries' action: #writeMultipleSummaries."		menu addLine.		fillScreenFlag			ifTrue: [				menu add: 'Exit User Mode' action: #fillScreenOff]			ifFalse: [				menu add: 'Enter User Mode' action: #fillScreenOn.				menu add: 'Save Image in User Mode' action: #saveImageForEndUser]].	menu addLine.	menu add: 'Quit' action: #quitScratch.	menu localize.	"	#(2 4 5 6 7) do: [:n |"	#(2 4 5) do: [:n |		menu labels at: n put:			((menu labels at: n) copyFrom: 1 to: (menu labels at: n) size - 1), ScratchTranslator ellipsesSuffix].	menu invokeOn: self at: aMenuTitleMorph bottomLeft + (0@10).! !!ScratchFrameMorph methodsFor: 'menu/button actions' stamp: 'sk 9/16/2016 16:56'!helpMenu: aMenuTitleMorph	| menu |	menu _ CustomMenu new."	menu add: 'Help Page' action: #launchHelpPage.""	menu add: 'Help Screens' action: #launchAllHelpScreens.""	menu addLine."	menu add: 'About Studuino Block Programming Environment' action: #aboutScratch."	menu add: 'Manual' action: #aboutPartsBlock2."	menu add: 'Board selection' action: #selectBoardType.	menu localize.	#(1) do: [:n |		menu labels at: n put:			((menu labels at: n) copyFrom: 1 to: (menu labels at: n) size - 1), ScratchTranslator ellipsesSuffix].	menu invokeOn: self at: aMenuTitleMorph bottomLeft + (0@10).! !!ScratchFrameMorph methodsFor: 'menu/button actions' stamp: 'sk 9/3/2015 11:33'!languageMenu: aToggleButtonMorph	"Present a menu of possible languages for blocks."	| bullet menu choice l msg |	ScratchTranslator canRenderUnicode ifFalse: [		"try to find a Unicode plugin in case this is the first use after startup"		ScratchTranslator detectRenderPlugin].	bullet _ UTF8 withAll: ' '.	menu _ CustomMenu new.	ScratchTranslator languageNames do: [:lang |		((ScratchTranslator isoCodeForName: lang) = (ScratchTranslator currentLanguage))			ifTrue: [menu add: (bullet, lang) action: lang]			ifFalse: [menu add: lang action: lang]].	choice _ menu startUp: nil withCaption: nil at: aToggleButtonMorph bottomLeft + (0@10).	choice ifNil: [^ self].	self stopAll.	self setLanguage: choice.	self recordLanguage: (ScratchTranslator currentLanguage).	l _ ScratchTranslator currentLanguage.	(LangDic includesKey: l)		ifTrue: [msg _ LangDic at: l.]		ifFalse: [msg _ 'LANGE'.].	self sendMessageToBM: msg.! !!ScratchFrameMorph methodsFor: 'menu/button actions' stamp: 'KK 8/19/2013 17:56'!launchHelpFile: aFilename	| helpDir subDir |	(FileDirectory default directoryNames includes: 'Help') ifFalse: [^ self beep].  "no help folder"	self stopAll.	helpDir _ FileDirectory default directoryNamed: 'Help'.	"use the English subfolder by default if it exists"	(helpDir directoryNames includes: 'en') ifTrue: [subDir _ helpDir directoryNamed: 'en'].	"use subfolder for the current language if it exists"	(helpDir directoryNames includes: ScratchTranslator currentLanguage) ifTrue: [		subDir _ helpDir directoryNamed: ScratchTranslator currentLanguage].	subDir ifNotNil: [helpDir _ subDir].	(helpDir fileExists: aFilename)		ifTrue: [Smalltalk isMacOSX			ifTrue: [ScratchPlugin primOpenURL: 'file://', (helpDir pathName, FileDirectory slash, aFilename) encodeForHTTP]			ifFalse: [ScratchPlugin primOpenURL: helpDir pathName, FileDirectory slash, aFilename]]		ifFalse: [			DialogBoxMorph inform: 'Scratch help file not found.' localized].! !!ScratchFrameMorph methodsFor: 'menu/button actions' stamp: 'sk 3/10/2016 22:19'!newScratchProject	"Make a new, blank Scratch project."	| response newProject |	self closeMediaEditorsAndDialogs ifFalse: [^ self].	self stopAll.	(DuringTest = true)	" During a test ? "	ifTrue: [ self testModeOff. ].	" yes -> off "	(justSaved or: [self projectIsEmpty]) ifFalse: [		"ask the user if they want to save the current project"		response _ DialogBoxMorph askWithCancel: 'Save the current project?'.		response = #cancelled ifTrue: [^ self].		response ifTrue: [self saveScratchProjectNoDialog.			justSaved ifFalse: [^ self]]].	projectDirectory _ ScratchFileChooserDialog getDefaultFolderForType: #project.	projectName _ ''.	projectInfo _ Dictionary new.	"self initIOPort." "Initializing Board.cfg & IOPort."	self initStuduinoGlobalVars.	"Initializing Board.cfg & IOPort."	newProject _ ScratchStageMorph new."	sprite _ ScratchFrameMorph defaultSprite fullCopy.	sprite position: (241@181) - sprite extent.	newProject addMorph: sprite."	self installNewProject: newProject.	self initializeWatcherPositions.	justSaved _ true.		self viewerPane refresh.	"self enterNormalMode."	scriptsPane cleanUp.! !!ScratchFrameMorph methodsFor: 'menu/button actions' stamp: 'sk 8/23/2016 18:23'!quitScratch	"Quit from Scratch. Ask the user if they want to save, first."	| response |	self closeMediaEditorsAndDialogs ifFalse: [^ self].	self stopAll.	(DuringTest = true)	" During a test ? "	ifTrue: [ self testModeOff. ].	" yes -> off "	(justSaved or: [self projectIsEmpty]) ifFalse: [		response _ ScratchCloseDialog new getUserResponse.		response = #cancelled ifTrue: [^ self].		response ifTrue: [			self saveScratchProjectNoDialog.			justSaved ifFalse: [^ self]]].	(self sendFinishToBM) ifFalse: [		Smalltalk snapshot: false andQuit: true].! !!ScratchFrameMorph methodsFor: 'menu/button actions' stamp: 'sk 4/27/2016 21:30'!runMenu: t1 	| t2 |	t2 _ CustomMenu new.	t2 add: 'Transfer' action: #runOnBoard.	(BoardType = 0) & (BoardStatus = 2)	ifTrue: [t2 add: 'Run ' action: #startProgram.]	ifFalse: [].	t2 addLine.	(DuringTest = true)	" During a test ? "	ifTrue: [ t2 add: 'Test OFF' action: #testModeOff. ]	" yes -> off "	ifFalse: [ t2 add: 'Test ON' action: #testMode. ].		" no -> start "	t2 localize."	#(3 ) do: [:t3 | t2 labels at: t3 put: ((t2 labels at: t3)				copyFrom: 1 to: (t2 labels at: t3) size - 1)				, ScratchTranslator ellipsesSuffix]."	t2 invokeOn: self at: t1 bottomLeft + (0 @ 10)! !!ScratchFrameMorph methodsFor: 'menu/button actions' stamp: 'sk 8/9/2016 16:41'!runOnBoard	"I create a source file written in Arduino language. 	 I make it and run on board in communication with board manager"	| s line dialogBox comPort msgID doBuild comNumber res |	" If test mode on, test mode off "	(DuringTest = true) ifTrue: [	" During a test? "		self testModeOff.	].	" Create a UserProgram.cpp "	doBuild _ self writeArduLangFile: 'user\artecRobot.cpp'.	(doBuild = false) ifTrue: [		" STOP Serial Communication "		^ self.	].	s _ self createBMHandle.	s ifNil: [^ self].	" Success in connection "	" Send message "	Transcript show: '---------- Sending ----------'; cr.	s sendCommand: 'RUN'.	" Display Status DialogBox "	dialogBox _ NotificationMessage show: 16r10.	"Building and updating"	" Waiting for BM's completing to build a program."	" Only if a board is Studuino mini. "	(BoardType = 1 or: [BoardType = 2]) ifTrue: [		Transcript show: '---------- Recving1 ----------'; cr.		line _ self waitForBMResponse: s.		(line = '-1') ifTrue: [			dialogBox ifNotNil: [dialogBox no].			^ self].		res _ line.		line _ self waitForBMResponse: s.		(line = '-1') ifTrue: [			dialogBox ifNotNil: [dialogBox no].			^ self].		msgID _ line. " Number "Transcript show: res; show: ' '; show: msgID; cr.		dialogBox no.		(res = 'OK') ifTrue: [			" Asking user to push a reset button. "			dialogBox _ NotificationMessage show: 16r20.	"Waiting for RESET"]		ifFalse: [	" Build error "			ErrorMessage show: msgID asNumber.			^ self.].	].	" Wait for program creation and updating to end  "	Transcript show: '---------- Recving2 ----------'; cr.	line _ self waitForBMResponse: s.	(line = '-1') ifTrue: [		dialogBox ifNotNil: [dialogBox no].		^ self].	comPort _ line.	COMPort _ comPort.	" set class value "	line _ self waitForBMResponse: s.	(line = '-1') ifTrue: [		dialogBox ifNotNil: [dialogBox no].		^ self].	msgID _ line sansPeriodSuffix.Transcript show:comPort; show:', '; show:msgID;cr.	" Display message "	" Hide Status DialogBox "	dialogBox no.	Transcript show:line;cr.	" Display message "	" Send message "	Transcript show: '---------- Sending ----------'; cr.	s sendCommand: 'BREAK'.	s disconnect.	s destroy.	BoardStatus _ 0.	(comPort ~= 'ERR') ifTrue: [		BoardStatus _ 2.	] ifFalse: [		(msgID = '2') ifTrue: [			" Close port if port was opened  by myself "			comNumber _ 1.			32 timesRepeat: [				ScratchPlugin closePort:comNumber.				comNumber _ comNumber + 1.			].		].		ErrorMessage show: msgID asNumber.	].! !!ScratchFrameMorph methodsFor: 'menu/button actions' stamp: 'KK 8/20/2013 10:55'!sendProgram	| |	"Create Arduino program and send it."	"Create Arduino program..."	self translateArduLang.! !!ScratchFrameMorph methodsFor: 'menu/button actions' stamp: 'sk 8/1/2016 10:28'!setBoardIO| result |[	 | s line filename f b i |	ScratchMenuTitleMorph setMenuEnable: false.	" Communicate with Board Manager "	s _ self createBMHandle.	s ifNil: [^ self].	" Success in connection "	" Send message "	Transcript show: '---------- Sending ----------'; cr.	s sendCommand: 'CONFIG'.	" Wait for program creation and updating to end  "	Transcript show: '---------- Recving ----------'; cr.	line _ self waitForBMResponse: s For: 36000.	(line = '-1') ifTrue: [^ self].	result _ line sansPeriodSuffix.	line _ self waitForBMResponse: s.	(line = '-1') ifTrue: [^ self].	Transcript show:line;cr.	" Display message "	" Send message "	Transcript show: '---------- Sending ----------'; cr.	s sendCommand: 'BREAK'.	"Delay forSeconds: 1."	"1000 timesRepeat: []."	s disconnect.	s destroy.	" If I/O Configuration is updated, update IOPort and TestMode OFF. "	result = 'UPDATE' ifTrue: [		" Get Configuration Info "		filename := 'Board.cfg'.		f _ FileStream fileNamed: filename.		f binary.		i _ 1.		[f atEnd] whileFalse: [			b _ f next.	" PartsID "			" I/O Port Configuration "			IOPort at:(i) put:b.			i _ i + 1.		].		(DuringTest = true)	" During a test ? "		ifTrue: [ self testModeOff. ].	" yes -> off "Transcript show:IOPort;cr.		self viewerPane refresh.		f close.		self setLanguage: (ScratchTranslator currentLanguage).	].	ScratchMenuTitleMorph setMenuEnable: true.] fork.! !!ScratchFrameMorph methodsFor: 'menu/button actions' stamp: 'sk 8/26/2016 18:11'!shiftToCalibrationMode	"Move onto calibration mode for Studuino."	| s notification line |	" Communicate with Board Manager "	s _ self createBMHandle.	s ifNil: [^ self].	" Success in connection "	" -------------------------------------------------------------------- "	" Send message "	" -------------------------------------------------------------------- "	Transcript show: '---------- Sending BM ----------'; cr.	s sendCommand: 'CALIB'.	" -------------------------------------------------------------------- "	" Display Status DialogBox "	" -------------------------------------------------------------------- "	" Shifting ot calibration mode "	notification _ NotificationMessage show: 16r12.	" Wait for program creation and updating to end  "	Transcript show: '---------- Recving BM ----------'; cr.	line _ self waitForBMResponse: s.	(line = '-1') ifTrue: [		notification ifNotNil: [notification no].		^ self].	Transcript show: '---------- Recv message: '; show:line; show:' ----------'; cr.	notification no.	line = 'CALIBRATE' ifFalse: [		" ---------------------------------------------------------------- "		" receive ERR "		" ---------------------------------------------------------------- "		" Get error number "		line _ self waitForBMResponse: s.		(line = '-1') ifTrue: [^ self].		Transcript show: '---------- Recv message: '; show:line; show:' ----------'; cr.		"Wait for finish "		line _ self waitForBMResponse: s.		(line = '-1') ifTrue: [^ self].		Transcript show: '---------- Recv message: '; show:line; show:' ----------'; cr.		" Send message "		Transcript show: '---------- Sending ----------'; cr.		s sendCommand: 'BREAK'.		ErrorMessage show: 1.		s disconnect.		s destroy.	]	ifTrue: [		" ---------------------------------------------------------------- "		" receive CALIBRATE "		" ---------------------------------------------------------------- "		BoardStatus _ 3.		"Wait for finish calibration"		line _ self waitForBMResponse: s For: 36000.		(line = '-1') ifTrue: [^ self].		Transcript show: '---------- Recv message: '; show:line; show:' ----------'; cr.		(line = 'ERR') ifTrue: [			" Disconnect !! "			ErrorMessage show: 1].		" Send message "		Transcript show: '---------- Sending ----------'; cr.		s sendCommand: 'BREAK'.		s disconnect.		s destroy.	].! !!ScratchFrameMorph methodsFor: 'menu/button actions' stamp: 'sk 8/26/2016 18:11'!shiftToCalibrationModeMini	"Move onto calibration mode for Studuino mini."	| s notification res |	" Communicate with Board Manager "	s _ self createBMHandle.	s ifNil: [^ self].	" Asking user to push a reset button. "	notification _ NotificationMessage show: 16r20.	"Waiting for RESET"	" Success in connection "	" -------------------------------------------------------------------- "	" Send message "	" -------------------------------------------------------------------- "	s sendCommand: 'CALIB'.	" Waiting for BM to transfer a testmode program. "	Transcript show: '---------- Recving ----------'; cr.	res _ self waitForBMResponse: s.	(res = '-1') ifTrue: [		notification ifNotNil: [notification no].		^ self].	notification no.	(BoardType = 2) ifTrue: [		(res = 'OK') ifFalse: [			" Getting error number "			res _ self waitForBMResponse: s.			(res = '-1') ifTrue: [				notification ifNotNil: [notification no].				^ self].			" Notify timeout error. "			ErrorMessage show: res asNumber.			^ self].		" Asking user to push a reset button. - 2 - "		notification _ NotificationMessage show: 16r21.	"Waiting for RESET"		" Waiting for BM to transfer a testmode program. "		Transcript show: '---------- Recving1 ----------'; cr.		res _ self waitForBMResponse: s.		(res = '-1') ifTrue: [			notification ifNotNil: [notification no].			^ self].		notification no].	(res = 'OK') ifTrue: [		"Waiting INITOK"		res _ self waitForBMResponse: s.		(res = '-1') ifTrue: [			notification ifNotNil: [notification no].			^ self].		(res = 'INITOK') ifTrue: [			" Do nothing "]		ifFalse: [			notification no.			ErrorMessage show: 100.			^ self]]	ifFalse: [		" Notify error. "		Transcript show: '---------- Error ----------'; cr.		"Getting an error number."		notification no.		res _ self waitForBMResponse: s.		(res = '-1') ifTrue: [			notification ifNotNil: [notification no].			^ self].		ErrorMessage show: res asNumber.		^ self].		" ---------------------------------------------------------------- "		" Waiting for the calibration done.                          "		" ---------------------------------------------------------------- "		notification no.		BoardStatus _ 3.		"Wait for finish calibration"		res _ self waitForBMResponse: s For: 36000.		(res = '-1') ifTrue: [			notification ifNotNil: [notification no].			^ self].		Transcript show: '---------- Recv message: '; show:res; show:' ----------'; cr.		(res = 'ERR') ifTrue: [			" Disconnect !! "			ErrorMessage show: 1].		" Send message "		Transcript show: '---------- Sending ----------'; cr.		s sendCommand: 'BREAK'.		s disconnect.		s destroy.! !!ScratchFrameMorph methodsFor: 'menu/button actions' stamp: 'sk 8/24/2015 17:00'!shoutGo	"Broadcasts the start event to all objects and processes."	self stopAll.	workPane broadcastEventNamed: 'Scratch-StartClicked' with: 0.	flagButton on.	World displayWorldSafely.  "force button flash"	Delay waitMSecs: 20.! !!ScratchFrameMorph methodsFor: 'menu/button actions' stamp: 'sk 3/3/2016 11:05'!showSensorBoard	| sb |	sb _ workPane sensorBoard.	sb position: self workPane position + 20.	self workPane addMorph: sb.	" Only if a board is Studuino. "	(BoardType = 0) ifTrue: [		sb tryToOpenPort.].	World startSteppingSubmorphsOf: sb.! !!ScratchFrameMorph methodsFor: 'menu/button actions' stamp: 'KK 9/14/2013 14:13'!startProgram	| sb |	"I restart program on board"	sb _ workPane sensorBoard.	sb openPort: COMPort.	sb closePort.! !!ScratchFrameMorph methodsFor: 'menu/button actions' stamp: 'KK 2/10/2014 10:28'!stopAll	"Tell my workPane to stop everything."	| oldJustSaved |	oldJustSaved _ justSaved.	workPane stopAll.	justSaved _ oldJustSaved.! !!ScratchFrameMorph methodsFor: 'menu/button actions' stamp: 'sk 6/10/2016 17:52'!testMode	| |	workPane stopAll.	(BoardType = 0) ifTrue: [		self shiftToTestMode.].	(BoardType = 1) ifTrue: [		self shiftToTestModeMini.].	(BoardType = 2) ifTrue: [		self shiftToTestModeMini2.].! !!ScratchFrameMorph methodsFor: 'menu/button actions' stamp: 'sk 3/24/2016 21:54'!testModeOff	| sb bmSocket |	workPane stopAll.	sb _ workPane sensorBoard.	(BoardType = 0) ifTrue: [ " Studuino "		" Close port "			sb closePort.]	ifFalse: [ " Studuino mini "		" Close socket "		bmSocket _ self createBMHandle.		bmSocket ifNotNil: [			bmSocket sendCommand: 'TEST2E'.			bmSocket getResponseShowing: true. "Waiting ACK"				bmSocket disconnect.			bmSocket destroy].		sb closeSocket.].	" Hide SensorBoard "	sb delete.	DuringTest _ false.! !!ScratchFrameMorph methodsFor: 'menu/button actions' stamp: 'KK 8/2/2013 11:41'!translateArduLang	"Translate block into Arduino language and write to a file."	self writeArduLangFile: ''.! !!ScratchFrameMorph methodsFor: 'menu/button actions' stamp: 'KK 8/19/2014 14:21'!uniqueSummaryFileName	| baseName fileName n |	baseName _ self projectName.	baseName size <= 1 ifTrue: [baseName _ 'newProject'].	fileName _ baseName, '.ino'.	n _ 1.	[FileDirectory default fileExists: fileName] whileTrue: [		fileName _ baseName, n printString, '.ino'.		n _ n + 1].	^ fileName! !!ScratchFrameMorph methodsFor: 'menu/button actions' stamp: 'sk 7/7/2016 19:36'!writeArduLangFile: fullFileName	"Translate block into Arduino language and write to a file."	| s sprites f fName ltmp dir headCode footCode dialogBox response  blocks |	"Convert to block sign"	ltmp _ ScratchTranslator currentLanguage.	"---------------------------------------------------------"	" Check hatless blocks "	"---------------------------------------------------------"	blocks _ workPane getHatlessBlocks.	(blocks size = 0) ifFalse: [	" exist hatless blocks "		" Display a hatless block in red "		blocks do: [:item |			item color: Color red.		].		" Warn the hatless block exists "		dialogBox  _ DialogBoxMorph new.		dialogBox withButtonsForYes: true no: true okay: false cancel: false.		dialogBox title: 'Unconnected blocks present'.		dialogBox openInWorld.		" Display Dialogbox "		dialogBox centerOnScreen.	" Set center position "		dialogBox world doOneCycle.		(fullFileName size = 0) ifFalse: [			" Transfer "			dialogBox message: 'These blocks will not be built.Do you wish to continue?'.		] ifTrue: [			" Export Arduino Language "			dialogBox message: 'These blocks will not be exported to Arduino Language.Do you wish to continue?'.		].		" Stop Building "		response _ dialogBox getUserResponse.		(response = false) ifTrue: [			self setLanguage: ltmp. 			 ^ false.		].	].	" Continue Building "	self setLanguage: ltmp. 	" Build... "	self setLanguage: 'atc'. 	s _ WriteStream on: (String new: 10000).	workPane printArduLangOn: s.	self setLanguage: ltmp. 	sprites _ workPane submorphs select: [:m | m isKindOf: ScratchSpriteMorph].	sprites do: [:m |		s skip: -2.  "remove last cr"		s nextPutAll: '--------'; cr.		m printSummaryOn: s]."	s nextPutAll: '--------'; cr."	ParagraphEditor clipboardTextPut: s contents asText.	fName _ fullFileName.	fullFileName size = 0		ifTrue: [			fName _ ScratchFileChooserDialog				chooseNewFileDefault: self uniqueSummaryFileName				title: 'File Name?'				type: #projectSummary.			fName = #cancelled ifTrue: [				"Turn setting laguage"				self setLanguage: ltmp. 				^ self].			f _ CrLfFileStream newScratchFileNamed: fName.		]		ifFalse: [			(StandardFileStream isAFileNamed: fName) ifTrue: [				" Exist file "				dir _ FileDirectory default directoryNamed: 'user'.	" Get target directory "				dir deleteFileNamed: 'artecRobot.cpp'.					" delete file "			].			f _ StandardFileStream new open: fName forWrite: true.		].	f ifNil: [		"Turn setting laguage"		self setLanguage: ltmp. 		^ self].	" Head and Footer file "	" Default English. "	headCode _ StandardFileStream new open: 'code\head_en.txt' forWrite: false.	footCode _ StandardFileStream new open: 'code\foot_en.txt' forWrite: false.	((ltmp = 'ja') | (ltmp = 'ja_HIRA')) ifTrue: [		Transcript show: '---------- Trans to Japan ----------'; cr.		(BoardType = 0 or: [BoardType = 2]) ifTrue: [			headCode _ StandardFileStream new open: 'code\head.txt' forWrite: false.]		ifFalse: [			headCode _ StandardFileStream new open: 'code\head_mini.txt' forWrite: false.].		footCode _ StandardFileStream new open: 'code\foot.txt' forWrite: false.	]	ifFalse: [		(ltmp = 'zh_CN') ifTrue: [			Transcript show: '---------- China ----------'; cr.			headCode _ StandardFileStream new open: 'code\head_zh.txt' forWrite: false.			footCode _ StandardFileStream new open: 'code\foot_zh.txt' forWrite: false.		]		ifFalse: [			(ltmp = 'ko') ifTrue: [				Transcript show: '---------- Korea ----------'; cr.				headCode _ StandardFileStream new open: 'code\head_ko.txt' forWrite: false.				footCode _ StandardFileStream new open: 'code\foot_ko.txt' forWrite: false.			]		].	].	[headCode atEnd] whileFalse: [		f nextPut: headCode next.	].	f nextPutAll: ((s contents) asUTF8).	[footCode atEnd] whileFalse: [		f nextPut: footCode next.	].	headCode close.	footCode close.	f close.	"Turn setting laguage"	self setLanguage: ltmp. ! !!ScratchFrameMorph methodsFor: 'geometry' stamp: 'KK 8/19/2014 15:02'!fixLayout	| stageExtent xyReadout w |	stageExtent _		workPane isQuarterSize			ifTrue: [(360@(self bottom)) - (0@(stageFrame top+42))]			ifFalse: [(360@(self bottom)) - (0@(stageFrame top+42))].	topPane		position: self topLeft;		width: self width;		height: (menuPanel height + 0 max: logoMorph height + 10).	stageFrame		extent: stageExtent + (14@42);		top: topPane bottom;		right: self right.	titlePane		position: stageFrame topLeft + (0@1);		width: stageFrame width - 6;		height: 36.	self fixProjectTitleMorphLayout.	scriptsPane fixLayout.	w _ (viewerPane catButtonsExtent x + 17)		within: 40		and: (self width - (scriptsPane bareMinimumWidth + stageFrame width)).	viewerPane position: topPane bottomLeft;		width: w;		height: self bottom - topPane bottom.	scriptsPane		position: viewerPane topRight;		width: self width - (stageFrame width + viewerPane width);		height: self bottom - topPane bottom;		fixLayout."	libraryPane position: stageFrame bottomLeft;		width: (self right - scriptsPane right);		height: self bottom - libraryPane top."	libraryPane delete.	menuPanel		left: logoMorph right + 18;		top: topPane top + ((topPane height - menuPanel height) // 2) + 2.	viewModeButtonsPanel		right: stageFrame right - 8;		top: self top + 7.	stageButtonsPanel		position: (stageFrame left + 10)@(topPane bottom + 5);		width: stageFrame width - 28;		height: (workPane top - stageFrame top) - 8.	xyReadout _ readoutPane submorphs at: 1.	readoutPane		width: xyReadout width + 23;		height: xyReadout height + 15;		position: stageFrame bottomRight - ((readoutPane width + 6)@3).	xyReadout position: readoutPane position + (18@5).	toolbarPanel		left: (stageFrame left - 4 max: menuPanel right);		top: self top + ((topPane height - toolbarPanel height) // 2) + 3.	((toolbarPanel right - 5) > viewModeButtonsPanel left)		ifTrue: [toolbarPanel delete]		ifFalse: [			(toolbarPanel owner = self) ifFalse: [				self addMorphFront: toolbarPanel]].	workPane position: stageFrame topLeft + (4@37).	workPane height: stageExtent y - 20.	workPane width: 360.! !!ScratchFrameMorph methodsFor: 'stepping' stamp: 'sk 9/23/2016 20:49'!processDroppedFiles	"Process any files that have been dropped onto me."	| droppedFiles m dropPoint fName |	droppedFiles _ FileStream droppedFiles.	droppedFiles size = 0 ifTrue: [^ self].	(m _ self viewerPane target) ifNil: [^ self].	dropPoint _ droppedFiles first.	(droppedFiles copyFrom: 2 to: droppedFiles size) do: [:file |		file close.		fName _ file fullName.		((fName asLowercase endsWith: '.bpd'))			ifTrue: [self openScratchDroppedProjectNamed: fName]			ifFalse: [				(fName asLowercase endsWith: '.sprite')					ifTrue: [self importSpriteOrProject: fName]					ifFalse: [m importMedia: fName]]].! !!ScratchFrameMorph methodsFor: 'stepping' stamp: 'sk 6/8/2016 16:41'!step	"Run each process until it gives up control, then filter out any processes that have terminated."	| screenExtent oldJustSaved |	fillScreenFlag ifTrue: [		screenExtent _ Display extent.		((self position = (0@0)) and: [self extent = screenExtent]) ifFalse: [			oldJustSaved _ justSaved.			self position: 0@0.			self extent: screenExtent.			self enterQuarterModeIfSmallScreen.			scriptsPane currentCategory: scriptsPane currentCategory.			justSaved _ oldJustSaved.			^ self]].	workPane ifNotNil: [		ScriptableScratchMorph scratchOrigin: workPane center.		viewerPane target isNil 			ifTrue: [workPane viewBlocksAndScripts]			ifFalse: [viewerPane target isInWorld ifFalse: [workPane viewBlocksAndScripts]]].	Sensor processOSMenuEvents.	paintingInProgress ifTrue: [^ self].	workPane scratchServer ifNotNil: [workPane scratchServer stepServer].	self checkForWeDo.	self updateToolButtons.	self processWhenConditions.	self processKeyboardEvents.	workPane stepProcesses.	workPane scratchServer ifNotNil: [workPane scratchServer stepServer].	self processDroppedFiles.	workPane processesToRun size > 0		ifTrue: [flagButton on]		ifFalse: [flagButton off].	(workPane sensorBoard disconnected) ifTrue: [Transcript show: 'disconnected'; cr.		self testModeOff.		workPane sensorBoard disconnected: false].! !!ScratchFrameMorph methodsFor: 'stepping' stamp: 'sk 7/29/2016 17:30'!waitForBMResponse: s For: seconds	| line |	" I receive message from Board Manager and return message"	line _ WriteStream on: String new.	line _ s getBMResponseFor: seconds.	^ line sansPeriodSuffix.! !!ScratchFrameMorph methodsFor: 'view mode' stamp: 'KK 9/4/2013 09:41'!enterNormalMode	"Go into normal (full-stage) mode."	(viewMode = #normal) ifTrue: [		self updateViewModeButtons.		^ self].	viewMode _ #normal.	workPane isQuarterSize: false.	workPane isInWorld		ifTrue: [self fixLayout]		ifFalse: [self exitPresentationMode].	stageFrame initFromForm: (ScratchFrameMorph skinAt: 'spriteLibraryPaneFrameTransparent2').	self removeAllMorphs.	self		addMorph: (topPane isSticky: true);		addMorph: (viewerPane isSticky: true);		addMorph: (scriptsPane isSticky: true);		addMorph: (stageFrame isSticky: true);		addMorph: (workPane isSticky: true);		addMorph: (titlePane isSticky: true);		addMorph: (libraryPane isSticky: true).	libraryPane delete.	self updatePanes.	self updateViewModeButtons.! !!ScratchFrameMorph methodsFor: 'view mode' stamp: 'KK 9/3/2013 16:42'!enterQuarterMode	"Go into quarter stage mode."	(viewMode = #quarter) ifTrue: [		self updateViewModeButtons.		^ self].	viewMode _ #quarter.	workPane isQuarterSize: true.	workPane isInWorld		ifTrue: [self fixLayout]		ifFalse: [self exitPresentationMode].	stageFrame initFromForm: (ScratchFrameMorph skinAt: 'spriteLibraryPaneFrameTransparent2').	self removeAllMorphs.	self		addMorph: (topPane isSticky: true);		addMorph: (viewerPane isSticky: true);		addMorph: (scriptsPane isSticky: true);		addMorph: (workPane isSticky: true);		addMorph: (stageFrame isSticky: true);		addMorph: (titlePane isSticky: true);		addMorph: (libraryPane isSticky: true).	libraryPane delete.	self updatePanes.	self updateViewModeButtons.! !!ScratchFrameMorph methodsFor: 'other' stamp: 'KK 10/2/2013 15:58'!view: aMorph tab: t category: c	"Add given morph to the work pane and view it."	scriptsPane target: aMorph.	scriptsPane tabPane currentTab: t.	viewerPane		target: aMorph;		currentCategory: c.! !!ScratchFrameMorph methodsFor: 'startup' stamp: 'KK 10/25/2013 15:16'!processSettingsFile	"Process settings from the Scratch.ini file."	| lang settings k |	self class setVisibleDrives: nil.	lang _ nil.	ScratchFileChooserDialog clearFolderCache. "clear homeDir and last folder cache"	settings _ self readSettingsFile.	AopenFile _ ''.	settings associationsDo: [:assoc |		k _ assoc key.		k = 'openfile' ifTrue: [ AopenFile _ assoc value].		k = 'language' ifTrue: [lang _ assoc value].		k = 'home' ifTrue: [ScratchFileChooserDialog setHomeDir: assoc value].		k = 'visibledrives' ifTrue: [self class setVisibleDrives: assoc value]].	lang ifNil: [lang _ ScratchTranslator guessLanguage].	self setLanguage: lang.! !!ScratchFrameMorph methodsFor: 'startup' stamp: 'sk 11/16/2015 16:05'!readSettingsFile	"Read my settings file and answer a Dictionary of settings."	"ScratchFrameMorph new readSettingsFile"	| f dict s tokens k |	f _ FileStream readOnlyFileNamedOrNil: 'Scratch.ini'.	f ifNil: [^ Dictionary new].	dict _ Dictionary new.	f contentsOfEntireFile lines do: [:line |		s _ line collect: [:c | (c asciiValue < 32) ifTrue: [Character space] ifFalse: [c]].		tokens _ s findTokens: '='.		k _ tokens first withBlanksTrimmed asLowercase.		tokens size = 2			ifTrue: [dict at: k put: tokens second withBlanksTrimmed]			ifFalse: [dict at: k put: '1']].	^ dict! !!ScratchFrameMorph methodsFor: 'startup' stamp: 'sk 9/23/2016 13:51'!startup	| startupFileNames fileName arg presentationMode |	HostSystemMenus startUp.	HostSystemMenus menuBarControler reviseHostMenus.	ScriptableScratchMorph randomInit.	ScratchTranslator detectRenderPlugin.	ScratchTranslator importLanguagesList.	self processSettingsFile.	self readDefaultNotes.	self updateProjectName.	shuffledCostumeNames _ nil.	author _ ''.	loginName _ ''.	loginPassword _ ''.	justSaved _ true.	presentationMode _ false.	"Reset BoardStatus"	BoardStatus _ -1.	startupFileNames _ InputSensor startupFileNames asOrderedCollection.	2 to: 10 do: [:i |		arg _ Smalltalk getSystemAttribute: i.		(arg notNil and: [arg size > 0]) ifTrue: [			startupFileNames addLast: (ScratchPlugin primShortToLongPath: arg)]].	startupFileNames do: [:n |		(n asLowercase = 'presentation') ifTrue: [presentationMode _ true].		(n asLowercase = 'fullscreen') ifTrue: [TakeOverScreen _ true]].	TakeOverScreen ifTrue: [		Smalltalk fullScreenMode: true.		World restoreDisplay].	self enterQuarterModeIfSmallScreen.	fileName _ startupFileNames		detect: [:fn |			(fn asLowercase endsWith: '.bpd')]		ifNone: [nil].	fileName ifNotNil: [		presentationMode ifTrue: [Display fillColor: Color black].		self openScratchProjectNamed: fileName.		presentationMode ifTrue: [self enterPresentationMode; shoutGo].		^ self].	viewerPane currentCategory: 'motion'.	self setDefaultSprite.	self newScratchProject.	fileName _ startupFileNames		detect: [:fn | fn asLowercase endsWith: '.sprite']		ifNone: [^ self].	"open a .sprite file"	workPane submorphs do: [:m | (m isKindOf: ScratchSpriteMorph) ifTrue: [m deleteSprite]].	self importSpriteOrProject: fileName.! !!ScratchFrameMorph methodsFor: 'file read/write' stamp: 'KK 9/5/2013 16:41'!extractInfoFrom: aByteArray	"Answer a Scratch info dictionary from the given ByteArray. Answer an empty dictionary if it is an old project."	| s version |	s _ ReadStream on: aByteArray.	version _ ObjStream scratchFileVersionFrom: (s next: 10) asString.	(version = 1) | (version = 2)		ifTrue: [			s skip: IOPort size.			s skip: 4.  "skip info header byte count"			^ ObjStream new readObjFrom: s showProgress: false]		ifFalse: [^ Dictionary new].! !!ScratchFrameMorph methodsFor: 'file read/write' stamp: 'KK 4/20/2015 10:23'!extractProjectFrom: aByteArray	"Answer a Scratch project (i.e. a ScratchStageMorph possibly containing sprites) from the given ByteArray. Answer nil if the project cannot be unpacked."	| s version proj prev dialogBox |	s _ ReadStream on: aByteArray.	version _ ObjStream scratchFileVersionFrom: (s next: 10) asString.	version = 0 ifTrue: [		s position: 0.		proj _ ObjStream new readObjFrom: s showProgress: true].	(version = 1) | (version = 2) ifTrue: [		versionConflict _ false.		s _ self setIOPortFrom: s put: true.	" Copy pin assing information to IOPort Array "		"-----------------------------------"		" Skip header data and check BPE version "		s uint32.						" skip header size "		ObjStream new readObjFrom: s.	" skip Object Table "		prev _ s position.				" store current position "		versionConflict ifTrue: [			" Block Programming Environment ver1.X - "			" Display Message "			dialogBox _ DialogBoxMorph new.			dialogBox withButtonsForYes: false no: false okay: true cancel: false.			dialogBox title: 'This project may not be able to properly open.'.			dialogBox message: 'Project you are trying to open might be using a block that can not be displayed in this programming environment. It is recommended that you update the programming environment to the latest version.'.			dialogBox openInWorld.		" Display Dialogbox "			dialogBox centerOnScreen.	" Set center position "			dialogBox world doOneCycle.			s position:prev.	" Back to Object Table header "		]		ifFalse: [			" Block Programming Environment ver1.0 "			s position:prev.	" Back to Object Table header "		].		"-----------------------------------""		s skip: s uint32."  "skip header"		proj _ ObjStream new readObjFrom: s showProgress: true].	proj class = ScratchStageMorph ifFalse: [		version > 2			ifTrue: [self error: 'Project created by a later version of Scratch']			ifFalse: [self error: 'Problem reading project.'].		^ nil].	ScriptableScratchMorph buildBlockSpecDictionary.	proj allMorphsDo: [:m |		(m isKindOf: ScriptableScratchMorph) ifTrue: [  "covert to new blocks"			m convertStacksToTuples.			m convertTuplesToStacks]]."Transcript show:'ScratchFrameMorph::extractProjectFrom:';cr."	^ proj! !!ScratchFrameMorph methodsFor: 'file read/write' stamp: 'KK 4/20/2015 11:50'!extractScriptFrom: aByteArray	"Answer a Scratch project (i.e. a ScratchStageMorph possibly containing sprites) from the given ByteArray. Answer nil if the project cannot be unpacked."	| s version proj dialogBox |	s _ ReadStream on: aByteArray.	version _ ObjStream scratchFileVersionFrom: (s next: 10) asString.	version = 0 ifTrue: [		s position: 0.		proj _ ObjStream new readObjFrom: s showProgress: true].	(version = 1) | (version = 2) ifTrue: [		versionConflict _ false.		s _ self setIOPortFrom: s put: false.		versionConflict ifTrue: [			" Block Programming Environment ver1.X - "			" Display Message "			dialogBox _ DialogBoxMorph new.			dialogBox withButtonsForYes: false no: false okay: true cancel: false.			dialogBox title: 'This script may not be able to properly open.'.			dialogBox message: 'Script you are trying to open might be using a block that can not be displayed in this programming environment. It is recommended that you update the programming environment to the latest version.'.			dialogBox openInWorld.		" Display Dialogbox "			dialogBox centerOnScreen.	" Set center position "			dialogBox world doOneCycle.		].		s skip: s uint32.  "skip header"		proj _ ObjStream new readObjFrom: s showProgress: true].	proj class = ScratchStageMorph ifFalse: [		version > 2			ifTrue: [self error: 'Project created by a later version of Scratch']			ifFalse: [self error: 'Problem reading project.'].		^ nil].	ScriptableScratchMorph buildBlockSpecDictionary.	proj allMorphsDo: [:m |		(m isKindOf: ScriptableScratchMorph) ifTrue: [  "covert to new blocks"			m convertStacksToTuples.			m convertTuplesToStacks]].	^ proj! !!ScratchFrameMorph methodsFor: 'file read/write' stamp: 'KK 1/13/2015 15:58'!importScripts	"Allow the user to select a project to open, then merge that project's sprites with thecurrent project."	| response ltmp |	self closeMediaEditorsAndDialogs ifFalse: [^ self].	self stopAll.	response _ ScratchFileChooserDialog		chooseExistingFileType: #project		extensions: #(bpd)		title: 'Import Project'.	response ifNil: [^ self].	self importScripts: response.	ltmp _ ScratchTranslator currentLanguage.	self setLanguage: 'atc'. 	self setLanguage: ltmp. ! !!ScratchFrameMorph methodsFor: 'file read/write' stamp: 'sk 6/29/2016 11:54'!installNewProject: newWorkpane	"Called after creating or reading a new project to clear the process scheduler, pick an object to view, clear the library thumbnails, and perform other housekeeping."	| viewTarget sb |	self stopAll.	IOPort ifNil: [ IOPort _ Array new:18. ].	SvCalib ifNil: [ SvCalib _ Array new:8. ].	DCCalib ifNil: [ DCCalib _ Array new:2. ].	SvDegree ifNil: [ SvDegree _ Array new:8. ].	SvDegreeTemp ifNil: [ SvDegreeTemp _ Array new:8. ].	SvSentAlready ifNil: [ SvSentAlready _ Array new:8. ].	SvCalib atAllPut: 0.	DCCalib atAllPut: 100.	SvDegree atAllPut: 90.	SvDegreeTemp atAllPut: 90.	SvSentAlready atAllPut: false.	ServomotorSynchroMotion _ false.	newWorkpane class = ScratchStageMorph		ifFalse: [^ self inform: 'Incompatible Scratch file format'].	"self exitScratchSession."	workPane scratchServer ifNotNil: [		workPane scratchServer clearCaches.		workPane scratchServer stage: newWorkpane.		newWorkpane scratchServer: workPane scratchServer].	newWorkpane isQuarterSize: workPane isQuarterSize.	newWorkpane bounds: workPane bounds.	newWorkpane midiPortNum: workPane midiPortNum.	workPane closeMIDI.	"use the same sensorboard for the new project"	sb _ workPane sensorBoard.	newWorkpane submorphs do: [:m |		(m isKindOf: SensorBoardMorph) ifTrue: [			sb position: m position.			newWorkpane replaceSubmorph: m by: sb.			sb tryToOpenPort]].	newWorkpane sensorBoard: sb.	workPane owner replaceSubmorph: workPane by: newWorkpane.	workPane _ newWorkpane.	self fixByteReversedSounds.	"fix sprite positions (backward compatability)"	workPane submorphs do: [:m |		(m isKindOf: WatcherMorph) ifTrue: [m convertFromOldWatcher].		(m respondsTo: #costume) ifTrue: [			m position: m position + m costume rotationCenter]. "fix up positions"		m layoutChanged].	workPane layoutChanged.	"reset timer"	ScriptableScratchMorph resetTimer.	"pick an object view, or view the background if there is no other"	viewTarget _ workPane.	workPane submorphs do: [:m |		(m respondsTo: #scripts) ifTrue: [			m scripts size >= viewTarget scripts size ifTrue: [viewTarget _ m]]].	viewTarget viewBlocksAndScripts.	"populate the sprites list if it is empty (backward compatability)"	workPane sprites isEmpty ifTrue: [		workPane submorphs do: [:m |			(m isKindOf: ScriptableScratchMorph) ifTrue: [workPane sprites addLast: m]]].	scriptsPane tabPane currentTab: 'Scripts'.	libraryPane clearLibrary.	workPane clearPenTrails.	self updateProjectName.	ScratchProcess blockHighlightMSecs: 1.	ScratchPrompterMorph clearLastAnswer.	(projectInfo at: 'isHosting' ifAbsent: [false]) ifTrue: [		self enableRemoteSensors].	(projectInfo at: 'hasMotorBlocks' ifAbsent: [false]) ifTrue: [		self showMotorBlocks].	(projectInfo includesKey: 'penTrails') ifTrue: [		workPane penTrailsForm: (projectInfo at: 'penTrails')].	Clipboard _ nil.	World cleanseStepList.  "make sure garbage collect can clean up the old sprites"	Smalltalk garbageCollect.  "get rid of old sprite instances"	self world ifNotNil: [self world startSteppingSubmorphsOf: self].	ScriptableScratchMorph scratchOrigin: workPane center.	justSaved _ true.! !!ScratchFrameMorph methodsFor: 'file read/write' stamp: 'KK 9/26/2013 16:46'!nameFromFileName: fileName	"Return the given Scratch file name without the trailing .sb or .scratch extension, if it has one. Ensure the the result is UTF8."	| s |	s _ fileName.	(s asLowercase endsWith: '.scratch') ifTrue: [s _ s copyFrom: 1 to: s size - 8].	(s asLowercase endsWith: '.sb') ifTrue: [s _ s copyFrom: 1 to: s size - 3].	(s asLowercase endsWith: '.bpd') ifTrue: [s _ s copyFrom: 1 to: s size - 4].	s isUnicode ifFalse: [s _ UTF8 withAll: s].	^ s! !!ScratchFrameMorph methodsFor: 'file read/write' stamp: 'KK 10/25/2013 13:56'!openScratchProject	"Allow the user to select a project to open, then open that project."	| response newProj |	self closeMediaEditorsAndDialogs ifFalse: [^ self].	self stopAll.	(DuringTest = true)	" During a test ? "	ifTrue: [ self testModeOff. ].	" yes -> off "	(justSaved or: [self projectIsEmpty]) ifFalse: [		"ask the user if they want to save the current project"		response _ DialogBoxMorph askWithCancel: 'Save the current project?'.		response = #cancelled ifTrue: [^ self].		response ifTrue: [self saveScratchProjectNoDialog]].	response _ ScratchFileChooserDialog openScratchFileFor: self.	response = #cancelled ifTrue: [^ self].	(response isKindOf: String) ifTrue: [  "read the contents of a local file"		^ self openScratchProjectNamed: response].	(response isKindOf: ByteArray) ifTrue: [		[projectInfo _ self extractInfoFrom: response] ifError: [projectInfo _ Dictionary new].		[newProj _ self extractProjectFrom: response] ifError: [^ self].		self installNewProject: newProj.		projectDirectory _ ScratchFileChooserDialog getDefaultFolderForType: #project].! !!ScratchFrameMorph methodsFor: 'file read/write' stamp: 'KK 9/10/2013 14:52'!openScratchProjectNamed: fName	"Open a Scratch project with the given name."	| f projData newProj dir fn filename |	self closeMediaEditorsAndDialogs ifFalse: [^ self].		fn _ fName.	f _ FileStream readOnlyFileNamedOrNil: fn. 	f ifNil: ["try a different encoding, fixes a Firefox bug, -Jens"		fn _ fName isoLatinToMac asUTF8.		f _ FileStream readOnlyFileNamedOrNil: fn.		f ifNil: [^ self inform: 'Could not read' withDetails: fName]].	[	projData _ f binary contentsOfEntireFile.		newProj _ self extractProjectFrom: projData.		projectInfo _ self extractInfoFrom: projData.	] ifError: [:err :rcvr | ^ self inform: 'Could not read project; file may be damaged' withDetails: '(', err, ')'].	dir _ FileDirectory dirPathFor: fn.	projectDirectory _ FileDirectory on: dir.	ScratchFileChooserDialog setLastFolderTo: projectDirectory forType: #project.	projectName _ FileDirectory localNameFor: fn.	self installNewProject: newProj.	self initializeWatcherPositions.	viewerPane updateContents.	"Write I/O configuration file"	filename := 'Board.cfg'.	f _ FileStream fileNamed: filename.	f binary.	IOPort do: [ :partsID |		f nextPut: partsID.	].	f close.! !!ScratchFrameMorph methodsFor: 'file read/write' stamp: 'KK 9/21/2013 14:09'!saveScratchProject	| fName result |	self closeMediaEditorsAndDialogs ifFalse: [^ self].	self stopAll.	(DuringTest = true)	" During a test ? "	ifTrue: [ self testModeOff. ].	" yes -> off "	fName _ ScratchFileChooserDialog saveScratchFileFor: self.	(fName size = 0 or: [fName = #cancelled]) ifTrue: [^ self].	[(result _ ScratchFileChooserDialog confirmFileOverwriteIfExisting: fName) = false] whileTrue: [		fName _ ScratchFileChooserDialog saveScratchFileFor: self.		(fName size = 0 or: [fName = #cancelled]) ifTrue: [^ self]].	(result = #cancelled) ifTrue: [^ self].	self updateLastHistoryEntryIfNeeded.	fName _ (self nameFromFileName: fName), '.bpd'.	projectDirectory _ FileDirectory on: (FileDirectory dirPathFor: fName).	projectName _ FileDirectory localNameFor: fName.	projectInfo at: 'author' put: author.	self updateHistoryProjectName: projectName op: 'save'.	self writeScratchProject.! !!ScratchFrameMorph methodsFor: 'file read/write' stamp: 'KK 11/29/2013 11:51'!saveScratchProjectNoDialog	| fName dir |	(DuringTest = true)	" During a test ? "	ifTrue: [ self testModeOff. ].	" yes -> off "	self closeMediaEditorsAndDialogs ifFalse: [^ self].	projectName ifNil: [projectName _ ''].	fName _ self nameFromFileName: projectName.	dir _ ScratchFileChooserDialog getLastFolderForType: #project.	(fName size = 0 | (dir fileExists: fName , '.bpd') not) ifTrue: [^ self saveScratchProject].	ScratchFileChooserDialog lastFolderIsSampleProjectsFolder ifTrue:  [^ self saveScratchProject].	self updateLastHistoryEntryIfNeeded.	projectName _ FileDirectory localNameFor: (fName, '.bpd').  "ignore path, if any; save in the original project directory"	projectDirectory _ dir.	self updateHistoryProjectName: projectName op: 'save'.	self writeScratchProject.! !!ScratchFrameMorph methodsFor: 'file read/write' stamp: 'KK 4/20/2015 11:52'!setIOPortFrom: fileStream put: flag	"Read I/O Port Information from .bpd file"	| i id |	i _ 1.	IOPort size timesRepeat: [		id _ fileStream next.		flag ifTrue: [			(id > 21) ifTrue: [				id _ 0.				versionConflict _ true.			].			IOPort at: i put: id.		]		ifFalse: [			(id > 21) ifTrue: [				versionConflict _ true.			].		].		i _ i + 1.	].	^ fileStream.! !!ScratchFrameMorph methodsFor: 'file read/write' stamp: 'KK 9/5/2013 15:34'!storeProjectInfoOn: aBinaryStream	| s |	projectInfo at: 'thumbnail' put: workPane thumbnailForm.	s _ WriteStream on: (ByteArray new: 100000).	ObjStream new storeObj: projectInfo on: s.	aBinaryStream uint32: s size.	" save data size "	aBinaryStream nextPutAll: s contents.! !!ScratchFrameMorph methodsFor: 'file read/write' stamp: 'KK 9/5/2013 17:20'!writeScratchProject	"Write this Scratch project to the file named projectFile in the project directory. Called by saveScratchProject."	| oldScriptsTarget oldTab oldViewerCategory oldPosition saveError out |	self stopAll.	self world ifNotNil: [self world activeHand newKeyboardFocus: nil].  "terminates active editor"	"share duplicate sounds and images"	self canonicalizeSoundsBits: nil saveOriginal: false.	self canonicalizeImagesQuality: nil saveOriginal: false.	oldScriptsTarget _ scriptsPane target.	oldTab _ scriptsPane tabPane currentTab.	oldViewerCategory _ viewerPane currentCategory.	scriptsPane target: nil.	workPane updateSpritesList.	oldPosition _ workPane position.	workPane delete; position: 0@0.	self updatePenPositions.	ScriptableScratchMorph buildBlockSpecDictionary.	workPane allMorphsDo: [:m |		(m isKindOf: ScriptableScratchMorph) ifTrue: [			m blocksBin allMorphsDo: [:b |				(b isKindOf: BlockMorph) ifTrue: [b stop]].			m convertStacksToTuples]].	saveError _ nil.	[	out _ FileStream newFileNamed: (projectDirectory unusedNameStartingWith: 'tmp').		out			ifNil: [saveError _ 'Folder may be locked or read-only']			ifNotNil: [				out binary.				out nextPutAll: 'ScratchV02' asByteArray.				" Write I/O port contructure "				out nextPutAll: IOPort asByteArray.				self storeProjectInfoOn: out.				ObjStream new storeObj: workPane on: out.				out close].	] ifError: [:err :rcvr |		out ifNotNil: [			[	out close.				projectDirectory deleteFileNamed: out localName.			] ifError: []].  "clean up, ignoring any errors"		saveError _ err].	workPane allMorphsDo: [:m |		(m isKindOf: ScriptableScratchMorph) ifTrue: [			m convertTuplesToStacks]].	self addMorph: (workPane position: oldPosition).	oldScriptsTarget ifNil: [oldScriptsTarget _ workPane].	oldScriptsTarget viewBlocksAndScripts.	scriptsPane tabPane currentTab: oldTab.	viewerPane currentCategory: oldViewerCategory.	self updatePenPositions.	saveError		ifNil: [			justSaved _ true.			self updateProjectName.			projectDirectory deleteFileNamed: projectName.			[projectDirectory rename: out localName toBe: projectName]				ifError: [^ self inform: 'Save failed' withDetails: 'Is the folder read-only?' localized].			projectDirectory setMacFileNamed: projectName type: 'STsb' creator: 'MITS']		ifNotNil: [			projectName _ ''.			self inform: 'Save failed' withDetails: saveError].! !!ScratchFrameMorph methodsFor: 'uploading' stamp: 'sk 8/19/2016 12:50'!calibrateSvMotor2| notification res |[	 | s |	ScratchMenuTitleMorph setMenuEnable: false.	s _ self createBMHandle.	s ifNil: [^ self].	" Asking user to push a reset button. "	notification _ NotificationMessage show: 16r20.	"Waiting for RESET"	" Success in connection "	" -------------------------------------------------------------------- "	" Send message "	" -------------------------------------------------------------------- "	s sendCommand: 'CALIB'.	" Waiting for BM to transfer a testmode program. "	Transcript show: '---------- Recving ----------'; cr.	res _ self waitForBMResponse: s.	(res = '-1') ifTrue: [		notification ifNotNil: [notification no].		^ self].	notification no.	(BoardType = 2) ifTrue: [		(res = 'OK') ifFalse: [			" Getting error number "			res _ self waitForBMResponse: s.			(res = '-1') ifTrue: [				notification ifNotNil: [notification no].				^ self].			" Notify timeout error. "			ErrorMessage show: res asNumber.			^ self].		" Asking user to push a reset button. - 2 - "		notification _ NotificationMessage show: 16r20.	"Waiting for RESET"		" Waiting for BM to transfer a testmode program. "		Transcript show: '---------- Recving1 ----------'; cr.		res _ self waitForBMResponse: s.		(res = '-1') ifTrue: [			notification ifNotNil: [notification no].			^ self].		notification no].	(res = 'OK') ifTrue: [		"Waiting INITOK"		res _ self waitForBMResponse: s.		(res = '-1') ifTrue: [			notification ifNotNil: [notification no].			^ self].		(res = 'INITOK') ifTrue: [			" Do nothing "]		ifFalse: [			notification no.			ErrorMessage show: 100.			^ self]]	ifFalse: [		" Notify error. "		Transcript show: '---------- Error ----------'; cr.		"Getting an error number."		notification no.		res _ self waitForBMResponse: s.		(res = '-1') ifTrue: [			notification ifNotNil: [notification no].			^ self].		ErrorMessage show: res asNumber.		^ self].		" ---------------------------------------------------------------- "		" Waiting for the calibration done.                          "		" ---------------------------------------------------------------- "		notification no.		BoardStatus _ 3.		"Wait for finish calibration"		res _ self waitForBMResponse: s For: 36000.		(res = '-1') ifTrue: [			notification ifNotNil: [notification no].			^ self].		Transcript show: '---------- Recv message: '; show:res; show:' ----------'; cr.		(res = 'ERR') ifTrue: [			" Disconnect !! "			ErrorMessage show: 1].		" Send message "		Transcript show: '---------- Sending ----------'; cr.		s sendCommand: 'BREAK'.		s disconnect.		s destroy.	ScratchMenuTitleMorph setMenuEnable: true.] fork.! !!ScratchFrameMorph methodsFor: 'private' stamp: 'sk 3/24/2016 17:58'!createBMHandle	| filename f port |	" I connect to Board Manager through localhost. "	" Get IP Port Number "	filename := 'portNumber.info'.	f _ FileStream fileNamed: filename.	f binary.	port _ f uint32.	f close.	^ self createBMHandle: port.! !!ScratchFrameMorph methodsFor: 'private' stamp: 'sk 3/24/2016 21:50'!createBMHandle: portNumber	| hostName hostAddr s |	" I connect to Board Manager through localhost. "	" Communicate with Board Manager "	Socket initializeNetwork.	hostName _ '127.0.0.1'.	" For interprocess communication "	hostAddr _ NetNameResolver addressForName: hostName timeout: 10.	hostAddr ifNil: [		ErrorMessage show: 0.		^ nil.	].	s _ SimpleClientSocket new.	Transcript show: '---------- Connecting BM ----------'; cr.	s connectTo: hostAddr port: portNumber.	s waitForConnectionUntil: "self standardDeadline" (Socket deadlineSecs: 10).	(s isConnected) ifFalse: [		s destroy.		ErrorMessage show: 1.		^ nil.	].	^ s.! !!ScratchFrameMorph methodsFor: 'private' stamp: 'KK 9/23/2013 21:15'!enterQuarterModeIfSmallScreen"	(Display width >= 980) & (Display height >= 555) ifTrue: [^ self].	viewMode = #normal ifTrue: [self enterQuarterMode]."! !!ScratchFrameMorph methodsFor: 'private' stamp: 'sk 7/7/2016 19:35'!initIOPort	""	| f filename arrayID index |	(BoardType = 0 or: [BoardType = 2]) ifTrue: [ " Studuino "Transcript show: 'Studuino selected.'.		arrayID _ #(1 1 0 0 0 0 2 2 2 0 21 21 21 21 0 0 0 0).]	ifFalse: [ "BoardType 1: Studuino mini"Transcript show: 'Studuino mini selected.'.		arrayID _ #(0 0 5 5 5 2 2 0 0 0 0 0 0 0 0 0 16 16 0).].Transcript show: 'size: ', arrayID size asString; cr.	" Redefine IOPOrt basing on arrayID size."	IOPort _ Array new: (arrayID size).	filename := 'Board.cfg'.	f _ StandardFileStream new open: filename forWrite: true.	f binary.	index _ 1.	arrayID do: [:elm |		IOPort at: index put: elm.		f nextPut: elm.		index _ index + 1.].	f close.! !!ScratchFrameMorph methodsFor: 'private' stamp: 'sk 7/7/2016 19:35'!initStuduinoGlobalVars	""	| arrayID svSize filename f index |	(BoardType = 0 or: [BoardType = 2]) ifTrue: [ " Studuino "Transcript show: 'Studuino selected.'.		arrayID _ #(1 1 0 0 0 0 2 2 2 0 21 21 21 21 0 0 0 0).		svSize _ 8.]	ifFalse: [ "BoardType 1: Studuino mini"Transcript show: 'Studuino mini selected.'.		arrayID _ #(0 0 5 5 5 2 2 0 0 0 0 0 0 0 0 0 0 0 0).		svSize _ 5.].Transcript show: 'size: ', arrayID size asString; cr.	" Redefine IOPOrt basing on arrayID size."	IOPort _ Array new: (arrayID size).	filename := 'Board.cfg'.	f _ StandardFileStream new open: filename forWrite: true.	f binary.	index _ 1.	arrayID do: [:elm |		IOPort at: index put: elm.		f nextPut: elm.		index _ index + 1.].	f close.	SvCalib _ Array new: svSize.	SvCalib atAllPut: 0.	DCCalib _ #(100 100).	SvDegree _ Array new: svSize.	SvDegree atAllPut: 90.	SvDegreeTemp _ Array new: svSize.	SvDegreeTemp atAllPut: 90.	SvSentAlready _ Array new: svSize.	SvSentAlready atAllPut: false.	ServomotorSynchroMotion _ false.! !!ScratchFrameMorph methodsFor: 'private' stamp: 'sk 10/21/2015 15:07'!isPortAvailable: portName	"Answer if the port indicated by portName is available."	| port result |	port _ SerialPort2 new openPortNamed: portName baud: 9600.	result _ port isOpen.	port close.	port _ nil.		^ result! !!ScratchFrameMorph methodsFor: 'private' stamp: 'sk 11/16/2015 16:05'!recordLanguage: aString	"Record my language in the settings file."	"ScratchFrameMorph new recordLanguage: 'English'"	| fName f sz settings all |	fName _ FileDirectory default fullNameFor: 'Scratch.ini'.	f _ FileStream concreteStream new open: fName forWrite: true.	f ifNil: [^ self].	sz _ f size.	settings _ (f next: sz) lines.	settings _ settings reject: [:s | s asLowercase beginsWith: 'language='].	settings _ settings reject: [:s | all _ s asByteArray asSet. (all size = 1) and: [all asArray first = 0]].	settings _ settings copyWith: ('Language=', aString).	f position: 0.	settings do: [:s | f nextPutAll: s, String crlf].	[f position < sz] whileTrue: [f nextPut: 0 asCharacter].	f close.! !!ScratchFrameMorph methodsFor: 'private' stamp: 'sk 10/21/2015 17:17'!recordVerify: aString	"Record my verify flag in the settings file."	| fName f sz settings all |	fName _ FileDirectory default fullNameFor: 'Block.ini'.	f _ FileStream concreteStream new open: fName forWrite: true.	f ifNil: [^ self].	sz _ f size.	settings _ (f next: sz) lines.	settings _ settings reject: [:s | s asLowercase beginsWith: 'verify='].	settings _ settings reject: [:s | all _ s asByteArray asSet. (all size = 1) and: [all asArray first = 0]].	settings _ settings copyWith: ('Verify=', aString).	f position: 0.	settings do: [:s | f nextPutAll: s, String crlf].	[f position < sz] whileTrue: [f nextPut: 0 asCharacter].	f close.! !!ScratchFrameMorph methodsFor: 'private' stamp: 'sk 9/21/2016 19:30'!selectBoardType	"Sending a message to BM for changing a boardtype."	| menu type bullet boards s btype res |"	bullet _ UTF8 withAll: ' '."	bullet _ '* '.	boards _ #('Studuino' 'Studuino mini' 'Studuino & mini').	menu _ CustomMenu new title: 'Select a board type.'.	(BoardType = 0) ifTrue: [		menu add: (bullet, (boards at:1)) action: 0.		menu add: (boards at:2) action: 1."		menu add: (boards at:3) action: 2"].	(BoardType = 1) ifTrue: [		menu add: (boards at:1) action: 0.		menu add: (bullet, (boards at:2)) action: 1."		menu add: (boards at:3) action: 2"].	(BoardType = 2) ifTrue: [		menu add: (boards at:1) action: 0.		menu add: (boards at:2) action: 1.		menu add: (bullet, (boards at:3)) action: 2].	type _ menu localize startUp.	type ifNil: [^ self].	BoardType _ type.	BoardStatus _ -1.	self newScratchProject.	" Connect to BM "	s _ self createBMHandle.	s ifNil: [^ self].	" Success in connection "	" Send message "	Transcript show: '---------- Sending ----------'; cr.	(BoardType == 0) ifTrue: [Transcript show: 'standard'; cr.		btype _ 'BOARD0'].	(BoardType == 1) ifTrue: [Transcript show: 'mini'; cr.		btype _ 'BOARD1'].	(BoardType == 2) ifTrue: [Transcript show: 'standard + mini'; cr.		btype _ 'BOARD2'].	s sendCommand: btype.	" Wait for BM's response. "	Transcript show: '---------- Recving ----------'; cr.	res _ self waitForBMResponse: s.	(res = '-1') ifTrue: [		^ self].Transcript show: 'board changed to ', res, '.'; cr.	s sendCommand: 'BREAK'.	s disconnect.	s destroy.! !!ScratchFrameMorph methodsFor: 'private' stamp: 'sk 8/23/2016 18:22'!sendFinishToBM	| s line |	" Communicate with Board Manager "	s _ self createBMHandle.	s ifNil: [^ false].	" Success in connection "	" Send message "	Transcript show: '---------- Sending ----------'; cr.	s sendCommand: 'FINISH'.	line _ self waitForBMResponse: s For: 2.	(line = '-1') ifTrue: [^ false].	^ true! !!ScratchFrameMorph methodsFor: 'private' stamp: 'sk 7/27/2016 19:18'!sendMessageToBM: aMessage	 | s line result |	" Communicate with Board Manager "	s _ self createBMHandle.	s ifNil: [^ self].	" Success in connection "	" Send message "	Transcript show: '---------- Sending ----------'; cr.	s sendCommand: aMessage.	" Wait for program creation and updating to end  "	Transcript show: '---------- Recving ----------'; cr.	line _ self waitForBMResponse: s.	(line = '-1') ifTrue: [^ self].	result _ line sansPeriodSuffix.	line _ self waitForBMResponse: s.	(line = '-1') ifTrue: [^ self].	Transcript show:line;cr.	" Display message"	" Send message "	Transcript show: '---------- Sending BREAK----------'; cr.	s sendCommand: 'BREAK'.	s disconnect.	s destroy.! !!ScratchFrameMorph methodsFor: 'private' stamp: 'KK 10/7/2013 15:32'!setLanguage: aString	"Set my language and update my blocks."	| tempJustSaved |	tempJustSaved _ justSaved.	(workPane submorphs copyWith: workPane) do: [:m |		(m isKindOf: ScriptableScratchMorph) ifTrue: [			m convertStacksToTuples]].	ScratchTranslator setLanguage: (ScratchTranslator isoCodeForName: aString).	viewerPane rebuildCategorySelectors.	(workPane submorphs copyWith: workPane) do: [:m |		(m isKindOf: ScriptableScratchMorph) ifTrue: [			m convertTuplesToStacks]].	self updatePanes.	self		view: scriptsPane target		tab: scriptsPane tabPane currentTab		category: viewerPane currentCategory.	justSaved _ tempJustSaved.! !!ScratchFrameMorph methodsFor: 'private' stamp: 'sk 8/8/2016 11:55'!shiftToTestMode	"Move onto test mode for Studuino."	| s dialogBox line sb mid pin ival parts comPort index filename f msgID result j b |	(BoardStatus = 1) ifFalse: [		s _ self createBMHandle.		s ifNil: [^ self].		"---------- Success in connection ----------"		" Send message "		Transcript show: '---------- Sending ----------'; cr.		s sendCommand: 'TEST'.		" Display Status DialogBox "		dialogBox _ NotificationMessage show: 16r11.	"Shifting to testmode"						" Wait for program creation and updating to end  "		Transcript show: '---------- Recving ----------'; cr.		line _ self waitForBMResponse: s.		(line = '-1') ifTrue: [			dialogBox ifNotNil: [dialogBox no].			^ self].		comPort _ line sansPeriodSuffix.		COMPort _ comPort.	" set class value "		line _ self waitForBMResponse: s.		(line = '-1') ifTrue: [			dialogBox ifNotNil: [dialogBox no].			^ self].		msgID _ line sansPeriodSuffix.		" Hide Status DialogBox "Transcript show:comPort; show:', '; show:line;cr.	" Display message "		" Send message "		Transcript show: '---------- Sending ----------'; cr.		s sendCommand: 'BREAK'.		s disconnect.		s destroy.		BoardStatus _ 1.	] " End communication with Boardmanager."	ifTrue: [		comPort _ COMPort.		" Display Status DialogBox "		dialogBox _ NotificationMessage show: 16r11.	"Shifting to testmode"	].	(comPort = 'ERR') ifFalse: [	" Success to Transfer "		"Check if the port is available."		(self isPortAvailable: comPort) ifFalse: [			COMPort _ nil.			BoardStatus _ 0.			" Hide communication box "			dialogBox no.			self testMode.			^ self		].		" Connect with Arduino board ""sc _ workPane servoCalibrationBoard."		sb _ workPane sensorBoard.		sb portIsOpen ifTrue: [Transcript show:'[ScratchFrameMorph::testMode] close & open port';cr.			sb closePort.		].		sb selectPort: comPort.		" Wait for run arduino board "			result _ sb isBoardSetup.		result ifFalse: [			" Hide communication box "			dialogBox no.			sb closePort.			BoardStatus _ 0.			self testMode.		]		ifTrue: ["			(Delay forSeconds: 3) wait."			"  Set sensorboard items "			sb addReadouts.			" Send port configuration "			mid _ 4.			index _ 0.			IOPort do: [ :partsID |"				pin _ index bitShift: 6."	" pin = index << 6 "				(index = 0) ifTrue:  [ pin _ 16r0000. ].		"M1:  b0000 0000 0000 0000"				(index = 1) ifTrue:  [ pin _ 16r0040. ].		"M2:  b0000 0000 0100 0000"				(index = 2) ifTrue:  [ pin _ 16r0100. ].		"D2:  b0000 0001 0000 0000"				(index = 3) ifTrue:  [ pin _ 16r0140. ].		"D4:  b0000 0001 0100 0000"				(index = 4) ifTrue:  [ pin _ 16r0200. ].		"D7:  b0000 0010 0000 0000"				(index = 5) ifTrue:  [ pin _ 16r0240. ].		"D8:  b0000 0010 0100 0000"				(index = 6) ifTrue:  [ pin _ 16r0300. ].		"D9:  b0000 0011 0000 0000"				(index = 7) ifTrue:  [ pin _ 16r0340. ].		"D10: b0000 0011 0100 0000"				(index = 8) ifTrue:  [ pin _ 16r0400. ].		"D11: b0000 0100 0000 0000"				(index = 9) ifTrue:  [ pin _ 16r0440. ].		"D12: b0000 0100 0100 0000"				(index = 10) ifTrue: [ pin _ 16r0500. ].		"A0:  b0000 0101 0000 0000"				(index = 11) ifTrue: [ pin _ 16r0540. ].		"A1:  b0000 0101 0100 0000"				(index = 12) ifTrue: [ pin _ 16r0600. ].		"A2:  b0000 0110 0000 0000"				(index = 13) ifTrue: [ pin _ 16r0640. ].		"A3:  b0000 0110 0100 0000"				(index = 14) ifTrue: [ pin _ 16r0700. ].		"A4:  b0000 0111 0000 0000"				(index = 15) ifTrue: [ pin _ 16r0740. ].		"A5:  b0000 0111 0100 0000"				(index = 16) ifTrue: [ pin _ 16r0800. ].		"A6:  b0000 1000 0000 0000"				(index = 17) ifTrue: [ pin _ 16r0840. ].		"A7:  b0000 1000 0100 0000"				parts _ partsID.				ival _ pin + parts.				sb data:ival msgID:mid.				index _ index + 1.			].			" Set Servomotors' degree connected Studuino. "			1 to: (SvDegree size) do: [ : i |				SvDegree at: i put: 90.				SvDegreeTemp at:i put:90.			].			ServomotorSynchroMotion _ false.			"---------------------------------------------------------"			" Get Servomotor Info "			"---------------------------------------------------------"			filename := '..\common\sv_offset_ini'.			f _ FileStream fileNamed: filename.			f binary.			j _ 1.			[f atEnd] whileFalse: [				b _ f next.	" PartsID "				" I/O Port Configuration "				SvCalib at:(j) put:b.				j _ j + 1.			].			f close.			"---------------------------------------------------------"			" Get DC motor Info "			"---------------------------------------------------------"			filename _ '..\common\dc_calib_ini'.			f _ FileStream fileNamed: filename.			f binary.			j _ 1.			[f atEnd] whileFalse: [				b _ f next.	" DC motor speed ratio "				DCCalib at:(j) put:b.				j _ j + 1.			].			f close.			" Hide communication box "			dialogBox no.			self showSensorBoard.			DuringTest _ true.		]	]	ifTrue: [		" Hide communication box "		dialogBox no.		BoardStatus _ 0.		ErrorMessage show: msgID asNumber.	].! !!ScratchFrameMorph methodsFor: 'private' stamp: 'sk 8/8/2016 12:48'!shiftToTestModeMini	"Move onto test mode for Studuino mini."	| s line sb res socketCommand port notification portCommand portSensor socketSensor |	(BoardStatus = 1) ifFalse: [		s _ self createBMHandle.		s ifNil: [^ self].		" Asking user to push a reset button. "		notification _ NotificationMessage show: 16r20.	"Waiting for RESET"		"---------- Success in connection ----------"		" Send message "		Transcript show: '---------- Sending TEST----------'; cr.		s sendCommand: 'TEST'.		" Waiting for BM to transfer a testmode program. "		Transcript show: '---------- Recving ----------'; cr.		line _ self waitForBMResponse: s.		(line = '-1') ifTrue: [			notification ifNotNil: [notification no].			^ self].		res _ line.		notification no.		notification _ NotificationMessage show: 16r11.	"Shifting to testmode"						(res = 'OK') ifTrue: [			line _ self waitForBMResponse: s.			(line = '-1') ifTrue: [				notification ifNotNil: [notification no].				^ self].			res _ line.			(res = 'INITOK') ifTrue: [				Transcript show: '---------- Sending TEST2S----------'; cr.				s sendCommand: 'TEST2S'.				line _ self waitForBMResponse: s.				(line = '-1') ifTrue: [						notification ifNotNil: [notification no].					^ self].				res _ line. "Waiting port number."				port _ res asNumber.]			ifFalse: [				notification no.				ErrorMessage show: 100.				^ self].]		ifFalse: [			" Notify error. "			Transcript show: '---------- Error ----------'; cr.			notification no.			line _ self waitForBMResponse: s.			(line = '-1') ifTrue: [					notification ifNotNil: [notification no].				^ self].			ErrorMessage show: line asNumber.			^ self].	].Transcript show: res; cr.	(port > 0) ifTrue: [	" Success to Transfer "		"Check if the port is available."		portCommand _ (port asNumber) bitAnd: 16rFFFF.		portSensor _ portCommand + ((port asNumber) bitShift: -16).		sb _ workPane sensorBoard.		sb socketIsOpen ifTrue: [Transcript show:'[ScratchFrameMorph::testMode] close & open port';cr.			sb closeSocket.		]."		sb socket: s."		s sendCommand: 'BREAK'.		s disconnect.		s destroy.		socketSensor _ self createBMHandle: portSensor.		socketSensor ifNil: [^ self.].		sb socket: socketSensor.		socketCommand _ self createBMHandle: port.		socketCommand ifNil: [^ self.].		sb socketCommand: socketCommand.		"  Set sensorboard items "		sb addReadouts.		" Send port configuration "		self showSensorBoard.		DuringTest _ true.	].	notification no.! !!ScratchFrameMorph methodsFor: 'private' stamp: 'sk 8/23/2016 09:05'!shiftToTestModeMini2	"Move onto test mode for Studuino mini."	| s line sb res socketCommand port notification portCommand portSensor socketSensor |	(BoardStatus = 1) ifFalse: [		s _ self createBMHandle.		s ifNil: [^ self].		"---------- Success in connection ----------"		" Send message "		Transcript show: '---------- Sending TEST----------'; cr.		s sendCommand: 'TEST'.		" Asking user to push a reset button. - 1 - "		notification _ NotificationMessage show: 16r20.	"Waiting for RESET"		" Waiting for BM to transfer a testmode program. "		Transcript show: '---------- Recving1 ----------'; cr.		line _ self waitForBMResponse: s.		(line = '-1') ifTrue: [			notification ifNotNil: [notification no].			^ self].		res _ line.		notification no.		(res = 'OK') ifFalse: [			" Getting error number "			line _ self waitForBMResponse: s.			(line = '-1') ifTrue: [				notification ifNotNil: [notification no].				^ self].			" Notify timeout error. "			ErrorMessage show: line asNumber.			^ self].		" Asking user to push a reset button. - 2 - "		notification _ NotificationMessage show: 16r21.	"Waiting for RESET"		" Waiting for BM to transfer a testmode program. "		Transcript show: '---------- Recving1 ----------'; cr.		line _ self waitForBMResponse: s.		(line = '-1') ifTrue: [			notification ifNotNil: [notification no].			^ self].		res _ line.		notification no.		(res = 'OK') ifFalse: [			" Getting error number "			line _ self waitForBMResponse: s.			(line = '-1') ifTrue: [				notification ifNotNil: [notification no].				^ self].			" Notify timeout error. "			ErrorMessage show: line asNumber.			^ self].		Transcript show: '---------- Recving3 ----------'; cr.		"Waiting INITOK"		line _ self waitForBMResponse: s.		(line = '-1') ifTrue: [			notification ifNotNil: [notification no].			^ self].		res _ line sansPeriodSuffix.		(res = 'INITOK') ifTrue: [			Transcript show: '---------- Sending TEST2S----------'; cr.			s sendCommand: 'TEST2S'.			line _ self waitForBMResponse: s.			(line = '-1') ifTrue: [				notification ifNotNil: [notification no].				^ self].			port _ line asNumber.]		ifFalse: [			notification no.			ErrorMessage show: 100.			^ self].	].Transcript show: res; cr.	(port > 0) ifTrue: [	" Success to Transfer "		"Check if the port is available."		portCommand _ (port asNumber) bitAnd: 16rFFFF.		portSensor _ portCommand + ((port asNumber) bitShift: -16).		sb _ workPane sensorBoard.		sb socketIsOpen ifTrue: [Transcript show:'[ScratchFrameMorph::testMode] close & open port';cr.			sb closeSocket.		]."		sb socket: s."		s sendCommand: 'BREAK'.		s disconnect.		s destroy.		socketSensor _ self createBMHandle: portSensor.		socketSensor ifNil: [^ self.].		sb socket: socketSensor.		socketCommand _ self createBMHandle: port.		socketCommand ifNil: [^ self.].		sb socketCommand: socketCommand.		"  Set sensorboard items "		sb addReadouts.		" Send port configuration "		self showSensorBoard.		DuringTest _ true.	].	notification no.! !!ScratchFrameMorph methodsFor: 'private' stamp: 'KK 1/11/2013 19:45'!updatePanes	| p |	menuPanel delete.	self createMenuPanel."----------	toolbarPanel delete.	self createToolbar.----------"	viewModeButtonsPanel delete.	self createViewModeButtonsPanel.	stageButtonsPanel delete.	self createStageButtonsPanel.	titlePane addMorph: stageButtonsPanel."----------	scriptsPane tabPane delete.	scriptsPane createTabPane.	readoutPane delete.	self createReadoutPane.----------"	workPane sensorBoard owner		ifNil: [p _ nil]		ifNotNil: [p _ workPane sensorBoard position].	workPane sensorBoard addReadouts.	p ifNotNil:[		self showSensorBoard.		workPane sensorBoard position: p].	libraryPane clearLibrary.	self scratchWatchers do: [:w | w languageChanged].	self listWatchers do: [:w | w fixLayoutForNewLanguage].	World startSteppingSubmorphsOf: self.	self fixLayout.	scriptsPane fixLayout.	self updateViewModeButtons.! !!ScratchFrameMorph methodsFor: 'private' stamp: 'KK 10/9/2013 12:04'!updateProjectName	"Update the project name display in the Scratch title bar."	| s |	projectName ifNil: [projectName _ ''].	projectTitleMorph contents: (self nameFromFileName: projectName).	projectTitleMorph contents size > 0		ifTrue: [s _ projectTitleMorph contents, '- SPE BLOCK']		ifFalse: [s _ 'Studuino BLOCK Programming Environment'", Version"].	ScratchPlugin primSetWindowTitle: s.	self fixLayout.! !!ScratchFrameMorph methodsFor: 'private' stamp: 'sk 7/27/2016 19:08'!waitForBMResponse: s	| line |	" I receive message from Board Manager and return message"	line _ WriteStream on: String new.	line _ s getBMResponse.	^ line sansPeriodSuffix.! !!ScratchFrameMorph class methodsFor: 'class initialization' stamp: 'sk 8/8/2016 15:22'!initialize	|  |	"self initialize"	Clipboard _ nil.	WorkpaneExtent _ 480@360.	UseErrorCatcher _ true.	DefaultNotes _ ''.	IOPort ifNil: [ IOPort _ Array new:18. ].	SvCalib ifNil: [ SvCalib _ Array new:8. ].	DCCalib ifNil: [ DCCalib _ Array new:2. ].	SvDegree ifNil: [ SvDegree _ Array new:8. ].	LangDic ifNil: [ LangDic _ Dictionary new. ].	LangDic		at: 'ja' put: 'LANGJ';		at: 'ja_HIRA' put: 'LANGH';		at: 'zh_CN' put: 'LANGZ';		at: 'ko' put: 'LANGK';		at: 'es' put: 'LANGES'.	self initFonts.! !!ScratchFrameMorph class methodsFor: 'scratch skin' stamp: 'KK 12/25/2012 18:33'!readSkinFrom: t1 	| t2 t3 t4 t5 |	t2 _ Dictionary new.	t5 _ Dictionary new.	t1 fileNames do: 		[:t6 | 		Cursor read showWhile: [t3 _ [Form fromFileNamed: (t1 fullNameFor: t6)]						ifError: []].		t3			ifNotNil: 				[t4 _ t6 findLast: [:t7 | t7 = $.].				t4 = 0 ifFalse: [t6 _ t6 copyFrom: 1 to: t4 - 1].				(t6 asLowercase endsWith: '_xo')					ifTrue: [t5 at: (t6 copyFrom: 1 to: t6 size - 3) asSymbol put: t3]					ifFalse: [t2 at: t6 asSymbol put: t3]]].	ScratchSkin _ t2.	ScratchSkinXO _ t5.	t3 _ ScratchSkin at: #scriptsPaneTexture ifAbsent: [].	(t3 notNil and: [t3 depth ~= 32])		ifTrue: [ScratchSkin at: #scriptsPaneTexture put: (t3 asFormOfDepth: 32)]! !!ScratchFrameMorph class methodsFor: 'utilities' stamp: 'sk 7/30/2015 16:11'!displayMessageDialog: msgID	" I display Dialog Message from number. "	| dialogBox |	(msgID = '0') ifTrue: [	" Could not access to BM "		dialogBox _ DialogBoxMorph new.		dialogBox withButtonsForYes: false no: false okay: true cancel: false.		dialogBox title: 'Could not access to Studuino'.		dialogBox message: 'Please save your project and restart this software.'.		dialogBox openInWorld.		" Display Dialogbox "		dialogBox centerOnScreen.	" Set center position "		dialogBox world doOneCycle.	].	(msgID = '1') ifTrue: [		dialogBox _ DialogBoxMorph new.		dialogBox withButtonsForYes: false no: false okay: true cancel: false.		dialogBox title: 'Could not access to Studuino'.		dialogBox message: 'Make sure Studuino is connected to the PC.'.		dialogBox openInWorld.		" Display Dialogbox "		dialogBox centerOnScreen.	" Set center position "		dialogBox world doOneCycle.	].	(msgID = '2') ifTrue: [		dialogBox _ DialogBoxMorph new.		dialogBox withButtonsForYes: false no: false okay: true cancel: false.		dialogBox title: 'Could not access to Studuino'.		dialogBox message: 'Serial port already in use.Try quiting any programs that may be using it.'.		dialogBox openInWorld.		" Display Dialogbox "		dialogBox centerOnScreen.	" Set center position "		dialogBox world doOneCycle.	].	(msgID = '3') ifTrue: [		dialogBox _ DialogBoxMorph new.		dialogBox withButtonsForYes: false no: false okay: true cancel: false.		dialogBox title: 'Could not access to Studuino'.		dialogBox message: 'Studuino and PC failed to sync.Save your project, exit this software, reset Studuino, and restart this software.'.		dialogBox openInWorld.		" Display Dialogbox "		dialogBox centerOnScreen.	" Set center position "		dialogBox world doOneCycle.	].	(msgID = '4') ifTrue: [		dialogBox _ DialogBoxMorph new.		dialogBox withButtonsForYes: false no: false okay: true cancel: false.		dialogBox title: 'Could not access to Studuino'.		dialogBox message: 'Disconnected.'.		dialogBox openInWorld.		" Display Dialogbox "		dialogBox centerOnScreen.	" Set center position "		dialogBox world doOneCycle.	].	(msgID = '5') ifTrue: [		dialogBox _ DialogBoxMorph new.		dialogBox withButtonsForYes: false no: false okay: true cancel: false.		dialogBox title: 'System error'.		dialogBox message: 'System file is corrupted.Save your project, exit this software, reinstall Studuino programming environment.'.		dialogBox openInWorld.		" Display Dialogbox "		dialogBox centerOnScreen.	" Set center position "		dialogBox world doOneCycle.	].	(msgID = '6') ifTrue: [		dialogBox _ DialogBoxMorph new.		dialogBox withButtonsForYes: false no: false okay: true cancel: false.		dialogBox title: 'Could not access to Studuino'.		dialogBox message: 'COM port error.'.		dialogBox openInWorld.		" Display Dialogbox "		dialogBox centerOnScreen.	" Set center position "		dialogBox world doOneCycle.	].	(msgID = '7') ifTrue: [		dialogBox _ DialogBoxMorph new.		dialogBox withButtonsForYes: false no: false okay: true cancel: false.		dialogBox title: 'Build error'.		dialogBox message: 'Main function is not defined.'.		dialogBox openInWorld.		" Display Dialogbox "		dialogBox centerOnScreen.	" Set center position "		dialogBox world doOneCycle.	].	(msgID = '8') ifTrue: [		dialogBox _ DialogBoxMorph new.		dialogBox withButtonsForYes: false no: false okay: true cancel: false.		dialogBox title: 'Build error'.		dialogBox message: 'Script too big.'.		dialogBox openInWorld.		" Display Dialogbox "		dialogBox centerOnScreen.	" Set center position "		dialogBox world doOneCycle.	].	(msgID = '9') ifTrue: [		dialogBox _ DialogBoxMorph new.		dialogBox withButtonsForYes: false no: false okay: true cancel: false.		dialogBox title: 'Build error'.		dialogBox message: 'An error has occurred in the archiving process. Please re-install.'.		dialogBox openInWorld.		" Display Dialogbox "		dialogBox centerOnScreen.	" Set center position "		dialogBox world doOneCycle.	].	(msgID = '10') ifTrue: [		dialogBox _ DialogBoxMorph new.		dialogBox withButtonsForYes: false no: false okay: true cancel: false.		dialogBox title: 'Build error'.		dialogBox message: 'An error has occurred in the object copy1 process. Please re-install.'.		dialogBox openInWorld.		" Display Dialogbox "		dialogBox centerOnScreen.	" Set center position "		dialogBox world doOneCycle.	].	(msgID = '11') ifTrue: [		dialogBox _ DialogBoxMorph new.		dialogBox withButtonsForYes: false no: false okay: true cancel: false.		dialogBox title: 'Could not access to Studuino'.		dialogBox message: 'Time-out error has occurred in the communication with Studuino board. If the same error occurs even replaced the USB port on the PC side, please restart your PC.'.		dialogBox openInWorld.		" Display Dialogbox "		dialogBox centerOnScreen.	" Set center position "		dialogBox world doOneCycle.	].	(msgID = '12') ifTrue: [		dialogBox _ DialogBoxMorph new.		dialogBox withButtonsForYes: false no: false okay: true cancel: false.		dialogBox title: 'Could not access to Studuino'.		dialogBox message: 'Timeout error occurred in the communication of the substrate. Please restart the programming environment.'.		dialogBox openInWorld.		" Display Dialogbox "		dialogBox centerOnScreen.	" Set center position "		dialogBox world doOneCycle.	].	" ------------------------------- "	" The value of Message ID 13, 14, 15 is usable. "	" ------------------------------- "	(msgID = '17') ifTrue: [		dialogBox _ DialogBoxMorph new.		dialogBox withButtonsForYes: false no: false okay: true cancel: false.		dialogBox title: 'Build error'.		dialogBox message: 'Undefined function.'.		dialogBox openInWorld.		" Display Dialogbox "		dialogBox centerOnScreen.	" Set center position "		dialogBox world doOneCycle.	].	(msgID = '18') ifTrue: [		dialogBox _ DialogBoxMorph new.		dialogBox withButtonsForYes: false no: false okay: true cancel: false.		dialogBox title: 'Build error'.		dialogBox message: 'There are blocks that are not connected.'.		dialogBox openInWorld.		" Display Dialogbox "		dialogBox centerOnScreen.	" Set center position "		dialogBox world doOneCycle.	].	" ------------------------------- "	" The value of Message ID 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30 is usable. "	" ------------------------------- "	(msgID = '30') ifTrue: [		dialogBox _ DialogBoxMorph new.		dialogBox withButtonsForYes: false no: false okay: true cancel: false.		dialogBox title: '!!'.		dialogBox message: 'Infrared receiving sensor and I2C devices (gyro sensor, acceleration sensor, color sensors) can not be used together.'.		dialogBox openInWorld.		" Display Dialogbox "		dialogBox centerOnScreen.	" Set center position "		dialogBox world doOneCycle.	].	(msgID = '31') ifTrue: [		dialogBox _ DialogBoxMorph new.		dialogBox withButtonsForYes: false no: false okay: true cancel: false.		dialogBox title: '!!'.		dialogBox message: 'That value is already in define.'.		dialogBox openInWorld.		" Display Dialogbox "		dialogBox centerOnScreen.	" Set center position "		dialogBox world doOneCycle.	].	(msgID = '32') ifTrue: [		dialogBox _ DialogBoxMorph new.		dialogBox withButtonsForYes: false no: false okay: true cancel: false.		dialogBox title: 'Could not access to Studuino'.		dialogBox message: 'There is no reply from Studuino.Reconnect Studuino to PC, reset Studuino, and execute a  same command.'.		dialogBox openInWorld.		" Display Dialogbox "		dialogBox centerOnScreen.	" Set center position "		dialogBox world doOneCycle.	].	(msgID = '33') ifTrue: [		dialogBox _ DialogBoxMorph new.		dialogBox withButtonsForYes: false no: false okay: true cancel: false.		dialogBox title: 'Could not access to Studuino'.		dialogBox message: 'Maybe Studuino and PC are not connecting.Finish this mode, reconnect Studuino and PC,reset Studuino, and retry.'.		dialogBox openInWorld.		" Display Dialogbox "		dialogBox centerOnScreen.	" Set center position "		dialogBox world doOneCycle.	].! !!ScratchLibraryMorph methodsFor: 'initialization' stamp: 'KK 1/10/2013 17:18'!buildPanes	"Build my scroll pane."	| bin |	stagePane _ Morph new		color: Color transparent;		position: self position + (7@0).	bin _ ScratchSpriteLibraryMorph new		color: Color transparent;		borderWidth: 0.	scrollPane _ ScrollFrameMorph2 new		color: Color transparent;		contents: bin;		showHorizontalScrollbar: false.	spritePane _ Morph new		color: Color gray;		position: self position.	spriteLabel _ self buildSpriteLabel.	buttonPane _ self makeNewSpriteButtons: (self ownerThatIsA: ScratchFrameMorph).	self addMorph: spritePane.	self addMorph: spriteLabel.	self addMorph: buttonPane.	self addMorph: scrollPane."	self addMorph: stagePane."! !!ScratchLibraryMorph methodsFor: 'initialization' stamp: 'KK 1/11/2013 09:50'!clearLibrary	"Remove all library items. My step method will re-add items for existing objects."	| sFrame |	stagePane removeAllMorphs.	scrollPane contents removeAllMorphs.	scrollPane vScrollRelative: 0.	spriteLabel delete.	spriteLabel _ self buildSpriteLabel.	sFrame _ self ownerThatIsA: ScratchFrameMorph.	(sFrame isNil or:	 [sFrame viewMode = #normal]) ifTrue: [		self addMorph: spriteLabel]."	buttonPane delete.	buttonPane _ self makeNewSpriteButtons: sFrame.	self addMorph: buttonPane."	topSectionHeight _ ((spriteLabel height + 10) max: 40).	self fixLayout.! !!ScratchLibraryMorph methodsFor: 'initialization' stamp: 'KK 1/10/2013 16:53'!makeNewSpriteButtons: aScratchFrameMorph	"Return a morph containing a set of new sprite buttons."	| panel buttonSpecs buttons button butonExtent x |	panel _ Morph new color: Color transparent.	buttonSpecs _ #(		"	icon name				selector					tooltip"		(newSpritePaint			paintSpriteMorph		'Paint new sprite')		(newSpriteLibrary		addSpriteMorph			'Choose new sprite from file')		(newSpriteSurprise 		surpriseSpriteMorph		'Get surprise sprite')	).	buttons _ buttonSpecs collect: [:spec |		button _ ToggleButton new			onForm: (ScratchFrameMorph skinAt: (spec at: 1))			offForm: (ScratchFrameMorph skinAt: (spec at: 1)).		button			target: aScratchFrameMorph;			actionSelector: (spec at: 2);			setProperty: #balloonText toValue: (spec at: 3) localized.		button].	butonExtent _ ScratchFrameMorph isXO ifTrue: [37@27] ifFalse: [37@27].	x _ 0.	buttons do: [:b |		b extent: butonExtent.		panel addMorph: (b position: x@1).		x _ x + 5 + b width].	panel extent: x@(butonExtent y + 1).	^ panel! !!ScratchMenuTitleMorph methodsFor: 'event handling' stamp: 'KK 9/10/2013 15:39'!handlesMouseDown: evt	MenuEnable ifTrue: [ ^ true ]	ifFalse:	[ ^ false ].! !!ScratchMenuTitleMorph methodsFor: 'event handling' stamp: 'KK 9/6/2013 11:03'!handlesMouseOver: evt	MenuEnable ifTrue: [ ^ true ]	ifFalse:	[ ^ false ].! !!ScratchMenuTitleMorph methodsFor: 'event handling' stamp: 'KK 9/6/2013 10:55'!mouseDown: evt	target isNil | selector isNil ifTrue: [^ self].	Cursor normal show.	MenuBarIsActive _ true.	target perform: selector with: self.  "invoke my menu"! !!ScratchMenuTitleMorph class methodsFor: 'as yet unclassified' stamp: 'KK 9/6/2013 10:45'!setMenuEnable:flag	MenuEnable _ flag.! !!ScratchPlugin class methodsFor: 'translation' stamp: 'KK 8/27/2013 19:29'!writePort: portNum data: buffer	"Write data from the given ByteArray or String to the given port and answer the number of bytes written."	"self writePort: 1 into: (ByteArray new: 10)"	<primitive: 'primWrite' module: 'ScratchPlugin'>	^ 0! !!ScratchProcess methodsFor: 'private-evaluation' stamp: 'KK 5/1/2014 17:08'!applyTimedCommand	"Applies the current command to the already evaluated list of arguments over a particular time interval."	| block arguments currentTime startTime args totalMSecs elapsedMSecs |	block _ stackFrame expression.	arguments _ stackFrame arguments.	"Do we still need to evaluate more arguments?"	arguments size < block argumentCount ifTrue: [^ self evaluateNextArgument].	arguments _ block coerceArgs: arguments.	"Record or get the time when command was first invoked."	currentTime _ Time millisecondClockValue.	startTime _ stackFrame startTime.	startTime ifNil: [  "first call; just set starting time and value"		args _ arguments asArray, (Array with: 0 with: nil).		stackFrame startValue: (block receiver perform: block selector withArguments: args).		stackFrame startTime: currentTime.		readyToYield _ true.		^ self].	"Call primitive time command with its arguments and the elapsed time in seconds"	totalMSecs _ arguments last * 1000.	block selector = #glideSecs:toX:y:elapsed:from: ifTrue: [totalMSecs _ arguments first * 1000].	block selector = #mwait:elapsed:from: ifTrue: [totalMSecs _ arguments last].	((block selector = #drum:duration:elapsed:from:) or:	 [block selector = #noteOn:duration:elapsed:from:])		ifTrue: [totalMSecs _ (60000 * arguments second) / block receiver tempo].	block selector = #rest:elapsed:from:		ifTrue: [totalMSecs _ (60000 * arguments first) / block receiver tempo].	elapsedMSecs _ currentTime - startTime.	currentTime < startTime ifTrue: [elapsedMSecs _ totalMSecs].  "clock wrap"	args _ arguments asArray, (Array with: elapsedMSecs with: stackFrame startValue).	block receiver perform: block selector withArguments: args.	"If not done, then we leave stack as is and yield."	elapsedMSecs < totalMSecs ifTrue: [		readyToYield _ true.		^ self].	"Pop this command off the stack and return."	self popStackFrame.! !!ScratchProcess methodsFor: 'private-evaluation' stamp: 'KK 5/1/2014 17:08'!evaluateCommandFor: aStageMorph	"Evaluates the current block. If the argument is non-nil, redraw the stage."	| expression |	expression _ stackFrame expression.	BlockHighlightMSecs > 1 ifTrue: [expression litUp: true].	expression isSpecialForm ifTrue: [^ self evaluateSpecialForm].	"evaluate arguments, if necessary"	stackFrame arguments size < expression argumentCount		ifTrue: [^ self evaluateNextArgument].	expression isTimed ifTrue: [^ self applyTimedCommand].	self applyPrimitive.	aStageMorph ifNotNil: [		aStageMorph updateTrailsForm.		BlockHighlightMSecs = 1 ifTrue: [  "normal (non-turbo) mode; redraw after each cmd"			World displayWorldSafely]].! !!ScratchProcess methodsFor: 'private-evaluation' stamp: 'KK 4/28/2014 10:47'!evaluateSpecialForm	"Evaluates the current special form expression.  Requires that no arguments have been evaluated, and that the current expression be a special form."	self perform: stackFrame expression selector.! !!ScratchProcess methodsFor: 'private-special forms' stamp: 'KK 4/28/2014 11:34'!doRepeat	"Handles one iteration of a repeat block."	| arguments argExp block counter frame |	block _ stackFrame expression.	arguments _ stackFrame arguments.	"If we haven't done so yet, evaluate the argument to repeat."	arguments size < 1		ifTrue:	[argExp _ block argumentAt: 1.				^self pushStackFrame: (ScratchStackFrame new expression: argExp)].	"If the number of times to repeat is 0, then we're done."	counter _ arguments first asNumberNoError.	counter <= 0 ifTrue:	[^ self popStackFrame].	"Pop this instruction from the stack."	self popStackFrameNoUnhightlight.	"At top of stack should now be:		1.  evaluate body of repeat block.		2.  yield.		3.  evaluate repeat block with decremented counter value.	Need to add these to the stack in reverse order."	"3.  evaluate repeat block with decremented counter value."	frame _ ScratchStackFrame new				expression:		block;				addArgument:	counter - 1.	self pushStackFrame: frame.	"2.  yield."	self pushStackFrame: (ScratchStackFrame new shouldYield: true).	"1.  evaluate body of repeat block."	self pushStackFrame: (ScratchStackFrame new expression: block firstBlockList).! !!ScratchProcess methodsFor: 'private-special forms' stamp: 'KK 8/20/2014 10:58'!doSvmSyncMotion	"Handles one iteration of a repeat block."	| arguments argExp block frame delay expr blockLabelSpec argPermutation defaultArgs maxDelta d1 d2 |	block _ stackFrame expression.	arguments _ stackFrame arguments.	"If we haven't done so yet, evaluate the argument to repeat."	arguments  size < 1		ifTrue:	[argExp _ block argumentAt: 1.				^self pushStackFrame: (ScratchStackFrame new expression: argExp)].	"If the number of times to repeat is 0, then we're done."	" Notify syncro motion start to the board. "	delay _ arguments first asNumberNoError.	(delay <= 0) & (ServomotorSynchroMotion) ifTrue:	[		block evaluateWithArgs: -1.		self popStackFrame.		" Make dummy wait block and push stack frame. "		blockLabelSpec _ ScratchTranslator translationFor: ('wait %n secs').		argPermutation _ CommandBlockMorph argPermutationForSpec: ('wait %n secs') withTranslation: blockLabelSpec.		defaultArgs _ Array with:3.		expr _ CommandBlockMorph new.		expr isTimed: true.		expr		argPermutation: argPermutation;		selector: #mwait:elapsed:from:;		commandSpec: blockLabelSpec;		defaultArgs: defaultArgs;		receiver: block receiver.		maxDelta _ 0.		1 to: (SvDegree size) do: [ : i |			d1 _ SvDegree at:i.			d2 _ SvDegreeTemp at:i.			(((d1 - d2) abs) > maxDelta) ifTrue: [				maxDelta _ ((d1 - d2) abs).			].			SvDegree at:i put:d2.		].		frame _ ScratchStackFrame new					expression:		expr;					addArgument:	(maxDelta * (DelayMsecPerDeg+1)) asNumber.		^ self pushStackFrame: frame.	].	block evaluateWithArgs: delay.	"Pop this instruction from the stack."	self popStackFrameNoUnhightlight.	"At top of stack should now be:		1.  evaluate body of repeat block.		2.  yield.		3.  evaluate repeat block with decremented counter value.	Need to add these to the stack in reverse order."	"3.  evaluate repeat block with decremented counter value."	frame _ ScratchStackFrame new				expression:		block;				addArgument:	-1.	self pushStackFrame: frame.	"2.  yield."	self pushStackFrame: (ScratchStackFrame new shouldYield: true).	"1.  evaluate body of repeat block."	self pushStackFrame: (ScratchStackFrame new expression: block firstBlockList).! !!ScratchProcess methodsFor: 'private-special forms' stamp: 'KK 8/20/2014 11:00'!doSvmSyncMotion2	"Handles one iteration of a repeat block."	| arguments argExp block frame delay expr blockLabelSpec argPermutation defaultArgs maxDelta d1 d2 |	block _ stackFrame expression.	arguments _ stackFrame arguments.	"If we haven't done so yet, evaluate the argument to repeat."	arguments  size < 1		ifTrue:	[argExp _ block argumentAt: 1.				^self pushStackFrame: (ScratchStackFrame new expression: argExp)].	"If the number of times to repeat is 0, then we're done."	" Notify syncro motion start to the board. "	delay _ arguments first asNumberNoError.	(delay <= 0) & (ServomotorSynchroMotion) ifTrue:	[		block evaluateWithArgs: -1.		self popStackFrame.		" Make dummy wait block and push stack frame. "		blockLabelSpec _ ScratchTranslator translationFor: ('wait %n secs').		argPermutation _ CommandBlockMorph argPermutationForSpec: ('wait %n secs') withTranslation: blockLabelSpec.		defaultArgs _ Array with:3.		expr _ CommandBlockMorph new.		expr isTimed: true.		expr		argPermutation: argPermutation;		selector: #mwait:elapsed:from:;		commandSpec: blockLabelSpec;		defaultArgs: defaultArgs;		receiver: block receiver.		maxDelta _ 0.		1 to: (SvDegree size) do: [ : i |			d1 _ SvDegree at:i.			d2 _ SvDegreeTemp at:i.			(((d1 - d2) abs) > maxDelta) ifTrue: [				maxDelta _ ((d1 - d2) abs).			].			SvDegree at:i put:d2.		].		frame _ ScratchStackFrame new					expression:		expr;					addArgument:	(maxDelta * (DelayMsecPerDeg+1)) asNumber.		^ self pushStackFrame: frame.	].	block evaluateWithArgs: (20-delay).	"Pop this instruction from the stack."	self popStackFrameNoUnhightlight.	"At top of stack should now be:		1.  evaluate body of repeat block.		2.  yield.		3.  evaluate repeat block with decremented counter value.	Need to add these to the stack in reverse order."	"3.  evaluate repeat block with decremented counter value."	frame _ ScratchStackFrame new				expression:		block;				addArgument:	-1.	self pushStackFrame: frame.	"2.  yield."	self pushStackFrame: (ScratchStackFrame new shouldYield: true).	"1.  evaluate body of repeat block."	self pushStackFrame: (ScratchStackFrame new expression: block firstBlockList).! !!ScratchScriptEditorMorph methodsFor: 'initialization' stamp: 'KK 4/17/2014 15:31'!addNameBox	nameMorph _ UpdatingStringFieldMorph new		font: (ScratchFrameMorph getFont: #UpdatingStringField);		rightJustify: ScratchTranslator isRTL;		acceptWhenFocusLost: true;		position: thumbnailMorph topRight + (17@(thumbnailMorph height * 0.12))."	self addMorphBack: nameMorph."! !!ScratchScriptEditorMorph methodsFor: 'initialization' stamp: 'ee 12/5/2008 22:59'!createTabPane	| tabOnForm tabOffForm tabID tabLabel |	"create tab pane"	tabPaneMorph _ ScratchTabPaneMorph new.	tabPaneMorph		borderWidth: 0;		color: Color transparent;		targetPane: self.	tabOnForm _ (ScratchFrameMorph skinAt: #tabOn).	tabOffForm _ (ScratchFrameMorph skinAt: #tabOff).	"add the tabs"	#(Scripts Costumes Sounds) do: [:spec |		tabID _ spec asString.		tabLabel _ tabID localized.		tabPaneMorph			createTab: tabID			withLabel: tabLabel			onForm: tabOnForm			offForm: tabOffForm].	"set current tab and add to frame"	tabPaneMorph currentTab: 'Scripts'.	self addMorph: tabPaneMorph.! !!ScratchScriptEditorMorph methodsFor: 'initialization' stamp: 'KK 4/18/2014 12:38'!initialize	super initialize.	self		initFrontFromForm2: (ScratchFrameMorph skinAt: #scriptPaneFrameTransparent2)		topSectionHeight: 0.	self color: (Color r: (149/255) g: (154/255) b: (159/255)).	thumbnailMorph _ ScratchThumbnailMorph new."	self addMorph: (thumbnailMorph position: self position + (37@16))."	self addNameBox.	pageViewerMorph _ ScrollFrameMorph2 new		growthFraction: 0.1;		color: ScratchFrameMorph scriptsPaneColor.	self addMorph: (pageViewerMorph position: (self left @ (self top + topSectionHeight))).	rotationButtons _ #().	readoutMorphs _ #().	self target: nil.	thumbnailMorph extent: 50@50.	self extent: 300@400.	self createTabPane.! !!ScratchScriptEditorMorph methodsFor: 'accessing' stamp: 'jm 4/9/2009 10:09'!bareMinimumWidth	"Answer the bare minimum width for this pane to be useable."	lockButton ifNil: [^ 100].	^ lockButton right - self left! !!ScratchScriptEditorMorph methodsFor: 'accessing' stamp: 'jm 2/28/2005 17:07'!categoryChanged: aString	"If the given category is my current category, update my contents. Otherwise, do nothing."	self target ifNil: [^ self].	currentCategory = aString ifTrue: [self currentCategory: aString].! !!ScratchScriptEditorMorph methodsFor: 'accessing' stamp: 'jm 2/28/2005 14:29'!currentCategory	^ currentCategory! !!ScratchScriptEditorMorph methodsFor: 'accessing' stamp: 'jm 4/23/2008 12:43'!currentCategory: aString	| xOffset |	currentCategory _ aString.	self target ifNil: [^ self].	xOffset _ 0.	World activeHand newKeyboardFocus: nil.	currentCategory = 'Scripts' ifTrue: [		pageViewerMorph contents: self target blocksBin].	currentCategory = 'Costumes' ifTrue: [		pageViewerMorph contents: (self target costumesPage: xOffset)].	currentCategory = 'Sounds' ifTrue: [		pageViewerMorph contents: (self target soundsPage: xOffset)].	pageViewerMorph contents color: ScratchFrameMorph scriptsPaneColor.	self world ifNotNil: [self world startSteppingSubmorphsOf: pageViewerMorph contents].! !!ScratchScriptEditorMorph methodsFor: 'accessing' stamp: 'ee 8/11/2008 13:48'!getTabTop	"Used by ScratchFrameMorph when creating the tab pane. This returns the y position of where the top of the tabs should align. This situation is unfortunate (tabs should probaby be part of ScratchScriptEditorMorph), but we'll fix it later."	ScratchFrameMorph isXO ifTrue: [^ thumbnailMorph bottom + 20].	(readoutMorphs size > 0)		ifTrue: [^ (readoutMorphs at: 1) bottom + 6]		ifFalse: [^ nameMorph bottom + 5 + (ScratchTranslator stringExtent: '0' font: (ScratchFrameMorph getFont: #XYReadoutBold)) y + 6].! !!ScratchScriptEditorMorph methodsFor: 'accessing' stamp: 'ee 11/4/2008 11:44'!tabPane	^ tabPaneMorph! !!ScratchScriptEditorMorph methodsFor: 'accessing' stamp: 'ee 7/1/2003 12:58'!target	^ nameMorph target! !!ScratchScriptEditorMorph methodsFor: 'accessing' stamp: 'jm 7/2/2008 14:55'!target: aScratchObjectOrNil	"Start viewing the given object or no object."	| sFrame nameSel |	World activeHand newKeyboardFocus: nil.	(aScratchObjectOrNil isNil or:	 [aScratchObjectOrNil isScriptable not]) ifTrue: [		thumbnailMorph target: nil.		nameMorph target: nil; contents: 'no object '.		pageViewerMorph contents: (Morph new color: Color red).		(sFrame _ self ownerThatIsA: ScratchFrameMorph) ifNotNil: [			sFrame viewerPane target: nil].		self showOrHideReadouts.		^ self].	thumbnailMorph target: aScratchObjectOrNil.	nameSel _ (aScratchObjectOrNil isKindOf: ScratchStageMorph)		ifTrue: [nil]		ifFalse: [#objName:].	nameMorph		target: aScratchObjectOrNil;		getSelector: #objName;		putSelector: nameSel.	self showOrHideReadouts.	self fixLayout.! !!ScratchScriptEditorMorph methodsFor: 'drawing' stamp: 'ee 1/29/2009 10:12'!drawBackgroundOn: aCanvas	"Draw my background."	color isTransparent ifTrue: [^ self].	aCanvas		fillRectangle: (self topLeft corner: pageViewerMorph topRight)		color: color.! !!ScratchScriptEditorMorph methodsFor: 'drawing' stamp: 'ee 1/29/2009 10:35'!drawSubmorphsOn: aCanvas	"Display submorphs back to front."	submorphs reverseDo: [:m |		(m = tabPaneMorph) ifFalse: [aCanvas fullDrawMorph: m]].! !!ScratchScriptEditorMorph methodsFor: 'drawing' stamp: 'ee 1/29/2009 10:35'!fullDrawOn: aCanvas	"Draw my frame in front of my submorphs."	| clipC |	self isHidden ifTrue: [^ self].	(self hasProperty: #errorOnDraw) ifTrue:[^ self drawErrorOn: aCanvas].	(aCanvas isVisible: self fullBounds) ifFalse: [^ self].	"myBox has integer position and extent and has a potentially inset bottom"	myBox _ bounds truncated.	clipC _ aCanvas copyClipRect: myBox.	frameInFront		ifTrue: [			self drawOn: clipC.			self drawSubmorphsOn: clipC.			self drawFrameOn: clipC.			aCanvas fullDrawMorph: tabPaneMorph]		ifFalse: [			self drawOn: clipC.			self drawSubmorphsOn: clipC].! !!ScratchScriptEditorMorph methodsFor: 'event handling' stamp: 'ee 2/3/2009 13:28'!handlesMouseOverDragging: evt	| m |	evt hand submorphs size = 1 ifFalse: [^ false].	m _ evt hand firstSubmorph.	^ m isKindOf: BlockMorph.! !!ScratchScriptEditorMorph methodsFor: 'event handling' stamp: 'ee 2/8/2009 17:02'!mouseEnterDragging: evt	"Switch the tabs to script if a block is current being dragged"	(currentCategory = 'Scripts') ifFalse:[		self currentCategory: 'Scripts'.		tabPaneMorph currentTab: 'Scripts'].! !!ScratchScriptEditorMorph methodsFor: 'geometry' stamp: 'jm 10/28/2008 13:13'!extent: aPoint	super extent: aPoint.	pageViewerMorph ifNotNil: [		pageViewerMorph extent: self extent - (pageViewerMorph position - self position)].! !!ScratchScriptEditorMorph methodsFor: 'geometry' stamp: 'KK 4/17/2014 16:47'!fixLayout	| y x |	"layout readout morphs vertically"	y _ nameMorph bottom + 5.	readoutMorphs do: [:m |		m position: m left@y].	"layout readout and name morphs horizontally"	nameMorph position: (thumbnailMorph topRight + (17@(thumbnailMorph height * 0.12))).	x _ nameMorph left.	readoutMorphs do: [:m |		m position: x@m top.		x _ m right + 5].	"layout lock and pen morphs"	lockButton ifNotNil: [		lockButton position: (nameMorph right + 4)@(nameMorph top + ((nameMorph height - lockButton height) / 2)).		penReadout position: (lockButton right + 4)@(nameMorph top + ((nameMorph height - penReadout height) / 2))].	"place tab morph"	(readoutMorphs size > 1) ifTrue: [		topSectionHeight _ (readoutMorphs at: 1) bottom - self top + tabPaneMorph height + 5].	tabPaneMorph		width: self width;		position: (self left + 15) @ (self top + topSectionHeight - tabPaneMorph height + 1).	" Hide tab "	tabPaneMorph height: 0; width:0.	"place scripts scroll pane"	pageViewerMorph position: (self left @ (self top + topSectionHeight)).	self extent: self extent. "force resize of page viewer morph"! !!ScratchScriptEditorMorph methodsFor: 'stepping' stamp: 'ee 4/14/2008 15:01'!step	currentCategory = 'Costumes' ifTrue: [self updateCostumeSelection].	(penReadout isNil or: [penReadout owner ~= self]) ifTrue: [^ self].	self target penDown		ifTrue: [penReadout color: self target penColor]		ifFalse: [penReadout color: Color transparent].! !!ScratchScriptEditorMorph methodsFor: 'stepping' stamp: 'jm 1/5/2006 11:11'!stepTime	^ 50! !!ScratchScriptEditorMorph methodsFor: 'stepping' stamp: 'ee 4/14/2008 15:01'!updateCostumeSelection	"Update the currently selected costume if the costumes tab is selected."	| currentCostume |	currentCategory = 'Costumes' ifFalse: [^ self].	currentCostume _ self target costume.	pageViewerMorph contents submorphsDo: [:m |		((m isKindOf: MediaItemMorph) and:		 [m media isImage]) ifTrue: [			m highlight: (m media = currentCostume)]].! !!ScratchScriptEditorMorph methodsFor: 'menu/button ops' stamp: 'ee 5/14/2008 16:40'!addComment: aPosition	| c scriptsMorph |	scriptsMorph _ (pageViewerMorph allMorphs select: [: m | m isKindOf: ScratchScriptsMorph]) first.	scriptsMorph addMorph: (c _ ScratchCommentMorph new position: aPosition).	World activeHand newKeyboardFocus: c commentMorph.! !!ScratchScriptEditorMorph methodsFor: 'menu/button ops' stamp: 'jm 4/27/2007 16:12'!animateRotationStyle	| style thumbForm wasFlipped currentRotation pen center rotatedForm doFlip |	style _ self target rotationStyle.	thumbnailMorph updateThumbnail.	thumbForm _ thumbnailMorph form deepCopy.	currentRotation _ self target rotationDegrees rounded.	wasFlipped _ ((currentRotation \\ 360) >= 90) & ((currentRotation \\ 360) <= 270).	thumbnailMorph showDirection: false.	pen _ (Pen newOnForm: thumbnailMorph form) color: Color white.	center _ thumbnailMorph form center.	currentRotation to: currentRotation + 360 by: 12 do: [:i |		rotatedForm _ thumbForm.  "no rotation by default"		style = #normal ifTrue: [rotatedForm _ thumbForm rotateBy: i].		style = #leftRight ifTrue: [			doFlip _ ((i \\ 360) >= 90) & ((i \\ 360) <= 270).			wasFlipped ifTrue: [doFlip _ doFlip not].			doFlip ifTrue: [rotatedForm _ thumbForm flipBy: #horizontal centerAt: 0@0]].		thumbnailMorph form fill: thumbnailMorph form boundingBox fillColor: Color transparent.		rotatedForm			displayOn: thumbnailMorph form			at: (thumbnailMorph extent - rotatedForm extent) // 2			rule: Form paint.		pen place: center.		pen goto: center + (Point r: 22 degrees: i).		thumbnailMorph changed.		World displayWorldSafely.		Delay waitMSecs: 20].	thumbnailMorph showDirection: true.	thumbnailMorph updateThumbnail.! !!ScratchScriptEditorMorph methodsFor: 'menu/button ops' stamp: 'ee 11/5/2007 11:50'!cleanUp	"Align all scripts vertically in alphabetical order"	| scriptsMorph |	scriptsMorph _ (pageViewerMorph allMorphs select: [:c | c isKindOf: ScratchScriptsMorph]) first.	scriptsMorph cleanUp.	pageViewerMorph		updateContentsExtent;		updateScrollbars.! !!ScratchScriptEditorMorph methodsFor: 'menu/button ops' stamp: 'ee 2/12/2009 16:23'!deleteSprite	"Ask the user if they want to delete the currently selected sprite"	| response |	response _ DialogBoxMorph askWithCancel: 'Delete this sprite?' localized.	response = #cancelled ifTrue: [^ self].	response ifTrue: [thumbnailMorph target undoableDeleteSprite].! !!ScratchScriptEditorMorph methodsFor: 'menu/button ops' stamp: 'jens 3/9/2009 13:19'!saveScriptsToImage	"Take a snapshot of all scripts for a sprite and save as a GIF file"	| fName saveForm |	saveForm _ pageViewerMorph contents screenshot.	fName _ ScratchFileChooserDialog		chooseNewFileDefault: ''		title: 'Save Scripts Snapshot'		type: #scriptsSnapshot.	fName = #cancelled ifTrue: [^ self].	fName size = 0 ifTrue: [^ self].	(fName asLowercase endsWith: '.gif') ifFalse: [fName _ fName, '.gif'].	saveForm writeGIFFileNamed: fName.! !!ScratchScriptEditorMorph methodsFor: 'menu/button ops' stamp: 'jm 3/2/2009 13:00'!scriptsMenu: aPosition	"Present a menu of Scratch script operations."	| menu choice |	self target ifNil: [^ self].	menu _ CustomMenu new.	menu add: 'clean up' action: #cleanUp.	menu add: 'save picture of scripts' action: #saveScriptsToImage.	menu add: 'add comment' action: #addComment:.	choice _ menu localize startUp.	choice ifNil: [^ self].	choice = #addComment:		ifTrue: [self perform: choice with: aPosition]		ifFalse: [self perform: choice].! !!ScratchScriptEditorMorph methodsFor: 'menu/button ops' stamp: 'jm 4/27/2007 15:52'!setRotationStyle: aSymbol	aSymbol == #Smooth ifTrue: [self target rotationStyle: #normal].	aSymbol == #Flip ifTrue: [self target rotationStyle: #leftRight].	aSymbol == #None ifTrue: [self target rotationStyle: #none].	self updateRotationButtonHighlight.	(self target respondsTo: #rotationDegrees:) ifFalse: [^ self].	self animateRotationStyle.! !!ScratchScriptEditorMorph methodsFor: 'menu/button ops' stamp: 'jm 10/19/2007 11:35'!toggleSpriteDraggable	"Add buttons to set the rotation style."	self target draggable: self target draggable not.	self updateLockButton.! !!ScratchScriptEditorMorph methodsFor: 'private' stamp: 'jm 2/22/2009 21:37'!addDeleteButton	"Add button to delete sprite."	self deleteDeleteButton.	deleteButton _ ToggleButton		onForm: (ScratchFrameMorph skinAt: #deleteSprite)		offForm: (ScratchFrameMorph skinAt: #deleteSprite)		overForm: (ScratchFrameMorph skinAt: #deleteSprite).	deleteButton		target: self;		actionSelector: #deleteSprite;		setBalloonText: 'Delete this sprite' localized;		actWhen: #buttonUp;		isMomentary: true;		position: (lockButton right + 27)@(nameMorph top + ((nameMorph height - deleteButton height) / 2)).	self addMorph: deleteButton.! !!ScratchScriptEditorMorph methodsFor: 'private' stamp: 'ee 2/11/2009 14:13'!addLockButton	"Add button to set sprite locked status."	self deleteLockButton.	lockButton _ ToggleButton		onForm: (ScratchFrameMorph skinAt: #locked)		offForm: (ScratchFrameMorph skinAt: #unlocked).	lockButton		target: self;		actionSelector: #toggleSpriteDraggable;		setBalloonText: 'draggable on website?' localized;		actWhen: #buttonUp;		isMomentary: true;		position: (nameMorph right + 4)@(nameMorph top + ((nameMorph height - lockButton height) / 2)).	self addMorph: lockButton.	self updateLockButton.! !!ScratchScriptEditorMorph methodsFor: 'private' stamp: 'ee 2/20/2009 13:14'!addReadouts	"Add readouts for my target's position and direction."	| x y label readout s |	self deleteReadouts.	readoutMorphs _ OrderedCollection new.	x _ nameMorph left.	y _ nameMorph bottom + 5.	#(('x' xpos) ('y' ypos)('direction' heading)) do: [:spec |		(ScratchTranslator isRTL and: [(spec at: 1) = 'x' or: [(spec at: 1) = 'y']])			ifTrue: [s _ (':', spec first) asUTF8]			ifFalse: [s _ (spec first localized, ScratchTranslator colonSuffix)].		label _ StringMorph new			contents: s;			font: (ScratchFrameMorph getFont: #XYReadout);			position: x@y.		readout _ (UpdatingStringMorph on: self target selector: spec second)			font: (ScratchFrameMorph getFont: #XYReadoutBold);			forceUnicodeRendering: true;			color: (Color gray: 0.2);			contents: '-000';  "this sets the readout size"			growable: false;			stepTime: 100;			position: (label right + 4)@y.		ScratchTranslator isRTL ifTrue:[			readout rightJustify: true].		self addMorph: label; addMorph: readout.		readoutMorphs add: label; add: readout.		readout startStepping.		x _ readout right + 2].	ScratchTranslator isRTL ifTrue: [		readoutMorphs reversed do: [: m |			readoutMorphs remove: m.			readoutMorphs add: m]].	penReadout _ Morph new extent: 15@5.	penReadout position: (lockButton right + 4)@(nameMorph top + ((nameMorph height - penReadout height) / 2));		color: Color transparent.	self addMorph: penReadout.	readoutMorphs add: penReadout.	penReadout startStepping.	readoutMorphs _ readoutMorphs asArray.! !!ScratchScriptEditorMorph methodsFor: 'private' stamp: 'jm 3/21/2008 14:02'!addRotationButtons	"Add buttons to set the rotation style."	| specs x y style button |	self deleteRotationButtons.	(self target respondsTo: #rotationStyle:) ifFalse: [^ self].	specs _ #(		(Smooth		'can rotate')		(Flip		'only face left-right')		(None		'don''t rotate')).	x _ self left + 13.	y _ self top + 18.	specs do: [:pair |		style _ pair first.		button _ ToggleButton			onForm: (ScratchFrameMorph skinAt: ('rotStyle', style, 'On'))			offForm: (ScratchFrameMorph skinAt: ('rotStyle', style))			overForm: (ScratchFrameMorph skinAt: ('rotStyle', style, 'Over')).		button			target: self;			arguments: (Array with: style);			actionSelector: #setRotationStyle:;			setBalloonText: pair second localized;			actWhen: #buttonDown;			position: x@y.		self addMorph: button.		rotationButtons _ rotationButtons copyWith: button.		y _ y + button height + 2].	self updateRotationButtonHighlight.! !!ScratchScriptEditorMorph methodsFor: 'private' stamp: 'ee 2/12/2009 10:49'!deleteDeleteButton	"Delete my delete button."	deleteButton ifNotNil: [		deleteButton delete.		deleteButton _ nil].! !!ScratchScriptEditorMorph methodsFor: 'private' stamp: 'jm 10/3/2007 16:42'!deleteLockButton	"Delete my lock button."	lockButton ifNotNil: [		lockButton delete.		lockButton _ nil].! !!ScratchScriptEditorMorph methodsFor: 'private' stamp: 'jm 2/28/2005 17:46'!deleteReadouts	"Delete the position/rotation readouts."	readoutMorphs do: [:m | m delete].	readoutMorphs _ #().! !!ScratchScriptEditorMorph methodsFor: 'private' stamp: 'jm 2/28/2005 17:40'!deleteRotationButtons	"Delete the rotation style buttons."	rotationButtons do: [:m | m delete].	rotationButtons _ #().! !!ScratchScriptEditorMorph methodsFor: 'private' stamp: 'jm 7/3/2008 18:22'!showOrHideReadouts	"If this is a sprite, show the position and direction readouts and the rotation style buttons. Otherwise, hide them."	self deleteRotationButtons; deleteLockButton; deleteReadouts.	nameMorph		font: nameMorph font;		width: nameMorph height * 4;		rightJustify: ScratchTranslator isRTL.	(self target isKindOf: ScratchSpriteMorph) ifTrue: [		self addRotationButtons; addLockButton; addReadouts.		World ifNotNil: [World startSteppingSubmorphsOf: self]].! !!ScratchScriptEditorMorph methodsFor: 'private' stamp: 'jm 10/23/2007 15:24'!updateLockButton	lockButton ifNil: [^ self].	self target draggable		ifTrue: [lockButton off]		ifFalse: [lockButton on].! !!ScratchScriptEditorMorph methodsFor: 'private' stamp: 'jm 2/28/2005 17:33'!updateRotationButtonHighlight	"Highlight the appropriate rotation style button. Do nothing if my target is not a sprite."	| style sym |	(self target isKindOf: ScratchSpriteMorph) ifFalse: [^ self].	style _ self target rotationStyle.	style = #normal ifTrue: [sym _ #Smooth].	style = #leftRight ifTrue: [sym _ #Flip].	style = #none ifTrue: [sym _ #None].	rotationButtons do: [:m |		sym = m arguments first ifTrue: [m on] ifFalse: [m off]].! !!ScratchScriptsMorph methodsFor: 'initialization' stamp: 'KK 9/23/2013 18:57'!initialize	super initialize."Transcript show:'[ScratchScriptsMorph::initialize]';cr."	color _ Color white.	borderWidth _ 0.	self enableDragNDrop: true."(ConvertTuplesToStacks = true) ifFalse: [	self addMorphBack: (EventHatMorph new forStartEvent).].ConvertTuplesToStacks _ false."! !!ScratchScriptsMorph methodsFor: 'stepping' stamp: 'KK 4/30/2014 16:14'!step	"Give feedback about possible drop targets."	| feedbackColor h b targetArg targetAssoc targetP targetBlock |	feedbackMorph		ifNil: [feedbackMorph _ BorderedMorph new borderWidth: 3]  "create feedback morph if necessary"		ifNotNil: [feedbackMorph delete].  "remove old feedback"	feedbackColor _ Color white.	feedbackMorph useSquareCorners.	h _ World activeHand.	h toolType = 'CutTool' ifTrue: [^ self showDeleteFeedback].	(self bounds containsPoint: h position) ifFalse: [^ self].	h submorphCount = 1 ifFalse: [^ self].	b _ h firstSubmorph.	(b isKindOf: ScratchCommentMorph) ifTrue: [^ self showCommentDropFeedback].	(b isKindOf: BlockMorph) ifFalse: [^ self]."attempt at auto-scrolling (has some issues, commented out for now):	((self owner bounds containsPoint: h position) and:		[(h position x - self owner left) < 50 or: [			(self owner right - h position x) < 50 or: [				(self owner bottom - h position y) < 50 or: [					(h position y - self owner top) < 50]]]])		ifTrue:[self owner scrollMorphIntoView: h firstSubmorph].xxxxxxxx"	b isReporter ifTrue: [ "reporter block"		(targetArg _ self topArgMorphAt: b bounds exclude: nil) ifNil: [^ self].		(targetArg acceptsTypeOf: b) ifFalse: [^ self].		feedbackMorph			bounds: (targetArg bounds expandBy: 5);			color: (feedbackColor alpha: 0.4);			borderColor: feedbackColor;			useRoundedCorners.		^ self addMorphFront: feedbackMorph].	"non-reporter (i.e. command block or hat block)"	targetAssoc _ b closestAttachTargetIn: self.	targetAssoc ifNil: [		(b bottomBlock isKindOf: CBlockMorph) ifFalse: [			targetAssoc _ b bottomBlock closestAttachTargetIn: self.			targetAssoc ifNotNil:[				(targetAssoc value owner isKindOf: BlockMorph) ifTrue:[					targetAssoc _ nil]]]].	targetAssoc ifNil: [^ self].	targetP _ targetAssoc key.	targetBlock _ targetAssoc value.	feedbackMorph borderColor: feedbackColor; color: feedbackColor.	"subtract the attachment point x from the width so that the feedback in CBlock won't stick out"	ScratchTranslator isRTL		ifTrue: [feedbackMorph extent: (targetP x - targetBlock left)@5.			self addMorphFront: (feedbackMorph position: targetP - (feedbackMorph width@0))]		ifFalse: [feedbackMorph extent: (targetBlock right - targetP x)@5.			self addMorphFront: (feedbackMorph position: targetP)].! !!ScratchServer methodsFor: 'server control' stamp: 'KK 8/20/2013 15:47'!joinSessionAt: ipAddressString	"Add an outgoing connection to the given address. Fail if a connection cannot be made in bounded amount of time. Answer true if the connection was added successfully."	| addr sock ok |	addr _ NetNameResolver addressForName: ipAddressString timeout: 5.	sock _ MessageSocket new.	ok _ sock connectTo: addr port: ScratchServer portNumber waitSecs: 5.	ok ifFalse: [sock destroy. ^ false].	sock sendMessage: 'peer-name ', userName.	peerSockets add: sock.	^ true! !!ScratchServer methodsFor: 'server control' stamp: 'KK 8/20/2013 14:28'!startHosting	"Open a socket on my port and start accepting connections."	Socket initializeNetwork.	self shutdownServer.	serverSocket _ Socket new.	serverSocket listenOn: self class portNumber backlogSize: 20.	incomingUDPSocket _ Socket newUDP setPort: self class portNumber.! !!ScratchServer methodsFor: 'private-server' stamp: 'KK 1/18/2013 09:47'!broadcastMessageFor: aString	"Answer a message to broadcast the given string."	| msg |	msg _ WriteStream on: String new.	msg nextPutAll: 'broadcast '.	self putString: aString on: msg.	^ msg contents! !!ScratchServer methodsFor: 'private-server' stamp: 'KK 1/18/2013 09:49'!sendOutgoingCommands	"Send broadcasts and variable updates to my peers."	| varUpdateMsg |	self someVariableHasChanged		ifTrue: [varUpdateMsg _ self variableUpdateMessage]		ifFalse: [varUpdateMsg _ nil].	peerSockets copy do: [:sock |		sock isConnected			ifTrue: [				varUpdateMsg ifNotNil: [sock sendMessage: varUpdateMsg].				outgoingBroadcasts do: [:evt | sock sendMessage: (self broadcastMessageFor: evt)].				sock sendData]			ifFalse: [				sock destroy.				peerSockets remove: sock ifAbsent: []]].	self recordVariableValues.! !!ScratchThread methodsFor: 'system cmds' stamp: 'KK 4/28/2014 11:21'!doRepeat	"Execute my enclosed blocks the number of times given by my argument. tmp is used to count down the iterations."	| cmd |	cmd _ cmds at: ip.	tmp ifNil: [  "first time"		tmp _ self evalArg: (cmd at: 2)].	tmp <= 0 ifTrue: [^ self].  "repeat is finished"	tmp _ tmp - 1.	self evalCmdList: (cmd at: 3).! !!ScratchTranslator class methodsFor: 'language translation' stamp: 'KK 8/30/2013 17:31'!setLanguage: aString	"Set the current language. If the language is not supported, use English (i.e. an empty translation dictionary)."	| dict |	"default to English"	Language _ 'en'.	TranslationDict _ Dictionary new.	HeaderString _ ''.	self setRenderingHints.  "clear rendering hints"	ScratchTranslator detectRenderPlugin.	aString = 'en' ifTrue: [^ self].	dict _ self importTranslation: aString, '.po'.	dict ifNotNil: [		Language _ aString.		TranslationDict _ dict.		HeaderString _ dict at: '' ifAbsent: [''].		dict removeKey: '' ifAbsent: [].		self setRenderingHints.		RenderWithSqueak ifTrue: [self convertToMacRoman].		self isRTL ifTrue: [self fixAmbigousRTLPunctuation].		self addSensorTranslations].! !!ScratchTranslator class methodsFor: 'import/export' stamp: 'KK 8/30/2013 19:55'!exportStringsToTranslateFrom: aDictionary toFile: fName	"Export the strings to be translated either to Scratch.pot or an existing translation (.po) file."	"self resetUITranslationSet. self resetMIDITranslationSet. self exportStringsToTranslateFrom: nil toFile: nil"	"self resetMIDITranslationSet. self exportStringsToTranslateFrom: (self importTranslation: 'es.po') toFile: 'exportTest.po'"	| dir fn header f sections templateDict title keys comments |	self setLanguage: 'en'.	header _ HeaderString.	dir _ self translationDir.	fn _ fName.	fn ifNil: [fn _ self templateFilename].	(dir fileExists: fn) ifTrue: [  "extract the existing header, then delete the old .po file"		aDictionary ifNotNil: [			header _ aDictionary at: '' ifAbsent: [''].			dir deleteFileNamed: (dir fullNameFor: fn)]].	f _ FileStream newFileNamed: (dir fullNameFor: fn).	"f nextPutAll: #(239 187 191) asByteArray asString."  "UTF8 byte-order mark - removed for now (Pootle)"	"header comments are stored as '-comments' because the header key is the empty string"	aDictionary ifNotNil: [		comments _ aDictionary at: '-comments' ifAbsent: [#()].		comments do: [:s | f nextPutAll: s; crlf]].	"header is stored as a multi-line translation entry for the empty string"	self export: 'msgid' value: '' to: f.	self export: 'msgstr' value: header to: f.	f crlf.	sections _ {		{'FORMATTING'.			self formattingHeaderFields}.		{'BLOCKS'.				ScriptableScratchMorph blockSpecsForTranslation}.		{'USER INTERFACE'.		self uiTranslationSetAsSortedArray}. 		{'MIDI INSTRUMENTS'.	self midiTranslationSet asArray sort}	}.	aDictionary ifNotNil: [templateDict _ self importTranslation: self templateFilename].	sections do: [:pair |		title _ pair first.		keys _ pair second asOrderedCollection.		f nextPutAll: '############################################'; crlf.		f nextPutAll: '# ', title; crlf.		f nextPutAll: '############################################'; crlf.		f crlf.		((title = 'FORMATTING') and: [aDictionary isNil]) ifTrue: [			f nextPutAll: self formattingSectionForPOT.			keys _ OrderedCollection new].		keys removeAll: self doNotTranslate.		keys do: [:k |			(aDictionary isNil or: [templateDict includesKey: k]) ifTrue: [				"COMMENTS"				comments _ #().				(templateDict notNil and: [templateDict includesKey: k,'-comments'])					ifTrue: [ "use the comment from template .pot file if there is one"						comments _ (templateDict at: k, '-comments')]					ifFalse: [ "else use the comment from the translation file"						aDictionary ifNotNil: [							comments _ aDictionary at: k, '-comments' ifAbsent: [#()]]].				comments do: [:s | f nextPutAll: s; crlf].				"FUZZY TAG"				(aDictionary notNil and: [aDictionary includesKey: k, '-fuzzy'])					ifTrue: [f nextPutAll: '#, fuzzy'; crlf].				"KEY"				self export: 'msgid' value: k to: f.				"TRANSLATION"				(aDictionary notNil and: [aDictionary includesKey: k])					ifTrue: [						self export: 'msgstr' value: (aDictionary at: k) to: f]					ifFalse: [						(aDictionary notNil and: [aDictionary includesKey: k asLowercase])							ifTrue: [  "TEMPORARY CAPITALIZATION HACK"								self export: 'msgstr' value: (aDictionary at: k asLowercase) to: f]							ifFalse: [								(aDictionary notNil and: [(k endsWith: '?') and: [aDictionary includesKey: (k copyFrom: 1 to: k size - 1)]])									ifTrue: [  "TEMPORARY QUESTION HACK"										self export: 'msgstr' value: (aDictionary at: (k copyFrom: 1 to: k size - 1)) to: f]									ifFalse: [  "BLANK TRANSLATION"										self export: 'msgstr' value: '' to: f]]].				f crlf]]].	f close.! !!ScratchViewerMorph methodsFor: 'initialization' stamp: 'KK 1/15/2013 13:23'!rebuildCategorySelectors	| catList maxExtent buttons label offForm onForm overForm b pad leftColumnX rightColumnX x y |"xxx	catList _ #(		motion		control		looks		sensing		sound		operators		pen			variables)."	catList _ #(		motion		control					sensing					operators					variables).	"First, delete the old category buttons"	submorphs do: [:m | (m isKindOf: ResizableToggleButton2) ifTrue: [m delete]].	"Create new buttons, keeping track of the maximum extent."	maxExtent _ 75@0.	buttons _ catList collect: [:cat |		label _ (ScratchTranslator translationFor: cat asString) capitalized.		offForm _ (ScratchFrameMorph skinAt: cat).		onForm _ (ScratchFrameMorph skinAt: (cat, 'Pressed')).		overForm _ (ScratchFrameMorph skinAt: (cat, 'Over')).		ScratchTranslator isRTL			ifTrue:[				b _ ResizableToggleButton2 new					offForm:	(offForm flipBy: #horizontal centerAt: offForm center)					onForm:		(onForm flipBy: #horizontal centerAt: onForm center)					overForm:	(overForm flipBy: #horizontal centerAt: overForm center)]			ifFalse:[				b _ ResizableToggleButton2 new					offForm:	offForm					onForm:		onForm					overForm:	overForm].		b			label: label font: (ScratchFrameMorph getFont: #Category);			setLabelColor: Color white;			target: self;			actionSelector: #currentCategory:;			arguments: (Array with: cat);			toggleButtonMode: true;			toggleMode: false.		ScratchTranslator isRTL			ifTrue:[b rightJustifyInset: 10]			ifFalse:[b leftJustifyInset: 10].		maxExtent _ maxExtent max: (b extent + (3 @ -6)).		b].	"calculate catButtonsExtent"	pad _ 15. "padding on left, right, and betwen the button columns"	catButtonsExtent _ ((2 * maxExtent x) + (3 * pad)) @ (((catList size // 2+1) * (maxExtent y + 6)) + 25).	"place the buttons"	leftColumnX _ self left + 12 + pad.	rightColumnX _ leftColumnX + maxExtent x + pad.	x _ leftColumnX.	y _ self top + 17.	1 to: buttons size do: [:i |		b _ buttons at: i.		b extent: maxExtent.		self addMorph: (b position: x@y).		i even			ifTrue: [x _ leftColumnX. y _ y + b height + 6]			ifFalse: [x _ rightColumnX]].	self width: catButtonsExtent x.	pageViewer position: self position + (0@catButtonsExtent y).	topSectionHeight _ catButtonsExtent y - 4.! !!ScriptableScratchMorph methodsFor: 'initialization' stamp: 'KK 9/23/2013 18:53'!initialize	| |	super initialize.	objName _ self nextInstanceName.	vars _ Dictionary new.	lists _ Dictionary new.	blocksBin _ ScratchScriptsMorph new.	"  ""	(ConvertTuplesToStacks = true) ifFalse: ["		blocksBin addMorphBack: (EventHatMorph new forStartEvent scriptOwner: super)."	].	ConvertTuplesToStacks _ false."	isClone _ false.	costume _ self defaultImageMedia.	media _ OrderedCollection new.	costumeChangeMSecs _ 0.	visibility _ 100.	volume _ 100.	tempoBPM _ 60.	sceneStates _ Dictionary new.! !!ScriptableScratchMorph methodsFor: 'looks ops' stamp: 'sk 3/25/2016 16:43'!boardLED	" Check I/O pin configuration and answer a collection of board leds. "	| leds |Transcript show: 'boardLED'.	leds _ OrderedCollection new.	(IOPort at: 3) = 5 ifTrue: [		leds add: 'Red(D5)'].	(IOPort at: 4) = 5 ifTrue: [		leds add: 'Yellow(D6)'].	(IOPort at: 5) = 5 ifTrue: [		leds add: 'Green(D9)'].	^ leds! !!ScriptableScratchMorph methodsFor: 'looks ops' stamp: 'kk 7/5/2013 15:26'!bzrLEDPinNo	"Answer a collection of Buzzer/LED connected pin number."	^ #(		'A0'		'A1'		'A2'		'A3'		'A4'		'A5'		)! !!ScriptableScratchMorph methodsFor: 'looks ops' stamp: 'KK 9/20/2013 15:57'!bzrPinNo	" Check I/O pin configuration and reflect for argument "	"Answer a collection of buzzer number."	| offset validBuzzerPin id |	offset _ 10.	validBuzzerPin _ OrderedCollection new.	1 to: 8 do: [ :index |		id _ IOPort at: (index + offset).		id = 16r04 ifTrue: [			validBuzzerPin add: 'A', (index-1) asString.		]	].		^ validBuzzerPin.! !!ScriptableScratchMorph methodsFor: 'looks ops' stamp: 'KK 9/23/2013 21:20'!dcMotorNo	" Check I/O pin configuration and reflect for argument "	"Answer a collection of DC motor number."	| dcPin offset validDCPin id |	dcPin _ Array new: 2.	dcPin		at: 1 put: 'M1';		at: 2 put: 'M2'.	offset _ 0.	validDCPin _ OrderedCollection new.	1 to: 2 do: [ :index |		id _ IOPort at: (index + offset).		id = 1 ifTrue: [			validDCPin add: (dcPin at: index).		]	].		^ validDCPin."	^ #('M1' 'M2')	"! !!ScriptableScratchMorph methodsFor: 'looks ops' stamp: 'KK 2/12/2013 17:19'!dcMotorOff	"Answer a collection of DC motor Off."	^ #(		'Brake'		'Coast')! !!ScriptableScratchMorph methodsFor: 'looks ops' stamp: 'KK 2/12/2013 17:19'!dcMotorOn	"Answer a collection of DC motor On."	^ #(		'cw.'		'ccw.')! !!ScriptableScratchMorph methodsFor: 'looks ops' stamp: 'KK 9/4/2013 09:11'!ledColor	"Answer a collection of Buzzer/LED connected pin number."	^ #(		'White'		'Red'		'Green'		'Blue'		'Cyan'		'Magenta'		'Yellow'		)! !!ScriptableScratchMorph methodsFor: 'looks ops' stamp: 'kk 7/5/2013 15:24'!ledOnOff	"Answer a collection of LED On/Off."	^ #(		'on'		'off')! !!ScriptableScratchMorph methodsFor: 'looks ops' stamp: 'KK 9/20/2013 15:58'!ledPinNo	" Check I/O pin configuration and reflect for argument "	"Answer a collection of LED number."	| offset validLEDPin id |	offset _ 10.	validLEDPin _ OrderedCollection new.	1 to: 8 do: [ :index |		id _ IOPort at: (index + offset).		id = 16r03 ifTrue: [			validLEDPin add: 'A', (index-1) asString.		]	].		^ validLEDPin.! !!ScriptableScratchMorph methodsFor: 'looks ops' stamp: 'KK 12/26/2012 10:39'!motorOnOff	"Answer a collection of DC motor number."	^ #(		'on'		'off')! !!ScriptableScratchMorph methodsFor: 'looks ops' stamp: 'KK 1/24/2014 18:41'!moveDirection	"Answer a collection of move."	^ #(		'Forward'		'Back'		'Left front'		'Right front'		'Left rear'		'Right rear'		'cw.'		'ccw.'		)! !!ScriptableScratchMorph methodsFor: 'looks ops' stamp: 'sk 7/7/2016 19:38'!svMotorNo	" Check I/O pin configuration and reflect for argument "	"Answer a collection of servo motor number."	| servoPin offset validServoPin id |	(BoardType = 0 or: [BoardType = 2]) ifTrue: [		servoPin _ #('D2' 'D4' 'D7' 'D8' 'D9' 'D10' 'D11' 'D12').]	ifFalse: [		servoPin _ #('D5' 'D6' 'D9' 'D10' 'D11').].	offset _ 2.	validServoPin _ OrderedCollection new.	1 to: (servoPin size) do: [ :index |		id _ IOPort at: (index + offset).		id = 2 ifTrue: [			validServoPin add: (servoPin at: index).		]	].	^ validServoPin."	^ #('D2' 'D4' 'D7' 'D8' 'D9' 'D10' 'D11' 'D12')	"! !!ScriptableScratchMorph methodsFor: 'sensing ops' stamp: 'KK 8/31/2013 11:11'!accelerometer: sensorName	"Answer the value of the given sensor, or zero if the sensorboard is not available."	^ self sensor: sensorName.! !!ScriptableScratchMorph methodsFor: 'sensing ops' stamp: 'sk 4/14/2016 16:32'!clockValue: type	^ 0! !!ScriptableScratchMorph methodsFor: 'sensing ops' stamp: 'sk 2/18/2016 10:12'!clockVars	| varNames |	varNames _ #(		'Hour'		'Minute'		'Year'		'Month'		'Day'		'Temperature'		'Alarm hour'		'Alarm minute'	).	^ varNames! !!ScriptableScratchMorph methodsFor: 'sensing ops' stamp: 'KK 9/20/2013 09:37'!hookupARButton	" Check I/O pin configuration and reflect for argument "	"Answer a collection of button number."	| offset validButton id |	offset _ 10.	validButton _ OrderedCollection new.	1 to: 4 do: [ :index |		id _ IOPort at: (index + offset).		id = 16r15 ifTrue: [			validButton add: 'A', (index-1) asString.		]	].		^ validButton.! !!ScriptableScratchMorph methodsFor: 'sensing ops' stamp: 'sk 4/1/2016 09:57'!hookupARSensorNames	| sensorNames offset light touch sound infrared acceleration button setAcceleration sensorID |	" Check IOPort "	Transcript show:(IOPort);cr.	offset _ 11.		" Offset for sensor ID "	light _ 16r10.			" Light sensor ID "	touch _ 16r11.			" Touch sensor ID "	sound _ 16r12.			" Sound sensor ID "	infrared _ 16r13.		" IR Photoreflector ID "	acceleration _ 16r14.		" Acceleration sensor ID "	button _ 16r15.			" Button sensor ID "	setAcceleration _ false.	" Set acceleration sensor flag "	sensorNames _ OrderedCollection new.	0 to: 7 do: [ :index |		sensorID _ IOPort at: (index + offset).		(sensorID < 16r10) ifTrue: [		] ifFalse: [			(sensorID = light) ifTrue: [	" Light Sensor "				sensorNames add:'[A',index asString,']',' Light sensor'.			].			(sensorID = touch) ifTrue: [	" Touch Sensor "				sensorNames add:'[A',index asString,']',' Touch sensor'.			].			(sensorID = sound) ifTrue: [	" Sound Sensor "				sensorNames add:'[A',index asString,']',' Sound sensor'.			].			(sensorID = infrared) ifTrue: [	" IR Photoreflector "				sensorNames add:'[A',index asString,']',' IR Photoreflector'.			].			(sensorID = acceleration) ifTrue: [	" Acceleration Sensor "				(setAcceleration = false) ifTrue: [					sensorNames add:'[A4/A5] Acceleration sensor (X)'.					sensorNames add:'[A4/A5] Acceleration sensor (Y)'.					sensorNames add:'[A4/A5] Acceleration sensor (Z)'.					setAcceleration _ True.				].			].			(sensorID = button) ifTrue: [	" Button "				sensorNames add:'[A',index asString,']',' Button'.			].		].	]."	sensorNames _ #(		'A0'		'A1'		'A2'		'A3'		'A4'		'A5'		'A6'		'A7'	)."	^ sensorNames! !!ScriptableScratchMorph methodsFor: 'sensing ops' stamp: 'KK 8/23/2013 13:35'!hookupARSensorPinID	| sensorNames |	sensorNames _ #(		'A0'		'A1'		'A2'		'A3'		'A4'		'A5'		'A6'		'A7'	).	^ sensorNames! !!ScriptableScratchMorph methodsFor: 'sensing ops' stamp: 'KK 8/23/2013 13:36'!hookupARSensorPinID1	| sensorNames |	sensorNames _ #(		'A0'		'A1'		'A2'		'A3'		'A4'		'A5'		'A6'		'A7'	).	^ sensorNames! !!ScriptableScratchMorph methodsFor: 'sensing ops' stamp: 'KK 8/31/2013 11:18'!hookupARSensorPinID2	^ #(		'A0'		'A1'		'A2'		'A3'		'A4'		'A5'	).! !!ScriptableScratchMorph methodsFor: 'sensing ops' stamp: 'KK 8/29/2013 17:32'!hookupARSensorXYZ	| sensorNames |	sensorNames _ #(		'X'		'Y'		'Z'	).	^ sensorNames! !!ScriptableScratchMorph methodsFor: 'sensing ops' stamp: 'KK 9/20/2013 09:26'!hookupIRPin	" Check I/O pin configuration and reflect for argument "	"Answer a collection of light sensor number."	| offset validIRPin id |	offset _ 10.	validIRPin _ OrderedCollection new.	1 to: 8 do: [ :index |		id _ IOPort at: (index + offset).		id = 16r13 ifTrue: [			validIRPin add: 'A', (index-1) asString.		]	].		^ validIRPin.! !!ScriptableScratchMorph methodsFor: 'sensing ops' stamp: 'KK 9/20/2013 09:25'!hookupLightPin	" Check I/O pin configuration and reflect for argument "	"Answer a collection of light sensor number."	| offset validLightPin id |	offset _ 10.	validLightPin _ OrderedCollection new.	1 to: 8 do: [ :index |		id _ IOPort at: (index + offset).		id = 16r10 ifTrue: [			validLightPin add: 'A', (index-1) asString.		]	].		^ validLightPin.! !!ScriptableScratchMorph methodsFor: 'sensing ops' stamp: 'KK 9/20/2013 09:13'!hookupSensorIDPin	| offset validServoPin id |	offset _ 10.	validServoPin _ OrderedCollection new.	1 to: 8 do: [ :index |		id _ IOPort at: (index + offset).		id = 16r10 ifTrue: [			validServoPin add: 'Light sensor(A', (index-1) asString, ')'.		]	].		^ validServoPin.! !!ScriptableScratchMorph methodsFor: 'sensing ops' stamp: 'KK 9/20/2013 09:38'!hookupSoundPin	" Check I/O pin configuration and reflect for argument "	"Answer a collection of sound sensor number."	| offset validSoundPin id |	offset _ 10.	validSoundPin _ OrderedCollection new.	1 to: 8 do: [ :index |		id _ IOPort at: (index + offset).		id = 16r12 ifTrue: [			validSoundPin add: 'A', (index-1) asString.		]	].		^ validSoundPin.! !!ScriptableScratchMorph methodsFor: 'sensing ops' stamp: 'KK 9/20/2013 09:33'!hookupTouchPin	" Check I/O pin configuration and reflect for argument "	"Answer a collection of touch sensor number."	| offset validTouchPin id |	offset _ 10.	validTouchPin _ OrderedCollection new.	1 to: 8 do: [ :index |		id _ IOPort at: (index + offset).		id = 16r11 ifTrue: [			validTouchPin add: 'A', (index-1) asString.		]	].		^ validTouchPin.! !!ScriptableScratchMorph methodsFor: 'sensing ops' stamp: 'KK 10/3/2013 14:29'!indexForSensorName: sensorName	| sensorID acceleration |	"Answer the index for the given sensor name."	sensorName startsWithDigit ifTrue: [^ sensorName asNumberNoError].	sensorID _ IOPort at: (15).	" 14 and 15 : Acceleration ? "	acceleration _ 16r14.			" Acceleration sensor ID "	'A0' = sensorName		ifTrue: [^ 1].	'A1' = sensorName		ifTrue: [^ 2].	'A2' = sensorName		ifTrue: [^ 3].	'A3' = sensorName		ifTrue: [^ 4].	(sensorID = acceleration) ifFalse: [		'A4' = sensorName		ifTrue: [^ 5].		'A5' = sensorName		ifTrue: [^ 6].		'A6' = sensorName		ifTrue: [^ 7].		'A7' = sensorName		ifTrue: [^ 8].	] ifTrue: [		'X' = sensorName		ifTrue: [^ 5].		'Y' = sensorName		ifTrue: [^ 6].		'Z' = sensorName		ifTrue: [^ 7].		'A6' = sensorName		ifTrue: [^ 8].		'A7' = sensorName		ifTrue: [^ 9].	]."	'Light(Left)' = sensorName		ifTrue: [^ 1].	'Light(Right)' = sensorName			ifTrue: [^ 2].	'sound' = sensorName		ifTrue: [^ 3].	(sensorName includesSubString: 'button') ifTrue: [^ 4].	'Button(Left)' = sensorName		ifTrue: [^ 5].	'Button(Center)' = sensorName	ifTrue: [^ 6].	'Button(Right)' = sensorName	ifTrue: [^ 7].	'Button(Enter)' = sensorName		ifTrue: [^ 8].	(sensorName includes: $A)	ifTrue: [^ 5].	(sensorName includes: $B)	ifTrue: [^ 6].	(sensorName includes: $C)	ifTrue: [^ 7].	(sensorName includes: $D)	ifTrue: [^ 8]."	^ 1! !!ScriptableScratchMorph methodsFor: 'sensing ops' stamp: 'sk 7/6/2016 10:10'!isInAlarm	^ true! !!ScriptableScratchMorph methodsFor: 'sensing ops' stamp: 'KK 8/30/2013 16:34'!lightSensor: sensorName	"Answer the value of the given sensor, or zero if the sensorboard is not available."	^ self sensor: sensorName.! !!ScriptableScratchMorph methodsFor: 'sensing ops' stamp: 'KK 12/19/2012 18:40'!motor: n deg: d| stage |! !!ScriptableScratchMorph methodsFor: 'sensing ops' stamp: 'KK 8/31/2013 11:11'!onBoardButton: sensorName	"Answer the value of the given sensor, or zero if the sensorboard is not available."	^ self sensor: sensorName.! !!ScriptableScratchMorph methodsFor: 'sensing ops' stamp: 'sk 3/1/2016 15:52'!onBoardLightSensor	"Answer the value of on-board light sensor value."	^ self sensor: 'A6'.! !!ScriptableScratchMorph methodsFor: 'sensing ops' stamp: 'sk 3/1/2016 15:53'!power	"Answer the value of battery voltage."	^ self sensor: 'A7'.! !!ScriptableScratchMorph methodsFor: 'sensing ops' stamp: 'KK 8/31/2013 11:11'!refPhotosensor: sensorName	"Answer the value of the given sensor, or zero if the sensorboard is not available."	^ self sensor: sensorName.! !!ScriptableScratchMorph methodsFor: 'sensing ops' stamp: 'sk 3/10/2016 20:49'!sensor: sensorName	"Answer the value of the given sensor, or zero if the sensorboard is not available."	| stage v sb |	(stage _ self ownerThatIsA: ScratchStageMorph) ifNil: [^ 0].	stage scratchServer ifNotNil: [		v _ stage scratchServer sensorValueFor: sensorName.		v ifNotNil: [^ v]].	'tilt' = sensorName ifTrue: [^ WeDoPlugin tilt].	'distance' = sensorName ifTrue: [^ WeDoPlugin distance].	sb _ stage sensorBoard.	(BoardType = 0) ifTrue: [		sb tryToOpenPort ifFalse: [^ 0].]  "could not open"	ifFalse: [		sb socketIsOpen ifFalse: [^ 0]].	^ sb sensor: (self indexForSensorName: sensorName)! !!ScriptableScratchMorph methodsFor: 'sensing ops' stamp: 'KK 8/31/2013 11:11'!soundSensor: sensorName	"Answer the value of the given sensor, or zero if the sensorboard is not available."	^ self sensor: sensorName.! !!ScriptableScratchMorph methodsFor: 'sensing ops' stamp: 'KK 8/31/2013 11:10'!touchSensor: sensorName	"Answer the value of the given sensor, or zero if the sensorboard is not available."	^ self sensor: sensorName.! !!ScriptableScratchMorph methodsFor: 'list ops' stamp: 'KK 9/1/2014 11:58'!addGlobalList	| sFrame listName |	(sFrame _ self ownerThatIsA: ScratchFrameMorph) ifNil: [^ self beep].	ValueOrList _ true.	listName _ StringDialog ask: 'List name?(Only alphanumeric characters are allowed)'.	listName size = 0 ifTrue: [^ self].	sFrame workPane createListNamed: listName.	sFrame viewerPane categoryChanged: 'variables'.! !!ScriptableScratchMorph methodsFor: 'list ops' stamp: 'sk 7/7/2016 19:37'!defaultArgsFor: blockSpec	"Answer the default argument for the given block specification."	| defaultArgs stage sel currentSize list offset isDetect partsID arrPort |	defaultArgs _ blockSpec copyFrom: 4 to: blockSpec size.  "may be empty"	stage _ self ownerThatIsA: ScratchStageMorph.	sel _ (blockSpec at: 3) asSymbol.	#gotoX:y: = sel ifTrue: [		defaultArgs _ Array			with: self referencePosition x rounded			with: self referencePosition y rounded].	#glideSecs:toX:y:elapsed:from: = sel ifTrue: [		defaultArgs _ Array			with: 1			with: self referencePosition x rounded			with: self referencePosition y rounded].	#motor:direction: = self ifTrue: [		defaultArgs _ Array with: 'reverse' localized with: 'this way' localized with: 'that way'].	#setSizeTo: = sel ifTrue: [		currentSize _ (100.0 * (self scalePoint x max: self scalePoint y)) rounded.		defaultArgs _ Array with: currentSize].	#getAttribute:of: = sel ifTrue: [		(stage _ self ownerThatIsA: ScratchStageMorph) ifNotNil: [			list _ stage submorphs select: [:m | m isKindOf: ScratchSpriteMorph].			list sort: [:s1 :s2 | s1 objName asLowercase < s2 objName asLowercase].			list size > 0				ifTrue: [defaultArgs _ Array with: 'x position' with: list first]				ifFalse: [defaultArgs _ Array with: 'background #' with: stage]]		ifNil:[defaultArgs _ Array with: 'x position' with: self]].	#concatenate:with: = sel ifTrue: [		defaultArgs _ Array with: 'hello ' localized with: 'world' localized].	#doAsk = sel ifTrue: [		defaultArgs _ Array with: 'What''s your name?' localized].	#letter:of: = sel ifTrue: [		defaultArgs _ Array with: 1 with: 'world' localized].	#stringLength: = sel ifTrue: [		defaultArgs _ Array with: 'world' localized].	#say:duration:elapsed:from: = sel ifTrue: [		defaultArgs _ Array with: 'Hello!!' localized with: 2].	#say: = sel ifTrue: [		defaultArgs _ Array with: 'Hello!!' localized].	#think:duration:elapsed:from: = sel ifTrue: [		defaultArgs _ Array with: 'Hmm...' localized with: 2].	#think: = sel ifTrue: [		defaultArgs _ Array with: 'Hmm...' localized].	(#(lookLike: showBackground:) includes: sel) ifTrue: [		defaultArgs _ Array with: self costumeNames last].	(#(playSound: doPlaySoundAndWait) includes: sel) ifTrue: [		list _ self soundNames.		defaultArgs _ list size <= 2			ifTrue: [Array with: '']			ifFalse: [Array with: (list at: (list size - 2))]].	(#(broadcast: doBroadcastAndWait) includes: sel) ifTrue: [		stage ifNotNil: [defaultArgs _ Array with: stage defaultEventName]].	(#(append:toList: deleteLine:ofList: insert:at:ofList:) includes: sel) ifTrue: [		defaultArgs size >= 1 ifTrue: [			defaultArgs at: 1 put: (defaultArgs at: 1) localized]].	(#(append:toList: deleteLine:ofList: getLine:ofList: insert:at:ofList: lineCountOfList:)		includes: sel) ifTrue: [			defaultArgs _ defaultArgs copyWith: self defaultListName].	#setLine:ofList:to: = sel ifTrue: [		defaultArgs size >= 3 ifTrue: [			defaultArgs at: 2 put: self defaultListName.			defaultArgs at: 3 put: (defaultArgs at: 3) localized]].	#appendLettersOf:toList: = sel ifTrue: [		defaultArgs size >= 2 ifTrue: [			defaultArgs at: 1 put: (defaultArgs at: 1) localized.			defaultArgs at: 2 put: self defaultListName]].	#list:contains: = sel ifTrue: [		defaultArgs size >= 2 ifTrue: [			defaultArgs at: 1 put: self defaultListName.			defaultArgs at: 2 put: (defaultArgs at: 2) localized]].	((#motorNo:power: = sel) | (#motorNo:dcMotorOn: = sel) | (#motorNo:dcMotorOff: = sel)) ifTrue: [		isDetect _ false.			" detect DC motor? "		offset _ 0.				" 1-2:DC 3-10:SV 11-18:Sensor "		partsID _ 16r01.			" 01:DC 02:SV 03:LED 04:BZR 05:CLED 10:LS 11:TS 12:SS 13:IRS 14:3S 15:BTN"		defaultArgs at: 1 put: ''.		1 to: 2 do: [ :index |			(((IOPort at: (index+offset)) = partsID) & (isDetect = false)) ifTrue: [				(index = 1) ifTrue: [ defaultArgs at: 1 put: 'M1'. isDetect _ true. ].				(index = 2) ifTrue: [ defaultArgs at: 1 put: 'M2'. isDetect _ true. ].			]		].	].	#motorNo:degree: = sel ifTrue: [		isDetect _ false.			" detect servo motor? "		offset _ 2.				" 1-2:DC 3-10:SV 11-18:Sensor "		partsID _ 16r02.			" 01:DC 02:SV 03:LED 04:BZR 05:CLED 10:LS 11:TS 12:SS 13:IRS 14:3S 15:BTN"		defaultArgs at: 1 put: ''.	""		(BoardType = 0 or: [BoardType = 2]) ifTrue: [			arrPort _ #('D2' 'D4' 'D7' 'D8' 'D9' 'D10' 'D11' 'D12').]		ifFalse: [ " Studuino mini "			arrPort _ #('D5' 'D6' 'D9' 'D10' 'D11').].		1 to: (arrPort size) do: [:index |			((IOPort at: (index + offset)) = partsID) ifTrue: [				defaultArgs at: 1 put: (arrPort at: index).				^ defaultArgs.].]."		1 to: 8 do: [ :index |			(((IOPort at: (index+offset)) = partsID) & (isDetect = false)) ifTrue: [				(index = 1) ifTrue: [ defaultArgs at: 1 put: 'D2'. isDetect _ true. ].				(index = 2) ifTrue: [ defaultArgs at: 1 put: 'D4'. isDetect _ true. ].				(index = 3) ifTrue: [ defaultArgs at: 1 put: 'D7'. isDetect _ true. ].				(index = 4) ifTrue: [ defaultArgs at: 1 put: 'D8'. isDetect _ true. ].				(index = 5) ifTrue: [ defaultArgs at: 1 put: 'D9'. isDetect _ true. ].				(index = 6) ifTrue: [ defaultArgs at: 1 put: 'D10'. isDetect _ true. ].				(index = 7) ifTrue: [ defaultArgs at: 1 put: 'D11'. isDetect _ true. ].				(index = 8) ifTrue: [ defaultArgs at: 1 put: 'D12'. isDetect _ true. ].			]		]."	].	(#ledPin:onOff: = sel) ifTrue: [		isDetect _ false.			" detect buzzer? "		offset _ 10.				" 1-2:DC 3-10:SV 11-18:Sensor "		partsID _ 16r03.			" 01:DC 02:SV 03:LED 04:BZR 05:CLED 10:LS 11:TS 12:SS 13:IRS 14:3S 15:BTN"		defaultArgs at: 1 put: ''.		1 to: 6 do: [ :index |			(((IOPort at: (index+offset)) = partsID) & (isDetect = false)) ifTrue: [				defaultArgs at: 1 put: ('A', (index-1) asString).				isDetect _ true.			]		].	].	((#buzzerPin:freq: = sel) | (#buzzerPin: = sel)) ifTrue: [		isDetect _ false.			" detect buzzer? "		offset _ 10.				" 1-2:DC 3-10:SV 11-18:Sensor "		partsID _ 16r04.			" 01:DC 02:SV 03:LED 04:BZR 05:CLED 10:LS 11:TS 12:SS 13:IRS 14:3S 15:BTN"		defaultArgs at: 1 put: ''.		1 to: 6 do: [ :index |			(((IOPort at: (index+offset)) = partsID) & (isDetect = false)) ifTrue: [				defaultArgs at: 1 put: ('A', (index-1) asString).				isDetect _ true.			]		].	].	(#lightSensor: = sel) ifTrue: [		isDetect _ false.			" detect buzzer? "		offset _ 10.				" 1-2:DC 3-10:SV 11-18:Sensor "		partsID _ 16r10.			" 01:DC 02:SV 03:LED 04:BZR 05:CLED 10:LS 11:TS 12:SS 13:IRS 14:3S 15:BTN"		defaultArgs at: 1 put: ''.		(BoardType = 0 or: [BoardType = 2]) ifTrue: [			arrPort _ #('A0' 'A1' 'A2' 'A3' 'A4' 'A5' 'A6' 'A7').]		ifFalse: [ " Studuino mini "			arrPort _ #('A0' 'A1' 'A2' 'A3' 'A4' 'A5').].		1 to: (arrPort size) do: [:index |			((IOPort at: (index + offset)) = partsID) ifTrue: [				defaultArgs at: 1 put: (arrPort at: index).				^ defaultArgs.].]."		1 to: 8 do: [ :index |			(((IOPort at: (index+offset)) = partsID) & (isDetect = false)) ifTrue: [				defaultArgs at: 1 put: ('A', (index-1) asString).				isDetect _ true.			]		]."	].	(#touchSensor: = sel) ifTrue: [		isDetect _ false.			" detect buzzer? "		offset _ 10.				" 1-2:DC 3-10:SV 11-18:Sensor "		partsID _ 16r11.			" 01:DC 02:SV 03:LED 04:BZR 05:CLED 10:LS 11:TS 12:SS 13:IRS 14:3S 15:BTN"		defaultArgs at: 1 put: ''.		1 to: 6 do: [ :index |			(((IOPort at: (index+offset)) = partsID) & (isDetect = false)) ifTrue: [				defaultArgs at: 1 put: ('A', (index-1) asString).				isDetect _ true.			]		].	].	(#soundSensor: = sel) ifTrue: [		isDetect _ false.			" detect buzzer? "		offset _ 10.				" 1-2:DC 3-10:SV 11-18:Sensor "		partsID _ 16r12.			" 01:DC 02:SV 03:LED 04:BZR 05:CLED 10:LS 11:TS 12:SS 13:IRS 14:3S 15:BTN"		defaultArgs at: 1 put: ''.		1 to: 8 do: [ :index |			(((IOPort at: (index+offset)) = partsID) & (isDetect = false)) ifTrue: [				defaultArgs at: 1 put: ('A', (index-1) asString).				isDetect _ true.			]		].	].	(#refPhotosensor: = sel) ifTrue: [		isDetect _ false.			" detect buzzer? "		offset _ 10.				" 1-2:DC 3-10:SV 11-18:Sensor "		partsID _ 16r13.			" 01:DC 02:SV 03:LED 04:BZR 05:CLED 10:LS 11:TS 12:SS 13:IRS 14:3S 15:BTN"		defaultArgs at: 1 put: ''.		1 to: 8 do: [ :index |			(((IOPort at: (index+offset)) = partsID) & (isDetect = false)) ifTrue: [				defaultArgs at: 1 put: ('A', (index-1) asString).				isDetect _ true.			]		].	].	(#accelerometer: = sel) ifTrue: [		isDetect _ false.			" detect buzzer? "		offset _ 10.				" 1-2:DC 3-10:SV 11-18:Sensor "		partsID _ 16r14.			" 01:DC 02:SV 03:LED 04:BZR 05:CLED 10:LS 11:TS 12:SS 13:IRS 14:3S 15:BTN"		defaultArgs at: 1 put: ''.		1 to: 8 do: [ :index |			(((IOPort at: (index+offset)) = partsID) & (isDetect = false)) ifTrue: [				defaultArgs at: 1 put: 'X'.				isDetect _ true.			]		].	].	(#onBoardButton: = sel) ifTrue: [		isDetect _ false.			" detect buzzer? "		offset _ 10.				" 1-2:DC 3-10:SV 11-18:Sensor "		partsID _ 16r15.			" 01:DC 02:SV 03:LED 04:BZR 05:CLED 10:LS 11:TS 12:SS 13:IRS 14:3S 15:BTN"		defaultArgs at: 1 put: ''.		1 to: 4 do: [ :index |			(((IOPort at: (index+offset)) = partsID) & (isDetect = false)) ifTrue: [				defaultArgs at: 1 put: ('A', (index-1) asString).				isDetect _ true.			]		].	].	(#boardLED:onOff: = sel) ifTrue: [		isDetect _ false.			" detect buzzer? "		partsID _ 16r05.			" 01:DC 02:SV 03:LED 04:BZR 05:CLED 10:LS 11:TS 12:SS 13:IRS 14:3S 15:BTN"Transcript show: (IOPort at: 3); cr.		defaultArgs at: 1 put: ''.		((IOPort at: 3) = partsID) & (isDetect not) ifTrue: [			defaultArgs at: 1 put: 'Red(D5)'.			isDetect _ true].		((IOPort at: 4) = partsID) & (isDetect not) ifTrue: [			defaultArgs at: 1 put: 'Yellow(D6)'.			isDetect _ true].		((IOPort at: 5) = partsID) & (isDetect not) ifTrue: [			defaultArgs at: 1 put: 'Green(D9)'.			isDetect _ true].	].	^ defaultArgs! !!ScriptableScratchMorph methodsFor: 'motor ops' stamp: 'KK 11/20/2013 18:31'!motorNo:n dcMotorOff:s"Set On/Off the DC motor selected"| stage sb mid ival |"Check argument."n = '' ifTrue: [^0].(stage := self ownerThatIsA: ScratchStageMorph) ifNil: [^0].sb _ stage sensorBoard."sb tryToOpenPort ifFalse:[^0]."mid _ 0.		" 0: DC Motor ID "(n = 'M1') ifTrue: [ ival _ 16r0200. ].		"b0000 0010 0000 0000"(n = 'M2') ifTrue: [ ival _ 16r0A00. ].	"b0000 1010 0000 0000"(s = 'Brake') ifTrue: [ ival _ ival + 0. ].		" b0000 n010 0000 0000"(s = 'Coast') ifTrue: [ ival _ ival + 1. ].		" b0000 n010 0000 0001 "^sb data:ival msgID:mid.! !!ScriptableScratchMorph methodsFor: 'motor ops' stamp: 'KK 11/20/2013 18:30'!motorNo:n dcMotorOn:s"Set On/Off the DC motor selected"| stage sb mid ival |"Check argument."n = '' ifTrue: [^0].(stage := self ownerThatIsA: ScratchStageMorph) ifNil: [^0].sb _ stage sensorBoard."sb tryToOpenPort ifFalse:[^0]."mid _ 0.		" 0: DC Motor ID "(n = 'M1') ifTrue: [ ival _ 16r0100. ].		" b0000 0001 0000 0000 "(n = 'M2') ifTrue: [ ival _ 16r0900. ].		" b0000 1001 0000 0000 "(s = 'cw.') ifTrue: [ ival _ ival + 0. ].	" b0000 n001 0000 0000 "(s = 'ccw.') ifTrue: [ ival _ ival + 1. ].	" b0000 n001 0000 0001 "^sb data:ival msgID:mid.! !!ScriptableScratchMorph methodsFor: 'motor ops' stamp: 'sk 7/7/2016 19:37'!motorNo:n degree:d"Set degree the servo motor selected"| stage sb mid ival pin offset index svPort |" Check argument. "n = '' ifTrue: [^0].(stage := self ownerThatIsA: ScratchStageMorph) ifNil: [^0].sb _ stage sensorBoard."sb tryToOpenPort ifFalse:[^0]."offset _ 0.mid _ 1.		" 1 : Servo Motor ID"index _ 1.	(BoardType = 0 or: [BoardType = 2]) ifTrue: [(n = 'D2') ifTrue: [	pin _ 16r0000.			"b0000 0000 0000 0000"	offset _ SvCalib at:(5).	" Servomotor offset"	index _ 1.].(n = 'D4') ifTrue: [	pin _ 16r0200.			"b0000 0010 0000 0000"	offset _ SvCalib at:(6).	" Servomotor offset"	index _ 2.].(n = 'D7') ifTrue: [	pin _ 16r0400.			"b0000 0100 0000 0000"	offset _ SvCalib at:(7).	" Servomotor offset"	index _ 3.].(n = 'D8') ifTrue: [	pin _ 16r0600.			"b0000 0110 0000 0000"	offset _ SvCalib at:(8).	" Servomotor offset"	index _ 4.].(n = 'D9') ifTrue: [	pin _ 16r0800.			"b0000 1000 0000 0000"	offset _ SvCalib at:(1).	" Servomotor offset"	index _ 5.	(SvSentAlready at:index) ifTrue: [	] ifFalse: [		SvSentAlready at:index put:true.	].].(n = 'D10') ifTrue: [	pin _ 16r0A00.			"b0000 1010 0000 0000"	offset _ SvCalib at:(2).	" Servomotor offset"	index _ 6.].(n = 'D11') ifTrue: [	pin _ 16r0C00.			"b0000 1100 0000 0000"	offset _ SvCalib at:(3).	" Servomotor offset"	index _ 7.].(n = 'D12') ifTrue: [	pin _ 16r0E00.			"b0000 1110 0000 0000"	offset _ SvCalib at:(4).	" Servomotor offset"	index _ 8.]." Convert unsigned to singed "(offset > 127) ifTrue: [	offset _ offset - 256.].ival _ d asNumber.ival _ ival + offset.	" Calibration "(ival >= 180)  ifTrue: [ ival _ 180. ].(ival <= 0)	 ifTrue: [ ival _ 0.   ].ServomotorSynchroMotion ifTrue: [ SvDegreeTemp at:index put:ival. ]ifFalse: [	SvDegreeTemp at:index put:ival. 	SvDegree at:index put:ival.].ival _ pin + ival rounded.	]	ifFalse: [		svPort _ #(D5 D6 D9 D10 D11).		index _ svPort asOrderedCollection find: n.		ival _ ((index - 1) bitShift: 9) + d.].^sb data:ival msgID:mid.! !!ScriptableScratchMorph methodsFor: 'motor ops' stamp: 'KK 8/29/2013 12:35'!motorNo:n onOff:s"Set On/Off the DC motor selected"| stage sb mid ival |(stage := self ownerThatIsA: ScratchStageMorph) ifNil: [^0].sb _ stage sensorBoard."sb tryToOpenPort ifFalse:[^0]."(n = 'M1') ifTrue: [ mid _ 0. ].(n = 'M2') ifTrue: [ mid _ 1. ].(s = 'on') ifTrue: [ ival _ 1. ].(s = 'off') ifTrue: [ ival _ 0. ].^sb data:ival msgID:mid.! !!ScriptableScratchMorph methodsFor: 'motor ops' stamp: 'KK 4/21/2015 15:08'!motorNo:n power: p"Set Power the DC motor selected"| stage sb mid ival tmp ratio |"Check argument."n = '' ifTrue: [^0].(stage := self ownerThatIsA: ScratchStageMorph) ifNil: [^0].sb _ stage sensorBoard."sb tryToOpenPort ifFalse:[^0]."mid _ 0.		" 0: DC Motor ID "(n = 'M1') ifTrue: [	ratio _ (DCCalib at:1) / 100.0.	tmp _ 16r0400.		"b0000 0100 0000 0000"].(n = 'M2') ifTrue: [	ratio _ (DCCalib at:2) / 100.0.	tmp _ 16r0C00.		"b0000 1100 0000 0000"].ival _ (p asNumber) * ratio.(ival >= 100)  ifTrue: [ ival _ 100. ].(ival <= 0)	 ifTrue: [ ival _ 0.   ].ival _ tmp + (ival rounded).				"b0000 n100 + val "^sb data:ival msgID:mid.! !!ScriptableScratchMorph methodsFor: 'motor ops' stamp: 'KK 4/24/2014 15:48'!setServoSpeed:s d2:dg2 d4:dg4 d7:dg7 d8:dg8 d9:dg9 d10:dg10 d11:dg11 d12:dg12	"Set degree the servo motor selected"	| stage sb id pin offset ival d mid |Transcript show:'ScriptableScratchMorph::setServoSpeed:d2:d4:d7:d8:d9:d10:d11:d12';cr.	(stage := self ownerThatIsA: ScratchStageMorph) ifNil: [^0].	sb _ stage sensorBoard.	" Set degrees "	mid _ 5.		" Multi servomotors start!! "	ival _ s.	" Set speed "	sb data:ival msgID:mid.	mid _ 1.		" Set servomotor's degree "	3 to: 10 do: [ :index | 		id _ IOPort at:index.	" Get port ID "		id = 2 ifTrue: [			(index = 3) ifTrue: [	" D2 "				pin _ 16r0000.			"b0000 0000 0000 0000"				offset _ SvCalib at:(5).	" Servomotor offset"				d _ dg2.			].			(index = 4) ifTrue: [	" D4 "				pin _ 16r0200.			"b0000 0010 0000 0000"				offset _ SvCalib at:(6).	" Servomotor offset"				d _ dg4.			].			(index = 5) ifTrue: [	" D7 "				pin _ 16r0400.			"b0000 0100 0000 0000"				offset _ SvCalib at:(7).	" Servomotor offset"				d _ dg7.			].			(index = 6) ifTrue: [	" D8 "				pin _ 16r0600.			"b0000 0110 0000 0000"				offset _ SvCalib at:(8).	" Servomotor offset"				d _ dg8.			].			(index = 7) ifTrue: [	" D9 "				pin _ 16r0800.			"b0000 1000 0000 0000"				offset _ SvCalib at:(1).	" Servomotor offset"				d _ dg9.			].			(index = 8) ifTrue: [	" D10 "				pin _ 16r0A00.			"b0000 1010 0000 0000"				offset _ SvCalib at:(2).	" Servomotor offset"				d _ dg10.			].			(index = 9) ifTrue: [	" D11 "				pin _ 16r0C00.			"b0000 1100 0000 0000"				offset _ SvCalib at:(3).	" Servomotor offset"				d _ dg11.			].			(index = 10) ifTrue: [" D12 "				pin _ 16r0E00.			"b0000 1110 0000 0000"				offset _ SvCalib at:(4).	" Servomotor offset"				d _ dg12.			].			" Convert unsigned to singed "			(offset > 127) ifTrue: [				offset _ offset - 256.			].			ival _ d asNumber.			ival _ ival + offset.	" Calibration "			(ival >= 180)  ifTrue: [ ival _ 180. ].			(ival <= 0)	 ifTrue: [ ival _ 0.   ].			ival _ pin + ival rounded.			"Transcript show:'ScriptableScratchMorph:: motorNo:degree:'; show: ival;cr."			sb data:ival msgID:mid.		].	].	mid _ 5.			" Multi servomotors Finish!! "	ival _ 16r0040.	"b0000 0000 0100 0000"	sb data:ival msgID:mid.	(Delay forMilliseconds: 3000 ) wait.! !!ScriptableScratchMorph methodsFor: 'other ops' stamp: 'sk 4/14/2016 15:42'!alhour:h almin:m	| stage sb data |	(stage := self ownerThatIsA: ScratchStageMorph) ifNil: [^0].	sb _ stage sensorBoard.	data _ (16r2000) + (m bitShift: 5) + h.   "subID1: 2"Transcript show: data; cr.	^sb clockDataSend: data subID: 1.! !!ScriptableScratchMorph methodsFor: 'other ops' stamp: 'sk 3/7/2016 18:24'!boardLED:n onOff:s"Set On/Off the LED selected"| stage sb mid ival |"Check argument."n = '' ifTrue: [^0].(stage := self ownerThatIsA: ScratchStageMorph) ifNil: [^0].sb _ stage sensorBoard."sb tryToOpenPort ifFalse:[^0]."mid _ 3.		" 3: LED ID "Transcript show:' board LED'; cr.(n = 'Red(D5)') ifTrue: [ ival _ 16r0040. ].		" b0000 0000 0000 0000 "(n = 'Yellow(D6)') ifTrue: [ ival _ 16r0240. ].		" b0000 0010 0000 0000 "(n = 'Green(D9)') ifTrue: [ ival _ 16r0440. ].		" b0000 0100 0000 0000 "(s = 'off') ifTrue: [ ival _ ival + 16r0000. ].	" b0000 xxx0 0000 0000 "(s = 'on') ifTrue: [ ival _ ival + 16r0100. ].	" b0000 xxx1 0000 0000 "^sb data:ival msgID:mid.! !!ScriptableScratchMorph methodsFor: 'other ops' stamp: 'KK 11/20/2013 18:34'!buzzerPin:n"Set Off the buzzer selected"| stage sb mid ival |"Check argument."n = '' ifTrue: [^0].(stage := self ownerThatIsA: ScratchStageMorph) ifNil: [^0].sb _ stage sensorBoard."sb tryToOpenPort ifFalse:[^0]."mid _ 2.		" 2: Buzzer ID "" set port and buzzer ON "(n = 'A0') ifTrue: [ ival _ 16r0000. ].		" b0000 0000 0000 0000 "(n = 'A1') ifTrue: [ ival _ 16r0200. ].		" b0000 0010 0000 0000 "(n = 'A2') ifTrue: [ ival _ 16r0400. ].		" b0000 0100 0000 0000 "(n = 'A3') ifTrue: [ ival _ 16r0600. ].		" b0000 0110 0000 0000 "(n = 'A4') ifTrue: [ ival _ 16r0800. ].		" b0000 1000 0000 0000 "(n = 'A5') ifTrue: [ ival _ 16r0A00. ].		" b0000 1010 0000 0000 "^sb data:ival msgID:mid.! !!ScriptableScratchMorph methodsFor: 'other ops' stamp: 'KK 11/20/2013 18:32'!buzzerPin:n freq:s"Set frequency the buzzer selected"| stage sb mid ival tmp |"Check argument."n = '' ifTrue: [^0].(stage := self ownerThatIsA: ScratchStageMorph) ifNil: [^0].sb _ stage sensorBoard."sb tryToOpenPort ifFalse:[^0]."mid _ 2.		" 2: Buzzer ID "" set port and buzzer ON "(n = 'A0') ifTrue: [ ival _ 16r0100. ].		" b0000 0001 0000 0000 "(n = 'A1') ifTrue: [ ival _ 16r0300. ].		" b0000 0011 0000 0000 "(n = 'A2') ifTrue: [ ival _ 16r0500. ].		" b0000 0101 0000 0000 "(n = 'A3') ifTrue: [ ival _ 16r0700. ].		" b0000 0111 0000 0000 "(n = 'A4') ifTrue: [ ival _ 16r0900. ].		" b0000 1001 0000 0000 "(n = 'A5') ifTrue: [ ival _ 16r0B00. ].		" b0000 1011 0000 0000 "tmp _ s asNumber.(tmp < 48) ifTrue: [ tmp _ 48. ].(tmp > 108) ifTrue: [ tmp _ 108. ].ival _ ival + tmp."Transcript show:'ScriptableScratchMorph:: buzzerPin:freq:'; show: ival;cr."^sb data:ival msgID:mid.! !!ScriptableScratchMorph methodsFor: 'other ops' stamp: 'sk 4/25/2016 12:42'!clkBackLight: onoff	| stage sb data |	(stage := self ownerThatIsA: ScratchStageMorph) ifNil: [^0].	sb _ stage sensorBoard.	(onoff = 'on') ifTrue: [data _ 1]	ifFalse: [data _ 0]."	data _ 0.""	data _ (rVal bitShift: 12) + (gVal bitShift: 8) + (16r80) + bVal.""Transcript show: data; cr."	^sb clockOnOff: data.! !!ScriptableScratchMorph methodsFor: 'other ops' stamp: 'sk 4/15/2016 20:03'!clkBackLightOff	| stage sb data |	(stage := self ownerThatIsA: ScratchStageMorph) ifNil: [^0].	sb _ stage sensorBoard.	data _ 0."	data _ (rVal bitShift: 12) + (gVal bitShift: 8) + (16r80) + bVal."Transcript show: data; cr.	^sb clockDataSend: data subID: 1.! !!ScriptableScratchMorph methodsFor: 'other ops' stamp: 'sk 2/22/2016 10:07'!clkBuzzerOFF! !!ScriptableScratchMorph methodsFor: 'other ops' stamp: 'sk 4/11/2016 22:18'!clkBuzzerOff| mid ival sb stage |(stage := self ownerThatIsA: ScratchStageMorph) ifNil: [^0].sb _ stage sensorBoard.mid _ 2.		" 2: Buzzer ID "" set port and buzzer ON "ival _ 16r0040.	" b0000 0000 0100 0000 "^sb data:ival msgID:mid.! !!ScriptableScratchMorph methodsFor: 'other ops' stamp: 'sk 4/11/2016 22:20'!clkBuzzerOnFreq: frequency| stage sb mid ival tmp |"Check argument.""n = '' ifTrue: [^0]."(stage := self ownerThatIsA: ScratchStageMorph) ifNil: [^0].sb _ stage sensorBoard."sb tryToOpenPort ifFalse:[^0]."mid _ 2.		" 2: Buzzer ID "" set port and buzzer ON "ival _ 16r0100.	" b0000 0001 0000 0000 "tmp _ frequency asNumber.tmp _ tmp - 48.(tmp > 47) & (tmp < 109) ifTrue: [ tmp _ 0. ].ival _ ival + tmp."Transcript show:'ScriptableScratchMorph:: buzzerPin:freq:'; show: ival;cr."^sb data:ival msgID:mid.! !!ScriptableScratchMorph methodsFor: 'other ops' stamp: 'sk 4/25/2016 18:27'!clkBuzzerOnFreq: frequency For: duration elapsed: elapsed from: ignored| stage sb |"Check argument.""n = '' ifTrue: [^0]."(stage := self ownerThatIsA: ScratchStageMorph) ifNil: [^0].sb _ stage sensorBoard.^sb clockBuzzer: frequency For: duration! !!ScriptableScratchMorph methodsFor: 'other ops' stamp: 'sk 3/11/2016 21:29'!doSvmSyncMotion: delay"Set Off the buzzer selected"	| mid ival sb stage temp|	(stage := self ownerThatIsA: ScratchStageMorph) ifNil: [^0].	sb _ stage sensorBoard.	delay >= 0.0		ifTrue: [temp _ (delay + 0.5) truncated]		ifFalse: [temp _ (delay - 0.5) truncated].	(ServomotorSynchroMotion) ifTrue: [		(temp < 0) ifTrue: [			" Servomotors' synchro motion end. "			mid _ 5.			" Multi servomotors Finish!! "			ival _ 16r0040.	"b0000 0000 0100 0000"			sb data:ival msgID:mid.			ServomotorSynchroMotion _ false.		].	] ifFalse: [		" floor "		(temp < 0) ifTrue: [			temp _ 0.		].		" ceil "		(temp > 20) ifTrue: [			temp _ 20.		].		" Servomotors' synchro motion start. "		mid _ 5.			" Multi servomotors start!! "		ival _ temp + 3.	" Set speed "		sb data:ival msgID:mid.		ServomotorSynchroMotion _ true.		DelayMsecPerDeg _ temp + 3."		1 to: 8 do: [:index |			SvSentAlready at: index put: false.		].	"	].! !!ScriptableScratchMorph methodsFor: 'other ops' stamp: 'sk 4/14/2016 15:06'!hour:h min:m	| stage sb data |	(stage := self ownerThatIsA: ScratchStageMorph) ifNil: [^0].	sb _ stage sensorBoard.	data _ (16r1000) + (m bitShift: 5) + h.Transcript show: data; cr.	^sb clockDataSend: data subID: 1.! !!ScriptableScratchMorph methodsFor: 'other ops' stamp: 'KK 9/11/2013 12:52'!ledColor:n onOff:s"Set On/Off the LED selected"| stage sb mid ival p |(stage := self ownerThatIsA: ScratchStageMorph) ifNil: [^0].sb _ stage sensorBoard."sb tryToOpenPort ifFalse:[^0]."mid _ 5.		" 5: Color LED ID "(n = 'White') ifTrue: [ ival _ 16r0000. ].		" b0000 0000 0000 0000 "(n = 'Red') ifTrue: [ ival _ 16r0200. ].		" b0000 0010 0000 0000 "(n = 'Green') ifTrue: [ ival _ 16r0400. ].		" b0000 0100 0000 0000 "(n = 'Blue') ifTrue: [ ival _ 16r0600. ].		" b0000 0110 0000 0000 "(n = 'Cyan') ifTrue: [ ival _ 16r0800. ].		" b0000 1000 0000 0000 "(n = 'Magenta') ifTrue: [ ival _ 16r0A00. ].	" b0000 1010 0000 0000 "(n = 'Yellow') ifTrue: [ ival _ 16r0C00. ].		" b0000 1100 0000 0000 "(s = 'off') ifTrue: [ ival _ ival + 16r0000. ].	" b0000 xxx0 0000 0000 "(s = 'on') ifTrue: [ ival _ ival + 16r0100. ].	" b0000 xxx1 0000 0000 "" check connected port. "p _ IOPort at:11.(p = 5) ifTrue: [ " A0, A1, A2 ""Transcript show:'A0 : '; show: ival; cr."	^sb data:ival msgID:mid.] ifFalse: [	p _ IOPort at: 14.	(p = 5) ifTrue: [ " A1, A2, A3 "		ival _ ival + 16r0001."Transcript show:'A1 : '; show: ival; cr."		^sb data:ival msgID:mid.	]]! !!ScriptableScratchMorph methodsFor: 'other ops' stamp: 'sk 4/15/2016 19:55'!ledPin:n onOff:s"Set On/Off the LED selected"| stage sb mid ival |"Check argument."n = '' ifTrue: [^0].(stage := self ownerThatIsA: ScratchStageMorph) ifNil: [^0].sb _ stage sensorBoard."sb tryToOpenPort ifFalse:[^0]."mid _ 3.		" 3: LED ID "(n = 'A0') ifTrue: [ ival _ 16r0000. ].		" b0000 0000 0000 0000 "(n = 'A1') ifTrue: [ ival _ 16r0200. ].		" b0000 0010 0000 0000 "(n = 'A2') ifTrue: [ ival _ 16r0400. ].		" b0000 0100 0000 0000 "(n = 'A3') ifTrue: [ ival _ 16r0600. ].		" b0000 0110 0000 0000 "(n = 'A4') ifTrue: [ ival _ 16r0800. ].		" b0000 1000 0000 0000 "(n = 'A5') ifTrue: [ ival _ 16r0A00. ].		" b0000 1010 0000 0000 "(s = 'off') ifTrue: [ ival _ ival + 16r0000. ].	" b0000 xxx0 0000 0000 "(s = 'on') ifTrue: [ ival _ ival + 16r0100. ].	" b0000 xxx1 0000 0000 "^sb data:ival msgID:mid.! !!ScriptableScratchMorph methodsFor: 'other ops' stamp: 'KK 9/28/2013 13:54'!mathFunctionNames	"Answer a collection of math function names."	^ #(		'abs'		'sqrt'		'sin'		'cos'		'tan'"		'asin'		'acos'		'atan'"		'ln'		'log'		'e ^'		'10 ^')! !!ScriptableScratchMorph methodsFor: 'other ops' stamp: 'sk 4/15/2016 19:52'!month:m day:d year:y	| stage sb data |	(stage := self ownerThatIsA: ScratchStageMorph) ifNil: [^0].	sb _ stage sensorBoard.	data _ (m bitShift: 12) + ((y - 2000) bitShift: 5)  + d.Transcript show: data; cr.	^sb clockDataSend: data subID: 0.! !!ScriptableScratchMorph methodsFor: 'other ops' stamp: 'KK 8/29/2013 12:36'!pinNo:n onOff:s"Set On/Off the LED selected"| stage sb mid ival |(stage := self ownerThatIsA: ScratchStageMorph) ifNil: [^0].sb _ stage sensorBoard."sb tryToOpenPort ifFalse:[^0]."self halt.mid _ 3.		" 3: LED ID "(n = 'A0') ifTrue: [ ival _ 16r0000. ].		" b0000 0000 0000 0000 "(n = 'A1') ifTrue: [ ival _ 16r0200. ].		" b0000 0010 0000 0000 "(n = 'A2') ifTrue: [ ival _ 16r0400. ].		" b0000 0100 0000 0000 "(n = 'A3') ifTrue: [ ival _ 16r0600. ].		" b0000 0110 0000 0000 "(n = 'A4') ifTrue: [ ival _ 16r0800. ].		" b0000 1000 0000 0000 "(n = 'A5') ifTrue: [ ival _ 16r0A00. ].		" b0000 1010 0000 0000 "(s = 'off.') ifTrue: [ ival _ ival + 16r0000. ].	" b0000 xxx0 0000 0000 "(s = 'on.') ifTrue: [ ival _ ival + 16r0100. ].	" b0000 xxx1 0000 0000 "^sb data:ival msgID:mid.! !!ScriptableScratchMorph methodsFor: 'other ops' stamp: 'sk 4/25/2016 12:37'!red: rVal green: gVal blue: bVal	| stage sb |	(stage := self ownerThatIsA: ScratchStageMorph) ifNil: [^0].	sb _ stage sensorBoard."	data _ (16r8000) + (gVal bitShift: 8) + (rVal bitShift: 4)  + bVal.""	data _ (rVal bitShift: 12) + (gVal bitShift: 8) + (16r80) + bVal.""Transcript show: data; cr.""	^sb clockDataSend: data subID: 1."	^sb clockR: rVal G: gVal B: bVal.! !!ScriptableScratchMorph methodsFor: 'other ops' stamp: 'KK 4/30/2014 17:45'!wait: duration elapsed: elapsed from: ignored	"Do nothing; just wait for the time interval to elapse."	^ nil! !!ScriptableScratchMorph methodsFor: 'other ops' stamp: 'sk 2/18/2016 11:50'!year:y month:m day:d! !!ScriptableScratchMorph methodsFor: 'variables' stamp: 'KK 9/1/2014 11:58'!addGlobalVariable	"Ask the user for a variable name, then add a background (global) variable of that name."	| sFrame varName |	(sFrame _ self ownerThatIsA: ScratchFrameMorph) ifNil: [^ self beep].	ValueOrList _ true.	varName _ StringDialog ask: 'Variable name?(Only alphanumeric characters are allowed)'.	varName size = 0 ifTrue: [^ self].	varName _ varName asUTF8.	(sFrame workPane variableNameInUse: varName) ifTrue: [		self beep.		DialogBoxMorph warn: 'That variable name is already in use'.		^ self].	sFrame workPane addVariable: varName.	sFrame viewerPane categoryChanged: 'variables'.	self addWatcherForNewVariable: varName withScope: sFrame workPane.! !!ScriptableScratchMorph methodsFor: 'variables' stamp: 'KK 9/18/2013 19:17'!addVariable: varName	"Add a new user variable with the given name to this object. Do nothing if the variable already exists or is built in."	(vars includesKey: varName asString) ifFalse: [		vars at: varName asString put: 0].	self isClone: false.! !!ScriptableScratchMorph methodsFor: 'scripts' stamp: 'KK 12/10/2014 13:22'!addStack: aBlockStack	"Aligns the newly added script below the lowest script in the pane."	| y bottom |	y _ 10.	blocksBin submorphsDo: [:m |		bottom _  (m fullBounds bottom) - (blocksBin position y).		(bottom > y) ifTrue: 			[y _ bottom]].	aBlockStack position: blocksBin position + (20@(y+10)).	aBlockStack newScriptOwner: self.	blocksBin addMorph: aBlockStack.! !!ScriptableScratchMorph methodsFor: 'blocks' stamp: 'KK 9/18/2013 19:30'!addGenericVariableBlocksTo: page x: x y: startY	"Add the generic variable blocks to the given page starting at the given y offset. Answer the new y."	| y vName stage block varBlocks |	y _ startY.	"pick a default variable name"	vName _ nil.	stage _ self ownerThatIsA: ScratchStageMorph.	(stage notNil and: [stage varNames size > 0])		ifTrue: [			vName _ stage varNames first]		ifFalse: [			self varNames size = 0 ifTrue: [^ y].			vName _ self varNames first].	varBlocks _ OrderedCollection new.	block _ SetterBlockMorph new		initSetterForVar: vName;		receiver: self blockReceiver.	block expressionArg numExpression: '0'.	varBlocks add: block.	block _ SetterBlockMorph new		initChangerForVar: vName;		receiver: self blockReceiver.	block expressionArg numExpression: '1'.	varBlocks add: block.	(self blocksFor: 'variables') do: [:b |		b defaultArgs: (Array with: vName).		varBlocks add: b].	varBlocks do: [:b |		b color: self variableBlockColor.		page addMorph: (b position: x@y).		y _ b bottom + 3].	^ y! !!ScriptableScratchMorph methodsFor: 'blocks' stamp: 'KK 8/30/2013 20:15'!blockCategories	"Answer a list of block categories."	^ (self class blockSpecs select: [:el |		(el isKindOf: String) and: [el ~= '-' and: [el ~= '~']]]) asArray! !!ScriptableScratchMorph methodsFor: 'blocks' stamp: 'sk 4/27/2016 21:20'!blockFromSpec: spec color: blockColor	"Create a block from the given block specification. Answer nil if I don't implement the block spec selector."	| blockLabelSpec blockType selector defaultArgs block rcvr argPermutation dispBlockColor isDetect offset partsID invalidR invalidG invalidB |	invalidR _ 0.6.	invalidG _ 0.6.	invalidB _ 0.6.	blockLabelSpec _ ScratchTranslator translationFor: (spec at: 1).	argPermutation _ CommandBlockMorph argPermutationForSpec: (spec at: 1) withTranslation: blockLabelSpec.	blockType _ spec at: 2.	selector _ (spec at: 3) asSymbol.	defaultArgs _ self defaultArgsFor: spec.	dispBlockColor _ blockColor.	((defaultArgs size ~= 0) & (#doBroadcastAndWait ~= selector)) ifTrue: [		((defaultArgs at: 1) = '') ifTrue: [			dispBlockColor _ (Color r: invalidR g: invalidG b: invalidB).		]	].	(BoardType = 1) ifTrue: [	" Clock's validity check. "	((IOPort at: 19) ~= 6) ifTrue: [		(#hour:min: = selector) ifTrue: [			dispBlockColor _ (Color r: invalidR g: invalidG b: invalidB).].		(#month:day:year: = selector) ifTrue: [			dispBlockColor _ (Color r: invalidR g: invalidG b: invalidB).].		(#alhour:almin: = selector) ifTrue: [			dispBlockColor _ (Color r: invalidR g: invalidG b: invalidB).].		(#red:green:blue: = selector) ifTrue: [			dispBlockColor _ (Color r: invalidR g: invalidG b: invalidB).].		(#clkBackLight: = selector) ifTrue: [			dispBlockColor _ (Color r: invalidR g: invalidG b: invalidB).].		(#clkBuzzerOnFreq:For:elapsed:from: = selector) ifTrue: [			dispBlockColor _ (Color r: invalidR g: invalidG b: invalidB).].		(#clkBuzzerOff = selector) ifTrue: [			dispBlockColor _ (Color r: invalidR g: invalidG b: invalidB).].		(#clockValue: = selector) ifTrue: [			dispBlockColor _ (Color r: invalidR g: invalidG b: invalidB).].		(#isInAlarm = selector) ifTrue: [			dispBlockColor _ (Color r: invalidR g: invalidG b: invalidB).].].].	" Color LED is used ? "	(#ledColor:onOff: = selector) ifTrue: [		isDetect _ false.			" detect buzzer? "		offset _ 10.				" 1-2:DC 3-10:SV 11-18:Sensor "		partsID _ 16r05.			" 01:DC 02:SV 03:LED 04:BZR 05:CLED 10:LS 11:TS 12:SS 13:IRS 14:3S 15:BTN"		1 to: 4 do: [ :index |			(((IOPort at: (index+offset)) = partsID) & (isDetect = false)) ifTrue: [				isDetect _ true.			]		].		isDetect = false ifTrue: [			dispBlockColor _ (Color r: invalidR g: invalidG b: invalidB).		].	].	(#(E K M S W) includes: blockType) ifTrue: [		^ (self hatBlockType: blockType) color: blockColor].	"basic block type: normal or C-shaped"	(blockType includes: $c)		ifTrue:	[			selector = #doIfElse				ifTrue: [block _ IfElseBlockMorph new isSpecialForm: true]				ifFalse: [block _ CBlockMorph new isSpecialForm: true]]		ifFalse:	[			(blockType includes: $r) | (blockType includes: $b)				ifTrue: [block _ ReporterBlockMorph new]				ifFalse: [block _ CommandBlockMorph new]].	(blockType includes: $b) ifTrue: [block isBoolean: true].	(blockType includes: $s) ifTrue: [block isSpecialForm: true].	(blockType includes: $t) ifTrue: [block isTimed: true].	(ScriptableScratchMorph isSpriteSpecificTarget: self selector: selector)		ifTrue: [rcvr _ self]		ifFalse: [rcvr _ self ownerThatIsA: ScratchStageMorph].	^ block		argPermutation: argPermutation;"		color: blockColor;"		color: dispBlockColor;		selector: selector;		commandSpec: blockLabelSpec;		defaultArgs: defaultArgs;		receiver: rcvr! !!ScriptableScratchMorph methodsFor: 'blocks' stamp: 'KK 9/18/2013 19:01'!blockFromTuple: tuple receiver: scriptOwner	"Answer a new block for the given tuple."	| k spec blockColor block argCount arg argBlock |"Transcript show:'[ScriptableScratchMorph::blockFromTuple:receiver:]';cr."	k _ tuple first.	(#(readVariable changeVariable) includes: k) ifTrue: [		^ self variableBlockFromTuple: tuple receiver: scriptOwner].	#contentsOfList: = k ifTrue: [		^ ListContentsBlockMorph new			color: ScriptableScratchMorph listBlockColor;			receiver: scriptOwner;			commandSpec: tuple second;			selector: #contentsOfList:].	(#(EventHatMorph KeyEventHatMorph MouseClickEventHatMorph WhenHatBlockMorph) includes: k) ifTrue: [		block _ self hatBlockFromTuple: tuple receiver: scriptOwner.		(block isKindOf: WhenHatBlockMorph) ifTrue: [block color: Color red].		^ block].	#scratchComment = k ifTrue: [		block _ ScratchCommentMorph new.		tuple size > 1 ifTrue: [block commentMorph contents: (tuple at: 2)].		tuple size > 2 ifTrue: [(tuple at: 3) ifFalse: [block toggleShowing]].		tuple size > 3 ifTrue: [block width: (tuple at: 4)].		tuple size > 4 ifTrue: [block anchor: (self blockWithID: (tuple at: 5))].		^ block].	#comment: = k ifTrue: [		block _ CommentBlockMorph new.		tuple size > 1 ifTrue: [block comment: (tuple at: 2)].		tuple size > 2 ifTrue: [(tuple at: 3) ifFalse: [block toggleShowing]].		block color: (Color r: 0.8 g: 0 b: 0).  "obsolete"		^ block]."Transcript show:'[ScriptableScratchMorph::blockFromTuple:receiver:]';cr.Transcript show:BlockSpecDict;cr."	spec _ BlockSpecDict at: k ifAbsent: [nil].	spec ifNil: ["Transcript show:'[ScriptableScratchMorph::blockFromTuple:receiver:] spec ifNill';cr."		^ scriptOwner			blockFromSpec: #('obsolete!!' - yourself)			color: Color red].	blockColor _ BlockColorDict at: k ifAbsent: [Color red].	block _ scriptOwner blockFromSpec: spec color: blockColor.	(block isKindOf: CommandBlockMorph) ifTrue: [		argCount _ block argumentCount min: tuple size - 1.		1 to: argCount do: [:i |			((#(+ - / * =) includes: block selector) and: [ScratchTranslator isRTLMath]) "RTLMath operators are RTL"				ifTrue: [arg _ tuple at: ((argCount + 1) - (i - 1))]				ifFalse: [arg _ tuple at: i + 1].			(arg isKindOf: Array)				ifTrue: [  "argument is a block"					((arg size = 1) and: [arg first isKindOf: Array]) ifTrue: [arg _ arg first].					argBlock _ self blockFromTuple: arg receiver: scriptOwner.					block replaceArgMorph: (block argumentAt: i) by: argBlock]				ifFalse: [  "argument is a value"					(block argumentAt: i) defaultValue: arg]].		(block isKindOf: CBlockMorph) ifTrue: [			(tuple last isKindOf: Array) ifTrue: [				block firstBlockList: (self stackFromTupleList: tuple last receiver: scriptOwner)]].		(block isKindOf: IfElseBlockMorph) ifTrue: [			arg _ tuple at: tuple size - 1.			(arg isKindOf: Array) ifTrue: [				block trueBlock: (self stackFromTupleList: arg receiver: scriptOwner)].			arg _ tuple at: tuple size.			(arg isKindOf: Array) ifTrue: [				block falseBlock: (self stackFromTupleList: arg receiver: scriptOwner)]].		(block isKindOf: ReporterBlockMorph) ifTrue: ["Transcript show:'[ScriptableScratchMorph::blockFromTuple:receiver:] ReporterBlockMorph';cr.Transcript show:'[ScriptableScratchMorph::blockFromTuple:receiver:] '; show: spec;cr."			((spec at: 2) includes: $b) ifTrue: [block isBoolean: true]]].	^ block! !!ScriptableScratchMorph methodsFor: 'blocks' stamp: 'KK 8/28/2013 20:30'!blockSpecForSelector: aSymbol	"Answer a block specification string (in English) for the give selector or nil if there is no spec that has the given selector."	self class blockSpecs do: [:spec |		((spec isKindOf: Array) and: [(spec at: 3) = aSymbol])			ifTrue: [^ spec first]].	^ nil! !!ScriptableScratchMorph methodsFor: 'blocks' stamp: 'sk 3/8/2016 13:53'!checkBlockValidity: spec	| blockType selector defaultArgs |	"Answer a copy of me for exporting."	blockType _ spec at: 2.	selector _ (spec at: 3) asSymbol.	defaultArgs _ self defaultArgsFor: spec.	((defaultArgs size ~= 0) & (#hour:min: = selector)) ifTrue: [		((IOPort at: 19) = 6) ifTrue: [Transcript show: 'hoge'; cr.			^ false.		]	].! !!ScriptableScratchMorph methodsFor: 'blocks' stamp: 'KK 12/10/2014 11:47'!convertStacksToTuples	"Convert my blocks bin from a morph containing block stack into a collection of (<point>, <tuple>) pairs the represent the same stacks in compact, language-independent form."	| stacks blocks comments |	(blocksBin isKindOf: Array) ifTrue: [^ self].  "already converted"	stacks _ (blocksBin submorphs select: [:m | m respondsTo: #tupleSequence]).	blocks _ stacks select: [:m | m isKindOf: BlockMorph].	comments _ stacks select: [:m | m isKindOf: ScratchCommentMorph].	blocks _ blocks collect: [:blockM |		Array			with: blockM position - blocksBin position			with: blockM tupleSequence].	comments _ comments collect: [:blockM |		Array			with: blockM position - blocksBin position			with: blockM tupleSequence].	blocksBin _ blocks, comments.! !!ScriptableScratchMorph methodsFor: 'blocks' stamp: 'KK 9/23/2013 16:44'!convertTuplesToStacks	"Convert my blocks bin from a collection of (<point>, <tuple>) pairs into a morph containing a number of block stacks."	| tuplesList stack |	(blocksBin isKindOf: Array) ifFalse: [^ self].  "already converted"	tuplesList _ blocksBin.ConvertTuplesToStacks _ true.	blocksBin _ ScratchScriptsMorph new.	tuplesList do: [:pair |		stack _ self stackFromTupleList: pair second receiver: self.		stack position: pair first.		blocksBin addMorph: stack].! !!ScriptableScratchMorph methodsFor: 'blocks' stamp: 'KK 8/29/2013 16:41'!createBlock: block atPosition: pos onPage: page	"Creates a block on the given page. If the block is one that can become a watcher, then a toggle button is created as well."	| x y changingX toggleButton yOffset frame |	x _ pos x.	y _ pos y.	changingX _ x.	block canBecomeWatcher ifTrue: [		toggleButton _ self createToggleButtonFor: block.		yOffset _ (block fullBounds height - toggleButton fullBounds height) // 2.		page addMorphBack: (toggleButton position: x@(y+yOffset)).		changingX _ x + toggleButton fullBounds width + 4].	block fixBlockLayout; position: changingX@y.	page addMorphBack: block.	block canBecomeWatcher ifTrue: [		frame _ self ownerThatIsA: ScratchFrameMorph.		page updateWatcherButtonsForFrame: frame].	^ y + block height + 3! !!ScriptableScratchMorph methodsFor: 'blocks' stamp: 'KK 9/23/2013 18:49'!hatBlockType: blockType	| stage evtName |	'E' = blockType ifTrue: [		evtName _ ''.		(stage _ self ownerThatIsA: ScratchStageMorph)			ifNotNil: [evtName _ stage defaultEventName].		^ EventHatMorph new scriptOwner: self; eventName: evtName].	'K' = blockType ifTrue: [^ KeyEventHatMorph new scriptOwner: self].	'M' = blockType ifTrue: [^ MouseClickEventHatMorph new scriptOwner: self].	'S' = blockType ifTrue: [ ^ EventHatMorph new forStartEvent scriptOwner: self].	'W' = blockType ifTrue: [^ WhenHatBlockMorph new scriptOwner: self].! !!ScriptableScratchMorph methodsFor: 'blocks' stamp: 'KK 9/18/2013 19:02'!variableBlockFromTuple: tuple receiver: scriptOwner	"Answer a new block for the given variable reference tuple."	| varName rcvr bg selector block arg argBlock |	varName _ tuple at: 2.	rcvr _ scriptOwner.	(scriptOwner varNames includes: varName) ifFalse: [		bg _ scriptOwner ownerThatIsA: ScratchStageMorph.		bg			ifNil: [scriptOwner addVariable: varName]			ifNotNil: [				bg addVariable: varName.				rcvr _ bg]].	tuple first = #readVariable ifTrue: [		^ VariableBlockMorph new			commandSpec: varName;			receiver: rcvr].	tuple first = #changeVariable ifTrue: [		selector _ tuple at: 3.		"update selector if necessary (backward compatibility):"		(selector = #set:to:) ifTrue: [selector _ #setVar:to:].		block _ SetterBlockMorph new receiver: rcvr.		selector = #setVar:to:			ifTrue: [block initSetterForVar: varName]			ifFalse: [block initChangerForVar: varName].		arg _ tuple at: 4.		(arg isKindOf: Array)			ifTrue: [  "argument is a block"				((arg size = 1) and: [arg first isKindOf: Array]) ifTrue: [arg _ arg first].				argBlock _ self blockFromTuple: arg receiver: scriptOwner.				block replaceArgMorph: block expressionArg by: argBlock]			ifFalse: [ "argument is a value"				block expressionArg defaultValue: arg].		^ block].	self error: 'unknown variable spec'! !!ScriptableScratchMorph methodsFor: 'blocks' stamp: 'sk 2/23/2016 21:29'!viewerPageForMotion	"Answer a morph containing mtion blocks for the given category for use in the given ScratchViewer."	| bin isStage addMotorBlocks s x y |	bin _ ScratchBlockPaletteMorph new.	(self isKindOf: ScratchStageMorph)		ifTrue: [			isStage _ true.			addMotorBlocks _ self showMotorBlocks]		ifFalse: [			isStage _ false.			s _ self ownerThatIsA: ScratchStageMorph.			addMotorBlocks _ s notNil and: [s showMotorBlocks]].	addMotorBlocks _ true.	(isStage & addMotorBlocks not) ifTrue: [ ^ bin ]."		font _ (ScratchFrameMorph getFont: #ViewerPage).		x _ 20.		y _ 12.		m _ StringMorph contents: 'Stage selected:' localized font: font.		bin addMorph: (m color: Color white; position: x@y).		m _ StringMorph contents: 'No motion blocks' localized font: font.		bin addMorph: (m color: Color white; position: x@(y + 17)).		^ bin]."	x _ 12.	y _ 10.	(self blocksFor: 'motion') do: [:blockOrSym |		(blockOrSym = #-) | (blockOrSym = #~)			ifTrue: [				(blockOrSym = #-) ifTrue: [y _ y + 15].  "insert a full space"				(blockOrSym = #~) ifTrue: [y _ y + 5]]  "insert a half space"			ifFalse: [				y _ self createBlock: blockOrSym atPosition: x@y onPage: bin]].	addMotorBlocks ifFalse: [^ bin].	isStage ifFalse: [		y _ y + 7.		bin addMorph: ((ImageMorph new form: (ScratchFrameMorph skinAt: #connector)) position: x@y).		y _ y + 20].	(self blocksFor: 'motor') do: [:blockOrSym |		(blockOrSym = #-) | (blockOrSym = #~)			ifTrue: [				(blockOrSym = #-) ifTrue: [y _ y + 15].  "insert a full space"				(blockOrSym = #~) ifTrue: [y _ y + 5]]  "insert a half space"			ifFalse: [				y _ self createBlock: blockOrSym atPosition: x@y onPage: bin]].	" Only for Studuino mini "	(BoardType = 1) ifTrue: [		(self blocksFor: 'motion mini') do: [:blockOrSym |			(blockOrSym = #-) | (blockOrSym = #~)				ifTrue: [					(blockOrSym = #-) ifTrue: [y _ y + 15].  "insert a full space"					(blockOrSym = #~) ifTrue: [y _ y + 5]]  "insert a half space"				ifFalse: [					y _ self createBlock: blockOrSym atPosition: x@y onPage: bin]].].	^ bin! !!ScriptableScratchMorph methodsFor: 'blocks' stamp: 'sk 2/26/2016 20:58'!viewerPageForSensing	"Answer a morph containing mtion blocks for the given category for use in the given ScratchViewer."	| bin x y |	bin _ ScratchBlockPaletteMorph new.	x _ 12.	y _ 10.	(self blocksFor: 'sensing') do: [:blockOrSym |		(blockOrSym = #-) | (blockOrSym = #~)			ifTrue: [				(blockOrSym = #-) ifTrue:[y _ y + 15]. "insert a full space"				(blockOrSym = #~) ifTrue: [					y _ y + 7.					bin addMorph: ((ImageMorph new form: (ScratchFrameMorph skinAt: #connector)) position: x@y).					y _ y + 20]]			ifFalse: [				y _ self createBlock: blockOrSym atPosition: x@y onPage: bin]].	" Only for Studuino mini "	(BoardType = 1) ifTrue: [		(self blocksFor: 'sensing mini') do: [:blockOrSym |			(blockOrSym = #-) | (blockOrSym = #~)				ifTrue: [					(blockOrSym = #-) ifTrue:[y _ y + 15]. "insert a full space"					(blockOrSym = #~) ifTrue: [						y _ y + 7.						bin addMorph: ((ImageMorph new form: (ScratchFrameMorph skinAt: #connector)) position: x@y).						y _ y + 20]]				ifFalse: [					y _ self createBlock: blockOrSym atPosition: x@y onPage: bin]].].	^ bin! !!ScriptableScratchMorph methodsFor: 'event handling' stamp: 'KK 9/19/2013 10:32'!doubleClick: evt	"Show my viewer and script editor."		| hand |	hand _ self world activeHand.	hand toolType ifNotNil: [		^ self handleTool: hand toolType hand: hand]."	self viewBlocksAndScripts."! !!ScriptableScratchMorph methodsFor: 'object i/o' stamp: 'KK 1/21/2013 19:19'!storeFieldsOn: anObjStream	| oldBlockBinOwner |	super storeFieldsOn: anObjStream.	(blocksBin isKindOf: Morph) ifTrue: [		oldBlockBinOwner _ blocksBin owner.		blocksBin delete].	self storeFieldsNamed: #(		objName		vars		blocksBin		isClone		media		costume	) on: anObjStream.	oldBlockBinOwner ifNotNil: [oldBlockBinOwner addMorph: blocksBin].! !!ScriptableScratchMorph methodsFor: 'private' stamp: 'KK 2/27/2015 15:16'!getHatlessBlocks	| stacks aloneBlocks |	aloneBlocks _ nil.	stacks _ blocksBin submorphs select: [:m | m isKindOf: BlockMorph].	stacks size = 0 ifTrue: [		^ aloneBlocks].	aloneBlocks _ stacks select: [:m | (m isKindOf: HatBlockMorph) not].	^ aloneBlocks! !!ScriptableScratchMorph methodsFor: 'private' stamp: 'sk 7/7/2016 19:37'!printArduLangOn: aStream 	| stacks hats evtName index partsName portName offset filename f j b initCode |	stacks _ blocksBin submorphs select: [:m | m isKindOf: BlockMorph].	stacks size = 0 ifTrue: [		^ self].	hats _ stacks select: [:m | m isKindOf: HatBlockMorph].	" Include file declaration "	"---------------------------------------------------------"	" Get Servomotor Info "	"---------------------------------------------------------"	filename := '..\common\sv_offset_ini'.	f _ FileStream fileNamed: filename.	f binary.	j _ 1.	[j > SvCalib size] whileFalse: [		b _ f next.	" PartsID "		" I/O Port Configuration "		SvCalib at:(j) put:b.		j _ j + 1.	].	f close.	"---------------------------------------------------------"	" Get DC motor Info "	"---------------------------------------------------------"	filename _ '..\common\dc_calib_ini'.	f _ FileStream fileNamed: filename.	f binary.	j _ 1.	[j > DCCalib size] whileFalse: [		b _ f next.	" DC motor speed ratio "		DCCalib at:(j) put:b.		j _ j + 1.	].	f close.	aStream nextPutAll: '// ---------------------------------------'; cr.	aStream nextPutAll: '// Servomotor calibration data'; cr.	aStream nextPutAll: '// ---------------------------------------'; cr.	aStream nextPutAll: 'char SvCalibrationData[] = { '.	(BoardType = 0 or: [BoardType = 2]) ifTrue: [	5 to: 8 do: [:i|		offset _ SvCalib at:(i).		" Convert unsigned to singed "		(offset > 127) ifTrue: [			offset _ offset - 256.		].		aStream nextPutAll: offset asString, ', '.	].	1 to: 4 do: [:i|		offset _ SvCalib at:(i).		" Convert unsigned to singed "		(offset > 127) ifTrue: [			offset _ offset - 256.		].		aStream nextPutAll: offset asString, ', '.	].	]	ifFalse: [ " Studuino mini "		SvCalib do: [:elm |			offset _ elm.			(offset > 127) ifTrue: [ " Convert unsigned to singed "				offset _ offset - 256.].			aStream nextPutAll: offset asString, ', '.].	].	aStream nextPutAll: ' };'; cr.	aStream nextPutAll: '// ---------------------------------------'; cr.	aStream nextPutAll: '// DC motor calibration data'; cr.	aStream nextPutAll: '// ---------------------------------------'; cr.	aStream nextPutAll: 'byte DCCalibrationData[] = { '.	offset _ DCCalib at:(1).	aStream nextPutAll: offset asString, ', '.	offset _ DCCalib at:(2).	aStream nextPutAll: offset asString.	aStream nextPutAll: ' };'; cr.	" Prototype declaration "	aStream nextPutAll: '// ---------------------------------------'; cr.	aStream nextPutAll: '// prototype declaration'; cr.	aStream nextPutAll: '// ---------------------------------------'; cr.	hats do: [:item |		evtName _ item eventName.		evtName = 'Scratch-StartClicked'			ifTrue: [aStream nextPutAll: 'void artecRobotMain();']			ifFalse: [aStream nextPutAll: 'void ARSR_', evtName, '();'].		aStream cr.	].	aStream nextPutAll: '// ---------------------------------------'; cr.	aStream nextPutAll: '// Global variable'; cr.	aStream nextPutAll: '// ---------------------------------------'; cr.	"Define value"	self varNames do: [:v |		aStream nextPutAll: 'float ARVAL_' , v, ';'.		aStream cr.	].	"Define list"	self listVarNames do: [:v |		aStream nextPutAll: 'cell ARLIST_' , v, ';'.		aStream cr.	].	aStream nextPutAll: 'byte port[8];';cr.	aStream nextPutAll: 'byte degree[8];';cr.	aStream nextPutAll: '// ---------------------------------------'; cr.	aStream nextPutAll: '// Artec robot setup routine'; cr.	aStream nextPutAll: '// ---------------------------------------'; cr.	aStream nextPutAll: 'void artecRobotSetup() {'; cr.	"For Studuino mini clock initialization."	(BoardType == 1) ifTrue: [		((IOPort at: 19) = 6) ifTrue: [ "Clock is enabled."			aStream nextPutAll: '    board.InitClock();'; cr.].].	index _ 0.	IOPort do: [ :partsID |		(partsID ~= 0) ifTrue: [			(index = 0) ifTrue: [				aStream nextPutAll: '    board.InitDCMotorPort(PORT_M1);'; cr."Transcript show: 'initDCMotor('; show:index; show: ');'; cr."			].			(index = 1) ifTrue: [				aStream nextPutAll: '    board.InitDCMotorPort(PORT_M2);'; cr."Transcript show: 'initDCMotor('; show:index; show: ');'; cr."			].	" Board selection "	(BoardType = 0 or: [BoardType = 2]) ifTrue: [	" For Studuino "			(index = 2) ifTrue: [				aStream nextPutAll: '    board.InitServomotorPort(PORT_D2);'; cr.			].			(index = 3) ifTrue: [				aStream nextPutAll: '    board.InitServomotorPort(PORT_D4);'; cr.			].			(index = 4) ifTrue: [				aStream nextPutAll: '    board.InitServomotorPort(PORT_D7);'; cr.			].			(index = 5) ifTrue: [				aStream nextPutAll: '    board.InitServomotorPort(PORT_D8);'; cr.			].			(index = 6) ifTrue: [				aStream nextPutAll: '    board.InitServomotorPort(PORT_D9);'; cr.			].			(index = 7) ifTrue: [				aStream nextPutAll: '    board.InitServomotorPort(PORT_D10);'; cr.			].			(index = 8) ifTrue: [				aStream nextPutAll: '    board.InitServomotorPort(PORT_D11);'; cr.			].			(index = 9) ifTrue: [				aStream nextPutAll: '    board.InitServomotorPort(PORT_D12);'; cr.			].]	ifFalse: [	" For Studuino mini "		((index > 1) & (index < 10)) ifTrue: [			(partsID = 2) ifTrue: [				initCode _ '    board.InitServomotorPort(']			ifFalse: [				initCode _ '    board.InitDigitalPort('].			(index = 2) ifTrue: [				initCode _ initCode, 'PORT_D5'.].			(index = 3) ifTrue: [				initCode _ initCode, 'PORT_D6'.].			(index = 4) ifTrue: [				initCode _ initCode, 'PORT_D9'.].			(index = 5) ifTrue: [				initCode _ initCode, 'PORT_D10'.].			(index = 6) ifTrue: [				initCode _ initCode, 'PORT_D11'.].			(partsID = 5) ifTrue: [				initCode _ initCode, ', PIDLED'.].			aStream nextPutAll: initCode, ');'; cr.].]."			((index > 1) & (index < 10)) ifTrue: [				aStream nextPutAll: '    initSVMotor('.				aStream nextPutAll: (index-2) asString.				aStream nextPutAll: ');'; cr.			]."			(index > 9) & (index < 18) ifTrue: [				(partsID = 16r03) ifTrue: [ partsName _ 'PIDLED' ].				(partsID = 16r04) ifTrue: [ partsName _ 'PIDBUZZER' ].				(partsID = 16r05) ifTrue: [ partsName _ 'PIDCOLORLED' ].				(partsID = 16r10) ifTrue: [ partsName _ 'PIDLIGHTSENSOR' ].				(partsID = 16r11) ifTrue: [ partsName _ 'PIDTOUCHSENSOR' ].				(partsID = 16r12) ifTrue: [ partsName _ 'PIDSOUNDSENSOR' ].				(partsID = 16r13) ifTrue: [ partsName _ 'PIDIRPHOTOREFLECTOR' ].				(partsID = 16r14) ifTrue: [ partsName _ 'PIDACCELEROMETER' ].				(partsID = 16r15) ifTrue: [ partsName _ 'PIDPUSHSWITCH' ].				(index = 10) ifTrue: [ portName _ 'PORT_A0' ].				(index = 11) ifTrue: [ portName _ 'PORT_A1' ].				(index = 12) ifTrue: [ portName _ 'PORT_A2' ].				(index = 13) ifTrue: [ portName _ 'PORT_A3' ].				(index = 14) ifTrue: [ portName _ 'PORT_A4' ].				(index = 15) ifTrue: [ portName _ 'PORT_A5' ].				(index = 16) ifTrue: [ portName _ 'PORT_A6' ].				(index = 17) ifTrue: [ portName _ 'PORT_A7' ].				aStream nextPutAll: '    board.InitSensorPort('.				aStream nextPutAll: portName.				aStream nextPutAll: ', '.				aStream nextPutAll: partsName.				aStream nextPutAll: ');'; cr."Transcript show: 'initSensorPin('; show:(index-10); show: ', '; show:partsName; show: ');'; cr."			].		].		index _ index + 1.	].	aStream nextPutAll: '    board.SetServomotorCalibration(SvCalibrationData);'; cr.	aStream nextPutAll: '    board.SetDCMotorCalibration(DCCalibrationData);'; cr.	aStream nextPutAll: '}'; cr.	NumberOfdoRepeat _ 0.	hats do: [:item |		item printArduCodeOn: aStream indent: 0.		(item isKindOf: ReporterBlockMorph) ifTrue: [aStream cr].		aStream cr].! !!ScratchSpriteMorph methodsFor: 'accessing' stamp: 'KK 1/28/2013 11:37'!referencePosition	| p s |	p _ (bounds origin + offsetWhenRotated) - ScratchOrigin.	"adjust when in Hand in quartersize mode:"	((owner isKindOf: HandMorph) and:	 [((s _ owner formerOwner) isKindOf: ScratchStageMorph) and:	 [s isQuarterSize]]) ifTrue: [		"Note: this is not quite right when rotation center is offset"		p _ (p * 2) + (240@180)].	^ p x @ p y negated! !!ScratchStageMorph methodsFor: 'initialization' stamp: 'KK 2/13/2014 18:51'!initialize	super initialize.	color _ Color white.	self enableDragNDrop: true.	objName _ 'Stage' localized.	costume _ self defaultImageMedia.	media _ OrderedCollection with: costume with: SoundMedia new.	zoom _ 1.0.	hPan _ 0.	vPan _ 0.	runningBlocks _ OrderedCollection new.	inProcessStep _ false.	sensorBoard _ SensorBoardMorph new.	midiPortNum _ -1.	notePlayerDict _ Dictionary new.	obsoleteSavedState _ nil.	sprites _ OrderedCollection new.	showMotorBlocks _ false.	servoCalibrationBoard _ SensorBoardMorph new.! !!ScratchStageMorph methodsFor: 'accessing' stamp: 'KK 1/21/2013 19:20'!objName	^ 'ArTec Block Robot Programming Environment' localized! !!ScratchStageMorph methodsFor: 'event handling' stamp: 'KK 9/19/2013 10:21'!containsPoint: aPoint	self isQuarterSize ifTrue: [^ (self position extent: self extent // 2)  containsPoint: aPoint].	^ self bounds containsPoint: aPoint! !!ScratchStageMorph methodsFor: 'event handling' stamp: 'KK 9/19/2013 10:20'!fullContainsPoint: aPoint	"Answer true if the given point is in my visible bounds. In quarterSize mode, my visible bounds is only half of my extent."	| r |	r _ self isQuarterSize		ifTrue: [self position extent: bounds extent // 2]		ifFalse: [bounds].	^ r containsPoint: aPoint! !!ScratchStageMorph methodsFor: 'drawing' stamp: 'KK 9/3/2013 16:42'!drawQuarterSizeOn: aCanvas	"Draw myself and my submorphs to an offscreen canvas, then scale down to quarter size and draw that on the given canvas."	| r srcR c |	cachedForm ifNil: [cachedForm _ Form extent: self extent depth: 32].	r _ aCanvas clipRect intersect: (bounds origin extent:  (bounds extent x // 2 @ bounds extent y)).	srcR _ ((r origin - bounds origin) * 2.0) truncated extent: (r extent * 2.0) rounded.	c _ (FormCanvas on: cachedForm)		copyOrigin: self position negated		clipRect: srcR.	super fullDrawOn: c.	ScratchPlugin halfSize: cachedForm into: Display srcPoint: srcR origin dstRect: r."xxx	cachedForm unhibernate.	LowResPlugin		primHalf2Average: cachedForm bits w: cachedForm width h: cachedForm height		into: Display bits w: Display width h: Display height		srcX: srcR left srcY: srcR top		dstX: r left dstY: r top dstW: r width dstH: r height.	(WarpBlt toForm: Display)		sourceForm: cachedForm;		combinationRule: Form over;		clipRect: aCanvas clipRect;		cellSize: 2;		copyQuad: srcR corners toRect: r.xxx"	"the following scales down entire stage:""	LowResPlugin scale: cachedForm into: aCanvas form at: aCanvas origin + self position."! !!ScratchStageMorph methodsFor: 'menus' stamp: 'KK 9/19/2013 10:05'!rightButtonMenu	"Present the right button menu."	| |"	menu _ CustomMenu new.	menu add: 'grab screen region for new sprite' action: #grabSpriteFromScreen.	menu addLine.	menu add: 'save picture of stage...' action: #stageShot.	menu localize; invokeOn: self."! !!ScriptableScratchMorph class methodsFor: 'block specs' stamp: 'sk 2/23/2016 21:30'!blockColorFor: aCategory	"Answer the block color for the given category."	'control' = aCategory ifTrue: [^ (Color h: 41 s: 0.85 v: 0.9)].	'motion' = aCategory ifTrue: [^ (Color h: 225 s: 0.65 v: 0.83)].	'motor' = aCategory ifTrue: [^ (Color h: 220 s: 0.85 v: 0.725)].	'motion mini' = aCategory ifTrue: [^ (Color h: 220 s: 0.85 v: 0.725)].	'looks' = aCategory ifTrue: [^ (Color h: 264 s: 0.62 v: 0.89)].	'pen' = aCategory ifTrue: [^ (Color h: 165 s: 1 v: 0.63)].	'operators' = aCategory ifTrue: [^ (Color h: 93 s: 0.9 v: 0.76)].	'sound' = aCategory ifTrue: [^ (Color h: 296 s: 0.66 v: 0.85)].	'sensing' = aCategory ifTrue: [^ (Color h: 200 s: 0.98 v: 0.86)].	'sensing mini' = aCategory ifTrue: [^ (Color h: 200 s: 0.98 v: 0.86)].	'variables' = aCategory ifTrue: [^ (Color h: 25 s: 0.88 v: 0.95)].	'list' = aCategory ifTrue: [^ ListBlockColor].	'notSensing' = aCategory ifTrue: [^ (Color h: 0 s: 0 v: 0.5)].	'compatible' = aCategory ifTrue: [^ (Color h: 28 s: 0.61 v: 0.96)].	^ (Color h: 0 s: 0.81 v: 0.83)  "a shade of red"! !!ScriptableScratchMorph class methodsFor: 'block specs' stamp: 'sk 4/25/2016 18:46'!blockSpecs	"Answer a collection of block specifications for the blocks that are common to all objects. Block specificatons (Arrays) are interspersed with category names (Strings). A block specification is an Array of the form: (<block spec string> <block type> <selector> [optional initial argument values]).	Explanation of flags:		-	no flags		b	boolean reporter		c	c-shaped block containing a sequence of commands (always special form)		r	reporter		s	special form command with its own evaluation rule		t	timed command, like wait or glide		E	message event hat		K	key event hat		M	mouse-click event hat		S	start event hat		W	when <condition> hat (obsolete)"	| blocks |	blocks _ #(		'control'			('%e function'			E	-)			('call %e function'			s	doBroadcastAndWait)			-			('wait %n secs'					t	wait:elapsed:from: 1)			-			('forever'						c	doForever)			('repeat %n'						c	doRepeat 10)			-"			('broadcast %e'					-	broadcast:)"			('forever if %b'					c	doForeverIf)			('if %b'							c	doIf)			('if %b'							c	doIfElse)			('wait until %b'					s	doWaitUntil)			('repeat until %b'				c	doUntil)"			-			('stop script'					s	doReturn)			('stop all'						-	stopAll)"			('Servomotor synchro motion speed:%E'						c	doSvmSyncMotion2 10)		'compatible'			('Servomotor synchro motion delay:%E'						c	doSvmSyncMotion 10)		'operators'			('%n + %n'						r	+ - -)			('%n - %n'						r	- - -)			('%n * %n'						r	* - -)			('%n / %n'						r	/ - -)			-			('pick random %n to %n'		r	randomFrom:to: 1 10)			-			('%n < %n'						b	< - -)			('%n = %n'						b	= - -)			('%n > %n'						b	> - -)			-			('%b and %b'					b	&)			('%b or %b'						b	|)			('not %b'						b	not)"			-			('join %s %s'					r	concatenate:with: 'hello ' 'world')			('letter %n of %s'				r	letter:of: 1 'world')			('length of %s'					r	stringLength: 'world')"			-			('%n mod %n'					r	\\ - -)			('round %n'						r	rounded -)			-			('%f of %n'						r	computeFunction:of: 'sqrt' 10)		'sound'"xxx			('play sound %S'				-	playSound:)			('play sound %S until done'		s	doPlaySoundAndWait)			('stop all sounds'				-	stopAllSounds)			-			('play drum %D for %n beats'	t 	drum:duration:elapsed:from: 48 0.2)			('rest for %n beats'				t 	rest:elapsed:from: 0.2)			-			('play note %N for %n beats'	t	noteOn:duration:elapsed:from: 60 0.5)			('set instrument to %I'			- 	midiInstrument: 1)			-			('change volume by %n'		- 	changeVolumeBy: -10)			('set volume to %n%'			- 	setVolumeTo: 100)			('volume'						r 	volume)			-			('change tempo by %n'			- 	changeTempoBy: 20)			('set tempo to %n bpm'			- 	setTempoTo: 60)			('tempo'							r 	tempo)"		'motor'"			('motor on for %n secs'			t	motorOnFor:elapsed:from: 1)			('motor on'						-	allMotorsOn)			('motor off'						-	allMotorsOff)			('motor power %n'				-	startMotorPower: 100)			('motor direction %W'			-	setMotorDirection: 'this way')"			('Set servomotor %J to %F degrees'			-	motorNo:degree: 'PIN' 90)			('DC motor %j power %n'		-	motorNo:power: 'PIN' 100)			('DC motor %j on at %t'		-	motorNo:dcMotorOn: 'PIN' 'cw.')			('DC motor %j off %T'		-	motorNo:dcMotorOff:'PIN' 'Brake')			('Buzzer %B on frequency %N'	-	buzzerPin:freq: 'PIN' 60)			('Buzzer %B off'					-	buzzerPin: 'PIN')			('LED %p %o'					-	ledPin:onOff: 'PIN' 'on')		'motion mini'			('Onboard LED %p1 %o'			-	boardLED:onOff: 'Red(D5)' 'on')			('Set time %nh %nm'			-	hour:min: 0 0)			('Set date %n/%n/%n'			-	month:day:year: 1 1 2016)			('Set alarm %nh %nm'			-	alhour:almin: 0 0)			('Set backlight R%n G%n B%n'	-	red:green:blue: 0 0 0)			('Backlight %o'					-	clkBackLight: 'on')			('Clock''s buzzer on frequency %N for %n'	t	clkBuzzerOnFreq:For:elapsed:from: 60 1)"			('Clock''s buzzer off'				-	clkBuzzerOff)""			('Color LED %w %o'				-	ledColor:onOff: 'White' 'on')"			-"			('Move %q for %n msec at %n power and %T'	-	direct:time:power:stop 'Forward' 100  100 'Brake')""			('Set servomotors %E ms/deg, D2:%F D4:%F D7:%F D8:%F D9:%F D10:%F D11:%F D12:%F' - setServoSpeed:d2:d4:d7:d8:d9:d10:d11:d12: 10 90 90 90 90 90 90 90 90)"			-		'variables'"			('show variable %v'				-	showVariable:)			('hide variable %v'				-	hideVariable:)"		'list'			('add %n to %L'					-	append:toList: 0)			-			('delete %y of %L'				-	deleteLine:ofList: 1)			('insert %n at %i of %L'			-	insert:at:ofList: 0 1)			('replace item %i of %L with %n'		-	setLine:ofList:to: 1 'list' 0)			-			('item %i of %L'					r	getLine:ofList: 1)			('length of %L'					r	lineCountOfList:)			('%L contains %n'				b	list:contains: 'list' 0)	).	^ blocks, self obsoleteBlockSpecs! !!ScriptableScratchMorph class methodsFor: 'block specs' stamp: 'KK 9/5/2013 16:33'!buildBlockSpecDictionary	"self buildBlockSpecDictionary"	| blockColor sel |	BlockSpecDict _ IdentityDictionary new: 250.	BlockColorDict _ IdentityDictionary new: 250."Transcript show:'[ScriptableScratchMorph::buildBlockSpecDictionary]';cr."	self withAllSubclassesDo: [:cl |		blockColor _ Color blue.		cl blockSpecs do: [:spec |			((spec isKindOf: String) and: [spec size > 1]) ifTrue: [				"set color  for this category"				blockColor _ self blockColorFor: spec].			(spec isMemberOf: Array) ifTrue: [				sel _ spec at: 3.				BlockSpecDict at: sel put: spec.				BlockColorDict at: sel put: blockColor]]].! !!ScratchSpriteMorph class methodsFor: 'block specs' stamp: 'KK 8/31/2013 11:01'!blockSpecs	| blocks |	blocks _ #(		'motion'			('move %n steps'				-	forward:)			('turn %n degrees'				-	turnRight: 15)	"icon shows turn direction"			('turn %n degrees'				-	turnLeft: 15)	"icon shows turn direction"			-			('point in direction %d'			-	heading: 90)			('point towards %m'				-	pointTowards:)			-			('go to x:%n y:%n'				-	gotoX:y: 0 0)			('go to %m'						-	gotoSpriteOrMouse:)			('glide %n secs to x:%n y:%n'	t	glideSecs:toX:y:elapsed:from: 1 50 50)			-			('change x by %n'				-	changeXposBy: 10)			('set x to %n'					-	xpos: 0)			('change y by %n'				-	changeYposBy: 10)			('set y to %n'					-	ypos: 0)			-			('if on edge, bounce'			-	bounceOffEdge)			-			('x position'						r	xpos)			('y position'						r	ypos)			('direction'						r	heading)		'pen'			('clear'							-	clearPenTrails)			-			('pen down'						-	putPenDown)			('pen up'						-	putPenUp)			-			('set pen color to %c'			-	penColor:)			('change pen color by %n'		-	changePenHueBy:)			('set pen color to %n'			-	setPenHueTo: 0)			-			('change pen shade by %n'		-	changePenShadeBy:)			('set pen shade to %n'			-	setPenShadeTo: 50)			-			('change pen size by %n'		-	changePenSizeBy: 1)			('set pen size to %n'				-	penSize: 1)			-			('stamp'							-	stampCostume)	).	blocks _ blocks, #(		'looks'			('switch to costume %l'			-	lookLike:)			('next costume'					-	nextCostume)			('costume #'						r	costumeIndex)			-			('say %s for %n secs'			t	say:duration:elapsed:from: 'Hello!!' 2)			('say %s'						-	say: 'Hello!!')			('think %s for %n secs'			t	think:duration:elapsed:from: 'Hmm...' 2)			('think %s'						-	think: 'Hmm...')			-			('change %g effect by %n'		-	changeGraphicEffect:by: 'color' 25)			('set %g effect to %n'			-	setGraphicEffect:to: 'color' 0)			('clear graphic effects'			-	filterReset)			-			('change size by %n'			-	changeSizeBy:)			('set size to %n%'				-	setSizeTo: 100)			('size'							r	scale)			-			('show'							-	show)			('hide'							-	hide)			-			('go to front'					-	comeToFront)			('go back %n layers'			-	goBackByLayers: 1)		'sensing'			('touching %m?' 				b	touching:)			('touching color %C?' 			b	touchingColor:)			('color %C is touching %C?'		b	color:sees:)			-			('ask %s and wait'				s	doAsk 'What''s your name?')			('answer'						r	answer)			-			('mouse x'						r	mouseX)			('mouse y'						r	mouseY)			('mouse down?'					b	mousePressed)			-			('key %k pressed?'				b	keyPressed: 'space')			-			('distance to %m'				r	distanceTo:)			-			('reset timer'					-	timerReset)			('timer'							r	timer)			-			('%a of %m'						r	getAttribute:of:)			-			('loudness'						r	soundLevel)			('loud?'							b	isLoud)			~			('%H sensor value'				r	sensor: 'slider')			('sensor %h?'					b	sensorPressed: 'button pressed')"			('Light Sensor %Z value'		r	lightSensor: 'A0')			('Touch Sensor %V value'	r	touchSensor: 'A0')			('Sound Sensor %Z value'	r	sensor: 'A0')			('Reflective Photosensor %Z value'	r	sensor: 'A0')			('3-Axis Digital Accelerometer %Y value'	r	sensor: 'X')			('Button %X value'	r	sensor: 'A0')"		).	^ blocks, super blockSpecs! !!ScratchStageMorph class methodsFor: 'block specs' stamp: 'sk 7/8/2016 10:32'!blockSpecs	| blocks |	blocks _ #(		'sensing'"			('ask %s and wait'			s	doAsk 'What''s your name?')			('answer'					r	answer)			-			('mouse x'					r	mouseX)			('mouse y'					r	mouseY)			('mouse down?'				b	mousePressed)			-			('key %k pressed?'			b	keyPressed: 'space')			-			('reset timer'				-	timerReset)			('timer'						r	timer)			-			('%a of %m'					r	getAttribute:of:)			-			('loudness'					r	soundLevel)			('loud?'						b	isLoud)			~			('%H sensor value'			r	sensor: 'slider')			('sensor %h?'				b	sensorPressed: 'button pressed')			~""			('set servo motor %J to %n degrees'			-	motorNo:degree: 'No.1' 90)			('set DC motor %j  %z'		-	motorNo:onOff: 'No.1' 'on')""			('%z sensor value'			r	sensor: 'A0')"			('Light Sensor %P value'		r	lightSensor: 'PIN')			('Touch Sensor %V value'	r	touchSensor: 'PIN')			('Sound Sensor %O value'	r	soundSensor: 'PIN')			('IR Photoreflector %Z value'	r	refPhotosensor: 'PIN')						('3-Axis Digital Accelerometer %Y value'	r	accelerometer: 'AXIS')			('Button %X value'	r		onBoardButton: 'PIN')			~			('reset timer'				-	timerReset)			('timer'						r	timer)			~		'sensing mini'			('Clock''s %Z1'	r	clockValue: 'Hour')			('becoming in alarm time'		b	isInAlarm)			('Onboard Light Sensor value'	r		onBoardLightSensor)			('Power value'	r		power)		'looks'"xxx			('switch to background %l'	-	showBackground: 'background1')			('next background'			-	nextBackground)			('background #'				r	backgroundIndex)			-			('change %g effect by %n'	-	changeGraphicEffect:by: 'color' 25)			('set %g effect to %n'		-	setGraphicEffect:to: 'color' 0)			('clear graphic effects'		-	filterReset)			-""xxx			('place sprites for scene %x'	-	showScene:) "		'pen'"xxx			('clear'						-	clearPenTrails)"	).	^ blocks, super blockSpecs! !!SensorBoardMorph methodsFor: 'initialization' stamp: 'KK 8/28/2013 17:12'!addReadoutLabeled: aString	"Add a readout row with the given label. Answer the stringmorph that's the readout."	| row box readout |	row _ AlignmentMorph newRow color: column color; inset: 2."	row _ AlignmentMorph newRow color: (Color r: (255/255) g: (0/255) b: (0/255)); inset: 2."	row addMorphBack: (Morph new color: column color; extent: 1@3). "spacer"	row addMorphBack: (StringMorph contents: aString capitalized font: (StrikeFont fontName: 'VerdanaBold' size: 10)).	row addMorphBack: (AlignmentMorph new color: column color; extent: 10@1; hResizing: #spaceFill).  "spacer"	box _ WatcherReadoutFrameMorph new		extent: 42@14;		color: (ScriptableScratchMorph blockColorFor: 'sensing').	readout _ StringMorph contents: '0' font: (StrikeFont fontName: 'VerdanaBold' size: 10).	readout color: Color white.	box addMorph: readout.	row addMorphBack: box.	column addMorphBack: row.	^ readout! !!SensorBoardMorph methodsFor: 'initialization' stamp: 'KK 8/28/2013 18:50'!addReadoutLabeled: aString isSensor: kind	"Add a readout row with the given label. Answer the stringmorph that's the readout."	| row box readout colorName |	row _ AlignmentMorph newRow color: column color; inset: 2.	row addMorphBack: (Morph new color: column color; extent: 1@3). "spacer"	row addMorphBack: (StringMorph contents: aString capitalized font: (StrikeFont fontName: 'VerdanaBold' size: 10)).	row addMorphBack: (AlignmentMorph new color: column color; extent: 10@1; hResizing: #spaceFill).  "spacer"	(kind = true) ifTrue:[	" Sensor "		colorName _ 'sensing'.	] ifFalse: [				" Not sensor "		colorName _ 'notSensing'.	].	box _ WatcherReadoutFrameMorph new		extent: 42@14;		color: (ScriptableScratchMorph blockColorFor: colorName).	readout _ StringMorph contents: '0' font: (StrikeFont fontName: 'VerdanaBold' size: 10).	readout color: Color white.	box addMorph: readout.	row addMorphBack: box.	column addMorphBack: row.	^ readout! !!SensorBoardMorph methodsFor: 'initialization' stamp: 'sk 8/5/2016 19:34'!addReadouts	| readoutNames sensorID offset light touch sound infrared acceleration button setAcceleration open led buzzer colorLED kindOfSensor sizeAx tmp header cont |	" Check IOPort ""	Transcript show:'[SensorBoardMorph::addReadouts] ';show:(IOPort);cr."	offset _ 10.		" Offset for sensor ID "	open _ 16r00.			" Not connected "	led _ 16r03.				" LED ID "	buzzer _ 16r04.			" Buzzer ID "	colorLED _ 16r05.		" Color LED ID "	light _ 16r10.			" Light sensor ID "	touch _ 16r11.			" Touch sensor ID "	sound _ 16r12.			" Sound sensor ID "	infrared _ 16r13.		" IR Photoreflector ID "	acceleration _ 16r14.		" Accelerometer ID "	button _ 16r15.			" Button sensor ID "	setAcceleration _ false.	" Set acceleration sensor flag "	(BoardType = 0 or: [BoardType = 2]) ifTrue: [		sizeAx _ 8.]	ifFalse: [		sizeAx _ 6.].	readoutNames _ OrderedCollection new.	1 to: sizeAx do: [ :index |		sensorID _ IOPort at: (index + offset).		(sensorID = open) ifTrue: [	" Not connected "			readoutNames add:'[A', (index - 1) asString,']',' Not connected'.		].		(sensorID = led) ifTrue: [	" LED "			readoutNames add:'[A', (index - 1) asString,']',' LED'.		].		(sensorID = buzzer) ifTrue: [	" Buzzer "			readoutNames add:'[A', (index - 1) asString,']',' Buzzer'.		].		(sensorID = colorLED) ifTrue: [	" Color LED "			readoutNames add:'[A', (index - 1) asString,']',' Color LED'.		].		(sensorID = light) ifTrue: [	" Light Sensor "			readoutNames add:'[A', (index - 1) asString,']',' Light sensor'.		].		(sensorID = touch) ifTrue: [	" Touch Sensor "			readoutNames add:'[A', (index - 1) asString,']',' Touch sensor'.		].		(sensorID = sound) ifTrue: [	" Sound Sensor "			readoutNames add:'[A', (index - 1) asString,']',' Sound sensor'.		].		(sensorID = infrared) ifTrue: [	" IR Photoreflector "			readoutNames add:'[A', (index - 1) asString,']',' IR Photoreflector'.		].		(sensorID = acceleration) ifTrue: [	" Accelerometer "			(setAcceleration = false) ifTrue: [				readoutNames add:'[A4/A5] Accelerometer (X)'.				readoutNames add:'[A4/A5] Accelerometer (Y)'.				readoutNames add:'[A4/A5] Accelerometer (Z)'.				setAcceleration _ True.			].		].		(sensorID = button) ifTrue: [	" Button "			readoutNames add:'[A', (index - 1) asString,']',' Button'.		].	].	column _ AlignmentMorph newColumn		centering: #center;		hResizing: #spaceFill;		vResizing: #shrinkWrap;		color: (Color r: (193/255) g: (196/255) b: (199/255));		borderWidth: 2;		borderColor: (Color r: (148/255) g: (145/255) b: (145/255));		useRoundedCorners;		inset: 3.	titleMorph _ StringMorph		contents: ''		font: (StrikeFont fontName: 'VerdanaBold' size: 10).	column addMorph: titleMorph.	self updateTitle.	column addMorphBack: (Morph new color: column color; extent: 5@3).  "spacer"	self removeAllMorphs.	readouts _ readoutNames collect: [:i |		(((i findString: 'Not connected') ~= 0) | ((i findString: 'LED') ~= 0) | ((i findString: 'Buzzer') ~= 0)) ifTrue: [			kindOfSensor _ false.		] ifFalse: [			kindOfSensor _ true.		].		(i size = 1)			ifTrue:[self addReadoutLabeled: i isSensor: kindOfSensor]			ifFalse:[				tmp _ i findTokens: ' '.				header _ tmp at: 1.				cont _ ''.				2 to: (tmp size) do: [:index |					cont _ cont, (tmp at: index).					(index = tmp size) ifFalse: [cont _ cont, ' '].].				self addReadoutLabeled: (header localized, ' ', cont localized) isSensor: kindOfSensor.]	].	" For Studuino mini "	(BoardType = 1) ifTrue: [		readouts add: (self addReadoutLabeled: 'Onboard LightSensor' localized).		readouts add: (self addReadoutLabeled: 'Battery voltage [V]' localized).		clock _ ColorClock new].	column position: self position - 2.	self addMorph: column.	self extent: column extent - 4.! !!SensorBoardMorph methodsFor: 'initialization' stamp: 'sk 4/25/2016 18:42'!clockBuzzer: bz For: time	| mid ival tmp |	mid _ 2.		" 2: Buzzer ID "	(clock isSounding) ifFalse: [		clock startBuzzerFor: time.		" set port and buzzer ON "		ival _ 16r0100.	" b0000 0001 0000 0000 "		tmp _ bz asNumber.		tmp _ tmp - 48.		(tmp > 47) & (tmp < 109) ifTrue: [ tmp _ 0. ].		ival _ ival + tmp.		"Transcript show:'ScriptableScratchMorph:: buzzerPin:freq:'; show: ival;cr."		^ self data:ival msgID:mid.]	ifTrue: [		clock isElapsed ifTrue: [			" set port and buzzer OFF "			ival _ 16r0040.	" b0000 0000 0100 0000 "			^ self data:ival msgID:mid].		].	^ self.! !!SensorBoardMorph methodsFor: 'initialization' stamp: 'sk 4/14/2016 14:39'!clockDataSend: data	| msg d1 d2 d3 sendMessage |	msg _ #(0 0 0) asByteArray.	d1 _ ((data bitShift: -12) bitAnd: 16r0F).	d2 _ ((data bitShift: -5) bitAnd: 16r7F).	d3 _ ((data bitShift: 2) bitAnd: 16r7C).	msg at:1 put: (16rE0 + d1).	msg at:2 put: (16r80 + d2).	msg at:3 put: (16r00 + d3).	sendMessage _ String fromBytes: msg.	sendMessage _ 'REQSEND', sendMessage.Transcript show: 'D1: '; show: (msg at:1); cr.Transcript show: 'D2: '; show: (msg at:2); cr.Transcript show: 'D3: '; show: (msg at:3); cr.	socketCommand sendCommand: sendMessage.	socketCommand getResponseShowing: true.   "Waiting ACK"! !!SensorBoardMorph methodsFor: 'initialization' stamp: 'sk 4/15/2016 19:54'!clockDataSend: data subID: id	| msg d1 d2 d3 sendMessage |	(BoardType = 0) ifTrue: [		(self portIsOpen) ifFalse: [ ^0. ].]	ifFalse: [		(self socketIsOpen) ifFalse: [^0. ].].	msg _ #(0 0 0) asByteArray.	d1 _ ((data bitShift: -12) bitAnd: 16r0F).	d2 _ ((data bitShift: -5) bitAnd: 16r7F).	d3 _ ((data bitShift: 2) bitAnd: 16r7C).	msg at:1 put: (16rE0 + d1).	msg at:2 put: (16r80 + d2).	msg at:3 put: (16r00 + d3 + id).	sendMessage _ String fromBytes: msg.	sendMessage _ 'REQSEND', sendMessage.Transcript show: 'D1: '; show: (msg at:1); cr.Transcript show: 'D2: '; show: (msg at:2); cr.Transcript show: 'D3: '; show: (msg at:3); cr.	socketCommand sendCommand: sendMessage.	socketCommand getResponseShowing: true.   "Waiting ACK"! !!SensorBoardMorph methodsFor: 'initialization' stamp: 'sk 4/25/2016 12:45'!clockOnOff: val	| data |	data _ clock onoff: val.Transcript show: val; cr.	^  self clockDataSend: data subID: 1.! !!SensorBoardMorph methodsFor: 'initialization' stamp: 'sk 4/25/2016 12:33'!clockR: rVal G: gVal B: bVal	| data |	data _ clock red: rVal green: gVal blue: bVal.	^  self clockDataSend: data subID: 1.! !!SensorBoardMorph methodsFor: 'initialization' stamp: 'sk 6/8/2016 16:13'!initialize	super initialize.	sensorValues _ Array new: 16 withAll: 0.	currentState _ #idle.	highByte _ 0.	useGoGoProtocol ifNil: [useGoGoProtocol _ false].	scratchBoardV3 _ false.	reportRaw _ false.	scanState _ #off.	self addReadouts.	disconnected _ false.! !!SensorBoardMorph methodsFor: 'initialization' stamp: 'KK 8/27/2013 19:58'!selectPort:  portNum	self stopReadingData.	self openPort: portNum.	self startReadingData.	scanState _ #on.	ResetCounter _ 0.! !!SensorBoardMorph methodsFor: 'sensor ops' stamp: 'KK 8/29/2013 13:43'!privateSensor: t1 	| t2 t3 |	t2 _ (t1 asInteger max: 1)				min: readouts size."	useGoGoProtocol		ifFalse: [scratchBoardV3				ifTrue: [t2 _ #(8 6 7 4 5 3 2 1 ) at: t2]				ifFalse: [t2 _ #(1 2 3 4 5 6 7 8 9) at: t2]]."	t3 _ sensorValues at: t2.	reportRaw _ true.			" return Rawdata "	reportRaw ifTrue: [^ t3].	scratchBoardV3		ifTrue: 			[t2 = 6 ifTrue: [^ self scaleLight: t3].			t2 = 7 ifTrue: [^ self scaleSound: t3]].	t3 > 1020 ifTrue: [t3 _ 1023].! !!SensorBoardMorph methodsFor: 'stepping' stamp: 'sk 3/25/2016 20:53'!step	"Update my title and sensor readouts. If scanning for ports, keep scanning."	| frame i |	(BoardType = 0) ifTrue: [	#checkData = scanState ifTrue: [self scanForPort].	self portIsOpen		ifTrue: [self processIncomingData]		ifFalse: [port _ nil."Transcript show: '[SensorBoardMorph::setp] port is nil';cr."		].	]	ifFalse: [		self socketIsOpen ifTrue: [			self processIncomingData2]		ifFalse: [			port _ nil.			Transcript show: 'sb socket is not open.'; cr.	].].	self updateTitle."	1 to: 8 do: [:i |""	1 to: readouts size do: [:i |"	readouts do: [:item |		i _ readouts find: item.		(BoardType = 1 &  i = (readouts size)) ifTrue: [  " Only for Studuino mini Battery Voltage. "			item contents: (self privateSensor: i) printString]		ifFalse: [			item contents: (self privateSensor: i) truncated printString].		(scratchBoardV3 and: [i = 4])			ifTrue: [(readouts at: i) contents: ((self privateSensor: i) < 10) printString]. "button"		frame _ (readouts at: i) owner.		(frame respondsTo: #fixLayout) ifTrue: [frame fixLayout]].! !!SensorBoardMorph methodsFor: 'serial port' stamp: 'sk 6/8/2016 14:27'!closeForDisconnection	disconnected _ true.	currentState _ #idle.	sensorValues atAllPut: 0.	scratchBoardV3 _ false.	readouts do: [:elm | elm contents: '0'].	scanState _ #off.	self step.! !!SensorBoardMorph methodsFor: 'serial port' stamp: 'sk 6/8/2016 14:37'!closePort	port ifNotNil: [		self data:0 msgID:7.	"Send End of Communication to PC"		port flushInputBuffer.		port close].	port _ nil.	currentState _ #idle.	sensorValues atAllPut: 0.	scratchBoardV3 _ false.	readouts do: [:elm | elm contents: '0'].	scanState _ #off.	self step.! !!SensorBoardMorph methodsFor: 'serial port' stamp: 'sk 3/10/2016 19:55'!data: d msgID: id	"I make message and send it to board."	| mid high low msgh msgl msg carry sendMessage |	(BoardType = 0) ifTrue: [		(self portIsOpen) ifFalse: [ ^0. ].]	ifFalse: [		(self socketIsOpen) ifFalse: [^0. ].]."self halt."	mid _ id bitShift: 4.			 " mid = id << 4 "	high _ d bitShift: -8.		 " high = d >> 8""Transcript show:'high:'; show:high;cr."	carry _ d bitShift: -7.		 " low side carry = d >> 7""Transcript show:'carry:'; show:carry;cr."	carry _ carry bitAnd: 16r01.	 " carry = carry & 0x01""Transcript show:'carry:'; show:carry;cr."	high _ high + carry.		 " high = high + carry""Transcript show:'high:'; show:high;cr.""	high _ d bitShift: -7."	high _ high bitAnd: 16r0F.	" high = high & 0x0F"	low _ d bitAnd: 16r7F.		" low = d & 0x7F"	msgh _ 16r80 + mid + high.	" msgh = 0x80 + mid + high"	msgl _ low.					" msgl = low"	msg _ #(0 0) asByteArray.	msg at: 1 put:msgh.	msg at: 2 put: msgl.Transcriptshow:msgh;show:', ';show:msgl;cr.	(BoardType = 0) ifTrue: [		port nextPutAll: msg.]	ifFalse: [		sendMessage _ String fromBytes: msg.		sendMessage _ 'REQSEND', sendMessage.		socketCommand sendCommand: sendMessage.		"self stopStepping."		socketCommand getResponseShowing: true.   "Waiting ACK"		"self startStepping.""		socket sendCommand: 'REQSEND'.		socket sendCommand: (String fromBytes: msg)."].! !!SensorBoardMorph methodsFor: 'serial port' stamp: 'KK 8/9/2013 18:36'!openPort: aString	"Close the serial port if it is open, then open the port with the given name and initialize streaming of sensor data. Answer true if the operation was successful."	| baudRate portNum numStart |	baudRate _ useGoGoProtocol ifTrue: [9600] ifFalse: [38400].	self closePort.	portName _ aString.	ScratchPlugin serialPortOpsAvailable		ifTrue: [			port _ SerialPort2 new openPortNamed: portName baud: baudRate.			port isOpen ifFalse: [port _ nil. ^ false].			port setOption: 20 to: 1.  "set DTR high"			port setOption: 21 to: 0]  "set RTS low"		ifFalse: [			portNum _ 1.			numStart _ (1 to: portName size) detect: [:i | (portName at: i) isDigit] ifNone: [0].			numStart > 0 ifTrue: [portNum _ (portName copyFrom: numStart to: portName size) asNumber].			port _ SerialPort new				baudRate: baudRate;				inputFlowControlType: 2;				openPort: portNum ifFail: [^ false]].	"initialize polling state"	lastPollMSecs _ Time millisecondClockValue.	^ true! !!SensorBoardMorph methodsFor: 'serial port' stamp: 'sk 8/9/2016 15:51'!processIncomingData	"Process incoming bytes from the serial port."	"Details: To work around a problem with the Prolific USB-Serial drivers on some Windows machines, a strict turn-taking polling protocol is used. A poll byte is sent, the ScratchBoard sends a response, and after a small delay (to be sure that all the data from the last poll has arrived, another poll is sent. The goal is to never allow more that few bytes to accumulate in the serial input buffer and to avoid sending a poll byte while data is arriving. However, since different versions of the ScratchBoard may send different amounts of data, we don't want to hard-code the number of reply bytes. Thus"	| buf msecsSinceLastPoll |	(self portIsOpen and: [#on = scanState]) ifFalse: [^ self].	useGoGoProtocol ifTrue: [		buf _ port readByteArray.		buf do: [:b | self processGoGoByte: b].		^ self].	msecsSinceLastPoll _ Time millisecondClockValue - lastPollMSecs.	msecsSinceLastPoll < 20 ifTrue: [^ self].	buf _ port readByteArray.	(buf size = 0) ifTrue: [	" The case of disconnection "		" Increment ResetCounter "		ResetCounter _ (ResetCounter + 1).		(ResetCounter = 20) ifTrue: [			ResetCounter _ 0.			self closeForDisconnection.			ScratchFrameMorph displayMessageDialog: '33']]	ifFalse: [		ResetCounter _ 0].	buf do: [:b | self processScratchByte: b]."	port nextPut: 1."	"send a ScratchBoard V4 poll byte"	lastPollMSecs _ Time millisecondClockValue.! !!SensorBoardMorph methodsFor: 'serial port' stamp: 'sk 3/3/2016 12:08'!processIncomingData2	"Process incoming bytes from the socket."	| buf msecsSinceLastPoll |	(self socketIsOpen) ifFalse: [^ self].	msecsSinceLastPoll _ Time millisecondClockValue - lastPollMSecs.	msecsSinceLastPoll < 20 ifTrue: [^ self].	buf _ self readByteArrayFromSocket.	(buf size = 0) ifTrue: [	" The case of disconnection "		" Increment ResetCounter "		ResetCounter _ (ResetCounter + 1)."Transcript show:'[Reset counter]';show:ResetCounter;cr."		(ResetCounter = 20) ifTrue: [			ResetCounter _ 0.			self closeSocket.			ScratchFrameMorph displayMessageDialog: '33'.		].	] ifFalse: [		ResetCounter _ 0.	].	buf do: [:b |		self processScratchByte: b.Transcript show: b; cr.		]."	port nextPut: 1."	"send a ScratchBoard V4 poll byte"	lastPollMSecs _ Time millisecondClockValue.! !!SensorBoardMorph methodsFor: 'serial port' stamp: 'sk 3/9/2016 19:27'!readByteArrayFromSocket	"Answer a ByteArray read from this serial port. Answer an empty ByteArray if no data is available. The socket must be open."	| buf line res |	socket ifNil: [^ ByteArray new].	socket sendCommand: 'REQDATA'.	line _ socket getResponseShowing: true.	res _ line sansPeriodSuffix.	buf _ res asByteArray.	^ buf! !!SensorBoardMorph methodsFor: 'serial port' stamp: 'KK 9/9/2013 11:55'!resetPort	"If the port is closed, do nothing. If it is open, close and reopen it. This can be used to reset the Prolific USB serial driver if it misbehaves."	self portIsOpen ifFalse: [^ self].	portName ifNil: [^ self].Transcript show: '[SensorBoardMorph::resetPort] before closePort';cr.	self closePort.	self openPort: portName.	scanState _ #on."Transcript show: '[SensorBoardMorph::resetPort] before step';cr.	self step."! !!SensorBoardMorph methodsFor: 'serial port' stamp: 'KK 8/16/2013 14:41'!selectPort	| menu choice |	self stopReadingData.	self portNames size = 0 ifTrue: [^ DialogBoxMorph inform: 'No serial ports found'].	menu _ CustomMenu new.	self portNames do: [:n | menu add: n action: n].	choice _ menu startUp.	choice ifNil: [^ self].	self openPort: choice.	self startReadingData.	scanState _ #on.	ResetCounter _ 0.! !!SensorBoardMorph methodsFor: 'event handling' stamp: 'KK 9/21/2013 16:55'!rightButtonMenu	| |"	menu _ CustomMenu new.	Sensor shiftPressed		ifTrue: [			reportRaw				ifTrue: [menu add: 'stop reporting raw data' action: #toggleRawMode]				ifFalse: [menu add: 'report raw data' action: #toggleRawMode].			useGoGoProtocol				ifTrue: [menu add: 'use Scratch board' action: #useScratchboardProtocol]				ifFalse: [menu add: 'use GoGo board' action: #useGoGoProtocol]]		ifFalse: [			menu add: 'select serial/USB port' action: #selectPort.			self portIsOpen				ifTrue: [menu add: 'close port' action: #stopReadingData].			menu addLine.			menu add: 'hide' action: #delete].	menu localize; invokeOn: self."! !!SensorBoardMorph methodsFor: 'object i/o' stamp: 'sk 6/8/2016 14:26'!disconnected	^ disconnected! !!SensorBoardMorph methodsFor: 'object i/o' stamp: 'sk 6/8/2016 14:33'!disconnected: aBoolean	disconnected _ aBoolean.! !!SensorBoardMorph methodsFor: 'private' stamp: 'sk 3/24/2016 21:15'!closeSocket	| |socket ifNotNil: [	socketCommand sendCommand: 'BREAK'.	socketCommand disconnect.	socketCommand destroy.	socketCommand _ nil.	" Send message "	Transcript show: '---------- Sending ----------'; cr.	socket sendCommand: 'BREAK'.	socket disconnect.	socket destroy.	socket _ nil].	currentState _ #idle.	sensorValues atAllPut: 0.	scratchBoardV3 _ false."	1 to: 8 do: [:i | (readouts at: i) contents: '0']."	1 to: readouts size do: [:i | (readouts at: i) contents: '0'].	scanState _ #off.! !!SensorBoardMorph methodsFor: 'private' stamp: 'sk 3/11/2016 14:53'!isBoardSetup	"Answer true if a Arduino Board is connected to serial port."	| buf temp start timeOut |	temp _ port flushInputBuffer.	(temp = -1) ifTrue: [Transcript show:'error1';cr.		^ false.	].	buf _ port readByteArray.	(buf) ifNil: [Transcript show:'error2';cr.		^ false.	].	timeOut _ 4000.	start _ Time millisecondClockValue.	[buf size = 0] whileTrue: [		buf _ port readByteArray.		(buf) ifNil: [			^ false.		].		(Time millisecondClockValue - start > timeOut) ifTrue: [			Transcript show: 'Time out'; cr.			^ false].	].	^ true.! !!SensorBoardMorph methodsFor: 'private' stamp: 'sk 3/25/2016 21:08'!processScratchByte: aByte	"Process one byte of the incoming data stream from a Scratch sensor board."	"Sensor messages are two bytes with the following format:		Byte1: <1><sensor number (4 bits)><sensor value high bits (3 bits)>		Byte2: <0><sensor value low bits (7 bits)>"	| sensorNum val |"Transcriptshow:'processScratchByte';cr."	currentState = #idle ifTrue: [  "wait for first byte of message"		(aByte bitAnd: 16r80) > 0 ifTrue: [			currentState _ #firstByteSeen.			highByte _ aByte].		^ self].	currentState = #firstByteSeen ifTrue: [		(aByte bitAnd: 16r80) > 0 ifTrue: [  "must have lost second byte; stay in firstByteSeen state"			highByte _ aByte.			^ self].		"good second byte: report the sensor value"		sensorNum _ ((highByte bitShift: -3) bitAnd: 16rF) + 1.		val _ ((highByte bitAnd: 7) bitShift: 7) + (aByte bitAnd: 16r7F).(val = 128) ifTrue: ["Transcriptshow:'[SensorBoardMorph::processScratchByte:] ';show:sensorNum; show:', '; show:val;cr."^ self.].		(val = 128) ifTrue: [ val _ 0. ].	" 128 is open port or output parts "				(BoardType = 1) & (sensorNum = (readouts size)) ifTrue: [			val _ (val / 10.0)].		sensorNum <= sensorValues size ifTrue: [			sensorValues at: sensorNum put: val.			sensorNum = 16 ifTrue: [				(val == 3) | (val == 4) ifTrue: [					scratchBoardV3 _ true]]].  "ScratchBoard, version 3 or 4"		currentState _ #idle].! !!SensorBoardMorph methodsFor: 'private' stamp: 'KK 8/28/2013 08:51'!readByteArray	"Answer true if a GoGoBoard is connected to my serial port."	| buf |	port flushInputBuffer.	^ buf _ port readByteArray.! !!SensorBoardMorph methodsFor: 'private' stamp: 'sk 3/25/2016 20:17'!socket: mSocket	"Answer true if a GoGoBoard is connected to my serial port."	socket _ mSocket.	scanState _ #on.	"initialize polling state"	lastPollMSecs _ Time millisecondClockValue.! !!SensorBoardMorph methodsFor: 'private' stamp: 'sk 3/10/2016 19:52'!socketCommand: mSocket	socketCommand _ mSocket.! !!SensorBoardMorph methodsFor: 'private' stamp: 'sk 3/3/2016 10:49'!socketIsOpen	^ socket notNil! !!SensorBoardMorph methodsFor: 'private' stamp: 'KK 9/21/2013 17:04'!updateTitle	"Update my title to reflect the current protocol and port number."	| s |	s _ (#on = scanState) ifTrue: ['Sensor Board' localized] ifFalse: ['Off' localized].	s = titleMorph contents ifFalse: [titleMorph contents: s].! !!SerialPort methodsFor: 'input/output' stamp: 'KK 8/9/2013 19:00'!readByteArray	"Answer a ByteArray read from this serial port. Answer an empty ByteArray if no data is available. The port must be open."	| buf count |	buf _ ByteArray new: 2000.	count _ self primReadPort: port into: buf startingAt: 1 count: buf size.	count <= 0 ifTrue: [^ ByteArray new].	^ buf copyFrom: 1 to: count! !!SerialPort2 methodsFor: 'input/output' stamp: 'KK 8/28/2013 08:34'!nextPutAll: aStringOrByteArray	"Send the given bytes out this serial port. The port must be open."	self isOpen ifFalse: [^ self].	ScratchPlugin writePort: portNum data: aStringOrByteArray.! !!SerialPort2 methodsFor: 'input/output' stamp: 'KK 9/6/2013 11:49'!readByteArray	"Answer a ByteArray read from this serial port. Answer an empty ByteArray if no data is available. The port must be open."	| buf count |	self isOpen ifFalse: [^ ByteArray new].	buf _ ByteArray new: 2000.	count _ ScratchPlugin readPort: portNum into: buf.	count <= 0 ifTrue: [^ ByteArray new].	^ buf copyFrom: 1 to: count! !!SetterBlockMorph methodsFor: 'initialization' stamp: 'KK 9/18/2013 19:10'!initSetterForVar: varName	self commandSpec: (ScratchTranslator translationFor: 'set %v to %n').	argPermutation _ CommandBlockMorph argPermutationForSpec: 'set %v to %n' withTranslation: commandSpec.	self selector: #setVar:to:.	self variable: varName.! !!SimpleClientSocket methodsFor: 'entry points' stamp: 'sk 7/29/2016 17:38'!getBMResponse	^ self getBMResponseFor: 30! !!SimpleClientSocket methodsFor: 'entry points' stamp: 'sk 7/29/2016 17:28'!getBMResponseFor: seconds	| line idx |	line _ WriteStream on: String new.	buffer ifNil: [		buffer _ String new.		bufferPos _ 0 ].	[		"look for a LF in the buffer"		idx _ buffer indexOf: Character lf startingAt: bufferPos+1 ifAbsent: [ 0 ].		idx > 0 ifTrue: [			"found it!! we have a line"			line nextPutAll: (buffer copyFrom: bufferPos+1 to: idx-1).			bufferPos _ idx.			^line contents ].				"didn't find it.  add the whole buffer to the line, and retrieve some more data"		line nextPutAll: (buffer copyFrom: bufferPos+1 to: buffer size).		bufferPos _ 0.		buffer _ String new.		(self waitForBMMessageEvery: seconds) ifTrue: [			buffer _ self getData.		] ifFalse: [			^ '-1'.		].		true	] whileTrue.! !!SimpleClientSocket methodsFor: 'private' stamp: 'sk 7/27/2016 19:04'!waitForBMMessageEvery: seconds	"Wait for data to arrive, asking the user periodically if they wish to keep waiting. If they don't wish to keep waiting, destroy the socket and raise an error."	| gotData |	gotData _ false.	[gotData]		whileFalse: [			gotData _ self waitForDataUntil: (Socket deadlineSecs: seconds).			gotData ifFalse: [				self isConnected ifFalse: [					self destroy.					"self error: 'server closed connection'."					ScratchFrameMorph displayMessageDialog: '12'." Display error message dialog "					^ false.				] ifTrue: [					self destroy.					"self error: 'no response from server'"					ScratchFrameMorph displayMessageDialog: '11'." Display error message dialog "					^ false.				].			]		].	^ true.! !!SpriteArgMorph methodsFor: 'other' stamp: 'KK 8/2/2013 12:59'!printArduArgOn: aStream	"Print this argument morph on the given stream."	aStream nextPutAll: 's['.	aStream nextPutAll: self labelMorph contents.	aStream nextPut: $].! !!SpriteArgMorph methodsFor: 'other' stamp: 'KK 8/2/2013 13:01'!printArgOn: aStream	"Print this argument morph on the given stream."	aStream nextPutAll: self labelMorph contents.! !!StandardFileStream class methodsFor: 'file creation' stamp: 'KK 8/21/2013 15:01'!newScratchFileNamed: fileName	"Create a new file with the given name, and answer a stream opened for writing on that file. If the file already exists, ask the user what to do."	| dir localName choice newName fullName result ext |	fullName _ self fullName: fileName.	(self isAFileNamed: fullName) ifFalse: [		result _ self new open: fullName forWrite: true.		result ifNil: [DialogBoxMorph inform: 'Could not write file' withDetails: 'Is the folder read-only?' localized].		^ result].	"file already exists:"	dir _ FileDirectory forFileName: fullName.	localName _ FileDirectory localNameFor: fullName.	choice _ DialogBoxMorph		askWithCancel: 'The file name already exists. Overwrite existing file?'.	choice = #cancelled ifTrue: [^ nil].	choice		ifTrue: [			dir deleteFileNamed: localName ifAbsent: [].			result _ self new open: fullName forWrite: true.			result ifNil: [DialogBoxMorph inform: 'Could not write file' withDetails: 'Is the folder read-only?' localized].			^ result]		ifFalse: [			newName _ StringDialog askWithCancel: 'New file name?'.			newName size = 0 ifTrue: [^ nil].			fullName _ dir fullNameFor: newName.			ext _ FileDirectory extensionFor: fileName.			(ext size > 0 and: [(newName endsWith: ext) not]) ifTrue: [				fullName _ fullName, '.', ext].			^ self newScratchFileNamed: fullName].! !!CrLfFileStream class methodsFor: 'class initialization' stamp: 'KK 1/7/2015 17:23'!newScratchFileNamed: fileName	"Create a new file with the given name, and answer a stream opened for writing on that file. If the file already exists, ask the user what to do."	| dir localName choice newName fullName result ext |	fullName _ self fullName: fileName.	(self isAFileNamed: fullName) ifFalse: [		result _ self new open: fullName forWrite: true.		result ifNil: [DialogBoxMorph inform: 'Could not write file' withDetails: 'Is the folder read-only?' localized].		^ result].	"file already exists:"	dir _ FileDirectory forFileName: fullName.	localName _ FileDirectory localNameFor: fullName.	choice _ DialogBoxMorph		askWithCancel: 'The file name already exists. Overwrite existing file?'.	choice = #cancelled ifTrue: [^ nil].	choice		ifTrue: [			dir deleteFileNamed: localName ifAbsent: [].			result _ self new open: fullName forWrite: true.			result ifNil: [DialogBoxMorph inform: 'Could not write file' withDetails: 'Is the folder read-only?' localized].			^ result]		ifFalse: [			newName _ StringDialog askWithCancel: 'New file name?'.			newName size = 0 ifTrue: [^ nil].			fullName _ dir fullNameFor: newName.			ext _ FileDirectory extensionFor: fileName.			(ext size > 0 and: [(newName endsWith: ext) not]) ifTrue: [				fullName _ fullName, '.', ext].			^ self newScratchFileNamed: fullName].! !!StringDialog methodsFor: 'initialization' stamp: 'KK 9/1/2014 12:01'!initialize	"Similar to my superclass, but with a string field for the user's response."	super initialize.	self title: '?'.	"create and position typeinMorph"	ValueOrList ifTrue: [	" Value or list "		mainColumn			addMorph: (Morph new extent: (5@6); color: Color transparent);			addMorph: (typeinMorph _ AlphamericFieldMorph				new client: self;				borderWidth: 2;				color: (Color r: (211/255) g: (214/255) b: (216/255)));			addMorph: (Morph new extent: (5@6); color: Color transparent).	] ifFalse: [	" Not value or list "		mainColumn			addMorph: (Morph new extent: (5@6); color: Color transparent);			addMorph: (typeinMorph _ StringFieldMorph				new client: self;				borderWidth: 2;				color: (Color r: (211/255) g: (214/255) b: (216/255)));			addMorph: (Morph new extent: (5@6); color: Color transparent).	].		typeinMorph		font: (ScratchFrameMorph getFont: #StringDialogTypeIn);		width: 250.	tabFields add: typeinMorph.! !!StringDialog class methodsFor: 'instance creation' stamp: 'KK 9/1/2014 11:39'!ask: questionString	"Put up an instance of me to ask the user for string input (such as file name). Answer the edited string."	^ self askWithCancel: questionString initialAnswer: ''! !!StringDialog class methodsFor: 'instance creation' stamp: 'KK 9/1/2014 11:39'!ask: questionString initialAnswer: aString	"Put up an instance of me to ask the user for string input (such as file name). The initial response text is set to the given string, which the user can replace or edit. Answer the edited string."	| dialogBox |	dialogBox _ self new		withButtonsForYes: false no: false okay: true cancel: false;		message: questionString;		initialAnswer: aString.	^ dialogBox getUserResponse! !!StringDialog class methodsFor: 'instance creation' stamp: 'KK 9/1/2014 11:39'!askWithCancel: questionString	"Like ask:, but with a cancel button. Answer the empty string if cancelled."	^ self askWithCancel: questionString initialAnswer: ''! !!StringDialog class methodsFor: 'instance creation' stamp: 'KK 12/17/2013 18:02'!askWithCancel: questionString initialAnswer: aString	"Put up an instance of me to ask the user for string input (such as file name). The initial response text is set to the given string, which the user can replace or edit. This version includes a cancel button. Answer the empty string if cancelled."	| dialogBox |	dialogBox _ self new		withButtonsForYes: false no: false okay: true cancel: true;		message: questionString;		initialAnswer: aString.	^ dialogBox getUserResponse! !!StringFieldMorph methodsFor: 'event handling' stamp: 'KK 5/12/2014 17:00'!keyStroke: evt	| ch m |	ch _ evt unicodeChar.	ch = 0 ifTrue: [ch _ evt keyValue].	evt buttons = 64 ifTrue: [ch _ ch \\ 32].  "command (alt) key pressed; map to a control key"	(ch = 3) & (evt buttons = 0) ifTrue: [ch _ 13].  "map enter key to cr"	ch = 9 ifTrue: [  "tab"		(m _ self ownerThatIsA: DialogBoxMorph) ifNotNil: [m tabToNextField: evt].		(m _ self ownerThatIsA: CommandBlockMorph) ifNotNil: [m tabToNextField: evt].		^ self].	(ch = 10) | (ch = 13) ifTrue: [  "cr, lf, or enter key"		(m _ self ownerThatIsA: DialogBoxMorph) ifNotNil: [^ m enterKeyPressed: evt].		(m _ self ownerThatIsA: ScratchPrompterMorph) ifNotNil: [^ m enterKeyPressed].		(m _ self ownerThatIsA: NumericUpDownMorph) ifNotNil: [ ^ m enterKeyPressed].		evt hand newKeyboardFocus: nil.		^ self].	ch = 27 ifTrue: [  "escape key"		(m _ self ownerThatIsA: DialogBoxMorph) ifNotNil: [m escapeKeyPressed: evt].		^ self].	ch = 8 ifTrue: [^ self backspace].	ch = 127 ifTrue: [^ self deleteSelection].	(evt buttons = 64) | (evt buttons = 16) ifTrue: [	"ctrl (or alt) is pressed"		ch = 1 ifTrue: [self selectAll].		"ctrl-a"		ch = 3 ifTrue: [self copySelection]. 	"ctrl-c"		ch = 22 ifTrue: [self paste].			"ctrl-v"		ch = 24 ifTrue: [self cutSelection].	"ctrl-x"		ch = 26 ifTrue: [self undo]].			"ctrl-z"	evt buttons = 8 ifTrue: [ "shift is pressed"		ch = 28 ifTrue: [self moveCursorLeftAndSelect].  	"shift-left"		ch = 29 ifTrue: [self moveCursorRightAndSelect].	"shift-right"		ch = 1 ifTrue: [self moveCursorHomeAndSelect].	"home"		ch = 4 ifTrue: [self moveCursorEndAndSelect]].	"end"	evt buttons = 0 ifTrue: [		ch = 1 ifTrue: [self moveCursorHome].	"home"		ch = 4 ifTrue: [self moveCursorEnd].		"end"		ch = 28 ifTrue: [self moveCursorLeft].	"left"		ch = 29 ifTrue: [self moveCursorRight].	"right"		blinkState _ true].	ch >= 32 ifTrue: [self insertCharacter: ch].! !!AlphamericFieldMorph methodsFor: 'event handling' stamp: 'KK 9/17/2014 11:19'!keyStroke: evt	| ch m |	ch _ evt unicodeChar.	ch = 9 ifTrue: [  "tab"		(m _ self ownerThatIsA: DialogBoxMorph) ifNotNil: [m tabToNextField: evt].		(m _ self ownerThatIsA: CommandBlockMorph) ifNotNil: [m tabToNextField: evt].		^ self].	(ch = 10) | (ch = 13) ifTrue: [  "cr, lf, or enter key"		(m _ self ownerThatIsA: DialogBoxMorph) ifNotNil: [^ m enterKeyPressed: evt].		(m _ self ownerThatIsA: ScratchPrompterMorph) ifNotNil: [^ m enterKeyPressed].		(m _ self ownerThatIsA: NumericUpDownMorph) ifNotNil: [ ^ m enterKeyPressed].		evt hand newKeyboardFocus: nil.		^ self].	ch = 27 ifTrue: [  "escape key"		(m _ self ownerThatIsA: DialogBoxMorph) ifNotNil: [m escapeKeyPressed: evt].		^ self].	ch = 8 ifTrue: [^ self backspace].	ch = 127 ifTrue: [^ self deleteSelection].	(evt buttons = 64) | (evt buttons = 16) ifTrue: [	"ctrl (or alt) is pressed"		ch = 1 ifTrue: [self selectAll].		"ctrl-a"		ch = 3 ifTrue: [self copySelection]. 	"ctrl-c"		ch = 22 ifTrue: [self paste].			"ctrl-v"		ch = 24 ifTrue: [self cutSelection].	"ctrl-x"		ch = 26 ifTrue: [self undo]].			"ctrl-z"	evt buttons = 8 ifTrue: [ "shift is pressed"		ch = 28 ifTrue: [self moveCursorLeftAndSelect].  	"shift-left"		ch = 29 ifTrue: [self moveCursorRightAndSelect].	"shift-right"		ch = 1 ifTrue: [self moveCursorHomeAndSelect].	"home"		ch = 4 ifTrue: [self moveCursorEndAndSelect]].	"end"	evt buttons = 0 ifTrue: [		ch = 1 ifTrue: [self moveCursorHome].	"home"		ch = 4 ifTrue: [self moveCursorEnd].		"end"		ch = 28 ifTrue: [self moveCursorLeft].	"left"		ch = 29 ifTrue: [self moveCursorRight].	"right"		blinkState _ true].	" ch = [0-9][A-Z][a-z][_] ? "	( ((ch >= 48) & (ch <= 57)) | ((ch >= 65) & (ch <= 90)) | ((ch >= 97) & (ch <= 122)) | ((ch = 95))) ifFalse: [		^ self.	].	ch = 0 ifTrue: [ch _ evt keyValue].	evt buttons = 64 ifTrue: [ch _ ch \\ 32].  "command (alt) key pressed; map to a control key"	(ch = 3) & (evt buttons = 0) ifTrue: [ch _ 13].  "map enter key to cr"	ch >= 32 ifTrue: [self insertCharacter: ch].! !!TextMorph methodsFor: 'editing' stamp: 'KK 8/30/2013 19:37'!handleInteraction: interactionBlock fromEvent: evt        | oldEditor oldParagraph |        "Perform the changes in interactionBlock, noting any change in selection"        "Also couple ParagraphEditor to Morphic keyboard events"        self editor sensor: (KeyboardBuffer new startingEvent: evt).        oldEditor _ editor.        oldParagraph _ paragraph.        self selectionChanged.  "Note old selection"                interactionBlock value.        oldParagraph == paragraph ifTrue: [     "this will not work if the paragraph changed"                editor _ oldEditor.     "since it may have been changed while in block"        ].        self selectionChanged.  "Note new selection"! !!ToggleButton methodsFor: 'event handling' stamp: 'sk 8/24/2015 17:00'!handlesMouseOver: evt	^ true! !!WatcherMorph methodsFor: 'private' stamp: 'KK 8/30/2013 20:16'!translatedName	"Answer the name for this watcher based on my selector and argument. The names of reporters are translated into the current language. The names of variables are left untouched."	| sel spec result param |	readout target ifNil: [^ 'xxx'].	sel _ readout getSelector.	#getVar: = sel ifTrue: [^ readout parameter].	spec _ readout target blockSpecForSelector: sel.	spec ifNil: [^ sel].	result _ ScratchTranslator translationFor: spec.	param _ readout parameter.	param ifNil: [param _ ''].	#sensor: = sel ifTrue: [		result _ self replace: '%H' with: (ScratchTranslator translationFor: param) in: result].	#sensorPressed: = sel ifTrue: [		result _ self replace: '%h' with: (ScratchTranslator translationFor: param) in: result].	^ result! !DialogBoxMorph subclass: #StringDialog	instanceVariableNames: 'typeinMorph '	classVariableNames: ''	poolDictionaries: ''	category: 'Scratch-UI-Dialogs'!Morph subclass: #SensorBoardMorph	instanceVariableNames: 'socket socketCommand column titleMorph portName port readouts sensorValues currentState highByte useGoGoProtocol scratchBoardV3 reportRaw scanPorts scanState scanStartMSecs lastPollMSecs clock disconnected '	classVariableNames: ''	poolDictionaries: ''	category: 'Scratch-UI-Panes'!ScriptableScratchMorph subclass: #ScratchStageMorph	instanceVariableNames: 'zoom hPan vPan penTrailsForm lastPenPositions runningBlocks inProcessStep sensorBoard servoCalibrationBoard midiPortNum midiPort notePlayerDict obsoleteSavedState sprites scratchServer isQuarterSize cachedForm showMotorBlocks '	classVariableNames: ''	poolDictionaries: ''	category: 'Scratch-Objects'!StringMorph subclass: #ScratchMenuTitleMorph	instanceVariableNames: 'target selector '	classVariableNames: 'MenuBarIsActive MenuEnable '	poolDictionaries: ''	category: 'Scratch-UI-Support'!ScratchFrameMorph initialize!NumericUpDownMorph initialize!"Postscript:Leave the line above, and replace the rest of this comment by a useful one.Executable statements should follow this comment, and shouldbe separated by periods, with no exclamation points (!!).Be sure to put any further comments in double-quotes, like this one."" Global Variables "Smalltalk at: #BoardType put: 0.ScratchFrameMorph readSkinFrom:(FileDirectory default directoryNamed: 'ScratchSkin').ScriptableScratchMorph buildBlockSpecDictionary.Smalltalk at: #DuringTest put: false.Smalltalk at: #DuringCalib put: false.Smalltalk at: #SvCalib put: nil.Smalltalk at: #DCCalib put: nil.Smalltalk at: #IOPort put: nil.IOPort ifNil: [	IOPort _ Array new:18.].Smalltalk at: #SvDegree put: nil.Smalltalk at: #SvDegreeTemp put: nil.Smalltalk at: #SvSentAlready put: nil.Smalltalk at: #ServomotorSynchroMotion put: false.Smalltalk at: #ResetCounter put: 0.!