'From MIT Squeak 0.9.4 (June 1, 2003) [No updates present.] on 8 March 2018 at 10:00:13 am'!Object subclass: #ColorClock	instanceVariableNames: 'red green blue onoff isSounding buzzerStartTime buzzerDuration '	classVariableNames: ''	poolDictionaries: ''	category: 'Studuino'!Object subclass: #DataCreation	instanceVariableNames: ''	classVariableNames: ''	poolDictionaries: ''	category: 'Studuino'!DataCreation class	instanceVariableNames: ''!Object subclass: #ErrorMessage	instanceVariableNames: ''	classVariableNames: ''	poolDictionaries: ''	category: 'Studuino'!ChoiceArgMorph subclass: #ChoiceArgMorphForStuduino	instanceVariableNames: 'isValid '	classVariableNames: 'FieldWidth '	poolDictionaries: ''	category: 'Scratch-Blocks'!Morph subclass: #ConfigureBoardMorph	instanceVariableNames: 'column titleMorph portName port readouts sensorValues currentState highByte useGoGoProtocol scratchBoardV3 reportRaw scanPorts scanState scanStartMSecs lastPollMSecs '	classVariableNames: ''	poolDictionaries: ''	category: 'Scratch-UI-Panes'!Smalltalk renameClassNamed: #DCSliderMorph2 as: #DCSliderMorph2!SimpleSliderMorph subclass: #DCSliderMorph2	instanceVariableNames: 'portName display '	classVariableNames: ''	poolDictionaries: ''	category: 'Studuino'!ImageFrameMorph subclass: #DividedImageFrameMorph	instanceVariableNames: 'topSectionHeight middleBarForm leftJointForm rightJointForm leftMargin rightMargin '	classVariableNames: ''	poolDictionaries: ''	category: 'Scratch-UI-Support'!Morph subclass: #KeyPadMorph	instanceVariableNames: 'buttons lastContents targetField '	classVariableNames: 'BaseColor ButtonColor ButtonSize FontColor '	poolDictionaries: ''	category: 'Studuino'!KeyPadMorph class	instanceVariableNames: ''!Smalltalk renameClassNamed: #MotorCalibMorph as: #MotorCalibMorphNotUse!Morph subclass: #MotorCalibMorphNotUse	instanceVariableNames: 'column titleMorph readouts '	classVariableNames: 'Boxes DCSliderMorph Sliders '	poolDictionaries: ''	category: 'Studuino'!Object subclass: #NotificationMessage	instanceVariableNames: ''	classVariableNames: ''	poolDictionaries: ''	category: 'Studuino'!ExpressionArgMorph subclass: #NumericUpDownMorph	instanceVariableNames: 'menuMorph getMenuSelector specialValue downMorph valid upMorph minimum maximum upButtonOn downButtonOn buttons '	classVariableNames: 'DownForm UpForm '	poolDictionaries: ''	category: 'Scratch-Blocks'!NumericUpDownMorph class	instanceVariableNames: ''!ChoiceArgMorph subclass: #PathSettingArgMorph	instanceVariableNames: ''	classVariableNames: 'DefaultPath '	poolDictionaries: ''	category: 'Scratch-Blocks'!PathSettingArgMorph class	instanceVariableNames: ''!Morph subclass: #PinAssignMorph	instanceVariableNames: 'column column1 column2 titleMorph readouts motorButtonPAArea sensorPAArea pinInfo buttonTitleMorph servoTitleMorph sensorTitleMorph dcTitleMorph pinAssignTemporary frameMorph selectedBT selectedIR done response '	classVariableNames: 'BA0Index BA1Index BA2Index BA3Index Boxes SA0Index SA1Index SA2Index SA3Index SA4Index SA5Index SA6Index SA7Index '	poolDictionaries: ''	category: 'Studuino'!DialogBoxMorph subclass: #ScratchFileChooserDialog	instanceVariableNames: 'scratchFrame list choosingFolder newFileTitle newFileName thumbnailFrameMorph thumbnailMorph authorLabelMorph authorMorph commentLabelMorph commentMorph readingScratchFile type newTitleBin fCursorOut '	classVariableNames: 'LastFolderForType UserHomeFolder '	poolDictionaries: ''	category: 'Scratch-UI-Dialogs'!Morph subclass: #ScratchFrameMorph	instanceVariableNames: 'topPane viewerPane scriptsPane stageFrame workPane titlePane libraryPane menuPanel stageButtonsPanel readoutPane logoMorph projectTitleMorph flagButton fillScreenFlag paintingInProgress projectDirectory projectName projectInfo author loginName loginPassword watcherPositions shuffledCostumeNames justSaved viewModeButtons viewMode lastViewMode viewModeButtonsPanel toolbarPanel lastWeDoPoll paBoard usbConnectionStatus fontButtons versionConflict usbCSPanel serverProcess keyPad '	classVariableNames: 'BoardStatus COMPort Clipboard DefaultNotes DefaultSprite Fonts FontsXO IsXO LangDic NewScratchProject ScratchServers ScratchSkin ScratchSkinXO TakeOverScreen UseErrorCatcher Version VersionDate VisibleDrives WorkpaneExtent DefaultArduinoSprite '	poolDictionaries: ''	category: 'Scratch-UI-Panes'!DividedImageFrameMorph subclass: #ScratchLibraryMorph	instanceVariableNames: 'scrollPane stagePane thumbWidth itemExtent spritePane buttonPane spriteLabel '	classVariableNames: ''	poolDictionaries: ''	category: 'Scratch-UI-Panes'!StringMorph subclass: #ScratchMenuTitleMorph	instanceVariableNames: 'target selector '	classVariableNames: 'Enable MenuBarIsActive MenuEnable '	poolDictionaries: ''	category: 'Scratch-UI-Support'!Object subclass: #ScratchProcess	instanceVariableNames: 'stackFrame topBlock readyToYield errorFlag readyToTerminate '	classVariableNames: 'BlockHighlightMSecs PrevBlock Times '	poolDictionaries: ''	category: 'Scratch-Execution Engine'!DividedImageFrameMorph subclass: #ScratchScriptEditorMorph	instanceVariableNames: 'thumbnailMorph nameMorph pageViewerMorph rotationButtons lockButton readoutMorphs penReadout currentCategory tabPaneMorph deleteButton '	classVariableNames: ''	poolDictionaries: ''	category: 'Scratch-UI-Panes'!!ScratchScriptEditorMorph commentStamp: '<historical>' prior: 0!I am a viewer for the scripts and media closet of a Scratch object. I have a heading row containing the object name (editable) and a drop-down menu icon. Below that is a scrollable content area.!Morph subclass: #ScriptableScratchMorph	instanceVariableNames: 'objName vars lists blocksBin isClone media costume costumeChangeMSecs filterPack visibility volume tempoBPM sceneStates '	classVariableNames: 'BlockColorDict BlockSpecDict DefaultBackgroundForm DefaultSpriteForm DoubleSize Experimental ListBlockColor MeowSound NumberOfdoRepeat OldMeowPrefixReversed PopSound RandomGen Recorder ScratchOrigin TimerStartMSecs '	poolDictionaries: ''	category: 'Scratch-Objects'!ScratchSpriteMorph subclass: #ArduinoScratchSpriteMorph	instanceVariableNames: 'arduinoBoard '	classVariableNames: ''	poolDictionaries: ''	category: 'StuduinoSprite'!ScriptableScratchMorph subclass: #ScratchStageMorph	instanceVariableNames: 'zoom hPan vPan penTrailsForm lastPenPositions runningBlocks inProcessStep sensorBoard midiPortNum midiPort notePlayerDict obsoleteSavedState sprites scratchServer isQuarterSize cachedForm showMotorBlocks arduinoBoards arduinoSprites showStuduinoBlocks studuinoBoard motorCalibBoard servoCalibrationBoard '	classVariableNames: ''	poolDictionaries: ''	category: 'Scratch-Objects'!ArduinoScratchSpriteMorph class	instanceVariableNames: ''!Morph subclass: #SensorBoardMorph	instanceVariableNames: 'column titleMorph portName port readouts sensorValues currentState highByte useGoGoProtocol scratchBoardV3 reportRaw scanPorts scanState scanStartMSecs lastPollMSecs '	classVariableNames: ''	poolDictionaries: ''	category: 'Scratch-UI-Panes'!!SensorBoardMorph commentStamp: '<historical>' prior: 0!I represent the Squeak interface to a sensor board connected via a serial port. One such board, the Scratch Board, has 8 10-bit sensor inputs capable of reading switches or resistive sensors. Another alternative, the GoGoBoard, has 8 10-bit sensors inputs plus three motor control ports. See http://learning.media.mit.edu/projects/gogo/ for additional info about the GoGo board.To create an instance of me:	SensorBoardMorph open(Note: You can only have one instance of me for each serial port that has a Scratch or GoGo board attached.)Use the menu to choose the serial port. When you're done, you can use the menu to close the serial port.------------------------------------------------------Scratch Sensor Board Serial ProtocolWhen the sensor board is powered up or reset, it immediately begins sendingsensor data. Sensor data is sent as two byte messages, one message for eachof the available sensors. The first byte supplies the sensor number and thehigh 3 bits of the sensor value. The second byte supplies the low 7 bitsof the sensor value. The values of all the available sensors are sent inthis format, followed by a pause of two full byte transmission times, thenthe entire cycle repeats. The pause allows the receiver's UART to regainsynchronization in the rare event that it is lost.Here is the byte format for the two bytes:  Byte1: <1><sensor number (4 bits)><sensor value high bits (3 bits)>  Byte2: <0><sensor value low bits (7 bits)>Note that the most significant bit is one for the first byte of a pairand zero for the second. This allows the receiver to tell if a givenbyte is the first or second byte of a message.Sensor board have various numbers of sensors. A given board with N sensorswill cycle through sensors numbers 0 through N-1, then repeat. For example,a four-sensor board would send data for sensors 0 through 3. Up to sixteensensors can be handled by this protocol.Sensor values should be normalized to fit a 10-bit, unsigned integer range.That is, sensor values should range from 0 to ~1023. For example, if a givensensor board only collects 8-bit values, these values should be shifted leftby two bits so that the maximum value is 1020. Likewise, a board that readsover 10-bits of sensor resolution should shift its sensor values right sothat only the 10 most-significant bits of the data are sent.The serial port should be set to 38.4 kbaud, one start bit, one stop bit,and no parity.------------------------------------------------------!Morph subclass: #ServoCalibrateMorph	instanceVariableNames: 'column titleMorph portName port readouts sensorValues currentState highByte useGoGoProtocol scratchBoardV3 reportRaw scanPorts scanState scanStartMSecs lastPollMSecs '	classVariableNames: ''	poolDictionaries: ''	category: 'Scratch-UI-Panes'!Object subclass: #SettingMenu	instanceVariableNames: 'diag boxes '	classVariableNames: ''	poolDictionaries: ''	category: 'Studuino'!SettingMenu class	instanceVariableNames: ''!SimpleClientSocket subclass: #SimpleUCDClientSocket	instanceVariableNames: ''	classVariableNames: ''	poolDictionaries: ''	category: 'Network-Kernel'!DialogBoxMorph subclass: #StringDialog	instanceVariableNames: 'typeinMorph '	classVariableNames: 'ValueOrListName '	poolDictionaries: ''	category: 'Scratch-UI-Dialogs'!StringFieldMorph subclass: #AlphamericFieldMorph	instanceVariableNames: ''	classVariableNames: ''	poolDictionaries: ''	category: 'Scratch-UI-Dialogs'!Smalltalk renameClassNamed: #StuduinoSensorBoardMorph as: #StuduinoSensorBoardMorph!SensorBoardMorph subclass: #StuduinoSensorBoardMorph	instanceVariableNames: 'socket socketCommand clock disconnected resCommand onSyncServo lockSend lockSync retrySend timeoutSend servoMotorBlockFIFO listTempBuf processDummySend secondByte thirdByte '	classVariableNames: ''	poolDictionaries: ''	category: 'Studuino'!StuduinoSensorBoardMorph subclass: #MotorCalibMorph2	instanceVariableNames: 'kindOfAck sketchActivation dcMotorCalibArea '	classVariableNames: 'Boxes BoxesTemp DCButtons DCCalibStatus DCMotorStatus DCSliderMorph DecisionButtons ServoMotorField SliderValueTemp Sliders '	poolDictionaries: ''	category: 'Studuino'!Object subclass: #TemperatureSensor	instanceVariableNames: 'buffer currentPos isRounded total ave '	classVariableNames: ''	poolDictionaries: ''	category: 'Studuino'!TemperatureSensor class	instanceVariableNames: ''!ToggleButton subclass: #ToggleImage	instanceVariableNames: ''	classVariableNames: ''	poolDictionaries: ''	category: 'Studuino'!!Object methodsFor: 'error handling' stamp: 'KK 10/8/2013 19:19'!doesNotUnderstand: aMessage 	 "Error: an attempt was made to send the given message but the receiver does not understand this message. This message is sent by the virtual machine when a message is sent to an object that does not define a method for the message selector."	"Example: 3 width"	(aMessage selector = #flushInputBuffer) ifTrue: [		^ -1.	].	(aMessage selector = #readByteArray) ifTrue: [		^ nil.	]	ifFalse: [		self error: 'Message not understood: ', aMessage selector.		^ aMessage sentTo: self	].! !!ColorClock methodsFor: 'initialization' stamp: 'sk 4/25/2016 14:49'!initialize	"comment stating purpose of message"	red _ 15.	green _ 15.	blue _ 15.	onoff _ 0.	isSounding _ false.! !!ColorClock methodsFor: 'initialization' stamp: 'sk 4/25/2016 18:34'!isElapsed	(buzzerDuration < ((Time millisecondClockValue) - buzzerStartTime)) ifTrue: [		isSounding _ false.		^ true].	^ false! !!ColorClock methodsFor: 'initialization' stamp: 'sk 4/25/2016 15:54'!isSounding	^ isSounding! !!ColorClock methodsFor: 'initialization' stamp: 'sk 4/25/2016 11:54'!onoff: val	"comment stating purpose of message"	onoff _ val.	^ self testModeData! !!ColorClock methodsFor: 'initialization' stamp: 'sk 4/25/2016 11:54'!red: rVal green: gVal blue: bVal	"comment stating purpose of message"	red _ rVal.	green _ gVal.	blue _ bVal.	^ self testModeData! !!ColorClock methodsFor: 'initialization' stamp: 'sk 4/25/2016 14:51'!startBuzzer	"comment stating purpose of message"	isSounding _ true.	buzzerStartTime _ Time millisecondClockValue.! !!ColorClock methodsFor: 'initialization' stamp: 'sk 4/25/2016 18:31'!startBuzzerFor: time	"comment stating purpose of message"	isSounding _ true.	buzzerStartTime _ Time millisecondClockValue.	buzzerDuration _ time * 1000.! !!ColorClock methodsFor: 'initialization' stamp: 'sk 4/25/2016 12:47'!testModeData	"comment stating purpose of message"Transcript show: 'ONOFF: '; show: onoff; cr.	^ (onoff bitShift: 15) + (green bitShift: 8) + (red bitShift: 4)  + blue.! !!CustomMenu methodsFor: 'private' stamp: 'KK 7/31/2017 19:13'!preSelect: action	"Pre-select and highlight the menu item associated with the given action."	| i |	i _ selections indexOf: action ifAbsent: [^ self].	marker ifNil: [self computeForm].	marker _ marker		align: marker topLeft		with: (marker left)@(frame inside top + (marker height * (i - 1))).	selection _ i.! !!DataCreation class methodsFor: 'as yet unclassified' stamp: 'sk 5/17/2017 15:51'!getServoFor: pin degree: aValue	| deg |	deg _ aValue.	(aValue > 180) ifTrue: [deg _ 180].	(aValue < 0) ifTrue: [deg _ 0].	^ (pin bitShift: 9) + deg.! !!DataCreation class methodsFor: 'as yet unclassified' stamp: 'sk 5/17/2017 14:40'!getServoWithOffsetFor: pin degree: aValue	| index offset |	index _ self servoPinToCalibIndex: pin.	offset _ SvCalib at: index.	^ self getServoFor: pin degree: (aValue + offset)! !!DataCreation class methodsFor: 'as yet unclassified' stamp: 'sk 5/17/2017 14:12'!servoPinToCalibIndex: pin	" To change a pin# to a corresponding index of SvCalib.		SvCalib Index  1 2 3 4 5 6 7 8		pinNumber    4 5 6 7 0 1 2 3	"	^ (pin + 4) \\ 8 + 1! !!ErrorMessage class methodsFor: 'private' stamp: 'sk 9/28/2016 17:51'!show: msgID	"Displaying an error message for a given number."	| dialogBox title message errNo |	title _ 'Undifined error number.'.	message _ 'Unknown error.'.	(msgID = 0) ifTrue: [		title _ 'Could not access localhost'.		message _ 'Please save your project and restart this software.'.	].	(msgID = 1) ifTrue: [		title _ 'Could not access to Studuino'.		message _ 'Make sure Studuino is connected to the PC.'.	].	(msgID = 2) ifTrue: [		title _ 'Could not access to Studuino'.		message _ 'Serial port already in use.', String cr,			'Try quiting any programs that may be using it.'.	].	(msgID = 3) ifTrue: [		title _ 'Could not access to Studuino'.		message _ 'Studuino and PC failed to sync.', String cr,			'Save your project, exit this software, ', String cr,			'reset Studuino, and restart this software.'.	].	(msgID = 4) ifTrue: [		title _ 'Could not access to Studuino'.		message _ 'Disconnected.'.	].	(msgID = 5) ifTrue: [		title _ 'System error'.		message _ 'System file is corrupted.', String cr,			'Save your project, exit this software, ', String cr,			'reinstall Studuino programming environment.'.	].	(msgID = 6) ifTrue: [		title _ 'Could not access to Studuino'.		message _ 'COM port error.'.	].	(msgID = 7) ifTrue: [		title _ 'Build error'.		message _ 'Main function is not defined.'.	].	(msgID = 8) ifTrue: [		title _ 'Build error'.		message _ 'Script too big.'.	].	(msgID = 9) ifTrue: [		title _ 'Build error'.		message _ 'An error has occurred in the archiving process. Please re-install.'.	].	(msgID = 10) ifTrue: [		title _ 'Build error'.		message _ 'An error has occurred in the object copy1 process. Please re-install.'.	].	(msgID = 11) ifTrue: [		title _ 'Build error'.		message _ 'An error has occurred in the object copy2 process. Please re-install.'.	].	(msgID > 16) & (msgID < 24) ifTrue: [		errNo _ msgID bitAnd: 7.		"Mask error category"		title _ 'Build error'.		message _ nil.		(errNo bitAnd: 16r01) = 1 ifTrue: [			message isNil ifTrue: [				message _ 'Undefined function.']			ifFalse: [				message _ message, String cr, 'Undefined function.']].		((errNo bitShift: -1) bitAnd: 16r01) = 1 ifTrue: [			message isNil ifTrue: [				message _ 'Multiple functions with same name.']			ifFalse: [				message _ message, String cr, 'Multiple functions with same name.']].		((errNo bitShift: -2) bitAnd: 16r01) = 1 ifTrue: [			message isNil ifTrue: [				message _ 'Unknown error.']			ifFalse: [				message _ message, String cr, 'Unknown error.']]].	(msgID = 100) ifTrue: [		title _ 'Transfer failed'.		message _ 'Failed to transfer a program. Please retry.'].	(msgID = 101) ifTrue: [		title _ 'Time out error.'.		message _ 'Operation timed out.'].	(msgID = 200) ifTrue: [		title _ 'This script may not be able to properly open.'.		message _ 'Script you are trying to open is not compartible to current project.'].	(msgID = 201) ifTrue: [		title _ 'This script may not be able to properly open.'.		message _ 'Script you are trying to open might be ', String cr,			'using a block that can not be displayed ', String cr,			'in this programming environment. ', String cr,			'It is recommended that you update ', String cr,			'the programming environment ', String cr,			'to the latest version.'].	dialogBox _ DialogBoxMorph new.	dialogBox withButtonsForYes: false no: false okay: true cancel: false.	dialogBox title: title.	dialogBox message: message.	dialogBox openInWorld.		" Display Dialogbox "	dialogBox centerOnScreen.	" Set center position "	dialogBox world doOneCycle.! !!FileDirectory methodsFor: 'testing' stamp: 'jm 8/26/2008 09:45'!fileExists: filenameOrPath	"Answer true if a file of the given name exists. The given name may be either a full path name or a local file within this directory."	"FileDirectory default fileExists: Smalltalk sourcesName"	| fName dir |	FileDirectory splitName: filenameOrPath to: [:filePath :name |		fName _ name.		filePath isEmpty			ifTrue: [dir _ self]			ifFalse: [dir _ FileDirectory on: filePath]].	fName isUnicode ifTrue: [fName _ String withAll: fName asUTF8].	self isCaseSensitive 		ifTrue: [^ dir fileNames includes: fName]		ifFalse: [^ dir fileNames anySatisfy: [:name| name sameAs: fName]].	! !!FileDirectory methodsFor: 'file operations' stamp: 'KK 10/25/2017 10:49'!deleteFileNamed: localFileName	"Delete the file with the given name in this directory."	self deleteFileNamed: localFileName ifAbsent: [].! !!Morph methodsFor: 'initialization' stamp: 'KK 7/31/2017 18:44'!initialize	bounds _ 0@0 corner: 50@40.	owner _ nil.	submorphs _ Array empty.	fullBounds _ nil.	color _ Color blue.	flags _ 0.	properties _ nil.! !!Morph methodsFor: 'copying' stamp: 'KK 7/31/2017 18:45'!fullCopy	"Produce a copy of me with my entire tree of submorphs. Morphs mentioned more than once are all directed to a single new copy. Simpleinst vars are not copied, so you must override to copy Arrays, Forms, editable text, etc."	| dict new |	dict _ IdentityDictionary new: 1000.	new _ self copyRecordingIn: dict.	new allMorphsDo: [:m | m updateReferencesUsing: dict].	^ new! !!BlockMorph methodsFor: 'accessing' stamp: 'KK 8/20/2014 11:51'!closestAttachTargetIn: newOwner	"Answer the closest block attachment point among the blocks and stack submorphs of the given morph. Answer nil if there are no blocks close enough to attach myself to."	| xThresh yThresh attachPoints best bestDist targetP dist ref topUsed bottomUsed target targetOwner connectionY |	xThresh _ 65.	((self isKindOf: CBlockMorph) and: [(self nestedBlockAt: (self top + self topBarHeight)) isNil])		ifTrue: [yThresh _ 25]		ifFalse: [yThresh _ 14].	topUsed _ false.	bottomUsed _ false.	attachPoints _ OrderedCollection new:100.	newOwner submorphsDo: [:m |		((m ~~ self) and:		 [(m ~~ (self bottomBlock)) and:		 [(m ~~ (self topBlock)) and:		 [(m ~~ (self owner)) and:		 [(m isKindOf: BlockMorph) and:		 [m isReporter not]]]]]) ifTrue: [			m blockAttachPoints: attachPoints]].	((self isKindOf: HatBlockMorph) or: [(self ownerThatIsA: HatBlockMorph) ~= nil]) ifTrue: [		"if I am a HatBlock or the bottom block of a HatBlock stack, I can only attach to the top block of a stack"		attachPoints _ attachPoints select: [:assoc |			(assoc value owner = newOwner) and:			[assoc key y = assoc value top]]].	(self isStop or:[self bottomBlock isStop]) ifTrue: [		"I am a stop block; I can't attach to the top of a stack"		attachPoints _ attachPoints select: [:assoc |			assoc key y ~= assoc value top]].	(self topBlock isForever not and: [self bottomBlock isForever]) ifTrue: [		"My bottom block is a forever; I can't attach to the top of a stack"		attachPoints _ attachPoints select: [:assoc |			assoc key y ~= assoc value top]].	best _ nil.	bestDist _ 10000.	attachPoints do: [:assoc |		targetP _ assoc key.		ScratchTranslator isRTL			ifTrue: [ref _ self right]			ifFalse: [ref _ self left].		((ref - targetP x) abs < xThresh)			ifTrue: [				(((self top - targetP y) abs < yThresh) or: [self nextBlock isNil and: [(self bottom - targetP y) abs < yThresh]])					ifTrue: [  "targetP is within sticking range"						ScratchTranslator isRTL							ifTrue: [dist _ (self topRight - targetP) r]							ifFalse: [dist _ (self position - targetP) r].						dist < bestDist ifTrue: [							((self top - targetP y) abs < yThresh) ifTrue: [topUsed _ true. bottomUsed _ false].							(self nextBlock isNil and: [(self bottom - targetP y) abs < yThresh]) ifTrue: [topUsed _ false. bottomUsed _ true].							best _ assoc.							bestDist _ dist]]]].	"special case for the servomotor blocks"	(self isKindOf: CommandBlockMorph) ifTrue: [	best ifNotNil: [		(self selector = #motorNo:degree:) ifTrue: [		" Top block is servomotor block "			(self isOnlyServo: self) ifFalse: [				" include other blocks. "				target _ best value.				(target isKindOf: CommandBlockMorph) ifTrue: [					(target selector = #motorNo:degree:) ifTrue: [					" Target block is servomotor block "						(targetOwner _ target ownerThatIsA: CBlockMorph) ifNotNil: [							((targetOwner selector = #doSvmSyncMotion) | (targetOwner selector = #doSvmSyncMotion2)) ifTrue: [	" included synchro-servo block "								(target position x = targetOwner position x) ifFalse: [									best _ nil.				" DnD invalid. "								].							].						].					].					((target selector = #doSvmSyncMotion) | (target selector = #doSvmSyncMotion2)) ifTrue: [						connectionY _ best key y.						((connectionY ~= target top) & (connectionY ~= target bottom)) ifTrue: [							best _ nil.				" DnD invalid. "						].					].				].			].		]		ifFalse: [										" Top block is not servomotor block "			target _ best value.			(target isKindOf: CommandBlockMorph) ifTrue: [				(target selector = #motorNo:degree:) ifTrue: [					" Target block is servomotor block "					(targetOwner _ target ownerThatIsA: CBlockMorph) ifNotNil: [						((targetOwner selector = #doSvmSyncMotion)  | (targetOwner selector = #doSvmSyncMotion2)) ifTrue: [	" included synchro-servo block "							(target position x = targetOwner position x) ifFalse: [								best _ nil.				" DnD invalid. "							].						].					].				].				((target selector = #doSvmSyncMotion) | (target selector = #doSvmSyncMotion2)) ifTrue: [					connectionY _ best key y.					((connectionY ~= target top) & (connectionY ~= target bottom)) ifTrue: [						best _ nil.				" DnD invalid. "					].				].			].		].	]].	"special case for the auto-wrapping of c-shaped/if-else blocks"	(self isKindOf: CBlockMorph) ifTrue: [	best ifNotNil: [		bottomUsed ifTrue: [				(best value owner isKindOf: BlockMorph) ifTrue: [				self stretchHeight: 0. ^ best _ nil]].		(self isStopOrForever or:[self bottomBlock isStopOrForever]) ifTrue: [			bottomUsed ifTrue: [					self stretchHeight: 0.					^ best _ nil]].		((best key y = best value top) and: [((self isForever or:[self bottomBlock isForever])) and: [(self nestedBlockAt: (best key y)) isNil not]])					ifTrue: [self stretchHeight: 0. ^ best _ nil].		(self nestedBlockAt: (best key y)) ifNil: [			bottomUsed ifTrue: [					self stretchHeight: 0.					(best key y = best value bottom) ifTrue: [^ best _ nil].					((best key y = best value top) and: [(best value owner isKindOf: BlockMorph)]) ifTrue: [^ best _ nil].					((best key y = best value bottom) and: [(best value owner isKindOf: BlockMorph) not]) ifTrue: [^ best _ nil]].			topUsed ifTrue: [				((best key y = best value bottom) and: [best value nextBlock isNil not]) ifTrue: [self stretchHeight: 0. ^ best _ nil].				"((best key y = best value top) and: [(best value owner isKindOf: BlockMorph)]) ifTrue: [self stretchHeight: 0. ^ best _ nil]."				(best key y = best value top) ifTrue: [					" If I am synchro motion morph... "					((self selector = #doSvmSyncMotion) | (self selector = #doSvmSyncMotion2)) ifTrue: [						(best value selector = #motorNo:degree:) ifFalse: [	" The bounded morph is not servomotor block. "							^ best _ nil.						]						ifTrue: [	" The bounded morph is servomotor block "							(best value isOnlyServo: best value) ifFalse: [	" with other block "								^ best _ nil.							]						].					].					self stretchHeight: best value fullBounds height - 17. ^ best				]			].			self stretchHeight: 0]].	best ifNil: [		self stretchHeight: 0]].	 ^ best! !!BlockMorph methodsFor: 'accessing' stamp: 'KK 8/1/2017 15:07'!presentHelpScreen	"Answer the name of the help screen for this block, or nil if no help is available."	| fr |	fr _ self ownerThatIsA: ScratchFrameMorph.	fr		ifNil: [^ nil]		ifNotNil: [fr presentHelpScreen: self helpScreenName]! !!BlockMorph methodsFor: 'drawing' stamp: 'KK 8/29/2013 15:41'!drawOn: aCanvas 	| c |	self computeHighlightColors.	c _ FormCanvas extent: self extent depth: 32.	c _ c copyOffset: self topLeft negated.	self isReporter ifTrue: [		self drawSmoothTopEdgeOn: c.		self drawReporterBodyOn: c.		self drawSmoothBottomEdgeOn: c.		^ self].	self isStop ifTrue: [		self drawTopEdgeOn: c.		self drawStopBodyOn: c.		self drawSmoothBottomEdgeOn: c.		self drawFinalOn: aCanvas fromCanvas: c.		^ self].	self drawTopEdgeOn: c.	self drawBodyOn: c.	self drawBottomEdgeOn: c.	self drawFinalOn: aCanvas fromCanvas: c.! !!BlockMorph methodsFor: 'dropping/grabbing' stamp: 'KK 9/8/2017 15:58'!justDroppedInto: newOwner event: evt	"Handle being dropped into a new situation."	| frame targetAssoc targetP targetBlock bottomBlockUsed upperBlock |	bottomBlockUsed _ false.	(frame _ newOwner ownerThatIsA: ScratchFrameMorph)		ifNotNil: [frame projectModified].	((self ownerThatIsA: ScratchViewerMorph) notNil) ifTrue: [		"delete myself when dropped in the blocks palette area"		self delete.		self receiver blocksBin changed.		^ self].	"blocks cannot be dropped onto the stage"	(owner isKindOf: ScratchStageMorph) ifTrue: [		^ self rejectDropEvent: evt].	"okay to drop blocks into the world during development"	((owner == World) and: [Preferences noviceMode not]) ifTrue: [^ self].	((owner isKindOf: ScratchScriptsMorph) or:	 [(owner isKindOf: BlockMorph) or:	 [(owner isKindOf: ScratchStageMorph) and: [self isReporter]]]) ifFalse: [		^ self rejectDropEvent: evt].	self isReporter ifTrue: [^ self handleReporterDrop].	targetAssoc _ self closestAttachTargetIn: newOwner.	targetAssoc ifNil: [		(self bottomBlock isKindOf: CBlockMorph) ifFalse: [			targetAssoc _ self bottomBlock closestAttachTargetIn: newOwner.			targetAssoc ifNotNil:[				bottomBlockUsed _ true.				(targetAssoc value owner isKindOf: BlockMorph) ifTrue:[					targetAssoc _ nil]]]].	targetAssoc ifNil: [^ self].	"make sure no processes are running"	self = self topBlock ifTrue: [self stop].	targetP _ targetAssoc key.	targetBlock _ targetAssoc value.	targetP y = targetBlock top		ifTrue: [			"c-shaped block should nest the target block"			"((bottomBlockUsed not) and: [((targetBlock owner isKindOf: BlockMorph) not) and: [(self isKindOf: CBlockMorph)]]) ifTrue:["			((bottomBlockUsed not) and: [(self isKindOf: CBlockMorph)]) ifTrue:[				(targetBlock owner isKindOf: BlockMorph)					ifTrue: [(targetBlock owner) attachBlock: self]					ifFalse: [self position: (targetP x - self bracketThickness)@(targetP y - self topBarHeight - 3)].				self attachBlockNested: targetBlock. ^ self].			"for all other non-c-shaped blocks"			(bottomBlockUsed or:[((targetBlock owner isKindOf: BlockMorph) not) and: [(self isKindOf: CBlockMorph) not]]) ifTrue:[				ScratchTranslator isRTL					ifTrue: [self bottomBlock position: (targetP x - self bottomBlock width) @ (targetP y - (self bottomBlock height - 4))]					ifFalse: [self bottomBlock position: targetP x @ (targetP y - (self bottomBlock height - 4))].				upperBlock _ self bottomBlock owner.				[upperBlock isKindOf: BlockMorph] whileTrue: [					upperBlock nextBlock ifNotNil:[						ScratchTranslator isRTL							ifTrue: [upperBlock position: (targetP x - upperBlock width) @ (upperBlock nextBlock position y - (upperBlock height - 4))]							ifFalse: [upperBlock position: targetP x @ (upperBlock nextBlock position y - (upperBlock height - 4))].						upperBlock _ upperBlock owner]]].			((bottomBlockUsed not) and: [targetBlock owner isKindOf: BlockMorph]) ifTrue:[				ScratchTranslator isRTL					ifTrue: [self position: (targetP x - self width) @ (targetP y - (self height - 4))]					ifFalse: [self position: targetP x @ (targetP y - (self height - 4))]].			(targetBlock owner isKindOf: BlockMorph) ifTrue:[				ScratchTranslator isRTL					ifTrue: [self topBlock position: (targetP x - self topBlock width) @ targetP y]					ifFalse: [self topBlock position: targetP x @ targetP y].				targetBlock owner attachBlock: self topBlock].			ScratchTranslator isRTL				ifTrue: [targetBlock position: (targetP x - targetBlock width) @ (self bottomBlock position y + self bottomBlock height + 4)]				ifFalse: [targetBlock position: targetP x @ (self bottomBlock position y + self bottomBlock height + 4)].			((bottomBlockUsed not) and: [((targetBlock owner isKindOf: BlockMorph) not) and: [(self isKindOf: CBlockMorph)]]) ifFalse:[				self bottomBlock attachBlock: targetBlock]]		ifFalse: [			self assert: [(self isKindOf: HatBlockMorph) not].  "I am not a HatBlockMorph"			ScratchTranslator isRTL				ifTrue: [self position: (targetP - (self width @0))]				ifFalse: [self position: targetP].			targetBlock attachBlock: self].! !!BlockMorph methodsFor: 'event handling' stamp: 'sk 3/15/2017 13:13'!mouseDown: evt	"Handle a mouse click. Left button either drags or performs click action. Right button brings up a menu."	evt hand newKeyboardFocus: nil.	evt rightButtonPressed		ifTrue: [^ self rightButtonMenu]		ifFalse:	[evt hand waitForClicksOrDrag: self event: evt].! !!BlockMorph methodsFor: 'event handling' stamp: 'KK 7/31/2017 19:28'!rightButtonMenu	| menu |	menu _ CustomMenu new.	menu add: 'help' action: #presentHelpScreen.	(owner isKindOf: ScratchBlockPaletteMorph) ifFalse: [		menu addLine.		menu add: 'duplicate' action: #duplicate.			(self owner isKindOf: BlockMorph) ifFalse: [  "we can't yet delete a blocks inside a script"			menu add: 'delete' action: #delete]].	DebugMenu ifTrue: [		menu addLine.		menu add: 'show tuples' action: #showTuples].		menu localize; invokeOn: self.! !!BlockMorph methodsFor: 'event handling' stamp: 'KK 10/10/2017 14:37'!startDrag: evt	"ArTeC: If owner is ScratchBlockPaletteMorph then I check IOPort Array and decide DragNDrop. "	| startEvt rootForGrab partsID |	(owner isKindOf: ScratchBlockPaletteMorph) ifTrue:[		(self isKindOf: EventHatMorph) ifFalse: [(self color = (Color r: 0.6 g: 0.6 b: 0.6)) ifTrue: [^ self.].			((self selector = 'motorNo:degree:') | 			 (self selector = 'motorNo:power:') | 			 (self selector = 'motorNo:dcMotorOn:') |			 (self selector = 'motorNo:dcMotorOff:') |			 (self selector = 'buzzerPin:freq:') |			 (self selector = 'buzzerPin:') |			 (self selector = 'ledPin:onOff:') |		 	 (self selector = 'lightSensor:') |		 	 (self selector = 'touchSensor:') |		 	 (self selector = 'soundSensor:') |		 	 (self selector = 'refPhotosensor:') |		 	 (self selector = 'temperatureSensor:') |		 	 (self selector = 'accelerometer:') |		 	 (self selector = 'onBoardButton:')) ifTrue: [				self submorphs do: [ :sub |					(sub isKindOf: ChoiceArgMorph) ifTrue: [						sub choice = '' ifTrue: [							^ self.						]					]				]			].			(self selector = 'ledColor:onOff:') ifTrue: [				partsID _ 16r05.			" 01:DC 02:SV 03:LED 04:BZR 05:CLED 10:LS 11:TS 12:SS 13:IRS 14:3S 15:BTN"				" If colorLED connect with board, IOPort No.12 is sure to set colorLED ID(0x05)"				((IOPort at: 12) ~= partsID) ifTrue: [					^ self.				]			]		]	].	evt hand toolType ifNil: [		startEvt _ evt hand firstClickEvent.		startEvt ifNil: [startEvt _ evt].		rootForGrab _ self rootForGrabOf: self.		rootForGrab ifNil: [^ self].		evt hand grabMorph: rootForGrab.		rootForGrab position: evt hand position + (rootForGrab topLeft - startEvt cursorPoint)].	self handleTool: evt hand toolType hand: evt hand.! !!BlockMorph methodsFor: 'private' stamp: 'KK 8/2/2013 13:05'!printArduCodeOn: aStream indent: indent	"Append a human-readable string for this block on the given stream."	indent timesRepeat: [aStream nextPutAll: '    '].	aStream nextPutAll: self class name; cr.	self nextBlock ifNotNil: [self nextBlock printArduCodeOn: aStream indent: indent].! !!BlockMorph methodsFor: 'private' stamp: 'KK 10/10/2017 12:22'!printArduCodeSubmorph: aMorph on: aStream	(aMorph isKindOf: ArgMorph) ifTrue: [		(self selector = 'list:export:') ifTrue: [ ^ ''. ].		aMorph printArgOn: aStream.	].	(aMorph isKindOf: BlockMorph) ifTrue: [		aMorph printArduCodeOn: aStream indent: 0.		aStream skip: -1.  "remove carriage return"		].	(aMorph isKindOf: StringMorph) ifTrue: [		((self selector = 'motorNo:degree:') & ServomotorSynchroMotion) ifTrue: ["			Transcript show:aMorph contents;cr."			(aMorph contents = ', SVRANGE(') ifTrue: [				aStream					nextPutAll: 'degree[';					nextPutAll: ((ServomotorNumber-1) asString);					nextPutAll: '] = ';					nextPutAll: 'SVRANGE('.			].			(aMorph contents = '));') ifTrue: [				aStream					nextPutAll: ');'.			].			^ ''		].		(self selector = 'list:export:') ifTrue: [ ^ ''. ].		((aMorph contents = '?')) " | (aMorph contents = '%'))"			ifTrue: [aStream skip: -1].	"remove space before ? or %"		(aMorph contents = 'else') ifTrue: [ ^ ''].		aStream nextPutAll: aMorph contents.].! !!BlockMorph methodsFor: 'private' stamp: 'KK 1/14/2015 17:56'!printCodeSubmorph: aMorph on: aStream	(aMorph isKindOf: ArgMorph) ifTrue: [aMorph printArgOn: aStream].	(aMorph isKindOf: BlockMorph) ifTrue: [		aStream nextPut: $(.		aMorph printCodeOn: aStream indent: 0.		aStream skip: -1.  "remove carriage return"		aStream nextPut: $)].	(aMorph isKindOf: StringMorph) ifTrue: [		((aMorph contents = '?') | (aMorph contents = '%'))			ifTrue: [aStream skip: -1].	"remove space before ? or %"		aStream nextPutAll: aMorph contents].! !!BorderedMorph methodsFor: 'drawing' stamp: 'KK 4/25/2014 12:59'!drawOn: aCanvas 	"Draw a rectangle with a solid, inset, or raised border.	Note: the raised border color is generated from the receiver's own color,	while the inset border color is generated from the color of its owner.	This behavior is visually more consistent. Thanks to Hans-Martin Mosner."	| insetColor |	borderWidth = 0 ifTrue: [  "no border"		"Note: This is the hook for border styles.			When converting to the new borders we'll just put 0 into the borderWidth"		super drawOn: aCanvas.		^ self].	borderColor == #raised ifTrue: [		"Use a hack for now"		aCanvas fillRectangle: self bounds color: color.		^ aCanvas frameAndFillRectangle: bounds			fillColor: Color transparent			borderWidth: borderWidth			topLeftColor: (borderWidth = 1 ifTrue: [color twiceLighter]										ifFalse: [color lighter])			bottomRightColor: (borderWidth = 1 ifTrue: [color twiceDarker]										ifFalse: [color darker])].	borderColor == #inset ifTrue: [		insetColor _ owner colorForInsets.		aCanvas fillRectangle: self bounds color: color.		^ aCanvas frameAndFillRectangle: bounds			fillColor: Color transparent			borderWidth: borderWidth			topLeftColor: (borderWidth = 1 ifTrue: [insetColor twiceDarker]										ifFalse: [insetColor darker])			bottomRightColor: (borderWidth = 1 ifTrue: [insetColor twiceLighter]										ifFalse: [insetColor lighter])].	"solid color border"	aCanvas fillRectangle: (self bounds insetBy: borderWidth) color: color.	aCanvas frameAndFillRectangle: bounds		fillColor: Color transparent		borderWidth: borderWidth		borderColor: borderColor.! !!ArgMorph methodsFor: 'other' stamp: 'KK 5/1/2014 15:14'!labelMorph	^ labelMorph! !!ArgMorph methodsFor: 'other' stamp: 'KK 8/2/2013 12:58'!printArduArgOn: aStream	"Print this argument morph on the given stream."	| v |	self labelMorph ifNotNil: [		v _ self evaluate.		(v isKindOf: String)			ifTrue: [aStream nextPutAll: '"', v, '"']			ifFalse: [aStream nextPutAll: v asString]].! !!ArgMorph methodsFor: 'other' stamp: 'KK 7/7/2014 10:16'!printArgOn: aStream	"Print this argument morph on the given stream."	| v |	self labelMorph ifNotNil: [		v _ self evaluate.		((owner selector = 'motorNo:degree:') & ServomotorSynchroMotion) ifTrue: [			aStream				nextPutAll: (v asString).		]		ifFalse: [			(v isKindOf: String)				ifTrue: [aStream nextPutAll: v ]				ifFalse: [aStream nextPutAll: v asString]		].	].! !!BooleanArgMorph methodsFor: 'other' stamp: 'KK 8/2/2013 12:58'!printArduArgOn: aStream	"Print this argument morph on the given stream."	aStream nextPutAll: 'false'.! !!ChoiceArgMorph methodsFor: 'event handling' stamp: 'sk 9/21/2016 19:25'!handlesMouseDown: evt	^ evt hand toolType isNil and:		[(self topLeft corner: self bottomRight) containsPoint: evt cursorPoint]! !!ChoiceArgMorph methodsFor: 'event handling' stamp: 'KK 7/12/2017 15:28'!mouseDown: evt	self presentMenu.! !!ChoiceArgMorph methodsFor: 'other' stamp: 'KK 8/2/2013 12:58'!printArduArgOn: aStream	"Print this argument morph on the given stream."	aStream nextPutAll: '"', self labelMorph contents, '"'.! !!ChoiceArgMorph methodsFor: 'other' stamp: 'KK 7/7/2014 09:11'!printArgOn: aStream	| arg |	"Print this argument morph on the given stream."	arg _ self labelMorph contents.	((owner selector = 'motorNo:degree:') & (ServomotorSynchroMotion)) ifTrue: [		aStream			nextPutAll: 'port[';			nextPutAll: ((ServomotorNumber-1) asString);			nextPutAll: '] = PORT_';			nextPutAll: (arg asString);			nextPutAll: ';';			nextPutAll: String tab.		^ self.	].	((owner selector ~= 'setVar:to:') & (owner selector ~= 'changeVar:by:') &	 (owner selector ~= 'append:toList:') & (owner selector ~= 'deleteLine:ofList:') &	 (owner selector ~= 'insert:at:ofList:') & (owner selector ~= 'setLine:ofList:to:') &	 (owner selector ~= 'getLine:ofList:') & (owner selector ~= 'lineCountOfList:') &	 (owner selector ~= 'list:contains:'))	 ifTrue: [		((arg = 'abs') | (arg = 'sqrt') | (arg = 'sin') | (arg = 'cos') | (arg = 'tan') |		 (arg = 'asin') | (arg = 'acos') | (arg = 'atan') | (arg = 'ln') | (arg = 'log'))		ifTrue: [ arg _ arg asUppercase. ].		(arg = 'e ^') ifTrue:[ arg _ 'POWE'. ].		(arg = '10 ^') ifTrue: [ arg _ 'POW10'. ].		((arg = 'on') | (arg = 'off'))		ifTrue: [ arg _ arg asUppercase. ]."		(arg = 'D0') ifTrue:[ arg _ 'DIG0' ].		(arg = 'D1') ifTrue:[ arg _ 'DIG1' ].		(arg = 'D2') ifTrue:[ arg _ 'DIG2' ].		(arg = 'D3') ifTrue:[ arg _ 'DIG3' ].		(arg = 'D4') ifTrue:[ arg _ 'DIG4' ].		(arg = 'D5') ifTrue:[ arg _ 'DIG5' ].		(arg = 'D6') ifTrue:[ arg _ 'DIG6' ].		(arg = 'D7') ifTrue:[ arg _ 'DIG7' ].		(arg = 'D8') ifTrue:[ arg _ 'DIG8' ].		(arg = 'D9') ifTrue:[ arg _ 'DIG9' ].		(arg = 'D10') ifTrue:[ arg _ 'DIG10' ].		(arg = 'D11') ifTrue:[ arg _ 'DIG11' ].		(arg = 'D12') ifTrue:[ arg _ 'DIG12' ].		(arg = 'D13') ifTrue:[ arg _ 'DIG13' ].		(arg = 'D14') ifTrue:[ arg _ 'DIG14' ].		(arg = 'D15') ifTrue:[ arg _ 'DIG15' ].		(arg = 'D16') ifTrue:[ arg _ 'DIG16' ].		(arg = 'D17') ifTrue:[ arg _ 'DIG17' ].		(arg = 'D18') ifTrue:[ arg _ 'DIG18' ].		(arg = 'D19') ifTrue:[ arg _ 'DIG19' ].		(arg = 'A0') ifTrue:[ arg _ 'ANA0' ].		(arg = 'A1') ifTrue:[ arg _ 'ANA1' ].		(arg = 'A2') ifTrue:[ arg _ 'ANA2' ].		(arg = 'A3') ifTrue:[ arg _ 'ANA3' ].		(arg = 'A4') ifTrue:[ arg _ 'ANA4' ].		(arg = 'A5') ifTrue:[ arg _ 'ANA5' ].		(arg = 'A6') ifTrue:[ arg _ 'ANA6' ].		(arg = 'A7') ifTrue:[ arg _ 'ANA7' ]."	].	aStream nextPutAll: arg.! !!ChoiceArgMorphForStuduino methodsFor: 'initialization' stamp: 'SeijiKagayama 11/14/2017 12:01'!handlesMouseDown: evt	isValid ifFalse: [ ^ false ].	^ super handlesMouseDown: evt! !!ChoiceArgMorphForStuduino methodsFor: 'initialization' stamp: 'KK 3/3/2015 09:55'!initialize	isValid := true.	super initialize."	labelMorph := StringFieldMorph new		forExpressionArg;		doResizing: true;		font: (ScratchFrameMorph getFont: #Arg);		color: Color black."! !!ChoiceArgMorphForStuduino methodsFor: 'initialization' stamp: 'KK 12/4/2017 19:45'!setFieldWidth: w	self width: w.	self extent: (w@20).	menuIconMorph position: (self right - borderWidth - 10)@(self top + borderWidth + 4).! !!ChoiceArgMorphForStuduino methodsFor: 'initialization' stamp: 'KK 12/4/2017 20:05'!setFieldWidth: w height: h	self width: w.	self extent: (w@h).	menuIconMorph position: (self right - borderWidth - 10)@(self top + borderWidth + 4).! !!ChoiceArgMorphForStuduino methodsFor: 'accessing' stamp: 'KK 3/27/2015 10:55'!choice: aSymbol	| selected tempExtent pinNo pinNoArray |	"Update the toggle button when an argument is changed within a block."	selected := self choice.	" selected Parts ""Transcript show:'aSymbol';show:': ';show:aSymbol;cr.Transcript show:'selected';show:': ';show:selected;cr."	(selected = aSymbol) ifTrue:[ ^ self.].	" Check whether user is going to use the infrared receiving sensor and I2C devices at the same time "	(aSymbol = InfraredReceiverName) ifTrue: [		pinNoArray := owner submorphs select: [:each | each isMemberOf: StringMorph. ].		pinNoArray ifNotNil: [ pinNo := (pinNoArray at:1) contents. ].		((pinNo = 'A4') | (pinNo = 'A5')) ifFalse: [			((self ownerThatIsA: PinAssignMorph) canBeSelected: aSymbol) ifFalse: [				^ self.			]		].	].	(aSymbol = AccelerometerName) |	(aSymbol = GyroSensorName) |	(aSymbol = ColorSensorName) ifTrue: [		((self ownerThatIsA: PinAssignMorph) canBeSelected: aSymbol) ifFalse: [			^ self.		]	].	tempExtent := self extent.	super choice: aSymbol.	(owner notNil) ifTrue: [		" ------------------------- Ultrasonic Sensor -------------------------"		(aSymbol = UltrasonicSensorName) ifTrue: [			(self ownerThatIsA: PinAssignMorph) notifyUltrasonicSelect: owner.		].		(selected = UltrasonicSensorName) ifTrue: [			(self ownerThatIsA: PinAssignMorph) notifyNotUltrasonicSelect: owner.		].		" --------------------------- Accelerometer ---------------------------"		(aSymbol = AccelerometerName) ifTrue: [			(self ownerThatIsA: PinAssignMorph) notifyAccelerometerSelect: owner.		].		(aSymbol = GyroSensorName) ifTrue: [			(self ownerThatIsA: PinAssignMorph) notifyGyroSensorSelect: owner.		].		(aSymbol = ColorSensorName) ifTrue: [			(self ownerThatIsA: PinAssignMorph) notifyColorSensorSelect: owner.		].		(selected = AccelerometerName) ifTrue: [			(self ownerThatIsA: PinAssignMorph) notifyNotToSelectAccelerometer: owner.		].		(selected = GyroSensorName) ifTrue: [			(self ownerThatIsA: PinAssignMorph) notifyNotToSelectGyroSensor: owner.		].		(selected = ColorSensorName) ifTrue: [			(self ownerThatIsA: PinAssignMorph) notifyNotToSelectColorSensor: owner.		].		" ------------------------- Infrare Receiver -------------------------"		(aSymbol = InfraredReceiverName) ifTrue: [			(self ownerThatIsA: PinAssignMorph) notifyInfrareReceiverSelect: owner.		].		(selected = InfraredReceiverName) ifTrue: [			(self ownerThatIsA: PinAssignMorph) notifyNotInfrareReceiverSelect: owner.		].		" ------------------------- Bluetooth -------------------------"		(aSymbol = BluetoothName) ifTrue: [			(self ownerThatIsA: PinAssignMorph) notifyBluetoothSelect: owner.		].		(selected = BluetoothName) ifTrue: [			(self ownerThatIsA: PinAssignMorph) notifyNotBluetoothSelect: owner.		].	].	self extent: tempExtent.	menuIconMorph position: (self right - borderWidth - 10)@(self top + borderWidth + 4).! !!ChoiceArgMorphForStuduino methodsFor: 'accessing' stamp: 'KK 3/27/2015 10:53'!choiceAccelerameter	| |	"Choice Accelerameter item in combo box."	self choice: AccelerometerName.! !!ChoiceArgMorphForStuduino methodsFor: 'accessing' stamp: 'KK 3/27/2015 10:45'!choiceColorSensor	| |	"Choice Accelerameter item in combo box."	self choice: ColorSensorName.	! !!ChoiceArgMorphForStuduino methodsFor: 'accessing' stamp: 'KK 3/27/2015 10:53'!choiceGyroSensor	| |	"Choice Gyro sensor item in combo box."	self choice: GyroSensorName.! !!ChoiceArgMorphForStuduino methodsFor: 'accessing' stamp: 'KK 1/5/2015 16:01'!choiceI2CDevice	| tempExtent |	"Choice Accelerameter item in combo box."	tempExtent := self extent.	super choice: 'I2C device'.	self extent: tempExtent.	menuIconMorph position: (self right - borderWidth - 10)@(self top + borderWidth + 4).	! !!ChoiceArgMorphForStuduino methodsFor: 'accessing' stamp: 'KK 3/24/2015 11:46'!choiceLightSensor	| |	"Choice Accelerameter item in combo box."	self choice: LightSensorName.	! !!ChoiceArgMorphForStuduino methodsFor: 'accessing' stamp: 'KK 3/27/2015 10:54'!choiceUltrasonicSensor	| |	"Choice Accelerameter item in combo box."	self choice: UltrasonicSensorName.! !!ChoiceArgMorphForStuduino methodsFor: 'accessing' stamp: 'KK 3/3/2015 09:41'!valiable: fisValid := f.! !!ColorArgMorph methodsFor: 'other' stamp: 'KK 8/2/2013 12:59'!printArduArgOn: aStream	"Print this argument morph on the given stream."	aStream nextPutAll: 'c[',		(self hexFor: color red),		(self hexFor: color green),		(self hexFor: color blue),		']'.! !!ColorArgMorph methodsFor: 'other' stamp: 'KK 8/2/2013 13:02'!printArgOn: aStream	"Print this argument morph on the given stream."	aStream nextPutAll:		(self hexFor: color red),		(self hexFor: color green),		(self hexFor: color blue).! !!CommandBlockMorph methodsFor: 'initialization' stamp: 'KK 9/20/2013 17:58'!initialize	super initialize.	commandSpec _ ''.	argMorphs _ OrderedCollection new.	receiver _ nil.	selector _ nil.	isTimed _ false.! !!CommandBlockMorph methodsFor: 'evaluation' stamp: 'KK 10/10/2017 12:23'!coerceArgs: argList	"Answer an arugments array in which all arguments that should be numbers have been coerced to numbers if necessary."	| args specialCommands numFlags |	args _ argList asArray.	specialCommands _ #(		append:toList: deleteLine:ofList: getLine:ofList: insert:at:ofList: list:contains: setLine:ofList:to: list:export:		lookLike: showBackground:		playSound: doPlaySoundAndWait		setVar:to:).	(specialCommands includes: selector) ifFalse: [		"ensure args are numbers where numbers are expected"		numFlags _ self numberArgFlags.		1 to: args size do: [:i |			(numFlags at: i) ifTrue: [args at: i put: (args at: i) asNumberNoError]]].	^ args! !!CommandBlockMorph methodsFor: 'evaluation' stamp: 'KK 7/31/2017 19:35'!evaluateWithArgs: rawArgs	"Evalue this block with the given argument list."	| args |	"special case for math and boolean infix operators"	selector isInfix ifTrue: [^ self evaluateInfixWithArgs: rawArgs].	args _ self coerceArgs: rawArgs..	"special case for unary operators"	(#(abs not rounded sqrt truncated) includes: selector) ifTrue: [^ args first perform: selector].	^ receiver perform: selector withArguments: args! !!CommandBlockMorph methodsFor: 'menus' stamp: 'KK 12/15/2017 08:14'!rightButtonMenu	| menu sFrame choice spec |	menu _ CustomMenu new.	menu add: 'help' action: #presentHelpScreen.	(owner isKindOf: ScratchBlockPaletteMorph) ifFalse: [		menu addLine.		(#(+ - * / \\) includes: selector) ifTrue: [			#(+ - * / mod) with: #(+ - * / \\) do: [:s :op | menu add: s action: op]].		(#(< = >) includes: selector) ifTrue: [			#(< = >) do: [:op | menu add: op action: op]].		(#(& |) includes: selector) ifTrue: [			#(and or) with: #(& |) do: [:s :op | menu add: s action: op]].		menu addLine.		menu add: 'duplicate' action: #duplicate.		(self owner isKindOf: BlockMorph) ifFalse: [  "can't yet delete a blocks inside a script"			menu add: 'delete' action: #delete]].	sFrame _ self ownerThatIsA: ScratchFrameMorph.	(sFrame notNil and: [#(sensor: sensorPressed:) includes: selector]) ifTrue: [		menu addLine.		menu add: 'show ScratchBoard watcher' action: #showSensorBoard.		sFrame workPane scratchServer			ifNil: [menu add: 'enable remote sensor connections' action: #enableRemoteSensors]			ifNotNil: [menu add: 'disable remote sensor connections' action: #exitScratchSession]	].	DebugMenu ifTrue: [		menu addLine.		menu add: 'show tuples' action: #showTuples].		(choice _ menu localize; startUp) ifNil: [^ self].	(#(presentHelpScreen duplicate delete) includes: choice) ifTrue: [^ self perform: choice].	choice = #showSensorBoard ifTrue: [sFrame showSensorBoard. ^ self].	choice = #enableRemoteSensors ifTrue: [sFrame enableRemoteSensors. ^ self].	choice = #exitScratchSession ifTrue: [sFrame exitScratchSession. ^ self].	choice = #showTuples ifTrue: [^ self showTuples].	"change operator"	spec _ '%n ', choice, ' %n'.	'\\' = choice	ifTrue: [spec _ ScratchTranslator translationFor: '%n mod %n'].	'&' = choice	ifTrue: [spec _ ScratchTranslator translationFor: '%b and %b'].	'|' = choice	ifTrue: [spec _ ScratchTranslator translationFor: '%b or %b'].	self commandSpec: spec.	self selector: choice.! !!CommandBlockMorph methodsFor: 'private' stamp: 'KK 7/31/2017 19:38'!addCommandIcons	"Add additional icons to certain blocks. Do nothing if this isn't one of those blocks."	| f m |	#turnLeft: = selector ifTrue: [		f _ ScratchFrameMorph skinAt: #turnCCW ifAbsent: [^ self].		m _ self firstSubmorph delete.		self addMorphFront: (ImageMorph new form: f).		self addMorphFront: m].	#turnRight: = selector ifTrue: [		f _ ScratchFrameMorph skinAt: #turnCW ifAbsent: [^ self].		m _ self firstSubmorph delete.		self addMorphFront: (ImageMorph new form: f).		self addMorphFront: m].	#stopAll = selector ifTrue: [		f _ ScratchFrameMorph skinAt: #stopButton ifAbsent: [^ self].		self addMorphBack: (ImageMorph new form: f)].	#motorNo:degree: = selector ifTrue: [		f _ ScratchFrameMorph skinAt: #sv ifAbsent: [^ self].		self addMorphFront: (ImageMorph new form: f)].	#setServoSpeed:d2:d4:d7:d8:d9:d10:d11:d12: = selector ifTrue: [		f _ ScratchFrameMorph skinAt: #sv ifAbsent: [^ self].		self addMorphFront: (ImageMorph new form: f)].	#motorNo:power: = selector ifTrue: [		f _ ScratchFrameMorph skinAt: #DC1 ifAbsent: [^ self].		self addMorphFront: (ImageMorph new form: f)].	#motorNo:dcMotorOff: = selector ifTrue: [		f _ ScratchFrameMorph skinAt: #DC3 ifAbsent: [^ self].		self addMorphFront: (ImageMorph new form: f)].	#motorNo:dcMotorOn: = selector ifTrue: [		f _ ScratchFrameMorph skinAt: #DC2 ifAbsent: [^ self].		self addMorphFront: (ImageMorph new form: f)].	#buzzerPin:freq: = selector ifTrue: [		f _ ScratchFrameMorph skinAt: #buzzer ifAbsent: [^ self].		self addMorphFront: (ImageMorph new form: f)].	#buzzerPin: = selector ifTrue: [		f _ ScratchFrameMorph skinAt: #buzzer2 ifAbsent: [^ self].		self addMorphFront: (ImageMorph new form: f)].	#ledPin:onOff: = selector ifTrue: [		f _ ScratchFrameMorph skinAt: #LED1 ifAbsent: [^ self].		self addMorphFront: (ImageMorph new form: f)].	#boardLED:onOff: = selector ifTrue: [		f _ ScratchFrameMorph skinAt: #LED1 ifAbsent: [^ self].		self addMorphFront: (ImageMorph new form: f)].	#ledColor:onOff: = selector ifTrue: [		f _ ScratchFrameMorph skinAt: #LED2 ifAbsent: [^ self].		self addMorphFront: (ImageMorph new form: f)].! !!CommandBlockMorph methodsFor: 'private' stamp: 'KK 7/31/2017 19:40'!argMorphToReplace: aMorph	"Answer a new argument morph to be used to replace the given morph. Answer nil if the given morph is not one of my argMorphs."	| i argSpecs spec argM defaults v |	i _ argMorphs indexOf: aMorph ifAbsent: [^ nil].	argSpecs _ (CommandBlockMorph parseCommandSpec: commandSpec) select: [:s | CommandBlockMorph isArgSpec: s].	i > argSpecs size ifTrue: [^ nil].	argM _ self argMorphFor: (argSpecs at: i).	(#setVar:to: = selector and: [(argSpecs at: i) = '%n']) ifTrue: [		^ argM stringExpression: '0'].	spec _ ScriptableScratchMorph blockSpecDict at: selector ifAbsent: [^ argM].	defaults _ receiver defaultArgsFor: spec.	i <= defaults size ifTrue: [		v _ defaults at: (argPermutation indexOf: i).		(v isKindOf: String)			ifTrue: [				(argM isKindOf: ExpressionArgMorph)					ifTrue: [argM defaultValueFromSpec: v localized]					ifFalse: [argM defaultValue: v localized]]			ifFalse: [argM defaultValue: v]].	^ argM! !!CommandBlockMorph methodsFor: 'private' stamp: 'KK 12/23/2017 15:09'!canBecomeWatcher	"I determine which blocks can become watchers."	| i |	i _ selector asString findAnySubStr: #('mouse' 'key' 'touching' 'distance' 'lightSensor' 'touchSensor' 'soundSensor' 'refPhotosensor' 'temperatureSensor' 'accelerometer' 'onBoardButton' 'gyro') startingAt: 1.	^ (self isReporter) &	   (self argumentCount <= 1) &	   ((#(not atRandom abs rounded lineCountOfList: stringLength:) includes: selector) not) &	   (i > selector asString size)! !!CommandBlockMorph methodsFor: 'private' stamp: 'KK 4/25/2014 16:47'!isOnlyServo: aMorph	" Blocks are mass of servomotor block ?  "	|  nextBlock |	nextBlock _ aMorph submorphs at:1.	" Check next blok is end of block "	(nextBlock isKindOf:CommandBlockMorph) ifTrue: [		" Next block is kind of CommandBlockMorph "		(nextBlock isKindOf: ReporterBlockMorph) ifTrue: [			" But, next block is kind of ReportBlockMorph "			" So, next block is nothing. "			^ true.		]	]	ifFalse: [		" Next block is NOT kind of CommandBlockMorph "		" So, next block is nothing. "		^ true.	].	" Next block is not servomoter "	(nextBlock selector = #motorNo:degree:) ifFalse: [ ^ false. ].	" Next block is servomotor. so, check after the next block... "	^ (self isOnlyServo: nextBlock).	! !!CommandBlockMorph methodsFor: 'private' stamp: 'KK 7/7/2014 09:19'!printArduCodeOn: aStream indent: indent	"Append a human-readable string for this block on the given stream."	| nextB hasFinalSpace |	indent timesRepeat: [aStream nextPutAll: '    '].	nextB _ self nextBlock.	hasFinalSpace _ false.	(self selector = 'contentsOfList:') ifTrue: [ aStream nextPutAll: 'listItem(&ARLIST_'. ].	(self isKindOf: VariableBlockMorph) ifTrue: [ aStream nextPutAll: 'ARVAL_'. ].	" To add offset degree info, copy PIN name to new ChoiceArgMorph "	(self selector = 'motorNo:degree:') ifTrue: [		ServomotorSynchroMotion ifTrue: [			ServomotorNumber _ ServomotorNumber + 1.		].	].	submorphs do: [:m |		m ~~ nextB ifTrue: [			self printArduCodeSubmorph: m on: aStream.			hasFinalSpace _ true.			"aStream space"]].	"hasFinalSpace ifTrue: [aStream skip: -1]."	(self selector = 'contentsOfList:') ifTrue: [ aStream nextPutAll: ',1)'. ].	(selector = 'ledColor:onOff:')	ifTrue: [		((IOPort at: 11) = 5) ifTrue: [ aStream nextPutAll: ', 0);' ]		ifFalse: [ aStream nextPutAll: ', 1);' ].	].		aStream cr.	self nextBlock ifNotNil: [self nextBlock printArduCodeOn: aStream indent: indent].! !!CommandBlockMorph methodsFor: 'private' stamp: 'KK 12/23/2017 14:56'!uncoloredArgMorphFor: t1 	"Answer an argument morph for the given argument specification string."	| code |	" Check if a single character or a string."	(t1 size = 2) ifTrue: [		code _ t1 at: 2.	]	ifFalse: [		code _ t1 copyFrom: 2 to: (t1 size).].	$a = code ifTrue: [^ AttributeArgMorph new choice: 'volume'].	$A = code ifTrue: [^ PathSettingArgMorph new getOptionsSelector: #blockDotIniPath].	$b = code ifTrue: [^ BooleanArgMorph new].	$B = code ifTrue: [^ ChoiceArgMorph new getOptionsSelector: #bzrPinNo;		 choice: 'A0'].	$c = code ifTrue: [^ ColorArgMorph new showPalette: true].	$C = code ifTrue: [^ ColorArgMorph new showPalette: false].	$d = code ifTrue: [^ ExpressionArgMorphWithMenu new numExpression: '0';		 menuSelector: #directionMenu].	$D = code ifTrue: [^ ExpressionArgMorphWithMenu new numExpression: '48';		 menuSelector: #midiDrumMenu].	$e = code ifTrue: [^ EventTitleMorph new].	$E = code ifTrue: [^ NumericUpDownMorph new  setDefault:10 min:0 max:20 width:15 isEdit:true].	$f = code ifTrue: [^ ChoiceArgMorph new getOptionsSelector: #mathFunctionNames;		 choice: 'sqrt'].	$F = code ifTrue: [^ NumericUpDownMorph new  setDefault:90 min:0 max:180 width:20 isEdit:true].	$g = code ifTrue: [^ ChoiceArgMorph new getOptionsSelector: #graphicEffectNames;		 choice: 'color'].	$G = code ifTrue: [^ ChoiceArgMorph new getOptionsSelector: #hookupGyroAccXYZ].	$H = code ifTrue: [^ ChoiceArgMorph new getOptionsSelector: #hookupSensorNames].	$h = code ifTrue: [^ ChoiceArgMorph new getOptionsSelector: #hookupBooleanSensorNames].	$I = code ifTrue: [^ ExpressionArgMorphWithMenu new numExpression: '1';		 menuSelector: #midiInstrumentMenu].	$i = code ifTrue: [^ ExpressionArgMorphWithMenu new numExpression: '1';		 menuSelector: #listIndexMenu]."	$i = code ifTrue: [^ ExpressionArgMorph new numExpression: '10']."	$j = code ifTrue: [^ ChoiceArgMorph new getOptionsSelector: #dcMotorNo;		 choice: 'PIN'].	$J = code ifTrue: [^ ChoiceArgMorph new getOptionsSelector: #svMotorNo;		 choice: 'PIN'].	$k = code ifTrue: [^ ChoiceArgMorph new getOptionsSelector: #keyNames;		 choice: 'space'].	$L = code ifTrue: [^ ChoiceArgMorph new getOptionsSelector: #listVarMenu].	$l = code ifTrue: [^ ChoiceOrExpressionArgMorph new getOptionsSelector: #costumeNames;		 choice: 'costume1'].	$m = code ifTrue: [^ SpriteArgMorph new].	$M = code ifTrue: [^ ChoiceArgMorph new getOptionsSelector: #motorNames].	$n = code ifTrue: [^ ExpressionArgMorph new numExpression: '10'].	$N = code ifTrue: [^ ExpressionArgMorphWithMenu new numExpression: '60';		 menuSelector: #noteSelector].	$o = code ifTrue: [^ ChoiceArgMorph new getOptionsSelector: #ledOnOff;		 choice: 'on'].	$O = code ifTrue: [^ ChoiceArgMorph new getOptionsSelector: #hookupSoundPin].	$p = code ifTrue: [^ ChoiceArgMorph new getOptionsSelector: #ledPinNo;		 choice: 'A0'].	'p1' = code ifTrue: [^ ChoiceArgMorph new getOptionsSelector: #boardLED;			choice: 'Red(D5)'.].	$P = code ifTrue: [^ ChoiceArgMorph new getOptionsSelector: #hookupLightPin].	$q = code ifTrue: [^ ChoiceArgMorph new getOptionsSelector: #moveDirection;		 choice: 'Forward'].	$s = code ifTrue: [^ ExpressionArgMorph new stringExpression: ''].	$S = code ifTrue: [^ ChoiceOrExpressionArgMorph new getOptionsSelector: #soundNames;		 choice: 'pop'].	$t = code ifTrue: [^ ChoiceArgMorph new getOptionsSelector: #dcMotorOn;		 choice: 'cw.'].	$T = code ifTrue: [^ ChoiceArgMorph new getOptionsSelector: #dcMotorOff;		 choice: 'Brake'].	$v = code ifTrue: [^ ChoiceArgMorph new getOptionsSelector: #varNamesMenu;		 choice: ''].	$V = code ifTrue: [^ ChoiceArgMorph new getOptionsSelector: #hookupTouchPin].	$w = code ifTrue: [^ ChoiceArgMorph new getOptionsSelector: #temperaturePinNo].	$W = code ifTrue: [^ ChoiceArgMorph new getOptionsSelector: #motorDirection].	$x = code ifTrue: [^ ChoiceOrExpressionArgMorph new getOptionsSelector: #sceneNames;		 choice: ''].	$X = code ifTrue: [^ ChoiceArgMorph new getOptionsSelector: #hookupARButton].	$y = code ifTrue: [^ ExpressionArgMorphWithMenu new numExpression: '1';		 menuSelector: #listIndexForDeleteMenu]."	$y = code ifTrue: [^ ExpressionArgMorph new numExpression: '10']."	$Y = code ifTrue: [^ ChoiceArgMorph new getOptionsSelector: #hookupARSensorXYZ].	$z = code ifTrue: [^ ChoiceArgMorph new getOptionsSelector: #hookupARSensorNames].	$Z = code ifTrue: [^ ChoiceArgMorph new getOptionsSelector: #hookupIRPin].	'Z1' = code ifTrue: [^ ChoiceArgMorph new getOptionsSelector: #clockVars].^ ExpressionArgMorph new numExpression: '10'! !!CBlockMorph methodsFor: 'drawing' stamp: 'KK 2/27/2015 13:55'!drawOn: aCanvas 	| c |	topBarBottom _ self top + self topBarHeight.	self isForever		ifTrue: [blockBottom _ self bottom - 3]		ifFalse: [blockBottom _ self bottom - 7].	self computeHighlightColors.	c _ FormCanvas extent: self extent depth: 32.	c _ c copyOffset: self topLeft negated.	self drawTopEdgeOn: c.	self drawTopBarOn: c.	self drawVerticalBarOn: c.	self drawBottomBarOn: c.	self drawFinalOn: aCanvas fromCanvas: c.! !!CBlockMorph methodsFor: 'private' stamp: 'KK 8/20/2014 11:46'!attachBlock: aBlockMorph	"Attach the given block to me. Assume the block has been positioned correctly."	aBlockMorph top >= (self bottom - CBlockBracketThickness)		ifTrue: [			self addMorph: aBlockMorph.			nextBlock _ aBlockMorph.		]		ifFalse: [			((self selector = #doSvmSyncMotion) | (self selector = #doSvmSyncMotion2)) ifTrue: [				" self is Servomotor synchro motion block. "				(aBlockMorph selector = #motorNo:degree:) ifTrue: [					" aBlockMorph is servomotor block. "					(self isOnlyServo: aBlockMorph) ifTrue: [						self addMorph: aBlockMorph.						nestedBlock _ aBlockMorph.					].				].			]			ifFalse: [				self addMorph: aBlockMorph.				nestedBlock _ aBlockMorph.			]		].! !!CBlockMorph methodsFor: 'private' stamp: 'sk 5/20/2016 21:21'!printArduCodeOn: aStream indent: indent	| localIndent localArg strDelayMsecPerDeg |	"Append a human-readable string for this block on the given stream."	indent timesRepeat: [aStream nextPutAll: '    '].	localIndent _ indent.	"if (T/F) for(;;)"	(selector = 'doForeverIf')	ifTrue: [		aStream nextPutAll: 'for(;;) {'.		aStream cr.		localIndent _ localIndent + 1.		(localIndent) timesRepeat: [aStream nextPutAll: '    '].	].	((selector = 'doSvmSyncMotion') | (selector = 'doSvmSyncMotion2'))	ifTrue: [		submorphs do: [:m |			(m ~~ nestedBlock) & (m ~~ nextBlock) & ((m isKindOf: StringMorph) not) ifTrue:	[				(m isKindOf: NumericUpDownMorph) ifTrue: [					ServomotorNumber _ 0.					ServomotorSynchroMotion _ true.					strDelayMsecPerDeg _ m labelMorph contents.				] ifFalse: [					localArg _ WriteStream on: (String new: 10000).					self printArduCodeSubmorph: m on: localArg.					strDelayMsecPerDeg _ localArg contents.					ServomotorNumber _ 0.					ServomotorSynchroMotion _ true.				].			].		].	] ifFalse: [		(selector = 'doRepeat') ifTrue: [			FirstSubMorphOfdoRepeat _ true.		" First sub morph? "			aStream nextPutAll: 'int loopCounter'.			aStream nextPutAll: NumberOfdoRepeat asString.			aStream nextPutAll: ' = '.			submorphs do: [:m |				(m ~~ nestedBlock) & (m ~~ nextBlock) ifTrue: [					self printArduCodeSubmorph: m on: aStream.					(FirstSubMorphOfdoRepeat) ifTrue: [						aStream nextPutAll: ';';cr.						indent timesRepeat: [aStream nextPutAll: '    '].						FirstSubMorphOfdoRepeat _ false.					].				].			].			" aStream is {for (int i = 0; i <} "			aStream nextPutAll: 'loopCounter'.			aStream nextPutAll: NumberOfdoRepeat asString.			aStream nextPutAll: '; i++) {'.			" Increment number of doRepeat Block "			NumberOfdoRepeat _ NumberOfdoRepeat + 1.			localIndent _ localIndent + 1.		]		ifFalse: [			submorphs do: [:m |				(m ~~ nestedBlock) & (m ~~ nextBlock) ifTrue: [					self printArduCodeSubmorph: m on: aStream.					aStream space ]].			localIndent _ localIndent + 1.		].	].	aStream cr.	nestedBlock ifNotNil: [nestedBlock printArduCodeOn: aStream indent: localIndent].	"if (T/F) for(;;)"	(selector = 'doForeverIf')	ifTrue: [		localIndent _ localIndent - 1.		(localIndent) timesRepeat: [aStream nextPutAll: '    '].		aStream nextPutAll: '}'; cr.	].	" For Studuino mini Clock. "	(BoardType = 1) ifTrue: [	((selector = 'doForever') & ((IOPort at: 19) = 6)) ifTrue: [		localIndent timesRepeat: [aStream nextPutAll: '    '].		aStream nextPutAll: 'board.sleep();'; cr.].].	"for(;;) / for(int i = 0;i < N;i++) / if (T/F) for(;;) / if(T/F) / while(T/F)"	((selector = 'doForever') | (selector = 'doRepeat') | (selector = 'doForeverIf') | (selector = 'doIf') | (selector = 'doUntil'))	ifTrue: [		localIndent _ localIndent - 1.		(localIndent) timesRepeat: [aStream nextPutAll: '    '].		aStream nextPutAll: '}'; cr.	].	(selector = 'doSvmSyncMotion')	ifTrue: [		ServomotorSynchroMotion _ false.		(localIndent) timesRepeat: [aStream nextPutAll: '    '].		aStream			nextPutAll: 'board.SyncServomotors(port, degree, ';			nextPutAll: ServomotorNumber asString;			nextPutAll: ', SYNCSVRANGE(scratchRound(';			nextPutAll: strDelayMsecPerDeg asString;			nextPutAll: '))+3);'; cr.	].	(selector = 'doSvmSyncMotion2')	ifTrue: [		ServomotorSynchroMotion _ false.		(localIndent) timesRepeat: [aStream nextPutAll: '    '].		aStream			nextPutAll: 'board.SyncServomotors(port, degree, ';			nextPutAll: ServomotorNumber asString;			nextPutAll: ', SYNCSVRANGE(scratchRound(20-';			nextPutAll: strDelayMsecPerDeg asString;			nextPutAll: '))+3);'; cr.	].	nextBlock ifNotNil: [nextBlock printArduCodeOn: aStream indent: indent].! !!CBlockMorph methodsFor: 'evaluation' stamp: 'KK 5/1/2014 17:12'!evaluateWithArgs: rawArgs	| |	^ receiver doSvmSyncMotion: rawArgs.! !!ConfigureBoardMorph methodsFor: 'initialization' stamp: 'KK 8/16/2013 17:29'!addReadoutLabeled: aString	"Add a readout row with the given label. Answer the stringmorph that's the readout."	| row box readout |	row _ AlignmentMorph newRow color: column color; inset: 2.	row addMorphBack: (Morph new color: column color; extent: 1@3). "spacer"	row addMorphBack: (StringMorph contents: aString capitalized font: (StrikeFont fontName: 'VerdanaBold' size: 10)).	row addMorphBack: (AlignmentMorph new color: column color; extent: 10@1; hResizing: #spaceFill).  "spacer"	box _ WatcherReadoutFrameMorph new		extent: 42@14;		color: (ScriptableScratchMorph blockColorFor: 'sensing').	readout _ StringMorph contents: '0' font: (StrikeFont fontName: 'VerdanaBold' size: 10).	readout color: Color white.	box addMorph: readout.	row addMorphBack: box.	column addMorphBack: row.	^ readout! !!ConfigureBoardMorph methodsFor: 'initialization' stamp: 'KK 8/16/2013 17:29'!addReadouts	| readoutNames |	readoutNames _ #(		'A0'		'A1'		'A2'		'A3'		'A4'		'A5'		'A6'		'A7'	).	column _ AlignmentMorph newColumn		centering: #center;		hResizing: #spaceFill;		vResizing: #shrinkWrap;		color: (Color r: (193/255) g: (196/255) b: (199/255));		borderWidth: 2;		borderColor: (Color r: (148/255) g: (145/255) b: (145/255));		useRoundedCorners;		inset: 3.	titleMorph _ StringMorph		contents: ''		font: (StrikeFont fontName: 'VerdanaBold' size: 10).	column addMorph: titleMorph.	self updateTitle.	column addMorphBack: (Morph new color: column color; extent: 5@3).  "spacer"	self removeAllMorphs.	readouts _ readoutNames collect: [:i |		(i size = 1)			ifTrue:[self addReadoutLabeled: i]			ifFalse:[self addReadoutLabeled: i localized]].	column position: self position - 2.	self addMorph: column.	self extent: column extent - 4.! !!ConfigureBoardMorph methodsFor: 'initialization' stamp: 'KK 8/16/2013 17:29'!data: d msgID: id	"I make message and send it to board."	| mid high low msgh msgl msg carry |"self halt."	mid _ id bitShift: 4.			" mid = id << 4 "	high _ d bitShift: -8.		" high = d >> 8"	carry _ d bitShift: -7.		" low side carry = d >> 7"	carry _ carry bitAnd: 16r01.	" carry = carry & 0x01"	high _ high + carry.		" high = high + carry"	high _ high bitAnd: 16r0F.	" high = high & 0x0F"	low _ d bitAnd: 16r7F.		" low = d & 0x7F"	msgh _ 16r80 + mid + high.	" msgh = 0x80 + mid + high"	msgl _ low.					" msgl = low"	msg _ #(0 0) asByteArray.	msg at: 1 put:msgh.	msg at: 2 put: msgl."Transcriptshow:msgh;show:', ';show:msgl;cr."	port nextPutAll: msg.! !!ConfigureBoardMorph methodsFor: 'initialization' stamp: 'KK 8/16/2013 18:23'!initialize	super initialize.	sensorValues _ Array new: 16 withAll: 0.	currentState _ #idle.	highByte _ 0.	useGoGoProtocol ifNil: [useGoGoProtocol _ false].	scratchBoardV3 _ false.	reportRaw _ false.	scanState _ #off.	self addReadouts.! !!ConfigureBoardMorph methodsFor: 'accessing' stamp: 'KK 8/16/2013 17:29'!isScriptable	"I am not scriptable."	^ false! !!ConfigureBoardMorph methodsFor: 'sensor ops' stamp: 'KK 8/16/2013 17:29'!privateSensor: t1 	| t2 t3 |	t2 _ (t1 asInteger max: 1)				min: 8.	useGoGoProtocol		ifFalse: [scratchBoardV3				ifTrue: [t2 _ #(8 6 7 4 5 3 2 1 ) at: t2]				ifFalse: [t2 _ #(1 2 3 4 5 6 7 8 ) at: t2]]."				ifFalse: [t2 _ #(5 6 7 8 1 2 3 4 ) at: t2]]."	t3 _ sensorValues at: t2.	reportRaw _ true.			" return Rawdata "	reportRaw ifTrue: [^ t3].	scratchBoardV3		ifTrue: 			[t2 = 6 ifTrue: [^ self scaleLight: t3].			t2 = 7 ifTrue: [^ self scaleSound: t3]].	t3 > 1020 ifTrue: [t3 _ 1023].! !!ConfigureBoardMorph methodsFor: 'sensor ops' stamp: 'KK 8/16/2013 17:29'!sensor: sensorIndex	"Answer the value of the virtual sensor with the given index. Sensors are numbered 1-8."	^ self privateSensor: sensorIndex! !!ConfigureBoardMorph methodsFor: 'sensor ops' stamp: 'KK 8/16/2013 17:29'!startReadingData	"Ensure that the serial port is open, turn off all motors and put them into a known state, and begin streaming sensor data."	self portIsOpen ifFalse: [^ self].  "could not open the serial port"	currentState _ #idle.	sensorValues atAllPut: 0.	scratchBoardV3 _ false.	self startStreamingSensors: 0.  "in case board was left in streaming mode"	port flushInputBuffer.	useGoGoProtocol ifTrue: [		1 to: 6 do: [:motor |			self turnOffMotor: motor.			self thisWayMotor: motor.			self setPower: 3 motor: motor.			self turnOffMotor: motor].		self startStreamingSensors: 16rFF].  "all 8 sensors"! !!ConfigureBoardMorph methodsFor: 'sensor ops' stamp: 'KK 8/16/2013 17:29'!stopReadingData	"Turn off all motors, stop streaming data, and close the port."	(port notNil and: [port isOpen]) ifTrue: [		useGoGoProtocol ifTrue: [			1 to: 6 do: [:motor | self turnOffMotor: motor].			self startStreamingSensors: 0]].  "turn off streaming"	self closePort.! !!ConfigureBoardMorph methodsFor: 'motor ops' stamp: 'KK 8/16/2013 17:29'!coastToStopMotor: motorNum	"Let the given motor coast to a stop."	self portIsOpen ifFalse: [^ self].	self selectMotor: motorNum.	port nextPutAll: #(84 254 84) asByteArray.! !!ConfigureBoardMorph methodsFor: 'motor ops' stamp: 'KK 8/16/2013 17:29'!reverseMotor: motorNum	"Reverse the direction of the given motor."	self portIsOpen ifFalse: [^ self].	self selectMotor: motorNum.	port nextPutAll: #(84 254 72) asByteArray.! !!ConfigureBoardMorph methodsFor: 'motor ops' stamp: 'KK 8/16/2013 17:29'!selectMotor: anInteger	"Select the motor to which subsequent motor commands will be addressed. Motors are numbered 1-6."	| motorNum msg |	motorNum _ (anInteger truncated - 1 max: 0) min: 7. "motor bit index"	msg _ #(84 254 128 0) asByteArray.	msg at: 4 put: (1 bitShift: motorNum).	port nextPutAll: msg.! !!ConfigureBoardMorph methodsFor: 'motor ops' stamp: 'KK 8/16/2013 17:29'!setPower: aNumber motor: motorNum	"Set the power of the given motor to 0 to 7."	| power msg |	self portIsOpen ifFalse: [^ self].	self selectMotor: motorNum.	power _ (aNumber truncated max: 0) min: 7.	msg _ #(84 254 0) asByteArray.	msg at: 3 put: 96 + (power bitShift: 2).	port nextPutAll: msg.! !!ConfigureBoardMorph methodsFor: 'motor ops' stamp: 'KK 8/16/2013 17:29'!thatWayMotor: motorNum	"Set motor direction to that way."	self portIsOpen ifFalse: [^ self].	self selectMotor: motorNum.	port nextPutAll: #(84 254 80) asByteArray.! !!ConfigureBoardMorph methodsFor: 'motor ops' stamp: 'KK 8/16/2013 17:29'!thisWayMotor: motorNum	"Set motor direction to this way."	self portIsOpen ifFalse: [^ self].	self selectMotor: motorNum.	port nextPutAll: #(84 254 76) asByteArray.! !!ConfigureBoardMorph methodsFor: 'motor ops' stamp: 'KK 8/16/2013 17:29'!turnOffMotor: motorNum	self portIsOpen ifFalse: [^ self].	self selectMotor: motorNum.	port nextPutAll: #(84 254 68) asByteArray.! !!ConfigureBoardMorph methodsFor: 'motor ops' stamp: 'KK 8/16/2013 17:29'!turnOnMotor: motorNum	self portIsOpen ifFalse: [^ self].	self selectMotor: motorNum.	port nextPutAll: #(84 254 64) asByteArray.! !!ConfigureBoardMorph methodsFor: 'stepping' stamp: 'KK 8/16/2013 17:29'!step	"Update my title and sensor readouts. If scanning for ports, keep scanning."	| frame |"Transcriptshow:'SensorBoardMorph::step';cr."	#checkData = scanState ifTrue: [self scanForPort].	self portIsOpen		ifTrue: [self processIncomingData]		ifFalse: [port _ nil].	self updateTitle.	1 to: 8 do: [:i |		(readouts at: i) contents: (self privateSensor: i) truncated printString.		(scratchBoardV3 and: [i = 4])			ifTrue: [(readouts at: i) contents: ((self privateSensor: i) < 10) printString]. "button"		frame _ (readouts at: i) owner.		(frame respondsTo: #fixLayout) ifTrue: [frame fixLayout]].! !!ConfigureBoardMorph methodsFor: 'stepping' stamp: 'KK 8/16/2013 17:29'!stepTime	^ 50! !!ConfigureBoardMorph methodsFor: 'serial port' stamp: 'KK 8/16/2013 17:29'!closePort	port ifNotNil: [		self data:0 msgID:7.	"Send End of Communication to PC"		port flushInputBuffer.		port close].	port _ nil.	currentState _ #idle.	sensorValues atAllPut: 0.	scratchBoardV3 _ false.	1 to: 8 do: [:i | (readouts at: i) contents: '0'].	scanState _ #off.	self step.! !!ConfigureBoardMorph methodsFor: 'serial port' stamp: 'KK 8/16/2013 17:29'!openPort: aString	"Close the serial port if it is open, then open the port with the given name and initialize streaming of sensor data. Answer true if the operation was successful."	| baudRate portNum numStart |	baudRate _ useGoGoProtocol ifTrue: [9600] ifFalse: [38400].	self closePort.	portName _ aString.	ScratchPlugin serialPortOpsAvailable		ifTrue: [			port _ SerialPort2 new openPortNamed: portName baud: baudRate.			port isOpen ifFalse: [port _ nil. ^ false].			port setOption: 20 to: 1.  "set DTR high"			port setOption: 21 to: 0]  "set RTS low"		ifFalse: [			portNum _ 1.			numStart _ (1 to: portName size) detect: [:i | (portName at: i) isDigit] ifNone: [0].			numStart > 0 ifTrue: [portNum _ (portName copyFrom: numStart to: portName size) asNumber].			port _ SerialPort new				baudRate: baudRate;				inputFlowControlType: 2;				openPort: portNum ifFail: [^ false]].	"initialize polling state"	lastPollMSecs _ Time millisecondClockValue.	^ true! !!ConfigureBoardMorph methodsFor: 'serial port' stamp: 'KK 8/16/2013 17:29'!portIsOpen	^ port notNil and: [port isOpen]! !!ConfigureBoardMorph methodsFor: 'serial port' stamp: 'KK 8/16/2013 17:29'!portNames	"Answer a collection of possible port names for the Scratch sensor board. Filter out modems and PDA cradles."	ScratchPlugin serialPortOpsAvailable ifFalse: [		^ (1 to: 32) collect: [:i | 'COM', i printString]].	^ SerialPort2 portNames reject: [:n |		(n asLowercase includesSubString: 'modem') or:		[n asLowercase includesSubString: 'pda-sync']].! !!ConfigureBoardMorph methodsFor: 'serial port' stamp: 'KK 8/16/2013 17:29'!resetPort	"If the port is closed, do nothing. If it is open, close and reopen it. This can be used to reset the Prolific USB serial driver if it misbehaves."	self portIsOpen ifFalse: [^ self].	portName ifNil: [^ self].	self closePort.	self openPort: portName.	scanState _ #on.	self step.! !!ConfigureBoardMorph methodsFor: 'serial port' stamp: 'KK 8/16/2013 17:29'!scanForPort	"Try to find the serial port that the sensor board is attached to. This is incremental--each time it is called it does the next task."	"Details: scanState is one of: #(off, start, checkData, on). scanPorts is a list of port names to try. Attempt to open each port in turn, then wait for a while and see if Scratch Sensor data of the right form has arrived."	| msecs buf i |	#off = scanState ifTrue: [self scanNextPort].	#on = scanState ifTrue: [  "if port is open, close it and start a new scan"		scanPorts _ nil.		self scanNextPort].	#start = scanState ifTrue: [		(scanPorts isNil or: [scanPorts size = 0]) ifTrue: [			scanPorts _ self portNames asOrderedCollection].		scanPorts size = 0 ifTrue: [^ self scanNextPort].		self openPort: scanPorts removeFirst.		self portIsOpen ifFalse: [^ self].		scanState _ #checkData.		scanStartMSecs _ Time millisecondClockValue.		^ self].	#checkData = scanState ifTrue: [		msecs _ Time millisecondClockValue - scanStartMSecs.		(self portIsOpen not or: [msecs > 4000]) ifTrue: [^ self scanNextPort].		port nextPut: 1.  "send poll byte"		((buf _ port readByteArray) size < 10) ifTrue: [^ self].  "no data yet"		"check that the data is in Scratch Sensor Board format"		i _ (buf first bitAnd: 128) > 0 ifTrue: [1] ifFalse: [2].		[i < (buf size - 1)] whileTrue: [			(((buf at: i) bitAnd: 128) > 0 and:			 [((buf at: i + 1) bitAnd: 128) = 0]) ifFalse: [^ self scanNextPort].			i _ i + 2].		scanState _ #on].! !!ConfigureBoardMorph methodsFor: 'serial port' stamp: 'KK 8/16/2013 17:29'!scanNextPort	"Called during port scanning. The current port does not seem to be a ScratchBoard. Close it and try the next port in the list."	self closePort.	scanState _ #start.! !!ConfigureBoardMorph methodsFor: 'serial port' stamp: 'KK 8/16/2013 17:29'!selectPort	| menu choice |	self stopReadingData.	self portNames size = 0 ifTrue: [^ DialogBoxMorph inform: 'No serial ports found'].	menu _ CustomMenu new.	self portNames do: [:n | menu add: n action: n].	choice _ menu startUp.	choice ifNil: [^ self].	self openPort: choice.	self startReadingData.	scanState _ #on.	ResetCounter _ 0.! !!ConfigureBoardMorph methodsFor: 'serial port' stamp: 'KK 8/16/2013 17:29'!tryToOpenPort	"Attempt to open the port. If successful, or if the port was open already, answer true. Otherwise, answer false."	(port notNil and: [port isOpen and: [scanState = #on]]) ifTrue: [^ true].  "already open"	self scanForPort.	^ port notNil and: [port isOpen]! !!ConfigureBoardMorph methodsFor: 'serial port' stamp: 'KK 8/16/2013 17:29'!useGoGoProtocol	self stopReadingData.	useGoGoProtocol _ true.	scratchBoardV3 _ false.	self startReadingData.! !!ConfigureBoardMorph methodsFor: 'serial port' stamp: 'KK 8/16/2013 17:29'!useScratchboardProtocol	self stopReadingData.	useGoGoProtocol _ false.	self startReadingData.! !!ConfigureBoardMorph methodsFor: 'event handling' stamp: 'KK 8/16/2013 17:29'!handlesMouseDown: evt	^ true! !!ConfigureBoardMorph methodsFor: 'event handling' stamp: 'KK 8/16/2013 17:29'!mouseDown: evt	evt rightButtonPressed | evt shiftPressed		ifTrue: [Sensor waitNoButton. ^ self rightButtonMenu].	evt hand toolType = 'CutTool' ifTrue: [		evt shiftPressed ifFalse: [evt hand toolType: nil].		ScratchFrameMorph putInClipboard: self.		^ self delete].	evt hand waitForClicksOrDrag: self event: evt.! !!ConfigureBoardMorph methodsFor: 'event handling' stamp: 'KK 8/16/2013 17:29'!mouseHold: evt	self rightButtonMenu.! !!ConfigureBoardMorph methodsFor: 'event handling' stamp: 'KK 8/16/2013 17:29'!preemptsMouseDown: evt	^ true! !!ConfigureBoardMorph methodsFor: 'event handling' stamp: 'KK 8/16/2013 17:29'!rightButtonMenu	| menu |	menu _ CustomMenu new.	Sensor shiftPressed		ifTrue: [			reportRaw				ifTrue: [menu add: 'stop reporting raw data' action: #toggleRawMode]				ifFalse: [menu add: 'report raw data' action: #toggleRawMode].			useGoGoProtocol				ifTrue: [menu add: 'use Scratch board' action: #useScratchboardProtocol]				ifFalse: [menu add: 'use GoGo board' action: #useGoGoProtocol]]		ifFalse: [			menu add: 'select serial/USB port' action: #selectPort.			self portIsOpen				ifTrue: [menu add: 'close port' action: #stopReadingData].			menu addLine.			menu add: 'hide' action: #delete].	menu localize; invokeOn: self.! !!ConfigureBoardMorph methodsFor: 'event handling' stamp: 'KK 8/16/2013 17:29'!toggleRawMode	reportRaw _ reportRaw not.! !!ConfigureBoardMorph methodsFor: 'dropping/grabbing' stamp: 'KK 8/16/2013 17:29'!justDroppedInto: newOwner event: evt	"Only allow embedding into the stage; otherwise, float (i.e. be a submorph of the world)."	(newOwner isKindOf: ScratchStageMorph) ifFalse: [ "only embed in the work pane"		self world addMorph: self].! !!ConfigureBoardMorph methodsFor: 'object i/o' stamp: 'KK 8/16/2013 17:29'!fieldsVersion	^ 1! !!ConfigureBoardMorph methodsFor: 'object i/o' stamp: 'KK 8/16/2013 17:29'!initFieldsFrom: anObjStream version: classVersion	super initFieldsFrom: anObjStream version: classVersion.	anObjStream nextField.  "skip old portNum field"	self addReadouts.! !!ConfigureBoardMorph methodsFor: 'object i/o' stamp: 'KK 8/16/2013 17:29'!storeFieldsOn: anObjStream	super storeFieldsOn: anObjStream.	anObjStream putField: 1.  "old portNum instance variable"! !!ConfigureBoardMorph methodsFor: 'private' stamp: 'KK 8/16/2013 17:29'!ping	"Answer true if a GoGoBoard is connected to my serial port."	| buf |	port flushInputBuffer.	port nextPutAll: #(84 254 0) asByteArray.	buf _ port next: 3.	^ buf = #(85 255 170) asByteArray! !!ConfigureBoardMorph methodsFor: 'private' stamp: 'KK 8/16/2013 17:29'!processGoGoByte: aByte	"Process one byte of the incoming data stream from a GoGoBoard."	"Details: This code recognizes three-byte sensor update messages starting with 16r0C using a simple, three-state finite state machine. We assume that sensor updates are always contiguous--that is, replies to motor or other GoGo board commands will not be inserted between the bytes of any given three-byte sensor update message. The sensor number is the top three bits of the byte two. The data value is the bottom two bits of byte two plus all eight bits of byte three."	| sensorNum val |	currentState = #idle ifTrue: [ 		aByte = 16r0C ifTrue: [currentState _ #startByteSeen].		^ self].	currentState = #startByteSeen ifTrue: [		highByte _ aByte.		currentState _ #highByteSeen.		^ self].	currentState = #highByteSeen ifTrue: [		"final byte of message: report the sensor value"		sensorNum _ (highByte bitShift: -5) + 1.		val _ ((highByte bitAnd: 3) bitShift: 8) + aByte.		(sensorNum between: 1 and: 8) ifTrue: [			sensorValues at: sensorNum put: val].		currentState _ #idle].! !!ConfigureBoardMorph methodsFor: 'private' stamp: 'KK 8/16/2013 17:29'!processIncomingData	"Process incoming bytes from the serial port."	"Details: To work around a problem with the Prolific USB-Serial drivers on some Windows machines, a strict turn-taking polling protocol is used. A poll byte is sent, the ScratchBoard sends a response, and after a small delay (to be sure that all the data from the last poll has arrived, another poll is sent. The goal is to never allow more that few bytes to accumulate in the serial input buffer and to avoid sending a poll byte while data is arriving. However, since different versions of the ScratchBoard may send different amounts of data, we don't want to hard-code the number of reply bytes. Thus"	| buf msecsSinceLastPoll |	(self portIsOpen and: [#on = scanState]) ifFalse: [^ self].	useGoGoProtocol ifTrue: [		buf _ port readByteArray.		buf do: [:b | self processGoGoByte: b].		^ self].	msecsSinceLastPoll _ Time millisecondClockValue - lastPollMSecs.	msecsSinceLastPoll < 20 ifTrue: [^ self].	buf _ port readByteArray."Transcriptshow:'SensorBoardMorph::processIncomingData';cr."	" Corresponding disconnection  "	(buf size = 0)	ifTrue: [	" The case of disconnection "Transcriptshow:'reset port : ';show:ResetCounter;cr.		" Increment ResetCounter "		ResetCounter _ (ResetCounter + 1).		(ResetCounter = 10) ifTrue: [				ResetCounter _ 0.	" Initialize ResetCounter "			self resetPort.		" reset port. "		].	]	ifFalse: [ 	" The case of connection "		ResetCounter _ 0.		" Initialize ResetCounter "	].	buf do: [:b | self processScratchByte: b]."	port nextPut: 1."	"send a ScratchBoard V4 poll byte"	lastPollMSecs _ Time millisecondClockValue.! !!ConfigureBoardMorph methodsFor: 'private' stamp: 'KK 8/16/2013 17:29'!processScratchByte: aByte	"Process one byte of the incoming data stream from a Scratch sensor board."	"Sensor messages are two bytes with the following format:		Byte1: <1><sensor number (4 bits)><sensor value high bits (3 bits)>		Byte2: <0><sensor value low bits (7 bits)>"	| sensorNum val |"Transcriptshow:'processScratchByte';cr."	currentState = #idle ifTrue: [  "wait for first byte of message"		(aByte bitAnd: 16r80) > 0 ifTrue: [			currentState _ #firstByteSeen.			highByte _ aByte].		^ self].	currentState = #firstByteSeen ifTrue: [		(aByte bitAnd: 16r80) > 0 ifTrue: [  "must have lost second byte; stay in firstByteSeen state"			highByte _ aByte.			^ self].		"good second byte: report the sensor value"		sensorNum _ ((highByte bitShift: -3) bitAnd: 16rF) + 1.		val _ ((highByte bitAnd: 7) bitShift: 7) + (aByte bitAnd: 16r7F).		sensorNum <= sensorValues size ifTrue: [			sensorValues at: sensorNum put: val.			sensorNum = 16 ifTrue: [				(val == 3) | (val == 4) ifTrue: [					scratchBoardV3 _ true]]].  "ScratchBoard, version 3 or 4"		currentState _ #idle].! !!ConfigureBoardMorph methodsFor: 'private' stamp: 'KK 8/16/2013 17:29'!scaleLight: val	val <= 25 ifTrue: [^ 100 - val].	^ ((1023 - val) * (75.0 / 998)) rounded! !!ConfigureBoardMorph methodsFor: 'private' stamp: 'KK 8/16/2013 17:29'!scaleSound: val	| n |	n _ ((val - 18) max: 0) min: 630.	n < 50 ifTrue: [^ n / 2.0].  "0 to 25"	^ 25.0 + ((n - 50) * (75.0 / 580.0))! !!ConfigureBoardMorph methodsFor: 'private' stamp: 'KK 8/16/2013 17:29'!startStreamingSensors: sensorByte	"Begin streaming data from the set of sensors specified by the bits of the given byte. Invoke this method with 0 to stop streaming. Incoming sensor data is processed by frequent calls to processIncomingData."	| cmd |	useGoGoProtocol ifFalse: [^ self].	port flushInputBuffer.	cmd _ #(84 254 160 0) asByteArray.	cmd at: 4 put: sensorByte.	port nextPutAll: cmd.! !!ConfigureBoardMorph methodsFor: 'private' stamp: 'KK 8/16/2013 17:29'!updateTitle	"Update my title to reflect the current protocol and port number."	| s |	s _ (#on = scanState) ifTrue: ['On' localized] ifFalse: ['Off' localized].	s = titleMorph contents ifFalse: [titleMorph contents: s].! !!DCSliderMorph2 methodsFor: 'scrolling' stamp: 'KK 1/30/2018 14:19'!scrollAbsolute: event	| sFrame sScript |	super scrollAbsolute: event.		(sFrame _ self ownerThatIsA: ScratchFrameMorph) ifNil: [		Transcript show:'sFrame nil';cr.	].	(sScript _ self ownerThatIsA: ScriptableScratchMorph) ifNil: [		Transcript show:'sScript nil';cr.	].	Transcript show:self getScaledValue;cr.! !!DCSliderMorph2 methodsFor: 'event handling' stamp: 'KK 2/8/2018 13:45'!mouseDown: evt	(MotorCalibMorph2 dcCalibStatus = 1) ifTrue: [	" start "		super mouseDown: evt.	].! !!DCSliderMorph2 methodsFor: 'event handling' stamp: 'KK 2/8/2018 13:45'!mouseMove: evt	| calibMorph ratio |	(MotorCalibMorph2 dcCalibStatus = 1) ifTrue: [		super scrollAbsolute: evt.		(calibMorph _ self ownerThatIsA: MotorCalibMorph2) ifNotNil: [			ratio _ self getScaledValue.			calibMorph motorNo: (self getPortName) calibrationPower: ((ratio * 100) truncated).			calibMorph motorNo: (self getPortName) displayPower: ratio.		].	].! !!DCSliderMorph2 methodsFor: 'private' stamp: 'KK 1/30/2018 14:20'!getPortName	"Get M1 or M2 port Name"	^ portName.! !!DCSliderMorph2 methodsFor: 'private' stamp: 'KK 2/2/2018 11:17'!setDisplayValue: val	"Set M1 or M2 port Name"	display _ val.! !!DCSliderMorph2 methodsFor: 'private' stamp: 'KK 1/30/2018 14:20'!setPortName: name	"Set M1 or M2 port Name"	portName _ name.! !!DialogBoxMorph methodsFor: 'geometry' stamp: 'KK 7/24/2017 12:58'!fixLayoutForExtent: aPoint	| xPos yPos shortcutWidth fileColumnWidth |	shortcutColumn ifNil: [^ self].	xPos _ self left + 20.	yPos _ self top + 40.	"position and size the shortcut column"	shortcutColumn position: xPos@yPos.	shortcutWidth _ 0.	shortcutColumn submorphsDo: [: m |		shortcutWidth _ m width max: shortcutWidth].	shortcutColumn submorphsDo: [: m |		m width: shortcutWidth].	"position main column"	mainColumn position: (shortcutColumn right + 5)@yPos.	"position and size the fileInfo column"	fileInfoColumn position: (mainColumn right + 5)@yPos.	fileColumnWidth _ 0.	fileInfoColumn submorphsDo: [: m |		fileColumnWidth _ m width max: fileColumnWidth].	fileInfoColumn submorphsDo: [: m |		(m isKindOf: StringMorph)			ifFalse: [m width: fileColumnWidth]].	"position and size title"	titleBin left: self left.	titleBin width: shortcutColumn width + mainColumn width + fileInfoColumn width + 55.	"add a bottom spacer to the tallest column"	bottomSpacer ifNil: [		bottomSpacer _ (Morph new extent: (5@22); color: Color transparent).		(shortcutColumn height > mainColumn height)			ifTrue: [shortcutColumn addMorphBack: bottomSpacer]			ifFalse: [(mainColumn height > fileInfoColumn height)				ifTrue: [mainColumn addMorphBack: bottomSpacer]				ifFalse: [fileInfoColumn addMorphBack: bottomSpacer]]].! !!DialogBoxMorph methodsFor: 'geometry' stamp: 'sk 2/6/2017 11:31'!topCenterOnScreen	"Center myself on the screen, if possible. Otherwise, adjust position so buttons are visible."	| w |	w _ self world.	self extent: self extent.  "force layout"	self position: ((w width // 2) - (self width // 2))@5.  "top center on screen but disregard the shadow on the bottom"	self bottom > w bottom ifTrue: [		self bottom: w bottom + 37.  "make sure cancel button is on screen"		self top > -2 ifTrue: [self top: -2]]. "make top flush with the top of the screen"	(self top < -2 and: [self top > -34]) ifTrue: [		"if title bar partway off screen, move it all the way off"		self top: -34].! !!DividedImageFrameMorph methodsFor: 'initialize' stamp: 'KK 4/18/2014 12:31'!initFrontFromForm: aForm topSectionHeight: aNumber	| w h |	super initFrontFromForm: aForm.	topSectionHeight _ aNumber.	leftMargin _ 0.	rightMargin _ 0.	middleBarForm _ ScratchFrameMorph skinAt: #dividedImageFrameBar.	w _ (middleBarForm width // 2) + 2.	h _ middleBarForm height.	leftJointForm _ middleBarForm copy: (0@0 extent: w@h).	rightJointForm _ middleBarForm copy: ((middleBarForm width - w) @ 0 extent: w@h).! !!DividedImageFrameMorph methodsFor: 'accessing' stamp: 'ee 10/30/2008 13:37'!middleBarLeftMargin: aNumber rightMargin: aNumber2	leftMargin _ aNumber.	rightMargin _ aNumber2.! !!DividedImageFrameMorph methodsFor: 'drawing' stamp: 'ee 1/28/2009 16:11'!drawDividerOn: aCanvas	"Draw my divider edge."	| w r f slice |	w _ self width - (leftJointForm width + rightJointForm width) - leftMargin - rightMargin.	r _ ((self left + leftJointForm width + leftMargin) @ (self top + topSectionHeight - 4))		extent: (w @ middleBarForm height).	f _ edgeCache at: 5.	(f isNil or: [f extent ~= r extent]) ifTrue: [		f _ Form extent: r extent depth: 32.		slice _ middleBarForm copy: (((middleBarForm width // 2) @ 0) extent: (1 @ r height)).		0 to: r width by: slice width do: [:x | slice displayOn: f at: x@0 rule: Form blend].		edgeCache at: 5 put: f].	aCanvas translucentImage: f at: r topLeft.! !!DividedImageFrameMorph methodsFor: 'drawing' stamp: 'ee 1/28/2009 16:11'!drawFrameOn: aCanvas	super drawFrameOn: aCanvas.	self drawDividerOn: aCanvas.	"draw middle bar left and right joints"	aCanvas		translucentImage: leftJointForm		at: self topLeft + (leftMargin@(topSectionHeight-4)).	aCanvas		translucentImage: rightJointForm		at: (self right - rightJointForm width - rightMargin) @ (self top + topSectionHeight - 4).! !!EventTitleMorph methodsFor: 'accessing' stamp: 'KK 8/2/2013 12:59'!printArduArgOn: aStream	"Print this argument morph on the given stream."	aStream nextPut: $".	aStream nextPutAll: self labelMorph contents.	aStream nextPut: $".! !!EventTitleMorph methodsFor: 'accessing' stamp: 'KK 8/2/2013 13:00'!printArgOn: aStream	"Print this argument morph on the given stream."	aStream nextPutAll: self labelMorph contents.! !!EventTitleMorph methodsFor: 'queries' stamp: 'KK 8/2/2017 14:01'!acceptsDroppedReporters	"Accept reporter blocks in broadcast blocks but not in 'when I receive' hat block."	^ owner isKindOf: CommandBlockMorph! !!EventTitleMorph methodsFor: 'event handling' stamp: 'sk 9/21/2016 19:27'!handlesMouseDown: evt	^ evt hand toolType isNil and:		[(self topLeft corner: self bottomRight) containsPoint: evt cursorPoint]! !!EventTitleMorph methodsFor: 'event handling' stamp: 'KK 7/12/2017 15:28'!mouseDown: evt	self presentMenu.! !!EventTitleMorph methodsFor: 'event handling' stamp: 'KK 8/22/2017 19:41'!presentMenu	"Pop up a menu of choices."	| eventNames sFrame menu choice s |	eventNames _ #().	(sFrame _ self ownerThatIsA: ScratchFrameMorph)		ifNotNil: [eventNames _ sFrame workPane allEventNames].	menu _ CustomMenu new.	eventNames do: [:n | menu add: n action: n asString].	menu addLine.	menu add: ('new' localized, ScratchTranslator ellipsesSuffix) action: #newEvent.	(choice _ menu startUp) ifNil: [^ self].	choice == #newEvent ifTrue: [		TabletMode ifTrue: [			sFrame sendMessageToBMnoBlocking: 'SHOWKEYPAD'].		ValueOrList _ false.		s _ StringDialog ask: 'Message name:'.		TabletMode ifTrue: [			sFrame sendMessageToBMnoBlocking: 'HIDEKEYPAD'].		s size = 0 ifTrue: [^ self].		^ self eventName: s].	self eventName: choice.! !!ExpressionArgMorph methodsFor: 'accessing' stamp: 'KK 9/18/2013 19:15'!defaultValue: anObject	anObject isNumber ifTrue: [self numExpression: anObject].	(anObject isKindOf: String) ifTrue: [self stringExpression: anObject].! !!ExpressionArgMorph methodsFor: 'accessing' stamp: 'KK 5/1/2014 17:10'!numExpression: aNumber	isNumber _ true.	labelMorph isNumeric: true.	aNumber isFloat		ifTrue: [labelMorph contents: aNumber printStringNoExponent]		ifFalse: [labelMorph contents: aNumber asString].	self fixArgLayout.! !!ExpressionArgMorphWithMenu methodsFor: 'accessing' stamp: 'sk 2/10/2017 16:53'!menuSelector: menuSelector	| scale |	"Add a drop-down menu button with the given selector. The selector should result in a menu whose action items are values that can be put into this type argument, typically numbers or strings."	scale _ ScratchTranslator renderScale rounded.	menuMorph _ ImageMorph new form: (DropDownMenuForm magnifyBy: scale).	getMenuSelector _ menuSelector.	self addMorphFront: menuMorph.	self fixArgLayout.! !!ExpressionArgMorphWithMenu methodsFor: 'event handling' stamp: 'KK 7/12/2017 15:12'!mouseDown: evt	| rcvr menu choice frame kw vPos |	menuMorph ifNil: [^ super mouseDown: evt].	(evt cursorPoint x < (menuMorph left - 1)) ifTrue: [^ super mouseDown: evt].	(getMenuSelector notNil and:	 [(owner isKindOf: BlockMorph) and: 	 [(rcvr _ owner receiver) notNil]]) ifFalse: [^ self beep].	menu _ rcvr perform: getMenuSelector.	(menu isKindOf: ScratchNoteSelector) ifTrue: [		"menu position: owner bottomLeft + (((owner width - menu width) // 2) @ -4)"		frame _ owner ownerThatIsA: ScratchFrameMorph.		kw _ (frame width * 0.04) truncated.		menu buildKeyboard: 2 baseOctave: 4 keyWidth: kw.		menu setUpNoteDisplay: (20 * kw // 13).		vPos _ owner bottom -4.		(vPos + (menu extent y)) > frame height ifTrue: [			vPos _ owner top + 4 - (menu extent y)].		menu position: ((frame width - menu width) // 2) @ vPos].	choice _ menu startUp.	choice ifNil: [^ self].	evt hand newKeyboardFocus: nil.  "close mini-editor, if any"	(#(listIndexMenu listIndexForDeleteMenu) includes: getMenuSelector) ifTrue: [		^ self specialValue: choice].	isNumber		ifTrue: [self numExpression: choice]		ifFalse: [self stringExpression: choice].! !!ExpressionArgMorphWithMenu methodsFor: 'private' stamp: 'sk 2/10/2017 16:36'!fixArgLayout	| dx |	dx _ 9 * (ScratchTranslator renderScale).	super fixArgLayout.	menuMorph ifNil: [^ self].	self width: self width + dx.	menuMorph position: (self right - dx - 2)@(self top + (self height // 3)).	(thisContext sender receiver isKindOf: StringFieldMorph) ifTrue: [		"clear only when user edit my label, but not on other arg layout changes"		specialValue _ nil].! !!HandMorph methodsFor: 'world menu commands' stamp: 'KK 11/21/2017 17:03'!openScratchFrame	| m |	m _ ScratchFrameMorph new.	m extent: Display extent - 50.	m position: 0@0.	m startup.	m newScratchProject.	m readAutosavedProgram."	m serverProcess: ([ m usbConnectionDetector. ] fork).""	m serverProcess terminate."	m openInWorld.! !!HatBlockMorph methodsFor: 'private' stamp: 'sk 3/16/2017 17:46'!fixBlockLayout	"Update the positions of my submorphs."	| x centerY nextB nonBlockSubmorphs oldExtent oldPos |	blockLayoutNeeded ifFalse: [^ self].	super fixBlockLayout.	oldExtent _ self extent.	oldPos _ self position.	ScratchTranslator isRTL		ifTrue: [x _ self right - 8]		ifFalse: [x _ self left + 8].	centerY _ self top + 3 + ((self height) // 2).	self nonControlFlowSubmorphs do: [:m |		(m isKindOf: ArgMorph) ifTrue: [m fixArgLayout].		ScratchTranslator isRTL			ifTrue: [m position: (x - m width)@(centerY - (m height // 2)). 				x _ x - m width - 5]			ifFalse: [m position: x@(centerY - (m height // 2)). 				x _ x + m width + 5]].	ScratchTranslator isRTL		ifTrue: [x _ x - 4.			self width: ((self right - x) max: self hatTopForm width)]		ifFalse: [x + x + 4.			self width: ((x - self left) max: self hatTopForm width)].	ScratchTranslator isRTL ifTrue: [		self left: oldPos x + (oldExtent x - self width)].	nonBlockSubmorphs _ self submorphs select: [:m |		(m isKindOf: BlockMorph) not or: [m isKindOf: ArgMorph]].	self height: self hatTopForm height + (nonBlockSubmorphs inject: CBlockBracketThickness into: [:h :m | h max: (m height + 8)]).	(nextB _ self nextBlock) ifNotNil: [		ScratchTranslator isRTL			ifTrue: [nextB right: self right]			ifFalse: [nextB left: self left].		nextB top: self bottom - 4.		nextB fixBlockLayout].! !!HatBlockMorph methodsFor: 'private' stamp: 'sk 5/20/2016 21:22'!printArduCodeOn: aStream indent: indent	"Append a human-readable string for this block on the given stream."	indent timesRepeat: [aStream nextPutAll: '    '].	self printArduHatNameOn: aStream.	self nextBlock ifNotNil: [self nextBlock printArduCodeOn: aStream indent: indent + 1].	indent timesRepeat: [aStream nextPutAll: '    '].		(BoardType = 1) ifTrue: [	((IOPort at:19) = 6) ifTrue: [		(indent + 1) timesRepeat: [aStream nextPutAll: '    '].		aStream nextPutAll: 'board.sleep();'; cr].].	aStream nextPutAll: '}'; cr.! !!EventHatMorph methodsFor: 'initialization' stamp: 'KK 7/11/2017 14:03'!forStartEvent	| parts s m |	super initialize.	self removeAllMorphs.	parts _ ScratchTranslator labelPartsFor: 'when %m clicked'.	s _ StringMorph new contents: parts first; font: (ScratchFrameMorph getFont: #Label); color: Color white.	self addMorphBack: s.	m _ ImageMorph new form: (ScratchFrameMorph skinAt: #goButton).	self addMorphBack: m.	s _ s fullCopy contents: parts second.	self addMorphBack: s.	"create scriptNameMorph but don't add it"	scriptNameMorph _ EventTitleMorph new eventName: 'Scratch-StartClicked'.	self fixBlockLayout.! !!EventHatMorph methodsFor: 'initialization' stamp: 'KK 7/12/2017 14:25'!initialize	| parts label |	super initialize.	self removeAllMorphs.	parts _ ScratchTranslator labelPartsFor: 'when I receive %e'.	parts first size > 0 ifTrue: [		label _ StringMorph contents: parts first font: (ScratchFrameMorph getFont: #Label).		label color: Color white.		self addMorphBack: label].	scriptNameMorph _ EventTitleMorph new.	self addMorphBack: scriptNameMorph.	parts second size > 0 ifTrue: [		label _ (StringMorph contents: parts second font: (ScratchFrameMorph getFont: #Label)) color: Color white.		self addMorphBack: label].! !!EventHatMorph methodsFor: 'other' stamp: 'KK 9/2/2013 10:23'!printArduHatNameOn: aStream	"Append a human-readable string for this hat block's name to the given stream."	| evtName |	evtName _ self eventName.	evtName = 'Scratch-StartClicked'		ifTrue: [			aStream nextPutAll: '// ---------------------------------------'; cr.			aStream nextPutAll: '// Artec robot mainroutine'; cr.			aStream nextPutAll: '// ---------------------------------------'; cr.			aStream nextPutAll: 'void artecRobotMain() {'		]		ifFalse: [			aStream nextPutAll: '// ---------------------------------------'; cr.			aStream nextPutAll: '// Artec robot subroutine'; cr.			aStream nextPutAll: '// ---------------------------------------'; cr.			aStream nextPutAll: 'void ARSR_', evtName, '() {'		].	aStream cr.! !!IfElseBlockMorph methodsFor: 'drawing' stamp: 'KK 2/27/2015 13:55'!drawOn: aCanvas 	| c |	topBarBottom _ self top + self topBarHeight.	blockBottom _ self bottom - 7.	self computeHighlightColors.	c _ FormCanvas extent: self extent depth: 32.	c _ c copyOffset: self topLeft negated.	self drawTopEdgeOn: c.	self drawTopBarOn: c.	self drawVerticalBarOn: c.	self drawElseBarOn: c.	self drawBottomBarOn: c.	self drawFinalOn: aCanvas fromCanvas: c.! !!IfElseBlockMorph methodsFor: 'private' stamp: 'KK 8/2/2013 15:08'!printArduCodeOn: aStream indent: indent	"Append a human-readable string for this block on the given stream."	indent timesRepeat: [aStream nextPutAll: '    '].	submorphs do: [:m |		(m ~~ trueBlock) & (m ~~ falseBlock) & (m ~~ nextBlock) ifTrue: [			self printArduCodeSubmorph: m on: aStream.			aStream space].].	aStream cr.	trueBlock ifNotNil: [trueBlock printArduCodeOn: aStream indent: indent + 1].	indent timesRepeat: [aStream nextPutAll: '    '].	aStream nextPutAll: '} else {'; cr.	falseBlock ifNotNil: [falseBlock printArduCodeOn: aStream indent: indent + 1].	indent timesRepeat: [aStream nextPutAll: '    '].	aStream nextPutAll: '}'; cr.	nextBlock ifNotNil: [nextBlock printArduCodeOn: aStream indent: indent].! !!KeyPadMorph methodsFor: 'stepping and presenter' stamp: 'sk 3/14/2017 11:30'!step

	| keyPadTarget expArg dispPosition frame |
	keyPadTarget _ World activeHand keyboardFocus.
	(keyPadTarget isKindOf: StringFieldMorph) ifTrue: [
		lastContents _ keyPadTarget contents.
		self target: keyPadTarget.
		expArg _ keyPadTarget ownerThatIsA: ExpressionArgMorph.
		frame _ expArg ownerThatIsA: ScratchFrameMorph.

		dispPosition _ expArg bottomLeft.
		((dispPosition y) + (self height)) > frame height ifTrue: [
			dispPosition _ (dispPosition x)@((dispPosition y) - (expArg height) - (self height))].
		self position: dispPosition.
		self comeToFront]
	ifFalse: [
		self delete].
! !!KeyPadMorph methodsFor: 'stepping and presenter' stamp: 'sk 2/7/2017 10:16'!stepTime

	^ 50! !!KeyPadMorph methodsFor: 'initialization' stamp: 'sk 3/15/2017 14:40'!initialize

	| col row bt size |
	super initialize.

	self color: Color transparent.
	col _ AlignmentMorph new.
	col orientation: #vertical.
	col color: BaseColor.
	col useRoundedCorners.

	buttons _ OrderedCollection new.
	size _ (ButtonSize + (10 * ScratchTranslator renderScale)) truncated.
	#(
		#(#('-' 45) #(0 48) #('.' 46))
		#(#(7 55) #(8 56) #(9 57))
		#(#(4 52) #(5 53) #(6 54))
		#(#(1 49) #(2 50) #(3 51))
		) do: [:num1 |
		row _ AlignmentMorph new.
		row color: BaseColor.
		num1 reverseDo: [:num2 |
			bt _ (SimpleButtonMorph new)
				label: ((num2 at: 1) asString) font: (StrikeFont fontName: #Verdana size: 20);
				extent: (size@size);
				color: ButtonColor;
				borderWidth: 1;
				borderColor: FontColor;
				target: self;
				actionSelector: #input:;
				arguments: {num2 at: 2};				actWhen: #buttonDown.
			(bt findA: StringMorph) color: FontColor.
			buttons add: bt.
			row addMorph: bt.
			row addMorph: (Morph new extent: (2@40); color: (Color transparent))].
		col addMorph: row].

	row _ AlignmentMorph new.
	row color: BaseColor.

	bt _ IconicButton new labelGraphic: ((ScratchFrameMorph skinAt: #bs) magnifyBy: 0.5) borderWidth: 0.
	bt target: self;
		actionSelector: #deleteChar;		actWhen: #buttonDown.
	buttons add: bt.

	row addMorph: bt.
	row addMorph: (Morph new extent: (20@30); color: (Color transparent)).

	bt _ SimpleButtonMorph new
		label: 'C' font: (StrikeFont fontName: #Verdana size: 20);
		extent: (70@30);
		color: ButtonColor;
		borderWidth: 1;
		borderColor: FontColor;
		target: self;
		actionSelector: #clearTarget;		actWhen: #buttonDown.
	(bt findA: StringMorph) color: FontColor.
	"buttons add: bt."
	row addMorph: bt.
	col addMorph: row.

	"col addMorph: sf."   "For debug"
	self addMorph: col.
	self extent: col extent.! !!KeyPadMorph methodsFor: 'accessing' stamp: 'sk 2/7/2017 09:30'!clearTarget

	targetField selectAll; removeSelection.
	World activeHand newKeyboardFocus: targetField.
! !!KeyPadMorph methodsFor: 'accessing' stamp: 'sk 2/7/2017 09:26'!deleteChar

	| curPosition |
	targetField backspace.
	curPosition _ targetField cursorPosition.
	World activeHand newKeyboardFocus: targetField.
	targetField moveCursorAt: curPosition.
! !!KeyPadMorph methodsFor: 'accessing' stamp: 'sk 4/24/2017 10:02'!input: aValue

	| curPosition |
	targetField contents: lastContents.	" To avoid the leading character to be '0' except a decimal. "
	((aValue = 46) not & lastContents = '0') ifTrue: [
		targetField selectAll].

	targetField insertCharacter: aValue.	lastContents _ targetField contents.
	curPosition _ targetField cursorPosition.
	World activeHand newKeyboardFocus: targetField.
	targetField moveCursorAt: curPosition.
! !!KeyPadMorph methodsFor: 'accessing' stamp: 'sk 3/14/2017 11:52'!setLocation	| keyPadTarget expArg dispPosition frame |	keyPadTarget _ World activeHand keyboardFocus.	(keyPadTarget isKindOf: StringFieldMorph) ifTrue: [		expArg _ keyPadTarget ownerThatIsA: ExpressionArgMorph.		frame _ expArg ownerThatIsA: ScratchFrameMorph.		dispPosition _ expArg bottomLeft.		((dispPosition y) + (self height)) > frame height ifTrue: [			dispPosition _ (dispPosition x)@((dispPosition y) - (expArg height) - (self height))].		self position: dispPosition.		self comeToFront].! !!KeyPadMorph methodsFor: 'accessing' stamp: 'sk 2/6/2017 20:38'!target: aStringField

	targetField _ aStringField.

"	buttons do: [:bt |
		bt target: aStringField]
"! !!KeyPadMorph class methodsFor: 'class initialization' stamp: 'sk 2/20/2017 16:27'!initialize
	"self initialize"

	BaseColor _ Color r: 0.753 g: 0.764 b: 0.776.
	ButtonColor _ Color r: 0.3 g: 0.3 b: 0.3.
	FontColor _ Color white.
	ButtonSize _ 40.
! !!LibraryItemMorph methodsFor: 'drawing' stamp: 'KK 7/31/2017 19:00'!updateNameAndInfo	| w y |	self		setProperty: #balloonText		toValue: ((target objName asUTF8, ' (' asUTF8, 'Scripts' localized, ScratchTranslator colonSuffix, ' ' asUTF8, target scripts size printString asUTF8,')' asUTF8) asUTF8).	nameMorph ifNotNil:[		(target isKindOf: ScriptableScratchMorph) ifFalse: [			nameMorph contents: '<no object>'.			scriptCountMorph contents: ''.			^ self].		nameMorph contents = target objName ifFalse: [			nameMorph contents: self truncatedLabel.			nameMorph left: self left + ((self width - nameMorph width) // 2) + 1]].	scriptCountMorph ifNotNil: [		w _ 0.		target scripts size > 0			ifTrue: [				w > 0 ifTrue: [w _ w + 2].				scriptCountMorph contents: 'Scripts' localized, ScratchTranslator colonSuffix, ' ', target scripts size printString.				w _ w + scriptCountMorph width + 2]			ifFalse: [				scriptCountMorph contents: ''].		"layout info morph row"		y _ nameMorph bottom.		w > 0 ifTrue: [			scriptCountMorph position: (self left + ((self width - (scriptCountMorph width)) // 2))@y]].! !!LibraryItemMorph methodsFor: 'event handling' stamp: 'KK 8/17/2017 20:16'!handlesMouseOverDragging: evt	| m |	evt hand submorphs size = 1 ifFalse: [^ false].	m _ evt hand firstSubmorph.	^ ((m isKindOf: BlockMorph) or: [(m isKindOf: MediaItemMorph) or: [m isKindOf: ScratchCommentMorph]])! !!LibraryItemMorph methodsFor: 'event handling' stamp: 'KK 7/18/2017 19:43'!mouseDown: evt	"Handle a mouse click. Left click either sets me as a target, deletes me, or copies me.  Shift left click makes me reappear in the middle of the screen.  Holding left button drags me. Right button brings up a menu."	| duplicate frame |	(evt hand toolType = 'CutTool') & (evt rightButtonPressed not) ifTrue: [		evt shiftPressed ifFalse: [evt hand toolType: nil].		(target notNil and:		 [((target isKindOf: ScratchStageMorph) | (target isKindOf: ArduinoScratchSpriteMorph)) not]) ifTrue: [			self target undoableDeleteSprite].		^ self].		(evt hand toolType = 'CopyTool') & (evt rightButtonPressed not) ifTrue: [		evt shiftPressed ifFalse: [evt hand toolType: nil].		(target notNil and:		 [((target isKindOf: ScratchStageMorph) | (target isKindOf: ArduinoScratchSpriteMorph)) not]) ifTrue: [			duplicate _ self target duplicate.			self world activeHand				attachMorph: duplicate;				formerOwner: self target owner position: self target owner center].		^ self].	target ifNotNil: [		evt shiftPressed ifTrue: [self select. ^ self target makeVisible].		evt rightButtonPressed			ifTrue: [				Sensor waitNoButton. 				(target isKindOf: ScratchStageMorph) 					ifFalse: [^ self rightButtonMenu]]			ifFalse:	[				self select.				frame _ self ownerThatIsA: ScratchFrameMorph.				"Set the viewerPane target to my target so I stay highlighted while I am being dragged. This is sort of a hack because my target is not actually being viewed until the mouseUp: command is called."				frame viewerPane target: self target.				evt hand waitForClicksOrDrag: self event: evt]].! !!LibraryItemMorph methodsFor: 'event handling' stamp: 'KK 9/8/2017 14:03'!mouseUp: evt	"View my target if it is not already beeing viewed."	| frame |	frame _ self ownerThatIsA: ScratchFrameMorph.	frame ifNil: [^ self].	self target ifNil: [^ self]. "deleted"	self select.	frame scriptsPane target = self target ifFalse: [		self target viewBlocksAndScripts].! !!LibraryItemMorph methodsFor: 'dropping/grabbing' stamp: 'KK 10/24/2017 10:00'!acceptDroppingMorph: aMorph event: evt	"Copy the dropped scripts of another object into its target."	(self target isMemberOf: ArduinoScratchSpriteMorph) ifTrue: [	] ifFalse: [		(aMorph receiver isMemberOf: ArduinoScratchSpriteMorph) ifTrue: [		] ifFalse: [			(aMorph isKindOf: MediaItemMorph) ifTrue: [				target addMediaItem: aMorph media copy.				evt hand rejectDropMorph: aMorph event: evt].			(aMorph isKindOf: BlockMorph) ifTrue: [				evt hand rejectDropMorph: aMorph event: evt.				target addStack: aMorph fullCopy].			(aMorph isKindOf: ScratchCommentMorph) ifTrue: [				evt hand rejectDropMorph: aMorph event: evt.				target addComment: aMorph fullCopy].		].	].! !!LibraryItemMorph methodsFor: 'dropping/grabbing' stamp: 'KK 8/17/2017 20:00'!justDroppedInto: aMorph event: evt	"When I am dropped into the viewer pane or the script editor, then delete the sprite associated with me."	self delete.true ifTrue: [^ self].	"delete me when dropped on the blocks palette or the script editor"	(((aMorph ownerThatIsA: ScratchViewerMorph) notNil) 		or: [(aMorph ownerThatIsA: ScratchScriptEditorMorph) notNil]) ifTrue: [		^ self target undoableDeleteSprite].	"blocks cannot be dropped onto the stage"	(owner isKindOf: ScratchStageMorph) ifTrue: [		^ self rejectDropEvent: evt].! !!LibraryItemMorph methodsFor: 'stepping' stamp: 'KK 7/31/2017 19:01'!step	"Optimization: Don't update unless the costume has changed."	| changeTime stage frame |	target ifNil: [		(frame _ (self ownerThatIsA: ScratchFrameMorph)) ifNotNil: [			(stage _ frame workPane) ifNotNil: [				stage updateSpritesList]].		^ self].	target world isNil ifTrue: [target _ nil. ^ self].	changeTime _ target costumeChangeMSecs.	changeTime = lastUpdateMSecs ifFalse: [		self updateThumbnail.		lastUpdateMSecs _ changeTime].	Sensor anyButtonPressed ifFalse: [self updateNameAndInfo].! !!LibraryItemMorph methodsFor: 'right button menu' stamp: 'KK 7/12/2017 17:32'!rightButtonMenu	"Present the right button menu."	| menu |	(target isKindOf: ArduinoScratchSpriteMorph) ifTrue: [ ^ nil ].	menu _ CustomMenu new.	menu add: 'show' action: #makeVisible.	menu add: 'export this sprite' action: #exportObject.	menu addLine.	menu add: 'duplicate' action: #duplicateNoAttach.	menu add: 'delete' action: #undoableDeleteSprite.	menu localize; invokeOn: self target.! !!LibraryItemMorph methodsFor: 'private' stamp: 'KK 1/21/2013 19:18'!truncatedLabel	"Answer the label string to used as the name morph."	| ellipses s w n |"	nameMorph contents = target objName ifFalse: [		n _ target objName.		ellipses _ ScratchTranslator ellipsesSuffix asUTF32.		1 to: n size do: [:i |			s _ n copyFrom: 1 to: i.			w _ nameMorph stringWidth: (s asUTF32, ellipses).			w > (self width - 3) ifTrue: [				^ (n copyFrom: 1 to: i - 1) asUTF32, ellipses]]]."	^ target objName! !!MediaItemMorph methodsFor: 'initialization' stamp: 'KK 10/26/2017 16:41'!buildRightSideMorph	"Answers the part of MediaItemMorph that includes the label, the edit/copy or record/play buttons, etc. This includes everything but the sprite image, the number, and the horizontal divider."	| e c bottom |	rightMorph _ Morph new.	rightMorph color: (Color transparent).	nameMorph _ UpdatingStringFieldMorph new		acceptWhenFocusLost: true;		font: (ScratchFrameMorph getFont: #UpdatingStringField);		rightJustify: ScratchTranslator isRTL;		getSelector: #mediaName;		putSelector: #mediaName:;		position: (0@0);		target: self.	nameMorph width: (5 * nameMorph height) asInteger.	rightMorph addMorphBack: nameMorph.	infoMorph _ (StringMorph contents: (media infoString))		font: (ScratchFrameMorph getFont: #MediaItemInfo);		position: nameMorph left + 2 @ (nameMorph bottom).	rightMorph addMorph: infoMorph.	media isSound		ifTrue: [			self addPlayButton.			playButton position: (nameMorph left)@(infoMorph bottom + 5).			self addStopButton.			stopButton position: playButton topRight + (5@0).			deleteButton _ self getDeleteButton.			rightMorph addMorph: deleteButton.			deleteButton left: stopButton right + 5.			bottom _ stopButton bottom.		] ifFalse: [			e _ self getEditButton.			rightMorph addMorph: e.			e position: nameMorph left@(infoMorph bottom + 5).			c _ self getCopyButton.			rightMorph addMorph: c.			c position: e topRight + (5@0).			deleteButton _ self getDeleteButton.			rightMorph addMorph: deleteButton.			deleteButton position: c right + 5.			bottom _ c bottom].	nameMorph extent: (deleteButton right max: nameMorph width)@(nameMorph extent y).	deleteButton position: (nameMorph right - deleteButton width)@(infoMorph bottom + 6).	soundSizeMorph _ (StringMorph contents: '')		font: (ScratchFrameMorph getFont: #MediaItemInfo);		position: nameMorph right @ nameMorph bottom.	rightMorph addMorph: soundSizeMorph.	soundSizeMorph		contents: media mediaSizeInKilobytes asString , ' KB';		position: ((nameMorph right - soundSizeMorph width) @ nameMorph bottom).	rightMorph extent: nameMorph width@bottom.! !!MediaItemMorph methodsFor: 'accessing' stamp: 'KK 10/26/2017 16:49'!mediaName	media ifNotNil: [^ UTF8 withAll: (media mediaName)]! !!MediaItemMorph methodsFor: 'accessing' stamp: 'jm 1/28/2009 10:46'!mediaName: name	| newName sFrame |	newName _ name.	newName _ self scratchObj unusedMediaNameFromBaseName: newName forMedia: self media.	media mediaName: newName.	nameMorph contents: newName.	(sFrame _ self ownerThatIsA: ScratchFrameMorph) ifNotNil: [		sFrame viewerPane refresh].! !!MotorCalibMorphNotUse methodsFor: 'initialization' stamp: 'KK 1/30/2018 14:22'!addDCReadoutLabeled: aString field:clmn	"Add a readout row with the given label. Answer the stringmorph that's the readout."	| row slider |	row _ AlignmentMorph newRow		color: clmn color;		inset: 2.	row addMorphBack: (Morph new color: clmn color; extent: 1@3). "spacer"	row addMorphBack: (StringMorph contents: aString capitalized font: (StrikeFont fontName: 'VerdanaBold' size: 10)).	slider _ DCSliderMorph2 new.	slider minVal: 0.5; maxVal: 1.0;		setValue: 1.0;		truncate: false;		extent: 128@10.	slider setPortName: aString.	Sliders add: slider.	row addMorphBack: (Morph new color: row color; extent: 10@3). "spacer"	row addMorphBack: slider.	clmn addMorphBack: row.! !!MotorCalibMorphNotUse methodsFor: 'initialization' stamp: 'KK 1/30/2018 13:17'!addReadoutLabeled: aString field:clmn	"Add a readout row with the given label. Answer the stringmorph that's the readout."	| row box readout |	row _ AlignmentMorph newRow		color: clmn color;		inset: 2.	row addMorphBack: (Morph new color: clmn color; extent: 1@3). "spacer"	row addMorphBack: (StringMorph contents: aString capitalized font: (StrikeFont fontName: 'VerdanaBold' size: 10)).	row addMorphBack: (AlignmentMorph new color: clmn color; extent: 10@1; hResizing: #spaceFill). "spacer"	box _ NumericUpDownMorph new		extent: 42@14;		color: (ScriptableScratchMorph blockColorFor: 'sensing').	box setDefault: 0 min: -15 max: 15 width: 30 isEdit: false.	Boxes add: box.	" Set the box "	row addMorphBack: box.	row addMorphBack: (StringMorph contents: ('deg.' localized) font: (StrikeFont fontName: 'VerdanaBold' size: 10)).	readout _ StringMorph contents: '0' font: (StrikeFont fontName: 'VerdanaBold' size: 10).	readout color: Color white.	clmn addMorphBack: row.	^ readout! !!MotorCalibMorphNotUse methodsFor: 'initialization' stamp: 'KK 1/30/2018 13:05'!addReadouts	| buttonRow spacer svCalibMorph svCalibArea title svTitleAndButton button dcCalibArea dcTitleAndButton dcCalibMorph buttonStart buttonStop   |	Boxes _ OrderedCollection new.	Sliders _ OrderedCollection new.	" Make all alignment column "	column _ AlignmentMorph newColumn		centering: #center;		hResizing: #spaceFill;		vResizing: #shrinkWrap;		color: (Color r: (193/255) g: (196/255) b: (199/255));		borderWidth: 2;		borderColor: (Color r: (148/255) g: (145/255) b: (145/255));		useRoundedCorners;		inset: 3.	" Make title morph and add column and update "	titleMorph _ StringMorph		contents: ''		font: (StrikeFont fontName: 'VerdanaBold' size: 14).	column addMorph: titleMorph.	self updateTitle.	column addMorphBack: (Morph new color: column color; extent: 5@3).  "spacer"	self removeAllMorphs.	" ----------------------------------------------------------------- "	" Make servomotors calibration's morpsh "	" ----------------------------------------------------------------- "	svCalibArea _ AlignmentMorph newColumn	" servormotor area "		centering: #left;		hResizing: #spaceFill;		vResizing: #shrinkWrap;		color: (Color r: (240/255) g: (128/255) b: (128/255));		borderColor: (Color r: (148/255) g: (145/255) b: (145/255));		useRoundedCorners;		inset: 3.	" --- Title And Button --- "	svTitleAndButton _ AlignmentMorph newRow		color: svCalibArea color.	title _ StringMorph		contents: ('Servomotor' localized)		font: (StrikeFont fontName: 'VerdanaBold' size: 12).	button _ self buttonLabel: 'Reset' localized action: #reset.	" --- Calibration --- "	svCalibMorph _ AlignmentMorph newRow		color: svCalibArea color.	self updateCalib: svCalibMorph.	" --- add to column --- "	column addMorphBack: svCalibArea.	svCalibArea addMorphBack: svTitleAndButton.	svCalibArea addMorphBack: svCalibMorph.	spacer _ (svCalibArea fullBounds corner)			 - (title fullBounds corner)			 - (button fullBounds corner).	spacer setX: ((spacer x)-10) setY:0.	svTitleAndButton addMorphBack: title.	svTitleAndButton addMorphBack: (Morph new extent:spacer).	svTitleAndButton addMorphBack: button.	" ----------------------------------------------------------------- "	" Make DC motors calibration's morpsh "	" ----------------------------------------------------------------- "	dcCalibArea _ AlignmentMorph newColumn	" servormotor area "		centering: #left;		hResizing: #spaceFill;		vResizing: #shrinkWrap;		color: (Color r: (143/255) g: (188/255) b: (139/255));		borderColor: (Color r: (143/255) g: (188/255) b: (139/255));		useRoundedCorners;		inset: 3.	" --- Title And Button --- "	dcTitleAndButton _ AlignmentMorph newRow		color: dcCalibArea color.	title _ StringMorph		contents: ('DC motor' localized) 		font: (StrikeFont fontName: 'VerdanaBold' size: 12).	buttonStart _ self buttonLabel: 'Rotate' localized action: #start.	buttonStop _ self buttonLabel: 'Stop' localized action: #stop.	" --- Calibration --- "	dcCalibMorph _ AlignmentMorph newColumn		color: dcCalibArea color.	self updateDCCalib: dcCalibMorph.	column addMorphBack: dcCalibArea.	dcCalibArea addMorphBack: dcTitleAndButton.	dcCalibArea addMorphBack: dcCalibMorph.	spacer _ (svCalibArea fullBounds corner)			 - (title fullBounds corner)			 - (buttonStart fullBounds corner)			 - (buttonStop fullBounds corner).	spacer setX: ((spacer x)-15) setY:0.	dcTitleAndButton addMorphBack: title.	dcTitleAndButton addMorphBack: (Morph new extent:spacer).	dcTitleAndButton addMorphBack: buttonStart.	dcTitleAndButton addMorphBack: (Morph new extent:5@0).	dcTitleAndButton addMorphBack: buttonStop."	self updateCalib: dcCalibMorph."	" Make button alignment morph and add column and update "	buttonRow _ AlignmentMorph newRow		color: Color transparent;		hResizing: #shrinkWrap;		vResizing: #shrinkWrap;		height: 32.	column addMorphBack: buttonRow.	spacer _ Morph new extent: 10@5; color: Color transparent.	buttonRow removeAllMorphs.	buttonRow addMorphBack: spacer fullCopy.	buttonRow addMorphBack: (self buttonLabel: 'OK' localized action: #yes).	buttonRow addMorphBack: spacer fullCopy.	buttonRow addMorphBack: (self buttonLabel: 'Cancel' localized action: #cancelled).	column position: self position - 2.	self addMorph: column.	self extent: column extent - 4.! !!MotorCalibMorphNotUse methodsFor: 'initialization' stamp: 'KK 1/30/2018 11:30'!initialize	super initialize.	self addReadouts.! !!MotorCalibMorphNotUse methodsFor: 'private' stamp: 'KK 1/30/2018 13:06'!buttonLabel: labelString action: actionSelector	"Answer a new button with the given label and selector. The button target will be me and it will use my button forms."	"(DialogBoxMorph new buttonLabel: 'Yes' action: #beep) openInWorld"	| onForm offForm button overForm |	onForm _ ScratchFrameMorph skinAt: #btnPressed.	offForm _ ScratchFrameMorph skinAt: #btn.	overForm _ ScratchFrameMorph skinAt: #btn.	button _ ResizableToggleButton2 new		offForm: offForm		onForm: onForm		overForm: overForm.	^ button		padding: 20@10;		label: labelString font: (ScratchFrameMorph getFont: #DialogBoxButton);		target: self;		actionSelector: actionSelector;		setLabelColor: (Color gray: 0.15)! !!MotorCalibMorphNotUse methodsFor: 'private' stamp: 'KK 1/30/2018 13:13'!updateCalib:  morph	"Update servomotor calibration."	|  readoutNames calbCol1 calbCol2 |	calbCol1 _ AlignmentMorph newColumn		centering: #center;		hResizing: #spaceFill;		vResizing: #shrinkWrap;		color: morph color;		borderColor:  morph color;		useRoundedCorners;		inset: 3.	readoutNames _ #(D2 D4 D7 D8).	readouts _ readoutNames collect: [:i |		(i size = 1)			ifTrue:[self addReadoutLabeled: i field: calbCol1]			ifFalse:[self addReadoutLabeled: i localized field: calbCol1]].	morph addMorph: calbCol1.	morph addMorphBack: (AlignmentMorph new color: morph color; extent: 10@1; hResizing: #spaceFill). "spacer"	calbCol2 _ AlignmentMorph newColumn		centering: #center;		hResizing: #spaceFill;		vResizing: #shrinkWrap;		color: morph color;		borderColor:  morph color;		useRoundedCorners;		inset: 3.	readoutNames _ #(D9 D10 D11 D12).	readouts _ readoutNames collect: [:i |		(i size = 1)			ifTrue:[self addReadoutLabeled: i field: calbCol2]			ifFalse:[self addReadoutLabeled: i localized field: calbCol2]].	morph addMorphBack: calbCol2.! !!MotorCalibMorphNotUse methodsFor: 'private' stamp: 'KK 1/30/2018 13:18'!updateDCCalib:  morph	"Update servomotor calibration."	|  calbCol1 |	calbCol1 _ AlignmentMorph newColumn		centering: #center;		hResizing: #spaceFill;		vResizing: #shrinkWrap;		color: morph color;		borderColor:  morph color;		useRoundedCorners;		inset: 3.	self addDCReadoutLabeled: ('M1' localized)  field:calbCol1.	self addDCReadoutLabeled: ('M2' localized)  field:calbCol1.	morph addMorph: calbCol1.! !!MotorCalibMorphNotUse methodsFor: 'private' stamp: 'KK 1/30/2018 13:05'!updateTitle	"Update my title to reflect the current protocol and port number."	| s  |	s _ 'Motor Calibration' localized.	s = titleMorph contents ifFalse: [titleMorph contents: s].! !!MotorCalibMorphNotUse methodsFor: 'event handling' stamp: 'KK 1/30/2018 14:49'!handlesMouseDown: evt	^ true! !!MotorCalibMorphNotUse methodsFor: 'dropping/grabbing' stamp: 'KK 1/30/2018 14:49'!justDroppedInto: newOwner event: evt	"Only allow embedding into the stage; otherwise, float (i.e. be a submorph of the world)."	"Board cannot be dropped onto the stage"	(owner isKindOf: ScratchStageMorph) ifTrue: [		super justDroppedInto: newOwner event: evt	]	ifFalse: [		evt hand rejectDropMorph: self event: evt.	].	! !!MotorCalibMorphNotUse methodsFor: 'accessing' stamp: 'KK 1/30/2018 13:36'!motorNo: n calibrationPower: p	| dh ival dm dl |	" Reflect calibration to real servomotor "	(self portIsOpen) ifFalse: [ ^ self. ].	" b[4] pin, b[1:0] action "	dh _ 16r09.	" Initialization "	(n = 'M1') ifTrue: [ dh _ 16r02. ].	(n = 'M2') ifTrue: [ dh _ 16r12. ].	ival _ p asNumber.	(ival >= 255)  ifTrue: [ ival _ 255. ].	(ival <= 127)	 ifTrue: [ ival _ 127.   ].	ival _ ival rounded.				"b0000 n100 + val "	dm _ (ival bitShift: -6) bitAnd: 16r03.	dl _ ival bitAnd: 16r3F.	self partsID: 9 high: dh middle: dm low: dl.! !!MultilineStringMorph methodsFor: 'accessing' stamp: 'KK 8/9/2017 16:35'!contents: aStringOrText	"Set my contents to the given String or Text. Break into lines, emove non-printing characters, and replace tabs with sequences of spaces."	lines _ Array with: (self replaceTabs: aStringOrText asUTF32).	self lineWrapFrom: 1.! !!NotificationMessage class methodsFor: 'printing' stamp: 'sk 8/23/2016 09:02'!show: msgID	"Displaying a notification message for a given number and returning the dialogbox."	| dialogBox title message |	title _ 'Undifined error number.'.	message _ 'Unknown error.'.	(msgID = 16r10) ifTrue: [		title _ 'Building and updating...'.		message _ 'Do not disconnect Studuino from the PC.'].	(msgID = 16r11) ifTrue: [		title _ 'Shifting to Test mode...'.		message _ 'Do not disconnect Studuino from the PC.'].	(msgID = 16r12) ifTrue: [		title _ 'Shifting to calibration mode...'.		message _ 'Do not disconnect Studuino from the PC.'].	(msgID = 16r20) ifTrue: [		title _ 'Are you ready to transfer your program?'.		message _ 'Push a reset button on a board.'].	(msgID = 16r21) ifTrue: [		title _ 'Are you ready to transfer your program?2'.		message _ 'Push a reset button on a board.'].	dialogBox _ DialogBoxMorph new.	dialogBox title: title.	dialogBox message: message.	dialogBox openInWorld.		" Display Dialogbox "	dialogBox centerOnScreen.	" Set center position "	dialogBox world doOneCycle.	^ dialogBox! !!NumericUpDownMorph methodsFor: 'accessing' stamp: 'sk 3/17/2017 19:05'!addUpDownButton	| scale |	buttons _ AlignmentMorph new		hResizing: #shrinkWrap;		vResizing: #shrinkWrap;		inset: 0;		color: (Color transparent).	scale _ ScratchTranslator renderScale rounded.	upMorph _ IconicButton new labelGraphic: (UpForm magnifyBy: scale).	upMorph color: (Color transparent);		borderWidth: 0;		target: self;		height: (self height);		actWhen: #whilePressed;		actionSelector: #incValue.	buttons addMorphBack: upMorph.	downMorph _ IconicButton new labelGraphic: (DownForm magnifyBy: scale).	downMorph color: (Color transparent);		target: self;		borderWidth: 0;		height: (self height);		actWhen: #whilePressed;		actionSelector: #decValue.	buttons addMorphBack: downMorph.	self addMorphFront: buttons.	self fixArgLayout! !!NumericUpDownMorph methodsFor: 'accessing' stamp: 'KK 2/5/2018 09:59'!color: c	color _ c.! !!NumericUpDownMorph methodsFor: 'accessing' stamp: 'KK 1/31/2018 10:37'!getValue	^ labelMorph contents asNumber.! !!NumericUpDownMorph methodsFor: 'accessing' stamp: 'KK 2/5/2018 11:31'!setValid: v	" set this Instance true:valid / false:invalid "	valid _ v.	v ifFalse: [		labelMorph textColor: (Color gray: 0.7).		upMorph actionSelector: #noReaction.		downMorph actionSelector: #noReaction.	] ifTrue: [		labelMorph textColor: (Color black).		upMorph actionSelector: #incValue.		downMorph actionSelector: #decValue.	].! !!NumericUpDownMorph methodsFor: 'other' stamp: 'sk 12/22/2016 12:42'!enterKeyPressed	| val tmp |	"Respond to the enter key being pressed in one of my input fields."	tmp _ World activeHand keyboardFocus.	World activeHand newKeyboardFocus: nil.	val _ labelMorph contents asNumber.	(val > maximum) ifTrue: [ val _ maximum ].	(val < minimum) ifTrue: [ val _ minimum ].	self numExpression: val.	self notifyOwner: val.	World activeHand newKeyboardFocus: tmp.! !!NumericUpDownMorph methodsFor: 'other' stamp: 'KK 1/31/2018 14:35'!notifyOwner: d	" I notify message to the owner "	" The owner is servomotor calibration board. "	| block frame sb pin ival offset portArg n b |	(block _ self ownerThatIsA: CommandBlockMorph).	block ifNotNil: [	" Owner is CommandBlockMorph "		(block selector = #motorNo:degree:) ifTrue: [	" Owner is servomotor block "			portArg _ block findA: ChoiceArgMorph.			n _ portArg choice.			" Check argument. "			n = '' ifTrue: [^self].			" Port is not open, return. "			frame _ self ownerThatIsA: ScratchFrameMorph.			sb  _ frame workPane studuinoBoard.			(sb portIsOpen) ifFalse: [ ^ self. ].			offset _ 0.			(n = 'D2') ifTrue: [	" D2 "				pin _ 16r0000.			"b0000 0000 0000 0000"				offset _ SvCalib at:(5).	" Servomotor offset"			].			(n = 'D4') ifTrue: [	" D4 "				pin _ 16r0200.			"b0000 0010 0000 0000"				offset _ SvCalib at:(6).	" Servomotor offset"			].			(n = 'D7') ifTrue: [	" D7 "				pin _ 16r0400.			"b0000 0100 0000 0000"				offset _ SvCalib at:(7).	" Servomotor offset"			].			(n = 'D8') ifTrue: [	" D8 "				pin _ 16r0600.			"b0000 0110 0000 0000"				offset _ SvCalib at:(8).	" Servomotor offset"			].			(n = 'D9') ifTrue: [	" D9 "				pin _ 16r0800.			"b0000 1000 0000 0000"				offset _ SvCalib at:(1).	" Servomotor offset"			].			(n = 'D10') ifTrue: [	" D10 "				pin _ 16r0A00.			"b0000 1010 0000 0000"				offset _ SvCalib at:(2).	" Servomotor offset"			].			(n = 'D11') ifTrue: [	" D11 "				pin _ 16r0C00.			"b0000 1100 0000 0000"				offset _ SvCalib at:(3).	" Servomotor offset"			].			(n = 'D12') ifTrue: [" D12 "				pin _ 16r0E00.			"b0000 1110 0000 0000"				offset _ SvCalib at:(4).	" Servomotor offset"			].			ival _ d asNumber.			ival _ ival + offset.	" Calibration "			(ival >= 180)  ifTrue: [ ival _ 180. ].			(ival <= 0)	 ifTrue: [ ival _ 0.   ].			ival _ pin + ival rounded.			"Transcript show:'ScriptableScratchMorph:: motorNo:degree:'; show: ival;cr."			sb data:ival msgID:1.		].	].	(b _ self ownerThatIsA: MotorCalibMorph2).	b ifNotNil: [	" Owner is Motor Calibration Board "		b reflectCalibration: self degree: d.	].! !!NumericUpDownMorph methodsFor: 'object i/o' stamp: 'KK 3/31/2014 13:20'!fieldsVersion	^ 2! !!NumericUpDownMorph methodsFor: 'private' stamp: 'sk 2/14/2017 18:57'!decValue	| val |	val _ self evaluate.	val _ val - 1.	self setNum: val.	! !!NumericUpDownMorph methodsFor: 'private' stamp: 'sk 3/17/2017 19:05'!fixArgLayout	| dx |	dx _ 9 * (ScratchTranslator renderScale).	super fixArgLayout.	upMorph ifNil: [^ self].	downMorph ifNil: [ ^ self].	dx _ upMorph width.	self width: self width + (dx * 2) + 5.	buttons position: (self right - (dx * 2) - 2)@(self top)."	upMorph position: (self right - dx - 2)@(self top + (self height // 3)).	downMorph position: (self right - (dx * 2) - 2)@(self top + (self height // 3))."! !!NumericUpDownMorph methodsFor: 'private' stamp: 'sk 2/14/2017 18:57'!incValue	| val |	val _ self evaluate.	val _ val + 1.	self setNum: val.! !!NumericUpDownMorph methodsFor: 'private' stamp: 'KK 2/5/2018 11:27'!noReaction! !!NumericUpDownMorph methodsFor: 'private' stamp: 'sk 2/16/2017 13:55'!setNum: aValue	| val |	aValue isNumber ifFalse: [^ self].	val _ aValue within: minimum and: maximum.	self numExpression: val.	self notifyOwner: val.! !!NumericUpDownMorph methodsFor: 'initialization' stamp: 'KK 1/31/2018 10:36'!setDefault: defVal	" Set initial value, minimum value, maximum value, and up/down button. "	self numExpression: defVal.! !!NumericUpDownMorph methodsFor: 'initialization' stamp: 'sk 12/22/2016 11:40'!setDefault: defVal min: minVal max: maxVal width:w isEdit: e	" Set initial value, minimum value, maximum value, and up/down button. "	minimum _ minVal.	maximum _ maxVal.	self numExpression: defVal.	labelMorph width: (w* (ScratchTranslator renderScale)).	labelMorph doResizing: false.	labelMorph rightJustify: true.	labelMorph isEditable: e.	self addUpDownButton.! !!NumericUpDownMorph class methodsFor: 'class initialization' stamp: 'KK 3/31/2014 13:53'!initialize	"self initialize"	DownForm _ Form		extent: 7@4		depth: 1		fromArray: #(4261412864 2080374784 939524096 268435456)		offset: 0@0.	DownForm _ DownForm colorReduced.  "become a ColorForm"	DownForm colors:		(Array with: Color transparent with: (Color gray: 0.25)).	UpForm _ Form		extent: 7@4		depth: 1		fromArray: #(268435456 939524096 2080374784 4261412864)		offset: 0@0.	UpForm _ UpForm colorReduced.  "become a ColorForm"	UpForm colors:		(Array with: Color transparent with: (Color gray: 0.25)).! !!ObjStream methodsFor: 'entry points' stamp: 'KK 7/20/2017 10:49'!readObjFrom: aStream showProgress: showProgress	"Read the root object from the given binary stream. If showProgress is true, display a progress bar."	| objCount tenPercent |	objects _ OrderedCollection new.	stream _ aStream.	self readFileHeader.	firstPass _ true.	objCount _ stream uint32.	showProgress		ifTrue: [			tenPercent _ objCount // 10.			('Reading' localized, ScratchTranslator ellipsesSuffix)				displayProgressAt: Sensor cursorPoint				from: 0 to: objCount + tenPercent				during: [:progressBar |					1 to: objCount do: [:i |						objects addLast: self readObjectRecord.						progressBar value: i].					firstPass _ false.					objects do: [:rec | self fixReferencesForObjectRecord: rec].					progressBar value: objCount + (tenPercent // 2).					objects do: [:rec | self initializeUserDefinedFields: rec].					progressBar value: objCount + tenPercent.					Delay waitMSecs: 200]]		ifFalse: [			objCount timesRepeat: [objects addLast: self readObjectRecord].			firstPass _ false.			objects do: [:rec | self fixReferencesForObjectRecord: rec].			objects do: [:rec | self initializeUserDefinedFields: rec]].	^ objects first first! !!ObjStream methodsFor: 'private-reading' stamp: 'KK 7/20/2017 10:53'!readFileHeader	"Read the file header on my stream."	(((stream next: 4) asString = 'ObjS') &	 (stream next = 1) &	 ((stream next: 4) asString = 'Stch') &	 (stream next = 1)) ifFalse: [		self error: 'bad header'].! !!ObjStream class methodsFor: 'class initialization' stamp: 'KK 7/11/2017 15:06'!userClasses	"Answer an array of (<class id>, <class name>) records for all version numbered user classes."	"The following finds obsolete user classes:"	"self initialize. self userClasses reject: [:rec | Smalltalk includesKey: rec second]"	^ #(		"id		class"		(100		Morph)		(101		BorderedMorph)		(102		RectangleMorph)		(103		EllipseMorph)		(104		AlignmentMorph)		(105		StringMorph)		(106		UpdatingStringMorph)		(107		SimpleSliderMorph)		(108		SimpleButtonMorph)		(109		SampledSound)		(110		ImageMorph)		(111		SketchMorph)		"(120	SpriteMorph)"		"(121		SoundMorph)"		"(122	ImageBoxMorph)"		(123		SensorBoardMorph)		(124		ScratchSpriteMorph)		(125		ScratchStageMorph)		(126		ArduinoScratchStageMorph)		(127		ArduinoScratchSpriteMorph)		(140		ChoiceArgMorph)		(141		ColorArgMorph)		(142		ExpressionArgMorph)		"(143	ParameterReferenceMorph)"		"(144	PositionArgMorph)"		(145		SpriteArgMorph)		"(146	VariableArgMorph)"		(147		BlockMorph)		(148		CommandBlockMorph)		(149		CBlockMorph)		"(150	MethodCallBlockMorph)"		(151		HatBlockMorph)		"(152	ScratchButtonMorph)"		(153		ScratchScriptsMorph)		(154		ScratchSliderMorph)		(155		WatcherMorph)		"(156	ParameterMorph)"		(157		SetterBlockMorph)		(158		EventHatMorph)		"(159	EventArgMorph)"		(160		VariableBlockMorph)		"(161		IACTHatBlock)"		(162		ImageMedia)		(163		MovieMedia)		(164		SoundMedia)		(165		KeyEventHatMorph)		(166		BooleanArgMorph)		(167		EventTitleMorph)		(168		MouseClickEventHatMorph)		(169		ExpressionArgMorphWithMenu)		(170		ReporterBlockMorph)		(171		MultilineStringMorph)		(172		ToggleButton)		(173		WatcherReadoutFrameMorph)		(174		WatcherSliderMorph)		(175		ScratchListMorph)		(176		ScrollingStringMorph)	)! !!PasteUpMorph methodsFor: 'dropping/grabbing' stamp: 'KK 9/23/2013 17:35'!acceptDroppingMorph: aMorph event: evt	aMorph submorphsDo: [:m | (m isKindOf: HaloMorph) ifTrue: [m delete]].	self addMorphFront: aMorph."Transcript show:'[PasteUpMorph::acceptDroppingMorph: event:]';show: aMorph;show: ', ';show: evt;cr."	self isPartsBin		ifTrue: [			aMorph isPartsDonor: true.			aMorph allMorphsDo: [:m | m stopStepping]]		ifFalse: [			self world startSteppingSubmorphsOf: aMorph].! !!PasteUpMorph methodsFor: 'world state' stamp: 'KK 8/3/2017 20:52'!fullRepaintNeeded	self damageRecorder doFullRepaint.	self submorphsDo: [:m |		(m isKindOf: SystemWindow) ifTrue: [m makeMeVisible]].! !!PathSettingArgMorph methodsFor: 'event handling' stamp: 'KK 8/24/2017 14:14'!handlesMouseDown: evt	^ true.! !!PathSettingArgMorph methodsFor: 'event handling' stamp: 'KK 9/6/2017 17:38'!mouseDown: evt	| fName result block |	" Make file name from list name. "	block _ self owner.	block submorphs do: [ :morph |		(morph isMemberOf: ChoiceArgMorph) ifTrue: [ fName _ morph choice.]	].	fName size <= 1 ifTrue: [fName _ 'newList'].	fName _ fName, '.txt'.	" Open dialog which export list data. "	fName _ ScratchFileChooserDialog		chooseNewFileDefault: fName		title: 'File Name?'		type: #list.	fName = #cancelled ifTrue: [^ self].	" Set menu. "	result _ #().	result _ UTF8 withAll: fName.	" Select Path"	self choice: result.! !!PathSettingArgMorph class methodsFor: 'class initialization' stamp: 'KK 9/12/2017 09:46'!getDefaultPath	| path |	"Set default path"	path _ DefaultPath.	path ifNil: [		path _ ScratchPlugin primGetFolderPath: 3.	].	^ path.! !!PathSettingArgMorph class methodsFor: 'class initialization' stamp: 'KK 9/11/2017 16:18'!initDefaultPath	"Set default path"	DefaultPath _ nil.! !!PathSettingArgMorph class methodsFor: 'class initialization' stamp: 'KK 9/22/2017 17:29'!setDefaultPath: path	| documentsPath stream end userProfilePath userPath token preLength |	"Set default path"	" Case short C:\ length. "	(path size < 4) ifTrue: [ ^ nil. ].	DefaultPath _ path.	" Check whether end of path is \. "	(DefaultPath at: (DefaultPath size)) asCharacter = $\ ifTrue: [		stream _ ReadStream on: DefaultPath.		end _ stream size.		DefaultPath _ (stream next: end - 1).	].	" Special folder description "	(DefaultPath first) asCharacter = $% ifTrue: [		" Check %USERPROFILE% "		stream _ ReadStream on: DefaultPath.		preLength _ '%USERPROFILE%' size.		" check a spelling mistake "		token _ stream next: preLength.		token = '%USERPROFILE%' ifFalse: [			DefaultPath _ nil.		] ifTrue: [			" Convert %USERPROFILE% to real path "			documentsPath _ FileDirectory on: (ScratchPlugin primGetFolderPath: 3).			userProfilePath _ documentsPath parentDirectory.			" Delete %USERPROFILE% "			end _ stream size.			stream position: preLength.			userPath _ stream next: (end - preLength).			" Create user default path "			DefaultPath _ userProfilePath pathName.			DefaultPath _ DefaultPath, userPath.			DefaultPath _ UTF8 withAll: DefaultPath.		].	].! !!PinAssignMorph methodsFor: 'accessing' stamp: 'KK 3/26/2015 17:12'!canBeSelected: aSymbol 	| set combo index |	index := 1.	(aSymbol = AccelerometerName) |	(aSymbol = GyroSensorName) |	(aSymbol = ColorSensorName) ifTrue: [		pinInfo do: [:each |			((index = SA4Index) | (index = SA5Index)) ifFalse: [				combo := each findA: ChoiceArgMorphForStuduino.					combo ifNotNil: [					(combo choice = InfraredReceiverName) ifTrue: [						ScratchFrameMorph displayMessageDialog:'30'.						^ false.					].				].				index := index + 1.			]		].	].	(aSymbol = InfraredReceiverName) ifTrue: [		set := pinInfo at:SA4Index.		combo := set findA: ChoiceArgMorphForStuduino.			(combo choice = AccelerometerName) |		(combo choice = GyroSensorName) |		(combo choice = ColorSensorName)  ifTrue: [			ScratchFrameMorph displayMessageDialog:'30'.			^ false.		]	].	^ true.! !!PinAssignMorph methodsFor: 'accessing' stamp: 'sk 7/6/2017 19:58'!changeSelectorStatus: s	| button selector |	button := s findA: ToggleButton.	" Toggle button "	selector := s findA: ChoiceArgMorphForStuduino.	" Combo morph "	(button isOn) ifTrue: [		"Action side pin Toggle button OFF "		selector ifNotNil: [selector color: (Color r: (240/255) g: (240/255) b: (240/255))].		selector valiable: true.	]	ifFalse: [		" Action side pin Toggle button ON "		selector ifNotNil: [selector color: Color gray].		selector valiable: false.	].! !!PinAssignMorph methodsFor: 'accessing' stamp: 'sk 7/6/2017 19:59'!exclusiveControlDC: dc servo1: sv1 servo2: sv2	| dcCB sv1CB sv2CB sv1Title sv2Title |	"comment stating purpose of message"	dcCB := dc findA: ToggleButton.	" DC motor Toggle button "	sv1CB := sv1 findA: ToggleButton.	" Servomotor1 Toggle button "	sv2CB := sv2 findA: ToggleButton.	" Servomotor2 Toggle button "	sv1Title := sv1 findA: StringMorph.			" Servomotor1 String morph "	sv2Title := sv2 findA: StringMorph.			" Servomotor2 String morph "	(dcCB isOn) ifTrue: [		" DC motor Toggle button ON "		sv1CB isDisabled: true.	" Servomotor1 Disable "		sv1Title color: (Color gray).		sv2CB isDisabled: true.	" Servomotor2 Disable "		sv2Title color: (Color gray).	]	ifFalse: [		" DC motor Toggle button OFF "		sv1CB isDisabled: false.	" Servomotor1 Enable "		sv1Title color: (Color black).		sv2CB isDisabled: false.	" Servomotor2 Enable "		sv2Title color: (Color black).	].! !!PinAssignMorph methodsFor: 'accessing' stamp: 'sk 7/6/2017 19:59'!exclusiveControlServo: sv1 servo2: sv2 dcMotor: dc	| sv1CB sv2CB dcCB dcTitle |	sv1CB := sv1 findA: ToggleButton.	" Servo1 Toggle button "	sv2CB := sv2 findA: ToggleButton.	" Servo2 Toggle button "	dcCB := dc findA: ToggleButton.	" DC motor Toggle button "	dcTitle := dc findA: StringMorph.				" DC motor String morph "	((sv1CB isOn) | (sv2CB isOn)) ifTrue: [		" Servo1 or Servo2 Toggle button ON "		dcCB isDisabled: true.		" DC motor Disable "		dcTitle color: (Color gray).	]	ifFalse: [		" Servo1 and Servo2 Toggle button OFF "		dcCB isDisabled: false.		" DC motor Enable "		dcTitle color: (Color black).	].! !!PinAssignMorph methodsFor: 'accessing' stamp: 'sk 7/6/2017 19:59'!exclusiveSensor: s1 sensor: s2	| s1CB s2CB s2Title |	s1CB := s1 findA: ToggleButton.		" Action side pin Toggle button "	s2CB := s2 findA: ToggleButton.	" Reaction side pin Toggle button "	s2Title := s2 findA: StringMorph.				" Reaction side pin String morph "	(s1CB isOn) ifTrue: [		" Action side pin Toggle button ON "		s2CB isDisabled: true.	" Reaction side pin Disable "		s2Title color: (Color gray).	]	ifFalse: [		"Action side pin Toggle button OFF "		s2CB isDisabled: false.	" Reaction side pin Enable "		s2Title color: (Color black).	].! !!PinAssignMorph methodsFor: 'accessing' stamp: 'KK 3/24/2015 11:51'!insertOption: aSet item: aString	" Insert the item to parts list when the item is not selected "	| sensors others combo newOption pinName |	" Get sensor's collection "	sensors := pinInfo select: [:each| 		((each findA: ChoiceArgMorph) = nil) not].	" Get other's sensors "	others := sensors select: [:each |(each = aSet) not].	others do: [:each |		combo := each findA: ChoiceArgMorph.		pinName := each findA: StringMorph.		newOption := OrderedCollection new.		(combo options ) do: [:option|			(option = TemperatureSensorName) ifTrue: [				(aString = InfraredReceiverName) ifTrue: [					" IR receive sensor can't not connet A6/A7. "					(pinName contents = 'A6') | (pinName contents  = 'A7') ifFalse: [						newOption add:aString.					].				].				newOption add:option.				(aString = BluetoothName) ifTrue: [					newOption add:aString.				].			] ifFalse: [				newOption add:option.			].		].		combo options: newOption.	].! !!PinAssignMorph methodsFor: 'accessing' stamp: 'KK 4/7/2014 13:09'!isScriptable	"I am not scriptable."	^ false! !!PinAssignMorph methodsFor: 'accessing' stamp: 'KK 3/9/2015 10:58'!notifyAccelerometerSelect: aSet 	| set combo |	" ---------------------------------- "	"	A4 Pin (Sensor side)	"	" ---------------------------------- "	(aSet == (pinInfo at:SA4Index)) ifTrue: [		set := pinInfo at:SA5Index.		combo := set findA: ChoiceArgMorphForStuduino.	" A5 pin Toggle button "		combo choiceAccelerameter.	].	" ---------------------------------- "	"	A5 Pin (Sensor side)	"	" ---------------------------------- "	(aSet == (pinInfo at:SA5Index)) ifTrue: [		set := pinInfo at:SA4Index.		combo := set findA: ChoiceArgMorphForStuduino.	" A4 pin Toggle button "		combo choiceAccelerameter.	].! !!PinAssignMorph methodsFor: 'accessing' stamp: 'KK 3/24/2015 11:52'!notifyBluetoothSelect: aSet selectedBT := true.self removeOption:aSet item:BluetoothName.! !!PinAssignMorph methodsFor: 'accessing' stamp: 'sk 7/19/2017 10:00'!notifyCheckChange: aSet 	self notifyCheckChangeBaseSet: aSet."	(frameMorph workPane showOptionBlocks) ifTrue: [		self notifyCheckChangeWithOption: aSet.	] ifFalse: [		self notifyCheckChangeBaseSet: aSet.	]"! !!PinAssignMorph methodsFor: 'accessing' stamp: 'sk 7/19/2017 10:01'!notifyCheckChangeBaseSet: aSet 	| dc sv1 sv2 ab as a4 a5 a4CB a5CB a4CmbB a5CmbB cmb |	" ---------------------------------- "	"	M1 Pin	"	" ---------------------------------- "	(aSet == (dc := pinInfo at:1)) ifTrue: [		sv1 := pinInfo at:3.		" D2 pin "		sv2 := pinInfo at:4.		" D4 pin "		self exclusiveControlDC:dc servo1:sv1 servo2:sv2.	].		" ---------------------------------- "	"	M2 Pin	"	" ---------------------------------- "	(aSet == (dc := pinInfo at:2)) ifTrue: [		sv1 := pinInfo at:5.		" D7 pin "		sv2 := pinInfo at:6.		" D8 pin "		self exclusiveControlDC:dc servo1:sv1 servo2:sv2.	].	" ---------------------------------- "	"	D2 or D4 Pin	"	" ---------------------------------- "	((aSet == (sv1 := pinInfo at:3)) | (aSet == (sv2 := pinInfo at:4))) ifTrue: [		dc := pinInfo at:1.		" M1 pin "		self exclusiveControlServo: sv1 servo2: sv2 dcMotor: dc	].	" ---------------------------------- "	"	D7 or D8 Pin	"	" ---------------------------------- "	((aSet == (sv1 := pinInfo at:5)) | (aSet == (sv2 := pinInfo at:6))) ifTrue: [		dc := pinInfo at:2.		" M2 pin "		self exclusiveControlServo: sv1 servo2: sv2 dcMotor: dc	].	" ---------------------------------- "	"	A0 Pin (Button side)	"	" ---------------------------------- "	(aSet == (ab := pinInfo at:11)) ifTrue: [		as := pinInfo at:15.		" A0(Sensor) pin "		self exclusiveSensor: ab sensor: as.	].	" ---------------------------------- "	"	A1 Pin (Button side)	"	" ---------------------------------- "	(aSet == (ab := pinInfo at:12)) ifTrue: [		as := pinInfo at:16.		" A1(Sensor) pin "		self exclusiveSensor: ab sensor: as.	].	" ---------------------------------- "	"	A2 Pin (Button side)	"	" ---------------------------------- "	(aSet == (ab := pinInfo at:13)) ifTrue: [		as := pinInfo at:17.		" A2(Sensor) pin "		self exclusiveSensor: ab sensor: as.	].	" ---------------------------------- "	"	A3 Pin (Button side)	"	" ---------------------------------- "	(aSet == (ab := pinInfo at:14)) ifTrue: [		as := pinInfo at:18.		" A3(Sensor) pin "		self exclusiveSensor: ab sensor: as.	].	" ---------------------------------- "	"	A0 Pin (Sensor side)	"	" ---------------------------------- "	(aSet == (as := pinInfo at:15)) ifTrue: [		ab := pinInfo at:11.		" A0(Button) pin "		self exclusiveSensor: as sensor: ab.		self changeSelectorStatus: as.		" add menu "		cmb := as findA: ChoiceArgMorph.		cmb options: self sensorPartsName0123.	].	" ---------------------------------- "	"	A1 Pin (Sensor side)	"	" ---------------------------------- "	(aSet == (as := pinInfo at:16)) ifTrue: [		ab := pinInfo at:12.		" A1(Button) pin "		self exclusiveSensor: as sensor: ab.		self changeSelectorStatus: as.		" add menu "		cmb := as findA: ChoiceArgMorph.		cmb options: self sensorPartsName0123.	].	" ---------------------------------- "	"	A2 Pin (Sensor side)	"	" ---------------------------------- "	(aSet == (as := pinInfo at:17)) ifTrue: [		ab := pinInfo at:13.		" A2(Button) pin "		self exclusiveSensor: as sensor: ab.		self changeSelectorStatus: as.		" add menu "		cmb := as findA: ChoiceArgMorph.		cmb options: self sensorPartsName0123.	].	" ---------------------------------- "	"	A3 Pin (Sensor side)	"	" ---------------------------------- "	(aSet == (as := pinInfo at:18)) ifTrue: [		ab := pinInfo at:14.		" A3(Button) pin "		self exclusiveSensor: as sensor: ab.		self changeSelectorStatus: as.		" add menu "		cmb := as findA: ChoiceArgMorph.		cmb options: self sensorPartsName0123.	].	" ---------------------------------- "	"	A4 or A5 Pin (Sensor)	"	" ---------------------------------- "	((aSet == (a4 := pinInfo at:19)) | (aSet == (a5 := pinInfo at:20))) ifTrue: [		a4CB := a4 findA: ToggleButton.	" A4 pin Toggle button "		a5CB := a5 findA: ToggleButton.	" A5 pin Toggle button "		a4CmbB := a4 findA: ChoiceArgMorph.		" A4 pin argment "		a5CmbB := a5 findA: ChoiceArgMorph.		" A5 pin argment "		((a4CB isOn) & (a5CB isOn)) ifTrue: [			" Added accelerometer menu "			a4CmbB options: self sensorPartsName45.			a5CmbB options: self sensorPartsName45.		]		ifFalse: [			" normal menu "			a4CmbB options: self sensorPartsName0123.			a5CmbB options: self sensorPartsName0123.		].		(aSet == (a4)) ifTrue: [ self changeSelectorStatus: a4. ].		(aSet == (a5)) ifTrue: [ self changeSelectorStatus: a5. ].	].	" ---------------------------------- "	"	A6 Pin (Sensor side)	"	" ---------------------------------- "	(aSet == (as := pinInfo at:21)) ifTrue: [		self changeSelectorStatus: as.		" add menu "		cmb := as findA: ChoiceArgMorph.		cmb options: self sensorPartsName67.	].	" ---------------------------------- "	"	A7 Pin (Sensor side)	"	" ---------------------------------- "	(aSet == (as := pinInfo at:22)) ifTrue: [		self changeSelectorStatus: as.		cmb := as findA: ChoiceArgMorph.		cmb options: self sensorPartsName67.	].! !!PinAssignMorph methodsFor: 'accessing' stamp: 'sk 7/6/2017 19:59'!notifyCheckChangeWithOption: aSet 	" aSet is the owner that has check box changed "	| dc sv1 sv2 ab as a4 a5 a4CB a5CB a4CmbB a5CmbB a0 a1 a0CB a1CB a0CmbB a1CmbB asCmbB setComb |	" ---------------------------------- "	"	M1 Pin	"	" ---------------------------------- "	(aSet == (dc := pinInfo at:1)) ifTrue: [		sv1 := pinInfo at:3.		" D2 pin "		sv2 := pinInfo at:4.		" D4 pin "		self exclusiveControlDC:dc servo1:sv1 servo2:sv2.	].		" ---------------------------------- "	"	M2 Pin	"	" ---------------------------------- "	(aSet == (dc := pinInfo at:2)) ifTrue: [		sv1 := pinInfo at:5.		" D7 pin "		sv2 := pinInfo at:6.		" D8 pin "		self exclusiveControlDC:dc servo1:sv1 servo2:sv2.	].	" ---------------------------------- "	"	D2 or D4 Pin	"	" ---------------------------------- "	((aSet == (sv1 := pinInfo at:3)) | (aSet == (sv2 := pinInfo at:4))) ifTrue: [		dc := pinInfo at:1.		" M1 pin "		self exclusiveControlServo: sv1 servo2: sv2 dcMotor: dc	].	" ---------------------------------- "	"	D7 or D8 Pin	"	" ---------------------------------- "	((aSet == (sv1 := pinInfo at:5)) | (aSet == (sv2 := pinInfo at:6))) ifTrue: [		dc := pinInfo at:2.		" M2 pin "		self exclusiveControlServo: sv1 servo2: sv2 dcMotor: dc	].	" ---------------------------------- "	"	A0 Pin (Button side)	"	" ---------------------------------- "	(aSet == (ab := pinInfo at:11)) ifTrue: [		as := pinInfo at:15.		" A0(Sensor) pin "		self exclusiveSensor: ab sensor: as.	].	" ---------------------------------- "	"	A1 Pin (Button side)	"	" ---------------------------------- "	(aSet == (ab := pinInfo at:12)) ifTrue: [		as := pinInfo at:16.		" A1(Sensor) pin "		self exclusiveSensor: ab sensor: as.	].	" ---------------------------------- "	"	A2 Pin (Button side)	"	" ---------------------------------- "	(aSet == (ab := pinInfo at:13)) ifTrue: [		as := pinInfo at:17.		" A2(Sensor) pin "		self exclusiveSensor: ab sensor: as.	].	" ---------------------------------- "	"	A3 Pin (Button side)	"	" ---------------------------------- "	(aSet == (ab := pinInfo at:14)) ifTrue: [		as := pinInfo at:18.		" A3(Sensor) pin "		self exclusiveSensor: ab sensor: as.	].	" ---------------------------------- "	"	A0 or A1 Pin (Sensor)	"	" ---------------------------------- "	((aSet == (a0 := pinInfo at:SA0Index)) | (aSet == (a1 := pinInfo at:SA1Index))) ifTrue: [		a0CB := a0 findA: ToggleButton.	" A0 pin Toggle button "		a1CB := a1 findA: ToggleButton.	" A1 pin Toggle button "		a0CmbB := a0 findA: ChoiceArgMorph.		" A0 pin argment "		a1CmbB := a1 findA: ChoiceArgMorph.		" A1 pin argment "		((a0CB isOn) & (a1CB isOn)) ifTrue: ["Transcript show:'[A01]A01OP';cr."			" Added accelerometer menu "			a0CmbB options: (self sensorPartsNameA01OP: (a0CmbB choice)).			a1CmbB options: (self sensorPartsNameA01OP: (a1CmbB choice)).		] ifFalse: ["Transcript show:'[A01]A23OP';cr."			" normal menu "			" If I select Infrared receiver or Bluttooth, select Light sensor and set flag to false. "			setComb := aSet findA: ChoiceArgMorph.			(setComb choice = InfraredReceiverName) ifTrue: [				setComb choice: LightSensorName.				selectedIR := false. 			].			(setComb choice = BluetoothName) ifTrue: [ 				setComb choice: LightSensorName.				selectedBT := false.			].			a0CmbB options: (self sensorPartsNameA23OP: (a0CmbB choice)).			a1CmbB options:  (self sensorPartsNameA23OP: (a1CmbB choice)).		].		(aSet == (a0)) ifTrue: [			ab := pinInfo at:BA0Index." A0(Button) pin "			self exclusiveSensor: a0 sensor: ab.			self changeSelectorStatus: a0.		].		(aSet == (a1)) ifTrue: [			ab := pinInfo at:BA1Index." A0(Button) pin "			self exclusiveSensor: a1 sensor: ab.			self changeSelectorStatus: a1.		].	].	" ---------------------------------- "	"	A2 Pin (Sensor side)	"	" ---------------------------------- "	(aSet == (as := pinInfo at:SA2Index)) ifTrue: ["Transcript show:'[A2]A23OP';cr."		asCmbB := as findA: ChoiceArgMorph.			asCmbB options: self sensorPartsNameA23OP.		ab := pinInfo at:13.		" A2(Button) pin "		self exclusiveSensor: as sensor: ab.		self changeSelectorStatus: as.	].	" ---------------------------------- "	"	A3 Pin (Sensor side)	"	" ---------------------------------- "	(aSet == (as := pinInfo at:SA3Index)) ifTrue: ["Transcript show:'[A3]A23OP';cr."		asCmbB := as findA: ChoiceArgMorph.			asCmbB options: self sensorPartsNameA23OP.		ab := pinInfo at:14.		" A3(Button) pin "		self exclusiveSensor: as sensor: ab.		self changeSelectorStatus: as.	].	" ---------------------------------- "	"	A4 or A5 Pin (Sensor)	"	" ---------------------------------- "	((aSet == (a4 := pinInfo at:SA4Index)) | (aSet == (a5 := pinInfo at:SA5Index))) ifTrue: [		a4CB := a4 findA: ToggleButton.	" A4 pin Toggle button "		a5CB := a5 findA: ToggleButton.	" A5 pin Toggle button "		a4CmbB := a4 findA: ChoiceArgMorph.		" A4 pin argment "		a5CmbB := a5 findA: ChoiceArgMorph.		" A5 pin argment "		((a4CB isOn) & (a5CB isOn)) ifTrue: [			" Added accelerometer menu "			a4CmbB options: (self sensorPartsNameA45OP: (a4CmbB choice)).			a5CmbB options: (self sensorPartsNameA45OP: (a5CmbB choice)).		]		ifFalse: [			" normal menu "			" If I select Infrared receiver or Bluttooth, select Light sensor and set flag to false. "			setComb := aSet findA: ChoiceArgMorph.			(setComb choice = InfraredReceiverName) ifTrue: [				setComb choice: LightSensorName.				selectedIR := false. 			].			(setComb choice = BluetoothName) ifTrue: [ 				setComb choice: LightSensorName.				selectedBT := false.			].			a4CmbB options: (self sensorPartsNameA23OP: (a4CmbB choice)).			a5CmbB options: (self sensorPartsNameA23OP: (a5CmbB choice)).		].		(aSet == (a4)) ifTrue: [ self changeSelectorStatus: a4. ].		(aSet == (a5)) ifTrue: [ self changeSelectorStatus: a5. ].	].	" ---------------------------------- "	"	A6 Pin (Sensor side)	"	" ---------------------------------- "	(aSet == (as := pinInfo at:SA6Index)) ifTrue: ["Transcript show:'[A6]A67OP';cr."		asCmbB := as findA: ChoiceArgMorph.			asCmbB options: self sensorPartsNameA67OP.		self changeSelectorStatus: as.	].	" ---------------------------------- "	"	A7 Pin (Sensor side)	"	" ---------------------------------- "	(aSet == (as := pinInfo at:SA7Index)) ifTrue: ["Transcript show:'[A7]A67OP';cr."		asCmbB := as findA: ChoiceArgMorph.			asCmbB options: self sensorPartsNameA67OP.		self changeSelectorStatus: as.	].! !!PinAssignMorph methodsFor: 'accessing' stamp: 'KK 3/27/2015 10:45'!notifyColorSensorSelect: aSet 	| set combo |	" ---------------------------------- "	"	A4 Pin (Sensor side)	"	" ---------------------------------- "	(aSet == (pinInfo at:SA4Index)) ifTrue: [		set := pinInfo at:SA5Index.		combo := set findA: ChoiceArgMorphForStuduino.	" A5 pin Toggle button "		combo choiceColorSensor.	].	" ---------------------------------- "	"	A5 Pin (Sensor side)	"	" ---------------------------------- "	(aSet == (pinInfo at:SA5Index)) ifTrue: [		set := pinInfo at:SA4Index.		combo := set findA: ChoiceArgMorphForStuduino.	" A4 pin Toggle button "		combo choiceColorSensor.	].! !!PinAssignMorph methodsFor: 'accessing' stamp: 'KK 3/27/2015 10:43'!notifyGyroSensorSelect: aSet 	| set combo |	" ---------------------------------- "	"	A4 Pin (Sensor side)	"	" ---------------------------------- "	(aSet == (pinInfo at:SA4Index)) ifTrue: [		set := pinInfo at:SA5Index.		combo := set findA: ChoiceArgMorphForStuduino.	" A5 pin Toggle button "		combo choiceGyroSensor.	].	" ---------------------------------- "	"	A5 Pin (Sensor side)	"	" ---------------------------------- "	(aSet == (pinInfo at:SA5Index)) ifTrue: [		set := pinInfo at:SA4Index.		combo := set findA: ChoiceArgMorphForStuduino.	" A4 pin Toggle button "		combo choiceGyroSensor.	].! !!PinAssignMorph methodsFor: 'accessing' stamp: 'KK 3/24/2015 11:53'!notifyInfrareReceiverSelect: aSet selectedIR := true.self removeOption:aSet item:InfraredReceiverName.! !!PinAssignMorph methodsFor: 'accessing' stamp: 'KK 3/24/2015 11:54'!notifyNotBluetoothSelect: aSet selectedBT := false.self insertOption:aSet item:BluetoothName.! !!PinAssignMorph methodsFor: 'accessing' stamp: 'KK 3/24/2015 11:54'!notifyNotInfrareReceiverSelect: aSet selectedIR := false.self insertOption:aSet item:InfraredReceiverName.! !!PinAssignMorph methodsFor: 'accessing' stamp: 'KK 3/24/2015 11:54'!notifyNotToSelectAccelerometer: aSet 	| set combo |	" ---------------------------------- "	"	A4 Pin (Sensor side)	"	" ---------------------------------- "	(aSet == (pinInfo at:SA4Index)) ifTrue: [		set := pinInfo at:SA5Index.		combo := set findA: ChoiceArgMorphForStuduino.	" A5 pin Toggle button "		(combo evaluate) = AccelerometerName ifTrue: [			combo choiceLightSensor.		].	].	" ---------------------------------- "	"	A5 Pin (Sensor side)	"	" ---------------------------------- "	(aSet == (pinInfo at:SA5Index)) ifTrue: [		set := pinInfo at:SA4Index.		combo := set findA: ChoiceArgMorphForStuduino.	" A4 pin Toggle button "		(combo evaluate) = AccelerometerName ifTrue: [			combo choiceLightSensor.		].	].! !!PinAssignMorph methodsFor: 'accessing' stamp: 'KK 3/24/2015 11:55'!notifyNotToSelectColorSensor: aSet 	| set combo |	" ---------------------------------- "	"	A4 Pin (Sensor side)	"	" ---------------------------------- "	(aSet == (pinInfo at:SA4Index)) ifTrue: [		set := pinInfo at:SA5Index.		combo := set findA: ChoiceArgMorphForStuduino.	" A5 pin Toggle button "		(combo evaluate) = ColorSensorName ifTrue: [			combo choiceLightSensor.		].	].	" ---------------------------------- "	"	A5 Pin (Sensor side)	"	" ---------------------------------- "	(aSet == (pinInfo at:SA5Index)) ifTrue: [		set := pinInfo at:SA4Index.		combo := set findA: ChoiceArgMorphForStuduino.	" A4 pin Toggle button "		(combo evaluate) = ColorSensorName ifTrue: [			combo choiceLightSensor.		].	].! !!PinAssignMorph methodsFor: 'accessing' stamp: 'KK 3/24/2015 11:55'!notifyNotToSelectGyroSensor: aSet 	| set combo |	" ---------------------------------- "	"	A4 Pin (Sensor side)	"	" ---------------------------------- "	(aSet == (pinInfo at:SA4Index)) ifTrue: [		set := pinInfo at:SA5Index.		combo := set findA: ChoiceArgMorphForStuduino.	" A5 pin Toggle button "		(combo evaluate) = GyroSensorName ifTrue: [			combo choiceLightSensor.		].	].	" ---------------------------------- "	"	A5 Pin (Sensor side)	"	" ---------------------------------- "	(aSet == (pinInfo at:SA5Index)) ifTrue: [		set := pinInfo at:SA4Index.		combo := set findA: ChoiceArgMorphForStuduino.	" A4 pin Toggle button "		(combo evaluate) = GyroSensorName ifTrue: [			combo choiceLightSensor.		].	].! !!PinAssignMorph methodsFor: 'accessing' stamp: 'KK 3/24/2015 11:56'!notifyNotUltrasonicSelect: aSet 	| set combo |	" ---------------------------------- "	"	A0 Pin (Sensor side)	"	" ---------------------------------- "	(aSet == (pinInfo at:SA0Index)) ifTrue: [		set := pinInfo at:SA1Index.		combo := set findA: ChoiceArgMorphForStuduino.	" A1 pin Toggle button "		(combo evaluate) = UltrasonicSensorName ifTrue: [			combo choiceLightSensor.		].	].	" ---------------------------------- "	"	A1 Pin (Sensor side)	"	" ---------------------------------- "	(aSet == (pinInfo at:SA1Index)) ifTrue: [		set := pinInfo at:SA0Index.		combo := set findA: ChoiceArgMorphForStuduino.	" A0 pin Toggle button "		(combo evaluate) = UltrasonicSensorName ifTrue: [			combo choiceLightSensor.		].	].! !!PinAssignMorph methodsFor: 'accessing' stamp: 'KK 3/9/2015 10:54'!notifyUltrasonicSelect: aSet 	| set combo |	" ---------------------------------- "	"	A0 Pin (Sensor side)	"	" ---------------------------------- "	(aSet == (pinInfo at:SA0Index)) ifTrue: [		set := pinInfo at:SA1Index.		combo := set findA: ChoiceArgMorphForStuduino.	" A5 pin Toggle button "		combo choiceUltrasonicSensor.	].	" ---------------------------------- "	"	A1 Pin (Sensor side)	"	" ---------------------------------- "	(aSet == (pinInfo at:SA1Index)) ifTrue: [		set := pinInfo at:SA0Index.		combo := set findA: ChoiceArgMorphForStuduino.	" A4 pin Toggle button "		combo choiceUltrasonicSensor.	].! !!PinAssignMorph methodsFor: 'accessing' stamp: 'KK 3/9/2015 11:22'!removeOption: aSet item: aString	" Remove the item from parts list when the item selected "	| sensors others combo newOptions |	" Get sensor's collection "	sensors := pinInfo select: [:each| 		((each findA: ChoiceArgMorph) = nil) not].	" Get other's sensors "	others := sensors select: [:each |(each = aSet) not].	others do: [:each |		combo := each findA: ChoiceArgMorph.		newOptions := (combo options ) select: [:option|			(option = aString) not	].		combo options: newOptions.	].! !!PinAssignMorph methodsFor: 'accessing' stamp: 'KK 12/26/2017 16:49'!setAllOff	| cb combo |	" Set all checkbox off. "	selectedBT := false.	selectedIR := false.	pinInfo do: [ :pin |		combo := pin findA: ChoiceArgMorphForStuduino.		combo ifNotNil: [			combo choice: LightSensorName.		].		cb := pin findA: ToggleButton.	" Toggle button "		cb offStuduino.	].! !!PinAssignMorph methodsFor: 'accessing' stamp: 'KK 12/26/2017 16:50'!setCheckBox: portNumber partsID: pID	| set cb cmb |	" Set checkbox "	" If port connect nothing, do nothing. "	(pID = StdnoPIDOpen) ifTrue: [ ^ self. ].	" connect with something... "	(portNumber > 0) & (portNumber < 11) ifTrue: [	" M1 - D12 "		set := pinInfo at:portNumber.		" If the port connect with motor, set checkbox on. "		cb := set findA: ToggleButton.	" Toggle button "		cb onStuduino.	]	ifFalse: [	" A0 - A7 "		(pID = StdnoPIDButton) ifTrue: [			" Button "			set := pinInfo at:portNumber.			cb := set findA: ToggleButton.	"Toggle button "			cb onStuduino.		]		ifFalse: [			" Other Sensor or LED / Buzzer "			set := pinInfo at:(portNumber + 4).			cb := set findA: ToggleButton.			"Toggle button "			cmb := set findA: ChoiceArgMorphForStuduino.	" Parts name combo box "			cb onStuduino.			(pID = StdnoPIDLightSensor) ifTrue: [				cmb choice:LightSensorName			].			(pID = StdnoPIDTouchSensor) ifTrue: [				cmb choice:TouchSensorName			].			(pID = StdnoPIDSoundSensor) ifTrue: [				cmb choice:SoundSensorName			].			(pID = StdnoPIDIR) ifTrue: [				cmb choice:IRPhotoreflectorName			].			(pID = StdnoPIDAcceleration) ifTrue: [				cmb choice:AccelerometerName.			].			(pID = StdnoPIDLED) ifTrue: [				cmb choice:LEDName.			].			(pID = StdnoPIDBuzzer) ifTrue: [				cmb choice:BuzzerName.			].			(pID = StdnoPIDI2C) ifTrue: [				cmb choice:I2CDeviceName.			].			(pID = StdnoPIDInfraredRecv) ifTrue: [				cmb choice:InfraredReceiverName.				selectedIR := true.			].			(pID = StdnoPIDTemperature) ifTrue: [				cmb choice:TemperatureSensorName.			].			(pID = StdnoPIDGyro) ifTrue: [				cmb choice:GyroSensorName.			].			(pID = StdnoPIDUltrasonic) ifTrue: [				cmb choice:UltrasonicSensorName.			].			(pID = StdnoPIDColor) ifTrue: [				cmb choice:ColorSensorName.			].			(pID = StdnoPIDBluetooth) ifTrue: [				selectedBT := true.				cmb choice:BluetoothName.			].		].	].! !!PinAssignMorph methodsFor: 'accessing' stamp: 'SeijiKagayama 11/14/2017 11:55'!setCheckBoxOn: portNumber partsID: pID	| set cb |	" Set checkbox "	" If port connect nothing, do nothing. "	(pID = StdnoPIDOpen) ifTrue: [ ^ self. ].	" connect with something... "	(portNumber > 0) & (portNumber < 11) ifTrue: [	" M1 - D12 "		set := pinInfo at:portNumber.		" If the port connect with motor, set checkbox on. "		cb := set findA: ToggleButton.	" Toggle button "		cb on.		self notifyCheckChange: (cb owner).	]	ifFalse: [	" A0 - A7 "		(pID = StdnoPIDButton) ifTrue: [			" Button "			set := pinInfo at:portNumber.			cb := set findA: ToggleButton.	"Toggle button "			cb on.			self notifyCheckChange: (cb owner).		]		ifFalse: [			" Other Sensor or LED / Buzzer "			set := pinInfo at:(portNumber + 4).			cb := set findA: ToggleButton.			"Toggle button "			cb on.			self notifyCheckChange: (cb owner).		].	].! !!PinAssignMorph methodsFor: 'accessing' stamp: 'KK 3/24/2015 13:07'!setComboBox: portNumber partsID: pID	| set cmb |	" Set checkbox "	" If port connect nothing, do nothing. "	(pID = StdnoPIDOpen) ifTrue: [ ^ self. ].	" A0 - A7 "	" Other Sensor or LED / Buzzer "	set := pinInfo at:(portNumber + 4).	cmb := set findA: ChoiceArgMorphForStuduino.	" Parts name combo box "	(pID = StdnoPIDLightSensor) ifTrue: [		cmb choice:LightSensorName	].	(pID = StdnoPIDTouchSensor) ifTrue: [		cmb choice:TouchSensorName	].	(pID = StdnoPIDSoundSensor) ifTrue: [		cmb choice:SoundSensorName	].	(pID = StdnoPIDIR) ifTrue: [		cmb choice:IRPhotoreflectorName	].	(pID = StdnoPIDAcceleration) ifTrue: [		cmb choice:AccelerometerName.	].	(pID = StdnoPIDLED) ifTrue: [		cmb choice:LEDName.	].	(pID = StdnoPIDBuzzer) ifTrue: [		cmb choice:BuzzerName.	].	(pID = StdnoPIDI2C) ifTrue: [		cmb choice:I2CDeviceName.	].	(pID = StdnoPIDInfraredRecv) ifTrue: [		cmb choice:InfraredReceiverName.		selectedIR := true.	].	(pID = StdnoPIDTemperature) ifTrue: [		cmb choice:TemperatureSensorName.	].	(pID = StdnoPIDGyro) ifTrue: [		cmb choice:GyroSensorName.	].	(pID = StdnoPIDUltrasonic) ifTrue: [		cmb choice:UltrasonicSensorName.	].	(pID = StdnoPIDColor) ifTrue: [		cmb choice:ColorSensorName.	].	(pID = StdnoPIDBluetooth) ifTrue: [		selectedBT := true.		cmb choice:BluetoothName.	].! !!PinAssignMorph methodsFor: 'accessing' stamp: 'KK 1/6/2015 13:46'!setFrameMorph: frame	| |	" Set frame moprh. "	frameMorph := frame.! !!PinAssignMorph methodsFor: 'initialization' stamp: 'KK 12/4/2017 20:03'!addPACheckBox: area pinNames: pn	"Add a readout row with the given label. Answer the stringmorph that's the readout."	| row b temporary ratio cbRatio |	ratio := ScratchTranslator renderScale.	cbRatio := 1.0.	ratio > 1.5 ifTrue: [ cbRatio := ratio - 0.2. ].	temporary := OrderedCollection new.	pn do: [:pin |		row := AlignmentMorph newRow color: area color;			hResizing: #rigid;			vResizing: #shrinkWrap;			extent:(45*cbRatio)@30.		b := ToggleButton new			onForm: ((ScratchFrameMorph skinAt: #watcherButtonPressed) magnifyBy: ratio)			offForm: ((ScratchFrameMorph skinAt: #watcherButton) magnifyBy: ratio)			overForm: nil			disabledForm: ((ScratchFrameMorph skinAt: #watcherButton) magnifyBy: ratio).		b target: self;			actionSelector: #notifyCheckChange:;			arguments: (Array braceWith: row);			actWhen: #buttonUp.		row addMorph:b.		row addMorphBack: (Morph new color: area color; extent: 5@3).  "spacer""		row addMorphBack: (StringMorph contents: pin font: (ScratchFrameMorph getFont: #Label))."		row addMorphBack: (StringMorph contents: pin font: (StrikeFont fontName: 'VerdanaBold' size: 10 * ratio)).		area addMorphBack:row.		temporary add: row.	].	^ temporary.! !!PinAssignMorph methodsFor: 'initialization' stamp: 'KK 12/4/2017 20:06'!addPACheckComboBox: area pinNames: pn	"Add a readout row with the given label. Answer the stringmorph that's the readout."	| row b c temporary fixFieldWidth ratio cbRatio |	ratio := ScratchTranslator renderScale.	fixFieldWidth := 120 * ratio.	cbRatio := 1.0.	ratio > 1.5 ifTrue: [ cbRatio := ratio - 0.2. ].	temporary := OrderedCollection new.	pn do: [:pin |		row := AlignmentMorph newRow color: area color;			hResizing: #rigid;			extent:(190*cbRatio)@30.		b := ToggleButton new			onForm: ((ScratchFrameMorph skinAt: #watcherButtonPressed) magnifyBy: ratio)			offForm: ((ScratchFrameMorph skinAt: #watcherButton) magnifyBy: ratio)			overForm: nil			disabledForm: ((ScratchFrameMorph skinAt: #watcherButton) magnifyBy: ratio).		b target: self;			actionSelector: #notifyCheckChange:;			arguments: (Array braceWith: row);			actWhen: #buttonUp.		row addMorph:b.		row addMorphBack: (Morph new color: area color; extent: 5@3).  "spacer"		row addMorphBack: (StringMorph contents: pin font: (StrikeFont fontName: 'VerdanaBold' size: 10 * ratio)).		row addMorphBack: (Morph new color: area color; extent: 5@3).  "spacer"		c := ChoiceArgMorphForStuduino new				color: Color gray;				valiable: false.		c setFieldWidth: fixFieldWidth height: (20 * cbRatio).		(c labelMorph)			color: Color black.		((pin = 'A0') | (pin = 'A1') | (pin = 'A2') | (pin = 'A3')) ifTrue: [			c options: self sensorPartsName0123	].		((pin = 'A4') | (pin = 'A5')) ifTrue: [			c options: self sensorPartsName45	].		((pin = 'A6') | (pin = 'A7')) ifTrue: [			c options: self sensorPartsName67	].		row addMorphBack: c.		row addMorphBack: (Morph new color: area color; extent: 15@3).  "spacer"		temporary add: row.		area addMorphBack:row.	].	^ temporary.! !!PinAssignMorph methodsFor: 'initialization' stamp: 'KK 12/4/2017 19:16'!addReadouts	| buttonRow spacer button1 button2 button3 buttonSpacer |	" Make all alignment column "	column := AlignmentMorph newColumn		centering: #center;		hResizing: #shrinkWrap;		vResizing: #shrinkWrap;		color: (Color r: (240/255) g: (240/255) b: (240/255));		borderWidth: 2;		borderColor: (Color r: (148/255) g: (145/255) b: (145/255));		useRoundedCorners;		inset: 3.	" Make title morph and add column and update "	titleMorph := StringMorph		contents: ('Pin Assignment Board' localized)"		font: (ScratchFrameMorph getFont: #Label)."		font: (StrikeFont fontName: 'VerdanaBold' size: 12).	column addMorph: titleMorph.	column addMorphBack: (Morph new color: column color; extent: 5@3).  "spacer"	self removeAllMorphs.	" Make DC motor, servomotor, button assign space "	motorButtonPAArea := AlignmentMorph newRow color: column color.	column addMorphBack: motorButtonPAArea.	self updateMotorButtonPAArea.	" Make sensor, LED, buzzer assign space "	sensorPAArea := AlignmentMorph newColumn		color: (Color r: (153/255) g: (180/255) b: (209/255));		borderWidth: 1;		borderColor: (Color r: (148/255) g: (145/255) b: (145/255));		useRoundedCorners;		inset:3.	column addMorphBack: sensorPAArea.	self updateSensorPAArea.	" Make button alignment morph and add column and update "	buttonRow := AlignmentMorph newRow		color: Color transparent;		hResizing: #shrinkWrap;		vResizing: #shrinkWrap;		height: 32.	column addMorphBack: buttonRow.	spacer := Morph new extent: 10@5; color: Color transparent.	buttonRow removeAllMorphs.	" Bottommost Buttons "	button1 := (self buttonLabel: 'Uncheck All' localized action: #setAllOff).	button2 := (self buttonLabel: 'OK' localized action: #yes).	button3 := (self buttonLabel: 'Cancel' localized action: #cancelled).	" Spacer between Uncheck All button and OK button "	buttonSpacer := (sensorPAArea fullBounds corner) -				    ((button1 fullBounds corner) + (button2 fullBounds corner) + (button3 fullBounds corner)).	buttonSpacer setX: (buttonSpacer x - spacer extent x) setY:5.	" Set high "	" Locate buttons "	buttonRow addMorphBack: button1.	buttonRow addMorphBack: (Morph new extent: buttonSpacer; color: Color transparent) fullCopy.	buttonRow addMorphBack: button2.	buttonRow addMorphBack: spacer fullCopy.	buttonRow addMorphBack: button3.	column position: self position - 2.	self addMorph: column.	self extent: column extent - 4.! !!PinAssignMorph methodsFor: 'initialization' stamp: 'SeijiKagayama 9/5/2017 15:49'!initialize	super initialize.	done := false.	pinInfo := Array new: 22.	" pinInfo position. "	BA0Index := 11.	" Button A0 "	BA1Index := 12.	" Button A1 "	BA2Index := 13.	" Button A2 "	BA3Index := 14.	" Button A3 "	SA0Index := 15.	" Sensor A0 "	SA1Index := 16.	" Sensor A1 "	SA2Index := 17.	" Sensor A2 "	SA3Index := 18.	" Sensor A3 "	SA4Index := 19.	" Sensor A4 "	SA5Index := 20.	" Sensor A5 "	SA6Index := 21.	" Sensor A6 "	SA7Index := 22.	" Sensor A7 "	pinAssignTemporary := Array new: 18.	self addReadouts.! !!PinAssignMorph methodsFor: 'initialization' stamp: 'KK 4/7/2014 13:09'!setDefaultPosition	|  partsID box val dh dm dl |	3 to: 10 do: [ :i |		partsID := IOPort at:i.		" Get Parts ID "		" Send only servomotor info to board "		(partsID = StdnoPIDServomotor) ifTrue: [			box := Boxes at: (i-2).			val := box getValue.			dh := i - 3.			val := val + 90.			dm := (val bitShift: -6) bitAnd: 16r03.			dl := val bitAnd: 16r3F.			self partsID: 1 high: dh middle: dm low: dl.		].	].! !!PinAssignMorph methodsFor: 'interaction' stamp: 'SeijiKagayama 9/5/2017 15:51'!cancelled	response := false.	done := true.	self delete.	World doOneCycle	"erase myself from the screen"! !!PinAssignMorph methodsFor: 'interaction' stamp: 'SeijiKagayama 9/5/2017 16:01'!getUserResponse	"Wait for the user to respond, then report their response. The symbol #cancel is returned if the user wishes to cancel the operation. True/false is returned if they respond yes/no, and a string is returned if this this a string input dialog and they don't cancel."	"Details: This is invoked synchronously from the caller. In order to keep processing inputs and updating the screen while waiting for the user to respond, this method has its own version of the World's event loop."	| w |	self openInWorld.	w := self world.	done := false.	[done] whileFalse: [w doOneCycle].  "wait for user to press a button"	^ response! !!PinAssignMorph methodsFor: 'interaction' stamp: 'SeijiKagayama 9/5/2017 13:51'!handlesMouseDown: evt	" To avoid being grabbed by a hand morph. "	^ true! !!PinAssignMorph methodsFor: 'interaction' stamp: 'KK 12/5/2017 16:38'!mouseDown: evt	evt hand waitForClicksOrDrag: self event: evt.! !!PinAssignMorph methodsFor: 'interaction' stamp: 'KK 5/28/2014 16:55'!returnPinAssignInfo	| index |	"Return pin assignment from temporary buffer"		index := 1.	pinAssignTemporary do: [ :parts |		self setCheckBox: index partsID:parts.		index := index + 1.	].! !!PinAssignMorph methodsFor: 'interaction' stamp: 'KK 5/28/2014 16:52'!savePinAssignInfo	"Set pin assignment to IOPort"		self setPinAssignInfo: pinAssignTemporary.! !!PinAssignMorph methodsFor: 'interaction' stamp: 'sk 7/6/2017 20:00'!setPinAssignInfo: buf	"Set pin assignment"		| cb name set i2cUsed |	" Initialize buf array "	1 to: (buf size) do: [:num |		buf at:num put:0.	].	" Initialize some sensor's used flag "	i2cUsed := false.	InfraredReceiverUsed := -1.	UltrasonicUsed := false.	" Set buf information "	1 to: (pinInfo size) do: [:index |		set := pinInfo at:index.		cb := set findA: ToggleButton.	" Toggle button "		(index <= 2) ifTrue: [					" DC motor "			(cb isOn) ifTrue: [buf at:index put:StdnoPIDDCMotor.]		].		((index >= 3) & (index <= 10)) ifTrue: [	" Servomotor "			(cb isOn) ifTrue: [buf at:index put:StdnoPIDServomotor.]		].		((index >= 11) & (index <= 14)) ifTrue: [	" Button "			(cb isOn) ifTrue: [buf at:index put:StdnoPIDButton.]		].		((index >= 15) & (index <= 22)) ifTrue: [	" Sensro / LED / Buzzer "			(cb isOn) ifTrue: [				" Get selected name. "				name := (set findA: ChoiceArgMorphForStuduino) choice.				(name = LightSensorName) ifTrue: [ buf at:(index-4) put:StdnoPIDLightSensor.].				(name = TouchSensorName) ifTrue: [ buf at:(index-4) put:StdnoPIDTouchSensor.].				(name = SoundSensorName) ifTrue: [ buf at:(index-4) put:StdnoPIDSoundSensor.].				(name = IRPhotoreflectorName) ifTrue: [ buf at:(index-4) put:StdnoPIDIR.].				(name = AccelerometerName) ifTrue: [ buf at:(index-4) put:StdnoPIDAcceleration.].				(name = LEDName) ifTrue: [ buf at:(index-4) put:StdnoPIDLED.].				(name = BuzzerName) ifTrue: [ buf at:(index-4) put:StdnoPIDBuzzer.].				(name = InfraredReceiverName) ifTrue: [					InfraredReceiverUsed := (index-4).					buf at:(index-4) put:StdnoPIDInfraredRecv.				].				(name = TemperatureSensorName) ifTrue: [ buf at:(index-4) put:StdnoPIDTemperature.].				(name = GyroSensorName) ifTrue: [ buf at:(index-4) put: StdnoPIDGyro.].				(name = UltrasonicSensorName) ifTrue: [					UltrasonicUsed := true.					buf at:(index-4) put: StdnoPIDUltrasonic.].				(name = ColorSensorName) ifTrue: [ buf at:(index-4) put: StdnoPIDColor.].				(name = BluetoothName) ifTrue: [ buf at:(index-4) put: StdnoPIDBluetooth.].			]		].	].	^ i2cUsed.! !!PinAssignMorph methodsFor: 'interaction' stamp: 'SeijiKagayama 9/5/2017 15:50'!yes	"Set pin assignment to IOPort"	" Set pin assign to global information "	self setPinAssignInfo: IOPort.	response := true.	done := true.	self delete.	World doOneCycle	"erase myself from the screen"! !!PinAssignMorph methodsFor: 'private' stamp: 'KK 12/4/2017 16:53'!buttonLabel: labelString action: actionSelector	"Answer a new button with the given label and selector. The button target will be me and it will use my button forms."	"(DialogBoxMorph new buttonLabel: 'Yes' action: #beep) openInWorld"	| onForm offForm button overForm |	onForm := ScratchFrameMorph skinAt: #btnPressed.	offForm := ScratchFrameMorph skinAt: #btn.	overForm := ScratchFrameMorph skinAt: #btn.	button := ResizableToggleButton2 new		offForm: offForm		onForm: onForm		overForm: overForm.	^ button		padding: 20@10;		label: labelString font: (ScratchFrameMorph getFont: #Label);"		label: labelString font: (ScratchFrameMorph getFont: #DialogBoxButton);"		target: self;		actionSelector: actionSelector;		setLabelColor: (Color gray: 0.15)! !!PinAssignMorph methodsFor: 'private' stamp: 'KK 3/6/2015 18:19'!removeItem: order	| |	"Answer a collection of A0-A1 connectable parts name."	selectedIR ifFalse: [ order remove: 'Infrared receiver' ].	selectedBT ifFalse: [ order remove: 'Bluetooth' ].	^ order.! !!PinAssignMorph methodsFor: 'private' stamp: 'KK 12/5/2017 16:57'!sensorPartsName0123	"Answer a collection of A0-A3 connectable parts name."	^ #(		'Light sensor'		'Touch sensor'		'Sound sensor'		'IR photoreflector'		'Temperature sensor'		'LED'		'Buzzer'		)! !!PinAssignMorph methodsFor: 'private' stamp: 'KK 12/5/2017 17:49'!sensorPartsName45	"Answer a collection of A4,A5 connectable parts name."	^ #(		'Light sensor'		'Touch sensor'		'Sound sensor'		'IR photoreflector'		'Temperature sensor'		'Accelerometer'		'Gyro sensor'		'LED'		'Buzzer'		)! !!PinAssignMorph methodsFor: 'private' stamp: 'KK 12/5/2017 17:00'!sensorPartsName67	"Answer a collection of A6,A7 connectable parts name."	^ #(		'Light sensor'		'Sound sensor'		'IR photoreflector'		'Temperature sensor'		)! !!PinAssignMorph methodsFor: 'private' stamp: 'KK 12/5/2017 17:47'!sensorPartsNameA01OP	| myOrderedCollection |	"Answer a collection of A0-A1 connectable parts name."	myOrderedCollection := OrderedCollection new.	myOrderedCollection add: 'Light sensor';		add: TouchSensorName;		add: SoundSensorName;		add: IRPhotoreflectorName;"		add: TemperatureSensorName;"		add: LEDName;		add: BuzzerName;		add: '-';		add: UltrasonicSensorName.	selectedIR ifFalse: [ myOrderedCollection add: InfraredReceiverName ].	myOrderedCollection add: TemperatureSensorName.	selectedBT ifFalse: [ myOrderedCollection add: BluetoothName ].	^ myOrderedCollection.! !!PinAssignMorph methodsFor: 'private' stamp: 'KK 12/5/2017 17:47'!sensorPartsNameA01OP: selfOption	| myOrderedCollection |	"Answer a collection of A0-A1 connectable parts name."	myOrderedCollection := OrderedCollection new.	myOrderedCollection add: 'Light sensor';		add: TouchSensorName;		add: SoundSensorName;		add: IRPhotoreflectorName;"		add: TemperatureSensorName;"		add: LEDName;		add: BuzzerName;		add: '-';		add: UltrasonicSensorName.	selectedIR ifFalse: [ myOrderedCollection add: InfraredReceiverName ]	ifTrue: [		(selfOption = InfraredReceiverName) ifTrue: [			myOrderedCollection add: InfraredReceiverName ].	].	myOrderedCollection add: TemperatureSensorName.	selectedBT ifFalse: [ myOrderedCollection add: BluetoothName ]	ifTrue: [		(selfOption = BluetoothName) ifTrue: [			myOrderedCollection add: BluetoothName ].	].	^ myOrderedCollection.! !!PinAssignMorph methodsFor: 'private' stamp: 'KK 12/5/2017 17:47'!sensorPartsNameA23OP	| myOrderedCollection |	"Answer a collection of A0-A1 connectable parts name."	" ir : true(selected) / false(not select) "	" bt : true(selected) / false(not select) "	myOrderedCollection := OrderedCollection new.	myOrderedCollection add: LightSensorName;		add: TouchSensorName;		add: SoundSensorName;		add: IRPhotoreflectorName;"		add: TemperatureSensorName;"		add: LEDName;		add: BuzzerName;		add: '-'.	selectedIR ifFalse: [ myOrderedCollection add: InfraredReceiverName ].	myOrderedCollection add: TemperatureSensorName.	selectedBT ifFalse: [ myOrderedCollection add: BluetoothName ].	^ myOrderedCollection.! !!PinAssignMorph methodsFor: 'private' stamp: 'KK 12/5/2017 17:48'!sensorPartsNameA23OP: selfOption	| myOrderedCollection |	"Answer a collection of A0-A1 connectable parts name."	" ir : true(selected) / false(not select) "	" bt : true(selected) / false(not select) "	myOrderedCollection := OrderedCollection new.	myOrderedCollection add: LightSensorName;		add: TouchSensorName;		add: SoundSensorName;		add: IRPhotoreflectorName;"		add: TemperatureSensorName;"		add: LEDName;		add: BuzzerName;		add: '-'.	selectedIR ifFalse: [ myOrderedCollection add: InfraredReceiverName ]	ifTrue: [		(selfOption = InfraredReceiverName) ifTrue: [			myOrderedCollection add: InfraredReceiverName ].	].	myOrderedCollection add: TemperatureSensorName.	selectedBT ifFalse: [ myOrderedCollection add: BluetoothName ]	ifTrue: [		(selfOption = BluetoothName) ifTrue: [			myOrderedCollection add: BluetoothName ].	].	^ myOrderedCollection.! !!PinAssignMorph methodsFor: 'private' stamp: 'KK 12/5/2017 17:48'!sensorPartsNameA45OP	| myOrderedCollection |	"Answer a collection of A0-A1 connectable parts name."	" ir : true(selected) / false(not select) "	" bt : true(selected) / false(not select) "	myOrderedCollection := OrderedCollection new.	myOrderedCollection add: LightSensorName;		add: TouchSensorName;		add: SoundSensorName;		add: IRPhotoreflectorName;"		add: TemperatureSensorName;"		add: AccelerometerName;"		add: GyroSensorName;"		add: LEDName;		add: BuzzerName;		add: '-'.	selectedIR ifFalse: [ myOrderedCollection add: InfraredReceiverName ].	myOrderedCollection add: TemperatureSensorName.	selectedBT ifFalse: [ myOrderedCollection add: BluetoothName ].	myOrderedCollection add: GyroSensorName;		add: ColorSensorName.	^ myOrderedCollection.! !!PinAssignMorph methodsFor: 'private' stamp: 'KK 12/5/2017 17:48'!sensorPartsNameA45OP: selfOption	| myOrderedCollection |	"Answer a collection of A0-A1 connectable parts name."	" ir : true(selected) / false(not select) "	" bt : true(selected) / false(not select) "	myOrderedCollection := OrderedCollection new.	myOrderedCollection add: LightSensorName;		add: TouchSensorName;		add: SoundSensorName;		add: IRPhotoreflectorName;"		add: TemperatureSensorName;"		add: AccelerometerName;"		add: GyroSensorName;"		add: LEDName;		add: BuzzerName;		add: '-'.	selectedIR ifFalse: [ myOrderedCollection add: InfraredReceiverName ]	ifTrue: [		(selfOption = InfraredReceiverName) ifTrue: [			myOrderedCollection add: InfraredReceiverName ].	].	myOrderedCollection add: TemperatureSensorName.	selectedBT ifFalse: [ myOrderedCollection add: BluetoothName ]	ifTrue: [		(selfOption = BluetoothName) ifTrue: [			myOrderedCollection add: BluetoothName ].	].	myOrderedCollection add: GyroSensorName;		add: ColorSensorName.	^ myOrderedCollection.! !!PinAssignMorph methodsFor: 'private' stamp: 'KK 12/5/2017 17:48'!sensorPartsNameA67OP	| myOrderedCollection |	"Answer a collection of A0-A1 connectable parts name."	" ir : true(selected) / false(not select) "	" bt : true(selected) / false(not select) "	myOrderedCollection := OrderedCollection new.	myOrderedCollection add: LightSensorName;		add: SoundSensorName;		add: IRPhotoreflectorName;"		add: TemperatureSensorName;"		add: '-'.	myOrderedCollection add: TemperatureSensorName.	selectedBT ifFalse: [ myOrderedCollection add: BluetoothName ].	^ myOrderedCollection.! !!PinAssignMorph methodsFor: 'private' stamp: 'KK 5/26/2014 17:33'!updateButtonTitle	"Update my title to reflect the current protocol and port number."	| s |	s := 'Button' localized.	s = buttonTitleMorph contents ifFalse: [buttonTitleMorph contents: s].! !!PinAssignMorph methodsFor: 'private' stamp: 'KK 5/26/2014 17:27'!updateDCTitle	"Update my title to reflect the current protocol and port number."	| s |	s := 'DC motor' localized.	s = dcTitleMorph contents ifFalse: [dcTitleMorph contents: s].! !!PinAssignMorph methodsFor: 'private' stamp: 'KK 12/4/2017 16:15'!updateMotorButtonPAArea	"Update servomotor calibration."	|  dcPAArea dcPA pn svPAArea btnPAArea svPA btnPA rowTemp |	" -------------------------------------------------------------------- "	" 	DC motor pin assign area. "	" -------------------------------------------------------------------- "	dcPAArea := AlignmentMorph newColumn		hResizing: #shrinkWrap;		vResizing: #spaceFill;		color: (Color r: (143/255) g: (188/255) b: (139/255));		borderWidth: 1;		borderColor: (Color r: (148/255) g: (145/255) b: (145/255));		useRoundedCorners;		inset: 3.	dcTitleMorph := StringMorph		contents: ''"		font: (ScratchFrameMorph getFont: #Label)."		font: (StrikeFont fontName: 'VerdanaBold' size: 10).	dcPAArea addMorph: dcTitleMorph.	self updateDCTitle.	dcPAArea addMorphBack: (Morph new color: dcPAArea color; extent: 5@3).  "spacer"	dcPA := AlignmentMorph newRow		color:dcPAArea color;		borderColor: (Color r: (148/255) g: (145/255) b: (145/255));		useRoundedCorners;		inset: 3.	dcPAArea addMorphBack: dcPA.		pn := #(M1 M2).	rowTemp := self addPACheckBox: dcPA pinNames: pn.	pinInfo at:1 put:(rowTemp at:1).		" M1 "	pinInfo at:2 put:(rowTemp at:2).		" M2 "	motorButtonPAArea addMorphBack: dcPAArea.	motorButtonPAArea addMorphBack: (Morph new color: motorButtonPAArea color; extent: 5@3).  "spacer"	" -------------------------------------------------------------------- "	" 	Servomotor pin assign area. "	" -------------------------------------------------------------------- "	svPAArea := AlignmentMorph newColumn		hResizing: #shrinkWrap;		vResizing: #shrinkWrap;		color: (Color r: (240/255) g: (128/255) b: (128/255));		borderWidth: 1;		borderColor: (Color r: (148/255) g: (145/255) b: (145/255));		useRoundedCorners;		inset: 3.	servoTitleMorph := StringMorph		contents: ''"		font: (ScratchFrameMorph getFont: #Label)."		font: (StrikeFont fontName: 'VerdanaBold' size: 10).	svPAArea addMorph: servoTitleMorph.	self updateServoTitle.	svPAArea addMorphBack: (Morph new color: svPAArea color; extent: 5@3).  "spacer"	svPA := AlignmentMorph newRow		color:svPAArea color;		borderColor: (Color r: (148/255) g: (145/255) b: (145/255));		useRoundedCorners;		inset: 3.	svPAArea addMorphBack: svPA.		pn := #(D2 D4 D7 D8).	rowTemp := self addPACheckBox: svPA pinNames: pn.	pinInfo at:3 put:(rowTemp at:1).		" D2 "	pinInfo at:4 put:(rowTemp at:2).		" D4 "	pinInfo at:5 put:(rowTemp at:3).		" D7 "	pinInfo at:6 put:(rowTemp at:4).		" D8 "	svPA := AlignmentMorph newRow		color:svPAArea color;		borderColor: (Color r: (148/255) g: (145/255) b: (145/255));		useRoundedCorners;		inset: 3.	svPAArea addMorphBack: svPA.		pn := #(D9 D10 D11 D12).	rowTemp := self addPACheckBox: svPA pinNames: pn.	pinInfo at:7 put:(rowTemp at:1).		" D9 "	pinInfo at:8 put:(rowTemp at:2).		" D10 "	pinInfo at:9 put:(rowTemp at:3).		" D11 "	pinInfo at:10 put:(rowTemp at:4).	" D12 "	motorButtonPAArea addMorphBack: svPAArea.	motorButtonPAArea addMorphBack: (Morph new color: motorButtonPAArea color; extent: 5@3).  "spacer"	" -------------------------------------------------------------------- "	"	Button pin assign area. "	" -------------------------------------------------------------------- "	btnPAArea := AlignmentMorph newColumn		hResizing: #spaceFill;		vResizing: #shrinkWrap;		color: (Color r: (244/255) g: (164/255) b: (96/255));		borderWidth: 1;		borderColor: (Color r: (148/255) g: (145/255) b: (145/255));		useRoundedCorners;		inset: 3.	buttonTitleMorph := StringMorph		contents: ''"		font: (ScratchFrameMorph getFont: #Label)."		font: (StrikeFont fontName: 'VerdanaBold' size: 10).	btnPAArea addMorph: buttonTitleMorph.	self updateButtonTitle.	btnPAArea addMorphBack: (Morph new color: btnPAArea color; extent: 5@3).  "spacer"	btnPA := AlignmentMorph newRow		color:btnPAArea color;		borderColor: (Color r: (148/255) g: (145/255) b: (145/255));		useRoundedCorners;		inset: 3.	btnPAArea addMorphBack: btnPA.		pn := #(A0 A2).	rowTemp := self addPACheckBox: btnPA pinNames: pn.	pinInfo at:11 put:(rowTemp at:1).		" A0 "	pinInfo at:13 put:(rowTemp at:2).	" A2 "	btnPA := AlignmentMorph newRow		color:btnPAArea color;		borderColor: (Color r: (148/255) g: (145/255) b: (145/255));		useRoundedCorners;		inset: 3.	btnPAArea addMorphBack: btnPA.		pn := #(A1 A3).	rowTemp := self addPACheckBox: btnPA pinNames: pn.	pinInfo at:12 put:(rowTemp at:1).		" A1 "	pinInfo at:14 put:(rowTemp at:2).	" A3 "	motorButtonPAArea addMorphBack: btnPAArea.! !!PinAssignMorph methodsFor: 'private' stamp: 'KK 12/4/2017 16:15'!updateSensorPAArea	"Update sensor pin assign. "	|  pn sensorPA rowTemp |	sensorTitleMorph := StringMorph		contents: ''"		font: (ScratchFrameMorph getFont: #Label)."		font: (StrikeFont fontName: 'VerdanaBold' size: 10).	sensorPAArea addMorph: sensorTitleMorph.	self updateSensorTitle.	sensorPAArea addMorphBack: (Morph new color: sensorPAArea color; extent: 5@3).  "spacer"	sensorPA := AlignmentMorph newRow		color:sensorPAArea color;		borderColor: (Color r: (148/255) g: (145/255) b: (145/255));		useRoundedCorners;		inset: 3.	sensorPAArea addMorphBack: sensorPA.		pn := #(A0 A4).	rowTemp := self addPACheckComboBox: sensorPA pinNames: pn.	pinInfo at:15 put:(rowTemp at:1).		" A0 "	pinInfo at:19 put:(rowTemp at:2).	" A4 "	sensorPA := AlignmentMorph newRow		color:sensorPAArea color;		borderColor: (Color r: (148/255) g: (145/255) b: (145/255));		useRoundedCorners;		inset: 3.	sensorPAArea addMorphBack: sensorPA.		pn := #(A1 A5).	rowTemp := self addPACheckComboBox: sensorPA pinNames: pn.	pinInfo at:16 put:(rowTemp at:1).		" A1 "	pinInfo at:20 put:(rowTemp at:2).	" A5 "	sensorPA := AlignmentMorph newRow		color:sensorPAArea color;		borderColor: (Color r: (148/255) g: (145/255) b: (145/255));		useRoundedCorners;		inset: 3.	sensorPAArea addMorphBack: sensorPA.		pn := #(A2 A6).	rowTemp := self addPACheckComboBox: sensorPA pinNames: pn.	pinInfo at:17 put:(rowTemp at:1).		" A2 "	pinInfo at:21 put:(rowTemp at:2).	" A6 "	sensorPA := AlignmentMorph newRow		color:sensorPAArea color;		borderColor: (Color r: (148/255) g: (145/255) b: (145/255));		useRoundedCorners;		inset: 3.	sensorPAArea addMorphBack: sensorPA.		pn := #(A3 A7).	rowTemp := self addPACheckComboBox: sensorPA pinNames: pn.	pinInfo at:18 put:(rowTemp at:1).		" A3 "	pinInfo at:22 put:(rowTemp at:2).	" A7 "! !!PinAssignMorph methodsFor: 'private' stamp: 'KK 5/26/2014 17:44'!updateSensorTitle	"Update my title to reflect the current protocol and port number."	| s |	s := 'Sensor/LED/Buzzer' localized.	s = sensorTitleMorph contents ifFalse: [sensorTitleMorph contents: s].! !!PinAssignMorph methodsFor: 'private' stamp: 'KK 5/26/2014 17:33'!updateServoTitle	"Update my title to reflect the current protocol and port number."	| s |	s := 'Servomotor' localized.	s = servoTitleMorph contents ifFalse: [servoTitleMorph contents: s].! !!PinAssignMorph methodsFor: 'dropping/grabbing' stamp: 'SeijiKagayama 8/18/2017 21:17'!justDroppedInto: newOwner event: evt	self world addMorph: self! !!ScratchBlockPaletteMorph methodsFor: 'initialization' stamp: 'KK 9/20/2013 17:28'!initialize	super initialize.	borderWidth _ 0.! !!ScratchBlockPaletteMorph methodsFor: 'other' stamp: 'KK 9/20/2013 17:25'!fixLayout	"Right align the blocks in the palette if RTL is set to true. The watcher toggle checkbox buttons are assumed to be about 18 pixels wide."	| offset r |	owner ifNil: [^ self].	ScratchTranslator isRTL ifTrue:[		self submorphs do: [:m |			(m isKindOf: BlockMorph) ifTrue: [				m canBecomeWatcher					ifTrue: [m position: (self right - m width - 18 - 10)@(m position y)]					ifFalse: [m position: (self right - m width - 10)@(m position y)].				m changed].			((m isKindOf: ToggleButton) or: [m isKindOf: ResizableToggleButton2]) ifTrue:[	"watcher checkbox case"				m position: (self right - m width - 10)@(m position y)].			(m isKindOf: ImageMorph) ifTrue: [				m position: (self right - m width - 10)@(m position y)]]].	offset _ self topLeft negated.	r _ 0@0 extent: 1@1.	self submorphsDo: [:m |		r _ r quickMerge: (m fullBounds translateBy: offset) truncated].	self width: (r width max: owner width).! !!ScratchBlockPaletteMorph methodsFor: 'other' stamp: 'KK 7/31/2017 19:06'!updateWatcherButtonsForFrame: frame	"Update the watcher button on this palette."	| reporter sprite selAndArg |	frame ifNil: [^ self].	submorphs do: [:b |		((b isKindOf: ToggleButton) and:		 [b target isKindOf: ReporterBlockMorph]) ifTrue: [			reporter _ b target.			sprite _ reporter getAssociatedSprite.			selAndArg _ reporter selectorAndArg.			(frame watcherShowingFor: sprite selectorAndArg: selAndArg)				ifTrue: [b on; setProperty: #balloonText toValue: 'Remove viewer from stage' localized]				ifFalse: [b off; setProperty: #balloonText toValue: 'View on stage' localized]]].! !!ScratchCommentMorph methodsFor: 'dropping/grabbing' stamp: 'KK 7/28/2017 15:13'!justDroppedInto: newOwner event: evt	"Handle being dropped into a new situation."	| frame target |	(frame _ newOwner ownerThatIsA: ScratchFrameMorph)		ifNotNil: [frame projectModified].	((self ownerThatIsA: ScratchViewerMorph) notNil) ifTrue: [		"delete myself when dropped in the blocks palette area"		self delete.		^ self].	"comments cannot be dropped onto the stage"	(owner isKindOf: ScratchStageMorph) ifTrue: [		^ self rejectDropEvent: evt].	"okay to drop comments into the world during development"	((owner == World) and: [Preferences noviceMode not]) ifTrue: [^ self].	(owner isKindOf: ScratchScriptsMorph) ifFalse: [		^ self rejectDropEvent: evt].	target _ self attachTargetIn: newOwner.	target ifNotNil: [self anchor: target]! !!ScratchFileChooserDialog methodsFor: 'initialization' stamp: 'KK 10/20/2017 11:41'!addShortcutButtons	"Add shortcut buttons for my type to the shortcutColumn."	| spacer |	spacer _ Morph new extent: 5@5; color: Color transparent.	shortcutColumn removeAllMorphs."	shortcutColumn addMorphBack: (self shortcutButtonLabel: 'Computer' action: #myComp icon: #folderDiscsIcon).	shortcutColumn addMorphBack: spacer fullCopy."	shortcutColumn addMorphBack: (self shortcutButtonLabel: self labelForHomeFolder action: #myHome icon: #folderHouseIcon).	shortcutColumn addMorphBack: spacer fullCopy.	shortcutColumn addMorphBack: (self shortcutButtonLabel: 'Desktop' action: #myDesktop icon: #folderIcon).	shortcutColumn addMorphBack: spacer fullCopy.	#background = self type ifTrue: [		shortcutColumn addMorphBack:			(self shortcutButtonLabel: 'Backgrounds' action: #scratchBackgrounds icon: #folderCatIcon)].	#costume = self type ifTrue: [		shortcutColumn addMorphBack:			(self shortcutButtonLabel: 'Costumes' action: #scratchCostumes icon: #folderCatIcon)].	#project = self type ifTrue: [		shortcutColumn addMorphBack:			(self shortcutButtonLabel: 'Examples' action: #sampleProjects icon: #folderCatIcon).		shortcutColumn addMorphBack: spacer fullCopy.		shortcutColumn addMorphBack:			(self shortcutButtonLabel: 'My Projects' action: #userProjects icon: #folderIcon)].	#sound = self type ifTrue: [		shortcutColumn addMorphBack:			(self shortcutButtonLabel: 'Sounds' action: #scratchSounds icon: #folderCatIcon)].! !!ScratchFileChooserDialog methodsFor: 'initialization' stamp: 'KK 10/20/2017 16:45'!createScratchFileChooserFor: aScratchFrameMorph saving: savingFlag	"Create a Scratch file chooser dialog box with a project thumbnail and info box."	| labelFont contentsFont commentFont thumbnailHolder |	scratchFrame _ aScratchFrameMorph.	readingScratchFile _ savingFlag not.	list _ ScratchFilePicker new extensions: #(scratch sb bpd bpd2 bpdc).	TabletMode ifTrue: [		list extent: 380@220].	self removeAllMorphs.	bottomSpacer delete.	bottomSpacer _ nil.	mainColumn addMorphBack: list.	savingFlag ifFalse: [		self title: 'Open Project'.		list scratchInfoClient: self].	labelFont _ (ScratchFrameMorph getFont: #FileChooserLabel).	contentsFont _ (ScratchFrameMorph getFont: #FileChooserContents).	commentFont _ (ScratchFrameMorph getFont: #FileChooserComment).	savingFlag ifTrue: [		self title: 'Save Project'.		newFileTitle _ StringMorph contents: ('New Filename:' localized, ' ') font: labelFont.		newFileTitle color: (Color gray: 0.3).		newFileName _ StringFieldMorph new			contents: scratchFrame projectName;			client: self;			font: contentsFont;			color: (Color r: (211/255) g: (214/255) b: (216/255));			width: 180.		tabFields add: newFileName.		newTitleBin			addMorphBack: newFileTitle;			addMorphBack: (Morph new extent: (5@5); color: Color transparent);			addMorphBack: newFileName;			addMorphBack: (AlignmentMorph newSpacer: Color transparent).		ScratchTranslator isRTL			ifTrue: [newTitleBin submorphs reversed do: [:m |				m delete.				newTitleBin addMorphBack: m]]].	mainColumn		addMorphBack: (Morph new extent: (5@9); color: Color transparent);		addMorphBack: newTitleBin.	thumbnailHolder _ AlignmentMorph newColumn		centering: #center;		color: Color transparent.	thumbnailFrameMorph _ ImageFrameMorph new		initFromForm: (ScratchFrameMorph skinAt: #dialogThumbnailFrame).	TabletMode ifTrue: [		thumbnailFrameMorph extent: (85@65). ]	ifFalse: [		thumbnailFrameMorph extent: (170@130). ].	thumbnailHolder addMorph: thumbnailFrameMorph.	fileInfoColumn		addMorphBack: thumbnailHolder;		addMorphBack: (Morph new extent: (5@6); color: Color transparent). "spacer"	TabletMode ifTrue: [		thumbnailMorph _ ImageMorph new form: (Form extent: 75@55 depth: 1). ]	ifFalse: [		thumbnailMorph _ ImageMorph new form: (Form extent: 160@120 depth: 1). ].	thumbnailFrameMorph addMorphFront: (thumbnailMorph position: ((thumbnailFrameMorph position) + (5@5))).	authorLabelMorph _ StringMorph contents: 'Project author:' localized font: labelFont.	authorLabelMorph color: (Color gray: 0.3).	fileInfoColumn addMorphBack: authorLabelMorph.	savingFlag		ifTrue: [authorMorph _ StringFieldMorph new			useStringFieldFrame;			contents: '';			font: contentsFont.			tabFields add: authorMorph]		ifFalse: [fileInfoColumn addMorphBack: (Morph new extent: (5@6); color: Color transparent). "spacer"			authorMorph _ StringFieldMorph new				color: Color transparent;				borderWidth: 0;				contents: '';				isEditable: false;				font: contentsFont].	fileInfoColumn		addMorphBack: authorMorph;		addMorphBack: (Morph new extent: (5@6); color: Color transparent). "spacer"	commentLabelMorph _ StringMorph contents: 'About this project:' localized font: labelFont.	commentLabelMorph color: authorLabelMorph color.	fileInfoColumn addMorphBack: commentLabelMorph.	commentMorph _ ScrollingStringMorph new		borderWidth: 0;		contents: '';		font: commentFont;		extent: (210@110).	TabletMode ifTrue: [		commentMorph extent: (210@75).	].	savingFlag		ifTrue: [commentMorph backForm: (ScratchFrameMorph skinAt: #stringFieldFrame).			tabFields add: commentMorph]		ifFalse: [commentMorph isEditable: false].	fileInfoColumn addMorphBack: commentMorph.	fileInfoColumn addMorphBack: buttonRow.	TabletMode ifTrue: [		fileInfoColumn addMorphBack: (Morph new extent: (5@30); color: Color transparent). "spacer"	].	self		addMorphBack: shortcutColumn;		addMorphBack: mainColumn;		addMorphBack: fileInfoColumn.	savingFlag ifTrue: [		self scratchInfo: scratchFrame projectInfo.		thumbnailMorph form: scratchFrame workPane thumbnailForm.		"default author field to login name if known; else author"		(aScratchFrameMorph loginName size > 0)			ifTrue: [authorMorph contents: aScratchFrameMorph loginName]			ifFalse: [authorMorph contents: aScratchFrameMorph author]].! !!ScratchFileChooserDialog methodsFor: 'initialization' stamp: 'sk 2/20/2017 17:47'!getUserResponse	"Wait for the user to respond, then answer the full path name of the chosen file or #cancelled if the user cancels the operation. If opening a remote file for reading, answer a HTTPFetcher on the remote file."	"Details: This is invoked synchronously from the caller. In order to keep processing inputs and updating the screen while waiting for the user to respond, this method has its own version of the World's event loop."	| w |	self openInWorld.	w _ self world.	w activeHand newKeyboardFocus: (tabFields at: 1).	TabletMode ifTrue: [		self topCenterOnScreen]	ifFalse: [		self centerOnScreen].	newFileName ifNotNil: [w activeHand newKeyboardFocus: newFileName].	list getDirectoryContents.	response _ #cancelled.  "default response"	done _ false.	[done or: [list isFinalSelection]] whileFalse: [w doOneCycle].	self delete.	w doOneCycle.  "erase myself from the screen"	((response = #cancelled) and: [list isFinalSelection not]) ifTrue: [^ #cancelled].	list selectedFile ifNil: [^ #cancelled].	(thumbnailMorph notNil & readingScratchFile not) ifTrue: [  "save info in project"		scratchFrame author: authorMorph contents withBlanksTrimmed.		scratchFrame projectComment: commentMorph contents].	(list currentDirectory isKindOf: ScratchServerDirectory)		ifTrue: [^ list projectFetcher]		ifFalse: [^ list currentDirectory fullNameFor: list selectedFile].! !!ScratchFileChooserDialog methodsFor: 'initialization' stamp: 'KK 7/24/2017 12:19'!initialize	"Create the file chooser dialog box"	super initialize.	choosingFolder _ false.	scratchFrame _ nil.	readingScratchFile _ false.	fCursorOut _ true.	newTitleBin _ AlignmentMorph newRow		centering: #center;		color: Color transparent.	buttonRow hResizing: #spaceFill."	TabletMode ifTrue: [		mainColumn orientation: #horizontal.		newTitleBin orientation: #vertical]."	self withButtonsForYes: false no: false okay: true cancel: true.! !!ScratchFileChooserDialog methodsFor: 'accessing' stamp: 'KK 7/24/2017 13:05'!createFileChooserLayout: allowNewFile	"Create the file chooser dialog box."	list _ ScratchFilePicker new.	self removeAllMorphs.	bottomSpacer delete.	bottomSpacer _ nil.	mainColumn addMorphBack: list.	self title: 'Open'.	allowNewFile ifTrue: [		self title: 'Save As'.		newFileTitle _ StringMorph new			contents: 'New Filename:' localized, ' ';			color: (Color gray: 0.3);			font: (ScratchFrameMorph getFont: #FileChooserNewFileTitle).		newFileName _ StringFieldMorph new			font: (ScratchFrameMorph getFont: #FileChooserNewFilename);			color: (Color r: (211/255) g: (214/255) b: (216/255));			width: 180.		newTitleBin			addMorphBack: newFileTitle;			addMorphBack: (Morph new extent: (5@5); color: Color transparent);			addMorphBack: newFileName;			addMorphBack: (AlignmentMorph newSpacer: Color transparent).			ScratchTranslator isRTL		ifTrue: [newTitleBin submorphs reversed do: [:m |			m delete.			newTitleBin addMorphBack: m]]].		mainColumn			addMorphBack: newTitleBin;			addMorphBack: buttonRow.	self		addMorphBack: shortcutColumn;		addMorphBack: mainColumn;		addMorphBack: fileInfoColumn.! !!ScratchFileChooserDialog methodsFor: 'interaction' stamp: 'sk 2/20/2017 17:49'!getUserResponseForNewFile	"Wait for the user to respond, then answer the full path name of the new file or #cancelled if the user cancels the operation."	"Details: This is invoked synchronously from the caller. In order to keep processing inputs and updating the screen while waiting for the user to respond, this method has its own version of the World's event loop."	| w fn |	self openInWorld.	w _ self world.	w activeHand newKeyboardFocus: (tabFields at: 1).	self extent: self extent.  "force layout"	TabletMode ifTrue: [		self position: ((w width // 2) - (self width // 2)@5)]	ifFalse: [		self position: w center - (self extent // 2) + (0@5)].    "center on screen but disregard the shadow on the bottom"	newFileName ifNotNil: [w activeHand newKeyboardFocus: newFileName].	list getDirectoryContents.	[true] whileTrue: [		done _ false.		[done] whileFalse: [w doOneCycle].		response = #cancelled ifTrue: [^ #cancelled].		thumbnailMorph ifNotNil: [  "save info in project"			scratchFrame author: authorMorph contents withBlanksTrimmed.			scratchFrame projectComment: commentMorph contents].		fn _ newFileName contents withBlanksTrimmed.		fn size > 0 ifTrue: [			fn _ fn collect: [:ch | ('\/:' includes: ch) ifTrue: [$-] ifFalse: [ch]].  "replace directory delimiters with dashes"			^ list currentDirectory pathName, FileDirectory pathNameDelimiter asString, fn].		newFileTitle color: Color red.		self openInWorld.		w activeHand newKeyboardFocus: newFileName].! !!ScratchFileChooserDialog methodsFor: 'other' stamp: 'KK 8/17/2017 16:43'!scratchInfo: infoDict	"Update the Scratch project thumbnail and info display."	| s f thumbForm |	infoDict ifNil: [  "clear thumbnail and info"		thumbnailMorph form: (Form extent: thumbnailMorph extent depth: 1) fillWhite.		authorMorph contents: ''.		commentMorph contents: ''.		^ self].	((infoDict includesKey: 'thumbnail') and: [thumbnailMorph notNil])		ifTrue: ["			thumbnailMorph form: (infoDict at: 'thumbnail')"			" I resize thumbnail from 160@120 to 77@55 "			f _ infoDict at: 'thumbnail'.			thumbForm _ Form extent: (77@55) depth: 32.			(WarpBlt toForm: thumbForm)				sourceForm: f;				cellSize: 2;				combinationRule: Form over;				copyQuad: (0@0 extent: f extent) innerCorners toRect: thumbForm boundingBox.			thumbForm _ thumbForm colorReduced.  "first try to make a ColorForm with exact colors"			thumbnailMorph form: thumbForm.		]		ifFalse: [thumbnailMorph form: (Form extent: thumbnailMorph extent depth: 1) fillBlack].	authorMorph contents: ''.	((infoDict includesKey: 'author') and: [authorMorph notNil]) ifTrue: [		authorMorph contents: (infoDict at: 'author')].	s _ ''.	readingScratchFile		ifTrue: [			(infoDict includesKey: 'comment') ifTrue: [s _ infoDict at: 'comment']]		ifFalse: [			s _ scratchFrame projectCommentOrTemplate].	commentMorph contents: s; changed.! !!ScratchFileChooserDialog methodsFor: 'geometry' stamp: 'sk 3/16/2017 14:40'!extent: aPoint	super extent: aPoint.	mainColumn ifNotNil: [		mainColumn submorphs do: [:elm |			elm class = ScratchFilePicker ifTrue: [				elm height: ((elm height) - 22)]]].! !!ScratchFileChooserDialog methodsFor: 'stepping and presenter' stamp: 'sk 4/24/2017 09:51'!step	| current |	newFileName ifNil: [^ self].	current _ World activeHand keyboardFocus.	(current isKindOf: StringFieldMorph) ifTrue: [		]	ifFalse: [		fCursorOut ifTrue: [			World activeHand firstClickEvent ifNotNil: [				self cancelled]]].! !!ScratchFileChooserDialog methodsFor: 'stepping and presenter' stamp: 'sk 1/23/2017 23:41'!stepTime	^ 200! !!ScratchFileChooserDialog methodsFor: 'event handling' stamp: 'sk 4/21/2017 12:35'!handlesMouseOver: evt	^ true! !!ScratchFileChooserDialog methodsFor: 'event handling' stamp: 'sk 4/24/2017 09:50'!mouseEnter: evt	"Handle a mouse down event. This default implementation does nothing."	fCursorOut _ false.! !!ScratchFileChooserDialog methodsFor: 'event handling' stamp: 'sk 4/24/2017 09:50'!mouseLeave: evt	"Handle a mouse down event. This default implementation does nothing."	fCursorOut _ true.! !!ScratchFileChooserDialog class methodsFor: 'instance creation' stamp: 'sk 3/16/2017 14:50'!chooseExistingFileType: type extensions: anArrayOrNil title: titleString	| m |	ScratchFileChooserDialog deleteDuplicates.	m _ self new		createFileChooserLayout: false;		type: type;		extensions: anArrayOrNil;		title: titleString.	TabletMode ifTrue: [		m listExtent: 380@220].	^ m getUserResponse! !!ScratchFileChooserDialog class methodsFor: 'instance creation' stamp: 'KK 7/31/2017 13:15'!chooseImageFileType: type title: aString	"ScratchFileChooserDialog chooseImageFileType: #costume title: 'Costume'"	| m |	ScratchFileChooserDialog deleteDuplicates.	m _ self new		createFileChooserLayout: false;		showThumbnails: true;		type: type;		extensions: #(gif jpeg jpg bmp png);		title: aString;		listExtent: 550@300.	"allow sprites to be imported into the paint editor:"	aString = 'Import Image'		ifTrue: [m extensions: #(gif jpeg jpg bmp png sprite studuinosprite)]		ifFalse: [m extensions: #(gif jpeg jpg bmp png sprite studuinosprite)].	^ m getUserResponse! !!ScratchFileChooserDialog class methodsFor: 'instance creation' stamp: 'sk 3/16/2017 14:49'!chooseNewFileDefault: defaultName title: titleString type: type	| m |	ScratchFileChooserDialog deleteDuplicates.	m _ self new		createFileChooserLayout: true;		type: type;		defaultName: defaultName;		title: titleString.	TabletMode ifTrue: [		m listExtent: 380@220]	ifFalse: [		m listExtent: 400@280].	^ m getUserResponseForNewFile! !!ScratchFileChooserDialog class methodsFor: 'instance creation' stamp: 'KK 7/31/2017 11:34'!chooseSpriteCostumeFor: aScratchFrameMorph	"ScratchFileChooserDialog chooseSpriteCostumeFor: nil"	| m |	ScratchFileChooserDialog deleteDuplicates.	m _ self new		createFileChooserLayout: false;		title: 'New Sprite';		showThumbnails: true;		type: #costume;		extensions: #(gif jpeg jpg bmp png sprite studuinosprite);		scratchFrame: aScratchFrameMorph;		listExtent: 550@300.	^ m getUserResponse! !!ScratchFileChooserDialog class methodsFor: 'instance creation' stamp: 'KK 10/20/2017 16:36'!saveScratchFileFor: aScratchFrameMorph	"Choose a file for saving the current Scratch project file. Display the thumbnail and info string for the current project and allow the info string to be edited. Answer the full name of the file in which to save the project or #cancelled if the operation is cancelled."	"ScratchFileChooserDialog saveScratchFileFor: nil"	| m result |	ScratchFileChooserDialog deleteDuplicates.	m _ self new		createScratchFileChooserFor: aScratchFrameMorph saving: true;		type: #project;		redirectSavesToSampleFolder.	result _ m getUserResponseForNewFile.	result = #cancelled ifTrue: [^ result].	(result asLowercase endsWith: '.bpdc') ifFalse: [result _ result, '.bpdc'].	^ result! !!ScratchFileChooserDialog class methodsFor: 'accessing' stamp: 'KK 7/31/2017 13:07'!getDefaultFolderForType: type	| mediaDir |	(type = #project) ifTrue: [^ self userScratchProjectsDir].	(FileDirectory default directoryExists: 'Media') ifTrue: [		mediaDir _ FileDirectory default directoryNamed: 'Media'.		#background = type ifTrue: [			(mediaDir directoryExists: 'Backgrounds') ifTrue: [				^ mediaDir directoryNamed: 'Backgrounds']].		(#(costume sprite studuinosprite) includes: type) ifTrue: [			(mediaDir directoryExists: 'Costumes') ifTrue: [				^ mediaDir directoryNamed: 'Costumes']].		#sound = type ifTrue: [			(mediaDir directoryExists: 'Sounds') ifTrue: [				^ mediaDir directoryNamed: 'Sounds']]].	^ self homeDir! !!ScratchFileChooserDialog class methodsFor: 'utilities' stamp: 'KK 10/20/2017 16:37'!confirmFileOverwriteIfExisting: aFilename	"If the given file exists, ask the user if they want to overwrite it or pick a different file name."	| response fName |	fName _ aFilename.	(fName endsWith: '.bpdc') ifFalse: [fName _ fName, '.bpdc'].	(FileDirectory default fileExists: fName) ifFalse: [^ aFilename].	response _ DialogBoxMorph		askWithCancel: 'The file name already exists. Overwrite existing file?'.	response = #cancelled ifTrue: [^ #cancelled].	response ifTrue: [^ fName] ifFalse: [^ false].! !!ScratchFilePicker methodsFor: 'private' stamp: 'KK 8/3/2017 15:44'!checkForScratchInfoFetchDone	"Try to retrieve info for the currently selected Scratch project and, if successful, report it to our client."	"Details: The fetcher is allowed to keep running even after the info dictionary is retrieved. Thus if the user decides to open this project, we'll have a head start on fetching it."	| data s version infoSize infoDict |	scratchProjectFetcher ifNil: [^ self].	data _ scratchProjectFetcher bodyData.	data size >= 14 ifTrue: [		s _ ReadStream on: data.		version _ ObjStream scratchFileVersionFrom: (s next: 10) asString.		(version = 1) | (version = 2)			ifTrue: [				infoSize _ s uint32.				infoSize <= (s size - s position) ifTrue: [					infoDict _ [ObjStream new readObjFrom: s] ifError: [Dictionary new].					scratchInfoClient scratchInfo: infoDict]]			ifFalse: [				scratchInfoClient scratchInfo: Dictionary new]].! !!ScratchFilePicker methodsFor: 'private' stamp: 'KK 9/1/2014 11:57'!newDirectory	"Create a new directory."	| name |	ValueOrList _ false.	name _ StringDialog askWithCancel: 'New folder name:'.	name = '' ifTrue: [^ self].	[self currentDirectory createDirectory: name] ifError: [:err :rcvr |		^ DialogBoxMorph warn: 'Could not create folder.'].	self currentDirectory: self currentDirectory.! !!ScratchFilePicker methodsFor: 'private' stamp: 'KK 8/3/2017 16:56'!reportScratchProjectInfo	"Try to retrieve info for the currently selected Scratch project and, if successful, report it to our client."	| fullPath |	scratchInfoClient ifNil: [^ self].	scratchProjectFetcher ifNotNil: [		scratchProjectFetcher stopDownload.		scratchProjectFetcher _ nil].	self selectedFile ifNil: [scratchInfoClient scratchInfo: nil. ^ self].	(currentDir isKindOf: FileDirectory) ifTrue: [		^ scratchInfoClient scratchInfo: self getScratchInfoFromFile].	"directory is on a server: start a fetcher to get the project info"	fullPath _ currentDir path, self selectedFile, '.scratch'.	scratchProjectFetcher ifNil: [scratchProjectFetcher _ HTTPFetcher new].	((scratchProjectFetcher serverName ~= currentDir serverName) |	 (scratchProjectFetcher path ~= fullPath)) ifTrue: [		"start fetching from the new path"		scratchProjectFetcher			startDownload: fullPath 			fromServer: currentDir serverName].	Delay waitMSecs: 50.	self checkForScratchInfoFetchDone.! !!ScratchFrameMorph methodsFor: 'intialization' stamp: 'sk 3/17/2017 18:34'!addShortcutButtonsTo: rowMorph	| buttonSpecs b |	buttonSpecs _ #(		"name		tool tip				selector"		(language	'Set language'		languageMenu:)		(save		'Save this project'	saveScratchProjectNoDialog)	).	buttonSpecs do: [:spec |		b _ ToggleButton			onForm: ((ScratchFrameMorph skinAt: (spec at: 1), 'ButtonOver') magnifyBy: FontMagnification)			offForm: ((ScratchFrameMorph skinAt: (spec at: 1), 'Button') magnifyBy: FontMagnification)			overForm: ((ScratchFrameMorph skinAt: (spec at: 1), 'ButtonOver') magnifyBy: FontMagnification).		b			target: self;			actionSelector: (spec at: 3);			setBalloonText: (spec at: 2) localized;			actWhen: #buttonUp;			isMomentary: true.				('language' = (spec at: 1)) ifTrue: [  "language special case"			b arguments: (Array with: b)].		('save' = (spec at: 1)) ifTrue: [  "spacer"			rowMorph addMorphBack: (Morph new extent: (10@5); color: Color transparent)].		rowMorph addMorphBack: b].	rowMorph addMorphBack: (Morph new extent: (20@5); color: Color transparent).! !!ScratchFrameMorph methodsFor: 'intialization' stamp: 'ee 1/27/2009 16:44'!createBasicPanes	"Create and add my palette (viewer), script editor, stage, and library panes."	topPane _ ImageFrameMorph new initFromForm: (ScratchFrameMorph skinAt: 'topPane').	viewerPane _ ScratchViewerMorph new rebuildCategorySelectors.		scriptsPane _ ScratchScriptEditorMorph new.	stageFrame _ ImageFrameMorph new initFromForm: (ScratchFrameMorph skinAt: 'stagePane').	titlePane _ ImageFrameMorph new initFromForm: (ScratchFrameMorph skinAt: 'titlePane').	workPane _ ScratchStageMorph new extent: WorkpaneExtent.	libraryPane _ ScratchLibraryMorph new.	"make panes sticky so clicking on them doesn't pick up entire frame"	self		addMorph: (topPane isSticky: true);		addMorph: (viewerPane isSticky: true);		addMorph: (scriptsPane isSticky: true);		addMorph: (stageFrame isSticky: true);		addMorph: (workPane isSticky: true);		addMorph: (titlePane isSticky: true);		addMorph: (libraryPane isSticky: true).	self createReadoutPane.	workPane comeToFront.! !!ScratchFrameMorph methodsFor: 'intialization' stamp: 'KK 8/3/2017 11:00'!createFontSizeButton	| bt |	fontButtons _ AlignmentMorph new			color: (Color transparent);			centering: #bottomRight.	#(1.0 1.5 2.0) do: [:fSize |		bt _ SimpleButtonMorph new			color: (Color gray);			borderColor: (Color white);			target: self;			actionSelector: #setFontMagnification:;			arguments: {fSize};			label: 'aA' font: (StrikeFont fontName: #Verdana size: fSize * 10);			extent: (fSize * 10 + 17)@(fSize * 10 + 17).		fontButtons addMorphBack: bt.		fontButtons addMorphBack: (Morph new extent: 5@0)].	fontButtons position: (topPane topRight).	self addMorph: fontButtons.! !!ScratchFrameMorph methodsFor: 'intialization' stamp: 'sk 6/15/2016 11:40'!createLogo	"Create and the Scratch logo."	logoMorph _ SketchMorph withForm: (ScratchFrameMorph skinAt: #studuinoLogo).	logoMorph position: topPane position + (12@8).	topPane addMorph: logoMorph.! !!ScratchFrameMorph methodsFor: 'intialization' stamp: 'KK 2/7/2018 13:26'!createMenuPanel	"Create and add a panel containing the menus and close button."	| menuSpecs m code |	"create panel"	menuPanel _ AlignmentMorph new		color: Color transparent;		centering: #center;		inset: 0;		height: 0.	"will grow as needed"	self addShortcutButtonsTo: menuPanel.	"menuSpecs defines the menus"	code _ ScratchTranslator currentLanguage.	(code = 'en') | (code = 'ja') | (code = 'ja_HIRA') ifTrue:[		menuSpecs _ #(			"name			selector"			(File			fileMenu:)			(Edit			editMenu:)			(Run			runMenu:)"			(Setting			settingMenu:)"			(Help			helpMenu:)		)]	ifFalse: [		menuSpecs _ #(			"name			selector"			(File			fileMenu:)			(Edit			editMenu:)			(Run			runMenu:)			(Help			helpMenu:)		)].	" Check motor calibration mode "	workPane motorCalibrationBoard owner	ifNil: [		ScratchMenuTitleMorph setMenuEnable: true.	].	menuSpecs do: [:spec |		m _ ScratchMenuTitleMorph new			contents: (spec at: 1) localized;			target: self selector: (spec at: 2).		menuPanel addMorphBack: m.		#helpMenu: = (spec at: 2) ifFalse: [			menuPanel addMorphBack: (Morph new color: Color transparent; extent: 12@5)]].	topPane addMorph: menuPanel.! !!ScratchFrameMorph methodsFor: 'intialization' stamp: 'KK 7/4/2017 14:04'!createToolbar	"Create and add the toolbar."	| buttonSpecs bName button |	toolbarPanel _ AlignmentMorph new		hResizing: #shrinkWrap;		vResizing: #shrinkWrap;		color: Color transparent.			buttonSpecs _ #(		"name			selector"			"tooltip"		(copy			copyTool		'Duplicate')		(delete			cutTool			'Delete')		(zoomIn 		zoomInTool		'Grow sprite')		(zoomOut 		zoomOutTool		'Shrink sprite')	).	buttonSpecs do: [:spec |		bName _ spec at: 1.		button _ ToggleButton			onForm: (ScratchFrameMorph skinAt: (bName, 'ButtonPressed') asSymbol)			offForm: (ScratchFrameMorph skinAt: (bName, 'Button') asSymbol)			overForm: (ScratchFrameMorph skinAt: (bName, 'ButtonOver') asSymbol).		button			target: self;			actionSelector: (spec at: 2);			isMomentary: true;			setProperty: #balloonText toValue: (spec at: 3) localized.		toolbarPanel addMorphBack: button].	self addMorph: toolbarPanel.! !!ScratchFrameMorph methodsFor: 'intialization' stamp: 'KK 11/14/2017 17:03'!createUSBCSPanel	" Create USB Connection Status Panel. "	| on off |	usbCSPanel _ AlignmentMorph new			color: (Color transparent);			centering: #center;			vResizing: #shrinkWrap.				usbCSPanel borderWidth: 1.	usbCSPanel borderColor: Color white.	on _ ScratchFrameMorph skinAt: #connect8 ifAbsent: [^ self].	off _ ScratchFrameMorph skinAt: #disconnect8 ifAbsent: [^ self].	usbCSPanel addMorphBack: (Morph new extent: 5@0).	usbCSPanel addMorphBack: (ToggleImage new		onForm: on offForm: off;		off	).	usbCSPanel addMorphBack: (Morph new extent: 5@0).	usbCSPanel addMorphBack: (StringMorph new contents: ('Disconnect' localized)).	usbCSPanel addMorphBack: (Morph new extent: 5@0).	usbCSPanel position: (topPane topRight).	self addMorph: usbCSPanel.! !!ScratchFrameMorph methodsFor: 'intialization' stamp: 'KK 7/4/2017 13:09'!createViewModeButtonsPanel	| specs bName button |	viewModeButtonsPanel _ AlignmentMorph newRow		hResizing: #shrinkWrap;		vResizing: #shrinkWrap;		color: Color transparent.	viewModeButtons _ OrderedCollection new.	specs _ OrderedCollection new.	specs add: #(quarter			enterQuarterMode		'Switch to small stage').	specs add: #(normal			enterNormalMode		'Switch to full stage').	specs add: #(presentation	enterPresentationMode	'Switch to presentation mode').	specs do: [:spec |		bName _ spec first.		button _ ToggleButton new			onForm: (ScratchFrameMorph skinAt: bName, 'ViewModeOn')			offForm: (ScratchFrameMorph skinAt: bName, 'ViewMode')			overForm: (ScratchFrameMorph skinAt: bName, 'ViewModeOver').		button			target: self;			actionSelector: (spec at: 2);			alphaOn: true;			setProperty: #balloonText toValue: (spec at: 3) localized.		viewModeButtonsPanel			addMorphBack: button;			addMorphBack: (Morph new extent: 1@5; color: Color transparent).		viewModeButtons add: button].	self addMorph: viewModeButtonsPanel.! !!ScratchFrameMorph methodsFor: 'intialization' stamp: 'KK 12/4/2017 16:36'!initialize	super initialize.	fillScreenFlag _ false.	paintingInProgress _ false.	projectInfo _ Dictionary new.	watcherPositions _ Dictionary new.	justSaved _ false.	author _ ''.	loginName _ ''.	loginPassword _ ''.	viewMode _ #normal.	usbConnectionStatus _ false.	self createBasicPanes.	self createLogo.	self createMenuPanel.	self createUSBCSPanel.	self createFontSizeButton.	self createViewModeButtonsPanel.	self createStageButtonsPanel.	self createToolbar.	self extent: 1000@600.	paBoard _ PinAssignMorph new.! !!ScratchFrameMorph methodsFor: 'intialization' stamp: 'KK 11/14/2017 16:19'!usbConnectionDetector	| handle line |	"Socket remoteTestServerTCP"	handle _ self createUSBConnectionDetectorHandle.	handle ifNil: [^ self].	Transcript show: '---------- Recving ----------'; cr.	[1 > 0] whileTrue: [		line _ self waitForBMResponse: handle.		Transcript show: line; cr.		(line = 'USBCON') ifTrue: [			self setUSBConnectionStatus: true.		].		(line = 'USBDISCON') ifTrue: [			self setUSBConnectionStatus: false.		].		(line = 'NETDISCON') ifTrue: [			self setUSBConnectionStatus: false.			ScratchFrameMorph displayMessageDialog: '12'." Display error message dialog "			^ self.		].	].! !!ScratchFrameMorph methodsFor: 'accessing' stamp: 'KK 12/11/2014 11:41'!importScripts: fileNameOrData	"Read the sprite or project file and merge into the current project."	| data f importedStage defaultForm defaultSound oldName oldPosition sub register |	data _ fileNameOrData.	(data isKindOf: String) ifTrue: [  "read the contents of a local file"		(FileDirectory default fileExists: fileNameOrData) ifFalse: [^ self].		f _ (FileStream readOnlyFileNamed: fileNameOrData) binary.		f ifNil: [^ self].		data _ f contentsOfEntireFile].	[importedStage _ self extractScriptFrom: data] ifError: [^ self].	"fix references to old stage"	importedStage allMorphsDo: [:m |		(m isKindOf: WatcherMorph) ifTrue: [m mapReceiver: importedStage to: workPane].		(m isKindOf: ScriptableScratchMorph) ifTrue: [			m blocksBin submorphs do: [:stack |				(stack isKindOf: BlockMorph) ifTrue: [					stack blockSequence do: [:b | 						" In the case of control start block "						(b isMemberOf: EventHatMorph) ifTrue: [							(b eventName = 'Scratch-StartClicked') ifTrue: [								" Change to the function call block "								sub _ b submorphs.								b initialize.								b eventName:'localScriptStart'.								(sub first isMemberOf: StringMorph) ifFalse: [									b addMorph: sub first.								].							].						].						b mapReceiver: importedStage to: workPane]]]]].	"add global variables from importated stage to my stage"	importedStage varNames do: [:v |		workPane addVariable: v value: (importedStage getVar: v)].	"add imported stage scripts"	importedStage blocksBin submorphs do: [:stack |		" I do not register if the imported script's Control-Start Hat does not have any blocks. "		register _ true.		(stack isMemberOf: EventHatMorph) ifTrue: [			(stack eventName = 'localScriptStart') ifTrue: [				sub _ stack submorphs.				(sub first isMemberOf: EventTitleMorph) ifTrue: [					register _ false.				].			].		].		register ifTrue: [			(stack isKindOf: BlockMorph) ifTrue: [				workPane addStack: stack fullCopy.			].		].	].	"add imported background costumes and scripts to my stage, filtering out default items"	defaultForm _ workPane defaultImageMedia form hibernate.	defaultSound _ SoundMedia new sound.	importedStage media do: [:media |		(media isImage and: [media form hibernate bits ~= defaultForm bits])			ifTrue: [workPane addMediaItem: media].		(media isSound and: [media sound samples ~= defaultSound samples])			ifTrue: [workPane addMediaItem: media]].	importedStage submorphs do: [:m |		(m isKindOf: ScratchSpriteMorph) ifTrue: [			oldName _ m objName.			oldPosition _ m position - m owner position + (47@55).  "jm: I am not sure why this offset is needed. It's the rotation center of the default costume..."			self addAndView: m.  "assigns a new name"			m objName: oldName.			m position: workPane topLeft + oldPosition]].	workPane layoutChanged.! !!ScratchFrameMorph methodsFor: 'accessing' stamp: 'KK 11/16/2017 10:20'!importSpriteOrProject: fileNameOrData	"Read the sprite or project file and merge into the current project."	| data f importedStage defaultForm defaultSound oldName oldPosition |	data _ fileNameOrData.	(data isKindOf: String) ifTrue: [  "read the contents of a local file"		(FileDirectory default fileExists: fileNameOrData) ifFalse: [^ self].		f _ (FileStream readOnlyFileNamed: fileNameOrData) binary.		f ifNil: [^ self].		data _ f contentsOfEntireFile].	(fileNameOrData endsWith: '.bpd') ifTrue: [		[importedStage _ self extractScriptFrom: data] ifError: [:err :rcvr |			err = 'unsupported0' ifTrue: [				err _ 'Project created by Studuino mini'.				^ self inform: 'Could not load project. Project created for Studuino mini.' withDetails: ''].			err = 'Different board type' ifTrue: [				^ self inform: 'Could not load project. Project created using Optional Parts from Studuino 2.0.' withDetails: ''].			 ^ self inform: 'Could not read project; file may be damaged' withDetails: '(', err, ')'		].	] ifFalse: [		[importedStage _ self extractProjectFrom: data] ifError: [^ self].	].	"fix references to old stage"	importedStage allMorphsDo: [:m |		(m isKindOf: WatcherMorph) ifTrue: [m mapReceiver: importedStage to: workPane].		(m isKindOf: ScriptableScratchMorph) ifTrue: [			m blocksBin submorphs do: [:stack |				(stack isKindOf: BlockMorph) ifTrue: [					stack blockSequence do: [:b | b mapReceiver: importedStage to: workPane]]]]].	"add global variables from importated stage to my stage"	importedStage varNames do: [:v |		workPane addVariable: v value: (importedStage getVar: v)].	"add global lists from importated stage to my stage"	importedStage listVarNames do: [:v |		workPane ensureListExists: v asString].	"add imported stage scripts"	"When .bpd data is imported, I change the morph add stack. From Stage to Studuino Sprite."	(fileNameOrData endsWith: '.bpd') ifTrue: [		importedStage blocksBin submorphs do: [:stack |			(stack isKindOf: BlockMorph) ifTrue: [workPane arduinoSprites first addStack: stack fullCopy]].	] ifFalse: [		importedStage blocksBin submorphs do: [:stack |			(stack isKindOf: BlockMorph) ifTrue: [					workPane addStack: stack fullCopy			]].	].	"add imported background costumes and scripts to my stage, filtering out default items"	defaultForm _ workPane defaultImageMedia form hibernate.	defaultSound _ SoundMedia new sound.	importedStage media do: [:media |		(media isImage and: [media form hibernate bits ~= defaultForm bits])			ifTrue: [workPane addMediaItem: media].		(media isSound and: [media sound samples ~= defaultSound samples])			ifTrue: [workPane addMediaItem: media]].	importedStage submorphs do: [:m |		" If m is ArduinoScratchSpriteMorph then read block in existed Studuino Sprite. "		(m isMemberOf: ArduinoScratchSpriteMorph) ifTrue: [			m blocksBin submorphs do: [:stack |				workPane arduinoSprites first addStack: stack fullCopy.			].		] ifFalse: [		(m isKindOf: ScratchSpriteMorph) ifTrue: [			oldName _ m objName.			oldPosition _ m position - m owner position + (47@55).  "jm: I am not sure why this offset is needed. It's the rotation center of the default costume..."			self addAndView: m.  "assigns a new name"			m objName: oldName.			m position: workPane topLeft + oldPosition]]].	workPane layoutChanged.! !!ScratchFrameMorph methodsFor: 'menu/button actions' stamp: 'KK 8/20/2014 13:14'!aboutScratch	| dialogBox |	dialogBox _ DialogBoxMorph new		title: 'About Block Programming Environment';		withButtonsForYes: false no: false okay: true cancel: false.	dialogBox		message: 'Based on Scratch from the MIT Media Lab, v', Version, 'Copyright  2014 Artec co., Ltd.All rights reserved.Developed by Artec co., Ltd. with the help of open source software.http://www.artec-kk.co.jp/en/'		font: (ScratchFrameMorph getFont: #AboutScratch).	dialogBox getUserResponse.! !!ScratchFrameMorph methodsFor: 'menu/button actions' stamp: 'KK 8/4/2017 17:09'!addArduinoSensorBoardMorphFor: anArduinoSprite 	| response |	self world ifNotNil: [		self world activeHand toolType: nil].	self paintingInProgress ifTrue: [		^ self beep].	response := self openConnectionChooserDialogFor: anArduinoSprite.	self addArduinoSprite: anArduinoSprite.	response = 'new'		ifTrue: ["			workPane addArduinoBoardFor: anArduinoSprite"]		ifFalse: [			self attachArduinoSprite: anArduinoSprite with: response].! !!ScratchFrameMorph methodsFor: 'menu/button actions' stamp: 'KK 7/12/2017 10:19'!addServerCommandsTo: menu	"Add Scratch server commands to the given menu."	| disable endCmd |	disable _ false.  "make this true to disable this feature"	disable ifTrue: [^ self].	menu addLine.	(workPane scratchServer notNil and:	 [workPane scratchServer sessionInProgress])		ifTrue: [			menu add: 'Show IP Address' action: #showNetworkAddress.			endCmd _ workPane scratchServer isHosting				ifTrue: ['Stop Hosting Mesh']				ifFalse: ['Leave Mesh'].			menu add: endCmd action: #exitScratchSession]		ifFalse: [			menu add: 'Host Mesh' action: #startHostingScratchSession.			menu add: 'Join Mesh' action: #joinScratchSession].! !!ScratchFrameMorph methodsFor: 'menu/button actions' stamp: 'KK 7/31/2017 11:53'!addSpriteMorph	| result f m el |	self world activeHand toolType: nil.	self paintingInProgress ifTrue: [^ self beep].	result _ ScratchFileChooserDialog chooseSpriteCostumeFor: self.	result = #cancelled ifTrue: [^ self].	((result asLowercase endsWith: '.sprite') | (result asLowercase endsWith: '.studuinosprite'))		ifTrue: [^ self importSpriteOrProject: result].	[f _ Form fromFileNamed: result] ifError: [^ self].	el _ ImageMedia new form: (ScratchFrameMorph scaledFormForPaintEditor: f).	m _ ScratchSpriteMorph new soleCostume: el.	el mediaName: (m unusedMediaNameFromBaseName: (FileDirectory localNameFor: result)).	self addAndView: m.! !!ScratchFrameMorph methodsFor: 'menu/button actions' stamp: 'KK 2/7/2018 10:24'!calibrateMotor"[""	ScratchMenuTitleMorph setMenuEnable: false."	(BoardType = 0) ifTrue: [		self shiftToCalibrationMode].	(BoardType = 1) ifTrue: [		self shiftToCalibrationModeMini].	(BoardType = 2) ifTrue: [		self shiftToCalibrationModeMini]."	ScratchMenuTitleMorph setMenuEnable: true.""] fork."! !!ScratchFrameMorph methodsFor: 'menu/button actions' stamp: 'sk 8/9/2016 16:33'!calibrateSvMotor| notification |[	 | s line |	ScratchMenuTitleMorph setMenuEnable: false.	" Communicate with Board Manager "	s _ self createBMHandle.	s ifNil: [^ self].	" Success in connection "	" -------------------------------------------------------------------- "	" Send message "	" -------------------------------------------------------------------- "	Transcript show: '---------- Sending BM ----------'; cr.	s sendCommand: 'CALIB'.	" -------------------------------------------------------------------- "	" Display Status DialogBox "	" -------------------------------------------------------------------- "	" Shifting ot calibration mode "	notification _ NotificationMessage show: 16r12.	" Wait for program creation and updating to end  "	Transcript show: '---------- Recving BM ----------'; cr.	line _ self waitForBMResponse: s.	(line = '-1') ifTrue: [		notification ifNotNil: [notification no].		^ self].	Transcript show: '---------- Recv message: '; show:line; show:' ----------'; cr.	notification no.	line = 'CALIBRATE' ifFalse: [		" ---------------------------------------------------------------- "		" receive ERR "		" ---------------------------------------------------------------- "		" Get error number "		line _ self waitForBMResponse: s.		(line = '-1') ifTrue: [^ self].		Transcript show: '---------- Recv message: '; show:line; show:' ----------'; cr.		"Wait for finish "		line _ self waitForBMResponse: s.		(line = '-1') ifTrue: [^ self].		Transcript show: '---------- Recv message: '; show:line; show:' ----------'; cr.		" Send message "		Transcript show: '---------- Sending ----------'; cr.		s sendCommand: 'BREAK'.		ErrorMessage show: 1.		s disconnect.		s destroy.	]	ifTrue: [		" ---------------------------------------------------------------- "		" receive CALIBRATE "		" ---------------------------------------------------------------- "		BoardStatus _ 3.		"Wait for finish calibration"		line _ self waitForBMResponse: s For: 36000.		(line = '-1') ifTrue: [^ self].		Transcript show: '---------- Recv message: '; show:line; show:' ----------'; cr.		(line = 'ERR') ifTrue: [			" Disconnect !! "			ErrorMessage show: 1].		" Send message "		Transcript show: '---------- Sending ----------'; cr.		s sendCommand: 'BREAK'.		s disconnect.		s destroy.	].	ScratchMenuTitleMorph setMenuEnable: true.] fork.! !!ScratchFrameMorph methodsFor: 'menu/button actions' stamp: 'KK 12/4/2017 15:53'!editMenu: aMenuTitleMorph 	| menu |	menu _ CustomMenu new.	menu add: 'Undelete' action: #undoTool.	menu addLine.	ScratchProcess blockHighlightMSecs <= 1		ifTrue: [menu add: 'Start Single Stepping' action: #toggleSingleStepping]		ifFalse: [menu add: 'Stop Single Stepping' action: #toggleSingleStepping].	menu add: 'Set Single Stepping' action: #setSingleStepping.	menu addLine."	menu add: 'Export Arduino Language' action: #translateArduLang.""	menu add: 'Compress Sounds' action: #compressSounds.""	menu add: 'Compress Images' action: #compressImages.""	menu addLine."	(DuringTest = true)	" During a test ? "	ifTrue: [ 	" yes -> hide "		menu add: 'Port Settings' action: #setPinAssign.		"menu add: 'Board selection' action: #selectBoardType." "Uncomment if Board selection is needed."		self addServerCommandsTo: menu.		menu addLine.		workPane showStuduinoBlocks			ifTrue: [menu add: 'Hide Studuino Blocks' action: #hideStuduinoBlocks]			ifFalse: [menu add: 'Show Studuino Blocks' action: #showStuduinoBlocks]."		workPane showMotorBlocks			ifTrue: [menu add: 'Hide Motor Blocks' action: #hideMotorBlocks]			ifFalse: [menu add: 'Show Motor Blocks' action: #showMotorBlocks]."		menu localize.		#(3 4) do: [:t3 | menu labels at: t3 put: ((menu labels at: t3)					copyFrom: 1 to: (menu labels at: t3) size - 1)					, ScratchTranslator ellipsesSuffix].	]	ifFalse: [	" no -> show "		menu add: 'Motor Calibration' action: #calibrateMotor.		menu add: 'Port Settings' action: #setPinAssign.		"menu add: 'Board selection' action: #selectBoardType." "Uncomment if Board selection is needed."		self addServerCommandsTo: menu.		menu addLine.		workPane showStuduinoBlocks			ifTrue: [menu add: 'Hide Studuino Blocks' action: #hideStuduinoBlocks]			ifFalse: [menu add: 'Show Studuino Blocks' action: #showStuduinoBlocks]."		workPane showMotorBlocks			ifTrue: [menu add: 'Hide Motor Blocks' action: #hideMotorBlocks]			ifFalse: [menu add: 'Show Motor Blocks' action: #showMotorBlocks]."		menu localize.		#(3 4 5) do: [:t3 | menu labels at: t3 put: ((menu labels at: t3)					copyFrom: 1 to: (menu labels at: t3) size - 1)					, ScratchTranslator ellipsesSuffix].	].	menu invokeOn: self at: aMenuTitleMorph bottomLeft + (0 @ 10)! !!ScratchFrameMorph methodsFor: 'menu/button actions' stamp: 'KK 9/11/2017 11:37'!enableRemoteSensors	"Start running the Scratch server, allowing Scratch and other applications to interact with this Scratch remotely."	| server |	workPane scratchServer		ifNil: 			[server _ ScratchServer new userName: 'Scratch'.			server stage: workPane.			workPane scratchServer: server].	workPane scratchServer startHosting.	DialogBoxMorph inform: 'Remote sensor connections enabled' localized! !!ScratchFrameMorph methodsFor: 'menu/button actions' stamp: 'KK 10/13/2017 18:02'!fileMenu: aMenuTitleMorph	| menu |	menu _ CustomMenu new.	menu add: 'New' action: #newScratchProject.	menu add: 'Open' action: #openScratchProjectBPE.	menu add: 'Save' action: #saveScratchProjectNoDialog.	menu add: 'Save As' action: #saveScratchProjectBPE.	menu addLine."	menu add: 'Import Scripts' action: #importScripts."	menu add: 'Import Project' action: #importScratchProject.	menu add: 'Export Sprite' action: #exportSprite.	menu addLine.	menu add: 'Project Notes' action: #editNotes.	menu addLine.	menu add: 'Calibration Setting Options' action: #openStuduinoSettingMenu.	Sensor shiftPressed ifTrue: [  "developer menu""		menu addLine.		menu add: 'Write Project Summary' action: #writeSummaryFile.		menu add: 'Write Multiple Project Summaries' action: #writeMultipleSummaries."		menu addLine.		fillScreenFlag			ifTrue: [				menu add: 'Exit User Mode' action: #fillScreenOff]			ifFalse: [				menu add: 'Enter User Mode' action: #fillScreenOn.				menu add: 'Save Image in User Mode' action: #saveImageForEndUser]].	menu addLine.	menu add: 'Quit' action: #quitScratch.	menu localize.		#(2 4 5 6 7) do: [:n |"	#(2 4 5) do: [:n |"		menu labels at: n put:			((menu labels at: n) copyFrom: 1 to: (menu labels at: n) size - 1), ScratchTranslator ellipsesSuffix].	menu invokeOn: self at: aMenuTitleMorph bottomLeft + (0@10).! !!ScratchFrameMorph methodsFor: 'menu/button actions' stamp: 'sk 5/22/2017 14:23'!helpMenu: aMenuTitleMorph	| menu lang |	menu _ CustomMenu new."	menu add: 'Help Page' action: #launchHelpPage.""	menu add: 'Help Screens' action: #launchAllHelpScreens.""	menu addLine."	menu add: 'About Studuino Block Programming Environment' action: #aboutScratch."	menu add: 'Manual' action: #aboutPartsBlock2."	lang _ ScratchTranslator currentLanguage.	(lang = 'ja') | (lang = 'ja_HIRA') ifTrue: [		menu add: 'FAQ' action: #openFAQ].	menu localize.	#(1) do: [:n |		menu labels at: n put:			((menu labels at: n) copyFrom: 1 to: (menu labels at: n) size - 1), ScratchTranslator ellipsesSuffix].	menu invokeOn: self at: aMenuTitleMorph bottomLeft + (0@10).! !!ScratchFrameMorph methodsFor: 'menu/button actions' stamp: 'KK 10/4/2017 15:42'!hideStuduinoBlocks	workPane showStuduinoBlocks: false.	viewerPane refresh.! !!ScratchFrameMorph methodsFor: 'menu/button actions' stamp: 'KK 10/25/2017 17:29'!joinScratchSession	"Join another Scratch user or a Scratch-compatible remote application."	| server addrString ok |	server _ ScratchServer new.	server stage: workPane.	workPane scratchServer: server.	addrString _ StringDialog askWithCancel: 'IP address:'.	addrString size = 0 ifTrue: [^ self].	ok _ workPane scratchServer joinSessionAt: addrString.	ok ifFalse: [DialogBoxMorph warn: 'Could not connect to ' localized, addrString].! !!ScratchFrameMorph methodsFor: 'menu/button actions' stamp: 'sk 9/28/2016 17:19'!languageMenu: aToggleButtonMorph	"Present a menu of possible languages for blocks."	| bullet menu choice l msg code |	ScratchTranslator canRenderUnicode ifFalse: [		"try to find a Unicode plugin in case this is the first use after startup"		ScratchTranslator detectRenderPlugin].	bullet _ UTF8 withAll: ' '.	menu _ CustomMenu new.	ScratchTranslator languageNames do: [:lang |		code _ ScratchTranslator isoCodeForName: lang.		(BoardType = 1) | (BoardType = 2) ifTrue: [			(code = 'en') | (code = 'ja') | (code = 'ja_HIRA') ifTrue: [				(code = (ScratchTranslator currentLanguage))					ifTrue: [menu add: (bullet, lang) action: lang]					ifFalse: [menu add: lang action: lang]]]		ifFalse: [			(code = (ScratchTranslator currentLanguage))				ifTrue: [menu add: (bullet, lang) action: lang]				ifFalse: [menu add: lang action: lang]]].	choice _ menu startUp: nil withCaption: nil at: aToggleButtonMorph bottomLeft + (0@10).	choice ifNil: [^ self].	self stopAll.	self setLanguage: choice.	self recordLanguage: (ScratchTranslator currentLanguage).	l _ ScratchTranslator currentLanguage.	(LangDic includesKey: l)		ifTrue: [msg _ LangDic at: l.]		ifFalse: [msg _ 'LANGE'.].	self sendMessageToBM: msg.! !!ScratchFrameMorph methodsFor: 'menu/button actions' stamp: 'KK 8/19/2013 17:56'!launchHelpFile: aFilename	| helpDir subDir |	(FileDirectory default directoryNames includes: 'Help') ifFalse: [^ self beep].  "no help folder"	self stopAll.	helpDir _ FileDirectory default directoryNamed: 'Help'.	"use the English subfolder by default if it exists"	(helpDir directoryNames includes: 'en') ifTrue: [subDir _ helpDir directoryNamed: 'en'].	"use subfolder for the current language if it exists"	(helpDir directoryNames includes: ScratchTranslator currentLanguage) ifTrue: [		subDir _ helpDir directoryNamed: ScratchTranslator currentLanguage].	subDir ifNotNil: [helpDir _ subDir].	(helpDir fileExists: aFilename)		ifTrue: [Smalltalk isMacOSX			ifTrue: [ScratchPlugin primOpenURL: 'file://', (helpDir pathName, FileDirectory slash, aFilename) encodeForHTTP]			ifFalse: [ScratchPlugin primOpenURL: helpDir pathName, FileDirectory slash, aFilename]]		ifFalse: [			DialogBoxMorph inform: 'Scratch help file not found.' localized].! !!ScratchFrameMorph methodsFor: 'menu/button actions' stamp: 'KK 12/26/2017 14:07'!newScratchProject	"Make a new, blank Scratch project."	| response newProject |"	ObjStream initialize."	self closeMediaEditorsAndDialogs ifFalse: [^ self].	self stopAll.	(DuringTest = true)	" During a test ? "	ifTrue: [ self testModeOff. ].	" yes -> off "	(justSaved or: [self projectIsEmpty]) ifFalse: [		"ask the user if they want to save the current project"		response _ DialogBoxMorph askWithCancel: 'Save the current project?'.		response = #cancelled ifTrue: [^ self].		response ifTrue: [self saveScratchProjectNoDialog.			justSaved ifFalse: [^ self]]].	projectDirectory _ ScratchFileChooserDialog getDefaultFolderForType: #project.	projectName _ ''.	projectInfo _ Dictionary new.	"self initIOPort." "Initializing Board.cfg & IOPort."	self initStuduinoGlobalVars.	"Initializing Board.cfg & IOPort."Transcript show:IOPort;cr.	newProject := ScratchStageMorph new.	self installNewProject: newProject.	self initializeWatcherPositions.		self viewerPane refresh.	"self enterNormalMode."	scriptsPane cleanUp.	justSaved _ true."	self deleteBackupFile."Transcript show:'newScratchProject';cr.! !!ScratchFrameMorph methodsFor: 'menu/button actions' stamp: 'sk 5/18/2017 18:27'!openFAQ	" Open the Studuino FAQ page on default web browser.	Japanese is only available at presetnt. "	ScratchPlugin primOpenURL: 'http://www.artec-kk.co.jp/studuino/ja/faq.php'! !!ScratchFrameMorph methodsFor: 'menu/button actions' stamp: 'sk 5/15/2017 17:15'!openStuduinoSettingMenu	| resp |	resp _ SettingMenu showWith: (CalibInfoLocation + 1).	resp ifNotNil: [		CalibInfoLocation _ resp - 1.		self recordCalibInfoLocation: (CalibInfoLocation asString)].! !!ScratchFrameMorph methodsFor: 'menu/button actions' stamp: 'KK 11/21/2017 17:45'!quitScratch	"Quit from Scratch. Ask the user if they want to save, first."	| response |	self closeMediaEditorsAndDialogs ifFalse: [		self deleteBackupFile.		^ self	].	self stopAll.	(DuringTest = true)	" During a test ? "	ifTrue: [ self testModeOff. ].	" yes -> off "	(justSaved or: [self projectIsEmpty]) ifFalse: [		response _ ScratchCloseDialog new getUserResponse.		response = #cancelled ifTrue: [^ self].		response ifTrue: [			self saveScratchProjectNoDialog.			justSaved ifFalse: [^ self]]].	self deleteBackupFile."	self serverProcess terminate."	(self sendFinishToBM) ifFalse: [		Smalltalk snapshot: false andQuit: true].! !!ScratchFrameMorph methodsFor: 'menu/button actions' stamp: 'KK 7/24/2017 16:52'!restoreVariableBlockMorphsOf: aScriptableScratchMorph"change receiver of gobal variable blocks attached to this sprite/stage"	aScriptableScratchMorph blocksBin allMorphsDo: [:m | 				(m isKindOf: VariableBlockMorph) ifTrue: [			(aScriptableScratchMorph vars includesKey: m variable) ifFalse: ["global variable"				m receiver: workPane]]].! !!ScratchFrameMorph methodsFor: 'menu/button actions' stamp: 'KK 7/24/2017 16:52'!restoreWatcher: aWatcherMorph	aWatcherMorph convertFromOldWatcher.	self showWatcher: aWatcherMorph.! !!ScratchFrameMorph methodsFor: 'menu/button actions' stamp: 'KK 10/4/2017 18:39'!runMenu: aMenuTitleMorph 	| menu |	menu _ CustomMenu new."	menu add: 'Transfer' action: #runOnBoard.	(BoardType = 0) & (BoardStatus = 2)	ifTrue: [menu add: 'Run ' action: #startProgram.]	ifFalse: [].	menu addLine."	(DuringTest = true)	" During a test ? "	ifTrue: [ menu add: 'Disconnect' action: #testModeOff. ]	" yes -> off "	ifFalse: [ menu add: 'Connect' action: #testMode. ].		" no -> start "	menu localize."	#(3 ) do: [:n | menu labels at: n put: ((menu labels at: n)				copyFrom: 1 to: (menu labels at: n) size - 1)				, ScratchTranslator ellipsesSuffix]."	menu invokeOn: self at: aMenuTitleMorph bottomLeft + (0 @ 10)! !!ScratchFrameMorph methodsFor: 'menu/button actions' stamp: 'KK 2/13/2018 18:39'!runOnBoard	"I create a source file written in Arduino language. 	 I make it and run on board in communication with board manager"	| s line dialogBox comPort msgID doBuild comNumber res |	" If test mode on, test mode off "	(DuringTest = true) ifTrue: [	" During a test? "		self testModeOff.	].	" Create a UserProgram.cpp "	doBuild _ self writeArduLangFile: 'user\artecRobot.cpp'.	(doBuild = false) ifTrue: [		" STOP Serial Communication "		^ self.	].	s _ self createBMHandle.	s ifNil: [^ self].	" Success in connection "	" Send message "	Transcript show: '---------- Sending ----------'; cr.	s sendCommand: 'RUN'.	" Display Status DialogBox "	dialogBox _ NotificationMessage show: 16r10.	"Building and updating"	" Waiting for BM's completing to build a program."	" Only if a board is Studuino mini. "	(BoardType = 1 or: [BoardType = 2]) ifTrue: [		Transcript show: '---------- Recving1 ----------'; cr.		line _ self waitForBMResponse: s.		(line = '-1') ifTrue: [			dialogBox ifNotNil: [dialogBox no].			^ self].		res _ line.		line _ self waitForBMResponse: s.		(line = '-1') ifTrue: [			dialogBox ifNotNil: [dialogBox no].			^ self].		msgID _ line. " Number "Transcript show: res; show: ' '; show: msgID; cr.		dialogBox no.		(res = 'OK') ifTrue: [			" Asking user to push a reset button. "			dialogBox _ NotificationMessage show: 16r20.	"Waiting for RESET"]		ifFalse: [	" Build error "			ErrorMessage show: msgID asNumber.			^ self.].	].	" Wait for program creation and updating to end  "	Transcript show: '---------- Recving2 ----------'; cr.	line _ self waitForBMResponse: s.	(line = '-1') ifTrue: [		dialogBox ifNotNil: [dialogBox no].		^ self].	comPort _ line.	COMPort _ comPort.	" set class value "	line _ self waitForBMResponse: s.	(line = '-1') ifTrue: [		dialogBox ifNotNil: [dialogBox no].		^ self].	msgID _ line sansSemicolonSuffix.Transcript show:comPort; show:', '; show:msgID;cr.	" Display message "	" Hide Status DialogBox "	dialogBox no.	Transcript show:line;cr.	" Display message "	" Send message "	Transcript show: '---------- Sending ----------'; cr.	s sendCommand: 'BREAK'.	s disconnect.	s destroy.	BoardStatus _ 0.	(comPort ~= 'ERR') ifTrue: [		BoardStatus _ 2.	] ifFalse: [		(msgID = '2') ifTrue: [			" Close port if port was opened  by myself "			comNumber _ 1.			32 timesRepeat: [				ScratchPlugin closePort:comNumber.				comNumber _ comNumber + 1.			].		].		ErrorMessage show: msgID asNumber.	].! !!ScratchFrameMorph methodsFor: 'menu/button actions' stamp: 'KK 11/21/2017 17:03'!saveImageForEndUser	(self confirm: 'Close non-Scratch windows and save thisimage in end-user (fillScreen) mode?') ifFalse: [^ self].	ScratchFrameMorph isXO ifTrue: [Preferences useLargeFonts].	self setLanguage: 'en'.	World submorphs do: [:m |		(m isKindOf: SystemWindow) ifTrue: [m delete]].	self clearStage.	Display newDepth: 32.	self fillScreenOn.	World doOneCycleNow.	Smalltalk snapshot: true andQuit: true.	self startup.	self readAutosavedProgram."	self serverProcess: ([ self usbConnectionDetector. ] fork)."	Sensor useOSEvents: true.! !!ScratchFrameMorph methodsFor: 'menu/button actions' stamp: 'KK 8/20/2013 10:55'!sendProgram	| |	"Create Arduino program and send it."	"Create Arduino program..."	self translateArduLang.! !!ScratchFrameMorph methodsFor: 'menu/button actions' stamp: 'KK 2/13/2018 19:06'!setBoardIO| result |[	 | s line filename f b i |	ScratchMenuTitleMorph setMenuEnable: false.	" Communicate with Board Manager "	s _ self createBMHandle.	s ifNil: [^ self].	" Success in connection "	" Send message "	Transcript show: '---------- Sending ----------'; cr.	s sendCommand: 'CONFIG'.	" Wait for program creation and updating to end  "	Transcript show: '---------- Recving ----------'; cr.	line _ self waitForBMResponse: s For: 36000.	(line = '-1') ifTrue: [^ self].	result _ line sansSemicolonSuffix.	line _ self waitForBMResponse: s.	(line = '-1') ifTrue: [^ self].	Transcript show:line;cr.	" Display message "	" Send message "	Transcript show: '---------- Sending ----------'; cr.	s sendCommand: 'BREAK'.	"Delay forSeconds: 1."	"1000 timesRepeat: []."	s disconnect.	s destroy.	" If I/O Configuration is updated, update IOPort and TestMode OFF. "	result = 'UPDATE' ifTrue: [		" Get Configuration Info "		filename := 'Board.cfg'.		f _ FileStream fileNamed: filename.		f binary.		i _ 1.		[f atEnd] whileFalse: [			b _ f next.	" PartsID "			" I/O Port Configuration "			IOPort at:(i) put:b.			i _ i + 1.		].		(DuringTest = true)	" During a test ? "		ifTrue: [ self testModeOff. ].	" yes -> off "Transcript show:IOPort;cr.		self viewerPane refresh.		f close.		self setLanguage: (ScratchTranslator currentLanguage).	].	ScratchMenuTitleMorph setMenuEnable: true.] fork.! !!ScratchFrameMorph methodsFor: 'menu/button actions' stamp: 'sk 9/28/2016 17:05'!settingMenu: aMenuTitleMorph	| menu |	menu _ CustomMenu new.	menu add: 'Board selection' action: #selectBoardType.	menu localize.	menu invokeOn: self at: aMenuTitleMorph bottomLeft + (0@10).! !!ScratchFrameMorph methodsFor: 'menu/button actions' stamp: 'KK 2/28/2018 10:11'!shiftToCalibrationMode	"Move onto calibration mode for Studuino."	| s line  dialogBox comPort msgID sb result calibData dcCalibData |	(BoardStatus = 1) ifFalse: [		s _ self createBMHandle.		s ifNil: [^ self].		"---------- Success in connection ----------"		" Send message "		Transcript show: '---------- Sending1 ----------'; cr.		s sendCommand: 'TEST'.		" Display Status DialogBox "		dialogBox _ NotificationMessage show: 16r11.	"Shifting to testmode"						" Wait for program creation and updating to end  "		Transcript show: '---------- Recving2 ----------'; cr.		line _ self waitForBMResponse: s.		(line = '-1') ifTrue: [			dialogBox ifNotNil: [dialogBox no].			^ self].		comPort _ line sansSemicolonSuffix.		COMPort _ comPort.	" set class value "		line _ self waitForBMResponse: s.		(line = '-1') ifTrue: [			dialogBox ifNotNil: [dialogBox no].			^ self].		msgID _ line sansSemicolonSuffix.		" Hide Status DialogBox "Transcript show: comPort; show:', '; show: line; cr.	" Display message "		" Send message "		Transcript show: '---------- Sending3 ----------'; cr.		s sendCommand: 'BREAK'.		s disconnect.		s destroy.		BoardStatus _ 1.	] " End communication with Boardmanager."	ifTrue: [		comPort _ COMPort.		" Display Status DialogBox "		dialogBox _ NotificationMessage show: 16r11.	"Shifting to testmode"	].	(comPort = 'ERR') ifFalse: [	" Success to Transfer "		"Check if the port is available."		(self isPortAvailable: comPort) ifFalse: [			COMPort _ nil.			BoardStatus _ 0.			" Hide communication box "			dialogBox no.			self testMode.			^ self		].		" Connect with Arduino board "		sb _ workPane motorCalibrationBoard.		sb portIsOpen ifTrue: [			Transcript show:'[ScratchFrameMorph::calibrationMode] close & open port';cr.			sb closePort.		].		sb selectPort: comPort.		" Wait for run arduino board "			result _ sb isBoardSetup.		result ifFalse: [			" Hide communication box "			dialogBox no.			sb closePort.			BoardStatus _ 0.			self calibrateMotor.		]		ifTrue: [			"  Set sensorboard items "			sb addReadouts.			" Connected Studuino. "			ServomotorSynchroMotion _ false.			sb data: 16r0100 msgID: 5.			calibData _ Array new: 8.			dcCalibData _ Array new: 2.			ScratchFrameMorph getCalibData: calibData swap: true.			ScratchFrameMorph getDCCalibData: dcCalibData.			" Set servomotors 90 deg. with offsets. "			(3 to: 10) do: [:elm |				((IOPort at: elm) = 0) ifFalse: [					sb data: (DataCreation getServoWithOffsetFor: (elm - 3) degree: 90) msgID: 1.					sb setCalibrationField: (elm-2) valid: true.				] ifTrue: [					calibData at: (elm-2) put: 0.					sb setCalibrationField: (elm-2) valid: false.				].			].			" Set DC motor status "			(((IOPort at: 1) = 0) | ((IOPort at: 2) = 0)) ifTrue: [				" Set Unusable "				sb initDCMotorCalibrationField: false.			] ifFalse: [				" Set Usable "				sb initDCMotorCalibrationField: true.			].			" Hide communication box "			dialogBox no.			" Set default value to Servo and DC "			sb setDefaultValue: calibData.			sb setDCDefaultValue: dcCalibData.			" Set default position to the servomotor. "			sb setDefaultPosition.			" Invalidate menu "			ScratchMenuTitleMorph setMenuEnable: false.			self showCalibrationBoard.			sb initSyncProc.		]	]	ifTrue: [		" Hide communication box "		dialogBox no.		BoardStatus _ 0.		ErrorMessage show: msgID asNumber.	].! !!ScratchFrameMorph methodsFor: 'menu/button actions' stamp: 'KK 1/31/2018 09:10'!shiftToCalibrationMode2	"Move onto calibration mode for Studuino."	| s notification line cb idNortifySketchActivation idAckSetIOConfigure retryTime calibData partsID count sendStatus |	" Communicate with Board Manager "	s _ self createBMHandle.	s ifNil: [^ self].	" Success in connection "	" -------------------------------------------------------------------- "	" Send message "	" -------------------------------------------------------------------- "	Transcript show: '---------- Sending BM ----------'; cr.	s sendCommand: 'CALIB'.	" -------------------------------------------------------------------- "	" Display Status DialogBox "	" -------------------------------------------------------------------- "	" Shifting ot calibration mode "	notification _ NotificationMessage show: 16r12.	" Wait for program creation and updating to end  "	Transcript show: '---------- Recving BM ----------'; cr.	line _ self waitForBMResponse: s.	(line = '-1') ifTrue: [		notification ifNotNil: [notification no].		^ self].	Transcript show: '---------- Recv message: '; show:line; show:' ----------'; cr.	notification no.	line = 'CALIBRATE' ifFalse: [		" ---------------------------------------------------------------- "		" receive ERR "		" ---------------------------------------------------------------- "		" Get error number "		line _ self waitForBMResponse: s.		(line = '-1') ifTrue: [^ self].		Transcript show: '---------- Recv message: '; show:line; show:' ----------'; cr.		"Wait for finish "		line _ self waitForBMResponse: s.		(line = '-1') ifTrue: [^ self].		Transcript show: '---------- Recv message: '; show:line; show:' ----------'; cr.		" Send message "		Transcript show: '---------- Sending ----------'; cr.		s sendCommand: 'BREAK'.		ErrorMessage show: 1.		s disconnect.		s destroy.	]	ifTrue: [		" ---------------------------------------------------------------- "		" receive CALIBRATE "		" ---------------------------------------------------------------- "		BoardStatus _ 3.		"Wait for finish calibration"		line _ self waitForBMResponse: s For: 36000.		(line = '-1') ifTrue: [^ self].		Transcript show: '---------- Recv message: '; show:line; show:' ----------'; cr.		(line = 'ERR') ifTrue: [			" Disconnect !! "			ErrorMessage show: 1].		self readCalibInfo.		" Send message "		Transcript show: '---------- Sending ----------'; cr.		s sendCommand: 'BREAK'.		s disconnect.		s destroy.	].	" ------------------------------------------------"	" Step 3. Open COM port and Display calibration board "	" ------------------------------------------------"	idNortifySketchActivation _ 16rFF.	idAckSetIOConfigure _ 14.	cb _ workPane motorCalibrationBoard.	" Get calibration board handle. "	cb portIsOpen ifTrue: [		Transcript show:'[ScratchFrameMorph::calbirateSvmotors] close & open port';cr.		cb closePort.	].	" Open COM port ""	cb selectPort: comPortInfo."	" COM port name "	cb selectPort: 'COM3'.	" COM port name "Transcript show: 'dbg1'; cr.	" Check activation of skectch that is uploaded Studuino. "	(cb isSketchActivated: 5000 kind: idNortifySketchActivation) ifFalse: [		ScratchFrameMorph displayMessageDialog: '7'.	" Display error message dialog "		cb closePort.		^ self.			 ].Transcript show: 'dbg2'; cr.	" Send port configuration "	retryTime _ 3.	" Resend time "	calibData _ Array new:8.	ScratchFrameMorph getCalibData: calibData swap:true.Transcript show: 'dbg3'; cr.	" DC motor initialized "	cb partsID: 4 high: 0 middle: 0 low: StdnoPIDDCMotor.	cb partsID: 4 high: 1 middle: 0 low: StdnoPIDDCMotor.Transcript show: 'dbg4'; cr.	" Servomotor initialized "	3 to: 10 do: [ :i |		partsID _ IOPort at:i.		" Get Parts ID "		" Send only servomotor info to board "		(partsID = StdnoPIDServomotor) ifTrue: [			count _ 0.			" Resend count "			sendStatus _ true.	" sendStatus true->sending... false->sent "			[((count < retryTime) & sendStatus)] whileTrue: [				cb partsID: 4 high: (i-1) middle:0 low:partsID.				(cb isSketchActivated: 1000 kind: idAckSetIOConfigure) ifTrue: [					" Time out "					count _ count + 1.				] ifFalse: [					" Receive Ack. "					sendStatus _ false.				].			].			(sendStatus) ifTrue: [				" Send is not finish. "				ScratchFrameMorph displayMessageDialog: '7'.	" Display error message dialog "				cb closePort.				^ self.			]."			SvCalib at:(i-2) put: b."			cb setCalibrationField:(i-2) valid:true.		]		ifFalse: ["			SvCalib at:(i-2) put: 0."			calibData at:(i-2) put: 0.			cb setCalibrationField:(i-2) valid:false.		].	].Transcript show: 'dbg5'; cr.	" Send servomotor calibration start. "	cb partsID:5 high:0 middle:0 low:0.Transcript show: 'dbg6'; cr.	" Set default value to Servo and DC "	cb setDefaultValue: calibData.	cb setDCDefaultValue: DCCalib.Transcript show: 'dbg7'; cr.	" Set default position to the servomotor. "	cb setDefaultPosition.Transcript show: 'dbg8'; cr.	" Invalidate menu "	ScratchMenuTitleMorph setMenuEnable: false.Transcript show: 'dbg9'; cr.	self showCalibrationBoard.Transcript show: 'dbg10'; cr.! !!ScratchFrameMorph methodsFor: 'menu/button actions' stamp: 'sk 8/26/2016 18:11'!shiftToCalibrationModeMini	"Move onto calibration mode for Studuino mini."	| s notification res |	" Communicate with Board Manager "	s _ self createBMHandle.	s ifNil: [^ self].	" Asking user to push a reset button. "	notification _ NotificationMessage show: 16r20.	"Waiting for RESET"	" Success in connection "	" -------------------------------------------------------------------- "	" Send message "	" -------------------------------------------------------------------- "	s sendCommand: 'CALIB'.	" Waiting for BM to transfer a testmode program. "	Transcript show: '---------- Recving ----------'; cr.	res _ self waitForBMResponse: s.	(res = '-1') ifTrue: [		notification ifNotNil: [notification no].		^ self].	notification no.	(BoardType = 2) ifTrue: [		(res = 'OK') ifFalse: [			" Getting error number "			res _ self waitForBMResponse: s.			(res = '-1') ifTrue: [				notification ifNotNil: [notification no].				^ self].			" Notify timeout error. "			ErrorMessage show: res asNumber.			^ self].		" Asking user to push a reset button. - 2 - "		notification _ NotificationMessage show: 16r21.	"Waiting for RESET"		" Waiting for BM to transfer a testmode program. "		Transcript show: '---------- Recving1 ----------'; cr.		res _ self waitForBMResponse: s.		(res = '-1') ifTrue: [			notification ifNotNil: [notification no].			^ self].		notification no].	(res = 'OK') ifTrue: [		"Waiting INITOK"		res _ self waitForBMResponse: s.		(res = '-1') ifTrue: [			notification ifNotNil: [notification no].			^ self].		(res = 'INITOK') ifTrue: [			" Do nothing "]		ifFalse: [			notification no.			ErrorMessage show: 100.			^ self]]	ifFalse: [		" Notify error. "		Transcript show: '---------- Error ----------'; cr.		"Getting an error number."		notification no.		res _ self waitForBMResponse: s.		(res = '-1') ifTrue: [			notification ifNotNil: [notification no].			^ self].		ErrorMessage show: res asNumber.		^ self].		" ---------------------------------------------------------------- "		" Waiting for the calibration done.                          "		" ---------------------------------------------------------------- "		notification no.		BoardStatus _ 3.		"Wait for finish calibration"		res _ self waitForBMResponse: s For: 36000.		(res = '-1') ifTrue: [			notification ifNotNil: [notification no].			^ self].		Transcript show: '---------- Recv message: '; show:res; show:' ----------'; cr.		(res = 'ERR') ifTrue: [			" Disconnect !! "			ErrorMessage show: 1].		" Send message "		Transcript show: '---------- Sending ----------'; cr.		s sendCommand: 'BREAK'.		s disconnect.		s destroy.! !!ScratchFrameMorph methodsFor: 'menu/button actions' stamp: 'KK 9/5/2017 14:59'!shoutGo	"Broadcasts the start event to all objects and processes."	self stopAll.	workPane broadcastEventNamed: 'Scratch-StartClicked' with: 0.	flagButton on.	World displayWorldSafely.  "force button flash"	Delay waitMSecs: 20.! !!ScratchFrameMorph methodsFor: 'menu/button actions' stamp: 'KK 2/6/2018 11:22'!showCalibrationBoard	| sc |	sc _ workPane motorCalibrationBoard.	sc position: stageFrame position - ((sc width)@0) + (-20@20).	sc openInWorld.	World startSteppingSubmorphsOf: sc.! !!ScratchFrameMorph methodsFor: 'menu/button actions' stamp: 'sk 3/16/2017 18:57'!showSensorBoard	| sb |	sb _ workPane sensorBoard.	sb position: stageFrame position - ((sb width)@0) + (-20@20).	sb openInWorld.	"self workPane addMorph: sb."	" Only if a board is Studuino. "	(BoardType = 0) ifTrue: [		sb tryToOpenPort.].	World startSteppingSubmorphsOf: sb.! !!ScratchFrameMorph methodsFor: 'menu/button actions' stamp: 'KK 10/4/2017 13:32'!showStuduinoBlocks	workPane showStuduinoBlocks: true.	viewerPane currentCategory: 'motion'.	viewerPane pageViewer vScrollRelative: 1.0.! !!ScratchFrameMorph methodsFor: 'menu/button actions' stamp: 'KK 10/4/2017 19:20'!showStuduinoSensorBoard	| sb |	sb _ workPane studuinoBoard.	sb position: stageFrame position - ((sb width)@0) + (-20@20).	sb openInWorld.	"self workPane addMorph: sb."	" Only if a board is Studuino. "	(BoardType = 0) ifTrue: [		sb tryToOpenPort.].	World startSteppingSubmorphsOf: sb.! !!ScratchFrameMorph methodsFor: 'menu/button actions' stamp: 'KK 9/14/2013 14:13'!startProgram	| sb |	"I restart program on board"	sb _ workPane sensorBoard.	sb openPort: COMPort.	sb closePort.! !!ScratchFrameMorph methodsFor: 'menu/button actions' stamp: 'KK 7/28/2017 15:22'!stopAll	"Tell my workPane to stop everything."	| oldJustSaved |	oldJustSaved _ justSaved.	workPane stopAll.	justSaved _ oldJustSaved.! !!ScratchFrameMorph methodsFor: 'menu/button actions' stamp: 'sk 6/10/2016 17:52'!testMode	| |	workPane stopAll.	(BoardType = 0) ifTrue: [		self shiftToTestMode.].	(BoardType = 1) ifTrue: [		self shiftToTestModeMini.].	(BoardType = 2) ifTrue: [		self shiftToTestModeMini2.].! !!ScratchFrameMorph methodsFor: 'menu/button actions' stamp: 'KK 10/4/2017 19:26'!testModeOff	| sb bmSocket |	workPane stopAll.	sb _ workPane studuinoBoard.	(BoardType = 0) ifTrue: [ " Studuino "		" Close port "			sb closePort.]	ifFalse: [ " Studuino mini "		" Close socket "		bmSocket _ self createBMHandle.		bmSocket ifNotNil: [			bmSocket sendCommand: 'TEST2E'.			bmSocket getResponseShowing: true. "Waiting ACK"				bmSocket disconnect.			bmSocket destroy].		sb closeSocket.].	" Hide SensorBoard "	sb delete.	DuringTest _ false.! !!ScratchFrameMorph methodsFor: 'menu/button actions' stamp: 'KK 8/2/2013 11:41'!translateArduLang	"Translate block into Arduino language and write to a file."	self writeArduLangFile: ''.! !!ScratchFrameMorph methodsFor: 'menu/button actions' stamp: 'KK 8/19/2014 14:21'!uniqueSummaryFileName	| baseName fileName n |	baseName _ self projectName.	baseName size <= 1 ifTrue: [baseName _ 'newProject'].	fileName _ baseName, '.ino'.	n _ 1.	[FileDirectory default fileExists: fileName] whileTrue: [		fileName _ baseName, n printString, '.ino'.		n _ n + 1].	^ fileName! !!ScratchFrameMorph methodsFor: 'menu/button actions' stamp: 'sk 2/22/2017 11:51'!writeArduLangFile: fullFileName	"Translate block into Arduino language and write to a file."	| s sprites f fName ltmp dir headCode footCode dialogBox response  blocks |	"Convert to block sign"	ltmp _ ScratchTranslator currentLanguage.	"---------------------------------------------------------"	" Check hatless blocks "	"---------------------------------------------------------"	blocks _ workPane getHatlessBlocks.	(blocks size = 0) ifFalse: [	" exist hatless blocks "		" Display a hatless block in red "		blocks do: [:item |			item color: Color red.		].		" Warn the hatless block exists "		dialogBox  _ DialogBoxMorph new.		dialogBox withButtonsForYes: true no: true okay: false cancel: false.		dialogBox title: 'Unconnected blocks present'.		dialogBox openInWorld.		" Display Dialogbox "		dialogBox centerOnScreen.	" Set center position "		dialogBox world doOneCycle.		(fullFileName size = 0) ifFalse: [			" Transfer "			dialogBox message: 'These blocks will not be built.Do you wish to continue?'.		] ifTrue: [			" Export Arduino Language "			dialogBox message: 'These blocks will not be exported to Arduino Language.Do you wish to continue?'.		].		" Stop Building "		response _ dialogBox getUserResponse.		(response = false) ifTrue: [			self setLanguage: ltmp. 			 ^ false.		].	].	" Continue Building "	self setLanguage: ltmp. 	" Build... "	self setLanguage: 'atc'. 	s _ WriteStream on: (String new: 10000).	workPane printArduLangOn: s.	self setLanguage: ltmp. 	sprites _ workPane submorphs select: [:m | m isKindOf: ScratchSpriteMorph].	sprites do: [:m |		s skip: -2.  "remove last cr"		s nextPutAll: '--------'; cr.		m printSummaryOn: s]."	s nextPutAll: '--------'; cr."	ParagraphEditor clipboardTextPut: s contents asText.	fName _ fullFileName.	fullFileName size = 0		ifTrue: [			TabletMode ifTrue: [				self sendMessageToBMnoBlocking: 'SHOWKEYPAD'].			fName _ ScratchFileChooserDialog				chooseNewFileDefault: self uniqueSummaryFileName				title: 'File Name?'				type: #projectSummary.			TabletMode ifTrue: [				self sendMessageToBMnoBlocking: 'HIDEKEYPAD'].			fName = #cancelled ifTrue: [				"Turn setting laguage"				self setLanguage: ltmp. 				^ self].			f _ CrLfFileStream newScratchFileNamed: fName.		]		ifFalse: [			(StandardFileStream isAFileNamed: fName) ifTrue: [				" Exist file "				dir _ FileDirectory default directoryNamed: 'user'.	" Get target directory "				dir deleteFileNamed: 'artecRobot.cpp'.					" delete file "			].			f _ StandardFileStream new open: fName forWrite: true.		].	f ifNil: [		"Turn setting laguage"		self setLanguage: ltmp. 		^ self].	" Head and Footer file "	" Default English. "	headCode _ StandardFileStream new open: 'code\head_en.txt' forWrite: false.	footCode _ StandardFileStream new open: 'code\foot_en.txt' forWrite: false.	((ltmp = 'ja') | (ltmp = 'ja_HIRA')) ifTrue: [		Transcript show: '---------- Trans to Japan ----------'; cr.		(BoardType = 0 or: [BoardType = 2]) ifTrue: [			headCode _ StandardFileStream new open: 'code\head.txt' forWrite: false.]		ifFalse: [			headCode _ StandardFileStream new open: 'code\head_mini.txt' forWrite: false.].		footCode _ StandardFileStream new open: 'code\foot.txt' forWrite: false.	]	ifFalse: [		(ltmp = 'zh_CN') ifTrue: [			Transcript show: '---------- China ----------'; cr.			headCode _ StandardFileStream new open: 'code\head_zh.txt' forWrite: false.			footCode _ StandardFileStream new open: 'code\foot_zh.txt' forWrite: false.		]		ifFalse: [			(ltmp = 'ko') ifTrue: [				Transcript show: '---------- Korea ----------'; cr.				headCode _ StandardFileStream new open: 'code\head_ko.txt' forWrite: false.				footCode _ StandardFileStream new open: 'code\foot_ko.txt' forWrite: false.			]		].	].	[headCode atEnd] whileFalse: [		f nextPut: headCode next.	].	f nextPutAll: ((s contents) asUTF8).	[footCode atEnd] whileFalse: [		f nextPut: footCode next.	].	headCode close.	footCode close.	f close.	"Turn setting laguage"	self setLanguage: ltmp. ! !!ScratchFrameMorph methodsFor: 'geometry' stamp: 'KK 11/14/2017 16:21'!fixLayout	| stageExtent xyReadout w |	stageExtent _		workPane isQuarterSize			ifTrue: [workPane extent // 2]			ifFalse: [workPane extent].	topPane		position: self topLeft;		width: self width;		height: (menuPanel height + 0 max: logoMorph height + 10).	stageFrame		extent: stageExtent + (14@42);		top: topPane bottom;		right: self right.	workPane position: stageFrame topLeft + (4@37).	titlePane		position: stageFrame topLeft + (0@1);		width: stageFrame width - 6;		height: 36.	self fixProjectTitleMorphLayout.	scriptsPane fixLayout.	w _ (viewerPane catButtonsExtent x + 17)		within: 40		and: (self width - (scriptsPane bareMinimumWidth + stageFrame width)).	viewerPane position: topPane bottomLeft;		width: w;		height: self bottom - topPane bottom.	scriptsPane		position: viewerPane topRight;		width: self width - (stageFrame width + viewerPane width);		height: self bottom - topPane bottom;		fixLayout.	libraryPane position: stageFrame bottomLeft;		width: (self right - scriptsPane right);		height: self bottom - libraryPane top.	menuPanel		left: logoMorph right + 18;		top: topPane top + ((topPane height - menuPanel height) // 2) + 2.	viewModeButtonsPanel		right: stageFrame right - 8;		top: self top + 7.	stageButtonsPanel		position: (stageFrame left + 10)@(topPane bottom + 5);		width: stageFrame width - 28;		height: (workPane top - stageFrame top) - 8.	xyReadout _ readoutPane submorphs at: 1.	readoutPane		width: xyReadout width + 23;		height: xyReadout height + 15;		position: stageFrame bottomRight - ((readoutPane width + 6)@3).	xyReadout position: readoutPane position + (18@5).	toolbarPanel		left: (viewModeButtonsPanel left - toolbarPanel width -4);		top: self top + ((topPane height - toolbarPanel height) // 2) + 3.	fontButtons		left: toolbarPanel left - fontButtons width -4;		top: topPane top + ((topPane height - fontButtons height) // 2) + 2.	usbCSPanel notNil ifTrue: [		usbCSPanel			left: fontButtons left - usbCSPanel width -4;			top: topPane top + ((topPane height - usbCSPanel height) // 2) + 2.	].	((toolbarPanel right - 5) > viewModeButtonsPanel left)		ifTrue: [toolbarPanel delete]		ifFalse: [			(toolbarPanel owner = self) ifFalse: [				self addMorphFront: toolbarPanel]].! !!ScratchFrameMorph methodsFor: 'stepping' stamp: 'KK 10/20/2017 16:38'!processDroppedFiles	"Process any files that have been dropped onto me."	| droppedFiles m dropPoint fName |	droppedFiles _ FileStream droppedFiles.	droppedFiles size = 0 ifTrue: [^ self].	(m _ self viewerPane target) ifNil: [^ self].	dropPoint _ droppedFiles first.	(droppedFiles copyFrom: 2 to: droppedFiles size) do: [:file |		file close.		fName _ file fullName.		((fName asLowercase endsWith: '.scratch') | (fName asLowercase endsWith: '.sb') | (fName asLowercase endsWith: '.bpd') | (fName asLowercase endsWith: '.bpd2') | (fName asLowercase endsWith: '.bpdc'))			ifTrue: [self openScratchDroppedProjectNamed: fName]			ifFalse: [				((fName asLowercase endsWith: '.sprite') | (fName asLowercase endsWith: '.studuinosprite'))					ifTrue: [self importSpriteOrProject: fName]					ifFalse: [m importMedia: fName]]].! !!ScratchFrameMorph methodsFor: 'stepping' stamp: 'KK 10/5/2017 11:24'!step	"Run each process until it gives up control, then filter out any processes that have terminated."	| screenExtent oldJustSaved keyPadTarget |	fillScreenFlag ifTrue: [		screenExtent _ Display extent.		((self position = (0@0)) and: [self extent = screenExtent]) ifFalse: [			oldJustSaved _ justSaved.			self position: 0@0.			self extent: screenExtent.			self enterQuarterModeIfSmallScreen.			scriptsPane currentCategory: scriptsPane currentCategory.			justSaved _ oldJustSaved.			^ self]].	workPane ifNotNil: [		ScriptableScratchMorph scratchOrigin: workPane center.		viewerPane target isNil 			ifTrue: [workPane viewBlocksAndScripts]			ifFalse: [viewerPane target isInWorld ifFalse: [workPane viewBlocksAndScripts]]].	Sensor processOSMenuEvents.	paintingInProgress ifTrue: [^ self].	workPane scratchServer ifNotNil: [workPane scratchServer stepServer].	self checkForWeDo.	self updateToolButtons.	self processWhenConditions.	self processKeyboardEvents.	workPane stepProcesses.	workPane stepStuduinoProcesses.	workPane scratchServer ifNotNil: [workPane scratchServer stepServer].	self processDroppedFiles.	workPane processesToRun size > 0		ifTrue: [flagButton on]		ifFalse: [flagButton off].	(workPane studuinoBoard disconnected) ifTrue: [Transcript show: 'disconnected'; cr.		self testModeOff.		workPane studuinoBoard disconnected: false].	TabletMode ifTrue: [		keyPadTarget _ World activeHand keyboardFocus.		(keyPadTarget isKindOf: StringFieldMorph) ifTrue: [			(keyPadTarget ownerThatIsA: ExpressionArgMorph) ifNotNil: [				keyPad ifNil: [					keyPad _ KeyPadMorph new openInWorld]]]		ifFalse: [			keyPad _ nil]].! !!ScratchFrameMorph methodsFor: 'stepping' stamp: 'KK 2/13/2018 19:07'!waitForBMResponse: s For: seconds	| line |	" I receive message from Board Manager and return message"	line _ WriteStream on: String new.	line _ s getBMResponseFor: seconds.	^ line sansSemicolonSuffix.! !!ScratchFrameMorph methodsFor: 'view mode' stamp: 'KK 7/4/2017 13:12'!enterNormalMode	"Go into normal (full-stage) mode."	(viewMode = #normal) ifTrue: [		self updateViewModeButtons.		^ self].	viewMode _ #normal.	workPane isQuarterSize: false.	workPane isInWorld		ifTrue: [self fixLayout]		ifFalse: [self exitPresentationMode]."	stageFrame initFromForm: (ScratchFrameMorph skinAt: 'spriteLibraryPaneFrameTransparent2').	self removeAllMorphs.	self		addMorph: (topPane isSticky: true);		addMorph: (viewerPane isSticky: true);		addMorph: (scriptsPane isSticky: true);		addMorph: (stageFrame isSticky: true);		addMorph: (workPane isSticky: true);		addMorph: (titlePane isSticky: true);		addMorph: (libraryPane isSticky: true).	libraryPane delete."	self updatePanes.	self updateViewModeButtons.! !!ScratchFrameMorph methodsFor: 'view mode' stamp: 'KK 7/4/2017 13:33'!enterQuarterMode	"Go into quarter stage mode."	(viewMode = #quarter) ifTrue: [		self updateViewModeButtons.		^ self].	viewMode _ #quarter.	workPane isQuarterSize: true.	workPane isInWorld		ifTrue: [self fixLayout]		ifFalse: [self exitPresentationMode]."	stageFrame initFromForm: (ScratchFrameMorph skinAt: 'spriteLibraryPaneFrameTransparent2').	self removeAllMorphs.	self		addMorph: (topPane isSticky: true);		addMorph: (viewerPane isSticky: true);		addMorph: (scriptsPane isSticky: true);		addMorph: (workPane isSticky: true);		addMorph: (stageFrame isSticky: true);		addMorph: (titlePane isSticky: true);		addMorph: (libraryPane isSticky: true).	libraryPane delete."	self updatePanes.	self updateViewModeButtons.! !!ScratchFrameMorph methodsFor: 'other' stamp: 'KK 8/1/2017 15:10'!presentHelpScreen: aStringOrNil	"Look for a help screen with the given name in the 'Help' folder. If found, present it to the user."	| helpDir subDir fileNames helpFileName helpForm |	aStringOrNil ifNil: [^ self beep].	(FileDirectory default directoryNames includes: 'Help') ifFalse: [^ self beep].  "no help folder"	helpDir _ FileDirectory default directoryNamed: 'Help'.	"use the English subfolder by default if it exists"	(helpDir directoryNames includes: 'en') ifTrue: [subDir _ helpDir directoryNamed: 'en'].	"use subfolder for the current language if it exists"	(helpDir directoryNames includes: ScratchTranslator currentLanguage) ifTrue: [		subDir _ helpDir directoryNamed: ScratchTranslator currentLanguage].	subDir ifNotNil: [helpDir _ subDir].	fileNames _ helpDir fileNames collect: [:s | s asLowercase].	helpFileName _ nil.	#(hlp gif png jpg bmp) do: [:ext |		helpFileName ifNil: [			helpFileName _ aStringOrNil, '.', ext.			(fileNames includes: helpFileName asLowercase)				ifFalse: [helpFileName _ nil]]].	helpFileName ifNil: [^ self beep].	World doOneCycle.  "update cursor before fetching helpForm"	[helpForm _ Form fromFileNamed: (helpDir fullNameFor: helpFileName)]		ifError: [^ self beep].	HelpDialog showForm: helpForm.! !!ScratchFrameMorph methodsFor: 'other' stamp: 'KK 7/28/2017 15:24'!projectModified	"Record that the current project has changed since it was last saved."	justSaved _ false.! !!ScratchFrameMorph methodsFor: 'other' stamp: 'KK 11/10/2017 14:35'!serverProcess	^ serverProcess.! !!ScratchFrameMorph methodsFor: 'other' stamp: 'KK 11/10/2017 14:35'!serverProcess: p	serverProcess _ p.! !!ScratchFrameMorph methodsFor: 'other' stamp: 'KK 10/2/2013 15:58'!view: aMorph tab: t category: c	"Add given morph to the work pane and view it."	scriptsPane target: aMorph.	scriptsPane tabPane currentTab: t.	viewerPane		target: aMorph;		currentCategory: c.! !!ScratchFrameMorph methodsFor: 'startup' stamp: 'KK 10/25/2017 10:56'!backupFile	| saveDirectory userProfilePath backupFile documentsPath |	documentsPath _ FileDirectory on: (ScratchPlugin primGetFolderPath: 3).	" MyDocument Folder"	userProfilePath _ documentsPath parentDirectory.						" User Folder "	saveDirectory _ userProfilePath pathName.								" Object -> String "	backupFile _ saveDirectory, '\AppData\Local\Temp\Studuino\backup.bpdc'." Set save file "	^ backupFile! !!ScratchFrameMorph methodsFor: 'startup' stamp: 'KK 10/13/2017 17:29'!deleteBackupFile	(FileDirectory new) deleteFileNamed: self backupFile.	! !!ScratchFrameMorph methodsFor: 'startup' stamp: 'KK 10/10/2017 12:26'!processSettingsFile	"Process settings from the Scratch.ini file."	| lang settings k ratio |	self class setVisibleDrives: nil.	lang _ nil.	ratio _ 1.	ScratchFileChooserDialog clearFolderCache. "clear homeDir and last folder cache"	PathSettingArgMorph initDefaultPath.	settings _ self readSettingsFile.	settings associationsDo: [:assoc |		k _ assoc key.		k = 'exportlistpath' ifTrue: [PathSettingArgMorph setDefaultPath: assoc value.].		k = 'calibinfostore' ifTrue: [self setCalibInfoLocation: assoc value asNumber].		k = 'fontmagnification' ifTrue: [ratio _ assoc value asNumber].		"k = 'tabletmode' ifTrue: [self setTabletMode: (assoc value) ~= '0']."		k = 'language' ifTrue: [lang _ assoc value].		k = 'home' ifTrue: [ScratchFileChooserDialog setHomeDir: assoc value].		k = 'visibledrives' ifTrue: [self class setVisibleDrives: assoc value]].	lang ifNil: [lang _ ScratchTranslator guessLanguage].	self setLanguage: lang.	self fontMagnifyBy: ratio.! !!ScratchFrameMorph methodsFor: 'startup' stamp: 'KK 10/25/2017 10:47'!readAutosavedProgram	| response backupFile tempProjectDirectory |	tempProjectDirectory _ self projectDirectory.	" Push work directory "	" Check to exist auto save file "	backupFile _ self backupFile.	(FileDirectory new fileExists: backupFile) ifTrue: [		"ask the user if they want to save the current project"		response _ DialogBoxMorph ask: 'There is an autosaved program. Do you want to open it?'.		response ifTrue: [			self openScratchProjectNamed: backupFile.		] ifFalse: [		].		(FileDirectory new) deleteFileNamed: backupFile.		].	" pop work directory and set "	projectDirectory _ FileDirectory on: tempProjectDirectory pathName.	ScratchFileChooserDialog setLastFolderTo: projectDirectory forType: #project.! !!ScratchFrameMorph methodsFor: 'startup' stamp: 'sk 3/9/2017 11:06'!readSettingsFile	"Read my settings file and answer a Dictionary of settings."	"ScratchFrameMorph new readSettingsFile"	| f dict s tokens k |	f _ FileStream readOnlyFileNamedOrNil: 'Block.ini'.	f ifNil: [^ Dictionary new].	dict _ Dictionary new.	f contentsOfEntireFile lines do: [:line |		s _ line collect: [:c | (c asciiValue < 32) ifTrue: [Character space] ifFalse: [c]].		tokens _ s findTokens: '='.		k _ tokens first withBlanksTrimmed asLowercase.		tokens size = 2			ifTrue: [dict at: k put: tokens second withBlanksTrimmed]			ifFalse: [dict at: k put: '1']].	^ dict! !!ScratchFrameMorph methodsFor: 'startup' stamp: 'KK 11/16/2017 15:14'!startup	| startupFileNames fileName arg presentationMode |	HostSystemMenus startUp.	HostSystemMenus menuBarControler reviseHostMenus.	ScriptableScratchMorph randomInit.	ScratchTranslator detectRenderPlugin.	ScratchTranslator importLanguagesList.	self processSettingsFile.	self readDefaultNotes.	self updateProjectName.	shuffledCostumeNames _ nil.	author _ ''.	loginName _ ''.	loginPassword _ ''.	justSaved _ true.	presentationMode _ false.	"Reset BoardStatus"	BoardStatus _ -1.	startupFileNames _ InputSensor startupFileNames asOrderedCollection.	2 to: 10 do: [:i |		arg _ Smalltalk getSystemAttribute: i.		(arg notNil and: [arg size > 0]) ifTrue: [			startupFileNames addLast: (ScratchPlugin primShortToLongPath: arg)]].	startupFileNames do: [:n |		(n asLowercase = 'presentation') ifTrue: [presentationMode _ true].		(n asLowercase = 'fullscreen') ifTrue: [TakeOverScreen _ true]].	TakeOverScreen ifTrue: [		Smalltalk fullScreenMode: true.		World restoreDisplay].	self enterQuarterModeIfSmallScreen.	fileName _ startupFileNames		detect: [:fn |			(fn asLowercase endsWith: '.bpdc')]		ifNone: [nil].	fileName ifNotNil: [		presentationMode ifTrue: [Display fillColor: Color black].		self openScratchProjectNamed: fileName.		presentationMode ifTrue: [self enterPresentationMode; shoutGo].		^ self].	viewerPane currentCategory: 'motion'.	self setDefaultSprite.	self newScratchProject."	self readAutosavedProgram."	fileName _ startupFileNames		detect: [:fn | fn asLowercase endsWith: '.sprite']		ifNone: [^ self].	"open a .sprite file"	workPane submorphs do: [:m | (m isKindOf: ScratchSpriteMorph) ifTrue: [m deleteSprite]].	self importSpriteOrProject: fileName.! !!ScratchFrameMorph methodsFor: 'file read/write' stamp: 'KK 10/13/2017 16:50'!autoSaveScratchProject: fName	| tempProjectDirectory |	tempProjectDirectory _ self projectDirectory.	self updateLastHistoryEntryIfNeeded.	projectDirectory _ FileDirectory on: (FileDirectory dirPathFor: fName).	projectName _ FileDirectory localNameFor: fName.	projectInfo at: 'author' put: author.	" saving calibration info "	CalibInfoLocation = 1 ifTrue: [		projectInfo at: 'calibsv' put: SvCalib.		projectInfo at: 'calibdc' put: DCCalib].	self updateHistoryProjectName: projectName op: 'save'.	self writeScratchProject.	projectDirectory _ tempProjectDirectory.! !!ScratchFrameMorph methodsFor: 'file read/write' stamp: 'KK 8/4/2017 14:45'!clearStage	self stopAll.	projectDirectory _ ScratchFileChooserDialog getDefaultFolderForType: #project.	projectName _ ''.	projectInfo _ Dictionary new.	self installNewProject: ScratchStageMorph new.	self initializeWatcherPositions.	justSaved _ true.! !!ScratchFrameMorph methodsFor: 'file read/write' stamp: 'KK 7/26/2017 14:10'!extractBPEInfoFrom: aByteArray	"Answer a Scratch info dictionary from the given ByteArray. Answer an empty dictionary if it is an old project."	| s version |	s _ ReadStream on: aByteArray.	version _ ObjStream scratchFileVersionFrom: (s next: 10) asString.	(version = 1) | (version = 2)		ifTrue: [			s skip: IOPort size.			s skip: 4.  "skip info header byte count"			^ ObjStream new readObjFrom: s showProgress: false]		ifFalse: [^ Dictionary new].! !!ScratchFrameMorph methodsFor: 'file read/write' stamp: 'KK 7/20/2017 10:52'!extractInfoFrom: aByteArray	"Answer a Scratch info dictionary from the given ByteArray. Answer an empty dictionary if it is an old project."	| s version |	s _ ReadStream on: aByteArray.	version _ ObjStream scratchFileVersionFrom: (s next: 10) asString.	(version = 1) | (version = 2)		ifTrue: ["			s skip: IOPort size."			s skip: 4.  "skip info header byte count"			^ ObjStream new readObjFrom: s showProgress: false]		ifFalse: [^ Dictionary new].! !!ScratchFrameMorph methodsFor: 'file read/write' stamp: 'KK 7/24/2017 14:28'!extractProjectFrom: aByteArray	"Answer a Scratch project (i.e. a ScratchStageMorph possibly containing sprites) from the given ByteArray. Answer nil if the project cannot be unpacked."	| s version proj prev dialogBox |	s _ ReadStream on: aByteArray.	version _ ObjStream scratchFileVersionFrom: (s next: 10) asString.	version = 0 ifTrue: [		s position: 0.		proj _ ObjStream new readObjFrom: s showProgress: true].	(version = 1) | (version = 2) ifTrue: [		versionConflict _ false."		s _ self setIOPortFrom: s put: true."	" Copy pin assing information to IOPort Array "		"-----------------------------------"		" Skip header data and check BPE version "		s uint32.						" skip header size "		ObjStream new readObjFrom: s.	" skip Object Table "		prev _ s position.				" store current position "		versionConflict ifTrue: [			" Block Programming Environment ver1.X - "			" Display Message "			dialogBox _ DialogBoxMorph new.			dialogBox withButtonsForYes: false no: false okay: true cancel: false.			dialogBox title: 'This project may not be able to properly open.'.			dialogBox message: 'Project you are trying to open might be using a block that can not be displayed in this programming environment. It is recommended that you update the programming environment to the latest version.'.			dialogBox openInWorld.		" Display Dialogbox "			dialogBox centerOnScreen.	" Set center position "			dialogBox world doOneCycle.			s position:prev.	" Back to Object Table header "		]		ifFalse: [			" Block Programming Environment ver1.0 "			s position:prev.	" Back to Object Table header "		].		"-----------------------------------"		proj _ ObjStream new readObjFrom: s showProgress: true].	(proj isKindOf: ScratchStageMorph) ifFalse: [		version > 2			ifTrue: [self error: 'Project created by a later version of Scratch']			ifFalse: [self error: 'Problem reading project.'].		^ nil].	ScriptableScratchMorph buildBlockSpecDictionary.	proj allMorphsDo: [:m |		(m isKindOf: ScriptableScratchMorph) ifTrue: [  "covert to new blocks"			m convertStacksToTuples.			m convertTuplesToStacks]].	^ proj! !!ScratchFrameMorph methodsFor: 'file read/write' stamp: 'KK 8/3/2017 09:18'!extractScriptFrom: aByteArray	"Answer a Scratch project (i.e. a ScratchStageMorph possibly containing sprites) from the given ByteArray. Answer nil if the project cannot be unpacked."	| s version proj btype |	s _ ReadStream on: aByteArray.	version _ ObjStream scratchFileVersionFrom: (s next: 10) asString.	version = 0 ifTrue: [		s position: 0.		proj _ ObjStream new readObjFrom: s showProgress: true].	(version = 1) | (version = 2) ifTrue: [		versionConflict _ false.		btype _ self checkIO: s.		btype = BoardType ifFalse: [			"ErrorMessage show: 200."			^ self error: 'Different board type'].		versionConflict ifTrue: [			" Block Programming Environment ver1.X - "			"ErrorMessage show: 201."			^ self error: 'Different board type'.].		s skip: s uint32.  "skip header"		proj _ ObjStream new readObjFrom: s showProgress: true].	proj class = ScratchStageMorph ifFalse: [		version > 2			ifTrue: [self error: 'Project created by a later version of Scratch']			ifFalse: [self error: 'Problem reading project.'].		^ nil].	ScriptableScratchMorph buildBlockSpecDictionary.	proj allMorphsDo: [:m |		(m isKindOf: ScriptableScratchMorph) ifTrue: [  "covert to new blocks"			m convertStacksToTuples.			m convertTuplesToStacks]].	^ proj! !!ScratchFrameMorph methodsFor: 'file read/write' stamp: 'KK 7/26/2017 17:01'!getIOPort: aByteArray	"Answer a Scratch project (i.e. a ScratchStageMorph possibly containing sprites) from the given ByteArray. Answer nil if the project cannot be unpacked."	| s version |	s _ ReadStream on: aByteArray.	version _ ObjStream scratchFileVersionFrom: (s next: 10) asString.	(version = 1) | (version = 2) ifTrue: [		self setIOPortFrom: s put: true.	" Copy pin assing information to IOPort Array "	].! !!ScratchFrameMorph methodsFor: 'file read/write' stamp: 'KK 10/20/2017 16:50'!importScratchProject	"Allow the user to select a project to open, then merge that project's sprites with thecurrent project."	| response |	self closeMediaEditorsAndDialogs ifFalse: [^ self].	self stopAll.	response _ ScratchFileChooserDialog		chooseExistingFileType: #project		extensions: #(scratch sb bpd bpd2 bpdc)		title: 'Import Project'.	response ifNil: [^ self].	self importSpriteOrProject: response.! !!ScratchFrameMorph methodsFor: 'file read/write' stamp: 'KK 1/13/2015 15:58'!importScripts	"Allow the user to select a project to open, then merge that project's sprites with thecurrent project."	| response ltmp |	self closeMediaEditorsAndDialogs ifFalse: [^ self].	self stopAll.	response _ ScratchFileChooserDialog		chooseExistingFileType: #project		extensions: #(bpd)		title: 'Import Project'.	response ifNil: [^ self].	self importScripts: response.	ltmp _ ScratchTranslator currentLanguage.	self setLanguage: 'atc'. 	self setLanguage: ltmp. ! !!ScratchFrameMorph methodsFor: 'file read/write' stamp: 'KK 7/24/2017 20:33'!importWorkpane: importedStage	| defaultForm defaultSound oldName oldPosition |	"fix references to old stage"	importedStage allMorphsDo: [:m |		(m isKindOf: WatcherMorph) ifTrue: [			m mapReceiver: importedStage to: workPane.			self restoreWatcher: m].		(m isKindOf: ScriptableScratchMorph) ifTrue: [			self restoreVariableBlockMorphsOf: m.			m blocksBin submorphs do: [:stack |				(stack isKindOf: BlockMorph) ifTrue: [					stack blockSequence do: [:b | b mapReceiver: importedStage to: workPane]]]]].	"add global variables from importated stage to my stage"	importedStage varNames do: [:v |		workPane addVariable: v value: (importedStage getVar: v)].	"add imported stage scripts"	importedStage blocksBin submorphs do: [:stack |		(stack isKindOf: BlockMorph) ifTrue: [workPane addStack: stack fullCopy]].	"add imported background costumes and scripts to my stage, filtering out default items"	defaultForm _ workPane defaultImageMedia form hibernate.	defaultSound _ SoundMedia new sound.	importedStage media do: [:media |		(media isImage and: [media form hibernate bits ~= defaultForm bits])			ifTrue: [workPane addMediaItem: media].		(media isSound and: [media sound samples ~= defaultSound samples])			ifTrue: [workPane addMediaItem: media]].	importedStage submorphs reverseDo: [:m |		(m isKindOf: ScratchSpriteMorph) ifTrue: [					oldName _ m objName.					oldPosition _ m position - m owner position.					self addAndView: m.  "assigns a new name"					m objName: oldName.					m position: workPane topLeft + oldPosition.		].	 	(m isKindOf: ArduinoScratchSpriteMorph) 			ifTrue: [				m position: m position + m costume rotationCenter.				self restoreArduinoSprite: m.]].	workPane layoutChanged.! !!ScratchFrameMorph methodsFor: 'file read/write' stamp: 'KK 2/6/2018 11:55'!installNewProject: newWorkpane	"Called after creating or reading a new project to clear the process scheduler, pick an object to view, clear the library thumbnails, and perform other housekeeping."	| viewTarget sb cb |	self stopAll.	IOPort ifNil: [ IOPort _ Array new:18. ].	SvCalib ifNil: [ SvCalib _ Array new:8. ].	DCCalib ifNil: [ DCCalib _ Array new:2. ].	SvDegree ifNil: [ SvDegree _ Array new:8. ].	SvDegreeTemp ifNil: [ SvDegreeTemp _ Array new:8. ].	SvSentAlready ifNil: [ SvSentAlready _ Array new:8. ].	SvCalib atAllPut: 0.	DCCalib atAllPut: 100.	SvDegree atAllPut: 90.	SvDegreeTemp atAllPut: 90.	SvSentAlready atAllPut: false.	ServomotorSynchroMotion _ false.	newWorkpane class = ScratchStageMorph		ifFalse: [^ self inform: 'Incompatible Scratch file format'].	"self exitScratchSession."	workPane scratchServer ifNotNil: [		workPane scratchServer clearCaches.		workPane scratchServer stage: newWorkpane.		newWorkpane scratchServer: workPane scratchServer].	newWorkpane isQuarterSize: workPane isQuarterSize.	newWorkpane bounds: workPane bounds.	newWorkpane midiPortNum: workPane midiPortNum.	workPane closeMIDI.	"use the same sensorboard for the new project"	sb _ workPane sensorBoard.	newWorkpane submorphs do: [:m |		(m isKindOf: SensorBoardMorph) ifTrue: [			sb position: m position.			newWorkpane replaceSubmorph: m by: sb.			sb tryToOpenPort]].	newWorkpane sensorBoard: sb.	"use the same sensorboard for the new project"	sb _ workPane studuinoBoard.	newWorkpane submorphs do: [:m |		(m isKindOf: StuduinoSensorBoardMorph) ifTrue: [			sb position: m position.			newWorkpane replaceSubmorph: m by: sb.			sb tryToOpenPort]].	newWorkpane studuinoBoard: sb.	"use the same calibrationboard for the new project"	cb _ workPane motorCalibrationBoard.	newWorkpane submorphs do: [:m |		(m isKindOf: MotorCalibMorph2) ifTrue: [			cb position: m position.			newWorkpane replaceSubmorph: m by: cb.			cb tryToOpenPort]].	newWorkpane motorCalibrationBoard: cb.	workPane owner replaceSubmorph: workPane by: newWorkpane.	workPane _ newWorkpane.	self fixByteReversedSounds.	"fix sprite positions (backward compatability)"	workPane submorphs do: [:m |		(m isKindOf: WatcherMorph) ifTrue: [m convertFromOldWatcher].		(m respondsTo: #costume) ifTrue: [			m position: m position + m costume rotationCenter]. "fix up positions"		m layoutChanged].	workPane layoutChanged.	"reset timer"	ScriptableScratchMorph resetTimer.	"pick an object view, or view the background if there is no other"	viewTarget _ workPane.	workPane submorphs do: [:m |		(m respondsTo: #scripts) ifTrue: [			m scripts size >= viewTarget scripts size ifTrue: [viewTarget _ m]]].	viewTarget viewBlocksAndScripts.	"populate the sprites list if it is empty (backward compatability)"	workPane sprites isEmpty ifTrue: [		workPane submorphs do: [:m |			(m isKindOf: ScriptableScratchMorph) ifTrue: [workPane sprites addLast: m]]].	scriptsPane tabPane currentTab: 'Scripts'.	libraryPane clearLibrary.	workPane clearPenTrails.	self updateProjectName.	ScratchProcess blockHighlightMSecs: 1.	ScratchPrompterMorph clearLastAnswer.	"start Arduino sensorboard if it has been restored"	self restoreArduinoSprites.	(projectInfo at: 'isHosting' ifAbsent: [false]) ifTrue: [		self enableRemoteSensors].	(projectInfo at: 'hasMotorBlocks' ifAbsent: [false]) ifTrue: [		self showMotorBlocks].	(projectInfo includesKey: 'penTrails') ifTrue: [		workPane penTrailsForm: (projectInfo at: 'penTrails')].	(projectInfo at: 'hasStuduinoBlocks' ifAbsent: [false]) ifTrue: [		self showStuduinoBlocks].	Clipboard _ nil.	World cleanseStepList.  "make sure garbage collect can clean up the old sprites"	Smalltalk garbageCollect.  "get rid of old sprite instances"	self world ifNotNil: [self world startSteppingSubmorphsOf: self].	ScriptableScratchMorph scratchOrigin: workPane center.	justSaved _ true.! !!ScratchFrameMorph methodsFor: 'file read/write' stamp: 'KK 7/24/2017 20:03'!installScratchWorkpane: newWorkpane"install a project made with Scratch environment. Called after creating or reading a new project.As the new workpane is an instance of ScratchStageMorph instead of ArduinoScratchStageMorph, it can't be replaced directly. So, creates a new project, removes the default sprite and then imports the new workpane"	self newScratchProject."	(workPane arduinoSprites at: 1) undoableDeleteSprite." "remove default arduino sprite"	self importWorkpane: newWorkpane. ! !!ScratchFrameMorph methodsFor: 'file read/write' stamp: 'KK 12/26/2017 13:51'!moveScriptFromStageToStuduinoSprite	" I move  "	workPane blocksBin submorphs do: [:stack |		(stack isKindOf: BlockMorph) ifTrue: [			workPane arduinoSprites first addStack: stack fullCopy.		].	].	workPane blocksBin submorphs do: [:stack |		(stack isKindOf: BlockMorph) ifTrue: [			stack delete.		].		(stack isKindOf: ScratchCommentMorph) ifTrue: [			stack delete.		].	].! !!ScratchFrameMorph methodsFor: 'file read/write' stamp: 'KK 10/20/2017 16:40'!nameFromFileName: fileName	"Return the given Scratch file name without the trailing .sb or .scratch extension, if it has one. Ensure the the result is UTF8."	| s |	s _ fileName.	(s asLowercase endsWith: '.scratch') ifTrue: [s _ s copyFrom: 1 to: s size - 8].	(s asLowercase endsWith: '.sb') ifTrue: [s _ s copyFrom: 1 to: s size - 3].	(s asLowercase endsWith: '.bpd') ifTrue: [s _ s copyFrom: 1 to: s size - 4].	(s asLowercase endsWith: '.bpd2') ifTrue: [s _ s copyFrom: 1 to: s size - 5].	(s asLowercase endsWith: '.bpdc') ifTrue: [s _ s copyFrom: 1 to: s size - 5].	s isUnicode ifFalse: [s _ UTF8 withAll: s].	^ s! !!ScratchFrameMorph methodsFor: 'file read/write' stamp: 'KK 10/16/2017 10:59'!openScratchProject	"Allow the user to select a project to open, then open that project."	| response newProj |	self closeMediaEditorsAndDialogs ifFalse: [^ self].	self stopAll.	(DuringTest = true)	" During a test ? "	ifTrue: [ self testModeOff. ].	" yes -> off "	(justSaved or: [self projectIsEmpty]) ifFalse: [		"ask the user if they want to save the current project"		response _ DialogBoxMorph askWithCancel: 'Save the current project?'.		response = #cancelled ifTrue: [^ self].		response ifTrue: [self saveScratchProjectNoDialog]].	response _ ScratchFileChooserDialog openScratchFileFor: self.	response = #cancelled ifTrue: [^ self].	(response isKindOf: String) ifTrue: [  "read the contents of a local file"		^ self openScratchProjectNamed: response].	(response isKindOf: ByteArray) ifTrue: [		[projectInfo _ self extractInfoFrom: response] ifError: [projectInfo _ Dictionary new].		[newProj _ self extractProjectFrom: response] ifError: [^ self].		self installNewProject: newProj.		projectDirectory _ ScratchFileChooserDialog getDefaultFolderForType: #project].! !!ScratchFrameMorph methodsFor: 'file read/write' stamp: 'KK 10/16/2017 11:01'!openScratchProjectBPE	"Allow the user to select a project to open, then open that project."	| response newProj |	self closeMediaEditorsAndDialogs ifFalse: [^ self].	self stopAll.	(DuringTest = true)	" During a test ? "	ifTrue: [ self testModeOff. ].	" yes -> off "	(justSaved or: [self projectIsEmpty]) ifFalse: [		"ask the user if they want to save the current project"		response _ DialogBoxMorph askWithCancel: 'Save the current project?'.		response = #cancelled ifTrue: [^self].		response ifTrue: [self saveScratchProjectNoDialog]].	response _ ScratchFileChooserDialog openScratchFileFor: self.	response = #cancelled ifTrue: [^ self].	(response isKindOf: String) ifTrue: [  "read the contents of a local file"		^ self openScratchProjectNamed: response."		(response endsWith: '.bpd') ifFalse: [			^ self openScratchProjectNamed: response.		] ifTrue: [			self newScratchProject.			^ self importSpriteOrProject: response.		]."	].	(response isKindOf: ByteArray) ifTrue: [		[projectInfo _ self extractInfoFrom: response] ifError: [projectInfo _ Dictionary new].		[newProj _ self extractProjectFrom: response] ifError: [^ self].	self installNewProject: newProj.	projectDirectory _ ScratchFileChooserDialog getDefaultFolderForType: #project].! !!ScratchFrameMorph methodsFor: 'file read/write' stamp: 'KK 12/26/2017 14:07'!openScratchProjectNamed: fName	"Open a Scratch project with the given name."	| f projData newProj dir fn |	self closeMediaEditorsAndDialogs ifFalse: [^ self].	fn _ fName.	f _ FileStream readOnlyFileNamedOrNil: fn. 	f ifNil: ["try a different encoding, fixes a Firefox bug, -Jens"		fn _ fName isoLatinToMac asUTF8.		f _ FileStream readOnlyFileNamedOrNil: fn.		f ifNil: [^ self inform: 'Could not read' withDetails: fName]].	[	projData _ f binary contentsOfEntireFile."		newProj _ self extractProjectFrom: projData.		projectInfo _ self extractInfoFrom: projData."		(fName endsWith: '.bpd') ifTrue: [			self getIOPort: projData.			newProj _ self extractScriptFrom: projData.			projectInfo _ self extractBPEInfoFrom: projData.		] ifFalse: [			newProj _ self extractProjectFrom: projData.			projectInfo _ self extractInfoFrom: projData.		].	] ifError: [:err :rcvr |		err = 'unsupported0' ifTrue: [			err _ 'Project created by Studuino mini'.			^ self inform: 'Could not load project. Project created for Studuino mini.' withDetails: ''].		err = 'Different board type' ifTrue: [			^ self inform: 'Could not load project. Project created using Optional Parts from Studuino 2.0.' withDetails: ''].		 ^ self inform: 'Could not read project; file may be damaged' withDetails: '(', err, ')'].	dir _ FileDirectory dirPathFor: fn.	projectDirectory _ FileDirectory on: dir.	ScratchFileChooserDialog setLastFolderTo: projectDirectory forType: #project.	projectName _ FileDirectory localNameFor: fn.	self installNewProject: newProj.	(fName endsWith: '.bpd') ifTrue: [		self moveScriptFromStageToStuduinoSprite.	].	self initializeWatcherPositions.	viewerPane updateContents.	" updating calibration info "	CalibInfoLocation = 1 ifTrue: [		(projectInfo includesKey: 'calibsv') ifTrue: [			SvCalib _ (projectInfo at: 'calibsv')].		(projectInfo includesKey: 'calibdc') ifTrue: [			DCCalib _ (projectInfo at: 'calibdc')].		self updateCalibInfo].	(projectInfo includesKey: 'stdn pin assign') ifTrue: [		IOPort _ (projectInfo at: 'stdn pin assign')].Transcript show:IOPort;cr.	" updating I/O "	self updateIOInfo.		" Reset view pane and blocks at script area. "	self viewerPane refresh.	self setLanguage: (ScratchTranslator currentLanguage).! !!ScratchFrameMorph methodsFor: 'file read/write' stamp: 'KK 10/20/2017 19:17'!saveScratchProject	| fName result |	self closeMediaEditorsAndDialogs ifFalse: [^ self].	self stopAll.	(DuringTest = true)	" During a test ? "	ifTrue: [ self testModeOff. ].	" yes -> off "	TabletMode ifTrue: [		self sendMessageToBMnoBlocking: 'SHOWKEYPAD'].	fName _ ScratchFileChooserDialog saveScratchFileFor: self.	TabletMode ifTrue: [		self sendMessageToBMnoBlocking: 'HIDEKEYPAD'].	(fName size = 0 or: [fName = #cancelled]) ifTrue: [^ self].	[(result _ ScratchFileChooserDialog confirmFileOverwriteIfExisting: fName) = false] whileTrue: [		TabletMode ifTrue: [			self sendMessageToBMnoBlocking: 'SHOWKEYPAD'].		fName _ ScratchFileChooserDialog saveScratchFileFor: self.		TabletMode ifTrue: [			self sendMessageToBMnoBlocking: 'HIDEKEYPAD'].		(fName size = 0 or: [fName = #cancelled]) ifTrue: [^ self]].	(result = #cancelled) ifTrue: [^ self].	self updateLastHistoryEntryIfNeeded.	fName _ (self nameFromFileName: fName), '.bpdc'.	projectDirectory _ FileDirectory on: (FileDirectory dirPathFor: fName).	projectName _ FileDirectory localNameFor: fName.	projectInfo at: 'author' put: author.	" saving calibration info "	CalibInfoLocation = 1 ifTrue: [		projectInfo at: 'calibsv' put: SvCalib.		projectInfo at: 'calibdc' put: DCCalib].	self updateHistoryProjectName: projectName op: 'save'.	self writeScratchProject.	self deleteBackupFile.! !!ScratchFrameMorph methodsFor: 'file read/write' stamp: 'KK 10/20/2017 16:41'!saveScratchProjectBPE	| fName result |	self closeMediaEditorsAndDialogs ifFalse: [^ self].	self stopAll.	(DuringTest = true)	" During a test ? "	ifTrue: [ self testModeOff. ].	" yes -> off "	TabletMode ifTrue: [		self sendMessageToBMnoBlocking: 'SHOWKEYPAD'].	fName _ ScratchFileChooserDialog saveScratchFileFor: self.	TabletMode ifTrue: [		self sendMessageToBMnoBlocking: 'HIDEKEYPAD'].	(fName size = 0 or: [fName = #cancelled]) ifTrue: [^self].	[(result _ ScratchFileChooserDialog confirmFileOverwriteIfExisting: fName) = false] whileTrue: [		TabletMode ifTrue: [			self sendMessageToBMnoBlocking: 'SHOWKEYPAD'].		fName _ ScratchFileChooserDialog saveScratchFileFor: self.		TabletMode ifTrue: [			self sendMessageToBMnoBlocking: 'HIDEKEYPAD'].		(fName size = 0 or: [fName = #cancelled]) ifTrue: [^self]].	(result = #cancelled) ifTrue: [^self].	self updateLastHistoryEntryIfNeeded.	fName _ (self nameFromFileName: fName), '.bpdc'.	projectDirectory _ FileDirectory on: (FileDirectory dirPathFor: fName).	projectName _ FileDirectory localNameFor: fName.	projectInfo at: 'author' put: author.	" saving calibration info "	CalibInfoLocation = 1 ifTrue: [		projectInfo at: 'calibsv' put: SvCalib.		projectInfo at: 'calibdc' put: DCCalib].	self updateHistoryProjectName: projectName op: 'save'.	self writeScratchProject.	self deleteBackupFile.! !!ScratchFrameMorph methodsFor: 'file read/write' stamp: 'KK 10/20/2017 16:41'!saveScratchProjectNoDialog	| fName dir |	(DuringTest = true)	" During a test ? "	ifTrue: [ self testModeOff. ].	" yes -> off "	self closeMediaEditorsAndDialogs ifFalse: [^ self].	projectName ifNil: [projectName _ ''].	fName _ self nameFromFileName: projectName.	dir _ ScratchFileChooserDialog getLastFolderForType: #project.	(fName size = 0 | (dir fileExists: fName , '.bpdc') not) ifTrue: [^ self saveScratchProject].	ScratchFileChooserDialog lastFolderIsSampleProjectsFolder ifTrue:  [^ self saveScratchProject].	self updateLastHistoryEntryIfNeeded.	projectName _ FileDirectory localNameFor: (fName, '.bpdc').  "ignore path, if any; save in the original project directory"	projectDirectory _ dir.	" saving calibration info "	CalibInfoLocation = 1 ifTrue: [		projectInfo at: 'calibsv' put: SvCalib.		projectInfo at: 'calibdc' put: DCCalib].	self updateHistoryProjectName: projectName op: 'save'.	self writeScratchProject.	self deleteBackupFile.! !!ScratchFrameMorph methodsFor: 'file read/write' stamp: 'KK 12/23/2017 15:26'!setIOPortFrom: fileStream put: flag	"Read I/O Port Information from .bpdc file"	| i id newBoardType |	(self hasStandardIO: fileStream) ifTrue: [		newBoardType _ 0.		IOPort _ Array new: 18]	ifFalse: [		BoardType = 0 ifTrue: [			self error: 'unsupported0'.			^ nil].		newBoardType _ 1.		IOPort _ Array new: 19].	newBoardType = BoardType ifFalse: [		BoardType _ newBoardType.		self sendBoardTypeToBM].	i _ 1.	IOPort size timesRepeat: [		id _ fileStream next.		flag ifTrue: [			(id > 21 and: [((id = StdnoPIDTemperature) | (id = StdnoPIDGyro)) not]) ifTrue: [				id _ 0.				versionConflict _ true.			].			IOPort at: i put: id.		]		ifFalse: [			(id > 21 and: [((id = StdnoPIDTemperature) | (id = StdnoPIDGyro)) not]) ifTrue: [				versionConflict _ true.			].		].		i _ i + 1.	].	^ fileStream.! !!ScratchFrameMorph methodsFor: 'file read/write' stamp: 'KK 7/24/2017 14:36'!storeProjectInfoOn: aBinaryStream	| s |	projectInfo at: 'thumbnail' put: workPane thumbnailForm.	projectInfo at: 'stdn version' put: 5.	projectInfo at: 'stdn pin assign' put: IOPort asByteArray.	s _ WriteStream on: (ByteArray new: 100000).	ObjStream new storeObj: projectInfo on: s.	aBinaryStream uint32: s size.	" save data size "	aBinaryStream nextPutAll: s contents.! !!ScratchFrameMorph methodsFor: 'file read/write' stamp: 'KK 10/30/2017 08:34'!updateHistoryProjectName: projName op: operation	"The given user is about to save or upload a project with the given name. Update the project history. operation is a string specifying the operation."	| timestamp tab history platform osVersion |	projectInfo removeKey: 'organization' ifAbsent: [].	"obsolete"	projectInfo at: 'scratch-version' put: Version.	timestamp _ (Date today printFormat: #(3 2 1 $- 1 1)), ' ', Time now print24.	tab _ String tab.	history _ projectInfo at: 'history' ifAbsent: [''].	history _ history, timestamp, tab.	history _ history, operation, tab, (self nameFromFileName: projName), tab, loginName, tab, author.	history _ history, String cr.	projectInfo at: 'history' put: history.	"record other data"	projectInfo at: 'scratch-version' put: Version.	projectInfo at: 'language' put: ScratchTranslator currentLanguage.	platform _ Smalltalk platformName.	platform ifNil: [platform _ 'unknown'].	'linux' = platform ifTrue: [		Display extent = (1200@900) ifTrue: [platform _ 'XO']].	projectInfo at: 'platform' put: platform.	osVersion _ Smalltalk osVersion.	osVersion ifNil: [osVersion _ 'unknown'].	projectInfo at: 'os-version' put: osVersion.	(workPane scratchServer notNil and:	 [workPane scratchServer isHosting])		ifTrue: [projectInfo at: 'isHosting' put: true]		ifFalse: [projectInfo removeKey: 'isHosting' ifAbsent: []]."	(self allBlocksString includesSubString: 'motor')		ifTrue: [projectInfo at: 'hasMotorBlocks' put: true]		ifFalse: [projectInfo removeKey: 'hasMotorBlocks' ifAbsent: []]."	(workPane showStuduinoBlocks)		ifTrue: [projectInfo at: 'hasStuduinoBlocks' put: true]		ifFalse: [projectInfo removeKey: 'hasStuduinoBlocks' ifAbsent: []].	" not use default motor block "	projectInfo removeKey: 'hasMotorBlocks' ifAbsent: [].	workPane penTrailsForm		ifNil: [projectInfo removeKey: 'penTrails' ifAbsent: []]		ifNotNil: [projectInfo at: 'penTrails' put: workPane penTrailsForm].	projectInfo at: 'boardType' put: BoardType.! !!ScratchFrameMorph methodsFor: 'file read/write' stamp: 'KK 7/24/2017 14:21'!writeScratchProject	"Write this Scratch project to the file named projectFile in the project directory. Called by saveScratchProject."	| oldScriptsTarget oldTab oldViewerCategory oldPosition saveError out |	self stopAll.	self world ifNotNil: [self world activeHand newKeyboardFocus: nil].  "terminates active editor"	"share duplicate sounds and images"	self canonicalizeSoundsBits: nil saveOriginal: false.	self canonicalizeImagesQuality: nil saveOriginal: false.	oldScriptsTarget _ scriptsPane target.	oldTab _ scriptsPane tabPane currentTab.	oldViewerCategory _ viewerPane currentCategory.	scriptsPane target: nil.	workPane updateSpritesList.	oldPosition _ workPane position.	workPane delete; position: 0@0.	self updatePenPositions.	ScriptableScratchMorph buildBlockSpecDictionary.	workPane allMorphsDo: [:m |		(m isKindOf: ScriptableScratchMorph) ifTrue: [			m blocksBin allMorphsDo: [:b |				(b isKindOf: BlockMorph) ifTrue: [b stop]].			m convertStacksToTuples]].	saveError _ nil.	[	out _ FileStream newFileNamed: (projectDirectory unusedNameStartingWith: 'tmp').		out			ifNil: [saveError _ 'Folder may be locked or read-only']			ifNotNil: [				out binary.				out nextPutAll: 'ScratchV02' asByteArray.				self storeProjectInfoOn: out.				ObjStream new storeObj: workPane on: out.				out close].	] ifError: [:err :rcvr |		out ifNotNil: [			[	out close.				projectDirectory deleteFileNamed: out localName.			] ifError: []].  "clean up, ignoring any errors"		saveError _ err].	workPane allMorphsDo: [:m |		(m isKindOf: ScriptableScratchMorph) ifTrue: [			m convertTuplesToStacks]].	self addMorph: (workPane position: oldPosition).	oldScriptsTarget ifNil: [oldScriptsTarget _ workPane].	oldScriptsTarget viewBlocksAndScripts.	scriptsPane tabPane currentTab: oldTab."	self restoreArduinoBoards."	viewerPane currentCategory: oldViewerCategory.	self updatePenPositions.	saveError		ifNil: [			justSaved _ true.			self updateProjectName.			projectDirectory deleteFileNamed: projectName.			[projectDirectory rename: out localName toBe: projectName]				ifError: [^ self inform: 'Save failed' withDetails: 'Is the folder read-only?' localized].			projectDirectory setMacFileNamed: projectName type: 'STsb' creator: 'MITS']		ifNotNil: [			projectName _ ''.			self inform: 'Save failed' withDetails: saveError].! !!ScratchFrameMorph methodsFor: 'uploading' stamp: 'sk 8/19/2016 12:50'!calibrateSvMotor2| notification res |[	 | s |	ScratchMenuTitleMorph setMenuEnable: false.	s _ self createBMHandle.	s ifNil: [^ self].	" Asking user to push a reset button. "	notification _ NotificationMessage show: 16r20.	"Waiting for RESET"	" Success in connection "	" -------------------------------------------------------------------- "	" Send message "	" -------------------------------------------------------------------- "	s sendCommand: 'CALIB'.	" Waiting for BM to transfer a testmode program. "	Transcript show: '---------- Recving ----------'; cr.	res _ self waitForBMResponse: s.	(res = '-1') ifTrue: [		notification ifNotNil: [notification no].		^ self].	notification no.	(BoardType = 2) ifTrue: [		(res = 'OK') ifFalse: [			" Getting error number "			res _ self waitForBMResponse: s.			(res = '-1') ifTrue: [				notification ifNotNil: [notification no].				^ self].			" Notify timeout error. "			ErrorMessage show: res asNumber.			^ self].		" Asking user to push a reset button. - 2 - "		notification _ NotificationMessage show: 16r20.	"Waiting for RESET"		" Waiting for BM to transfer a testmode program. "		Transcript show: '---------- Recving1 ----------'; cr.		res _ self waitForBMResponse: s.		(res = '-1') ifTrue: [			notification ifNotNil: [notification no].			^ self].		notification no].	(res = 'OK') ifTrue: [		"Waiting INITOK"		res _ self waitForBMResponse: s.		(res = '-1') ifTrue: [			notification ifNotNil: [notification no].			^ self].		(res = 'INITOK') ifTrue: [			" Do nothing "]		ifFalse: [			notification no.			ErrorMessage show: 100.			^ self]]	ifFalse: [		" Notify error. "		Transcript show: '---------- Error ----------'; cr.		"Getting an error number."		notification no.		res _ self waitForBMResponse: s.		(res = '-1') ifTrue: [			notification ifNotNil: [notification no].			^ self].		ErrorMessage show: res asNumber.		^ self].		" ---------------------------------------------------------------- "		" Waiting for the calibration done.                          "		" ---------------------------------------------------------------- "		notification no.		BoardStatus _ 3.		"Wait for finish calibration"		res _ self waitForBMResponse: s For: 36000.		(res = '-1') ifTrue: [			notification ifNotNil: [notification no].			^ self].		Transcript show: '---------- Recv message: '; show:res; show:' ----------'; cr.		(res = 'ERR') ifTrue: [			" Disconnect !! "			ErrorMessage show: 1].		" Send message "		Transcript show: '---------- Sending ----------'; cr.		s sendCommand: 'BREAK'.		s disconnect.		s destroy.	ScratchMenuTitleMorph setMenuEnable: true.] fork.! !!ScratchFrameMorph methodsFor: 'private' stamp: 'KK 12/23/2017 16:34'!checkIO: stream	| newBoardType ioSize id |	(self hasStandardIO: stream) ifTrue: [		newBoardType _ 0.		ioSize _ 18]	ifFalse: [		BoardType = 0 ifTrue: [			self error: 'unsupported0'.			^ nil].		newBoardType _ 1.		ioSize _ 19].	ioSize timesRepeat: [		id _ stream next.		(id > 21 and: [((id = StdnoPIDTemperature) | (id = StdnoPIDGyro)) not]) ifTrue: [			versionConflict _ true]].	^ newBoardType! !!ScratchFrameMorph methodsFor: 'private' stamp: 'sk 3/24/2016 17:58'!createBMHandle	| filename f port |	" I connect to Board Manager through localhost. "	" Get IP Port Number "	filename := 'portNumber.info'.	f _ FileStream fileNamed: filename.	f binary.	port _ f uint32.	f close.	^ self createBMHandle: port.! !!ScratchFrameMorph methodsFor: 'private' stamp: 'sk 3/24/2016 21:50'!createBMHandle: portNumber	| hostName hostAddr s |	" I connect to Board Manager through localhost. "	" Communicate with Board Manager "	Socket initializeNetwork.	hostName _ '127.0.0.1'.	" For interprocess communication "	hostAddr _ NetNameResolver addressForName: hostName timeout: 10.	hostAddr ifNil: [		ErrorMessage show: 0.		^ nil.	].	s _ SimpleClientSocket new.	Transcript show: '---------- Connecting BM ----------'; cr.	s connectTo: hostAddr port: portNumber.	s waitForConnectionUntil: "self standardDeadline" (Socket deadlineSecs: 10).	(s isConnected) ifFalse: [		s destroy.		ErrorMessage show: 1.		^ nil.	].	^ s.! !!ScratchFrameMorph methodsFor: 'private' stamp: 'KK 11/21/2017 17:25'!createBMUBCHandle: portNumber	| hostName hostAddr s |	" I connect to Board Manager through localhost. "	" Communicate with Board Manager "	Socket initializeNetwork.	hostName _ '127.0.0.1'.	" For interprocess communication "	hostAddr _ NetNameResolver addressForName: hostName timeout: 10.	hostAddr ifNil: [		ErrorMessage show: 0.		^ nil.	].	s _ SimpleUCDClientSocket new.	Transcript show: '---------- Connecting BM ----------'; cr.	s connectTo: hostAddr port: portNumber.	s waitForConnectionUntil: "self standardDeadline" (Socket deadlineSecs: 10).	(s isConnected) ifFalse: [		s destroy.		ErrorMessage show: 1.		^ nil.	].	^ s.! !!ScratchFrameMorph methodsFor: 'private' stamp: 'KK 11/21/2017 17:25'!createUSBConnectionDetectorHandle	| filename f port |	" I connect to Board Manager through localhost. "	" Get IP Port Number "	filename := 'portUSBConStat.info'.	f _ FileStream fileNamed: filename.	f binary.	port _ f uint32.	f close.	^ self createBMUBCHandle: port.! !!ScratchFrameMorph methodsFor: 'private' stamp: 'KK 7/4/2017 14:33'!enterQuarterModeIfSmallScreen	(Display width >= 980) & (Display height >= 555) ifTrue: [^ self].	viewMode = #normal ifTrue: [self enterQuarterMode].! !!ScratchFrameMorph methodsFor: 'private' stamp: 'sk 3/14/2017 11:12'!fontMagnifyBy: ratio	| s baseScale buttons targetIndex |	FontMagnification _ ratio.	baseScale _ 1.	s _ ScratchTranslator translationDict at: 'Font-Scale' ifAbsent: [''].	s size > 0 ifTrue: [		baseScale _ s asString asNumberNoError.		baseScale = 0 ifTrue: [baseScale _ 1]].  "non-number string"	buttons _ fontButtons submorphs select: [:each | each class == SimpleButtonMorph].	targetIndex _ #(1 1.5 2.0) indexOf: ratio.	buttons do: [:elm |		(buttons indexOf: elm) = targetIndex ifTrue: [			elm color: (Color lightOrange)]		ifFalse: [			elm color: (Color gray)]].	self setScaling: (baseScale * ratio)! !!ScratchFrameMorph methodsFor: 'private' stamp: 'sk 9/27/2016 19:27'!hasStandardIO: fileStream	| current check header |	current _ fileStream position.	fileStream position: current + 18 + 4.   "Standard IOPort size + header size"	check _ fileStream next: 5.	fileStream position: current.Transcript show: check; cr.	header _ #(16r4F 16r62 16r6A 16r53 16r01).	1 to: (header size) do: [:index |		(check at: index) = (header at: index) ifFalse: [			Transcript show: 'NG'; cr.			^ false]].	^ true! !!ScratchFrameMorph methodsFor: 'private' stamp: 'sk 7/7/2016 19:35'!initIOPort	""	| f filename arrayID index |	(BoardType = 0 or: [BoardType = 2]) ifTrue: [ " Studuino "Transcript show: 'Studuino selected.'.		arrayID _ #(1 1 0 0 0 0 2 2 2 0 21 21 21 21 0 0 0 0).]	ifFalse: [ "BoardType 1: Studuino mini"Transcript show: 'Studuino mini selected.'.		arrayID _ #(0 0 5 5 5 2 2 0 0 0 0 0 0 0 0 0 16 16 0).].Transcript show: 'size: ', arrayID size asString; cr.	" Redefine IOPOrt basing on arrayID size."	IOPort _ Array new: (arrayID size).	filename := 'Board.cfg'.	f _ StandardFileStream new open: filename forWrite: true.	f binary.	index _ 1.	arrayID do: [:elm |		IOPort at: index put: elm.		f nextPut: elm.		index _ index + 1.].	f close.! !!ScratchFrameMorph methodsFor: 'private' stamp: 'KK 2/13/2018 11:36'!initStuduinoGlobalVars	""	| arrayID svSize index |	(BoardType = 0 or: [BoardType = 2]) ifTrue: [ " Studuino "Transcript show: 'Studuino selected.'.		arrayID := Array new: 18.		index _ 1.		#(1 1 0 0 0 0 2 2 2 0 21 21 21 21 0 0 0 0) do: [:each |			arrayID at: index put: each.			index _ index + 1.		].		svSize _ 8.]	ifFalse: [ "BoardType 1: Studuino mini"Transcript show: 'Studuino mini selected.'.		arrayID := Array new: 19.		index _ 1.		#(0 0 5 5 5 2 2 0 0 0 0 0 0 0 0 0 0 0 0) do: [:each |			arrayID at: index put: each.			index _ index + 1.		].		svSize _ 5.].Transcript show: 'size: ', arrayID size asString; cr."Transcript show:IOPort;show:', ';show:arrayID;show:', ';show:svSize;cr."	" Redefine IOPOrt basing on arrayID size."	IOPort _ arrayID.	self updateIOInfo.	SvCalib _ Array new: svSize.	SvCalib atAllPut: 0.	DCCalib _ Array new: 2.	DCCalib atAllPut: 100.	CalibInfoLocation = 1 ifTrue: [		self updateCalibInfo].	SvDegree _ Array new: svSize.	SvDegree atAllPut: 90.	SvDegreeTemp _ Array new: svSize.	SvDegreeTemp atAllPut: 90.	SvSentAlready _ Array new: svSize.	SvSentAlready atAllPut: false.	ServomotorSynchroMotion _ false.! !!ScratchFrameMorph methodsFor: 'private' stamp: 'KK 2/13/2018 17:46'!isPortAvailable: portName	"Answer if the port indicated by portName is available."	| port result |	port _ SerialPort2 new openPortNamed: portName baud: 9600.	result _ port isOpen.	port close.	port _ nil.		^ result! !!ScratchFrameMorph methodsFor: 'private' stamp: 'sk 5/17/2017 14:38'!readCalibInfo	" Reading calibration info from files and updating the variables. [Files -> Variables] "	| filename f tmp tval |	"---------------------------------------------------------"	" Get Servomotor Info "	"---------------------------------------------------------"	filename _ '..\common\sv_offset_ini'.	f _ StandardFileStream fileNamed: filename.	f binary.	tmp _ OrderedCollection new.	[f atEnd] whileFalse: [		tval _ f next.		" Convert an unsigned value to singed one."		(tval > 127) ifTrue: [			tval _ tval - 256].		tmp add: tval].	f close.	SvCalib _ Array newFrom: tmp.	"---------------------------------------------------------"	" Get DC motor Info "	"---------------------------------------------------------"	filename _ '..\common\dc_calib_ini'.	f _ StandardFileStream fileNamed: filename.	f binary.	tmp _ OrderedCollection new.	[f atEnd] whileFalse: [		tmp add: (f next)].	f close.	DCCalib _ Array newFrom: tmp.! !!ScratchFrameMorph methodsFor: 'private' stamp: 'sk 5/15/2017 17:13'!recordCalibInfoLocation: aString	"Record a location of calibration information in the settings file."	| fName f sz settings all |	fName _ FileDirectory default fullNameFor: 'Block.ini'.	f _ FileStream concreteStream new open: fName forWrite: true.	f ifNil: [^ self].	sz _ f size.	settings _ (f next: sz) lines.	settings _ settings reject: [:s | s asLowercase beginsWith: 'calibinfostore='].	settings _ settings reject: [:s | all _ s asByteArray asSet. (all size = 1) and: [all asArray first = 0]].	settings _ settings copyWith: ('CalibInfoStore=', aString).	f position: 0.	settings do: [:s | f nextPutAll: s, String crlf].	[f position < sz] whileTrue: [f nextPut: 0 asCharacter].	f close.! !!ScratchFrameMorph methodsFor: 'private' stamp: 'sk 3/14/2017 10:14'!recordFontMagnification: aString	"Record font magnification in the settings file."	| fName f sz settings all |	fName _ FileDirectory default fullNameFor: 'Block.ini'.	f _ FileStream concreteStream new open: fName forWrite: true.	f ifNil: [^ self].	sz _ f size.	settings _ (f next: sz) lines.	settings _ settings reject: [:s | s asLowercase beginsWith: 'fontmagnification='].	settings _ settings reject: [:s | all _ s asByteArray asSet. (all size = 1) and: [all asArray first = 0]].	settings _ settings copyWith: ('FontMagnification=', aString).	f position: 0.	settings do: [:s | f nextPutAll: s, String crlf].	[f position < sz] whileTrue: [f nextPut: 0 asCharacter].	f close.! !!ScratchFrameMorph methodsFor: 'private' stamp: 'sk 10/21/2015 17:17'!recordVerify: aString	"Record my verify flag in the settings file."	| fName f sz settings all |	fName _ FileDirectory default fullNameFor: 'Block.ini'.	f _ FileStream concreteStream new open: fName forWrite: true.	f ifNil: [^ self].	sz _ f size.	settings _ (f next: sz) lines.	settings _ settings reject: [:s | s asLowercase beginsWith: 'verify='].	settings _ settings reject: [:s | all _ s asByteArray asSet. (all size = 1) and: [all asArray first = 0]].	settings _ settings copyWith: ('Verify=', aString).	f position: 0.	settings do: [:s | f nextPutAll: s, String crlf].	[f position < sz] whileTrue: [f nextPut: 0 asCharacter].	f close.! !!ScratchFrameMorph methodsFor: 'private' stamp: 'SeijiKagayama 10/31/2017 14:55'!refreshWorkPane	" Refresh workpane blocks. "	| tempJustSaved |	tempJustSaved := justSaved.	(workPane submorphs copyWith: workPane) do: [:m |		(m isKindOf: ScriptableScratchMorph) ifTrue: [			m convertStacksToTuples]].	viewerPane rebuildCategorySelectors.	(workPane submorphs copyWith: workPane) do: [:m |		(m isKindOf: ScriptableScratchMorph) ifTrue: [			m convertTuplesToStacks]].	self updatePanes.	self		view: scriptsPane target		tab: scriptsPane tabPane currentTab		category: viewerPane currentCategory.	justSaved := tempJustSaved! !!ScratchFrameMorph methodsFor: 'private' stamp: 'sk 9/28/2016 17:35'!selectBoardType	"Sending a message to BM for changing a boardtype."	| menu type bullet boards |"	bullet _ UTF8 withAll: ' '."	bullet _ '* '.	boards _ #('Studuino' 'Studuino mini' 'Studuino & mini').	menu _ CustomMenu new title: 'Select a board type.'.	(BoardType = 0) ifTrue: [		menu add: (bullet, (boards at:1)) action: 0.		menu add: (boards at:2) action: 1."		menu add: (boards at:3) action: 2"].	(BoardType = 1) ifTrue: [		menu add: (boards at:1) action: 0.		menu add: (bullet, (boards at:2)) action: 1."		menu add: (boards at:3) action: 2"].	(BoardType = 2) ifTrue: [		menu add: (boards at:1) action: 0.		menu add: (boards at:2) action: 1.		menu add: (bullet, (boards at:3)) action: 2].	type _ menu localize startUp.	type ifNil: [^ self].	(DuringTest = true) ifTrue: [	" During a test? "		self testModeOff].	BoardType _ type.	BoardStatus _ -1.	self newScratchProject.	self sendBoardTypeToBM.! !!ScratchFrameMorph methodsFor: 'private' stamp: 'sk 9/28/2016 10:39'!sendBoardTypeToBM	| s btype res |	" Connect to BM "	s _ self createBMHandle.	s ifNil: [^ self].	" Success in connection "	" Send message "	Transcript show: '---------- Sending ----------'; cr.	(BoardType == 0) ifTrue: [Transcript show: 'standard'; cr.		btype _ 'BOARD0'].	(BoardType == 1) ifTrue: [Transcript show: 'mini'; cr.		btype _ 'BOARD1'].	(BoardType == 2) ifTrue: [Transcript show: 'standard + mini'; cr.		btype _ 'BOARD2'].	s sendCommand: btype.	" Wait for BM's response. "	Transcript show: '---------- Recving ----------'; cr.	res _ self waitForBMResponse: s.	(res = '-1') ifTrue: [		^ self].Transcript show: 'board changed to ', res, '.'; cr.	s sendCommand: 'BREAK'.	s disconnect.	s destroy.! !!ScratchFrameMorph methodsFor: 'private' stamp: 'sk 8/23/2016 18:22'!sendFinishToBM	| s line |	" Communicate with Board Manager "	s _ self createBMHandle.	s ifNil: [^ false].	" Success in connection "	" Send message "	Transcript show: '---------- Sending ----------'; cr.	s sendCommand: 'FINISH'.	line _ self waitForBMResponse: s For: 2.	(line = '-1') ifTrue: [^ false].	^ true! !!ScratchFrameMorph methodsFor: 'private' stamp: 'KK 2/13/2018 19:06'!sendMessageToBM: aMessage	 | s line result |	" Communicate with Board Manager "	s _ self createBMHandle.	s ifNil: [^ self].	" Success in connection "	" Send message "	Transcript show: '---------- Sending ----------'; cr.	s sendCommand: aMessage.	" Wait for program creation and updating to end  "	Transcript show: '---------- Recving ----------'; cr.	line _ self waitForBMResponse: s.	(line = '-1') ifTrue: [^ self].	result _ line sansSemicolonSuffix.	line _ self waitForBMResponse: s.	(line = '-1') ifTrue: [^ self].	Transcript show:line;cr.	" Display message"	" Send message "	Transcript show: '---------- Sending BREAK----------'; cr.	s sendCommand: 'BREAK'.	s disconnect.	s destroy.! !!ScratchFrameMorph methodsFor: 'private' stamp: 'KK 7/12/2017 18:04'!sendMessageToBMnoBlocking: aMessage	 | s |	aMessage = 'SHOWKEYPAD' ifTrue: [ ^ nil ].	aMessage = 'HIDEKEYPAD' ifTrue: [ ^ nil ].	" Communicate with Board Manager "	s _ self createBMHandle.	s ifNil: [^ self].	" Success in connection "	" Send message "	Transcript show: '---------- Sending ----------'; cr.	s sendCommand: aMessage.	" Send message "	Transcript show: '---------- Sending BREAK----------'; cr.	s sendCommand: 'BREAK'.	s disconnect.	s destroy.! !!ScratchFrameMorph methodsFor: 'private' stamp: 'sk 5/2/2017 19:26'!setCalibInfoLocation: aNumber	CalibInfoLocation _ aNumber.! !!ScratchFrameMorph methodsFor: 'private' stamp: 'sk 3/14/2017 10:16'!setFontMagnification: aRatio	self fontMagnifyBy: aRatio.	self recordFontMagnification: aRatio asString.! !!ScratchFrameMorph methodsFor: 'private' stamp: 'sk 3/14/2017 11:21'!setLanguage: aString	"Set my language and update my blocks."	| tempJustSaved |	tempJustSaved _ justSaved.	(workPane submorphs copyWith: workPane) do: [:m |		(m isKindOf: ScriptableScratchMorph) ifTrue: [			m convertStacksToTuples]].	ScratchTranslator setLanguage: (ScratchTranslator isoCodeForName: aString).	viewerPane rebuildCategorySelectors.	(workPane submorphs copyWith: workPane) do: [:m |		(m isKindOf: ScriptableScratchMorph) ifTrue: [			m convertTuplesToStacks]].	self updatePanes.	self		view: scriptsPane target		tab: scriptsPane tabPane currentTab		category: viewerPane currentCategory.	justSaved _ tempJustSaved.	self fontMagnifyBy: FontMagnification.! !!ScratchFrameMorph methodsFor: 'private' stamp: 'KK 1/5/2018 17:35'!setPinAssign	| pab index resp |		" Set pin assing. "	pab := paBoard.	pab setFrameMorph: self.	pab setAllOff.	" set all checkbox off "	pab position: (self extent - pab extent) / 2.	"	self world addMorph: pab."	" Set check box "	index := 1.	IOPort		do: [ :parts | 			pab setCheckBoxOn: index partsID: parts.			index := index + 1 ].	index := 1.	IOPort		do: [ :parts | 			pab setComboBox: index partsID: parts.			index := index + 1 ].	" Waiting for the response. "	ScratchMenuTitleMorph setMenuEnable: false.	resp := pab getUserResponse.	resp		ifTrue: [ 			self viewerPane refresh.			self refreshWorkPane.			DuringTest ifTrue: [				self testModeOff.			].	 ].	ScratchMenuTitleMorph setMenuEnable: true.	self updateIOInfo.! !!ScratchFrameMorph methodsFor: 'private' stamp: 'sk 2/7/2017 11:59'!setScaling: aNumber	"Set my language and update my blocks."	| tempJustSaved |	ScratchTranslator fontScale: aNumber.	tempJustSaved _ justSaved.	(workPane submorphs copyWith: workPane) do: [:m |		(m isKindOf: ScriptableScratchMorph) ifTrue: [			m convertStacksToTuples]].	"ScratchTranslator setLanguage: (ScratchTranslator isoCodeForName: aString)."	viewerPane rebuildCategorySelectors.	(workPane submorphs copyWith: workPane) do: [:m |		(m isKindOf: ScriptableScratchMorph) ifTrue: [			m convertTuplesToStacks]].	self updatePanes.	self		view: scriptsPane target		tab: scriptsPane tabPane currentTab		category: viewerPane currentCategory.	justSaved _ tempJustSaved.! !!ScratchFrameMorph methodsFor: 'private' stamp: 'KK 11/21/2017 17:00'!setUSBConnectionStatus: on	| button text |	usbConnectionStatus _ on.	button _ nil.	text _ nil.	usbCSPanel submorphs do: [:each | 		(each isMemberOf: ToggleImage) ifTrue: [			button _ each.		].		(each isMemberOf: StringMorph) ifTrue: [			text _ each.		].	].	button ifNil: [ ^ self. ].	text ifNil: [ ^ self. ].	on ifTrue: [		button on.		text contents: ('Connect' localized).	]	ifFalse: [		button off.		text contents: ('Disconnect' localized).	].! !!ScratchFrameMorph methodsFor: 'private' stamp: 'KK 2/13/2018 19:11'!shiftToTestMode	"Move onto test mode for Studuino."	| s dialogBox line sb mid ival comPort msgID result partsID type documentsPath userProfilePath saveDirectory file saveFile backupFile |	Smalltalk isMacOSX ifFalse: [		" Auto save processing "		documentsPath _ FileDirectory on: (ScratchPlugin primGetFolderPath: 3).	" MyDocument Folder"		userProfilePath _ documentsPath parentDirectory.						" User Folder "		saveDirectory _ userProfilePath pathName.								" Object -> String "		saveDirectory _ saveDirectory, '\AppData\Local\Temp\Studuino\'.			" Set save directory "		[(FileDirectory new createDirectory: saveDirectory)] ifError: [ " Exist directory already " ].	" Create save directory "		file _ (self projectName), '.bpdc'.		" Create temporary file name "		saveFile _ saveDirectory, file. 			" Create temporary file. "		self autoSaveScratchProject: saveFile.	" Auto save under AppData folder "		" Rename project file name to backup file name "		file = 'backup.bpd2' ifFalse: [	" if project name defferent backup.bpd2 then rename project name to backup.bpd2 "			file _ 'backup.bpdc'.			backupFile _ saveDirectory, file.			(FileDirectory new) deleteFileNamed: backupFile.				(FileDirectory new) primRename: saveFile to: backupFile.		].	].		(BoardStatus = 1) ifFalse: [		s _ self createBMHandle.		s ifNil: [^ self].		" Display Status DialogBox "		dialogBox _ NotificationMessage show: 16r11.	"Shifting to testmode"						"---------- Success in connection ----------"		" Send message "		Transcript show: '---------- Sending ----------'; cr.		s sendCommand: 'TEST'.		" Wait for program creation and updating to end  "		Transcript show: '---------- Recving ----------'; cr.		line _ self waitForBMResponse: s.		(line = '-1') ifTrue: [			dialogBox ifNotNil: [dialogBox no].			^ self].Transcript show: line; cr.		comPort _ line sansSemicolonSuffix.		COMPort _ comPort.	" set class value "		line _ self waitForBMResponse: s.		(line = '-1') ifTrue: [			dialogBox ifNotNil: [dialogBox no].			^ self].		msgID _ line sansSemicolonSuffix.		" Hide Status DialogBox "Transcript show: comPort; show:', '; show: line; cr.	" Display message "		" Send message "		Transcript show: '---------- Sending ----------'; cr.		s sendCommand: 'BREAK'.		s disconnect.		s destroy.		BoardStatus _ 1.	] " End communication with Boardmanager."	ifTrue: [		comPort _ COMPort.		" Display Status DialogBox "		dialogBox _ NotificationMessage show: 16r11.	"Shifting to testmode"	].	(comPort = 'ERR') ifFalse: [	" Success to Transfer "		"Check if the port is available."		(self isPortAvailable: comPort) ifFalse: [			COMPort _ nil.			BoardStatus _ 0.			" Hide communication box "			dialogBox no.			self testMode.			^ self		].		" Connect with Arduino board ""sc _ workPane servoCalibrationBoard."		sb _ workPane studuinoBoard.		sb portIsOpen ifTrue: [Transcript show:'[ScratchFrameMorph::testMode] close & open port';cr.			sb closePort.		].		sb selectPort: comPort.		" Wait for run arduino board "			result _ sb isBoardSetup.		result ifFalse: [			" Hide communication box "			dialogBox no.			sb closePort.			BoardStatus _ 0.			self testMode.		]		ifTrue: [			"  Set sensorboard items "			sb addReadouts.			" Send port configuration "			mid _ 5.			0 to: 7 do: [: index |				partsID _ IOPort at: (11 + index).				((partsID = 17) | (partsID = 21)) ifTrue: [					type _ 0]. "Digital"				((partsID = 16) | (partsID = 18) | (partsID = 19)) ifTrue: [					type _ 1]. "Analog"				(partsID = 20) ifTrue: [					type _ 2]. "Accelerometer"				(partsID = 24) ifTrue: [					type _ 3]. "Temperature"				(partsID = 25) ifTrue: [					type _ 4]. "Gyro"				(partsID > 15) & (partsID < 26) ifTrue: [					ival _ 16r0100 + (type bitShift: 4) + index.					sb data:ival msgID:mid.					Transcript show: ival; cr]].			" Set A0 as digital input for dummy if no sensor is selected.			  It's necessary for preventing from the disconnection. "			(IOPort select: [:each | (each > 15) & (each < 25)]) size = 0				ifTrue: [ sb data: 16r0100 msgID: 5 ].			" Set Servomotors' degree connected Studuino. "			1 to: (SvDegree size) do: [ : i |				SvDegree at: i put: 90.				SvDegreeTemp at:i put:90.			].			ServomotorSynchroMotion _ false.			" Set servomotors 90 deg. with offsets. "			(3 to: 10) do: [:elm |				((IOPort at: elm) = 0) ifFalse: [					sb data: (DataCreation getServoWithOffsetFor: (elm - 3) degree: 90) msgID: 1]].			" Hide communication box "			dialogBox no.			self showStuduinoSensorBoard.			sb initSyncProc.			DuringTest _ true.		]	]	ifTrue: [		" Hide communication box "		dialogBox no.		BoardStatus _ 0.		ErrorMessage show: msgID asNumber.	].! !!ScratchFrameMorph methodsFor: 'private' stamp: 'sk 8/8/2016 12:48'!shiftToTestModeMini	"Move onto test mode for Studuino mini."	| s line sb res socketCommand port notification portCommand portSensor socketSensor |	(BoardStatus = 1) ifFalse: [		s _ self createBMHandle.		s ifNil: [^ self].		" Asking user to push a reset button. "		notification _ NotificationMessage show: 16r20.	"Waiting for RESET"		"---------- Success in connection ----------"		" Send message "		Transcript show: '---------- Sending TEST----------'; cr.		s sendCommand: 'TEST'.		" Waiting for BM to transfer a testmode program. "		Transcript show: '---------- Recving ----------'; cr.		line _ self waitForBMResponse: s.		(line = '-1') ifTrue: [			notification ifNotNil: [notification no].			^ self].		res _ line.		notification no.		notification _ NotificationMessage show: 16r11.	"Shifting to testmode"						(res = 'OK') ifTrue: [			line _ self waitForBMResponse: s.			(line = '-1') ifTrue: [				notification ifNotNil: [notification no].				^ self].			res _ line.			(res = 'INITOK') ifTrue: [				Transcript show: '---------- Sending TEST2S----------'; cr.				s sendCommand: 'TEST2S'.				line _ self waitForBMResponse: s.				(line = '-1') ifTrue: [						notification ifNotNil: [notification no].					^ self].				res _ line. "Waiting port number."				port _ res asNumber.]			ifFalse: [				notification no.				ErrorMessage show: 100.				^ self].]		ifFalse: [			" Notify error. "			Transcript show: '---------- Error ----------'; cr.			notification no.			line _ self waitForBMResponse: s.			(line = '-1') ifTrue: [					notification ifNotNil: [notification no].				^ self].			ErrorMessage show: line asNumber.			^ self].	].Transcript show: res; cr.	(port > 0) ifTrue: [	" Success to Transfer "		"Check if the port is available."		portCommand _ (port asNumber) bitAnd: 16rFFFF.		portSensor _ portCommand + ((port asNumber) bitShift: -16).		sb _ workPane sensorBoard.		sb socketIsOpen ifTrue: [Transcript show:'[ScratchFrameMorph::testMode] close & open port';cr.			sb closeSocket.		]."		sb socket: s."		s sendCommand: 'BREAK'.		s disconnect.		s destroy.		socketSensor _ self createBMHandle: portSensor.		socketSensor ifNil: [^ self.].		sb socket: socketSensor.		socketCommand _ self createBMHandle: port.		socketCommand ifNil: [^ self.].		sb socketCommand: socketCommand.		"  Set sensorboard items "		sb addReadouts.		" Send port configuration "		self showSensorBoard.		DuringTest _ true.	].	notification no.! !!ScratchFrameMorph methodsFor: 'private' stamp: 'KK 2/13/2018 19:07'!shiftToTestModeMini2	"Move onto test mode for Studuino mini."	| s line sb res socketCommand port notification portCommand portSensor socketSensor |	(BoardStatus = 1) ifFalse: [		s _ self createBMHandle.		s ifNil: [^ self].		"---------- Success in connection ----------"		" Send message "		Transcript show: '---------- Sending TEST----------'; cr.		s sendCommand: 'TEST'.		" Asking user to push a reset button. - 1 - "		notification _ NotificationMessage show: 16r20.	"Waiting for RESET"		" Waiting for BM to transfer a testmode program. "		Transcript show: '---------- Recving1 ----------'; cr.		line _ self waitForBMResponse: s.		(line = '-1') ifTrue: [			notification ifNotNil: [notification no].			^ self].		res _ line.		notification no.		(res = 'OK') ifFalse: [			" Getting error number "			line _ self waitForBMResponse: s.			(line = '-1') ifTrue: [				notification ifNotNil: [notification no].				^ self].			" Notify timeout error. "			ErrorMessage show: line asNumber.			^ self].		" Asking user to push a reset button. - 2 - "		notification _ NotificationMessage show: 16r21.	"Waiting for RESET"		" Waiting for BM to transfer a testmode program. "		Transcript show: '---------- Recving1 ----------'; cr.		line _ self waitForBMResponse: s.		(line = '-1') ifTrue: [			notification ifNotNil: [notification no].			^ self].		res _ line.		notification no.		(res = 'OK') ifFalse: [			" Getting error number "			line _ self waitForBMResponse: s.			(line = '-1') ifTrue: [				notification ifNotNil: [notification no].				^ self].			" Notify timeout error. "			ErrorMessage show: line asNumber.			^ self].		Transcript show: '---------- Recving3 ----------'; cr.		"Waiting INITOK"		line _ self waitForBMResponse: s.		(line = '-1') ifTrue: [			notification ifNotNil: [notification no].			^ self].		res _ line sansSemicolonSuffix.		(res = 'INITOK') ifTrue: [			Transcript show: '---------- Sending TEST2S----------'; cr.			s sendCommand: 'TEST2S'.			line _ self waitForBMResponse: s.			(line = '-1') ifTrue: [				notification ifNotNil: [notification no].				^ self].			port _ line asNumber.]		ifFalse: [			notification no.			ErrorMessage show: 100.			^ self].	].Transcript show: res; cr.	(port > 0) ifTrue: [	" Success to Transfer "		"Check if the port is available."		portCommand _ (port asNumber) bitAnd: 16rFFFF.		portSensor _ portCommand + ((port asNumber) bitShift: -16).		sb _ workPane sensorBoard.		sb socketIsOpen ifTrue: [Transcript show:'[ScratchFrameMorph::testMode] close & open port';cr.			sb closeSocket.		]."		sb socket: s."		s sendCommand: 'BREAK'.		s disconnect.		s destroy.		socketSensor _ self createBMHandle: portSensor.		socketSensor ifNil: [^ self.].		sb socket: socketSensor.		socketCommand _ self createBMHandle: port.		socketCommand ifNil: [^ self.].		sb socketCommand: socketCommand.		"  Set sensorboard items "		sb addReadouts.		" Send port configuration "		self showSensorBoard.		DuringTest _ true.	].	notification no.! !!ScratchFrameMorph methodsFor: 'private' stamp: 'KK 2/13/2018 11:36'!updateCalibInfo	" Updating calibration files with the latest info. [Variables -> Files] "	| filename f |	"---------------------------------------------------------"	" Get Servomotor Info "	"---------------------------------------------------------"	filename _ '..\common\sv_offset_ini'.	f _ StandardFileStream fileNamed: filename.	f binary.	SvCalib do: [:elm |		(elm < 0) ifTrue: [			f nextPut: elm + 256]		ifFalse: [			f nextPut: elm]].	f close.	"---------------------------------------------------------"	" Get DC motor Info "	"---------------------------------------------------------"	filename _ '..\common\dc_calib_ini'.	f _ StandardFileStream fileNamed: filename.	f binary.	DCCalib do: [:elm |		f nextPut: elm].	f close.! !!ScratchFrameMorph methodsFor: 'private' stamp: 'sk 4/25/2017 10:58'!updateIOInfo	" Updating an IOInfo file with the latest info. [Variable -> File] "	| filename f |	"---------------------------------------------------------"	" Write I/O configuration file "	"---------------------------------------------------------"	filename := 'Board.cfg'.	f _ FileStream fileNamed: filename.	f binary.	IOPort do: [ :elm |		f nextPut: elm].	f close.! !!ScratchFrameMorph methodsFor: 'private' stamp: 'KK 2/7/2018 13:28'!updatePanes	| p |	usbCSPanel ifNotNil: [ usbCSPanel delete. ].	self createUSBCSPanel.	usbConnectionStatus ifNotNil: [		self setUSBConnectionStatus: usbConnectionStatus.	].	menuPanel ifNotNil: [ menuPanel delete. ].	self createMenuPanel."----------"	toolbarPanel delete.	self createToolbar."----------"	viewModeButtonsPanel delete.	self createViewModeButtonsPanel.	stageButtonsPanel delete.	self createStageButtonsPanel.	titlePane addMorph: stageButtonsPanel."----------"	scriptsPane tabPane delete.	scriptsPane createTabPane.	readoutPane delete.	self createReadoutPane."----------"	" Sensor Board "	workPane sensorBoard owner		ifNil: [p _ nil]		ifNotNil: [p _ workPane sensorBoard position].	workPane sensorBoard addReadouts.	p ifNotNil:[		self showSensorBoard.		workPane sensorBoard position: p].	" Studuino Sensor Board "	workPane studuinoBoard owner		ifNil: [p _ nil]		ifNotNil: [p _ workPane studuinoBoard position].	workPane studuinoBoard addReadouts.	p ifNotNil:[		self showStuduinoSensorBoard.		workPane studuinoBoard position: p].	" Calibration Board "	workPane motorCalibrationBoard owner		ifNil: [p _ nil]		ifNotNil: [			p _ workPane motorCalibrationBoard position.			workPane motorCalibrationBoard saveCalibrationInfo.		].	workPane motorCalibrationBoard addReadouts.	p ifNotNil:[		workPane motorCalibrationBoard setCalibrationInfo.		self showCalibrationBoard.		workPane motorCalibrationBoard position: p.	].	" Pin Assign Board "	paBoard ifNotNil: [		paBoard savePinAssignInfo.		paBoard addReadouts.		paBoard returnPinAssignInfo.	].	libraryPane clearLibrary.	self scratchWatchers do: [:w | w languageChanged].	self listWatchers do: [:w | w fixLayoutForNewLanguage].	World startSteppingSubmorphsOf: self.	self fixLayout.	scriptsPane fixLayout.	self updateViewModeButtons.! !!ScratchFrameMorph methodsFor: 'private' stamp: 'KK 2/13/2018 18:32'!waitForBMResponse: s	| line |	" I receive message from Board Manager and return message"	line _ WriteStream on: String new.	line _ s getBMResponse.	^ line sansSemicolonSuffix.! !!ScratchFrameMorph methodsFor: 'arduino' stamp: 'KK 7/12/2017 17:23'!addArduinoSprite	| arduinoSprite |	arduinoSprite := ScratchFrameMorph defaultArduinoSprite fullCopy.	arduinoSprite hide.	self addArduinoSensorBoardMorphFor: arduinoSprite.! !!ScratchFrameMorph methodsFor: 'arduino' stamp: 'mcr 9/12/2010 16:48'!addArduinoSprite: anArduinoSprite		self addAndView: anArduinoSprite.	workPane newArduinoSprite: anArduinoSprite.! !!ScratchFrameMorph methodsFor: 'arduino' stamp: 'KK 7/12/2017 17:15'!addArduinoSpriteWithCostume: aCostume	| arduinoSprite |	arduinoSprite := ArduinoScratchSpriteMorph costume: aCostume.	self addArduinoSensorBoardMorphFor: arduinoSprite.! !!ScratchFrameMorph methodsFor: 'arduino' stamp: 'mcr 7/26/2011 17:28'!addRestoredArduinoSprite: anArduinoSprite	| oldName oldPosition |	oldName := anArduinoSprite objName.	oldPosition := anArduinoSprite position.	self addAndView: anArduinoSprite.	anArduinoSprite objName: oldName.	anArduinoSprite position: oldPosition - anArduinoSprite costume rotationCenter.	workPane newArduinoSprite: anArduinoSprite.! !!ScratchFrameMorph methodsFor: 'arduino' stamp: 'KK 7/24/2017 16:32'!arduinoSpritesInUse	^workPane spritesInUse collect: [:s | s objName].! !!ScratchFrameMorph methodsFor: 'arduino' stamp: 'mcr 7/21/2011 12:26'!attachArduinoSprite: anArduinoSprite with: anArduinoSpriteId	workPane arduinoSprites do: [:s | 		(s objName = anArduinoSpriteId) 			ifTrue: [^anArduinoSprite arduinoBoard: s arduinoBoard]]! !!ScratchFrameMorph methodsFor: 'arduino' stamp: 'mcr 9/12/2010 17:32'!computeBoardPosition	^workPane position + (10*workPane arduinoBoards size) asPoint! !!ScratchFrameMorph methodsFor: 'arduino' stamp: 'mcr 7/27/2011 14:18'!deleteAllArduinoBoards	workPane arduinoBoards do: [:b | b close].! !!ScratchFrameMorph methodsFor: 'arduino' stamp: 'KK 7/12/2017 17:14'!importArduinoSprite	| result |	result := ScratchFileChooserDialog chooseArduinoSpriteCostumeFor: self.	result = #cancelled ifTrue: [^ self].	(result asLowercase endsWith: '.arduinosprite') "import an Arduino sprite?"		ifTrue: [^self importSpriteOrProject: result]. 	self addArduinoSpriteWithCostume: (self importCostumeFromFile: result).	"create Arduino sprite with the imported costume"! !!ScratchFrameMorph methodsFor: 'arduino' stamp: 'mcr 7/26/2011 15:59'!importCostumeFromFile: aFileName	| f costume |	[f := Form fromFileNamed: aFileName] ifError: [^ self].	costume := ImageMedia new form: (ScratchFrameMorph scaledFormForPaintEditor: f).	^costume mediaName: (FileDirectory localNameFor: aFileName).	! !!ScratchFrameMorph methodsFor: 'arduino' stamp: 'mcr 8/1/2011 14:38'!openConnectionChooserDialogFor: anArduinoScratchSpriteMorph		| morph sprites |	(sprites := self arduinoSpritesInUse) isEmpty ifTrue: [		^'new'].			morph := ArduinoConnectionChooserDialog 				for: anArduinoScratchSpriteMorph 				withSpritesList: sprites.    	^morph getUserResponse	! !!ScratchFrameMorph methodsFor: 'arduino' stamp: 'mcr 7/26/2011 14:29'!paintArduinoSprite	| sprite response |	sprite := ScratchFrameMorph defaultArduinoSprite fullCopy.	response := sprite editDrawingOldCostumeName: nil deleteOnCancel: false.	response = #cancelled ifFalse: [self addArduinoSensorBoardMorphFor: sprite].!]style[(18 170 11 56)f1b,f1,f3,f1! !!ScratchFrameMorph methodsFor: 'arduino' stamp: 'vct 11/25/2011 17:38'!recordLanguage: aString	"Record my language in the settings file."	"ScratchFrameMorph new recordLanguage: 'English'"	| fName f sz settings all |	fName _ FileDirectory default fullNameFor: 'Scratch.ini'.	f _ FileStream concreteStream new open: fName forWrite: true.	f ifNil: [^ self].	sz _ f size.	settings _ (f next: sz) lines.	settings _ settings reject: [:s | s asLowercase beginsWith: 'language='].	settings _ settings reject: [:s | all _ s asByteArray asSet. (all size = 1) and: [all asArray first = 0]].	settings _ settings copyWith: ('Language=', aString).	f position: 0.	settings do: [:s | f nextPutAll: s, String crlf].	[f position < sz] whileTrue: [f nextPut: 0 asCharacter].	f close.! !!ScratchFrameMorph methodsFor: 'arduino' stamp: 'mcr 8/1/2011 16:25'!restoreArduinoBoards	| board boardLastOwner |	workPane arduinoSprites do: [:s | 		s submorphs isEmpty ifFalse: [			board := s submorphs at: 1.			boardLastOwner := board lastOwner.			boardLastOwner addMorph: board.			board comeToFront.			s submorphs do: [:sprite |				workPane addMorph: sprite]]].!]style[(20 254 1 36)f1b,f1,f2,f1! !!ScratchFrameMorph methodsFor: 'arduino' stamp: 'mcr 7/27/2011 17:59'!restoreArduinoMessages	workPane arduinoBoards do:[:b | b restoreMessages]! !!ScratchFrameMorph methodsFor: 'arduino' stamp: 'mcr 7/26/2011 13:15'!restoreArduinoSprite: anArduinoSprite	workPane addArduinoSprite: anArduinoSprite.	anArduinoSprite submorphs do: [:s |		(s isKindOf: ArduinoSensorBoardMorph)			ifTrue: [				workPane attachBoard: s withSprite: anArduinoSprite]			ifFalse: [				self addRestoredArduinoSprite: s.				s arduinoBoard: anArduinoSprite arduinoBoard]].! !!ScratchFrameMorph methodsFor: 'arduino' stamp: 'KK 7/25/2017 10:50'!restoreArduinoSprites	| existASpriteFlag |	workPane submorphs isEmpty ifTrue: [ "new project"Transcript show:'empty';cr.		^self addArduinoSprite].	existASpriteFlag _ false.	workPane submorphs do: [:sprite |		(sprite isKindOf: ArduinoScratchSpriteMorph) ifTrue: [			existASpriteFlag _ true.		].	].	existASpriteFlag ifFalse: [		self addArduinoSprite.	].	workPane submorphs do: [:sprite | Transcript show:sprite;cr.		(sprite isKindOf: ArduinoScratchSpriteMorph) ifTrue: [			sprite hide.			self restoreArduinoSprite: sprite]].											! !!ScratchFrameMorph methodsFor: 'arduino' stamp: 'mcr 8/2/2011 12:32'!saveArduinoBoards"no destruir la coleccion para no haber de reconstruirla!!!!!!"	| mainSprite index |	workPane arduinoBoards do: [:b | 		b isSearching ifTrue: [b closeConnection].		index := 1.		b arduinoSprites do: [:s |			(index = 1) 				ifTrue: [mainSprite := s.						b lastOwner: b owner.						mainSprite addMorphBack: b]				ifFalse: [mainSprite addMorphBack: s].			index := index + 1]		].! !!ScratchFrameMorph methodsFor: 'arduino' stamp: 'KK 7/5/2017 15:50'!updateProjectName	"Update the project name display in the Scratch title bar."	| s |	projectName ifNil: [projectName _ ''].	projectTitleMorph contents: (self nameFromFileName: projectName).	projectTitleMorph contents size > 0		ifTrue: [s _ projectTitleMorph contents, '- SPE BLOCK']		ifFalse: [s _ 'Studuino BLOCK Programming Environment'", Version"].	ScratchPlugin primSetWindowTitle: s.	self fixLayout.! !!ScratchFrameMorph class methodsFor: 'class initialization' stamp: 'KK 10/10/2017 12:33'!initialize	|  |	"self initialize"	Clipboard _ nil.	WorkpaneExtent _ 480@360.	UseErrorCatcher _ true.	DefaultNotes _ ''.	IOPort ifNil: [ IOPort _ Array new:18. ].	SvCalib ifNil: [ SvCalib _ Array new:8. ].	DCCalib ifNil: [ DCCalib _ Array new:2. ].	SvDegree ifNil: [ SvDegree _ Array new:8. ].	LangDic ifNil: [ LangDic _ Dictionary new. ].	LangDic		at: 'ja' put: 'LANGJ';		at: 'ja_HIRA' put: 'LANGH';		at: 'zh_CN' put: 'LANGZ';		at: 'zh_TW' put: 'LANGZT';		at: 'ko' put: 'LANGK';		at: 'es' put: 'LANGES';		at: 'fr' put: 'LANGFR'.	self initFonts.! !!ScratchFrameMorph class methodsFor: 'scratch skin' stamp: 'KK 9/11/2017 11:32'!readSkinFrom: aDirectory	"Read the Forms for my skin from the given directory and store them in myskin dictionary."	"When in XO mode, entries in ScratchSkinXO override the corresponding entries in ScratchSkin."	"self readSkinFrom: (FileDirectory default directoryNamed: 'ScratchSkin')"	| dict img i xoDict |	dict _ Dictionary new.	xoDict _ Dictionary new.	aDirectory fileNames do: [:fn |		Cursor read showWhile: [			img _ [Form fromFileNamed: (aDirectory fullNameFor: fn)] ifError: [nil]].		img ifNotNil: [			i _ fn findLast: [:c | c = $.].			i = 0 ifFalse: [fn _ fn copyFrom: 1 to: i - 1].			(fn asLowercase endsWith: '_xo')				ifTrue: [xoDict at: (fn copyFrom: 1 to: fn size - 3) asSymbol put: img]				ifFalse: [dict at: fn asSymbol put: img]]].	ScratchSkin _ dict.	ScratchSkinXO _ xoDict.	img _ ScratchSkin at: #scriptsPaneTexture ifAbsent: [nil].	(img notNil and: [img depth ~= 32]) ifTrue: [		ScratchSkin at: #scriptsPaneTexture put: (img asFormOfDepth: 32)].! !!ScratchFrameMorph class methodsFor: 'utilities' stamp: 'sk 7/30/2015 16:11'!displayMessageDialog: msgID	" I display Dialog Message from number. "	| dialogBox |	(msgID = '0') ifTrue: [	" Could not access to BM "		dialogBox _ DialogBoxMorph new.		dialogBox withButtonsForYes: false no: false okay: true cancel: false.		dialogBox title: 'Could not access to Studuino'.		dialogBox message: 'Please save your project and restart this software.'.		dialogBox openInWorld.		" Display Dialogbox "		dialogBox centerOnScreen.	" Set center position "		dialogBox world doOneCycle.	].	(msgID = '1') ifTrue: [		dialogBox _ DialogBoxMorph new.		dialogBox withButtonsForYes: false no: false okay: true cancel: false.		dialogBox title: 'Could not access to Studuino'.		dialogBox message: 'Make sure Studuino is connected to the PC.'.		dialogBox openInWorld.		" Display Dialogbox "		dialogBox centerOnScreen.	" Set center position "		dialogBox world doOneCycle.	].	(msgID = '2') ifTrue: [		dialogBox _ DialogBoxMorph new.		dialogBox withButtonsForYes: false no: false okay: true cancel: false.		dialogBox title: 'Could not access to Studuino'.		dialogBox message: 'Serial port already in use.Try quiting any programs that may be using it.'.		dialogBox openInWorld.		" Display Dialogbox "		dialogBox centerOnScreen.	" Set center position "		dialogBox world doOneCycle.	].	(msgID = '3') ifTrue: [		dialogBox _ DialogBoxMorph new.		dialogBox withButtonsForYes: false no: false okay: true cancel: false.		dialogBox title: 'Could not access to Studuino'.		dialogBox message: 'Studuino and PC failed to sync.Save your project, exit this software, reset Studuino, and restart this software.'.		dialogBox openInWorld.		" Display Dialogbox "		dialogBox centerOnScreen.	" Set center position "		dialogBox world doOneCycle.	].	(msgID = '4') ifTrue: [		dialogBox _ DialogBoxMorph new.		dialogBox withButtonsForYes: false no: false okay: true cancel: false.		dialogBox title: 'Could not access to Studuino'.		dialogBox message: 'Disconnected.'.		dialogBox openInWorld.		" Display Dialogbox "		dialogBox centerOnScreen.	" Set center position "		dialogBox world doOneCycle.	].	(msgID = '5') ifTrue: [		dialogBox _ DialogBoxMorph new.		dialogBox withButtonsForYes: false no: false okay: true cancel: false.		dialogBox title: 'System error'.		dialogBox message: 'System file is corrupted.Save your project, exit this software, reinstall Studuino programming environment.'.		dialogBox openInWorld.		" Display Dialogbox "		dialogBox centerOnScreen.	" Set center position "		dialogBox world doOneCycle.	].	(msgID = '6') ifTrue: [		dialogBox _ DialogBoxMorph new.		dialogBox withButtonsForYes: false no: false okay: true cancel: false.		dialogBox title: 'Could not access to Studuino'.		dialogBox message: 'COM port error.'.		dialogBox openInWorld.		" Display Dialogbox "		dialogBox centerOnScreen.	" Set center position "		dialogBox world doOneCycle.	].	(msgID = '7') ifTrue: [		dialogBox _ DialogBoxMorph new.		dialogBox withButtonsForYes: false no: false okay: true cancel: false.		dialogBox title: 'Build error'.		dialogBox message: 'Main function is not defined.'.		dialogBox openInWorld.		" Display Dialogbox "		dialogBox centerOnScreen.	" Set center position "		dialogBox world doOneCycle.	].	(msgID = '8') ifTrue: [		dialogBox _ DialogBoxMorph new.		dialogBox withButtonsForYes: false no: false okay: true cancel: false.		dialogBox title: 'Build error'.		dialogBox message: 'Script too big.'.		dialogBox openInWorld.		" Display Dialogbox "		dialogBox centerOnScreen.	" Set center position "		dialogBox world doOneCycle.	].	(msgID = '9') ifTrue: [		dialogBox _ DialogBoxMorph new.		dialogBox withButtonsForYes: false no: false okay: true cancel: false.		dialogBox title: 'Build error'.		dialogBox message: 'An error has occurred in the archiving process. Please re-install.'.		dialogBox openInWorld.		" Display Dialogbox "		dialogBox centerOnScreen.	" Set center position "		dialogBox world doOneCycle.	].	(msgID = '10') ifTrue: [		dialogBox _ DialogBoxMorph new.		dialogBox withButtonsForYes: false no: false okay: true cancel: false.		dialogBox title: 'Build error'.		dialogBox message: 'An error has occurred in the object copy1 process. Please re-install.'.		dialogBox openInWorld.		" Display Dialogbox "		dialogBox centerOnScreen.	" Set center position "		dialogBox world doOneCycle.	].	(msgID = '11') ifTrue: [		dialogBox _ DialogBoxMorph new.		dialogBox withButtonsForYes: false no: false okay: true cancel: false.		dialogBox title: 'Could not access to Studuino'.		dialogBox message: 'Time-out error has occurred in the communication with Studuino board. If the same error occurs even replaced the USB port on the PC side, please restart your PC.'.		dialogBox openInWorld.		" Display Dialogbox "		dialogBox centerOnScreen.	" Set center position "		dialogBox world doOneCycle.	].	(msgID = '12') ifTrue: [		dialogBox _ DialogBoxMorph new.		dialogBox withButtonsForYes: false no: false okay: true cancel: false.		dialogBox title: 'Could not access to Studuino'.		dialogBox message: 'Timeout error occurred in the communication of the substrate. Please restart the programming environment.'.		dialogBox openInWorld.		" Display Dialogbox "		dialogBox centerOnScreen.	" Set center position "		dialogBox world doOneCycle.	].	" ------------------------------- "	" The value of Message ID 13, 14, 15 is usable. "	" ------------------------------- "	(msgID = '17') ifTrue: [		dialogBox _ DialogBoxMorph new.		dialogBox withButtonsForYes: false no: false okay: true cancel: false.		dialogBox title: 'Build error'.		dialogBox message: 'Undefined function.'.		dialogBox openInWorld.		" Display Dialogbox "		dialogBox centerOnScreen.	" Set center position "		dialogBox world doOneCycle.	].	(msgID = '18') ifTrue: [		dialogBox _ DialogBoxMorph new.		dialogBox withButtonsForYes: false no: false okay: true cancel: false.		dialogBox title: 'Build error'.		dialogBox message: 'There are blocks that are not connected.'.		dialogBox openInWorld.		" Display Dialogbox "		dialogBox centerOnScreen.	" Set center position "		dialogBox world doOneCycle.	].	" ------------------------------- "	" The value of Message ID 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30 is usable. "	" ------------------------------- "	(msgID = '30') ifTrue: [		dialogBox _ DialogBoxMorph new.		dialogBox withButtonsForYes: false no: false okay: true cancel: false.		dialogBox title: '!!'.		dialogBox message: 'Infrared receiving sensor and I2C devices (gyro sensor, acceleration sensor, color sensors) can not be used together.'.		dialogBox openInWorld.		" Display Dialogbox "		dialogBox centerOnScreen.	" Set center position "		dialogBox world doOneCycle.	].	(msgID = '31') ifTrue: [		dialogBox _ DialogBoxMorph new.		dialogBox withButtonsForYes: false no: false okay: true cancel: false.		dialogBox title: '!!'.		dialogBox message: 'That value is already in define.'.		dialogBox openInWorld.		" Display Dialogbox "		dialogBox centerOnScreen.	" Set center position "		dialogBox world doOneCycle.	].	(msgID = '32') ifTrue: [		dialogBox _ DialogBoxMorph new.		dialogBox withButtonsForYes: false no: false okay: true cancel: false.		dialogBox title: 'Could not access to Studuino'.		dialogBox message: 'There is no reply from Studuino.Reconnect Studuino to PC, reset Studuino, and execute a  same command.'.		dialogBox openInWorld.		" Display Dialogbox "		dialogBox centerOnScreen.	" Set center position "		dialogBox world doOneCycle.	].	(msgID = '33') ifTrue: [		dialogBox _ DialogBoxMorph new.		dialogBox withButtonsForYes: false no: false okay: true cancel: false.		dialogBox title: 'Could not access to Studuino'.		dialogBox message: 'Maybe Studuino and PC are not connecting.Finish this mode, reconnect Studuino and PC,reset Studuino, and retry.'.		dialogBox openInWorld.		" Display Dialogbox "		dialogBox centerOnScreen.	" Set center position "		dialogBox world doOneCycle.	].! !!ScratchFrameMorph class methodsFor: 'utilities' stamp: 'KK 1/30/2018 16:23'!getCalibData: buf8Array swap: s	| filename f b index dir |	"Set my language and update my blocks."	Smalltalk isWindows ifTrue: [	" for Windows "		filename := '..\common\sv_offset_ini'.	] ifFalse: [	" for Unix / Mac "		dir _ FileDirectory default.	" Get target directory "		filename := dir pathName, '/../common/sv_offset_ini'.	].	f _ FileStream fileNamed: filename.	f binary.	" If file is not exist, intialize 0 and create file. "	f size = 0 ifTrue: [		1 to: 8 do: [ :i |			" PartsID "			buf8Array at:i put: 0.			f nextPut: 0.		].	] ifFalse: [		s ifTrue: [			1 to: 8 do: [ :i |				" PartsID "				b _ f next.				(b > 15) ifTrue: [ b _ b - 256. ].	" Two's complement "						(i <= 4) ifTrue: [					index _ i + 4.				].				(i > 4) ifTrue: [					index _ i - 4.				].				buf8Array at:index put:b.			].		] ifFalse: [			1 to: 8 do: [ :i |				" PartsID "				b _ f next.				(b > 15) ifTrue: [ b _ b - 256. ].	" Two's complement "				buf8Array at:i put: b.			].		].	].	f close.! !!ScratchFrameMorph class methodsFor: 'utilities' stamp: 'KK 2/2/2018 11:00'!getDCCalibData: buf2Array 	| filename f dir |	"Set my language and update my blocks."	Smalltalk isWindows ifTrue: [	" for Windows "		filename := '..\common\dc_calib_ini'.	] ifFalse: [	" for Unix / Mac "		dir _ FileDirectory default.	" Get target directory "		filename := dir pathName, '/../common/dc_calib_ini'.	].	f _ FileStream fileNamed: filename.	f binary.	" If file is not exist, intialize 100 and create file. "	f size = 0 ifTrue: [		buf2Array at:1 put:100.		buf2Array at:2 put:100.		f nextPut: 100.		f nextPut: 100.	] ifFalse: [		buf2Array at:1 put:(f next).		buf2Array at:2 put:(f next).	].	f close.! !!ScratchFrameMorph class methodsFor: 'arduino' stamp: 'KK 10/12/2017 20:22'!defaultArduinoSprite	"Return the default sprite"	| defaultCostume |	^DefaultArduinoSprite		ifNil: [defaultCostume := ImageMedia new form: (ScratchFrameMorph skinAt: #stduinoSpriteCostume).			   DefaultArduinoSprite := ArduinoScratchSpriteMorph costume: defaultCostume].! !!ScratchLibraryMorph methodsFor: 'initialization' stamp: 'KK 7/31/2017 15:32'!buildPanes	"Build my scroll pane."	| bin |	stagePane _ Morph new		color: Color transparent;		position: self position + (7@0)."	stagePane _ AlignmentMorph newColumn		color: Color transparent;		position: self position + (7@0)."	bin _ ScratchSpriteLibraryMorph new		color: Color transparent;		borderWidth: 0.	scrollPane _ ScrollFrameMorph2 new		color: Color transparent;		contents: bin;		showHorizontalScrollbar: false.	spritePane _ Morph new		color: Color gray;		position: self position.	spriteLabel _ self buildSpriteLabel.	buttonPane _ self makeNewSpriteButtons: (self ownerThatIsA: ScratchFrameMorph).	self addMorph: spritePane.	self addMorph: spriteLabel.	self addMorph: buttonPane.	self addMorph: scrollPane.	self addMorph: stagePane.! !!ScratchLibraryMorph methodsFor: 'initialization' stamp: 'jm 5/1/2009 10:50'!clearLibrary	"Remove all library items. My step method will re-add items for existing objects."	| sFrame |	stagePane removeAllMorphs.	scrollPane contents removeAllMorphs.	scrollPane vScrollRelative: 0.	spriteLabel delete.	spriteLabel _ self buildSpriteLabel.	sFrame _ self ownerThatIsA: ScratchFrameMorph.	(sFrame isNil or:	 [sFrame viewMode = #normal]) ifTrue: [		self addMorph: spriteLabel].	buttonPane delete.	buttonPane _ self makeNewSpriteButtons: sFrame.	self addMorph: buttonPane.	topSectionHeight _ ((spriteLabel height + 10) max: 40).	self fixLayout.! !!ScratchLibraryMorph methodsFor: 'initialization' stamp: 'KK 1/10/2013 16:53'!makeNewSpriteButtons: aScratchFrameMorph	"Return a morph containing a set of new sprite buttons."	| panel buttonSpecs buttons button butonExtent x |	panel _ Morph new color: Color transparent.	buttonSpecs _ #(		"	icon name				selector					tooltip"		(newSpritePaint			paintSpriteMorph		'Paint new sprite')		(newSpriteLibrary		addSpriteMorph			'Choose new sprite from file')		(newSpriteSurprise 		surpriseSpriteMorph		'Get surprise sprite')	).	buttons _ buttonSpecs collect: [:spec |		button _ ToggleButton new			onForm: (ScratchFrameMorph skinAt: (spec at: 1))			offForm: (ScratchFrameMorph skinAt: (spec at: 1)).		button			target: aScratchFrameMorph;			actionSelector: (spec at: 2);			setProperty: #balloonText toValue: (spec at: 3) localized.		button].	butonExtent _ ScratchFrameMorph isXO ifTrue: [37@27] ifFalse: [37@27].	x _ 0.	buttons do: [:b |		b extent: butonExtent.		panel addMorph: (b position: x@1).		x _ x + 5 + b width].	panel extent: x@(butonExtent y + 1).	^ panel! !!ScratchLibraryMorph methodsFor: 'geometry' stamp: 'KK 8/1/2017 09:32'!fixLayout	"Position and size thumbnails."	| libPane x y rMargin sFrame ax margin |	scrollPane isNil | stagePane isNil | spritePane isNil ifTrue: [^ self].	spritePane width: self width.	spritePane height: topSectionHeight.	spriteLabel position: (self left + 15)@(self top + (topSectionHeight // 2) - (spriteLabel height // 2) + 3).	sFrame _ self ownerThatIsA: ScratchFrameMorph.	(sFrame isNil or: [sFrame viewMode = #normal])		ifTrue: [buttonPane position: (spriteLabel right + 10)@(self top + (topSectionHeight // 2) - (buttonPane height // 2) + 3)]		ifFalse: [buttonPane position: (self left + 12)@(self top + (topSectionHeight // 2) - (buttonPane height // 2) + 3)].		stagePane height = self height ifFalse: [		stagePane height: self height].	scrollPane height = self height ifFalse: [		scrollPane height: self height - topSectionHeight].	scrollPane width = (self right - stagePane right) ifFalse: [		scrollPane width: self right - stagePane right].	scrollPane position: scrollPane left @ (self top + topSectionHeight + 3).	stagePane position: stagePane left @ (self top + topSectionHeight + 3).	libPane _ scrollPane contents.	margin _ 0."	ScratchTranslator isRTL		ifTrue: [x _ libPane left + 30]		ifFalse: [x _ libPane left + 8]."	ScratchTranslator isRTL		ifTrue: [margin _ 30]		ifFalse: [margin _ 8].	x _ libPane left + margin.	y _ libPane top + 7.	rMargin _ x + scrollPane width - 5.	libPane submorphCount > 0 ifTrue: [		x _ x + libPane firstSubmorph width.	].	" I position Studuino Sprite top. "	libPane submorphs do: [:m |		(m target isKindOf: ArduinoScratchSpriteMorph) ifTrue: ["			ScratchTranslator isRTL				ifTrue: [ax _ libPane left + 30]				ifFalse: [ax _ libPane left + 8]."			ax _ libPane left + 0.			m position: (ax @ libPane top + 7).		] ifFalse:[			(x + m width) > rMargin ifTrue: ["				ScratchTranslator isRTL					ifTrue: [x _ libPane left + 30]					ifFalse: [x _ libPane left + 8]."				x _ libPane left + margin.				y _ y + m height].			m position: x@y.			x _ x + m width		].	].	stagePane submorphCount > 0 ifTrue: [		m _ stagePane firstSubmorph.		m position: stagePane topLeft + ((stagePane extent - stagePane firstSubmorph extent) // 2) + (0@15) - (0@topSectionHeight)"		stagePane submorphs do: [:m |			(m target isKindOf: ScratchStageMorph) ifTrue: [				m position: stagePane topLeft + ((stagePane extent - stagePane firstSubmorph extent) // 2) + (0@15) - (0@topSectionHeight)			].			(m target isKindOf: ArduinoScratchSpriteMorph) ifTrue: [				m position: stagePane topLeft + (0@8).			].		]."	].! !!ScratchLibraryMorph methodsFor: 'private' stamp: 'KK 8/1/2017 14:48'!addThumbnailFor: aMorph	"Add a thumbnail for the given morph."	| newThumbnail |	newThumbnail _ LibraryItemMorph new.	newThumbnail extent: itemExtent thumbWidth: thumbWidth.	newThumbnail  target: aMorph.	(newThumbnail target isKindOf: ScratchStageMorph)		ifTrue: [stagePane addMorph: newThumbnail]		ifFalse: [scrollPane contents addMorphBack: newThumbnail].	newThumbnail step.! !!ScratchMedia methodsFor: 'accessing' stamp: 'KK 11/6/2017 10:40'!mediaName	^ UTF8 withAll: (mediaName)! !!ScratchMenuTitleMorph methodsFor: 'event handling' stamp: 'KK 9/10/2013 15:39'!handlesMouseDown: evt	MenuEnable ifTrue: [ ^ true ]	ifFalse:	[ ^ false ].! !!ScratchMenuTitleMorph methodsFor: 'event handling' stamp: 'KK 9/6/2013 11:03'!handlesMouseOver: evt	MenuEnable ifTrue: [ ^ true ]	ifFalse:	[ ^ false ].! !!ScratchMenuTitleMorph methodsFor: 'event handling' stamp: 'KK 9/6/2013 10:55'!mouseDown: evt	target isNil | selector isNil ifTrue: [^ self].	Cursor normal show.	MenuBarIsActive _ true.	target perform: selector with: self.  "invoke my menu"! !!ScratchMenuTitleMorph class methodsFor: 'as yet unclassified' stamp: 'KK 2/7/2018 13:31'!setMenuEnable:flag	MenuEnable _ flag.! !!ScratchNoteSelector methodsFor: 'initialization' stamp: 'sk 4/24/2017 09:52'!setUpNoteDisplay: aSize	| height rectMorph |	height _ aSize within:aSize and: 40.	"set up the rect morph which holds the note text"	rectMorph _ BorderedMorph new		color: Color white;		position: self bottomLeft - (0@2);		extent: (self width @ height).	self extent: self fullBounds extent.	self addMorph: rectMorph.	labelMorph _ StringMorph new.	labelMorph font: (ScratchFrameMorph getFont: #Label).	labelMorph position: rectMorph position + (0@4).	rectMorph addMorph: labelMorph.	self extent: self fullBounds extent.	self updateNoteDisplay: 60.! !!ScratchNoteSelector methodsFor: 'interaction' stamp: 'sk 3/15/2017 13:11'!startUp	"Waits for the user to click a value or to click outside, then returns the selected note or nil."	| w result |	self openInWorld.	w _ self world.	"Sensor waitNoButton."  "start with mouse up"	16 timesRepeat: [w doOneCycle].	"25ms x 16 = 400ms wait"	w activeHand newMouseFocus: self.	selectedVal _ nil.	done _ false.	[done] whileFalse: [		(w activeHand hasMouseFocus: self) ifFalse: [done _ true].		w doOneCycle].	result _ selectedVal.	self shutDown.	^ result! !!ScratchNoteSelector methodsFor: 'private' stamp: 'sk 3/21/2017 13:38'!updateNoteDisplay: noteNum	| s |	s _ #('C' 'C#' 'D' 'Eb' 'E' 'F' 'F#' 'G' 'G#' 'A' 'Bb' 'B') at: ((noteNum rem: 12) + 1).	labelMorph		contents: s, ' (' , noteNum asString, ')';		font: (StrikeFont fontName: 'VerdanaBold' size: 16);		centerInOwner.! !!ScratchPlugin class methodsFor: 'translation' stamp: 'KK 8/27/2013 19:29'!writePort: portNum data: buffer	"Write data from the given ByteArray or String to the given port and answer the number of bytes written."	"self writePort: 1 into: (ByteArray new: 10)"	<primitive: 'primWrite' module: 'ScratchPlugin'>	^ 0! !!ScratchPresenterMorph methodsFor: 'button actions' stamp: 'KK 9/5/2017 12:39'!shoutGo	frame ifNotNil: [frame shoutGo].	flagButton on.	World displayWorldSafely.  "force button flash"	Delay waitMSecs: 20.! !!ScratchPresenterMorph methodsFor: 'stepping' stamp: 'KK 10/4/2017 18:09'!step	"Run each process until it gives up control, then filter out any processes that have terminated."	| screenExtent |	screenExtent _ DisplayScreen actualScreenSize.	((self position = (0@0)) and: [self extent = screenExtent]) ifFalse: [		self position: 0@0.		^ self extent: screenExtent].	ScriptableScratchMorph scratchOrigin: stage center.	stage scratchServer ifNotNil: [stage scratchServer stepServer].	self processWhenConditions.	self processKeyboardEvents.	stage stepStuduinoProcesses.	stage stepProcesses.	stage step.	self stepSubmorphs.	offscreenWorld incrRedrawDouble: doubleSize.	stage processesToRun size > 0		ifTrue: [flagButton on]		ifFalse: [flagButton off].! !!ScratchProcess methodsFor: 'entry points' stamp: 'KK 9/6/2017 12:59'!stop	| |	"Permanently terminates this process."	stackFrame ifNotNil: [stackFrame stopMIDI; stopMotors; stopTalkThinkAsk].	readyToYield _ true.	readyToTerminate _ true.	topBlock ifNotNil: [topBlock scratchProc: nil].! !!ScratchProcess methodsFor: 'private-evaluation' stamp: 'KK 5/1/2014 17:08'!applyTimedCommand	"Applies the current command to the already evaluated list of arguments over a particular time interval."	| block arguments currentTime startTime args totalMSecs elapsedMSecs |	block _ stackFrame expression.	arguments _ stackFrame arguments.	"Do we still need to evaluate more arguments?"	arguments size < block argumentCount ifTrue: [^ self evaluateNextArgument].	arguments _ block coerceArgs: arguments.	"Record or get the time when command was first invoked."	currentTime _ Time millisecondClockValue.	startTime _ stackFrame startTime.	startTime ifNil: [  "first call; just set starting time and value"		args _ arguments asArray, (Array with: 0 with: nil).		stackFrame startValue: (block receiver perform: block selector withArguments: args).		stackFrame startTime: currentTime.		readyToYield _ true.		^ self].	"Call primitive time command with its arguments and the elapsed time in seconds"	totalMSecs _ arguments last * 1000.	block selector = #glideSecs:toX:y:elapsed:from: ifTrue: [totalMSecs _ arguments first * 1000].	block selector = #mwait:elapsed:from: ifTrue: [totalMSecs _ arguments last].	((block selector = #drum:duration:elapsed:from:) or:	 [block selector = #noteOn:duration:elapsed:from:])		ifTrue: [totalMSecs _ (60000 * arguments second) / block receiver tempo].	block selector = #rest:elapsed:from:		ifTrue: [totalMSecs _ (60000 * arguments first) / block receiver tempo].	elapsedMSecs _ currentTime - startTime.	currentTime < startTime ifTrue: [elapsedMSecs _ totalMSecs].  "clock wrap"	args _ arguments asArray, (Array with: elapsedMSecs with: stackFrame startValue).	block receiver perform: block selector withArguments: args.	"If not done, then we leave stack as is and yield."	elapsedMSecs < totalMSecs ifTrue: [		readyToYield _ true.		^ self].	"Pop this command off the stack and return."	self popStackFrame.! !!ScratchProcess methodsFor: 'private-evaluation' stamp: 'KK 5/1/2014 17:08'!evaluateCommandFor: aStageMorph	"Evaluates the current block. If the argument is non-nil, redraw the stage."	| expression |	expression _ stackFrame expression.	BlockHighlightMSecs > 1 ifTrue: [expression litUp: true].	expression isSpecialForm ifTrue: [^ self evaluateSpecialForm].	"evaluate arguments, if necessary"	stackFrame arguments size < expression argumentCount		ifTrue: [^ self evaluateNextArgument].	expression isTimed ifTrue: [^ self applyTimedCommand].	self applyPrimitive.	aStageMorph ifNotNil: [		aStageMorph updateTrailsForm.		BlockHighlightMSecs = 1 ifTrue: [  "normal (non-turbo) mode; redraw after each cmd"			World displayWorldSafely]].! !!ScratchProcess methodsFor: 'private-evaluation' stamp: 'KK 4/28/2014 10:47'!evaluateSpecialForm	"Evaluates the current special form expression.  Requires that no arguments have been evaluated, and that the current expression be a special form."	self perform: stackFrame expression selector.! !!ScratchProcess methodsFor: 'private-special forms' stamp: 'KK 9/5/2017 14:33'!doRepeat	"Handles one iteration of a repeat block."	| arguments argExp block counter frame |	block _ stackFrame expression.	arguments _ stackFrame arguments.	"If we haven't done so yet, evaluate the argument to repeat."	arguments size < 1		ifTrue:	[argExp _ block argumentAt: 1.				^self pushStackFrame: (ScratchStackFrame new expression: argExp)].	"If the number of times to repeat is 0, then we're done."	counter _ arguments first asNumberNoError.	counter <= 0 ifTrue:	[^ self popStackFrame].	"Pop this instruction from the stack."	self popStackFrameNoUnhightlight.	"At top of stack should now be:		1.  evaluate body of repeat block.		2.  yield.		3.  evaluate repeat block with decremented counter value.	Need to add these to the stack in reverse order."	"3.  evaluate repeat block with decremented counter value."	frame _ ScratchStackFrame new				expression:		block;				addArgument:	counter - 1.	self pushStackFrame: frame.	"2.  yield."	self pushStackFrame: (ScratchStackFrame new shouldYield: true).	"1.  evaluate body of repeat block."	self pushStackFrame: (ScratchStackFrame new expression: block firstBlockList).! !!ScratchProcess methodsFor: 'private-special forms' stamp: 'KK 8/20/2014 10:58'!doSvmSyncMotion	"Handles one iteration of a repeat block."	| arguments argExp block frame delay expr blockLabelSpec argPermutation defaultArgs maxDelta d1 d2 |	block _ stackFrame expression.	arguments _ stackFrame arguments.	"If we haven't done so yet, evaluate the argument to repeat."	arguments  size < 1		ifTrue:	[argExp _ block argumentAt: 1.				^self pushStackFrame: (ScratchStackFrame new expression: argExp)].	"If the number of times to repeat is 0, then we're done."	" Notify syncro motion start to the board. "	delay _ arguments first asNumberNoError.	(delay <= 0) & (ServomotorSynchroMotion) ifTrue:	[		block evaluateWithArgs: -1.		self popStackFrame.		" Make dummy wait block and push stack frame. "		blockLabelSpec _ ScratchTranslator translationFor: ('wait %n secs').		argPermutation _ CommandBlockMorph argPermutationForSpec: ('wait %n secs') withTranslation: blockLabelSpec.		defaultArgs _ Array with:3.		expr _ CommandBlockMorph new.		expr isTimed: true.		expr		argPermutation: argPermutation;		selector: #mwait:elapsed:from:;		commandSpec: blockLabelSpec;		defaultArgs: defaultArgs;		receiver: block receiver.		maxDelta _ 0.		1 to: (SvDegree size) do: [ : i |			d1 _ SvDegree at:i.			d2 _ SvDegreeTemp at:i.			(((d1 - d2) abs) > maxDelta) ifTrue: [				maxDelta _ ((d1 - d2) abs).			].			SvDegree at:i put:d2.		].		frame _ ScratchStackFrame new					expression:		expr;					addArgument:	(maxDelta * (DelayMsecPerDeg+1)) asNumber.		^ self pushStackFrame: frame.	].	block evaluateWithArgs: delay.	"Pop this instruction from the stack."	self popStackFrameNoUnhightlight.	"At top of stack should now be:		1.  evaluate body of repeat block.		2.  yield.		3.  evaluate repeat block with decremented counter value.	Need to add these to the stack in reverse order."	"3.  evaluate repeat block with decremented counter value."	frame _ ScratchStackFrame new				expression:		block;				addArgument:	-1.	self pushStackFrame: frame.	"2.  yield."	self pushStackFrame: (ScratchStackFrame new shouldYield: true).	"1.  evaluate body of repeat block."	self pushStackFrame: (ScratchStackFrame new expression: block firstBlockList).! !!ScratchProcess methodsFor: 'private-special forms' stamp: 'KK 10/12/2017 08:50'!doSvmSyncMotion2	"Handles one iteration of a repeat block."	| arguments argExp block frame delay maxDelta d1 d2 sb syncStat isPush svms |	block _ stackFrame expression.	arguments _ stackFrame arguments.	"If we haven't done so yet, evaluate the argument to repeat."	arguments  size < 1		ifTrue:	[argExp _ block argumentAt: 1.				^self pushStackFrame: (ScratchStackFrame new expression: argExp)].	"If the number of times to repeat is 0, then we're done."	" Notify syncro motion start to the board. "	delay _ arguments first asNumberNoError.	"Pop this instruction from the stack."	self popStackFrameNoUnhightlight.	sb _ (block receiver ownerThatIsA: ScratchStageMorph) studuinoBoard.	" Not TestMode status "	(DuringTest) ifFalse: [		" Send servomotors synchronous start message. "		block evaluateWithArgs: (20-delay).		" Send servomotor's degress. "		svms _ block firstBlockList.		svms do: [: svm|			svm evaluateWithArgs: svm args.			BlockHighlightMSecs > 1 ifTrue: [svm litUp: true].			BlockHighlightMSecs > 1 ifTrue: [svm litUp: false].		].		" Send servomotors synchronous end message. "		block evaluateWithArgs: -1.		"yield."		self pushStackFrame: (ScratchStackFrame new shouldYield: true).		^ self.	].	sb lockSync critical: [		"3.  evaluate repeat block with decremented counter value."		syncStat _ sb isOnSyncServo.		syncStat ifTrue: [	" Stack block "			" Push servomotor syncro block to FIFO. "			sb pushSvmFifo: block.			" Push self to Scratch Stack. "			frame _ ScratchStackFrame new						expression:		block.			frame addArgument: delay.			self pushStackFrame: frame.		]		ifFalse: [	" Execute or Stack block "			((sb checkSvmFifo) = block) | ((sb checkSvmFifo) = nil) ifTrue: [	" Execute block "				"Transcript show:'>>>  run:';show:block;show:' ';show:delay;cr."				sb startSyncServo.	" Set status during servomotors moving. "				" Send servomotors synchronous start message. "				block evaluateWithArgs: (20-delay).				" Send servomotor's degress. "				svms _ block firstBlockList.				svms do: [: svm|					svm evaluateWithArgs: svm args.					BlockHighlightMSecs > 1 ifTrue: [svm litUp: true].					BlockHighlightMSecs > 1 ifTrue: [svm litUp: false].				].				" Send servomotors synchronous end message. "				block evaluateWithArgs: -1.				" Make dummy wait block and push stack frame. "				maxDelta _ 0.				1 to: (SvDegree size) do: [ : i |					d1 _ SvDegree at:i.					d2 _ SvDegreeTemp at:i.					(((d1 - d2) abs) > maxDelta) ifTrue: [maxDelta _ ((d1 - d2) abs).].					SvDegree at:i put:d2.				].				frame _ self makeNewWaitBlock: ((maxDelta * (DelayMsecPerDeg+1)) asNumber) receiver: block receiver.				self pushStackFrame: frame.				sb popSvmFifo.				PrevBlock _ nil.			]			ifFalse: [	" Stack block "				isPush _ sb pushSvmFifo: block.		" Try push block to FIFO "				(isPush) ifFalse: [	" block exist already "					PrevBlock ifNil: [ " First time "						PrevBlock _ block.					] ifNotNil: [						(PrevBlock = block) ifTrue: [		" lap, so pop from FIFO. "							"Transcript show:'Not exist in FIFO';cr."							sb popSvmFifo. 							PrevBlock _ nil.].					].				].				" Push self to Scratch Stack. "				frame _ ScratchStackFrame new						expression:		block.				frame addArgument: delay.				self pushStackFrame: frame.			]		].		"yield."		self pushStackFrame: (ScratchStackFrame new shouldYield: true).	].! !!ScratchProcess methodsFor: 'private-special forms' stamp: 'KK 9/6/2017 11:13'!makeNewWaitBlock: delay	| blockLabelSpec argPermutation defaultArgs expr block frame |	" Make dummy wait block. "	blockLabelSpec _ ScratchTranslator translationFor: ('wait %n secs').	argPermutation _ CommandBlockMorph argPermutationForSpec: ('wait %n secs') withTranslation: blockLabelSpec.	defaultArgs _ Array with:3.	expr _ CommandBlockMorph new.	expr isTimed: true.	expr	argPermutation: argPermutation;	selector: #mwait:elapsed:from:;	commandSpec: blockLabelSpec;	defaultArgs: defaultArgs;	receiver: block receiver.	frame _ ScratchStackFrame new				expression:		expr;				addArgument:	delay.	^ frame.! !!ScratchProcess methodsFor: 'private-special forms' stamp: 'KK 9/6/2017 11:16'!makeNewWaitBlock: delay receiver: recv	| blockLabelSpec argPermutation defaultArgs expr frame |	" Make dummy wait block. "	blockLabelSpec _ ScratchTranslator translationFor: ('wait %n secs').	argPermutation _ CommandBlockMorph argPermutationForSpec: ('wait %n secs') withTranslation: blockLabelSpec.	defaultArgs _ Array with:3.	expr _ CommandBlockMorph new.	expr isTimed: true.	expr		argPermutation: argPermutation;		selector: #mwait:elapsed:from:;		commandSpec: blockLabelSpec;		defaultArgs: defaultArgs;		receiver: recv.	frame _ ScratchStackFrame new				expression:		expr;				addArgument:	delay.	^ frame.! !!ScratchScriptEditorMorph methodsFor: 'initialization' stamp: 'jm 7/4/2008 12:31'!addNameBox	nameMorph _ UpdatingStringFieldMorph new		font: (ScratchFrameMorph getFont: #UpdatingStringField);		rightJustify: ScratchTranslator isRTL;		acceptWhenFocusLost: true;		position: thumbnailMorph topRight + (17@(thumbnailMorph height * 0.12)).	self addMorphBack: nameMorph.! !!ScratchScriptEditorMorph methodsFor: 'initialization' stamp: 'ee 12/5/2008 22:59'!createTabPane	| tabOnForm tabOffForm tabID tabLabel |	"create tab pane"	tabPaneMorph _ ScratchTabPaneMorph new.	tabPaneMorph		borderWidth: 0;		color: Color transparent;		targetPane: self.	tabOnForm _ (ScratchFrameMorph skinAt: #tabOn).	tabOffForm _ (ScratchFrameMorph skinAt: #tabOff).	"add the tabs"	#(Scripts Costumes Sounds) do: [:spec |		tabID _ spec asString.		tabLabel _ tabID localized.		tabPaneMorph			createTab: tabID			withLabel: tabLabel			onForm: tabOnForm			offForm: tabOffForm].	"set current tab and add to frame"	tabPaneMorph currentTab: 'Scripts'.	self addMorph: tabPaneMorph.! !!ScratchScriptEditorMorph methodsFor: 'initialization' stamp: 'ee 11/4/2008 12:24'!initialize	super initialize.	self		initFrontFromForm: (ScratchFrameMorph skinAt: #scriptPaneFrameTransparent2)		topSectionHeight: 90.	self color: (Color r: (149/255) g: (154/255) b: (159/255)).	thumbnailMorph _ ScratchThumbnailMorph new.	self addMorph: (thumbnailMorph position: self position + (37@16)).	self addNameBox.	pageViewerMorph _ ScrollFrameMorph2 new		growthFraction: 0.1;		color: ScratchFrameMorph scriptsPaneColor.	self addMorph: (pageViewerMorph position: (self left @ (self top + topSectionHeight))).	rotationButtons _ #().	readoutMorphs _ #().	self target: nil.	thumbnailMorph extent: 50@50.	self extent: 300@400.	self createTabPane.! !!ScratchScriptEditorMorph methodsFor: 'accessing' stamp: 'jm 4/9/2009 10:09'!bareMinimumWidth	"Answer the bare minimum width for this pane to be useable."	lockButton ifNil: [^ 100].	^ lockButton right - self left! !!ScratchScriptEditorMorph methodsFor: 'accessing' stamp: 'jm 2/28/2005 17:07'!categoryChanged: aString	"If the given category is my current category, update my contents. Otherwise, do nothing."	self target ifNil: [^ self].	currentCategory = aString ifTrue: [self currentCategory: aString].! !!ScratchScriptEditorMorph methodsFor: 'accessing' stamp: 'jm 2/28/2005 14:29'!currentCategory	^ currentCategory! !!ScratchScriptEditorMorph methodsFor: 'accessing' stamp: 'KK 7/18/2017 20:12'!currentCategory: aString	| xOffset |	currentCategory _ aString.	self target ifNil: [^ self].	(self target isKindOf: ArduinoScratchSpriteMorph) ifTrue: [ currentCategory _ 'Scripts' ].	xOffset _ 0.	World activeHand newKeyboardFocus: nil.	currentCategory = 'Scripts' ifTrue: [		pageViewerMorph contents: self target blocksBin].	currentCategory = 'Costumes' ifTrue: [		pageViewerMorph contents: (self target costumesPage: xOffset)].	currentCategory = 'Sounds' ifTrue: [		pageViewerMorph contents: (self target soundsPage: xOffset)].	pageViewerMorph contents color: ScratchFrameMorph scriptsPaneColor.	self world ifNotNil: [self world startSteppingSubmorphsOf: pageViewerMorph contents].! !!ScratchScriptEditorMorph methodsFor: 'accessing' stamp: 'ee 8/11/2008 13:48'!getTabTop	"Used by ScratchFrameMorph when creating the tab pane. This returns the y position of where the top of the tabs should align. This situation is unfortunate (tabs should probaby be part of ScratchScriptEditorMorph), but we'll fix it later."	ScratchFrameMorph isXO ifTrue: [^ thumbnailMorph bottom + 20].	(readoutMorphs size > 0)		ifTrue: [^ (readoutMorphs at: 1) bottom + 6]		ifFalse: [^ nameMorph bottom + 5 + (ScratchTranslator stringExtent: '0' font: (ScratchFrameMorph getFont: #XYReadoutBold)) y + 6].! !!ScratchScriptEditorMorph methodsFor: 'accessing' stamp: 'ee 11/4/2008 11:44'!tabPane	^ tabPaneMorph! !!ScratchScriptEditorMorph methodsFor: 'accessing' stamp: 'ee 7/1/2003 12:58'!target	^ nameMorph target! !!ScratchScriptEditorMorph methodsFor: 'accessing' stamp: 'KK 8/3/2017 12:01'!target: aScratchObjectOrNil	"Start viewing the given object or no object."	| sFrame nameSel |	World activeHand newKeyboardFocus: nil.	(aScratchObjectOrNil isNil or:	 [aScratchObjectOrNil isScriptable not]) ifTrue: [		thumbnailMorph target: nil.		nameMorph target: nil; contents: 'no object '.		pageViewerMorph contents: (Morph new color: Color red).		(sFrame _ self ownerThatIsA: ScratchFrameMorph) ifNotNil: [			sFrame viewerPane target: nil].		self showOrHideReadouts.		^ self].	thumbnailMorph target: aScratchObjectOrNil.	nameSel _ ((aScratchObjectOrNil isKindOf: ScratchStageMorph) | (aScratchObjectOrNil isKindOf: ArduinoScratchSpriteMorph))		ifTrue: [nil]		ifFalse: [#objName:].		nameMorph		target: aScratchObjectOrNil;		getSelector: #objName;		putSelector: nameSel.	self showOrHideReadouts.	self fixLayout.! !!ScratchScriptEditorMorph methodsFor: 'drawing' stamp: 'ee 1/29/2009 10:12'!drawBackgroundOn: aCanvas	"Draw my background."	color isTransparent ifTrue: [^ self].	aCanvas		fillRectangle: (self topLeft corner: pageViewerMorph topRight)		color: color.! !!ScratchScriptEditorMorph methodsFor: 'drawing' stamp: 'ee 1/29/2009 10:35'!drawSubmorphsOn: aCanvas	"Display submorphs back to front."	submorphs reverseDo: [:m |		(m = tabPaneMorph) ifFalse: [aCanvas fullDrawMorph: m]].! !!ScratchScriptEditorMorph methodsFor: 'drawing' stamp: 'ee 1/29/2009 10:35'!fullDrawOn: aCanvas	"Draw my frame in front of my submorphs."	| clipC |	self isHidden ifTrue: [^ self].	(self hasProperty: #errorOnDraw) ifTrue:[^ self drawErrorOn: aCanvas].	(aCanvas isVisible: self fullBounds) ifFalse: [^ self].	"myBox has integer position and extent and has a potentially inset bottom"	myBox _ bounds truncated.	clipC _ aCanvas copyClipRect: myBox.	frameInFront		ifTrue: [			self drawOn: clipC.			self drawSubmorphsOn: clipC.			self drawFrameOn: clipC.			aCanvas fullDrawMorph: tabPaneMorph]		ifFalse: [			self drawOn: clipC.			self drawSubmorphsOn: clipC].! !!ScratchScriptEditorMorph methodsFor: 'event handling' stamp: 'ee 2/3/2009 13:28'!handlesMouseOverDragging: evt	| m |	evt hand submorphs size = 1 ifFalse: [^ false].	m _ evt hand firstSubmorph.	^ m isKindOf: BlockMorph.! !!ScratchScriptEditorMorph methodsFor: 'event handling' stamp: 'ee 2/8/2009 17:02'!mouseEnterDragging: evt	"Switch the tabs to script if a block is current being dragged"	(currentCategory = 'Scripts') ifFalse:[		self currentCategory: 'Scripts'.		tabPaneMorph currentTab: 'Scripts'].! !!ScratchScriptEditorMorph methodsFor: 'geometry' stamp: 'jm 10/28/2008 13:13'!extent: aPoint	super extent: aPoint.	pageViewerMorph ifNotNil: [		pageViewerMorph extent: self extent - (pageViewerMorph position - self position)].! !!ScratchScriptEditorMorph methodsFor: 'geometry' stamp: 'ee 2/5/2009 16:25'!fixLayout	| y x |	"layout readout morphs vertically"	y _ nameMorph bottom + 5.	readoutMorphs do: [:m |		m position: m left@y].	"layout readout and name morphs horizontally"	nameMorph position: (thumbnailMorph topRight + (17@(thumbnailMorph height * 0.12))).	x _ nameMorph left.	readoutMorphs do: [:m |		m position: x@m top.		x _ m right + 5].	"layout lock and pen morphs"	lockButton ifNotNil: [		lockButton position: (nameMorph right + 4)@(nameMorph top + ((nameMorph height - lockButton height) / 2)).		penReadout position: (lockButton right + 4)@(nameMorph top + ((nameMorph height - penReadout height) / 2))].	"place tab morph"	(readoutMorphs size > 1) ifTrue: [		topSectionHeight _ (readoutMorphs at: 1) bottom - self top + tabPaneMorph height + 5].	tabPaneMorph		width: self width;		position: (self left + 15) @ (self top + topSectionHeight - tabPaneMorph height + 1).	"place scripts scroll pane"	pageViewerMorph position: (self left @ (self top + topSectionHeight)).	self extent: self extent. "force resize of page viewer morph"! !!ScratchScriptEditorMorph methodsFor: 'stepping' stamp: 'ee 4/14/2008 15:01'!step	currentCategory = 'Costumes' ifTrue: [self updateCostumeSelection].	(penReadout isNil or: [penReadout owner ~= self]) ifTrue: [^ self].	self target penDown		ifTrue: [penReadout color: self target penColor]		ifFalse: [penReadout color: Color transparent].! !!ScratchScriptEditorMorph methodsFor: 'stepping' stamp: 'jm 1/5/2006 11:11'!stepTime	^ 50! !!ScratchScriptEditorMorph methodsFor: 'stepping' stamp: 'ee 4/14/2008 15:01'!updateCostumeSelection	"Update the currently selected costume if the costumes tab is selected."	| currentCostume |	currentCategory = 'Costumes' ifFalse: [^ self].	currentCostume _ self target costume.	pageViewerMorph contents submorphsDo: [:m |		((m isKindOf: MediaItemMorph) and:		 [m media isImage]) ifTrue: [			m highlight: (m media = currentCostume)]].! !!ScratchScriptEditorMorph methodsFor: 'menu/button ops' stamp: 'ee 5/14/2008 16:40'!addComment: aPosition	| c scriptsMorph |	scriptsMorph _ (pageViewerMorph allMorphs select: [: m | m isKindOf: ScratchScriptsMorph]) first.	scriptsMorph addMorph: (c _ ScratchCommentMorph new position: aPosition).	World activeHand newKeyboardFocus: c commentMorph.! !!ScratchScriptEditorMorph methodsFor: 'menu/button ops' stamp: 'jm 4/27/2007 16:12'!animateRotationStyle	| style thumbForm wasFlipped currentRotation pen center rotatedForm doFlip |	style _ self target rotationStyle.	thumbnailMorph updateThumbnail.	thumbForm _ thumbnailMorph form deepCopy.	currentRotation _ self target rotationDegrees rounded.	wasFlipped _ ((currentRotation \\ 360) >= 90) & ((currentRotation \\ 360) <= 270).	thumbnailMorph showDirection: false.	pen _ (Pen newOnForm: thumbnailMorph form) color: Color white.	center _ thumbnailMorph form center.	currentRotation to: currentRotation + 360 by: 12 do: [:i |		rotatedForm _ thumbForm.  "no rotation by default"		style = #normal ifTrue: [rotatedForm _ thumbForm rotateBy: i].		style = #leftRight ifTrue: [			doFlip _ ((i \\ 360) >= 90) & ((i \\ 360) <= 270).			wasFlipped ifTrue: [doFlip _ doFlip not].			doFlip ifTrue: [rotatedForm _ thumbForm flipBy: #horizontal centerAt: 0@0]].		thumbnailMorph form fill: thumbnailMorph form boundingBox fillColor: Color transparent.		rotatedForm			displayOn: thumbnailMorph form			at: (thumbnailMorph extent - rotatedForm extent) // 2			rule: Form paint.		pen place: center.		pen goto: center + (Point r: 22 degrees: i).		thumbnailMorph changed.		World displayWorldSafely.		Delay waitMSecs: 20].	thumbnailMorph showDirection: true.	thumbnailMorph updateThumbnail.! !!ScratchScriptEditorMorph methodsFor: 'menu/button ops' stamp: 'ee 11/5/2007 11:50'!cleanUp	"Align all scripts vertically in alphabetical order"	| scriptsMorph |	scriptsMorph _ (pageViewerMorph allMorphs select: [:c | c isKindOf: ScratchScriptsMorph]) first.	scriptsMorph cleanUp.	pageViewerMorph		updateContentsExtent;		updateScrollbars.! !!ScratchScriptEditorMorph methodsFor: 'menu/button ops' stamp: 'ee 2/12/2009 16:23'!deleteSprite	"Ask the user if they want to delete the currently selected sprite"	| response |	response _ DialogBoxMorph askWithCancel: 'Delete this sprite?' localized.	response = #cancelled ifTrue: [^ self].	response ifTrue: [thumbnailMorph target undoableDeleteSprite].! !!ScratchScriptEditorMorph methodsFor: 'menu/button ops' stamp: 'jens 3/9/2009 13:19'!saveScriptsToImage	"Take a snapshot of all scripts for a sprite and save as a GIF file"	| fName saveForm |	saveForm _ pageViewerMorph contents screenshot.	fName _ ScratchFileChooserDialog		chooseNewFileDefault: ''		title: 'Save Scripts Snapshot'		type: #scriptsSnapshot.	fName = #cancelled ifTrue: [^ self].	fName size = 0 ifTrue: [^ self].	(fName asLowercase endsWith: '.gif') ifFalse: [fName _ fName, '.gif'].	saveForm writeGIFFileNamed: fName.! !!ScratchScriptEditorMorph methodsFor: 'menu/button ops' stamp: 'jm 3/2/2009 13:00'!scriptsMenu: aPosition	"Present a menu of Scratch script operations."	| menu choice |	self target ifNil: [^ self].	menu _ CustomMenu new.	menu add: 'clean up' action: #cleanUp.	menu add: 'save picture of scripts' action: #saveScriptsToImage.	menu add: 'add comment' action: #addComment:.	choice _ menu localize startUp.	choice ifNil: [^ self].	choice = #addComment:		ifTrue: [self perform: choice with: aPosition]		ifFalse: [self perform: choice].! !!ScratchScriptEditorMorph methodsFor: 'menu/button ops' stamp: 'KK 8/3/2017 10:45'!setRotationStyle: aSymbol	aSymbol == #Smooth ifTrue: [self target rotationStyle: #normal].	aSymbol == #Flip ifTrue: [self target rotationStyle: #leftRight].	aSymbol == #None ifTrue: [self target rotationStyle: #none].	self updateRotationButtonHighlight.	(self target respondsTo: #rotationDegrees:) ifFalse: [^ self].	self animateRotationStyle.! !!ScratchScriptEditorMorph methodsFor: 'menu/button ops' stamp: 'jm 10/19/2007 11:35'!toggleSpriteDraggable	"Add buttons to set the rotation style."	self target draggable: self target draggable not.	self updateLockButton.! !!ScratchScriptEditorMorph methodsFor: 'private' stamp: 'jm 2/22/2009 21:37'!addDeleteButton	"Add button to delete sprite."	self deleteDeleteButton.	deleteButton _ ToggleButton		onForm: (ScratchFrameMorph skinAt: #deleteSprite)		offForm: (ScratchFrameMorph skinAt: #deleteSprite)		overForm: (ScratchFrameMorph skinAt: #deleteSprite).	deleteButton		target: self;		actionSelector: #deleteSprite;		setBalloonText: 'Delete this sprite' localized;		actWhen: #buttonUp;		isMomentary: true;		position: (lockButton right + 27)@(nameMorph top + ((nameMorph height - deleteButton height) / 2)).	self addMorph: deleteButton.! !!ScratchScriptEditorMorph methodsFor: 'private' stamp: 'ee 2/11/2009 14:13'!addLockButton	"Add button to set sprite locked status."	self deleteLockButton.	lockButton _ ToggleButton		onForm: (ScratchFrameMorph skinAt: #locked)		offForm: (ScratchFrameMorph skinAt: #unlocked).	lockButton		target: self;		actionSelector: #toggleSpriteDraggable;		setBalloonText: 'draggable on website?' localized;		actWhen: #buttonUp;		isMomentary: true;		position: (nameMorph right + 4)@(nameMorph top + ((nameMorph height - lockButton height) / 2)).	self addMorph: lockButton.	self updateLockButton.! !!ScratchScriptEditorMorph methodsFor: 'private' stamp: 'ee 2/20/2009 13:14'!addReadouts	"Add readouts for my target's position and direction."	| x y label readout s |	self deleteReadouts.	readoutMorphs _ OrderedCollection new.	x _ nameMorph left.	y _ nameMorph bottom + 5.	#(('x' xpos) ('y' ypos)('direction' heading)) do: [:spec |		(ScratchTranslator isRTL and: [(spec at: 1) = 'x' or: [(spec at: 1) = 'y']])			ifTrue: [s _ (':', spec first) asUTF8]			ifFalse: [s _ (spec first localized, ScratchTranslator colonSuffix)].		label _ StringMorph new			contents: s;			font: (ScratchFrameMorph getFont: #XYReadout);			position: x@y.		readout _ (UpdatingStringMorph on: self target selector: spec second)			font: (ScratchFrameMorph getFont: #XYReadoutBold);			forceUnicodeRendering: true;			color: (Color gray: 0.2);			contents: '-000';  "this sets the readout size"			growable: false;			stepTime: 100;			position: (label right + 4)@y.		ScratchTranslator isRTL ifTrue:[			readout rightJustify: true].		self addMorph: label; addMorph: readout.		readoutMorphs add: label; add: readout.		readout startStepping.		x _ readout right + 2].	ScratchTranslator isRTL ifTrue: [		readoutMorphs reversed do: [: m |			readoutMorphs remove: m.			readoutMorphs add: m]].	penReadout _ Morph new extent: 15@5.	penReadout position: (lockButton right + 4)@(nameMorph top + ((nameMorph height - penReadout height) / 2));		color: Color transparent.	self addMorph: penReadout.	readoutMorphs add: penReadout.	penReadout startStepping.	readoutMorphs _ readoutMorphs asArray.! !!ScratchScriptEditorMorph methodsFor: 'private' stamp: 'jm 3/21/2008 14:02'!addRotationButtons	"Add buttons to set the rotation style."	| specs x y style button |	self deleteRotationButtons.	(self target respondsTo: #rotationStyle:) ifFalse: [^ self].	specs _ #(		(Smooth		'can rotate')		(Flip		'only face left-right')		(None		'don''t rotate')).	x _ self left + 13.	y _ self top + 18.	specs do: [:pair |		style _ pair first.		button _ ToggleButton			onForm: (ScratchFrameMorph skinAt: ('rotStyle', style, 'On'))			offForm: (ScratchFrameMorph skinAt: ('rotStyle', style))			overForm: (ScratchFrameMorph skinAt: ('rotStyle', style, 'Over')).		button			target: self;			arguments: (Array with: style);			actionSelector: #setRotationStyle:;			setBalloonText: pair second localized;			actWhen: #buttonDown;			position: x@y.		self addMorph: button.		rotationButtons _ rotationButtons copyWith: button.		y _ y + button height + 2].	self updateRotationButtonHighlight.! !!ScratchScriptEditorMorph methodsFor: 'private' stamp: 'ee 2/12/2009 10:49'!deleteDeleteButton	"Delete my delete button."	deleteButton ifNotNil: [		deleteButton delete.		deleteButton _ nil].! !!ScratchScriptEditorMorph methodsFor: 'private' stamp: 'jm 10/3/2007 16:42'!deleteLockButton	"Delete my lock button."	lockButton ifNotNil: [		lockButton delete.		lockButton _ nil].! !!ScratchScriptEditorMorph methodsFor: 'private' stamp: 'jm 2/28/2005 17:46'!deleteReadouts	"Delete the position/rotation readouts."	readoutMorphs do: [:m | m delete].	readoutMorphs _ #().! !!ScratchScriptEditorMorph methodsFor: 'private' stamp: 'jm 2/28/2005 17:40'!deleteRotationButtons	"Delete the rotation style buttons."	rotationButtons do: [:m | m delete].	rotationButtons _ #().! !!ScratchScriptEditorMorph methodsFor: 'private' stamp: 'KK 8/3/2017 12:01'!showOrHideReadouts	"If this is a sprite, show the position and direction readouts and the rotation style buttons. Otherwise, hide them."	self deleteRotationButtons; deleteLockButton; deleteReadouts.	nameMorph		font: nameMorph font;		width: nameMorph height * 4;		rightJustify: ScratchTranslator isRTL.	" If target is Studuino Sprite, I do nothing. "	(self target isKindOf: ArduinoScratchSpriteMorph) ifTrue: [		self target rotationStyle: #none.		^ self.	].	(self target isKindOf: ScratchSpriteMorph) ifTrue: [		self addRotationButtons; addLockButton; addReadouts.		World ifNotNil: [World startSteppingSubmorphsOf: self]].! !!ScratchScriptEditorMorph methodsFor: 'private' stamp: 'jm 10/23/2007 15:24'!updateLockButton	lockButton ifNil: [^ self].	self target draggable		ifTrue: [lockButton off]		ifFalse: [lockButton on].! !!ScratchScriptEditorMorph methodsFor: 'private' stamp: 'KK 8/3/2017 10:14'!updateRotationButtonHighlight	"Highlight the appropriate rotation style button. Do nothing if my target is not a sprite."	| style sym |	(self target isKindOf: ScratchSpriteMorph) ifFalse: [^ self].	(self target isKindOf: ArduinoScratchSpriteMorph) ifTrue: [^ self].	style _ self target rotationStyle.	style = #normal ifTrue: [sym _ #Smooth].	style = #leftRight ifTrue: [sym _ #Flip].	style = #none ifTrue: [sym _ #None].	rotationButtons do: [:m |		sym = m arguments first ifTrue: [m on] ifFalse: [m off]].! !!ScratchScriptsMorph methodsFor: 'initialization' stamp: 'KK 8/1/2017 11:28'!initialize	super initialize.	color _ Color white.	borderWidth _ 0.	self enableDragNDrop: true.! !!ScratchScriptsMorph methodsFor: 'stepping' stamp: 'KK 4/30/2014 16:14'!step	"Give feedback about possible drop targets."	| feedbackColor h b targetArg targetAssoc targetP targetBlock |	feedbackMorph		ifNil: [feedbackMorph _ BorderedMorph new borderWidth: 3]  "create feedback morph if necessary"		ifNotNil: [feedbackMorph delete].  "remove old feedback"	feedbackColor _ Color white.	feedbackMorph useSquareCorners.	h _ World activeHand.	h toolType = 'CutTool' ifTrue: [^ self showDeleteFeedback].	(self bounds containsPoint: h position) ifFalse: [^ self].	h submorphCount = 1 ifFalse: [^ self].	b _ h firstSubmorph.	(b isKindOf: ScratchCommentMorph) ifTrue: [^ self showCommentDropFeedback].	(b isKindOf: BlockMorph) ifFalse: [^ self]."attempt at auto-scrolling (has some issues, commented out for now):	((self owner bounds containsPoint: h position) and:		[(h position x - self owner left) < 50 or: [			(self owner right - h position x) < 50 or: [				(self owner bottom - h position y) < 50 or: [					(h position y - self owner top) < 50]]]])		ifTrue:[self owner scrollMorphIntoView: h firstSubmorph].xxxxxxxx"	b isReporter ifTrue: [ "reporter block"		(targetArg _ self topArgMorphAt: b bounds exclude: nil) ifNil: [^ self].		(targetArg acceptsTypeOf: b) ifFalse: [^ self].		feedbackMorph			bounds: (targetArg bounds expandBy: 5);			color: (feedbackColor alpha: 0.4);			borderColor: feedbackColor;			useRoundedCorners.		^ self addMorphFront: feedbackMorph].	"non-reporter (i.e. command block or hat block)"	targetAssoc _ b closestAttachTargetIn: self.	targetAssoc ifNil: [		(b bottomBlock isKindOf: CBlockMorph) ifFalse: [			targetAssoc _ b bottomBlock closestAttachTargetIn: self.			targetAssoc ifNotNil:[				(targetAssoc value owner isKindOf: BlockMorph) ifTrue:[					targetAssoc _ nil]]]].	targetAssoc ifNil: [^ self].	targetP _ targetAssoc key.	targetBlock _ targetAssoc value.	feedbackMorph borderColor: feedbackColor; color: feedbackColor.	"subtract the attachment point x from the width so that the feedback in CBlock won't stick out"	ScratchTranslator isRTL		ifTrue: [feedbackMorph extent: (targetP x - targetBlock left)@5.			self addMorphFront: (feedbackMorph position: targetP - (feedbackMorph width@0))]		ifFalse: [feedbackMorph extent: (targetBlock right - targetP x)@5.			self addMorphFront: (feedbackMorph position: targetP)].! !!ScratchScriptsMorph methodsFor: 'event handling' stamp: 'sk 3/15/2017 13:50'!mouseDown: evt	| m |	evt hand newKeyboardFocus: nil.	evt hand toolType ifNotNil: [		"revert to normal cursor"		evt hand toolType: nil.		^ self].	evt rightButtonPressed ifTrue: [		"Sensor waitNoButton."		(m _ self ownerThatIsA: ScratchScriptEditorMorph) ifNil: [^ self].		(m target notNil and: [m currentCategory = 'Scripts'])			ifTrue: [m scriptsMenu: evt hand position].		^ self].	evt hand waitForClicksOrDrag: self event: evt.! !!ScratchServer methodsFor: 'server control' stamp: 'KK 8/9/2017 11:32'!joinSessionAt: ipAddressString	"Add an outgoing connection to the given address. Fail if a connection cannot be made in bounded amount of time. Answer true if the connection was added successfully."	| addr sock ok unit num |	" check IP address format "	unit _ ipAddressString findTokens: '.'.	(unit size = 4) ifFalse: [ ^ false. ].	unit do: [:each |		num _ each asNumberNoError.		num = 0 ifTrue: [			each = '0' ifFalse: [ ^ false. ].		].		((num < 0) | (num > 999)) ifTrue: [ ^ false ].	].	addr _ NetNameResolver addressForName: ipAddressString timeout: 5.	sock _ MessageSocket new.	ok _ sock connectTo: addr port: ScratchServer portNumber waitSecs: 5.	ok ifFalse: [sock destroy. ^ false].	sock sendMessage: 'peer-name ', userName.	peerSockets add: sock.	^ true! !!ScratchServer methodsFor: 'server control' stamp: 'KK 8/20/2013 14:28'!startHosting	"Open a socket on my port and start accepting connections."	Socket initializeNetwork.	self shutdownServer.	serverSocket _ Socket new.	serverSocket listenOn: self class portNumber backlogSize: 20.	incomingUDPSocket _ Socket newUDP setPort: self class portNumber.! !!ScratchServer methodsFor: 'private-server' stamp: 'KK 1/18/2013 09:47'!broadcastMessageFor: aString	"Answer a message to broadcast the given string."	| msg |	msg _ WriteStream on: String new.	msg nextPutAll: 'broadcast '.	self putString: aString on: msg.	^ msg contents! !!ScratchServer methodsFor: 'private-server' stamp: 'KK 1/18/2013 09:49'!sendOutgoingCommands	"Send broadcasts and variable updates to my peers."	| varUpdateMsg |	self someVariableHasChanged		ifTrue: [varUpdateMsg _ self variableUpdateMessage]		ifFalse: [varUpdateMsg _ nil].	peerSockets copy do: [:sock |		sock isConnected			ifTrue: [				varUpdateMsg ifNotNil: [sock sendMessage: varUpdateMsg].				outgoingBroadcasts do: [:evt | sock sendMessage: (self broadcastMessageFor: evt)].				sock sendData]			ifFalse: [				sock destroy.				peerSockets remove: sock ifAbsent: []]].	self recordVariableValues.! !!ScratchServer methodsFor: 'private-incoming commands' stamp: 'KK 10/23/2017 13:28'!doSensorUpdate: cmd from: requestSocket	"Handle a sensor update command: sensor-update [<sensor-name> <sensor-value>]"	| i sName sValue |	i _ 2.	[i < cmd size] whileTrue: [		sName _ cmd at: i.		sValue _ cmd at: i + 1.		(sName isKindOf: String)			ifTrue: [				sValue isNumber ifTrue:[					sensors at: (UTF8 withAll: sName) put: sValue.				] ifFalse: [					sensors at: (UTF8 withAll: sName) put: (UTF8 withAll: sValue).				].			].		i _ i + 2].! !!ScratchStackFrame methodsFor: 'accessing' stamp: 'KK 9/5/2017 14:53'!discardSvmFifo	| block sb |	block _ expression.	sb _ (block receiver ownerThatIsA: ScratchStageMorph) sensorBoard.	sb initSyncProc.! !!ScratchTabPaneMorph methodsFor: 'accessing' stamp: 'KK 7/18/2017 20:11'!currentTab: aString	currentTab _ aString.	self targetPane ifNil: [^ self].	(targetPane target isKindOf: ScratchStageMorph)		ifTrue: [self setLabelForTab: 'Costumes' to: 'Backgrounds' localized]		ifFalse: [self setLabelForTab: 'Costumes' to: 'Costumes' localized].	(targetPane target isKindOf: ArduinoScratchSpriteMorph)		ifTrue: [ currentTab _ 'Scripts'].	self lightUpCurrentTab.	targetPane currentCategory: aString.! !!ScratchTalkBubbleMorph methodsFor: 'intialization' stamp: 'KK 8/9/2017 17:33'!initialize	"Initialize the forms for all my elements."	super initialize.	self initFromForm: (ScratchFrameMorph skinAt: #talkBubbleFrame).	self beThoughtBubble: false.	pointLeft _ false.	contentsMorph _ MultilineStringMorph new		centerText: true;		font: (ScratchFrameMorph getFont: #TalkBubble).	contentsMorph		borderWidth: 0;		lock.	self addMorph: contentsMorph.! !!ScratchTalkBubbleMorph methodsFor: 'accessing' stamp: 'KK 8/9/2017 17:36'!message: aString	"(ScratchTalkBubbleMorph new message: 'Hello!!') openInWorld"	| maxWidth xOffset |	maxWidth _ 145.	contentsMorph		width: maxWidth;		contents: aString asUTF8 withBlanksTrimmed;		fitContents.	self extent: contentsMorph extent + (0@28).	xOffset _ contentsMorph width >= maxWidth		ifTrue: [3]		ifFalse: [((self width - contentsMorph width) // 2) + 3].	contentsMorph position: self position + (xOffset @ 5).! !!ScratchThread methodsFor: 'system cmds' stamp: 'KK 4/28/2014 11:21'!doRepeat	"Execute my enclosed blocks the number of times given by my argument. tmp is used to count down the iterations."	| cmd |	cmd _ cmds at: ip.	tmp ifNil: [  "first time"		tmp _ self evalArg: (cmd at: 2)].	tmp <= 0 ifTrue: [^ self].  "repeat is finished"	tmp _ tmp - 1.	self evalCmdList: (cmd at: 3).! !!ScratchTranslator class methodsFor: 'language translation' stamp: 'KK 8/30/2013 17:31'!setLanguage: aString	"Set the current language. If the language is not supported, use English (i.e. an empty translation dictionary)."	| dict |	"default to English"	Language _ 'en'.	TranslationDict _ Dictionary new.	HeaderString _ ''.	self setRenderingHints.  "clear rendering hints"	ScratchTranslator detectRenderPlugin.	aString = 'en' ifTrue: [^ self].	dict _ self importTranslation: aString, '.po'.	dict ifNotNil: [		Language _ aString.		TranslationDict _ dict.		HeaderString _ dict at: '' ifAbsent: [''].		dict removeKey: '' ifAbsent: [].		self setRenderingHints.		RenderWithSqueak ifTrue: [self convertToMacRoman].		self isRTL ifTrue: [self fixAmbigousRTLPunctuation].		self addSensorTranslations].! !!ScratchTranslator class methodsFor: 'rendering menu' stamp: 'sk 2/7/2017 11:58'!fontScale: aNumber	RenderScale _ aNumber.	self updateScratchUI.! !!ScratchTranslator class methodsFor: 'rendering menu' stamp: 'KK 8/3/2017 20:50'!updateScratchUI	"Update the UI of all ScratchFrameMorphs after changing the font or font scale."	RenderCenterOffsetCache _ RenderCenterOffsetCache species new.	RenderVerticalTrimCache _ RenderVerticalTrimCache species new.	ScratchFrameMorph allInstancesDo: [:m | m rebuildUIForNewLanguage].! !!ScratchTranslator class methodsFor: 'import/export' stamp: 'KK 8/30/2013 19:55'!exportStringsToTranslateFrom: aDictionary toFile: fName	"Export the strings to be translated either to Scratch.pot or an existing translation (.po) file."	"self resetUITranslationSet. self resetMIDITranslationSet. self exportStringsToTranslateFrom: nil toFile: nil"	"self resetMIDITranslationSet. self exportStringsToTranslateFrom: (self importTranslation: 'es.po') toFile: 'exportTest.po'"	| dir fn header f sections templateDict title keys comments |	self setLanguage: 'en'.	header _ HeaderString.	dir _ self translationDir.	fn _ fName.	fn ifNil: [fn _ self templateFilename].	(dir fileExists: fn) ifTrue: [  "extract the existing header, then delete the old .po file"		aDictionary ifNotNil: [			header _ aDictionary at: '' ifAbsent: [''].			dir deleteFileNamed: (dir fullNameFor: fn)]].	f _ FileStream newFileNamed: (dir fullNameFor: fn).	"f nextPutAll: #(239 187 191) asByteArray asString."  "UTF8 byte-order mark - removed for now (Pootle)"	"header comments are stored as '-comments' because the header key is the empty string"	aDictionary ifNotNil: [		comments _ aDictionary at: '-comments' ifAbsent: [#()].		comments do: [:s | f nextPutAll: s; crlf]].	"header is stored as a multi-line translation entry for the empty string"	self export: 'msgid' value: '' to: f.	self export: 'msgstr' value: header to: f.	f crlf.	sections _ {		{'FORMATTING'.			self formattingHeaderFields}.		{'BLOCKS'.				ScriptableScratchMorph blockSpecsForTranslation}.		{'USER INTERFACE'.		self uiTranslationSetAsSortedArray}. 		{'MIDI INSTRUMENTS'.	self midiTranslationSet asArray sort}	}.	aDictionary ifNotNil: [templateDict _ self importTranslation: self templateFilename].	sections do: [:pair |		title _ pair first.		keys _ pair second asOrderedCollection.		f nextPutAll: '############################################'; crlf.		f nextPutAll: '# ', title; crlf.		f nextPutAll: '############################################'; crlf.		f crlf.		((title = 'FORMATTING') and: [aDictionary isNil]) ifTrue: [			f nextPutAll: self formattingSectionForPOT.			keys _ OrderedCollection new].		keys removeAll: self doNotTranslate.		keys do: [:k |			(aDictionary isNil or: [templateDict includesKey: k]) ifTrue: [				"COMMENTS"				comments _ #().				(templateDict notNil and: [templateDict includesKey: k,'-comments'])					ifTrue: [ "use the comment from template .pot file if there is one"						comments _ (templateDict at: k, '-comments')]					ifFalse: [ "else use the comment from the translation file"						aDictionary ifNotNil: [							comments _ aDictionary at: k, '-comments' ifAbsent: [#()]]].				comments do: [:s | f nextPutAll: s; crlf].				"FUZZY TAG"				(aDictionary notNil and: [aDictionary includesKey: k, '-fuzzy'])					ifTrue: [f nextPutAll: '#, fuzzy'; crlf].				"KEY"				self export: 'msgid' value: k to: f.				"TRANSLATION"				(aDictionary notNil and: [aDictionary includesKey: k])					ifTrue: [						self export: 'msgstr' value: (aDictionary at: k) to: f]					ifFalse: [						(aDictionary notNil and: [aDictionary includesKey: k asLowercase])							ifTrue: [  "TEMPORARY CAPITALIZATION HACK"								self export: 'msgstr' value: (aDictionary at: k asLowercase) to: f]							ifFalse: [								(aDictionary notNil and: [(k endsWith: '?') and: [aDictionary includesKey: (k copyFrom: 1 to: k size - 1)]])									ifTrue: [  "TEMPORARY QUESTION HACK"										self export: 'msgstr' value: (aDictionary at: (k copyFrom: 1 to: k size - 1)) to: f]									ifFalse: [  "BLANK TRANSLATION"										self export: 'msgstr' value: '' to: f]]].				f crlf]]].	f close.! !!ScratchViewerMorph methodsFor: 'initialization' stamp: 'KK 7/4/2017 13:01'!rebuildCategorySelectors	| catList maxExtent buttons label offForm onForm overForm b pad leftColumnX rightColumnX x y |	catList _ #(		motion		control		looks		sensing		sound		operators		pen			variables)."	catList _ #(		motion		control					sensing					operators					variables)."	"First, delete the old category buttons"	submorphs do: [:m | (m isKindOf: ResizableToggleButton2) ifTrue: [m delete]].	"Create new buttons, keeping track of the maximum extent."	maxExtent _ 95@0.	buttons _ catList collect: [:cat |		label _ (ScratchTranslator translationFor: cat asString) capitalized.		offForm _ (ScratchFrameMorph skinAt: cat).		onForm _ (ScratchFrameMorph skinAt: (cat, 'Pressed')).		overForm _ (ScratchFrameMorph skinAt: (cat, 'Over')).		ScratchTranslator isRTL			ifTrue:[				b _ ResizableToggleButton2 new					offForm:	(offForm flipBy: #horizontal centerAt: offForm center)					onForm:		(onForm flipBy: #horizontal centerAt: onForm center)					overForm:	(overForm flipBy: #horizontal centerAt: overForm center)]			ifFalse:[				b _ ResizableToggleButton2 new					offForm:	offForm					onForm:		onForm					overForm:	overForm].		b			label: label font: (ScratchFrameMorph getFont: #Category);			setLabelColor: Color white;			target: self;			actionSelector: #currentCategory:;			arguments: (Array with: cat);			toggleButtonMode: true;			toggleMode: false.		ScratchTranslator isRTL			ifTrue:[b rightJustifyInset: 10]			ifFalse:[b leftJustifyInset: 10].		maxExtent _ maxExtent max: (b extent + (3 @ -6)).		b].	"calculate catButtonsExtent"	pad _ 25. "padding on left, right, and betwen the button columns"	catButtonsExtent _ ((2 * maxExtent x) + (3 * pad)) @ (((catList size // 2) * (maxExtent y + 6)) + 25).	"place the buttons"	leftColumnX _ self left + 12 + pad.	rightColumnX _ leftColumnX + maxExtent x + pad.	x _ leftColumnX.	y _ self top + 17.	1 to: buttons size do: [:i |		b _ buttons at: i.		b extent: maxExtent.		self addMorph: (b position: x@y).		i even			ifTrue: [x _ leftColumnX. y _ y + b height + 6]			ifFalse: [x _ rightColumnX]].	self width: catButtonsExtent x.	pageViewer position: self position + (0@catButtonsExtent y).	topSectionHeight _ catButtonsExtent y - 4.! !!ScratchViewerMorph methodsFor: 'accessing' stamp: 'KK 10/6/2017 15:16'!categoryChanged: aString	"The given category has changed (e.g., due to a variable or script add/remove). If it's the current category, update my contents. Otherwise, do nothing."	self target ifNil: [^ self].	currentCategory = aString ifTrue: [self updateContents].! !!ScratchViewerMorph methodsFor: 'accessing' stamp: 'KK 10/6/2017 15:29'!currentCategory: aString	World activeHand newKeyboardFocus: nil.	currentCategory _ aString.	self lightUpSelectorForCurrentCategory.	self updateContents.! !!ScratchViewerMorph methodsFor: 'private' stamp: 'KK 10/6/2017 15:14'!updateContents	| p |	self target ifNil: [		pageViewer contents: (Morph new color: ScratchFrameMorph palettePaneColor).		^ self].	p _ self target viewerPageForCategory: currentCategory.	p color: ScratchFrameMorph palettePaneColor.	pageViewer contents: p.	self isInWorld ifTrue: [self world startSteppingSubmorphsOf: p].	p fixLayout.	ScratchTranslator isRTL		ifTrue: [pageViewer hScrollPixels: (p right)].! !!ScriptableScratchMorph methodsFor: 'initialization' stamp: 'KK 7/11/2017 14:31'!initialize	| |	super initialize.	objName _ self nextInstanceName.	vars _ Dictionary new.	lists _ Dictionary new.	blocksBin _ ScratchScriptsMorph new.	isClone _ false.	costume _ self defaultImageMedia.	media _ OrderedCollection new.	costumeChangeMSecs _ 0.	visibility _ 100.	volume _ 100.	tempoBPM _ 60.	sceneStates _ Dictionary new.! !!ScriptableScratchMorph methodsFor: 'looks ops' stamp: 'sk 3/25/2016 16:43'!boardLED	" Check I/O pin configuration and answer a collection of board leds. "	| leds |Transcript show: 'boardLED'.	leds _ OrderedCollection new.	(IOPort at: 3) = 5 ifTrue: [		leds add: 'Red(D5)'].	(IOPort at: 4) = 5 ifTrue: [		leds add: 'Yellow(D6)'].	(IOPort at: 5) = 5 ifTrue: [		leds add: 'Green(D9)'].	^ leds! !!ScriptableScratchMorph methodsFor: 'looks ops' stamp: 'kk 7/5/2013 15:26'!bzrLEDPinNo	"Answer a collection of Buzzer/LED connected pin number."	^ #(		'A0'		'A1'		'A2'		'A3'		'A4'		'A5'		)! !!ScriptableScratchMorph methodsFor: 'looks ops' stamp: 'KK 9/20/2013 15:57'!bzrPinNo	" Check I/O pin configuration and reflect for argument "	"Answer a collection of buzzer number."	| offset validBuzzerPin id |	offset _ 10.	validBuzzerPin _ OrderedCollection new.	1 to: 8 do: [ :index |		id _ IOPort at: (index + offset).		id = 16r04 ifTrue: [			validBuzzerPin add: 'A', (index-1) asString.		]	].		^ validBuzzerPin.! !!ScriptableScratchMorph methodsFor: 'looks ops' stamp: 'KK 9/23/2013 21:20'!dcMotorNo	" Check I/O pin configuration and reflect for argument "	"Answer a collection of DC motor number."	| dcPin offset validDCPin id |	dcPin _ Array new: 2.	dcPin		at: 1 put: 'M1';		at: 2 put: 'M2'.	offset _ 0.	validDCPin _ OrderedCollection new.	1 to: 2 do: [ :index |		id _ IOPort at: (index + offset).		id = 1 ifTrue: [			validDCPin add: (dcPin at: index).		]	].		^ validDCPin."	^ #('M1' 'M2')	"! !!ScriptableScratchMorph methodsFor: 'looks ops' stamp: 'KK 2/12/2013 17:19'!dcMotorOff	"Answer a collection of DC motor Off."	^ #(		'Brake'		'Coast')! !!ScriptableScratchMorph methodsFor: 'looks ops' stamp: 'KK 2/12/2013 17:19'!dcMotorOn	"Answer a collection of DC motor On."	^ #(		'cw.'		'ccw.')! !!ScriptableScratchMorph methodsFor: 'looks ops' stamp: 'KK 9/4/2013 09:11'!ledColor	"Answer a collection of Buzzer/LED connected pin number."	^ #(		'White'		'Red'		'Green'		'Blue'		'Cyan'		'Magenta'		'Yellow'		)! !!ScriptableScratchMorph methodsFor: 'looks ops' stamp: 'kk 7/5/2013 15:24'!ledOnOff	"Answer a collection of LED On/Off."	^ #(		'on'		'off')! !!ScriptableScratchMorph methodsFor: 'looks ops' stamp: 'KK 9/20/2013 15:58'!ledPinNo	" Check I/O pin configuration and reflect for argument "	"Answer a collection of LED number."	| offset validLEDPin id |	offset _ 10.	validLEDPin _ OrderedCollection new.	1 to: 8 do: [ :index |		id _ IOPort at: (index + offset).		id = 16r03 ifTrue: [			validLEDPin add: 'A', (index-1) asString.		]	].		^ validLEDPin.! !!ScriptableScratchMorph methodsFor: 'looks ops' stamp: 'KK 12/26/2012 10:39'!motorOnOff	"Answer a collection of DC motor number."	^ #(		'on'		'off')! !!ScriptableScratchMorph methodsFor: 'looks ops' stamp: 'KK 1/24/2014 18:41'!moveDirection	"Answer a collection of move."	^ #(		'Forward'		'Back'		'Left front'		'Right front'		'Left rear'		'Right rear'		'cw.'		'ccw.'		)! !!ScriptableScratchMorph methodsFor: 'looks ops' stamp: 'sk 7/7/2016 19:38'!svMotorNo	" Check I/O pin configuration and reflect for argument "	"Answer a collection of servo motor number."	| servoPin offset validServoPin id |	(BoardType = 0 or: [BoardType = 2]) ifTrue: [		servoPin _ #('D2' 'D4' 'D7' 'D8' 'D9' 'D10' 'D11' 'D12').]	ifFalse: [		servoPin _ #('D5' 'D6' 'D9' 'D10' 'D11').].	offset _ 2.	validServoPin _ OrderedCollection new.	1 to: (servoPin size) do: [ :index |		id _ IOPort at: (index + offset).		id = 2 ifTrue: [			validServoPin add: (servoPin at: index).		]	].	^ validServoPin."	^ #('D2' 'D4' 'D7' 'D8' 'D9' 'D10' 'D11' 'D12')	"! !!ScriptableScratchMorph methodsFor: 'sensing ops' stamp: 'KK 10/5/2017 13:44'!accelerometer: sensorName	"Answer the value of the given sensor, or zero if the sensorboard is not available."	^ self studuinoSensor: sensorName.! !!ScriptableScratchMorph methodsFor: 'sensing ops' stamp: 'sk 4/14/2016 16:32'!clockValue: type	^ 0! !!ScriptableScratchMorph methodsFor: 'sensing ops' stamp: 'sk 2/18/2016 10:12'!clockVars	| varNames |	varNames _ #(		'Hour'		'Minute'		'Year'		'Month'		'Day'		'Temperature'		'Alarm hour'		'Alarm minute'	).	^ varNames! !!ScriptableScratchMorph methodsFor: 'sensing ops' stamp: 'KK 12/26/2017 20:58'!gyroSensor: sensorName	"Answer the value of the given sensor, or zero if the sensorboard is not available."	^ self studuinoSensor: sensorName.! !!ScriptableScratchMorph methodsFor: 'sensing ops' stamp: 'KK 9/20/2013 09:37'!hookupARButton	" Check I/O pin configuration and reflect for argument "	"Answer a collection of button number."	| offset validButton id |	offset _ 10.	validButton _ OrderedCollection new.	1 to: 4 do: [ :index |		id _ IOPort at: (index + offset).		id = 16r15 ifTrue: [			validButton add: 'A', (index-1) asString.		]	].		^ validButton.! !!ScriptableScratchMorph methodsFor: 'sensing ops' stamp: 'sk 4/1/2016 09:57'!hookupARSensorNames	| sensorNames offset light touch sound infrared acceleration button setAcceleration sensorID |	" Check IOPort "	Transcript show:(IOPort);cr.	offset _ 11.		" Offset for sensor ID "	light _ 16r10.			" Light sensor ID "	touch _ 16r11.			" Touch sensor ID "	sound _ 16r12.			" Sound sensor ID "	infrared _ 16r13.		" IR Photoreflector ID "	acceleration _ 16r14.		" Acceleration sensor ID "	button _ 16r15.			" Button sensor ID "	setAcceleration _ false.	" Set acceleration sensor flag "	sensorNames _ OrderedCollection new.	0 to: 7 do: [ :index |		sensorID _ IOPort at: (index + offset).		(sensorID < 16r10) ifTrue: [		] ifFalse: [			(sensorID = light) ifTrue: [	" Light Sensor "				sensorNames add:'[A',index asString,']',' Light sensor'.			].			(sensorID = touch) ifTrue: [	" Touch Sensor "				sensorNames add:'[A',index asString,']',' Touch sensor'.			].			(sensorID = sound) ifTrue: [	" Sound Sensor "				sensorNames add:'[A',index asString,']',' Sound sensor'.			].			(sensorID = infrared) ifTrue: [	" IR Photoreflector "				sensorNames add:'[A',index asString,']',' IR Photoreflector'.			].			(sensorID = acceleration) ifTrue: [	" Acceleration Sensor "				(setAcceleration = false) ifTrue: [					sensorNames add:'[A4/A5] Acceleration sensor (X)'.					sensorNames add:'[A4/A5] Acceleration sensor (Y)'.					sensorNames add:'[A4/A5] Acceleration sensor (Z)'.					setAcceleration _ True.				].			].			(sensorID = button) ifTrue: [	" Button "				sensorNames add:'[A',index asString,']',' Button'.			].		].	]."	sensorNames _ #(		'A0'		'A1'		'A2'		'A3'		'A4'		'A5'		'A6'		'A7'	)."	^ sensorNames! !!ScriptableScratchMorph methodsFor: 'sensing ops' stamp: 'KK 8/23/2013 13:35'!hookupARSensorPinID	| sensorNames |	sensorNames _ #(		'A0'		'A1'		'A2'		'A3'		'A4'		'A5'		'A6'		'A7'	).	^ sensorNames! !!ScriptableScratchMorph methodsFor: 'sensing ops' stamp: 'KK 8/23/2013 13:36'!hookupARSensorPinID1	| sensorNames |	sensorNames _ #(		'A0'		'A1'		'A2'		'A3'		'A4'		'A5'		'A6'		'A7'	).	^ sensorNames! !!ScriptableScratchMorph methodsFor: 'sensing ops' stamp: 'KK 8/31/2013 11:18'!hookupARSensorPinID2	^ #(		'A0'		'A1'		'A2'		'A3'		'A4'		'A5'	).! !!ScriptableScratchMorph methodsFor: 'sensing ops' stamp: 'KK 8/29/2013 17:32'!hookupARSensorXYZ	| sensorNames |	sensorNames _ #(		'X'		'Y'		'Z'	).	^ sensorNames! !!ScriptableScratchMorph methodsFor: 'sensing ops' stamp: 'KK 11/16/2017 10:13'!hookupBooleanSensorNames	| offset touch button sensorNames sensorID stage |	sensorNames _ OrderedCollection new.	(stage _ self ownerThatIsA: ScratchStageMorph) ifNil: [^0].	(stage showStuduinoBlocks) ifTrue: [		" Check IOPort "		Transcript show:(IOPort);cr.		offset _ 11.		" Offset for sensor ID "		touch _ 16r11.			" Touch sensor ID "		button _ 16r15.			" Button sensor ID "		0 to: 7 do: [ :index |			sensorID _ IOPort at: (index + offset).			(sensorID < 16r10) ifTrue: [			] ifFalse: [				(sensorID = touch) ifTrue: [	" Touch Sensor "					sensorNames add:'[A',index asString,']',' Studuino touch sensor pressed'.				].				(sensorID = button) ifTrue: [	" Button "					sensorNames add:'[A',index asString,']',' Studuino button pressed'.				].			].		].	].	^ sensorNames, #(		'-'		'button pressed'		'connected'	)! !!ScriptableScratchMorph methodsFor: 'sensing ops' stamp: 'KK 12/23/2017 15:41'!hookupGyroAccXYZ	| sensorNames |	sensorNames _ #(		'X(Acc)'		'Y(Acc)'		'Z(Acc)'		'X(Gyro)'		'Y(Gyro)'		'Z(Gyro)'	).	^ sensorNames! !!ScriptableScratchMorph methodsFor: 'sensing ops' stamp: 'KK 9/20/2013 09:26'!hookupIRPin	" Check I/O pin configuration and reflect for argument "	"Answer a collection of light sensor number."	| offset validIRPin id |	offset _ 10.	validIRPin _ OrderedCollection new.	1 to: 8 do: [ :index |		id _ IOPort at: (index + offset).		id = 16r13 ifTrue: [			validIRPin add: 'A', (index-1) asString.		]	].		^ validIRPin.! !!ScriptableScratchMorph methodsFor: 'sensing ops' stamp: 'KK 9/20/2013 09:25'!hookupLightPin	" Check I/O pin configuration and reflect for argument "	"Answer a collection of light sensor number."	| offset validLightPin id |	offset _ 10.	validLightPin _ OrderedCollection new.	1 to: 8 do: [ :index |		id _ IOPort at: (index + offset).		id = 16r10 ifTrue: [			validLightPin add: 'A', (index-1) asString.		]	].		^ validLightPin.! !!ScriptableScratchMorph methodsFor: 'sensing ops' stamp: 'KK 9/20/2013 09:13'!hookupSensorIDPin	| offset validServoPin id |	offset _ 10.	validServoPin _ OrderedCollection new.	1 to: 8 do: [ :index |		id _ IOPort at: (index + offset).		id = 16r10 ifTrue: [			validServoPin add: 'Light sensor(A', (index-1) asString, ')'.		]	].		^ validServoPin.! !!ScriptableScratchMorph methodsFor: 'sensing ops' stamp: 'KK 12/26/2017 20:39'!hookupSensorNames	| sensorNames stage virtualSensors offset light sound infrared acceleration setAcceleration sensorID temperature setGyro |	sensorNames _ OrderedCollection new.	(stage _ self ownerThatIsA: ScratchStageMorph) ifNil: [^0].	(stage showStuduinoBlocks) ifTrue: [		" Check IOPort "		Transcript show:(IOPort);cr.		offset _ 11.		" Offset for sensor ID "		light _ 16r10.			" Light sensor ID "		sound _ 16r12.			" Sound sensor ID "		infrared _ 16r13.		" IR Photoreflector ID "		acceleration _ 16r14.		" Acceleration sensor ID "		temperature _ 16r18.		" Temperature sensor ID "		setAcceleration _ false.	" Set acceleration sensor flag "		setGyro _ false.			" Set gyro sensor flag"		0 to: 7 do: [ :index |			sensorID _ IOPort at: (index + offset).			(sensorID < 16r10) ifTrue: [			] ifFalse: [				(sensorID = light) ifTrue: [	" Light Sensor "					sensorNames add:'[A',index asString,']',' Studuino light'.				].				(sensorID = sound) ifTrue: [	" Sound Sensor "					sensorNames add:'[A',index asString,']',' Studuino sound'.				].				(sensorID = infrared) ifTrue: [	" IR Photoreflector "					sensorNames add:'[A',index asString,']',' Studuino IR Photoreflector'.				].				(sensorID = temperature) ifTrue: [	" Temperature Sensor "					sensorNames add:'[A',index asString,']',' Studuino temperature'.				].				(sensorID = StdnoPIDGyro) ifTrue: [	" Gyro Sensor "					(setGyro = false) ifTrue: [						sensorNames add:'[A4/A5] Studuino gyro X(Acc)'.						sensorNames add:'[A4/A5] Studuino gyro Y(Acc)'.						sensorNames add:'[A4/A5] Studuino gyro Z(Acc)'.						sensorNames add:'[A4/A5] Studuino gyro X(Gyro)'.						sensorNames add:'[A4/A5] Studuino gyro Y(Gyro)'.						sensorNames add:'[A4/A5] Studuino gyro Z(Gyro)'.						setGyro _ True.					].				].				(sensorID = acceleration) ifTrue: [	" Acceleration Sensor "					(setAcceleration = false) ifTrue: [						sensorNames add:'[A4/A5] Studuino acceleration (X)'.						sensorNames add:'[A4/A5] Studuino acceleration (Y)'.						sensorNames add:'[A4/A5] Studuino acceleration (Z)'.						setAcceleration _ True.					].				].			].		].	].	sensorNames _ sensorNames, #(		'-'		'slider'		'light'		'sound'		'resistance'	).	sensorNames _ sensorNames, #('-' 'tilt' 'distance'). "WeDo sensors"	(stage _ self ownerThatIsA: ScratchStageMorph) ifNotNil: [		stage scratchServer ifNotNil: [			virtualSensors _ stage scratchServer sensorNames.			virtualSensors size > 0 ifTrue: [				^ sensorNames, {'-'}, stage scratchServer sensorNames]]].	^ sensorNames! !!ScriptableScratchMorph methodsFor: 'sensing ops' stamp: 'KK 9/20/2013 09:38'!hookupSoundPin	" Check I/O pin configuration and reflect for argument "	"Answer a collection of sound sensor number."	| offset validSoundPin id |	offset _ 10.	validSoundPin _ OrderedCollection new.	1 to: 8 do: [ :index |		id _ IOPort at: (index + offset).		id = 16r12 ifTrue: [			validSoundPin add: 'A', (index-1) asString.		]	].		^ validSoundPin.! !!ScriptableScratchMorph methodsFor: 'sensing ops' stamp: 'KK 9/20/2013 09:33'!hookupTouchPin	" Check I/O pin configuration and reflect for argument "	"Answer a collection of touch sensor number."	| offset validTouchPin id |	offset _ 10.	validTouchPin _ OrderedCollection new.	1 to: 8 do: [ :index |		id _ IOPort at: (index + offset).		id = 16r11 ifTrue: [			validTouchPin add: 'A', (index-1) asString.		]	].		^ validTouchPin.! !!ScriptableScratchMorph methodsFor: 'sensing ops' stamp: 'KK 12/26/2017 20:48'!indexForSensorName: sensorName	| sensorID usOffset |	"Answer the index for the given sensor name."	sensorName startsWithDigit ifTrue: [^ sensorName asNumberNoError].	usOffset _ 0.	sensorID _ IOPort at: (11).	" 11 and 12 : Ultra sonic ? "	sensorID = StdnoPIDUltrasonic ifTrue: [ usOffset _ 1. ].	sensorID _ IOPort at: (15).	" 14 and 15 : Acceleration ? "	'A0' = sensorName		ifTrue: [^ 1].	'A1' = sensorName		ifTrue: [^ 2].	'A2' = sensorName		ifTrue: [^ 3-usOffset].	'A3' = sensorName		ifTrue: [^ 4-usOffset].	((sensorID = StdnoPIDAcceleration) |	(sensorID = StdnoPIDGyro) |	(sensorID = StdnoPIDColor))	ifFalse: [		'A4' = sensorName		ifTrue: [^ 5-usOffset].		'A5' = sensorName		ifTrue: [^ 6-usOffset].		'A6' = sensorName		ifTrue: [^ 7-usOffset].		'A7' = sensorName		ifTrue: [^ 8-usOffset].	] ifTrue: [		(sensorID = StdnoPIDAcceleration) ifTrue: [			'X' = sensorName		ifTrue: [^ 5-usOffset].			'Y' = sensorName		ifTrue: [^ 6-usOffset].			'Z' = sensorName		ifTrue: [^ 7-usOffset].			'A6' = sensorName		ifTrue: [^ 8-usOffset].			'A7' = sensorName		ifTrue: [^ 9-usOffset].		].		(sensorID = StdnoPIDGyro) ifTrue: [			'X(Acc)' = sensorName		ifTrue: [^ 5-usOffset].			'Y(Acc)' = sensorName		ifTrue: [^ 6-usOffset].			'Z(Acc)' = sensorName		ifTrue: [^ 7-usOffset].			'X(Gyro)' = sensorName		ifTrue: [^ 8-usOffset].			'Y(Gyro)' = sensorName		ifTrue: [^ 9-usOffset].			'Z(Gyro)' = sensorName		ifTrue: [^ 10-usOffset].			'A6' = sensorName		ifTrue: [^ 11-usOffset].			'A7' = sensorName		ifTrue: [^ 12-usOffset].		].		(sensorID = StdnoPIDColor) ifTrue: [			'R' = sensorName		ifTrue: [^ 5-usOffset].			'G' = sensorName		ifTrue: [^ 6-usOffset].			'B' = sensorName		ifTrue: [^ 7-usOffset].			'C' = sensorName		ifTrue: [^ 8-usOffset].			'X' = sensorName		ifTrue: [^ 9-usOffset].			'Y' = sensorName		ifTrue: [^ 10-usOffset].			'myColor' = sensorName	ifTrue: [^ 11-usOffset].			'A6' = sensorName		ifTrue: [^ 12-usOffset].			'A7' = sensorName		ifTrue: [^ 13-usOffset].		].	].	'slider' = sensorName		ifTrue: [^ 1].	'light' = sensorName			ifTrue: [^ 2].	'sound' = sensorName		ifTrue: [^ 3].	(sensorName includesSubString: 'button') ifTrue: [^ 4].	(sensorName includes: $A)	ifTrue: [^ 5].	(sensorName includes: $B)	ifTrue: [^ 6].	(sensorName includes: $C)	ifTrue: [^ 7].	(sensorName includes: $D)	ifTrue: [^ 8].	^ 1! !!ScriptableScratchMorph methodsFor: 'sensing ops' stamp: 'sk 7/6/2016 10:10'!isInAlarm	^ true! !!ScriptableScratchMorph methodsFor: 'sensing ops' stamp: 'KK 10/5/2017 13:44'!lightSensor: sensorName	"Answer the value of the given sensor, or zero if the sensorboard is not available."	^ self studuinoSensor: sensorName.! !!ScriptableScratchMorph methodsFor: 'sensing ops' stamp: 'KK 12/19/2012 18:40'!motor: n deg: d| stage |! !!ScriptableScratchMorph methodsFor: 'sensing ops' stamp: 'KK 10/5/2017 13:45'!onBoardButton: sensorName	"Answer the value of the given sensor, or zero if the sensorboard is not available."	^ self studuinoSensor: sensorName.! !!ScriptableScratchMorph methodsFor: 'sensing ops' stamp: 'KK 10/5/2017 13:45'!onBoardLightSensor	"Answer the value of on-board light sensor value."	^ self studuinoSensor: 'A6'.! !!ScriptableScratchMorph methodsFor: 'sensing ops' stamp: 'KK 10/5/2017 13:45'!power	"Answer the value of battery voltage."	^ self studuinoSensor: 'A7'.! !!ScriptableScratchMorph methodsFor: 'sensing ops' stamp: 'KK 10/5/2017 13:42'!refPhotosensor: sensorName	"Answer the value of the given sensor, or zero if the sensorboard is not available."	^ self studuinoSensor: sensorName.! !!ScriptableScratchMorph methodsFor: 'sensing ops' stamp: 'KK 12/26/2017 20:52'!sensor: sensorName	"Answer the value of the given sensor, or zero if the sensorboard is not available."	| stage v sb sensorKey |	(stage _ self ownerThatIsA: ScratchStageMorph) ifNil: [^ 0].	stage scratchServer ifNotNil: [		v _ stage scratchServer sensorValueFor: sensorName.		v ifNotNil: [^ v]].	'tilt' = sensorName ifTrue: [^ WeDoPlugin tilt].	'distance' = sensorName ifTrue: [^ WeDoPlugin distance].	sb _ stage sensorBoard.	sensorKey _ sensorName.	(sensorName includesSubString: 'Studuino') ifTrue: [ sb _ stage studuinoBoard. ].	(sensorName includesSubString: '[A0]') ifTrue: [ sensorKey _ 'A0' ].	(sensorName includesSubString: '[A1]') ifTrue: [ sensorKey _ 'A1' ].	(sensorName includesSubString: '[A2]') ifTrue: [ sensorKey _ 'A2' ].	(sensorName includesSubString: '[A3]') ifTrue: [ sensorKey _ 'A3' ].	(sensorName includesSubString: '[A4]') ifTrue: [ sensorKey _ 'A4' ].	(sensorName includesSubString: '[A5]') ifTrue: [ sensorKey _ 'A5' ].	(sensorName includesSubString: '[A6]') ifTrue: [ sensorKey _ 'A6' ].	(sensorName includesSubString: '[A7]') ifTrue: [ sensorKey _ 'A7' ].	(sensorName includesSubString: '[A4/A5]') ifTrue: [		(sensorName includesSubString: '(X)') ifTrue: [ sensorKey _ 'X' ].		(sensorName includesSubString: '(Y)') ifTrue: [ sensorKey _ 'Y' ].		(sensorName includesSubString: '(Z)') ifTrue: [ sensorKey _ 'Z' ].		(sensorName includesSubString: 'X(Acc)') ifTrue: [ sensorKey _ 'X(Acc)' ].		(sensorName includesSubString: 'Y(Acc)') ifTrue: [ sensorKey _ 'Y(Acc)' ].		(sensorName includesSubString: 'Z(Acc)') ifTrue: [ sensorKey _ 'Z(Acc)' ].		(sensorName includesSubString: 'X(Gyro)') ifTrue: [ sensorKey _ 'X(Gyro)' ].		(sensorName includesSubString: 'Y(Gyro)') ifTrue: [ sensorKey _ 'Y(Gyro)' ].		(sensorName includesSubString: 'Z(Gyro)') ifTrue: [ sensorKey _ 'Z(Gyro)' ].	].	(BoardType = 0) ifTrue: [		"sb tryToOpenPort ifFalse: [^ 0]."]  "could not open"	ifFalse: [		sb socketIsOpen ifFalse: [^ 0]].	^ sb sensor: (self indexForSensorName: sensorKey)! !!ScriptableScratchMorph methodsFor: 'sensing ops' stamp: 'KK 11/30/2017 11:14'!sensorPressed: sensorName	"Answer true if a button connected to the given input of the sensor board is pressed. That is, if the sensor value is less than 10. Answer false if the sensor board cannot be opened."	| stage sb sensorKey |	(stage _ self ownerThatIsA: ScratchStageMorph) ifNil: [^ false].	sb _ stage sensorBoard.	sensorKey _ sensorName.	(sensorName includesSubString: 'Studuino') ifTrue: [ sb _ stage studuinoBoard. ].	(sensorName includesSubString: '[A0]') ifTrue: [ sensorKey _ 'A0' ].	(sensorName includesSubString: '[A1]') ifTrue: [ sensorKey _ 'A1' ].	(sensorName includesSubString: '[A2]') ifTrue: [ sensorKey _ 'A2' ].	(sensorName includesSubString: '[A3]') ifTrue: [ sensorKey _ 'A3' ].	(sensorName includesSubString: '[A4]') ifTrue: [ sensorKey _ 'A4' ].	(sensorName includesSubString: '[A5]') ifTrue: [ sensorKey _ 'A5' ]."	sb tryToOpenPort ifFalse: [^ false]."  "could not open"	(sb isKindOf: StuduinoSensorBoardMorph) ifTrue: [		^ ((sb sensor: (self indexForSensorName: sensorKey)) * 100.0) < 10	] ifFalse: [		^ (sb sensor: (self indexForSensorName: sensorKey)) < 10	].! !!ScriptableScratchMorph methodsFor: 'sensing ops' stamp: 'KK 10/5/2017 13:45'!soundSensor: sensorName	"Answer the value of the given sensor, or zero if the sensorboard is not available."	^ self studuinoSensor: sensorName.! !!ScriptableScratchMorph methodsFor: 'sensing ops' stamp: 'KK 10/5/2017 13:43'!studuinoSensor: sensorName	"Answer the value of the given sensor, or zero if the sensorboard is not available."	| stage v sb sensorKey |	(stage _ self ownerThatIsA: ScratchStageMorph) ifNil: [^ 0].	stage scratchServer ifNotNil: [		v _ stage scratchServer sensorValueFor: sensorName.		v ifNotNil: [^ v]].	sb _ stage studuinoBoard.	sensorKey _ sensorName.	(BoardType = 0) ifTrue: [		"sb tryToOpenPort ifFalse: [^ 0]."]  "could not open"	ifFalse: [		sb socketIsOpen ifFalse: [^ 0]].	^ sb sensor: (self indexForSensorName: sensorKey)! !!ScriptableScratchMorph methodsFor: 'sensing ops' stamp: 'KK 10/10/2017 12:35'!temperaturePinNo	" Check I/O pin configuration and reflect for argument "	"Answer a collection of button number."	| offset id validPin |	offset _ 10.	validPin _ OrderedCollection new.	1 to: 8 do: [ :index |		id _ IOPort at: (index + offset).		id = 16r18 ifTrue: [			validPin add: 'A', (index-1) asString.		]	].		^ validPin.! !!ScriptableScratchMorph methodsFor: 'sensing ops' stamp: 'KK 10/16/2017 11:07'!temperatureSensor: sensorName	"Answer the value of the given sensor, or zero if the sensorboard is not available."	^ self studuinoSensor: sensorName.! !!ScriptableScratchMorph methodsFor: 'sensing ops' stamp: 'KK 10/5/2017 13:45'!touchSensor: sensorName	"Answer the value of the given sensor, or zero if the sensorboard is not available."	^ self studuinoSensor: sensorName.! !!ScriptableScratchMorph methodsFor: 'list ops' stamp: 'KK 8/10/2017 09:46'!addGlobalList	| sFrame listName |	(sFrame _ self ownerThatIsA: ScratchFrameMorph) ifNil: [^ self beep].		ValueOrList _ false.	TabletMode ifTrue: [		sFrame sendMessageToBMnoBlocking: 'SHOWKEYPAD'].	listName _ StringDialog ask: 'List name?'.	TabletMode ifTrue: [		sFrame sendMessageToBMnoBlocking: 'HIDEKEYPAD'].	listName size = 0 ifTrue: [^ self].	sFrame workPane createListNamed: listName.	sFrame viewerPane categoryChanged: 'variables'.! !!ScriptableScratchMorph methodsFor: 'list ops' stamp: 'KK 10/10/2017 12:36'!blockDotIniPath	"Answer a menu for selecting a list variables."	| |! !!ScriptableScratchMorph methodsFor: 'list ops' stamp: 'sk 2/8/2017 13:49'!createListNamed: listName	| list stage n |	(self variableNameInUse: listName) ifTrue: [		self beep.		DialogBoxMorph warn: 'That variable name is already in use'.		^ self].	lists at: listName put: (list _ ScratchListMorph new listName: listName target: self).	(stage _ self ownerThatIsA: ScratchStageMorph) ifNotNil: [		n _ (stage submorphs select: [:m | m isKindOf: ScratchListMorph]) size.		"stage addMorph: (list position: stage topRight - ((list width + 10)@0) + (0@(10+(20*n))))."		stage addMorph: (list position: stage topLeft + (10@(10+(20*n)+(stage height // 2)))).		list startStepping].! !!ScriptableScratchMorph methodsFor: 'list ops' stamp: 'KK 12/23/2017 15:33'!defaultArgsFor: blockSpec	"Answer the default argument for the given block specification."	| defaultArgs stage sel currentSize list offset isDetect partsID arrPort |	defaultArgs _ blockSpec copyFrom: 4 to: blockSpec size.  "may be empty"	stage _ self ownerThatIsA: ScratchStageMorph.	sel _ (blockSpec at: 3) asSymbol.	#gotoX:y: = sel ifTrue: [		defaultArgs _ Array			with: self referencePosition x rounded			with: self referencePosition y rounded].	#glideSecs:toX:y:elapsed:from: = sel ifTrue: [		defaultArgs _ Array			with: 1			with: self referencePosition x rounded			with: self referencePosition y rounded].	#motor:direction: = self ifTrue: [		defaultArgs _ Array with: 'reverse' localized with: 'this way' localized with: 'that way'].	#setSizeTo: = sel ifTrue: [		currentSize _ (100.0 * (self scalePoint x max: self scalePoint y)) rounded.		defaultArgs _ Array with: currentSize].	#getAttribute:of: = sel ifTrue: [		(stage _ self ownerThatIsA: ScratchStageMorph) ifNotNil: [			list _ stage submorphs select: [:m | m isKindOf: ScratchSpriteMorph].			" I remove ArduinoScratchSpriteMorph from initialize value "			list _ list reject: [:m | m isKindOf: ArduinoScratchSpriteMorph.].			list sort: [:s1 :s2 | s1 objName asLowercase < s2 objName asLowercase].			list size > 0				ifTrue: [defaultArgs _ Array with: 'x position' with: list first]				ifFalse: [defaultArgs _ Array with: 'background #' with: stage]]		ifNil:[defaultArgs _ Array with: 'x position' with: self]].	#concatenate:with: = sel ifTrue: [		defaultArgs _ Array with: 'hello ' localized with: 'world' localized].	#doAsk = sel ifTrue: [		defaultArgs _ Array with: 'What''s your name?' localized].	#letter:of: = sel ifTrue: [		defaultArgs _ Array with: 1 with: 'world' localized].	#stringLength: = sel ifTrue: [		defaultArgs _ Array with: 'world' localized].	#say:duration:elapsed:from: = sel ifTrue: [		defaultArgs _ Array with: 'Hello!!' localized with: 2].	#say: = sel ifTrue: [		defaultArgs _ Array with: 'Hello!!' localized].	#think:duration:elapsed:from: = sel ifTrue: [		defaultArgs _ Array with: 'Hmm...' localized with: 2].	#think: = sel ifTrue: [		defaultArgs _ Array with: 'Hmm...' localized].	(#(lookLike: showBackground:) includes: sel) ifTrue: [		defaultArgs _ Array with: self costumeNames last].	(#(playSound: doPlaySoundAndWait) includes: sel) ifTrue: [		list _ self soundNames.		defaultArgs _ list size <= 2			ifTrue: [Array with: '']			ifFalse: [Array with: (list at: (list size - 2))]].	(#(broadcast: doBroadcastAndWait) includes: sel) ifTrue: [		stage ifNotNil: [defaultArgs _ Array with: stage defaultEventName]].	(#(append:toList: deleteLine:ofList: insert:at:ofList: list:export:) includes: sel) ifTrue: [		defaultArgs size >= 1 ifTrue: [			defaultArgs at: 1 put: (defaultArgs at: 1) localized]].	(#(append:toList: deleteLine:ofList: getLine:ofList: insert:at:ofList: lineCountOfList: list:export:)		includes: sel) ifTrue: [			defaultArgs _ defaultArgs copyWith: self defaultListName].	#setLine:ofList:to: = sel ifTrue: [		defaultArgs size >= 3 ifTrue: [			defaultArgs at: 2 put: self defaultListName.			defaultArgs at: 3 put: (defaultArgs at: 3) localized]].	#appendLettersOf:toList: = sel ifTrue: [		defaultArgs size >= 2 ifTrue: [			defaultArgs at: 1 put: (defaultArgs at: 1) localized.			defaultArgs at: 2 put: self defaultListName]].	#list:contains: = sel ifTrue: [		defaultArgs size >= 2 ifTrue: [			defaultArgs at: 1 put: self defaultListName.			defaultArgs at: 2 put: (defaultArgs at: 2) localized]].	#list:export: = sel ifTrue: [		defaultArgs size >= 2 ifTrue: [			defaultArgs at: 1 put: self defaultListName.			defaultArgs at: 2 put: (UTF8 withAll: (PathSettingArgMorph getDefaultPath, '\', self defaultListName, '.txt')).]].	((#motorNo:power: = sel) | (#motorNo:dcMotorOn: = sel) | (#motorNo:dcMotorOff: = sel)) ifTrue: [		isDetect _ false.			" detect DC motor? "		offset _ 0.				" 1-2:DC 3-10:SV 11-18:Sensor "		partsID _ 16r01.			" 01:DC 02:SV 03:LED 04:BZR 05:CLED 10:LS 11:TS 12:SS 13:IRS 14:3S 15:BTN"		defaultArgs at: 1 put: ''.		1 to: 2 do: [ :index |			(((IOPort at: (index+offset)) = partsID) & (isDetect = false)) ifTrue: [				(index = 1) ifTrue: [ defaultArgs at: 1 put: 'M1'. isDetect _ true. ].				(index = 2) ifTrue: [ defaultArgs at: 1 put: 'M2'. isDetect _ true. ].			]		].	].	#motorNo:degree: = sel ifTrue: [		isDetect _ false.			" detect servo motor? "		offset _ 2.				" 1-2:DC 3-10:SV 11-18:Sensor "		partsID _ 16r02.			" 01:DC 02:SV 03:LED 04:BZR 05:CLED 10:LS 11:TS 12:SS 13:IRS 14:3S 15:BTN"		defaultArgs at: 1 put: ''.	""		(BoardType = 0 or: [BoardType = 2]) ifTrue: [			arrPort _ #('D2' 'D4' 'D7' 'D8' 'D9' 'D10' 'D11' 'D12').]		ifFalse: [ " Studuino mini "			arrPort _ #('D5' 'D6' 'D9' 'D10' 'D11').].		1 to: (arrPort size) do: [:index |			((IOPort at: (index + offset)) = partsID) ifTrue: [				defaultArgs at: 1 put: (arrPort at: index).				^ defaultArgs.].]."		1 to: 8 do: [ :index |			(((IOPort at: (index+offset)) = partsID) & (isDetect = false)) ifTrue: [				(index = 1) ifTrue: [ defaultArgs at: 1 put: 'D2'. isDetect _ true. ].				(index = 2) ifTrue: [ defaultArgs at: 1 put: 'D4'. isDetect _ true. ].				(index = 3) ifTrue: [ defaultArgs at: 1 put: 'D7'. isDetect _ true. ].				(index = 4) ifTrue: [ defaultArgs at: 1 put: 'D8'. isDetect _ true. ].				(index = 5) ifTrue: [ defaultArgs at: 1 put: 'D9'. isDetect _ true. ].				(index = 6) ifTrue: [ defaultArgs at: 1 put: 'D10'. isDetect _ true. ].				(index = 7) ifTrue: [ defaultArgs at: 1 put: 'D11'. isDetect _ true. ].				(index = 8) ifTrue: [ defaultArgs at: 1 put: 'D12'. isDetect _ true. ].			]		]."	].	(#ledPin:onOff: = sel) ifTrue: [		isDetect _ false.			" detect buzzer? "		offset _ 10.				" 1-2:DC 3-10:SV 11-18:Sensor "		partsID _ 16r03.			" 01:DC 02:SV 03:LED 04:BZR 05:CLED 10:LS 11:TS 12:SS 13:IRS 14:3S 15:BTN"		defaultArgs at: 1 put: ''.		1 to: 6 do: [ :index |			(((IOPort at: (index+offset)) = partsID) & (isDetect = false)) ifTrue: [				defaultArgs at: 1 put: ('A', (index-1) asString).				isDetect _ true.			]		].	].	((#buzzerPin:freq: = sel) | (#buzzerPin: = sel)) ifTrue: [		isDetect _ false.			" detect buzzer? "		offset _ 10.				" 1-2:DC 3-10:SV 11-18:Sensor "		partsID _ 16r04.			" 01:DC 02:SV 03:LED 04:BZR 05:CLED 10:LS 11:TS 12:SS 13:IRS 14:3S 15:BTN"		defaultArgs at: 1 put: ''.		1 to: 6 do: [ :index |			(((IOPort at: (index+offset)) = partsID) & (isDetect = false)) ifTrue: [				defaultArgs at: 1 put: ('A', (index-1) asString).				isDetect _ true.			]		].	].	(#lightSensor: = sel) ifTrue: [		isDetect _ false.			" detect buzzer? "		offset _ 10.				" 1-2:DC 3-10:SV 11-18:Sensor "		partsID _ 16r10.			" 01:DC 02:SV 03:LED 04:BZR 05:CLED 10:LS 11:TS 12:SS 13:IRS 14:3S 15:BTN"		defaultArgs at: 1 put: ''.		(BoardType = 0 or: [BoardType = 2]) ifTrue: [			arrPort _ #('A0' 'A1' 'A2' 'A3' 'A4' 'A5' 'A6' 'A7').]		ifFalse: [ " Studuino mini "			arrPort _ #('A0' 'A1' 'A2' 'A3' 'A4' 'A5').].		1 to: (arrPort size) do: [:index |			((IOPort at: (index + offset)) = partsID) ifTrue: [				defaultArgs at: 1 put: (arrPort at: index).				^ defaultArgs.].]."		1 to: 8 do: [ :index |			(((IOPort at: (index+offset)) = partsID) & (isDetect = false)) ifTrue: [				defaultArgs at: 1 put: ('A', (index-1) asString).				isDetect _ true.			]		]."	].	(#touchSensor: = sel) ifTrue: [		isDetect _ false.			" detect buzzer? "		offset _ 10.				" 1-2:DC 3-10:SV 11-18:Sensor "		partsID _ 16r11.			" 01:DC 02:SV 03:LED 04:BZR 05:CLED 10:LS 11:TS 12:SS 13:IRS 14:3S 15:BTN"		defaultArgs at: 1 put: ''.		1 to: 6 do: [ :index |			(((IOPort at: (index+offset)) = partsID) & (isDetect = false)) ifTrue: [				defaultArgs at: 1 put: ('A', (index-1) asString).				isDetect _ true.			]		].	].	(#soundSensor: = sel) ifTrue: [		isDetect _ false.			" detect buzzer? "		offset _ 10.				" 1-2:DC 3-10:SV 11-18:Sensor "		partsID _ 16r12.			" 01:DC 02:SV 03:LED 04:BZR 05:CLED 10:LS 11:TS 12:SS 13:IRS 14:3S 15:BTN"		defaultArgs at: 1 put: ''.		1 to: 8 do: [ :index |			(((IOPort at: (index+offset)) = partsID) & (isDetect = false)) ifTrue: [				defaultArgs at: 1 put: ('A', (index-1) asString).				isDetect _ true.			]		].	].	(#refPhotosensor: = sel) ifTrue: [		isDetect _ false.			" detect buzzer? "		offset _ 10.				" 1-2:DC 3-10:SV 11-18:Sensor "		partsID _ 16r13.			" 01:DC 02:SV 03:LED 04:BZR 05:CLED 10:LS 11:TS 12:SS 13:IRS 14:3S 15:BTN"		defaultArgs at: 1 put: ''.		1 to: 8 do: [ :index |			(((IOPort at: (index+offset)) = partsID) & (isDetect = false)) ifTrue: [				defaultArgs at: 1 put: ('A', (index-1) asString).				isDetect _ true.			]		].	].	(#accelerometer: = sel) ifTrue: [		isDetect _ false.			" detect buzzer? "		offset _ 10.				" 1-2:DC 3-10:SV 11-18:Sensor "		partsID _ 16r14.			" 01:DC 02:SV 03:LED 04:BZR 05:CLED 10:LS 11:TS 12:SS 13:IRS 14:3S 15:BTN"		defaultArgs at: 1 put: ''.		1 to: 8 do: [ :index |			(((IOPort at: (index+offset)) = partsID) & (isDetect = false)) ifTrue: [				defaultArgs at: 1 put: 'X'.				isDetect _ true.			]		].	].	(#onBoardButton: = sel) ifTrue: [		isDetect _ false.			" detect buzzer? "		offset _ 10.				" 1-2:DC 3-10:SV 11-18:Sensor "		partsID _ 16r15.			" 01:DC 02:SV 03:LED 04:BZR 05:CLED 10:LS 11:TS 12:SS 13:IRS 14:3S 15:BTN"		defaultArgs at: 1 put: ''.		1 to: 4 do: [ :index |			(((IOPort at: (index+offset)) = partsID) & (isDetect = false)) ifTrue: [				defaultArgs at: 1 put: ('A', (index-1) asString).				isDetect _ true.			]		].	].	(#temperatureSensor: = sel) ifTrue: [		isDetect _ false.			" detect buzzer? "		offset _ 10.				" 1-2:DC 3-10:SV 11-18:Sensor "		partsID _ 16r18.		defaultArgs at: 1 put: ''.		1 to: 8 do: [ :index |			(((IOPort at: (index+offset)) = partsID) & (isDetect = false)) ifTrue: [				defaultArgs at: 1 put: ('A', (index-1) asString).				isDetect _ true.			]		].	].	(#gyroSensor: = sel) ifTrue: [		isDetect _ false.			" detect gyro? "		offset _ 10.				" 1-2:DC 3-10:SV 11-18:Sensor "		partsID _ StdnoPIDGyro.		defaultArgs at: 1 put: ''.		1 to: 8 do: [ :index |			(((IOPort at: (index+offset)) = partsID) & (isDetect = false)) ifTrue: [				defaultArgs at: 1 put: 'X(Acc)'.				isDetect _ true.			]		].	].	(#boardLED:onOff: = sel) ifTrue: [		isDetect _ false.			" detect buzzer? "		partsID _ 16r05.			" 01:DC 02:SV 03:LED 04:BZR 05:CLED 10:LS 11:TS 12:SS 13:IRS 14:3S 15:BTN"Transcript show: (IOPort at: 3); cr.		defaultArgs at: 1 put: ''.		((IOPort at: 3) = partsID) & (isDetect not) ifTrue: [			defaultArgs at: 1 put: 'Red(D5)'.			isDetect _ true].		((IOPort at: 4) = partsID) & (isDetect not) ifTrue: [			defaultArgs at: 1 put: 'Yellow(D6)'.			isDetect _ true].		((IOPort at: 5) = partsID) & (isDetect not) ifTrue: [			defaultArgs at: 1 put: 'Green(D9)'.			isDetect _ true].	].	^ defaultArgs! !!ScriptableScratchMorph methodsFor: 'list ops' stamp: 'KK 11/7/2017 11:06'!list: listName export: csvFile	| fullName f dir localName  lc list |	list _ self listNamed: listName ifNone: [^ ''].	" Output listfile. "	fullName _ csvFile.	dir _ FileDirectory forFileName: fullName.	localName _ FileDirectory localNameFor: fullName.	dir deleteFileNamed: localName.	f  _ StandardFileStream fileNamed: fullName.	f ifNil: [^ self.].	f nextPutAll: listName; crlf.	lc _ list listContents.	lc do: [:c | f nextPutAll: c contents; crlf].	f close.! !!ScriptableScratchMorph methodsFor: 'motor ops' stamp: 'KK 10/5/2017 10:17'!motorNo:n dcMotorOff:s	"Set On/Off the DC motor selected"	| stage sb mid ival |	"Check argument."	n = '' ifTrue: [^0].	(stage := self ownerThatIsA: ScratchStageMorph) ifNil: [^0].	sb _ stage studuinoBoard.	"sb tryToOpenPort ifFalse:[^0]."	mid _ 0.		" 0: DC Motor ID "	(n = 'M1') ifTrue: [ ival _ 16r0200. ].		"b0000 0010 0000 0000"	(n = 'M2') ifTrue: [ ival _ 16r0A00. ].	"b0000 1010 0000 0000"	(s = 'Brake') ifTrue: [ ival _ ival + 0. ].		" b0000 n010 0000 0000"	(s = 'Coast') ifTrue: [ ival _ ival + 1. ].		" b0000 n010 0000 0001 "	^sb data:ival msgID:mid.! !!ScriptableScratchMorph methodsFor: 'motor ops' stamp: 'KK 10/5/2017 11:16'!motorNo:n dcMotorOn:s	"Set On/Off the DC motor selected"	| stage sb mid ival |	"Check argument."	n = '' ifTrue: [^0].	(stage := self ownerThatIsA: ScratchStageMorph) ifNil: [^0].	sb _ stage studuinoBoard.	"sb tryToOpenPort ifFalse:[^0]."	mid _ 0.		" 0: DC Motor ID "	(n = 'M1') ifTrue: [ ival _ 16r0100. ].		" b0000 0001 0000 0000 "	(n = 'M2') ifTrue: [ ival _ 16r0900. ].		" b0000 1001 0000 0000 "	(s = 'cw.') ifTrue: [ ival _ ival + 0. ].	" b0000 n001 0000 0000 "	(s = 'ccw.') ifTrue: [ ival _ ival + 1. ].	" b0000 n001 0000 0001 "	^sb data:ival msgID:mid.! !!ScriptableScratchMorph methodsFor: 'motor ops' stamp: 'KK 10/5/2017 11:16'!motorNo:n degree:d	"Set degree the servo motor selected"	| stage sb mid ival pin offset index svPort |	" Check argument. "	n = '' ifTrue: [^0].	(stage := self ownerThatIsA: ScratchStageMorph) ifNil: [^0].	sb _ stage studuinoBoard.	"sb tryToOpenPort ifFalse:[^0]."	offset _ 0.	mid _ 1.		" 1 : Servo Motor ID"	index _ 1.	(BoardType = 0 or: [BoardType = 2]) ifTrue: [		(n = 'D2') ifTrue: [			pin _ 16r0000.			"b0000 0000 0000 0000"			offset _ SvCalib at:(5).	" Servomotor offset"			index _ 1.		].		(n = 'D4') ifTrue: [			pin _ 16r0200.			"b0000 0010 0000 0000"			offset _ SvCalib at:(6).	" Servomotor offset"			index _ 2.		].		(n = 'D7') ifTrue: [			pin _ 16r0400.			"b0000 0100 0000 0000"			offset _ SvCalib at:(7).	" Servomotor offset"			index _ 3.		].		(n = 'D8') ifTrue: [			pin _ 16r0600.			"b0000 0110 0000 0000"			offset _ SvCalib at:(8).	" Servomotor offset"			index _ 4.		].		(n = 'D9') ifTrue: [			pin _ 16r0800.			"b0000 1000 0000 0000"			offset _ SvCalib at:(1).	" Servomotor offset"			index _ 5.			(SvSentAlready at:index) ifTrue: [			] ifFalse: [				SvSentAlready at:index put:true.			].		].		(n = 'D10') ifTrue: [			pin _ 16r0A00.			"b0000 1010 0000 0000"			offset _ SvCalib at:(2).	" Servomotor offset"			index _ 6.		].		(n = 'D11') ifTrue: [			pin _ 16r0C00.			"b0000 1100 0000 0000"			offset _ SvCalib at:(3).	" Servomotor offset"			index _ 7.		].		(n = 'D12') ifTrue: [			pin _ 16r0E00.			"b0000 1110 0000 0000"			offset _ SvCalib at:(4).	" Servomotor offset"			index _ 8.		].		ival _ d asNumber.		ival _ ival + offset.	" Calibration "		(ival >= 180)  ifTrue: [ ival _ 180. ].		(ival <= 0)	 ifTrue: [ ival _ 0.   ].		ServomotorSynchroMotion ifTrue: [ SvDegreeTemp at:index put:ival. ]		ifFalse: [			SvDegreeTemp at:index put:ival. 			SvDegree at:index put:ival.		].		ival _ pin + ival rounded.	]	ifFalse: [		svPort _ #(D5 D6 D9 D10 D11).		index _ svPort asOrderedCollection find: n.		ival _ ((index - 1) bitShift: 9) + d.	].	^sb data:ival msgID:mid.! !!ScriptableScratchMorph methodsFor: 'motor ops' stamp: 'KK 10/5/2017 11:16'!motorNo:n onOff:s	"Set On/Off the DC motor selected"	| stage sb mid ival |	(stage := self ownerThatIsA: ScratchStageMorph) ifNil: [^0].	sb _ stage studuinoBoard.	"sb tryToOpenPort ifFalse:[^0]."	(n = 'M1') ifTrue: [ mid _ 0. ].	(n = 'M2') ifTrue: [ mid _ 1. ].	(s = 'on') ifTrue: [ ival _ 1. ].	(s = 'off') ifTrue: [ ival _ 0. ].	^sb data:ival msgID:mid.! !!ScriptableScratchMorph methodsFor: 'motor ops' stamp: 'KK 10/5/2017 11:16'!motorNo:n power: p	"Set Power the DC motor selected"	| stage sb mid ival tmp ratio |	"Check argument."	n = '' ifTrue: [^0].	(stage := self ownerThatIsA: ScratchStageMorph) ifNil: [^0].	sb _ stage studuinoBoard.	"sb tryToOpenPort ifFalse:[^0]."	mid _ 0.		" 0: DC Motor ID "	(n = 'M1') ifTrue: [		ratio _ (DCCalib at:1) / 100.0.		tmp _ 16r0400.		"b0000 0100 0000 0000"	].	(n = 'M2') ifTrue: [		ratio _ (DCCalib at:2) / 100.0.		tmp _ 16r0C00.		"b0000 1100 0000 0000"	].	ival _ (p asNumber) * ratio.	(ival >= 100)  ifTrue: [ ival _ 100. ].	(ival <= 0)	 ifTrue: [ ival _ 0.   ].	ival _ tmp + (ival rounded).				"b0000 n100 + val "	^sb data:ival msgID:mid.! !!ScriptableScratchMorph methodsFor: 'motor ops' stamp: 'KK 10/5/2017 11:16'!setServoSpeed:s d2:dg2 d4:dg4 d7:dg7 d8:dg8 d9:dg9 d10:dg10 d11:dg11 d12:dg12	"Set degree the servo motor selected"	| stage sb id pin offset ival d mid |Transcript show:'ScriptableScratchMorph::setServoSpeed:d2:d4:d7:d8:d9:d10:d11:d12';cr.	(stage := self ownerThatIsA: ScratchStageMorph) ifNil: [^0].	sb _ stage studuinoBoard.	" Set degrees "	mid _ 5.		" Multi servomotors start!! "	ival _ s.	" Set speed "	sb data:ival msgID:mid.	mid _ 1.		" Set servomotor's degree "	3 to: 10 do: [ :index | 		id _ IOPort at:index.	" Get port ID "		id = 2 ifTrue: [			(index = 3) ifTrue: [	" D2 "				pin _ 16r0000.			"b0000 0000 0000 0000"				offset _ SvCalib at:(5).	" Servomotor offset"				d _ dg2.			].			(index = 4) ifTrue: [	" D4 "				pin _ 16r0200.			"b0000 0010 0000 0000"				offset _ SvCalib at:(6).	" Servomotor offset"				d _ dg4.			].			(index = 5) ifTrue: [	" D7 "				pin _ 16r0400.			"b0000 0100 0000 0000"				offset _ SvCalib at:(7).	" Servomotor offset"				d _ dg7.			].			(index = 6) ifTrue: [	" D8 "				pin _ 16r0600.			"b0000 0110 0000 0000"				offset _ SvCalib at:(8).	" Servomotor offset"				d _ dg8.			].			(index = 7) ifTrue: [	" D9 "				pin _ 16r0800.			"b0000 1000 0000 0000"				offset _ SvCalib at:(1).	" Servomotor offset"				d _ dg9.			].			(index = 8) ifTrue: [	" D10 "				pin _ 16r0A00.			"b0000 1010 0000 0000"				offset _ SvCalib at:(2).	" Servomotor offset"				d _ dg10.			].			(index = 9) ifTrue: [	" D11 "				pin _ 16r0C00.			"b0000 1100 0000 0000"				offset _ SvCalib at:(3).	" Servomotor offset"				d _ dg11.			].			(index = 10) ifTrue: [" D12 "				pin _ 16r0E00.			"b0000 1110 0000 0000"				offset _ SvCalib at:(4).	" Servomotor offset"				d _ dg12.			].			" Convert unsigned to singed "			(offset > 127) ifTrue: [				offset _ offset - 256.			].			ival _ d asNumber.			ival _ ival + offset.	" Calibration "			(ival >= 180)  ifTrue: [ ival _ 180. ].			(ival <= 0)	 ifTrue: [ ival _ 0.   ].			ival _ pin + ival rounded.			"Transcript show:'ScriptableScratchMorph:: motorNo:degree:'; show: ival;cr."			sb data:ival msgID:mid.		].	].	mid _ 5.			" Multi servomotors Finish!! "	ival _ 16r0040.	"b0000 0000 0100 0000"	sb data:ival msgID:mid.	(Delay forMilliseconds: 3000 ) wait.! !!ScriptableScratchMorph methodsFor: 'other ops' stamp: 'KK 10/5/2017 10:18'!alhour: h almin: m	| stage sb data |	(stage := self ownerThatIsA: ScratchStageMorph) ifNil: [^0].	sb _ stage studuinoBoard.	data _ (16r2000) + (m bitShift: 5) + h.   "subID1: 2"Transcript show: data; cr.	^sb clockDataSend: data subID: 1.! !!ScriptableScratchMorph methodsFor: 'other ops' stamp: 'KK 10/5/2017 10:18'!boardLED: n onOff: s	"Set On/Off the LED selected"	| stage sb mid ival |	"Check argument."	n = '' ifTrue: [^0].	(stage := self ownerThatIsA: ScratchStageMorph) ifNil: [^0].	sb _ stage studuinoBoard.	"sb tryToOpenPort ifFalse:[^0]."	mid _ 3.		" 3: LED ID "	Transcript show:' board LED'; cr.	(n = 'Red(D5)') ifTrue: [ ival _ 16r0040. ].		" b0000 0000 0000 0000 "	(n = 'Yellow(D6)') ifTrue: [ ival _ 16r0240. ].		" b0000 0010 0000 0000 "	(n = 'Green(D9)') ifTrue: [ ival _ 16r0440. ].		" b0000 0100 0000 0000 "	(s = 'off') ifTrue: [ ival _ ival + 16r0000. ].	" b0000 xxx0 0000 0000 "	(s = 'on') ifTrue: [ ival _ ival + 16r0100. ].	" b0000 xxx1 0000 0000 "	^sb data:ival msgID:mid.! !!ScriptableScratchMorph methodsFor: 'other ops' stamp: 'KK 10/5/2017 10:19'!buzzerPin: n	"Set Off the buzzer selected"	| stage sb mid ival |	"Check argument."	n = '' ifTrue: [^0].	(stage := self ownerThatIsA: ScratchStageMorph) ifNil: [^0].	sb _ stage studuinoBoard.	"sb tryToOpenPort ifFalse:[^0]."	mid _ 2.		" 2: Buzzer ID "	" set port and buzzer ON "	(n = 'A0') ifTrue: [ ival _ 16r0000. ].		" b0000 0000 0000 0000 "	(n = 'A1') ifTrue: [ ival _ 16r0200. ].		" b0000 0010 0000 0000 "	(n = 'A2') ifTrue: [ ival _ 16r0400. ].		" b0000 0100 0000 0000 "	(n = 'A3') ifTrue: [ ival _ 16r0600. ].		" b0000 0110 0000 0000 "	(n = 'A4') ifTrue: [ ival _ 16r0800. ].		" b0000 1000 0000 0000 "	(n = 'A5') ifTrue: [ ival _ 16r0A00. ].		" b0000 1010 0000 0000 "	^sb data:ival msgID:mid.! !!ScriptableScratchMorph methodsFor: 'other ops' stamp: 'KK 10/5/2017 10:19'!buzzerPin: n freq: s	"Set frequency the buzzer selected"	| stage sb mid ival tmp |	"Check argument."	n = '' ifTrue: [^0].	(stage := self ownerThatIsA: ScratchStageMorph) ifNil: [^0].	sb _ stage studuinoBoard.	"sb tryToOpenPort ifFalse:[^0]."	mid _ 2.		" 2: Buzzer ID "	" set port and buzzer ON "	(n = 'A0') ifTrue: [ ival _ 16r0100. ].		" b0000 0001 0000 0000 "	(n = 'A1') ifTrue: [ ival _ 16r0300. ].		" b0000 0011 0000 0000 "	(n = 'A2') ifTrue: [ ival _ 16r0500. ].		" b0000 0101 0000 0000 "	(n = 'A3') ifTrue: [ ival _ 16r0700. ].		" b0000 0111 0000 0000 "	(n = 'A4') ifTrue: [ ival _ 16r0900. ].		" b0000 1001 0000 0000 "	(n = 'A5') ifTrue: [ ival _ 16r0B00. ].		" b0000 1011 0000 0000 "	tmp _ s asNumber.	(tmp < 48) ifTrue: [ tmp _ 48. ].	(tmp > 108) ifTrue: [ tmp _ 108. ].	tmp _ tmp - 24. "For new firmware"	ival _ ival + tmp.	"Transcript show:'ScriptableScratchMorph:: buzzerPin:freq:'; show: ival;cr."	^sb data:ival msgID:mid.! !!ScriptableScratchMorph methodsFor: 'other ops' stamp: 'KK 10/5/2017 10:20'!clkBackLight: onoff	| stage sb data |	(stage := self ownerThatIsA: ScratchStageMorph) ifNil: [^0].	sb _ stage studuinoBoard.	(onoff = 'on') ifTrue: [data _ 1]	ifFalse: [data _ 0]."	data _ 0.""	data _ (rVal bitShift: 12) + (gVal bitShift: 8) + (16r80) + bVal.""Transcript show: data; cr."	^sb clockOnOff: data.! !!ScriptableScratchMorph methodsFor: 'other ops' stamp: 'KK 10/5/2017 10:20'!clkBackLightOff	| stage sb data |	(stage := self ownerThatIsA: ScratchStageMorph) ifNil: [^0].	sb _ stage studuinoBoard.	data _ 0."	data _ (rVal bitShift: 12) + (gVal bitShift: 8) + (16r80) + bVal."Transcript show: data; cr.	^sb clockDataSend: data subID: 1.! !!ScriptableScratchMorph methodsFor: 'other ops' stamp: 'sk 2/22/2016 10:07'!clkBuzzerOFF! !!ScriptableScratchMorph methodsFor: 'other ops' stamp: 'KK 10/5/2017 10:20'!clkBuzzerOff	| mid ival sb stage |	(stage := self ownerThatIsA: ScratchStageMorph) ifNil: [^0].	sb _ stage studuinoBoard.	mid _ 2.		" 2: Buzzer ID "	" set port and buzzer ON "	ival _ 16r0040.	" b0000 0000 0100 0000 "	^sb data:ival msgID:mid.! !!ScriptableScratchMorph methodsFor: 'other ops' stamp: 'KK 10/5/2017 10:21'!clkBuzzerOnFreq: frequency	| stage sb mid ival tmp |	"Check argument."	"n = '' ifTrue: [^0]."	(stage := self ownerThatIsA: ScratchStageMorph) ifNil: [^0].	sb _ stage studuinoBoard.	"sb tryToOpenPort ifFalse:[^0]."	mid _ 2.		" 2: Buzzer ID "	" set port and buzzer ON "	ival _ 16r0100.	" b0000 0001 0000 0000 "	tmp _ frequency asNumber.	tmp _ tmp - 48.	(tmp > 47) & (tmp < 109) ifTrue: [ tmp _ 0. ].	ival _ ival + tmp.	"Transcript show:'ScriptableScratchMorph:: buzzerPin:freq:'; show: ival;cr."	^sb data:ival msgID:mid.! !!ScriptableScratchMorph methodsFor: 'other ops' stamp: 'KK 10/5/2017 10:21'!clkBuzzerOnFreq: frequency For: duration elapsed: elapsed from: ignored	| stage sb |	"Check argument."	"n = '' ifTrue: [^0]."	(stage := self ownerThatIsA: ScratchStageMorph) ifNil: [^0].	sb _ stage studuinoBoard.	^sb clockBuzzer: frequency For: duration! !!ScriptableScratchMorph methodsFor: 'other ops' stamp: 'KK 10/12/2017 08:24'!doSvmSyncMotion: delay"Set Off the buzzer selected"	| mid ival sb stage temp|	(stage := self ownerThatIsA: ScratchStageMorph) ifNil: [^0.].	sb _ stage studuinoBoard.	delay >= 0.0		ifTrue: [temp _ (delay + 0.5) truncated]		ifFalse: [temp _ (delay - 0.5) truncated].	(ServomotorSynchroMotion) ifTrue: [		(temp < 0) ifTrue: [			" Servomotors' synchro motion end. "			mid _ 5.			" Multi servomotors Finish!! "			ival _ 16r0040.	"b0000 0000 0100 0000"			sb data: ival msgID: mid.			ServomotorSynchroMotion _ false.		].	] ifFalse: [		" floor "		(temp < 0) ifTrue: [			temp _ 0.		].		" ceil "		(temp > 20) ifTrue: [			temp _ 20.		].		" Servomotors' synchro motion start. "		mid _ 5.			" Multi servomotors start!! "		ival _ temp + 3.	" Set speed "		sb data: ival msgID: mid.		ServomotorSynchroMotion _ true.		DelayMsecPerDeg _ temp + 3."		1 to: 8 do: [:index |			SvSentAlready at: index put: false.		].	"	].! !!ScriptableScratchMorph methodsFor: 'other ops' stamp: 'KK 10/5/2017 10:21'!hour: h min: m	| stage sb data |	(stage := self ownerThatIsA: ScratchStageMorph) ifNil: [^0].	sb _ stage studuinoBoard.	data _ (16r1000) + (m bitShift: 5) + h.Transcript show: data; cr.	^sb clockDataSend: data subID: 1.! !!ScriptableScratchMorph methodsFor: 'other ops' stamp: 'KK 10/5/2017 10:22'!ledColor: n onOff: s	"Set On/Off the LED selected"	| stage sb mid ival p |	(stage := self ownerThatIsA: ScratchStageMorph) ifNil: [^0].	sb _ stage studuinoBoard.	"sb tryToOpenPort ifFalse:[^0]."	mid _ 5.		" 5: Color LED ID "	(n = 'White') ifTrue: [ ival _ 16r0000. ].		" b0000 0000 0000 0000 "	(n = 'Red') ifTrue: [ ival _ 16r0200. ].		" b0000 0010 0000 0000 "	(n = 'Green') ifTrue: [ ival _ 16r0400. ].		" b0000 0100 0000 0000 "	(n = 'Blue') ifTrue: [ ival _ 16r0600. ].		" b0000 0110 0000 0000 "	(n = 'Cyan') ifTrue: [ ival _ 16r0800. ].		" b0000 1000 0000 0000 "	(n = 'Magenta') ifTrue: [ ival _ 16r0A00. ].	" b0000 1010 0000 0000 "	(n = 'Yellow') ifTrue: [ ival _ 16r0C00. ].		" b0000 1100 0000 0000 "	(s = 'off') ifTrue: [ ival _ ival + 16r0000. ].	" b0000 xxx0 0000 0000 "	(s = 'on') ifTrue: [ ival _ ival + 16r0100. ].	" b0000 xxx1 0000 0000 "	" check connected port. "	p _ IOPort at:11.	(p = 5) ifTrue: [ " A0, A1, A2 "	"Transcript show:'A0 : '; show: ival; cr."		^sb data:ival msgID:mid.	] ifFalse: [		p _ IOPort at: 14.		(p = 5) ifTrue: [ " A1, A2, A3 "			ival _ ival + 16r0001."Transcript show:'A1 : '; show: ival; cr."			^sb data:ival msgID:mid.		]	]! !!ScriptableScratchMorph methodsFor: 'other ops' stamp: 'KK 10/5/2017 11:15'!ledPin:n onOff:s	"Set On/Off the LED selected"	| stage sb mid ival |	"Check argument."	n = '' ifTrue: [^0].	(stage := self ownerThatIsA: ScratchStageMorph) ifNil: [^0].	sb _ stage studuinoBoard.	"sb tryToOpenPort ifFalse:[^0]."	mid _ 3.		" 3: LED ID "	(n = 'A0') ifTrue: [ ival _ 16r0000. ].		" b0000 0000 0000 0000 "	(n = 'A1') ifTrue: [ ival _ 16r0200. ].		" b0000 0010 0000 0000 "	(n = 'A2') ifTrue: [ ival _ 16r0400. ].		" b0000 0100 0000 0000 "	(n = 'A3') ifTrue: [ ival _ 16r0600. ].		" b0000 0110 0000 0000 "	(n = 'A4') ifTrue: [ ival _ 16r0800. ].		" b0000 1000 0000 0000 "	(n = 'A5') ifTrue: [ ival _ 16r0A00. ].		" b0000 1010 0000 0000 "	(s = 'off') ifTrue: [ ival _ ival + 16r0000. ].	" b0000 xxx0 0000 0000 "	(s = 'on') ifTrue: [ ival _ ival + 16r0100. ].	" b0000 xxx1 0000 0000 "	^sb data:ival msgID:mid.! !!ScriptableScratchMorph methodsFor: 'other ops' stamp: 'KK 7/12/2017 14:37'!mathFunctionNames	"Answer a collection of math function names."	^ #(		'abs'		'sqrt'		'sin'		'cos'		'tan'		'asin'		'acos'		'atan'		'ln'		'log'		'e ^'		'10 ^')! !!ScriptableScratchMorph methodsFor: 'other ops' stamp: 'KK 10/5/2017 11:16'!month:m day:d year:y	| stage sb data |	(stage := self ownerThatIsA: ScratchStageMorph) ifNil: [^0].	sb _ stage studuinoBoard.	data _ (m bitShift: 12) + ((y - 2000) bitShift: 5)  + d.Transcript show: data; cr.	^sb clockDataSend: data subID: 0.! !!ScriptableScratchMorph methodsFor: 'other ops' stamp: 'KK 10/5/2017 11:16'!pinNo:n onOff:s	"Set On/Off the LED selected"	| stage sb mid ival |	(stage := self ownerThatIsA: ScratchStageMorph) ifNil: [^0].	sb _ stage studuinoBoard.	"sb tryToOpenPort ifFalse:[^0]."	self halt.	mid _ 3.		" 3: LED ID "	(n = 'A0') ifTrue: [ ival _ 16r0000. ].		" b0000 0000 0000 0000 "	(n = 'A1') ifTrue: [ ival _ 16r0200. ].		" b0000 0010 0000 0000 "	(n = 'A2') ifTrue: [ ival _ 16r0400. ].		" b0000 0100 0000 0000 "	(n = 'A3') ifTrue: [ ival _ 16r0600. ].		" b0000 0110 0000 0000 "	(n = 'A4') ifTrue: [ ival _ 16r0800. ].		" b0000 1000 0000 0000 "	(n = 'A5') ifTrue: [ ival _ 16r0A00. ].		" b0000 1010 0000 0000 "	(s = 'off.') ifTrue: [ ival _ ival + 16r0000. ].	" b0000 xxx0 0000 0000 "	(s = 'on.') ifTrue: [ ival _ ival + 16r0100. ].	" b0000 xxx1 0000 0000 "	^sb data:ival msgID:mid.! !!ScriptableScratchMorph methodsFor: 'other ops' stamp: 'KK 8/2/2017 14:04'!randomFrom: start to: stop	"Answer a random number within the given range. If both min and max are integers, the result is rounded to the nearest integer."	| min max result |	min _ (start min: stop).	max _ (start max: stop).	result _ (RandomGen next * (max - min)) + min.	min isInteger & max isInteger		ifTrue: [result _ (RandomGen next * ((max + 1) - min)) truncated + min]		ifFalse: [result _ (RandomGen next * (max - min)) + min].	^ result! !!ScriptableScratchMorph methodsFor: 'other ops' stamp: 'KK 10/5/2017 11:16'!red: rVal green: gVal blue: bVal	| stage sb |	(stage := self ownerThatIsA: ScratchStageMorph) ifNil: [^0].	sb _ stage studuinoBoard."	data _ (16r8000) + (gVal bitShift: 8) + (rVal bitShift: 4)  + bVal.""	data _ (rVal bitShift: 12) + (gVal bitShift: 8) + (16r80) + bVal.""Transcript show: data; cr.""	^sb clockDataSend: data subID: 1."	^sb clockR: rVal G: gVal B: bVal.! !!ScriptableScratchMorph methodsFor: 'other ops' stamp: 'KK 4/30/2014 17:45'!wait: duration elapsed: elapsed from: ignored	"Do nothing; just wait for the time interval to elapse."	^ nil! !!ScriptableScratchMorph methodsFor: 'other ops' stamp: 'sk 2/18/2016 11:50'!year:y month:m day:d! !!ScriptableScratchMorph methodsFor: 'variables' stamp: 'KK 8/2/2017 10:16'!addGlobalVariable	"Ask the user for a variable name, then add a background (global) variable of that name."	| sFrame varName |	(sFrame _ self ownerThatIsA: ScratchFrameMorph) ifNil: [^ self beep].	ValueOrList _ false.	TabletMode ifTrue: [		sFrame sendMessageToBMnoBlocking: 'SHOWKEYPAD'].	varName _ StringDialog ask: 'Variable name?'.	TabletMode ifTrue: [		sFrame sendMessageToBMnoBlocking: 'HIDEKEYPAD'].	varName size = 0 ifTrue: [^ self].	varName _ varName asUTF8.	(sFrame workPane variableNameInUse: varName) ifTrue: [		self beep.		DialogBoxMorph warn: 'That variable name is already in use'.		^ self].	sFrame workPane addVariable: varName.	sFrame viewerPane categoryChanged: 'variables'.	self addWatcherForNewVariable: varName withScope: sFrame workPane.! !!ScriptableScratchMorph methodsFor: 'variables' stamp: 'KK 9/18/2013 19:17'!addVariable: varName	"Add a new user variable with the given name to this object. Do nothing if the variable already exists or is built in."	(vars includesKey: varName asString) ifFalse: [		vars at: varName asString put: 0].	self isClone: false.! !!ScriptableScratchMorph methodsFor: 'scripts' stamp: 'KK 12/26/2017 10:34'!addComment: aScratchCommentMorph	"Aligns the newly added script below the lowest script in the pane."	| y bottom |	y _ 10.	blocksBin submorphsDo: [:m |		bottom _  (m fullBounds bottom) - (blocksBin position y).		(bottom > y) ifTrue: 			[y _ bottom]].	aScratchCommentMorph position: blocksBin position + (20@(y+10)).	blocksBin addMorph: aScratchCommentMorph.! !!ScriptableScratchMorph methodsFor: 'scripts' stamp: 'KK 12/10/2014 13:22'!addStack: aBlockStack	"Aligns the newly added script below the lowest script in the pane."	| y bottom |	y _ 10.	blocksBin submorphsDo: [:m |		bottom _  (m fullBounds bottom) - (blocksBin position y).		(bottom > y) ifTrue: 			[y _ bottom]].	aBlockStack position: blocksBin position + (20@(y+10)).	aBlockStack newScriptOwner: self.	blocksBin addMorph: aBlockStack.! !!ScriptableScratchMorph methodsFor: 'blocks' stamp: 'KK 8/1/2017 11:17'!addGenericVariableBlocksTo: page x: x y: startY	"Add the generic variable blocks to the given page starting at the given y offset. Answer the new y."	| y vName stage block varBlocks |	y _ startY.	"pick a default variable name"	vName _ nil.	stage _ self ownerThatIsA: ScratchStageMorph.	(stage notNil and: [stage varNames size > 0])		ifTrue: [			vName _ stage varNames first]		ifFalse: [			self varNames size = 0 ifTrue: [^ y].			vName _ self varNames first].	varBlocks _ OrderedCollection new.	block _ SetterBlockMorph new		initSetterForVar: vName;		receiver: self blockReceiver.	block expressionArg stringExpression: '0'.	varBlocks add: block.	block _ SetterBlockMorph new		initChangerForVar: vName;		receiver: self blockReceiver.	block expressionArg numExpression: '1'.	varBlocks add: block.	(self blocksFor: 'variables') do: [:b |		b defaultArgs: (Array with: vName).		varBlocks add: b].	varBlocks do: [:b |		b color: self variableBlockColor.		page addMorph: (b position: x@y).		y _ b bottom + 3].	^ y! !!ScriptableScratchMorph methodsFor: 'blocks' stamp: 'KK 8/30/2013 20:15'!blockCategories	"Answer a list of block categories."	^ (self class blockSpecs select: [:el |		(el isKindOf: String) and: [el ~= '-' and: [el ~= '~']]]) asArray! !!ScriptableScratchMorph methodsFor: 'blocks' stamp: 'KK 12/23/2017 18:32'!blockFromSpec: spec color: blockColor	"Create a block from the given block specification. Answer nil if I don't implement the block spec selector."	| blockLabelSpec blockType selector defaultArgs block rcvr argPermutation dispBlockColor isDetect offset partsID invalidR invalidG invalidB |	invalidR _ 0.6.	invalidG _ 0.6.	invalidB _ 0.6.	blockLabelSpec _ ScratchTranslator translationFor: (spec at: 1).	argPermutation _ CommandBlockMorph argPermutationForSpec: (spec at: 1) withTranslation: blockLabelSpec.	blockType _ spec at: 2.	selector _ (spec at: 3) asSymbol.	defaultArgs _ self defaultArgsFor: spec.	dispBlockColor _ blockColor.	((defaultArgs size ~= 0)			& 	 ((#lightSensor: = selector)		|	  (#touchSensor: = selector)		|	  (#soundSensor: = selector)		|	  (#refPhotosensor: = selector)	|	  (#temperatureSensor: = selector)	|	  (#gyroSensor: = selector)	|	  (#accelerometer: = selector)	|	  (#onBoardButton: = selector)	|	  (#motorNo:degree: = selector)	|	  (#motorNo:power: = selector)	|	  (#motorNo:dcMotorOn: = selector)	|	  (#motorNo:dcMotorOff: = selector)	|	  (#buzzerPin:freq: = selector)	|	  (#buzzerPin: = selector)		|	  (#ledPin:onOff: = selector))	 ) ifTrue: [		((defaultArgs at: 1) = '') ifTrue: [			dispBlockColor _ (Color r: invalidR g: invalidG b: invalidB).		]	].	(BoardType = 1) ifTrue: [	" Clock's validity check. "	((IOPort at: 19) ~= 6) ifTrue: [		(#hour:min: = selector) ifTrue: [			dispBlockColor _ (Color r: invalidR g: invalidG b: invalidB).].		(#month:day:year: = selector) ifTrue: [			dispBlockColor _ (Color r: invalidR g: invalidG b: invalidB).].		(#alhour:almin: = selector) ifTrue: [			dispBlockColor _ (Color r: invalidR g: invalidG b: invalidB).].		(#red:green:blue: = selector) ifTrue: [			dispBlockColor _ (Color r: invalidR g: invalidG b: invalidB).].		(#clkBackLight: = selector) ifTrue: [			dispBlockColor _ (Color r: invalidR g: invalidG b: invalidB).].		(#clkBuzzerOnFreq:For:elapsed:from: = selector) ifTrue: [			dispBlockColor _ (Color r: invalidR g: invalidG b: invalidB).].		(#clkBuzzerOff = selector) ifTrue: [			dispBlockColor _ (Color r: invalidR g: invalidG b: invalidB).].		(#clockValue: = selector) ifTrue: [			dispBlockColor _ (Color r: invalidR g: invalidG b: invalidB).].		(#isInAlarm = selector) ifTrue: [			dispBlockColor _ (Color r: invalidR g: invalidG b: invalidB).].].].	" Color LED is used ? "	(#ledColor:onOff: = selector) ifTrue: [		isDetect _ false.			" detect buzzer? "		offset _ 10.				" 1-2:DC 3-10:SV 11-18:Sensor "		partsID _ 16r05.			" 01:DC 02:SV 03:LED 04:BZR 05:CLED 10:LS 11:TS 12:SS 13:IRS 14:3S 15:BTN"		1 to: 4 do: [ :index |			(((IOPort at: (index+offset)) = partsID) & (isDetect = false)) ifTrue: [				isDetect _ true.			]		].		isDetect = false ifTrue: [			dispBlockColor _ (Color r: invalidR g: invalidG b: invalidB).		].	].	(#(E K M S W) includes: blockType) ifTrue: [		^ (self hatBlockType: blockType) color: blockColor].	"basic block type: normal or C-shaped"	(blockType includes: $c)		ifTrue:	[			selector = #doIfElse				ifTrue: [block _ IfElseBlockMorph new isSpecialForm: true]				ifFalse: [block _ CBlockMorph new isSpecialForm: true]]		ifFalse:	[			(blockType includes: $r) | (blockType includes: $b)				ifTrue: [block _ ReporterBlockMorph new]				ifFalse: [block _ CommandBlockMorph new]].	(blockType includes: $b) ifTrue: [block isBoolean: true].	(blockType includes: $s) ifTrue: [block isSpecialForm: true].	(blockType includes: $t) ifTrue: [block isTimed: true].	(ScriptableScratchMorph isSpriteSpecificTarget: self selector: selector)		ifTrue: [rcvr _ self]		ifFalse: [rcvr _ self ownerThatIsA: ScratchStageMorph].	^ block		argPermutation: argPermutation;"		color: blockColor;"		color: dispBlockColor;		selector: selector;		commandSpec: blockLabelSpec;		defaultArgs: defaultArgs;		receiver: rcvr! !!ScriptableScratchMorph methodsFor: 'blocks' stamp: 'KK 12/26/2017 11:08'!blockFromTuple: tuple receiver: scriptOwner	"Answer a new block for the given tuple."	| k spec blockColor block argCount arg argBlock |	k _ tuple first.	(#(readVariable changeVariable) includes: k) ifTrue: [		^ self variableBlockFromTuple: tuple receiver: scriptOwner].	#contentsOfList: = k ifTrue: [		^ ListContentsBlockMorph new			color: ScriptableScratchMorph listBlockColor;			receiver: scriptOwner;			commandSpec: tuple second;			selector: #contentsOfList:].	(#(EventHatMorph KeyEventHatMorph MouseClickEventHatMorph WhenHatBlockMorph) includes: k) ifTrue: [		block _ self hatBlockFromTuple: tuple receiver: scriptOwner.		(block isKindOf: WhenHatBlockMorph) ifTrue: [block color: Color red].		^ block].	#scratchComment = k ifTrue: [		block _ ScratchCommentMorph new.		tuple size > 1 ifTrue: [block commentMorph contents: (tuple at: 2)].		tuple size > 2 ifTrue: [(tuple at: 3) ifFalse: [block toggleShowing]].		tuple size > 3 ifTrue: [block width: (tuple at: 4)].		tuple size > 4 ifTrue: [block anchor: (self blockWithID: (tuple at: 5))].		^ block].	#comment: = k ifTrue: [		block _ CommentBlockMorph new.		tuple size > 1 ifTrue: [block comment: (tuple at: 2)].		tuple size > 2 ifTrue: [(tuple at: 3) ifFalse: [block toggleShowing]].		block color: (Color r: 0.8 g: 0 b: 0).  "obsolete"		^ block]."Transcript show:'[ScriptableScratchMorph::blockFromTuple:receiver:]';cr.Transcript show:BlockSpecDict;cr."	spec _ BlockSpecDict at: k ifAbsent: [nil].	spec ifNil: ["Transcript show:'[ScriptableScratchMorph::blockFromTuple:receiver:] spec ifNill';cr."		^ scriptOwner			blockFromSpec: #('obsolete!!' - yourself)			color: Color red].	blockColor _ BlockColorDict at: k ifAbsent: [Color red].	block _ scriptOwner blockFromSpec: spec color: blockColor.	(block isKindOf: CommandBlockMorph) ifTrue: [		argCount _ block argumentCount min: tuple size - 1.		1 to: argCount do: [:i |			((#(+ - / * =) includes: block selector) and: [ScratchTranslator isRTLMath]) "RTLMath operators are RTL"				ifTrue: [arg _ tuple at: ((argCount + 1) - (i - 1))]				ifFalse: [arg _ tuple at: i + 1].			(arg isKindOf: Array)				ifTrue: [  "argument is a block"					((arg size = 1) and: [arg first isKindOf: Array]) ifTrue: [arg _ arg first].					argBlock _ self blockFromTuple: arg receiver: scriptOwner.					block replaceArgMorph: (block argumentAt: i) by: argBlock]				ifFalse: [  "argument is a value"					(block argumentAt: i) defaultValue: arg]].		(block isKindOf: CBlockMorph) ifTrue: [			(tuple last isKindOf: Array) ifTrue: [				block firstBlockList: (self stackFromTupleList: tuple last receiver: scriptOwner)]].		(block isKindOf: IfElseBlockMorph) ifTrue: [			arg _ tuple at: tuple size - 1.			(arg isKindOf: Array) ifTrue: [				block trueBlock: (self stackFromTupleList: arg receiver: scriptOwner)].			arg _ tuple at: tuple size.			(arg isKindOf: Array) ifTrue: [				block falseBlock: (self stackFromTupleList: arg receiver: scriptOwner)]].		(block isKindOf: ReporterBlockMorph) ifTrue: ["Transcript show:'[ScriptableScratchMorph::blockFromTuple:receiver:] ReporterBlockMorph';cr.Transcript show:'[ScriptableScratchMorph::blockFromTuple:receiver:] '; show: spec;cr."			((spec at: 2) includes: $b) ifTrue: [block isBoolean: true]]].	^ block! !!ScriptableScratchMorph methodsFor: 'blocks' stamp: 'KK 8/28/2013 20:30'!blockSpecForSelector: aSymbol	"Answer a block specification string (in English) for the give selector or nil if there is no spec that has the given selector."	self class blockSpecs do: [:spec |		((spec isKindOf: Array) and: [(spec at: 3) = aSymbol])			ifTrue: [^ spec first]].	^ nil! !!ScriptableScratchMorph methodsFor: 'blocks' stamp: 'KK 9/8/2017 15:24'!blocksFor: aCategory	"Answer a collection of blocks for the given category. Mixed with the blocks are dash and tilde symbols (#- and #~) indicating where full and half spaces should be inserted when laying out the blocks."	| blockColor blocksList category b |	blockColor _ self class blockColorFor: aCategory.	blocksList _ OrderedCollection new.	category _ nil.	self class blockSpecs do: [:spec |		((spec isKindOf: String) and: [spec ~= #- and: [spec ~= #~]])			ifTrue: [category _ spec]			ifFalse: [				category = aCategory ifTrue: [					(spec = #-) | (spec = #~)						ifTrue: [blocksList addLast: spec]						ifFalse: [							(b _ self blockFromSpec: spec color: blockColor) ifNotNil: [								blocksList addLast: b]]]]].	^ blocksList asArray! !!ScriptableScratchMorph methodsFor: 'blocks' stamp: 'sk 3/8/2016 13:53'!checkBlockValidity: spec	| blockType selector defaultArgs |	"Answer a copy of me for exporting."	blockType _ spec at: 2.	selector _ (spec at: 3) asSymbol.	defaultArgs _ self defaultArgsFor: spec.	((defaultArgs size ~= 0) & (#hour:min: = selector)) ifTrue: [		((IOPort at: 19) = 6) ifTrue: [Transcript show: 'hoge'; cr.			^ false.		]	].! !!ScriptableScratchMorph methodsFor: 'blocks' stamp: 'KK 12/10/2014 11:47'!convertStacksToTuples	"Convert my blocks bin from a morph containing block stack into a collection of (<point>, <tuple>) pairs the represent the same stacks in compact, language-independent form."	| stacks blocks comments |	(blocksBin isKindOf: Array) ifTrue: [^ self].  "already converted"	stacks _ (blocksBin submorphs select: [:m | m respondsTo: #tupleSequence]).	blocks _ stacks select: [:m | m isKindOf: BlockMorph].	comments _ stacks select: [:m | m isKindOf: ScratchCommentMorph].	blocks _ blocks collect: [:blockM |		Array			with: blockM position - blocksBin position			with: blockM tupleSequence].	comments _ comments collect: [:blockM |		Array			with: blockM position - blocksBin position			with: blockM tupleSequence].	blocksBin _ blocks, comments.! !!ScriptableScratchMorph methodsFor: 'blocks' stamp: 'KK 8/1/2017 11:27'!convertTuplesToStacks	"Convert my blocks bin from a collection of (<point>, <tuple>) pairs into a morph containing a number of block stacks."	| tuplesList stack |	(blocksBin isKindOf: Array) ifFalse: [^ self].  "already converted"	tuplesList _ blocksBin.	blocksBin _ ScratchScriptsMorph new.	tuplesList do: [:pair |		stack _ self stackFromTupleList: pair second receiver: self.		stack position: pair first.		blocksBin addMorph: stack].! !!ScriptableScratchMorph methodsFor: 'blocks' stamp: 'KK 8/29/2013 16:41'!createBlock: block atPosition: pos onPage: page	"Creates a block on the given page. If the block is one that can become a watcher, then a toggle button is created as well."	| x y changingX toggleButton yOffset frame |	x _ pos x.	y _ pos y.	changingX _ x.	block canBecomeWatcher ifTrue: [		toggleButton _ self createToggleButtonFor: block.		yOffset _ (block fullBounds height - toggleButton fullBounds height) // 2.		page addMorphBack: (toggleButton position: x@(y+yOffset)).		changingX _ x + toggleButton fullBounds width + 4].	block fixBlockLayout; position: changingX@y.	page addMorphBack: block.	block canBecomeWatcher ifTrue: [		frame _ self ownerThatIsA: ScratchFrameMorph.		page updateWatcherButtonsForFrame: frame].	^ y + block height + 3! !!ScriptableScratchMorph methodsFor: 'blocks' stamp: 'KK 9/23/2013 18:49'!hatBlockType: blockType	| stage evtName |	'E' = blockType ifTrue: [		evtName _ ''.		(stage _ self ownerThatIsA: ScratchStageMorph)			ifNotNil: [evtName _ stage defaultEventName].		^ EventHatMorph new scriptOwner: self; eventName: evtName].	'K' = blockType ifTrue: [^ KeyEventHatMorph new scriptOwner: self].	'M' = blockType ifTrue: [^ MouseClickEventHatMorph new scriptOwner: self].	'S' = blockType ifTrue: [ ^ EventHatMorph new forStartEvent scriptOwner: self].	'W' = blockType ifTrue: [^ WhenHatBlockMorph new scriptOwner: self].! !!ScriptableScratchMorph methodsFor: 'blocks' stamp: 'KK 9/18/2013 19:02'!variableBlockFromTuple: tuple receiver: scriptOwner	"Answer a new block for the given variable reference tuple."	| varName rcvr bg selector block arg argBlock |	varName _ tuple at: 2.	rcvr _ scriptOwner.	(scriptOwner varNames includes: varName) ifFalse: [		bg _ scriptOwner ownerThatIsA: ScratchStageMorph.		bg			ifNil: [scriptOwner addVariable: varName]			ifNotNil: [				bg addVariable: varName.				rcvr _ bg]].	tuple first = #readVariable ifTrue: [		^ VariableBlockMorph new			commandSpec: varName;			receiver: rcvr].	tuple first = #changeVariable ifTrue: [		selector _ tuple at: 3.		"update selector if necessary (backward compatibility):"		(selector = #set:to:) ifTrue: [selector _ #setVar:to:].		block _ SetterBlockMorph new receiver: rcvr.		selector = #setVar:to:			ifTrue: [block initSetterForVar: varName]			ifFalse: [block initChangerForVar: varName].		arg _ tuple at: 4.		(arg isKindOf: Array)			ifTrue: [  "argument is a block"				((arg size = 1) and: [arg first isKindOf: Array]) ifTrue: [arg _ arg first].				argBlock _ self blockFromTuple: arg receiver: scriptOwner.				block replaceArgMorph: block expressionArg by: argBlock]			ifFalse: [ "argument is a value"				block expressionArg defaultValue: arg].		^ block].	self error: 'unknown variable spec'! !!ScriptableScratchMorph methodsFor: 'blocks' stamp: 'KK 10/6/2017 15:14'!viewerPageForCategory: aCategoryName	"Answer a morph containing blocks for the given category for use in the given ScratchViewer."	| bin x y |	(self isMemberOf: ArduinoScratchSpriteMorph) ifTrue: ["		aCategoryName = 'motion' ifTrue: [ ^ self viewerPageFor: aCategoryName]."		aCategoryName = 'motion' ifTrue: [ ^ self viewerPageForMotion].		aCategoryName = 'control' ifTrue: [ ^ self viewerPageFor: aCategoryName].		aCategoryName = 'looks' ifTrue: [ ^ self viewerPageFor: aCategoryName].		aCategoryName = 'sensing' ifTrue: [ ^ self viewerPageForSensing"viewerPageFor: aCategoryName"].		aCategoryName = 'sound' ifTrue: [ ^ self viewerPageFor: aCategoryName].		aCategoryName = 'operators' ifTrue: [ ^ self viewerPageFor: aCategoryName].		aCategoryName = 'pen' ifTrue: [ ^ self viewerPageFor: aCategoryName].		aCategoryName = 'variables' ifTrue: [^ self variablesPage].	] ifFalse: [		aCategoryName = 'variables' ifTrue: [^ self variablesPage].		aCategoryName = 'motion' ifTrue: [^ self viewerPageForMotion].		aCategoryName = 'sensing' ifTrue: [^ self viewerPageForSensing].	].	bin _ ScratchBlockPaletteMorph new.	x _ 12.	y _ 10.	(self blocksFor: aCategoryName) do: [:blockOrSym |		(blockOrSym = #-) | (blockOrSym = #~)			ifTrue: [				(blockOrSym = #-) ifTrue: [y _ y + 15].  "insert a full space"				(blockOrSym = #~) ifTrue: [y _ y + 5]]  "insert a half space"			ifFalse: [				y _ self createBlock: blockOrSym atPosition: x@y onPage: bin]].	^ bin! !!ScriptableScratchMorph methodsFor: 'blocks' stamp: 'KK 10/6/2017 15:41'!viewerPageForMotion	"Answer a morph containing mtion blocks for the given category for use in the given ScratchViewer."	| bin isStage addMotorBlocks addStuduinoBlocks s x y font m |	bin _ ScratchBlockPaletteMorph new.	(self isKindOf: ScratchStageMorph)		ifTrue: [			isStage _ true.			addMotorBlocks _ self showMotorBlocks.			addStuduinoBlocks _ self showStuduinoBlocks]		ifFalse: [			isStage _ false.			s _ self ownerThatIsA: ScratchStageMorph.			addMotorBlocks _ s notNil and: [s showMotorBlocks].			addStuduinoBlocks _ s notNil and: [s showStuduinoBlocks]].	(isStage & ((addMotorBlocks not) & (addStuduinoBlocks not))) ifTrue: [		font _ (ScratchFrameMorph getFont: #ViewerPage).		x _ 20.		y _ 12.		m _ StringMorph contents: 'Stage selected:' localized font: font.		bin addMorph: (m color: Color white; position: x@y).		m _ StringMorph contents: 'No motion blocks' localized font: font.		bin addMorph: (m color: Color white; position: x@(y + 17)).		^ bin].	x _ 12.	y _ 10.	(self blocksFor: 'motion') do: [:blockOrSym |		(blockOrSym = #-) | (blockOrSym = #~)			ifTrue: [				(blockOrSym = #-) ifTrue: [y _ y + 15].  "insert a full space"				(blockOrSym = #~) ifTrue: [y _ y + 5]]  "insert a half space"			ifFalse: [				y _ self createBlock: blockOrSym atPosition: x@y onPage: bin]].	((addMotorBlocks not) & (addStuduinoBlocks not)) ifTrue: [^ bin].	isStage ifFalse: [		y _ y + 7.		bin addMorph: ((ImageMorph new form: (ScratchFrameMorph skinAt: #connector)) position: x@y).		y _ y + 20].	addStuduinoBlocks ifTrue: [		(self blocksFor: 'studuino') do: [:blockOrSym |			(blockOrSym = #-) | (blockOrSym = #~)				ifTrue: [					(blockOrSym = #-) ifTrue: [y _ y + 15].  "insert a full space"					(blockOrSym = #~) ifTrue: [y _ y + 5]]  "insert a half space"				ifFalse: [					y _ self createBlock: blockOrSym atPosition: x@y onPage: bin]].		(self blocksFor: 'studuino control') do: [:blockOrSym |			(blockOrSym = #-) | (blockOrSym = #~)				ifTrue: [					(blockOrSym = #-) ifTrue: [y _ y + 15].  "insert a full space"					(blockOrSym = #~) ifTrue: [y _ y + 5]]  "insert a half space"				ifFalse: [					y _ self createBlock: blockOrSym atPosition: x@y onPage: bin]].	].	isStage ifFalse: [		y _ y + 7.		bin addMorph: ((ImageMorph new form: (ScratchFrameMorph skinAt: #connector)) position: x@y).		y _ y + 20].	addMotorBlocks ifTrue: [		(self blocksFor: 'motor') do: [:blockOrSym |			(blockOrSym = #-) | (blockOrSym = #~)				ifTrue: [					(blockOrSym = #-) ifTrue: [y _ y + 15].  "insert a full space"					(blockOrSym = #~) ifTrue: [y _ y + 5]]  "insert a half space"				ifFalse: [					y _ self createBlock: blockOrSym atPosition: x@y onPage: bin]].	].	" Only for Studuino mini "	(BoardType = 1) ifTrue: [		(self blocksFor: 'motion mini') do: [:blockOrSym |			(blockOrSym = #-) | (blockOrSym = #~)				ifTrue: [					(blockOrSym = #-) ifTrue: [y _ y + 15].  "insert a full space"					(blockOrSym = #~) ifTrue: [y _ y + 5]]  "insert a half space"				ifFalse: [					y _ self createBlock: blockOrSym atPosition: x@y onPage: bin]].].	^ bin! !!ScriptableScratchMorph methodsFor: 'blocks' stamp: 'sk 2/26/2016 20:58'!viewerPageForSensing	"Answer a morph containing mtion blocks for the given category for use in the given ScratchViewer."	| bin x y |	bin _ ScratchBlockPaletteMorph new.	x _ 12.	y _ 10.	(self blocksFor: 'sensing') do: [:blockOrSym |		(blockOrSym = #-) | (blockOrSym = #~)			ifTrue: [				(blockOrSym = #-) ifTrue:[y _ y + 15]. "insert a full space"				(blockOrSym = #~) ifTrue: [					y _ y + 7.					bin addMorph: ((ImageMorph new form: (ScratchFrameMorph skinAt: #connector)) position: x@y).					y _ y + 20]]			ifFalse: [				y _ self createBlock: blockOrSym atPosition: x@y onPage: bin]].	" Only for Studuino mini "	(BoardType = 1) ifTrue: [		(self blocksFor: 'sensing mini') do: [:blockOrSym |			(blockOrSym = #-) | (blockOrSym = #~)				ifTrue: [					(blockOrSym = #-) ifTrue:[y _ y + 15]. "insert a full space"					(blockOrSym = #~) ifTrue: [						y _ y + 7.						bin addMorph: ((ImageMorph new form: (ScratchFrameMorph skinAt: #connector)) position: x@y).						y _ y + 20]]				ifFalse: [					y _ self createBlock: blockOrSym atPosition: x@y onPage: bin]].].	^ bin! !!ScriptableScratchMorph methodsFor: 'event handling' stamp: 'KK 8/3/2017 13:19'!doubleClick: evt	"Show my viewer and script editor."		| hand |	hand _ self world activeHand.	hand toolType ifNotNil: [		^ self handleTool: hand toolType hand: hand].	self viewBlocksAndScripts.! !!ScriptableScratchMorph methodsFor: 'object i/o' stamp: 'KK 1/21/2013 19:19'!storeFieldsOn: anObjStream	| oldBlockBinOwner |	super storeFieldsOn: anObjStream.	(blocksBin isKindOf: Morph) ifTrue: [		oldBlockBinOwner _ blocksBin owner.		blocksBin delete].	self storeFieldsNamed: #(		objName		vars		blocksBin		isClone		media		costume	) on: anObjStream.	oldBlockBinOwner ifNotNil: [oldBlockBinOwner addMorph: blocksBin].! !!ScriptableScratchMorph methodsFor: 'private' stamp: 'KK 7/11/2017 14:55'!copyRecordingIn: dict	"Copy my fields and scripts."	| newCopy newBlocksBin |	(self respondsTo: #sayNothing) ifTrue: [self sayNothing].  "remove talk bubble before copying"	newCopy _ super copyRecordingIn: dict.	newCopy renewFilterPack.	newBlocksBin _ blocksBin fullCopy.	newBlocksBin allMorphsDo: [:m |		(m isKindOf: HatBlockMorph) ifTrue: [m scriptOwner: newCopy].		(m isKindOf: CommandBlockMorph) ifTrue: [m mapReceiver: self to: newCopy]].	newCopy vars: vars copy lists: (self copyListsFor: newCopy) blocksBin: newBlocksBin.	newCopy objName: self nextInstanceName.	newCopy setMedia: (media collect: [:el | el copy]).	newCopy lookLike: costume mediaName.	^ newCopy! !!ScriptableScratchMorph methodsFor: 'private' stamp: 'KK 2/27/2015 15:16'!getHatlessBlocks	| stacks aloneBlocks |	aloneBlocks _ nil.	stacks _ blocksBin submorphs select: [:m | m isKindOf: BlockMorph].	stacks size = 0 ifTrue: [		^ aloneBlocks].	aloneBlocks _ stacks select: [:m | (m isKindOf: HatBlockMorph) not].	^ aloneBlocks! !!ScriptableScratchMorph methodsFor: 'private' stamp: 'KK 10/10/2017 12:42'!printArduLangOn: aStream 	| stacks hats evtName index partsName portName offset f j b initCode |	stacks _ blocksBin submorphs select: [:m | m isKindOf: BlockMorph].	stacks size = 0 ifTrue: [		^ self].	hats _ stacks select: [:m | m isKindOf: HatBlockMorph].	" Include file declaration "	aStream nextPutAll: '// ---------------------------------------'; cr.	aStream nextPutAll: '// Servomotor calibration data'; cr.	aStream nextPutAll: '// ---------------------------------------'; cr.	aStream nextPutAll: 'char SvCalibrationData[] = { '.	(BoardType = 0 or: [BoardType = 2]) ifTrue: [		5 to: 8 do: [:i|			offset _ SvCalib at:(i).			aStream nextPutAll: offset asString, ', '].		1 to: 4 do: [:i|			offset _ SvCalib at:(i).			aStream nextPutAll: offset asString, ', ']]	ifFalse: [ " Studuino mini "		SvCalib do: [:elm |			offset _ elm.			aStream nextPutAll: offset asString, ', '.]	].	aStream nextPutAll: ' };'; cr.	aStream nextPutAll: '// ---------------------------------------'; cr.	aStream nextPutAll: '// DC motor calibration data'; cr.	aStream nextPutAll: '// ---------------------------------------'; cr.	aStream nextPutAll: 'byte DCCalibrationData[] = { '.	offset _ DCCalib at:(1).	aStream nextPutAll: offset asString, ', '.	offset _ DCCalib at:(2).	aStream nextPutAll: offset asString.	aStream nextPutAll: ' };'; cr.	" Prototype declaration "	aStream nextPutAll: '// ---------------------------------------'; cr.	aStream nextPutAll: '// prototype declaration'; cr.	aStream nextPutAll: '// ---------------------------------------'; cr.	hats do: [:item |		evtName _ item eventName.		evtName = 'Scratch-StartClicked'			ifTrue: [aStream nextPutAll: 'void artecRobotMain();']			ifFalse: [aStream nextPutAll: 'void ARSR_', evtName, '();'].		aStream cr.	].	aStream nextPutAll: '// ---------------------------------------'; cr.	aStream nextPutAll: '// Global variable'; cr.	aStream nextPutAll: '// ---------------------------------------'; cr.	"Define value"	self varNames do: [:v |		aStream nextPutAll: 'float ARVAL_' , v, ';'.		aStream cr.	].	"Define list"	self listVarNames do: [:v |		aStream nextPutAll: 'cell ARLIST_' , v, ';'.		aStream cr.	].	aStream nextPutAll: 'byte port[8];';cr.	aStream nextPutAll: 'byte degree[8];';cr.	aStream nextPutAll: '// ---------------------------------------'; cr.	aStream nextPutAll: '// Artec robot setup routine'; cr.	aStream nextPutAll: '// ---------------------------------------'; cr.	aStream nextPutAll: 'void artecRobotSetup() {'; cr.	"For Studuino mini clock initialization."	(BoardType == 1) ifTrue: [		((IOPort at: 19) = 6) ifTrue: [ "Clock is enabled."			aStream nextPutAll: '    board.InitClock();'; cr.].].	index _ 0.	IOPort do: [ :partsID |		(partsID ~= 0) ifTrue: [			(index = 0) ifTrue: [				aStream nextPutAll: '    board.InitDCMotorPort(PORT_M1);'; cr."Transcript show: 'initDCMotor('; show:index; show: ');'; cr."			].			(index = 1) ifTrue: [				aStream nextPutAll: '    board.InitDCMotorPort(PORT_M2);'; cr."Transcript show: 'initDCMotor('; show:index; show: ');'; cr."			].	" Board selection "	(BoardType = 0 or: [BoardType = 2]) ifTrue: [	" For Studuino "			(index = 2) ifTrue: [				aStream nextPutAll: '    board.InitServomotorPort(PORT_D2);'; cr.			].			(index = 3) ifTrue: [				aStream nextPutAll: '    board.InitServomotorPort(PORT_D4);'; cr.			].			(index = 4) ifTrue: [				aStream nextPutAll: '    board.InitServomotorPort(PORT_D7);'; cr.			].			(index = 5) ifTrue: [				aStream nextPutAll: '    board.InitServomotorPort(PORT_D8);'; cr.			].			(index = 6) ifTrue: [				aStream nextPutAll: '    board.InitServomotorPort(PORT_D9);'; cr.			].			(index = 7) ifTrue: [				aStream nextPutAll: '    board.InitServomotorPort(PORT_D10);'; cr.			].			(index = 8) ifTrue: [				aStream nextPutAll: '    board.InitServomotorPort(PORT_D11);'; cr.			].			(index = 9) ifTrue: [				aStream nextPutAll: '    board.InitServomotorPort(PORT_D12);'; cr.			].]	ifFalse: [	" For Studuino mini "		((index > 1) & (index < 10)) ifTrue: [			(partsID = 2) ifTrue: [				initCode _ '    board.InitServomotorPort(']			ifFalse: [				initCode _ '    board.InitDigitalPort('].			(index = 2) ifTrue: [				initCode _ initCode, 'PORT_D5'.].			(index = 3) ifTrue: [				initCode _ initCode, 'PORT_D6'.].			(index = 4) ifTrue: [				initCode _ initCode, 'PORT_D9'.].			(index = 5) ifTrue: [				initCode _ initCode, 'PORT_D10'.].			(index = 6) ifTrue: [				initCode _ initCode, 'PORT_D11'.].			(partsID = 5) ifTrue: [				initCode _ initCode, ', PIDLED'.].			aStream nextPutAll: initCode, ');'; cr.].]."			((index > 1) & (index < 10)) ifTrue: [				aStream nextPutAll: '    initSVMotor('.				aStream nextPutAll: (index-2) asString.				aStream nextPutAll: ');'; cr.			]."			(index > 9) & (index < 18) ifTrue: [				(partsID = 16r03) ifTrue: [ partsName _ 'PIDLED' ].				(partsID = 16r04) ifTrue: [ partsName _ 'PIDBUZZER' ].				(partsID = 16r05) ifTrue: [ partsName _ 'PIDCOLORLED' ].				(partsID = 16r10) ifTrue: [ partsName _ 'PIDLIGHTSENSOR' ].				(partsID = 16r11) ifTrue: [ partsName _ 'PIDTOUCHSENSOR' ].				(partsID = 16r12) ifTrue: [ partsName _ 'PIDSOUNDSENSOR' ].				(partsID = 16r13) ifTrue: [ partsName _ 'PIDIRPHOTOREFLECTOR' ].				(partsID = 16r14) ifTrue: [ partsName _ 'PIDACCELEROMETER' ].				(partsID = 16r15) ifTrue: [ partsName _ 'PIDPUSHSWITCH' ].				(partsID = 16r18) ifTrue: [ partsName _ 'PIDTEMPERATURESENSOR' ].				(index = 10) ifTrue: [ portName _ 'PORT_A0' ].				(index = 11) ifTrue: [ portName _ 'PORT_A1' ].				(index = 12) ifTrue: [ portName _ 'PORT_A2' ].				(index = 13) ifTrue: [ portName _ 'PORT_A3' ].				(index = 14) ifTrue: [ portName _ 'PORT_A4' ].				(index = 15) ifTrue: [ portName _ 'PORT_A5' ].				(index = 16) ifTrue: [ portName _ 'PORT_A6' ].				(index = 17) ifTrue: [ portName _ 'PORT_A7' ].				aStream nextPutAll: '    board.InitSensorPort('.				aStream nextPutAll: portName.				aStream nextPutAll: ', '.				aStream nextPutAll: partsName.				aStream nextPutAll: ');'; cr."Transcript show: 'initSensorPin('; show:(index-10); show: ', '; show:partsName; show: ');'; cr."			].		].		index _ index + 1.	].	aStream nextPutAll: '    board.SetServomotorCalibration(SvCalibrationData);'; cr.	aStream nextPutAll: '    board.SetDCMotorCalibration(DCCalibrationData);'; cr.	aStream nextPutAll: '}'; cr.	NumberOfdoRepeat _ 0.	hats do: [:item |		item printArduCodeOn: aStream indent: 0.		(item isKindOf: ReporterBlockMorph) ifTrue: [aStream cr].		aStream cr].! !!ScriptableScratchMorph methodsFor: 'private' stamp: 'KK 8/4/2017 16:09'!spriteNameInUse: aString	| s |	(s _ self ownerThatIsA: ScratchStageMorph) ifNotNil: [		s submorphs do: [:m |			m == self ifFalse: [				((m isKindOf: ScriptableScratchMorph) and:				 [m objName caseInsensitiveEqual: aString]) ifTrue: [					^ true]]]].	^ false! !!ScriptableScratchMorph methodsFor: 'private' stamp: 'KK 7/28/2017 15:13'!updateMediaCategory	"Update the media category in the viewer, if it is showing."	| sFrame |	sFrame _ self ownerThatIsA: ScratchFrameMorph.	sFrame ifNotNil: [		sFrame projectModified.		sFrame updateMediaCategoryFor: self.		sFrame viewerPane refresh].! !!ScratchSpriteMorph methodsFor: 'accessing' stamp: 'KK 1/28/2013 11:37'!referencePosition	| p s |	p _ (bounds origin + offsetWhenRotated) - ScratchOrigin.	"adjust when in Hand in quartersize mode:"	((owner isKindOf: HandMorph) and:	 [((s _ owner formerOwner) isKindOf: ScratchStageMorph) and:	 [s isQuarterSize]]) ifTrue: [		"Note: this is not quite right when rotation center is offset"		p _ (p * 2) + (240@180)].	^ p x @ p y negated! !!ArduinoScratchSpriteMorph methodsFor: 'sensor commands' stamp: 'vct 9/6/2013 13:27'!allSensorNames	^#(		'Analog0'		'Analog1'		'Analog2'		'Analog3'		'Analog4'		'Analog5'		'Digital2'		'Digital3'	)! !!ArduinoScratchSpriteMorph methodsFor: 'sensor commands' stamp: 'vct 9/6/2013 13:27'!digitalSensorNames	^#(		 'Digital2'		 'Digital3'	)! !!ArduinoScratchSpriteMorph methodsFor: 'sensor commands' stamp: 'mcr 7/4/2011 11:32'!getSensor: sensorName	"Answer the value of the given sensor"	^ self arduinoBoard getSensor: sensorName! !!ArduinoScratchSpriteMorph methodsFor: 'sensor commands' stamp: 'mcr 7/7/2011 19:02'!isSensorPressed: sensorName	^self arduinoBoard getSensor: sensorName! !!ArduinoScratchSpriteMorph methodsFor: 'blocks' stamp: 'mcr 7/5/2011 19:04'!addBlocks: subcategory yPosition: y onPage: bin	| yPos x |	x := 12.	yPos := y.	(self blocksFor: subcategory) do: [:blockOrSym | 		(blockOrSym = #-) | (blockOrSym = #~)			ifTrue: [(blockOrSym = #-) 						ifTrue: [yPos _ yPos + 15].  "insert a full space"					(blockOrSym = #~) 						ifTrue: [yPos _ yPos + 5]]  "insert a half space"						ifFalse: [yPos _ self createBlock: blockOrSym atPosition: x@yPos onPage: bin]].	^yPos! !!ArduinoScratchSpriteMorph methodsFor: 'blocks' stamp: 'KK 7/7/2017 09:32'!addBlocksOn: bin	| line yPos |	yPos := self addBlocks: 'studuino' yPosition: 10 onPage: bin.	line := ImageMorph new form: (ScratchFrameMorph skinAt: #connector)."	bin addMorph: (line position: 12@yPos).	yPos := self addBlocks: 'motion' yPosition: yPos + 15 onPage: bin.	(self owner showMotorBlocks) ifTrue: [		bin addMorph: (line fullCopy position: 12@yPos).		self addBlocks: 'motor' yPosition: yPos + 15 onPage: bin]."	^bin! !!ArduinoScratchSpriteMorph methodsFor: 'blocks' stamp: 'KK 7/7/2017 09:54'!addBlocksOn: bin kind: k	| line yPos |	k = 'motion' ifTrue: [		yPos := self addBlocks: 'studuino' yPosition: 10 onPage: bin.		line := ImageMorph new form: (ScratchFrameMorph skinAt: #connector).	] ifFalse: [		yPos := self addBlocks: k yPosition: 10 onPage: bin.		line := ImageMorph new form: (ScratchFrameMorph skinAt: #connector).			]."	bin addMorph: (line position: 12@yPos).	yPos := self addBlocks: 'motion' yPosition: yPos + 15 onPage: bin.	(self owner showMotorBlocks) ifTrue: [		bin addMorph: (line fullCopy position: 12@yPos).		self addBlocks: 'motor' yPosition: yPos + 15 onPage: bin]."	^bin! !!ArduinoScratchSpriteMorph methodsFor: 'blocks' stamp: 'KK 10/6/2017 14:52'!viewerPageFor: aCategoryName	"Answer a morph containing mtion blocks for the given category for use in the given ScratchViewer."	| bin |	bin := ScratchBlockPaletteMorph new.	self addBlocksOn: bin kind: aCategoryName.	^ bin		! !!ArduinoScratchSpriteMorph methodsFor: 'blocks' stamp: 'mcr 8/3/2010 15:32'!viewerPageForMotion	"Answer a morph containing mtion blocks for the given category for use in the given ScratchViewer."	| bin |	bin := ScratchBlockPaletteMorph new.	self addBlocksOn: bin.	^ bin		! !!ArduinoScratchSpriteMorph methodsFor: 'blocks' stamp: 'KK 7/7/2017 09:28'!viewerPageFroLooks	"Answer a morph containing mtion blocks for the given category for use in the given ScratchViewer."	| bin |	bin := ScratchBlockPaletteMorph new."	self addBlocksOn: bin."	^ bin		! !!ArduinoScratchSpriteMorph methodsFor: 'servomotor commands' stamp: 'vct 10/31/2014 10:01'!servoPinNumbers	^ #('8' '7' '4' )! !!ArduinoScratchSpriteMorph methodsFor: 'servomotor commands' stamp: 'mcr 7/4/2011 11:41'!servomotor: pin angle: angle	self arduinoBoard servomotor: pin angle: angle! !!ArduinoScratchSpriteMorph methodsFor: 'servomotor commands' stamp: 'mcr 7/22/2010 15:28'!servomotor: pin direction: direction	self arduinoBoard servomotor: pin direction: direction! !!ArduinoScratchSpriteMorph methodsFor: 'servomotor commands' stamp: 'mcr 6/17/2010 11:36'!servomotorDirections	^ #(		  'clockwise'		  'anticlockwise'	)! !!ArduinoScratchSpriteMorph methodsFor: 'servomotor commands' stamp: 'mcr 7/13/2010 14:00'!servomotorOff: pin	self arduinoBoard servomotorOff: pin! !!ArduinoScratchSpriteMorph methodsFor: 'board commands' stamp: 'mcr 7/6/2011 12:49'!boardGotoX: x y: y	self arduinoBoard boardGotoX: x y: y! !!ArduinoScratchSpriteMorph methodsFor: 'board commands' stamp: 'mcr 8/3/2010 18:10'!deleteBoard"delete board's sprite before because this sprite can be the last one attached to his board"	| attachedSprites |	attachedSprites := self arduinoBoard arduinoSprites.	attachedSprites size = 1		ifTrue: [self arduinoBoard close.				self owner arduinoBoards remove: self arduinoBoard.				attachedSprites do: [:sprite | sprite arduinoBoard delete]]		ifFalse: [self arduinoBoard arduinoSprites remove: self]	! !!ArduinoScratchSpriteMorph methodsFor: 'board commands' stamp: 'mcr 7/6/2011 18:20'!hideBoard	self arduinoBoard hide.! !!ArduinoScratchSpriteMorph methodsFor: 'board commands' stamp: 'mcr 6/25/2010 16:09'!showBoard	self arduinoBoard show.! !!ArduinoScratchSpriteMorph methodsFor: 'other actuator ops' stamp: 'vct 10/28/2011 12:02'!analog: pin value: value 	self arduinoBoard analog: pin value: value! !!ArduinoScratchSpriteMorph methodsFor: 'other actuator ops' stamp: 'vct 9/6/2013 13:20'!analogPinNumbers	^#( '9' '6' '5')! !!ArduinoScratchSpriteMorph methodsFor: 'other actuator ops' stamp: 'mcr 7/13/2010 14:05'!digitalOff: pin	self arduinoBoard digitalOff: pin.! !!ArduinoScratchSpriteMorph methodsFor: 'other actuator ops' stamp: 'mcr 7/13/2010 14:18'!digitalOn: pin	self arduinoBoard digitalOn: pin! !!ArduinoScratchSpriteMorph methodsFor: 'other actuator ops' stamp: 'vct 9/6/2013 13:20'!digitalPinNumbers		^ #('13' '12' '11' '10')! !!ArduinoScratchSpriteMorph methodsFor: 'other actuator ops' stamp: 'KK 8/4/2017 15:02'!exportObject	| fileName dir |	fileName := self nameForExportDialog.	(fileName = #cancelled) ifTrue: [^self].	dir := ScratchFileChooserDialog getLastFolderForType: #sprite.	(dir fileExists: fileName) 		ifTrue: [(DialogBoxMorph ask: 'Overwrite existing ', fileName, '?') ifFalse: [^ self].				dir deleteFileNamed: fileName].	self exportObject: fileName directory: dir ! !!ArduinoScratchSpriteMorph methodsFor: 'other actuator ops' stamp: 'vct 3/22/2012 11:30'!resetActuators	self arduinoBoard resetActuators! !!ArduinoScratchSpriteMorph methodsFor: 'other actuator ops' stamp: 'vct 3/26/2012 12:04'!resumeConnection	self arduinoBoard resumeConnection! !!ArduinoScratchSpriteMorph methodsFor: 'other actuator ops' stamp: 'vct 3/26/2012 12:04'!stopConnection	self arduinoBoard stopConnection! !!ArduinoScratchSpriteMorph methodsFor: 'accesing' stamp: 'mcr 5/31/2010 16:35'!arduinoBoard	^arduinoBoard! !!ArduinoScratchSpriteMorph methodsFor: 'accesing' stamp: 'KK 7/5/2017 17:21'!arduinoBoard: anArduinoSensorBoard	arduinoBoard := anArduinoSensorBoard."	arduinoBoard attachToSprite: self."! !!ArduinoScratchSpriteMorph methodsFor: 'private' stamp: 'KK 10/12/2017 13:46'!nextInstanceName	"Answer a name for a new instance. For sprites, an attempt is made to create a unique name of the form 'spriteN'."	| stage lastN digits |	(stage _ self ownerThatIsA: ScratchStageMorph) ifNil: [^ 'Studuino' localized asUTF8, 1 printString].	lastN _ 0.	stage arduinoSprites ifNotNil: [		stage arduinoSprites do: [:m |				digits _ m objName trailingDigits.				((digits size > 0) and: [m objName beginsWith: ('Studuino' localized)])					ifTrue: [lastN _ lastN max: digits asNumber]]].	^ 'Studuino' localized asUTF8 ", (lastN + 1) printString"! !!ArduinoScratchSpriteMorph methodsFor: 'private' stamp: 'KK 8/4/2017 16:09'!spriteNameInUse: aString	| stage |	(stage _ self ownerThatIsA: ScratchStageMorph) ifNotNil: [		stage submorphs do: [:m |			m == self ifFalse: [				((m isKindOf: ScriptableScratchMorph) and: [m objName caseInsensitiveEqual: aString]) ifTrue: [					^ true].			nil]]].	^ false! !!ArduinoScratchSpriteMorph methodsFor: 'right button menu' stamp: 'mcr 7/6/2011 13:11'!connectionOptions	| stage spriteInUse |	stage := self owner.	(stage spritesInUse includes: self)		ifTrue: [^stage spritesInUse remove: self; yourself].		spriteInUse := self arduinoBoard arduinoSprites first. "the sprite that created the connection in use"	(stage spritesInUse includes: spriteInUse)		ifTrue: [^stage spritesInUse remove: spriteInUse; yourself].! !!ArduinoScratchSpriteMorph methodsFor: 'right button menu' stamp: 'KK 7/31/2017 10:08'!copyForExport	"Answer a copy of me for exporting."	"Note: Sprites are always exported in the context of an empty background."	| objToExport superObjToExport |"	objToExport _ 	ArduinoScratchStageMorph new clearMediaAndCostume position: self owner position."	objToExport _ 	ScratchStageMorph new clearMediaAndCostume position: self owner position.	superObjToExport _ self fullCopy.	superObjToExport objName: objName.	superObjToExport blocksBin allMorphsDo: [:m | (m isKindOf: BlockMorph) ifTrue: [m stop].												 (m isKindOf: SpriteArgMorph) ifTrue: [m clearMorphReference]].	superObjToExport convertStacksToTuples."	superObjToExport addMorph: self arduinoBoard fullCopy."	^objToExport addMorph: superObjToExport.! !!ArduinoScratchSpriteMorph methodsFor: 'right button menu' stamp: 'mcr 7/14/2010 10:20'!dirForExport: fileName	| dir |	dir := ScratchFileChooserDialog getLastFolderForType: #sprite.	(dir fileExists: fileName) 		ifTrue: [(DialogBoxMorph ask: 'Overwrite existing ', fileName, '?') ifFalse: [^ self].				dir deleteFileNamed: fileName].	^dir! !!ArduinoScratchSpriteMorph methodsFor: 'right button menu' stamp: 'mcr 8/7/2010 13:43'!duplicateNoAttach	"Duplicate this sprite, but do not attach to the hand."	| frame newSprite |	newSprite := self fullCopy.	frame := self ownerThatIsA: ScratchFrameMorph.	frame addArduinoSensorBoardMorphFor: newSprite.! !!ArduinoScratchSpriteMorph methodsFor: 'right button menu' stamp: 'KK 7/31/2017 11:10'!exportObject: fileName directory: dir 	| f objToExport |	f _ nil.	[	f _ (dir newFileNamed: fileName) binary.		objToExport _ self copyForExport.		objToExport objName: fileName.		ObjStream new storeObj: objToExport on: f showProgress: true.		f close.		dir setMacFileNamed: fileName type: 'STsb' creator: 'MITS'.	] ifError: [		f ifNotNil: [f close].		self inform: 'Could not write file' withDetails: 'Export failed' localized].! !!ArduinoScratchSpriteMorph methodsFor: 'right button menu' stamp: 'KK 7/31/2017 11:18'!nameForExportDialog	| fName |	fName _ ScratchFileChooserDialog		chooseNewFileDefault: objName		title: 'Export Sprite'		type: #sprite.	(fName = #cancelled or: [fName size = 0]) ifTrue: [^fName].	(fName endsWith: '.studuinosprite') ifFalse: [fName := fName, '.studuinosprite'].	fName _ FileDirectory localNameFor: fName.  "ignore path, if any; save in default directory"	^fName! !!ArduinoScratchSpriteMorph methodsFor: 'right button menu' stamp: 'mcr 8/6/2010 15:58'!showSpritesMenu		| menu choice |	menu := CustomMenu new.		self connectionOptions do: [:s | menu add: s objName action: s].	choice := menu startUp.	choice ifNotNil: [		self deleteBoard;			 arduinoBoard: choice arduinoBoard]! !!ArduinoScratchSpriteMorph methodsFor: 'right button menu' stamp: 'KK 7/24/2017 16:58'!undoableDeleteSprite	"Delete the board and the sprite and store it in the clipboard in case of an undo.""	self deleteBoard."	self owner undoableDeleteSprite: self.	super undoableDeleteSprite.! !!ArduinoScratchSpriteMorph methodsFor: 'testing' stamp: 'vct 3/12/2012 11:32'!isSpriteMorph	^true! !!ScratchStageMorph methodsFor: 'initialization' stamp: 'KK 1/30/2018 15:21'!initialize	|  |	super initialize.	color _ Color white.	self enableDragNDrop: true.	objName _ 'Stage' localized.	costume _ self defaultImageMedia.	media _ OrderedCollection with: costume with: SoundMedia new.	zoom _ 1.0.	hPan _ 0.	vPan _ 0.	runningBlocks _ OrderedCollection new.	inProcessStep _ false.	sensorBoard _ SensorBoardMorph new.	studuinoBoard _ StuduinoSensorBoardMorph new.	motorCalibBoard _ MotorCalibMorph2 new.	midiPortNum _ -1.	notePlayerDict _ Dictionary new.	obsoleteSavedState _ nil.	sprites _ OrderedCollection new.	showMotorBlocks _ false.	showStuduinoBlocks _ false.	servoCalibrationBoard _ SensorBoardMorph new.! !!ScratchStageMorph methodsFor: 'arduino' stamp: 'KK 7/28/2017 16:02'!addArduinoBoardFor: anArduinoSprite	| board |	board := SensorBoardMorph new."	self attachBoard: board withSprite: anArduinoSprite."		! !!ScratchStageMorph methodsFor: 'arduino' stamp: 'KK 7/25/2017 09:32'!addArduinoSprite: anArduinoSprite		self arduinoSprites add: anArduinoSprite.! !!ScratchStageMorph methodsFor: 'arduino' stamp: 'KK 7/25/2017 09:27'!arduinoBoards	^arduinoBoards ifNil: [arduinoBoards:= OrderedCollection new]! !!ScratchStageMorph methodsFor: 'arduino' stamp: 'KK 7/25/2017 09:24'!arduinoSprites	^ arduinoSprites ifNil: [arduinoSprites := OrderedCollection new]! !!ScratchStageMorph methodsFor: 'arduino' stamp: 'KK 7/28/2017 16:02'!attachBoard: anArduinoSensorBoard withSprite: anArduinoSprite	self addMorph: anArduinoSensorBoard.	World startStepping: anArduinoSensorBoard.	self arduinoBoards add: anArduinoSensorBoard.	anArduinoSprite arduinoBoard: anArduinoSensorBoard."	anArduinoSensorBoard 		stage: self;		position: self owner computeBoardPosition;		startScanForPort.	"! !!ScratchStageMorph methodsFor: 'arduino' stamp: 'KK 7/25/2017 09:23'!newArduinoSprite: anArduinoSprite		self arduinoSprites add: anArduinoSprite.! !!ScratchStageMorph methodsFor: 'arduino' stamp: 'KK 7/25/2017 09:18'!sensorBoards	^sensorBoards ifNil: [sensorBoards:= OrderedCollection new]! !!ScratchStageMorph methodsFor: 'arduino' stamp: 'KK 7/25/2017 09:19'!spritesInUse		^self sensorBoards collect: [:b | b arduinoSprites first].! !!ScratchStageMorph methodsFor: 'accessing' stamp: 'KK 1/30/2018 14:32'!motorCalibrationBoard	^ motorCalibBoard! !!ScratchStageMorph methodsFor: 'accessing' stamp: 'KK 2/6/2018 11:56'!motorCalibrationBoard: aCalibrationBoardMorph	motorCalibBoard _ aCalibrationBoardMorph.! !!ScratchStageMorph methodsFor: 'accessing' stamp: 'KK 7/5/2017 14:14'!objName	^ 'Stage' localized! !!ScratchStageMorph methodsFor: 'accessing' stamp: 'KK 10/4/2017 17:51'!sensorBoard	^ sensorBoard! !!ScratchStageMorph methodsFor: 'accessing' stamp: 'KK 10/23/2017 14:38'!showMotorBlocks: aBoolean"	showMotorBlocks _ aBoolean."	showMotorBlocks _ false.! !!ScratchStageMorph methodsFor: 'accessing' stamp: 'KK 10/4/2017 13:31'!showStuduinoBlocks	^ showStuduinoBlocks! !!ScratchStageMorph methodsFor: 'accessing' stamp: 'KK 10/4/2017 13:32'!showStuduinoBlocks: aBoolean	showStuduinoBlocks _ aBoolean.! !!ScratchStageMorph methodsFor: 'accessing' stamp: 'KK 10/4/2017 17:52'!studuinoBoard	^ studuinoBoard! !!ScratchStageMorph methodsFor: 'accessing' stamp: 'KK 10/4/2017 18:29'!studuinoBoard: aSensorBoardMorph	studuinoBoard _ aSensorBoardMorph.! !!ScratchStageMorph methodsFor: 'event handling' stamp: 'KK 9/19/2013 10:21'!containsPoint: aPoint	self isQuarterSize ifTrue: [^ (self position extent: self extent // 2)  containsPoint: aPoint].	^ self bounds containsPoint: aPoint! !!ScratchStageMorph methodsFor: 'event handling' stamp: 'KK 9/19/2013 10:20'!fullContainsPoint: aPoint	"Answer true if the given point is in my visible bounds. In quarterSize mode, my visible bounds is only half of my extent."	| r |	r _ self isQuarterSize		ifTrue: [self position extent: bounds extent // 2]		ifFalse: [bounds].	^ r containsPoint: aPoint! !!ScratchStageMorph methodsFor: 'drawing' stamp: 'KK 7/4/2017 20:20'!drawQuarterSizeOn: aCanvas	"Draw myself and my submorphs to an offscreen canvas, then scale down to quarter size and draw that on the given canvas."	| r srcR c |	cachedForm ifNil: [cachedForm _ Form extent: self extent depth: 32].	r _ aCanvas clipRect intersect: (bounds origin extent:  bounds extent // 2 ).	srcR _ ((r origin - bounds origin) * 2.0) truncated extent: (r extent * 2.0) rounded.	c _ (FormCanvas on: cachedForm)		copyOrigin: self position negated		clipRect: srcR.	super fullDrawOn: c.	ScratchPlugin halfSize: cachedForm into: Display srcPoint: srcR origin dstRect: r."xxx	cachedForm unhibernate.	LowResPlugin		primHalf2Average: cachedForm bits w: cachedForm width h: cachedForm height		into: Display bits w: Display width h: Display height		srcX: srcR left srcY: srcR top		dstX: r left dstY: r top dstW: r width dstH: r height.	(WarpBlt toForm: Display)		sourceForm: cachedForm;		combinationRule: Form over;		clipRect: aCanvas clipRect;		cellSize: 2;		copyQuad: srcR corners toRect: r.xxx"	"the following scales down entire stage:""	LowResPlugin scale: cachedForm into: aCanvas form at: aCanvas origin + self position."! !!ScratchStageMorph methodsFor: 'drawing' stamp: 'KK 7/28/2017 15:31'!invalidRect: damageRect	"Clip damage reports to my bounds, since drawing is clipped to my bounds."	| r |	(owner isKindOf: ScratchFrameMorph) ifTrue: [owner projectModified].	(self isQuarterSize and: [owner isKindOf: ScratchFrameMorph])		ifTrue: [			r _ (bounds origin + ((damageRect origin - bounds origin) / 2.0)) extent: (damageRect extent / 2.0).			r _ r intersect: (bounds origin extent: bounds extent // 2)]		ifFalse: [			r _ (damageRect topLeft truncated) corner: (damageRect right ceiling@damageRect bottom ceiling).			r _ r intersect: self bounds].	(r width > 0 and: [r height > 0]) ifTrue: [super invalidRect: r].! !!ScratchStageMorph methodsFor: 'drawing' stamp: 'KK 8/3/2017 17:20'!thumbnailForm	"Answer a thumbnail of me and my submorphs.""	^ self stageShotSized: (160@120)"	TabletMode ifTrue: [		^ self stageShotSized: (75@55). ]	ifFalse: [		^ self stageShotSized: (160@120). ].! !!ScratchStageMorph methodsFor: 'scratch processes/events' stamp: 'KK 10/4/2017 18:09'!stepStuduinoProcesses	"Run each Scratch process until it gives up control, then filter out any processes that have terminated."	"Details: Iterate over a copy of processes to allow processes to stop themselves. During development, the error catcher makes it difficult to track down errors, so it can be disabled."	| proc |"	studuinoBoard processIncomingData.	ScratchProcess blockHighlightMSecs = 0 ifTrue: [^ self stepProcessesTurbo].	inProcessStep ifTrue: [^ self].	inProcessStep _ true.	ScratchFrameMorph useErrorCatcher		ifTrue: [			[self processesToRun do: [:p | (proc _ p) runStepFor: self]]				ifError: [proc errorFlag: true]]		ifFalse: [			self processesToRun do: [:p | p runStepFor: self]].	self removeTerminatedProcesses.	inProcessStep _ false."! !!ScratchStageMorph methodsFor: 'menus' stamp: 'KK 7/5/2017 14:19'!rightButtonMenu	"Present the right button menu."	| menu |	menu _ CustomMenu new.	menu add: 'grab screen region for new sprite' action: #grabSpriteFromScreen.	menu addLine.	menu add: 'save picture of stage...' action: #stageShot.	menu localize; invokeOn: self.! !!ScriptableScratchMorph class methodsFor: 'block specs' stamp: 'KK 10/6/2017 16:27'!blockColorFor: aCategory	"Answer the block color for the given category."	'studuino control' = aCategory ifTrue: [^ (Color h: 41 s: 0.85 v: 0.9)].	'control' = aCategory ifTrue: [^ (Color h: 41 s: 0.85 v: 0.9)].	('motion' = aCategory or: ['studuino' = aCategory]) ifTrue: [^ (Color h: 225 s: 0.65 v: 0.83)].	'motor' = aCategory ifTrue: [^ (Color h: 220 s: 0.85 v: 0.725)].	'motion mini' = aCategory ifTrue: [^ (Color h: 220 s: 0.85 v: 0.725)].	'looks' = aCategory ifTrue: [^ (Color h: 264 s: 0.62 v: 0.89)].	'pen' = aCategory ifTrue: [^ (Color h: 165 s: 1 v: 0.63)].	'operators' = aCategory ifTrue: [^ (Color h: 93 s: 0.9 v: 0.76)].	'sound' = aCategory ifTrue: [^ (Color h: 296 s: 0.66 v: 0.85)].	'sensing' = aCategory ifTrue: [^ (Color h: 200 s: 0.98 v: 0.86)].	'sensing mini' = aCategory ifTrue: [^ (Color h: 200 s: 0.98 v: 0.86)].	'variables' = aCategory ifTrue: [^ (Color h: 25 s: 0.88 v: 0.95)].	'list' = aCategory ifTrue: [^ ListBlockColor].	'notSensing' = aCategory ifTrue: [^ (Color h: 0 s: 0 v: 0.5)].	'compatible' = aCategory ifTrue: [^ (Color h: 28 s: 0.61 v: 0.96)].	^ (Color h: 0 s: 0.81 v: 0.83)  "a shade of red"! !!ScriptableScratchMorph class methodsFor: 'block specs' stamp: 'KK 10/10/2017 12:43'!blockSpecs	"Answer a collection of block specifications for the blocks that are common to all objects. Block specificatons (Arrays) are interspersed with category names (Strings). A block specification is an Array of the form: (<block spec string> <block type> <selector> [optional initial argument values]).	Explanation of flags:		-	no flags		b	boolean reporter		c	c-shaped block containing a sequence of commands (always special form)		r	reporter		s	special form command with its own evaluation rule		t	timed command, like wait or glide		E	message event hat		K	key event hat		M	mouse-click event hat		S	start event hat		W	when <condition> hat (obsolete)"	| blocks |	blocks _ #(		'control'			('when %m clicked'				S	-)			('when %k key pressed'			K	-)			('when %m clicked'				M	-)			-			('wait %n secs'					t	wait:elapsed:from: 1)			-			('forever'						c	doForever)			('repeat %n'						c	doRepeat 10)			-			('broadcast %e'					-	broadcast:)			('broadcast %e and wait'			s	doBroadcastAndWait)			('when I receive %e'			E	-)			-			('forever if %b'					c	doForeverIf)			('if %b'							c	doIf)			('if %b'							c	doIfElse)			('wait until %b'					s	doWaitUntil)			('repeat until %b'				c	doUntil)			-			('stop script'					s	doReturn)			('stop all'						-	stopAll)		'operators'			('%n + %n'						r	+ - -)			('%n - %n'						r	- - -)			('%n * %n'						r	* - -)			('%n / %n'						r	/ - -)			-			('pick random %n to %n'		r	randomFrom:to: 1 10)			-			('%s < %s'						b	< '' '')			('%s = %s'						b	= '' '')			('%s > %s'						b	> '' '')			-			('%b and %b'					b	&)			('%b or %b'						b	|)			('not %b'						b	not)			-			('join %s %s'					r	concatenate:with: 'hello ' 'world')			('letter %n of %s'				r	letter:of: 1 'world')			('length of %s'					r	stringLength: 'world')			-			('%n mod %n'					r	\\ - -)			('round %n'						r	rounded -)			-			('%f of %n'						r	computeFunction:of: 'sqrt' 10)		'sound'			('play sound %S'				-	playSound:)			('play sound %S until done'		s	doPlaySoundAndWait)			('stop all sounds'				-	stopAllSounds)			-			('play drum %D for %n beats'	t 	drum:duration:elapsed:from: 48 0.2)			('rest for %n beats'				t 	rest:elapsed:from: 0.2)			-			('play note %N for %n beats'	t	noteOn:duration:elapsed:from: 60 0.5)			('set instrument to %I'			- 	midiInstrument: 1)			-			('change volume by %n'		- 	changeVolumeBy: -10)			('set volume to %n%'			- 	setVolumeTo: 100)			('volume'						r 	volume)			-			('change tempo by %n'			- 	changeTempoBy: 20)			('set tempo to %n bpm'			- 	setTempoTo: 60)			('tempo'							r 	tempo)		'studuino'			('Set servomotor %J to %F degrees'			-	motorNo:degree: 'PIN' 90)			('DC motor %j power %n'		-	motorNo:power: 'PIN' 100)			('DC motor %j on at %t'		-	motorNo:dcMotorOn: 'PIN' 'cw.')			('DC motor %j off %T'		-	motorNo:dcMotorOff:'PIN' 'Brake')			('Buzzer %B on frequency %N'	-	buzzerPin:freq: 'PIN' 60)			('Buzzer %B off'					-	buzzerPin: 'PIN')			('LED %p %o'					-	ledPin:onOff: 'PIN' 'on')		'studuino control'			('Servomotor synchro motion speed:%E'						c	doSvmSyncMotion2 10)		'motor'			('motor on for %n secs'			t	motorOnFor:elapsed:from: 1)			('motor on'						-	allMotorsOn)			('motor off'						-	allMotorsOff)			('motor power %n'				-	startMotorPower: 100)			('motor direction %W'			-	setMotorDirection: 'this way')		'variables'			('show variable %v'				-	showVariable:)			('hide variable %v'				-	hideVariable:)		'list'			('add %s to %L'					-	append:toList: 'thing')			-			('delete %y of %L'				-	deleteLine:ofList: 1)			('insert %s at %i of %L'			-	insert:at:ofList: 'thing' 1)			('replace item %i of %L with %s'		-	setLine:ofList:to: 1 'list' 'thing')			-			('item %i of %L'					r	getLine:ofList: 1)			('length of %L'					r	lineCountOfList:)			('%L contains %s'				b	list:contains: 'list' 'thing')			-			('write %L to %A as text file'	-	list:export: 'list' 'path')	).	^ blocks, self obsoleteBlockSpecs! !!ScriptableScratchMorph class methodsFor: 'block specs' stamp: 'KK 9/5/2013 16:33'!buildBlockSpecDictionary	"self buildBlockSpecDictionary"	| blockColor sel |	BlockSpecDict _ IdentityDictionary new: 250.	BlockColorDict _ IdentityDictionary new: 250."Transcript show:'[ScriptableScratchMorph::buildBlockSpecDictionary]';cr."	self withAllSubclassesDo: [:cl |		blockColor _ Color blue.		cl blockSpecs do: [:spec |			((spec isKindOf: String) and: [spec size > 1]) ifTrue: [				"set color  for this category"				blockColor _ self blockColorFor: spec].			(spec isMemberOf: Array) ifTrue: [				sel _ spec at: 3.				BlockSpecDict at: sel put: spec.				BlockColorDict at: sel put: blockColor]]].! !!ScriptableScratchMorph class methodsFor: 'translation support' stamp: 'KK 8/17/2017 17:46'!blockSpecsForTranslation	"Answer a collection blocks for translation. Obsolete blocks are removed."	| allSpecs |	allSpecs _ Set new.	(ScriptableScratchMorph blockSpecs,	 ScratchSpriteMorph blockSpecs,	 ArduinoScratchSpriteMorph blockSpecs,	 ScratchStageMorph blockSpecs) do: [:el |		(el isKindOf: Array)			ifTrue: [allSpecs add: el first]			ifFalse: [((el beginsWith: 'obsolete') or:[#('-' '~') includes: el])				ifFalse:[allSpecs add: el]]].	ScriptableScratchMorph obsoleteBlockSpecs do: [:el |		(el isKindOf: Array) ifTrue: [allSpecs remove: el first ifAbsent: []]].	allSpecs		add: 'else';		add: 'variables';		add: 'set %v to %n';		add: 'change %v by %n'.	^ allSpecs asArray sort! !!ScratchSpriteMorph class methodsFor: 'block specs' stamp: 'KK 8/31/2013 11:01'!blockSpecs	| blocks |	blocks _ #(		'motion'			('move %n steps'				-	forward:)			('turn %n degrees'				-	turnRight: 15)	"icon shows turn direction"			('turn %n degrees'				-	turnLeft: 15)	"icon shows turn direction"			-			('point in direction %d'			-	heading: 90)			('point towards %m'				-	pointTowards:)			-			('go to x:%n y:%n'				-	gotoX:y: 0 0)			('go to %m'						-	gotoSpriteOrMouse:)			('glide %n secs to x:%n y:%n'	t	glideSecs:toX:y:elapsed:from: 1 50 50)			-			('change x by %n'				-	changeXposBy: 10)			('set x to %n'					-	xpos: 0)			('change y by %n'				-	changeYposBy: 10)			('set y to %n'					-	ypos: 0)			-			('if on edge, bounce'			-	bounceOffEdge)			-			('x position'						r	xpos)			('y position'						r	ypos)			('direction'						r	heading)		'pen'			('clear'							-	clearPenTrails)			-			('pen down'						-	putPenDown)			('pen up'						-	putPenUp)			-			('set pen color to %c'			-	penColor:)			('change pen color by %n'		-	changePenHueBy:)			('set pen color to %n'			-	setPenHueTo: 0)			-			('change pen shade by %n'		-	changePenShadeBy:)			('set pen shade to %n'			-	setPenShadeTo: 50)			-			('change pen size by %n'		-	changePenSizeBy: 1)			('set pen size to %n'				-	penSize: 1)			-			('stamp'							-	stampCostume)	).	blocks _ blocks, #(		'looks'			('switch to costume %l'			-	lookLike:)			('next costume'					-	nextCostume)			('costume #'						r	costumeIndex)			-			('say %s for %n secs'			t	say:duration:elapsed:from: 'Hello!!' 2)			('say %s'						-	say: 'Hello!!')			('think %s for %n secs'			t	think:duration:elapsed:from: 'Hmm...' 2)			('think %s'						-	think: 'Hmm...')			-			('change %g effect by %n'		-	changeGraphicEffect:by: 'color' 25)			('set %g effect to %n'			-	setGraphicEffect:to: 'color' 0)			('clear graphic effects'			-	filterReset)			-			('change size by %n'			-	changeSizeBy:)			('set size to %n%'				-	setSizeTo: 100)			('size'							r	scale)			-			('show'							-	show)			('hide'							-	hide)			-			('go to front'					-	comeToFront)			('go back %n layers'			-	goBackByLayers: 1)		'sensing'			('touching %m?' 				b	touching:)			('touching color %C?' 			b	touchingColor:)			('color %C is touching %C?'		b	color:sees:)			-			('ask %s and wait'				s	doAsk 'What''s your name?')			('answer'						r	answer)			-			('mouse x'						r	mouseX)			('mouse y'						r	mouseY)			('mouse down?'					b	mousePressed)			-			('key %k pressed?'				b	keyPressed: 'space')			-			('distance to %m'				r	distanceTo:)			-			('reset timer'					-	timerReset)			('timer'							r	timer)			-			('%a of %m'						r	getAttribute:of:)			-			('loudness'						r	soundLevel)			('loud?'							b	isLoud)			~			('%H sensor value'				r	sensor: 'slider')			('sensor %h?'					b	sensorPressed: 'button pressed')"			('Light Sensor %Z value'		r	lightSensor: 'A0')			('Touch Sensor %V value'	r	touchSensor: 'A0')			('Sound Sensor %Z value'	r	sensor: 'A0')			('Reflective Photosensor %Z value'	r	sensor: 'A0')			('3-Axis Digital Accelerometer %Y value'	r	sensor: 'X')			('Button %X value'	r	sensor: 'A0')"		).	^ blocks, super blockSpecs! !!ArduinoScratchSpriteMorph class methodsFor: 'block specs' stamp: 'KK 10/6/2017 16:26'!blockColorFor: aCategory	"Answer the block color for the given category."	'control' = aCategory ifTrue: [^ (Color h: 41 s: 0.85 v: 0.9)].	('motion' = aCategory or: ['studuino' = aCategory]) ifTrue: [^ (Color h: 225 s: 0.65 v: 0.83)].	'motor' = aCategory ifTrue: [^ (Color h: 220 s: 0.85 v: 0.725)].	'looks' = aCategory ifTrue: [^ (Color h: 264 s: 0.62 v: 0.89)].	'pen' = aCategory ifTrue: [^ (Color h: 165 s: 1 v: 0.63)].	'operators' = aCategory ifTrue: [^ (Color h: 93 s: 0.9 v: 0.76)].	'sound' = aCategory ifTrue: [^ (Color h: 296 s: 0.66 v: 0.85)].	'sensing' = aCategory ifTrue: [^ (Color h: 200 s: 0.98 v: 0.86)].	'variables' = aCategory ifTrue: [^ (Color h: 25 s: 0.88 v: 0.95)].	'list' = aCategory ifTrue: [^ ListBlockColor].	^ (Color h: 0 s: 0.81 v: 0.83)  "a shade of red"! !!ArduinoScratchSpriteMorph class methodsFor: 'block specs' stamp: 'vct 10/31/2014 11:10'!blockSelectors 	^#(	getSensor:		isSensorPressed:		digitalOn:		digitalOff:		analog:value:		servomotorOff: 		servomotor:direction:		servomotor:angle:		resetActuators		stopConnection		resumeConnection		showBoard		hideBoard		boardGotoX:y:).	! !!ArduinoScratchSpriteMorph class methodsFor: 'block specs' stamp: 'KK 12/23/2017 15:31'!blockSpecs"self buildBlockSpecDictionary"	| blocks |	blocks _ #(		'motion'		'studuino'			('Set servomotor %J to %F degrees'			-	motorNo:degree: 'PIN' 90)			('DC motor %j power %n'		-	motorNo:power: 'PIN' 100)			('DC motor %j on at %t'		-	motorNo:dcMotorOn: 'PIN' 'cw.')			('DC motor %j off %T'		-	motorNo:dcMotorOff:'PIN' 'Brake')			('Buzzer %B on frequency %N'	-	buzzerPin:freq: 'PIN' 60)			('Buzzer %B off'					-	buzzerPin: 'PIN')			('LED %p %o'					-	ledPin:onOff: 'PIN' 'on')		'motion mini'			('Onboard LED %p1 %o'			-	boardLED:onOff: 'Red(D5)' 'on')			('Set time %nh %nm'			-	hour:min: 0 0)			('Set date %n/%n/%n'			-	month:day:year: 1 1 2016)			('Set alarm %nh %nm'			-	alhour:almin: 0 0)			('Set backlight R%n G%n B%n'	-	red:green:blue: 0 0 0)			('Backlight %o'					-	clkBackLight: 'on')			('Clock''s buzzer on frequency %N for %n'	t	clkBuzzerOnFreq:For:elapsed:from: 60 1)		'control'			('when %m clicked'				S	-)			('when %k key pressed'			K	-)			-			('wait %n secs'					t	wait:elapsed:from: 1)			-			('forever'						c	doForever)			('repeat %n'						c	doRepeat 10)			-			('broadcast %e'					-	broadcast:)			('broadcast %e and wait'			s	doBroadcastAndWait)			('when I receive %e'			E	-)			-			('forever if %b'					c	doForeverIf)			('if %b'							c	doIf)			('if %b'							c	doIfElse)			('wait until %b'					s	doWaitUntil)			('repeat until %b'				c	doUntil)			('Servomotor synchro motion speed:%E'						c	doSvmSyncMotion2 10)			-			('stop script'					s	doReturn)			('stop all'						-	stopAll)		'compatible'			('Servomotor synchro motion delay:%E'						c	doSvmSyncMotion 10)		'studuino control'			('Servomotor synchro motion speed:%E'						c	doSvmSyncMotion2 10)		'looks'		'sensing'			('Light Sensor %P value'		r	lightSensor: 'PIN')			('Touch Sensor %V value'	r	touchSensor: 'PIN')			('Sound Sensor %O value'	r	soundSensor: 'PIN')			('IR Photoreflector %Z value'	r	refPhotosensor: 'PIN')						('Temperature sensor %w value'	r	temperatureSensor: 'PIN')			('3-Axis Digital Accelerometer %Y value'	r	accelerometer: 'AXIS')			('Gyro sensor %G value'	r	gyroSensor: 'X(Acc)')			('Button %X value'	r		onBoardButton: 'PIN')			~			('mouse x'					r	mouseX)			('mouse y'					r	mouseY)			('mouse down?'				b	mousePressed)			-			('key %k pressed?'			b	keyPressed: 'space')			-			('reset timer'				-	timerReset)			('timer'						r	timer)		'sensing mini'			('Clock''s %Z1'	r	clockValue: 'Hour')			('becoming in alarm time'		b	isInAlarm)			('Onboard Light Sensor value'	r		onBoardLightSensor)			('Power value'	r		power)		'sound'		'operators'			('%n + %n'						r	+ - -)			('%n - %n'						r	- - -)			('%n * %n'						r	* - -)			('%n / %n'						r	/ - -)			-			('pick random %n to %n'		r	randomFrom:to: 1 10)			-			('%s < %s'						b	< '' '')			('%s = %s'						b	= '' '')			('%s > %s'						b	> '' '')			-			('%b and %b'					b	&)			('%b or %b'						b	|)			('not %b'						b	not)			-			('join %s %s'					r	concatenate:with: 'hello ' 'world')			('letter %n of %s'				r	letter:of: 1 'world')			('length of %s'					r	stringLength: 'world')			-			('%n mod %n'					r	\\ - -)			('round %n'						r	rounded -)			-			('%f of %n'						r	computeFunction:of: 'sqrt' 10)		'pen'		'variables'			('show variable %v'				-	showVariable:)			('hide variable %v'				-	hideVariable:)		'list'			('add %s to %L'					-	append:toList: 'thing')			-			('delete %y of %L'				-	deleteLine:ofList: 1)			('insert %s at %i of %L'			-	insert:at:ofList: 'thing' 1)			('replace item %i of %L with %s'		-	setLine:ofList:to: 1 'list' 'thing')			-			('item %i of %L'					r	getLine:ofList: 1)			('length of %L'					r	lineCountOfList:)			('%L contains %s'				b	list:contains: 'list' 'thing')			-			('write %L to %A as text file'	-	list:export: 'list' 'path')	).	 ^ blocks! !!ArduinoScratchSpriteMorph class methodsFor: 'instance creation' stamp: 'mcr 9/12/2010 14:37'!costume: aCostume 	^self new 		soleCostume: aCostume.! !!ScratchStageMorph class methodsFor: 'block specs' stamp: 'KK 7/6/2017 10:01'!blockSpecs	| blocks |	blocks _ #(		'sensing'			('ask %s and wait'			s	doAsk 'What''s your name?')			('answer'					r	answer)			-			('mouse x'					r	mouseX)			('mouse y'					r	mouseY)			('mouse down?'				b	mousePressed)			-			('key %k pressed?'			b	keyPressed: 'space')			-			('reset timer'				-	timerReset)			('timer'						r	timer)			-			('%a of %m'					r	getAttribute:of:)			-			('loudness'					r	soundLevel)			('loud?'						b	isLoud)			~			('%H sensor value'			r	sensor: 'slider')			('sensor %h?'				b	sensorPressed: 'button pressed')		'looks'			('switch to background %l'	-	showBackground: 'background1')			('next background'			-	nextBackground)			('background #'				r	backgroundIndex)			-			('change %g effect by %n'	-	changeGraphicEffect:by: 'color' 25)			('set %g effect to %n'		-	setGraphicEffect:to: 'color' 0)			('clear graphic effects'		-	filterReset)			-"xxx			('place sprites for scene %x'	-	showScene:) "		'pen'			('clear'						-	clearPenTrails)	).	^ blocks, super blockSpecs! !!SensorBoardMorph methodsFor: 'initialization' stamp: 'ee 11/10/2007 19:31'!addReadoutLabeled: aString	"Add a readout row with the given label. Answer the stringmorph that's the readout."	| row box readout |	row _ AlignmentMorph newRow color: column color; inset: 2.	row addMorphBack: (Morph new color: column color; extent: 1@3). "spacer"	row addMorphBack: (StringMorph contents: aString capitalized font: (StrikeFont fontName: 'VerdanaBold' size: 10)).	row addMorphBack: (AlignmentMorph new color: column color; extent: 10@1; hResizing: #spaceFill).  "spacer"	box _ WatcherReadoutFrameMorph new		extent: 42@14;		color: (ScriptableScratchMorph blockColorFor: 'sensing').	readout _ StringMorph contents: '0' font: (StrikeFont fontName: 'VerdanaBold' size: 10).	readout color: Color white.	box addMorph: readout.	row addMorphBack: box.	column addMorphBack: row.	^ readout! !!SensorBoardMorph methodsFor: 'initialization' stamp: 'ee 11/10/2007 19:28'!addReadouts	| readoutNames |	readoutNames _ #(		slider		light		sound		button		A		B		C		D	).	column _ AlignmentMorph newColumn		centering: #center;		hResizing: #spaceFill;		vResizing: #shrinkWrap;		color: (Color r: (193/255) g: (196/255) b: (199/255));		borderWidth: 2;		borderColor: (Color r: (148/255) g: (145/255) b: (145/255));		useRoundedCorners;		inset: 3.	titleMorph _ StringMorph		contents: ''		font: (StrikeFont fontName: 'VerdanaBold' size: 10).	column addMorph: titleMorph.	self updateTitle.	column addMorphBack: (Morph new color: column color; extent: 5@3).  "spacer"	self removeAllMorphs.	readouts _ readoutNames collect: [:i |		(i size = 1)			ifTrue:[self addReadoutLabeled: i]			ifFalse:[self addReadoutLabeled: i localized]].	column position: self position - 2.	self addMorph: column.	self extent: column extent - 4.! !!SensorBoardMorph methodsFor: 'initialization' stamp: 'jm 4/27/2007 17:59'!initialize	super initialize.	sensorValues _ Array new: 16 withAll: 0.	currentState _ #idle.	highByte _ 0.	useGoGoProtocol ifNil: [useGoGoProtocol _ false].	scratchBoardV3 _ false.	reportRaw _ false.	scanState _ #off.	self addReadouts.! !!SensorBoardMorph methodsFor: 'accessing' stamp: 'jm 6/22/2003 23:39'!isScriptable	"I am not scriptable."	^ false! !!SensorBoardMorph methodsFor: 'sensor ops' stamp: 'jm 4/27/2007 18:01'!privateSensor: sensorIndex	"Read the virtual sensor with the given index permuted according to which Scratch board is plugged in and scaled if it is a known special sensor such as the light or sound sensor. If reportRaw is true then the raw sensor value (0..1023) is reported."	"This method does not call processIncomingData. It should only be used by the step method."	| i raw |	"map the sensor index to the corresponding channel"	i _ (sensorIndex asInteger max: 1) min: 8.	useGoGoProtocol ifFalse: [		scratchBoardV3			ifTrue: [i _ #(8 6 7 4 5 3 2 1) at: i] 			ifFalse: [i _ #(5 6 7 8 1 2 3 4) at: i]].	raw _ sensorValues at: i.	reportRaw ifTrue: [^ raw].	scratchBoardV3 ifTrue: [		i = 6 ifTrue: [^ self scaleLight: raw].		i = 7 ifTrue: [^ self scaleSound: raw]].	raw > 1020 ifTrue: [raw _ 1023].  "avoids jitter in the range 1021-1023"	^ (100.0 * raw) / 1023.0  ! !!SensorBoardMorph methodsFor: 'sensor ops' stamp: 'jm 4/27/2007 17:59'!sensor: sensorIndex	"Answer the value of the virtual sensor with the given index. Sensors are numbered 1-8."	^ self privateSensor: sensorIndex! !!SensorBoardMorph methodsFor: 'sensor ops' stamp: 'jm 4/27/2007 18:01'!startReadingData	"Ensure that the serial port is open, turn off all motors and put them into a known state, and begin streaming sensor data."	self portIsOpen ifFalse: [^ self].  "could not open the serial port"	currentState _ #idle.	sensorValues atAllPut: 0.	scratchBoardV3 _ false.	self startStreamingSensors: 0.  "in case board was left in streaming mode"	port flushInputBuffer.	useGoGoProtocol ifTrue: [		1 to: 6 do: [:motor |			self turnOffMotor: motor.			self thisWayMotor: motor.			self setPower: 3 motor: motor.			self turnOffMotor: motor].		self startStreamingSensors: 16rFF].  "all 8 sensors"! !!SensorBoardMorph methodsFor: 'sensor ops' stamp: 'jm 4/19/2007 13:10'!stopReadingData	"Turn off all motors, stop streaming data, and close the port."	(port notNil and: [port isOpen]) ifTrue: [		useGoGoProtocol ifTrue: [			1 to: 6 do: [:motor | self turnOffMotor: motor].			self startStreamingSensors: 0]].  "turn off streaming"	self closePort.! !!SensorBoardMorph methodsFor: 'motor ops' stamp: 'jm 3/5/2003 21:52'!coastToStopMotor: motorNum	"Let the given motor coast to a stop."	self portIsOpen ifFalse: [^ self].	self selectMotor: motorNum.	port nextPutAll: #(84 254 84) asByteArray.! !!SensorBoardMorph methodsFor: 'motor ops' stamp: 'jm 3/5/2003 21:50'!reverseMotor: motorNum	"Reverse the direction of the given motor."	self portIsOpen ifFalse: [^ self].	self selectMotor: motorNum.	port nextPutAll: #(84 254 72) asByteArray.! !!SensorBoardMorph methodsFor: 'motor ops' stamp: 'jm 3/9/2003 10:31'!selectMotor: anInteger	"Select the motor to which subsequent motor commands will be addressed. Motors are numbered 1-6."	| motorNum msg |	motorNum _ (anInteger truncated - 1 max: 0) min: 7. "motor bit index"	msg _ #(84 254 128 0) asByteArray.	msg at: 4 put: (1 bitShift: motorNum).	port nextPutAll: msg.! !!SensorBoardMorph methodsFor: 'motor ops' stamp: 'jm 3/9/2003 10:05'!setPower: aNumber motor: motorNum	"Set the power of the given motor to 0 to 7."	| power msg |	self portIsOpen ifFalse: [^ self].	self selectMotor: motorNum.	power _ (aNumber truncated max: 0) min: 7.	msg _ #(84 254 0) asByteArray.	msg at: 3 put: 96 + (power bitShift: 2).	port nextPutAll: msg.! !!SensorBoardMorph methodsFor: 'motor ops' stamp: 'jm 3/5/2003 21:46'!thatWayMotor: motorNum	"Set motor direction to that way."	self portIsOpen ifFalse: [^ self].	self selectMotor: motorNum.	port nextPutAll: #(84 254 80) asByteArray.! !!SensorBoardMorph methodsFor: 'motor ops' stamp: 'jm 3/5/2003 21:49'!thisWayMotor: motorNum	"Set motor direction to this way."	self portIsOpen ifFalse: [^ self].	self selectMotor: motorNum.	port nextPutAll: #(84 254 76) asByteArray.! !!SensorBoardMorph methodsFor: 'motor ops' stamp: 'jm 3/9/2003 10:31'!turnOffMotor: motorNum	self portIsOpen ifFalse: [^ self].	self selectMotor: motorNum.	port nextPutAll: #(84 254 68) asByteArray.! !!SensorBoardMorph methodsFor: 'motor ops' stamp: 'jm 3/9/2003 10:31'!turnOnMotor: motorNum	self portIsOpen ifFalse: [^ self].	self selectMotor: motorNum.	port nextPutAll: #(84 254 64) asByteArray.! !!SensorBoardMorph methodsFor: 'stepping' stamp: 'jm 4/27/2007 18:08'!step	"Update my title and sensor readouts. If scanning for ports, keep scanning."	| frame |	#checkData = scanState ifTrue: [self scanForPort].	self portIsOpen		ifTrue: [self processIncomingData]		ifFalse: [port _ nil].	self updateTitle.	1 to: 8 do: [:i |		(readouts at: i) contents: (self privateSensor: i) truncated printString.		(scratchBoardV3 and: [i = 4])			ifTrue: [(readouts at: i) contents: ((self privateSensor: i) < 10) printString]. "button"		frame _ (readouts at: i) owner.		(frame respondsTo: #fixLayout) ifTrue: [frame fixLayout]].! !!SensorBoardMorph methodsFor: 'stepping' stamp: 'jm 4/5/2007 20:59'!stepTime	^ 50! !!SensorBoardMorph methodsFor: 'serial port' stamp: 'jm 4/27/2007 18:00'!closePort	port ifNotNil: [		port flushInputBuffer.		port close].	port _ nil.	currentState _ #idle.	sensorValues atAllPut: 0.	scratchBoardV3 _ false.	1 to: 8 do: [:i | (readouts at: i) contents: '0'].	scanState _ #off.	self step.! !!SensorBoardMorph methodsFor: 'serial port' stamp: 'jm 4/19/2007 16:03'!openPort: aString	"Close the serial port if it is open, then open the port with the given name and initialize streaming of sensor data. Answer true if the operation was successful."	| baudRate portNum numStart |	baudRate _ useGoGoProtocol ifTrue: [9600] ifFalse: [38400].	self closePort.	portName _ aString.	ScratchPlugin serialPortOpsAvailable		ifTrue: [			port _ SerialPort2 new openPortNamed: portName baud: baudRate.			port isOpen ifFalse: [port _ nil. ^ false].			port setOption: 20 to: 1.  "set DTR high"			port setOption: 21 to: 0]  "set RTS low"		ifFalse: [			portNum _ 1.			numStart _ (1 to: portName size) detect: [:i | (portName at: i) isDigit] ifNone: [0].			numStart > 0 ifTrue: [portNum _ (portName copyFrom: numStart to: portName size) asNumber].			port _ SerialPort new				baudRate: baudRate;				inputFlowControlType: 2;				openPort: portNum ifFail: [^ false]].	"initialize polling state"	lastPollMSecs _ Time millisecondClockValue.	^ true! !!SensorBoardMorph methodsFor: 'serial port' stamp: 'jm 3/5/2003 21:35'!portIsOpen	^ port notNil and: [port isOpen]! !!SensorBoardMorph methodsFor: 'serial port' stamp: 'jm 4/9/2007 14:05'!portNames	"Answer a collection of possible port names for the Scratch sensor board. Filter out modems and PDA cradles."	ScratchPlugin serialPortOpsAvailable ifFalse: [		^ (1 to: 32) collect: [:i | 'COM', i printString]].	^ SerialPort2 portNames reject: [:n |		(n asLowercase includesSubString: 'modem') or:		[n asLowercase includesSubString: 'pda-sync']].! !!SensorBoardMorph methodsFor: 'serial port' stamp: 'jm 4/19/2007 13:12'!resetPort	"If the port is closed, do nothing. If it is open, close and reopen it. This can be used to reset the Prolific USB serial driver if it misbehaves."	self portIsOpen ifFalse: [^ self].	portName ifNil: [^ self].	self closePort.	self openPort: portName.	scanState _ #on.	self step.! !!SensorBoardMorph methodsFor: 'serial port' stamp: 'jm 4/17/2007 10:05'!scanForPort	"Try to find the serial port that the sensor board is attached to. This is incremental--each time it is called it does the next task."	"Details: scanState is one of: #(off, start, checkData, on). scanPorts is a list of port names to try. Attempt to open each port in turn, then wait for a while and see if Scratch Sensor data of the right form has arrived."	| msecs buf i |	#off = scanState ifTrue: [self scanNextPort].	#on = scanState ifTrue: [  "if port is open, close it and start a new scan"		scanPorts _ nil.		self scanNextPort].	#start = scanState ifTrue: [		(scanPorts isNil or: [scanPorts size = 0]) ifTrue: [			scanPorts _ self portNames asOrderedCollection].		scanPorts size = 0 ifTrue: [^ self scanNextPort].		self openPort: scanPorts removeFirst.		self portIsOpen ifFalse: [^ self].		scanState _ #checkData.		scanStartMSecs _ Time millisecondClockValue.		^ self].	#checkData = scanState ifTrue: [		msecs _ Time millisecondClockValue - scanStartMSecs.		(self portIsOpen not or: [msecs > 4000]) ifTrue: [^ self scanNextPort].		port nextPut: 1.  "send poll byte"		((buf _ port readByteArray) size < 10) ifTrue: [^ self].  "no data yet"		"check that the data is in Scratch Sensor Board format"		i _ (buf first bitAnd: 128) > 0 ifTrue: [1] ifFalse: [2].		[i < (buf size - 1)] whileTrue: [			(((buf at: i) bitAnd: 128) > 0 and:			 [((buf at: i + 1) bitAnd: 128) = 0]) ifFalse: [^ self scanNextPort].			i _ i + 2].		scanState _ #on].! !!SensorBoardMorph methodsFor: 'serial port' stamp: 'jm 4/10/2007 17:56'!scanNextPort	"Called during port scanning. The current port does not seem to be a ScratchBoard. Close it and try the next port in the list."	self closePort.	scanState _ #start.! !!SensorBoardMorph methodsFor: 'serial port' stamp: 'jm 4/19/2007 13:10'!selectPort	| menu choice |	self stopReadingData.	self portNames size = 0 ifTrue: [^ DialogBoxMorph inform: 'No serial ports found'].	menu _ CustomMenu new.	self portNames do: [:n | menu add: n action: n].	choice _ menu startUp.	choice ifNil: [^ self].	self openPort: choice.	self startReadingData.	scanState _ #on.! !!SensorBoardMorph methodsFor: 'serial port' stamp: 'KK 10/12/2017 19:34'!tryToOpenPort	"Attempt to open the port. If successful, or if the port was open already, answer true. Otherwise, answer false."	(port notNil and: [port isOpen and: [scanState = #on]]) ifTrue: [^ true].  "already open"	self scanForPort.	^ port notNil and: [port isOpen]! !!SensorBoardMorph methodsFor: 'serial port' stamp: 'jm 11/22/2006 17:13'!useGoGoProtocol	self stopReadingData.	useGoGoProtocol _ true.	scratchBoardV3 _ false.	self startReadingData.! !!SensorBoardMorph methodsFor: 'serial port' stamp: 'jm 8/21/2006 15:04'!useScratchboardProtocol	self stopReadingData.	useGoGoProtocol _ false.	self startReadingData.! !!SensorBoardMorph methodsFor: 'event handling' stamp: 'jm 6/2/2004 12:15'!handlesMouseDown: evt	^ true! !!SensorBoardMorph methodsFor: 'event handling' stamp: 'jm 12/30/2008 18:38'!mouseDown: evt	evt rightButtonPressed | evt shiftPressed		ifTrue: [Sensor waitNoButton. ^ self rightButtonMenu].	evt hand toolType = 'CutTool' ifTrue: [		evt shiftPressed ifFalse: [evt hand toolType: nil].		ScratchFrameMorph putInClipboard: self.		^ self delete].	evt hand waitForClicksOrDrag: self event: evt.! !!SensorBoardMorph methodsFor: 'event handling' stamp: 'jm 12/19/2008 17:36'!mouseHold: evt	self rightButtonMenu.! !!SensorBoardMorph methodsFor: 'event handling' stamp: 'jm 11/13/2006 16:44'!preemptsMouseDown: evt	^ true! !!SensorBoardMorph methodsFor: 'event handling' stamp: 'jm 10/25/2007 19:27'!rightButtonMenu	| menu |	menu _ CustomMenu new.	Sensor shiftPressed		ifTrue: [			reportRaw				ifTrue: [menu add: 'stop reporting raw data' action: #toggleRawMode]				ifFalse: [menu add: 'report raw data' action: #toggleRawMode].			useGoGoProtocol				ifTrue: [menu add: 'use Scratch board' action: #useScratchboardProtocol]				ifFalse: [menu add: 'use GoGo board' action: #useGoGoProtocol]]		ifFalse: [			menu add: 'select serial/USB port' action: #selectPort.			self portIsOpen				ifTrue: [menu add: 'close port' action: #stopReadingData].			menu addLine.			menu add: 'hide' action: #delete].	menu localize; invokeOn: self.! !!SensorBoardMorph methodsFor: 'event handling' stamp: 'jm 11/21/2006 10:55'!toggleRawMode	reportRaw _ reportRaw not.! !!SensorBoardMorph methodsFor: 'dropping/grabbing' stamp: 'jm 4/12/2007 10:40'!justDroppedInto: newOwner event: evt	"Only allow embedding into the stage; otherwise, float (i.e. be a submorph of the world)."	(newOwner isKindOf: ScratchStageMorph) ifFalse: [ "only embed in the work pane"		self world addMorph: self].! !!SensorBoardMorph methodsFor: 'object i/o' stamp: 'jm 9/24/2003 17:07'!fieldsVersion	^ 1! !!SensorBoardMorph methodsFor: 'object i/o' stamp: 'jm 4/9/2007 09:47'!initFieldsFrom: anObjStream version: classVersion	super initFieldsFrom: anObjStream version: classVersion.	anObjStream nextField.  "skip old portNum field"	self addReadouts.! !!SensorBoardMorph methodsFor: 'object i/o' stamp: 'jm 4/9/2007 09:18'!storeFieldsOn: anObjStream	super storeFieldsOn: anObjStream.	anObjStream putField: 1.  "old portNum instance variable"! !!SensorBoardMorph methodsFor: 'private' stamp: 'jm 3/5/2003 19:54'!ping	"Answer true if a GoGoBoard is connected to my serial port."	| buf |	port flushInputBuffer.	port nextPutAll: #(84 254 0) asByteArray.	buf _ port next: 3.	^ buf = #(85 255 170) asByteArray! !!SensorBoardMorph methodsFor: 'private' stamp: 'jm 11/20/2006 11:30'!processGoGoByte: aByte	"Process one byte of the incoming data stream from a GoGoBoard."	"Details: This code recognizes three-byte sensor update messages starting with 16r0C using a simple, three-state finite state machine. We assume that sensor updates are always contiguous--that is, replies to motor or other GoGo board commands will not be inserted between the bytes of any given three-byte sensor update message. The sensor number is the top three bits of the byte two. The data value is the bottom two bits of byte two plus all eight bits of byte three."	| sensorNum val |	currentState = #idle ifTrue: [ 		aByte = 16r0C ifTrue: [currentState _ #startByteSeen].		^ self].	currentState = #startByteSeen ifTrue: [		highByte _ aByte.		currentState _ #highByteSeen.		^ self].	currentState = #highByteSeen ifTrue: [		"final byte of message: report the sensor value"		sensorNum _ (highByte bitShift: -5) + 1.		val _ ((highByte bitAnd: 3) bitShift: 8) + aByte.		(sensorNum between: 1 and: 8) ifTrue: [			sensorValues at: sensorNum put: val].		currentState _ #idle].! !!SensorBoardMorph methodsFor: 'private' stamp: 'jm 5/8/2007 11:00'!processIncomingData	"Process incoming bytes from the serial port."	"Details: To work around a problem with the Prolific USB-Serial drivers on some Windows machines, a strict turn-taking polling protocol is used. A poll byte is sent, the ScratchBoard sends a response, and after a small delay (to be sure that all the data from the last poll has arrived, another poll is sent. The goal is to never allow more that few bytes to accumulate in the serial input buffer and to avoid sending a poll byte while data is arriving. However, since different versions of the ScratchBoard may send different amounts of data, we don't want to hard-code the number of reply bytes. Thus"	| buf msecsSinceLastPoll |	(self portIsOpen and: [#on = scanState]) ifFalse: [^ self].	useGoGoProtocol ifTrue: [		buf _ port readByteArray.		buf do: [:b | self processGoGoByte: b].		^ self].	msecsSinceLastPoll _ Time millisecondClockValue - lastPollMSecs.	msecsSinceLastPoll < 20 ifTrue: [^ self].	buf _ port readByteArray.	buf do: [:b | self processScratchByte: b].	port nextPut: 1.	"send a ScratchBoard V4 poll byte"	lastPollMSecs _ Time millisecondClockValue.! !!SensorBoardMorph methodsFor: 'private' stamp: 'jm 4/27/2007 18:00'!processScratchByte: aByte	"Process one byte of the incoming data stream from a Scratch sensor board."	"Sensor messages are two bytes with the following format:		Byte1: <1><sensor number (4 bits)><sensor value high bits (3 bits)>		Byte2: <0><sensor value low bits (7 bits)>"	| sensorNum val |	currentState = #idle ifTrue: [  "wait for first byte of message"		(aByte bitAnd: 16r80) > 0 ifTrue: [			currentState _ #firstByteSeen.			highByte _ aByte].		^ self].	currentState = #firstByteSeen ifTrue: [		(aByte bitAnd: 16r80) > 0 ifTrue: [  "must have lost second byte; stay in firstByteSeen state"			highByte _ aByte.			^ self].		"good second byte: report the sensor value"		sensorNum _ ((highByte bitShift: -3) bitAnd: 16rF) + 1.		val _ ((highByte bitAnd: 7) bitShift: 7) + (aByte bitAnd: 16r7F).		sensorNum <= sensorValues size ifTrue: [			sensorValues at: sensorNum put: val.			sensorNum = 16 ifTrue: [				(val == 3) | (val == 4) ifTrue: [					scratchBoardV3 _ true]]].  "ScratchBoard, version 3 or 4"		currentState _ #idle].! !!SensorBoardMorph methodsFor: 'private' stamp: 'jm 11/9/2006 16:06'!scaleLight: val	val <= 25 ifTrue: [^ 100 - val].	^ ((1023 - val) * (75.0 / 998)) rounded! !!SensorBoardMorph methodsFor: 'private' stamp: 'jm 11/20/2006 15:03'!scaleSound: val	| n |	n _ ((val - 18) max: 0) min: 630.	n < 50 ifTrue: [^ n / 2.0].  "0 to 25"	^ 25.0 + ((n - 50) * (75.0 / 580.0))! !!SensorBoardMorph methodsFor: 'private' stamp: 'jm 9/1/2005 10:48'!startStreamingSensors: sensorByte	"Begin streaming data from the set of sensors specified by the bits of the given byte. Invoke this method with 0 to stop streaming. Incoming sensor data is processed by frequent calls to processIncomingData."	| cmd |	useGoGoProtocol ifFalse: [^ self].	port flushInputBuffer.	cmd _ #(84 254 160 0) asByteArray.	cmd at: 4 put: sensorByte.	port nextPutAll: cmd.! !!SensorBoardMorph methodsFor: 'private' stamp: 'ee 11/10/2007 21:26'!updateTitle	"Update my title to reflect the current protocol and port number."	| s |	s _ (#on = scanState) ifTrue: ['On' localized] ifFalse: ['Off' localized].	s = titleMorph contents ifFalse: [titleMorph contents: s].! !!SerialPort methodsFor: 'input/output' stamp: 'KK 7/31/2017 19:13'!readByteArray	"Answer a ByteArray read from this serial port. Answer an empty ByteArray if no data is available. The port must be open."	| buf count |	buf _ ByteArray new: 2000.	count _ self primReadPort: port into: buf startingAt: 1 count: buf size.	count <= 0 ifTrue: [^ ByteArray new].	^ buf copyFrom: 1 to: count! !!SerialPort2 methodsFor: 'open/close' stamp: 'KK 10/4/2017 19:09'!isOpen	"Answer true if this serial port is open."	portNum ifNil: [^ false].	(ScratchPlugin isPortOpen: portNum)		ifTrue: [^ true]		ifFalse: [portNum _ nil. ^ false].! !!SerialPort2 methodsFor: 'input/output' stamp: 'KK 8/28/2013 08:34'!nextPutAll: aStringOrByteArray	"Send the given bytes out this serial port. The port must be open."	self isOpen ifFalse: [^ self].	ScratchPlugin writePort: portNum data: aStringOrByteArray.! !!SerialPort2 methodsFor: 'input/output' stamp: 'KK 9/6/2013 11:49'!readByteArray	"Answer a ByteArray read from this serial port. Answer an empty ByteArray if no data is available. The port must be open."	| buf count |	self isOpen ifFalse: [^ ByteArray new].	buf _ ByteArray new: 2000.	count _ ScratchPlugin readPort: portNum into: buf.	count <= 0 ifTrue: [^ ByteArray new].	^ buf copyFrom: 1 to: count! !!SetterBlockMorph methodsFor: 'initialization' stamp: 'KK 9/18/2013 19:10'!initSetterForVar: varName	self commandSpec: (ScratchTranslator translationFor: 'set %v to %n').	argPermutation _ CommandBlockMorph argPermutationForSpec: 'set %v to %n' withTranslation: commandSpec.	self selector: #setVar:to:.	self variable: varName.! !!SettingMenu methodsFor: 'accessing' stamp: 'sk 5/15/2017 11:16'!selected	boxes do: [:elm |		elm isOn ifTrue: [			^ boxes indexOf: elm]]! !!SettingMenu methodsFor: 'display' stamp: 'sk 5/15/2017 09:51'!show	| resp |	resp _ diag getUserResponse.! !!SettingMenu methodsFor: 'display' stamp: 'sk 5/15/2017 11:32'!showAndWaitingResponse	| resp |	resp _ diag getUserResponse.	resp = #cancelled ifTrue: [		^ nil]	ifFalse: [		^ self selected]! !!SettingMenu methodsFor: 'initialization' stamp: 'sk 5/23/2017 16:40'!initialize	| setting calib0 calib1 |	diag _ DialogBoxMorph new		withButtonsForYes: false no: false okay: true cancel: true;		title: 'Calibration Setting Options';		message: ''.	boxes _ OrderedCollection new.	calib0 _ 'PC (default)', String cr,		'Keep your Sermotor calibrations even when you restart your computer or make a new program by saving them to your PC.'.	calib1 _ 'File', String cr,		'Save your Servomotor calibrations to a file. You''ll need to calibrate them each time you restart your PC or open a new file.'.	setting _ OrderedCollection new.	setting add: calib0; add: calib1.	self addEntries: setting.! !!SettingMenu methodsFor: 'private' stamp: 'sk 5/22/2017 15:28'!addEntries: aList	| cont title |	cont _ AlignmentMorph new.	cont orientation: #Vertical;		borderWidth: 1;		color: (Color transparent)."	title _ StringMorph contents: 'Motor calibration store location.' localized				font: (ScratchFrameMorph getFont: #Label).	cont addMorphBack: title."	aList do: [: elm |		cont addMorphBack: (self cboxWithDescription: elm)].	diag addMessageLine: cont.! !!SettingMenu methodsFor: 'private' stamp: 'sk 5/22/2017 15:30'!cboxWithDescription: aDescription	"comment stating purpose of message"	| al cbox descMorph |	al _ AlignmentMorph new centering: #center.	al color: (Color transparent).	cbox _ ToggleButton new		onForm: (ScratchFrameMorph skinAt: #radioButtonOn)		offForm: (ScratchFrameMorph skinAt: #radioButton)		overForm: nil		disabledForm: (ScratchFrameMorph skinAt: #radioButtonOn).	cbox target: self; actionSelector: #check:; arguments: (Array with: cbox).	boxes add: cbox.	descMorph _ MultilineStringMorph new		isEditable: false;		borderWidth: 0;		extent: (300@0);		growWithText: true;		contents: aDescription localized.	al addMorph: cbox.	al addMorphBack: (Morph new extent: 10@0).	al addMorphBack: descMorph.	^ al! !!SettingMenu methodsFor: 'private' stamp: 'KK 2/13/2018 11:03'!check: aBox	| |	boxes do: [: elm|		elm == aBox ifTrue: [			elm isDisabled: true]		ifFalse: [			elm off.			elm isDisabled: false]]! !!SettingMenu methodsFor: 'private' stamp: 'KK 2/13/2018 10:59'!select: aNumber	(boxes at: aNumber) on.	(boxes at: aNumber) isDisabled: true.! !!SettingMenu class methodsFor: 'instance creation' stamp: 'sk 5/15/2017 11:20'!showWith: aNumber	^ self new select: aNumber; showAndWaitingResponse.! !!Socket methodsFor: 'connection open/close' stamp: 'KK 8/9/2017 10:15'!connectTo: hostAddress port: port	"Initiate a connection to the given port at the given host address. This operation will return immediately; follow it with waitForConnectionUntil: to wait until the connection is established."	| status |	status _ self primSocketConnectionStatus: socketHandle.	(status == Unconnected)		ifFalse: [self error: 'Socket status must Unconnected before opening a new connection'].	self primSocket: socketHandle connectTo: hostAddress port: port.! !!SimpleClientSocket methodsFor: 'entry points' stamp: 'sk 7/29/2016 17:38'!getBMResponse	^ self getBMResponseFor: 30! !!SimpleClientSocket methodsFor: 'entry points' stamp: 'sk 7/29/2016 17:28'!getBMResponseFor: seconds	| line idx |	line _ WriteStream on: String new.	buffer ifNil: [		buffer _ String new.		bufferPos _ 0 ].	[		"look for a LF in the buffer"		idx _ buffer indexOf: Character lf startingAt: bufferPos+1 ifAbsent: [ 0 ].		idx > 0 ifTrue: [			"found it!! we have a line"			line nextPutAll: (buffer copyFrom: bufferPos+1 to: idx-1).			bufferPos _ idx.			^line contents ].				"didn't find it.  add the whole buffer to the line, and retrieve some more data"		line nextPutAll: (buffer copyFrom: bufferPos+1 to: buffer size).		bufferPos _ 0.		buffer _ String new.		(self waitForBMMessageEvery: seconds) ifTrue: [			buffer _ self getData.		] ifFalse: [			^ '-1'.		].		true	] whileTrue.! !!SimpleClientSocket methodsFor: 'private' stamp: 'sk 7/27/2016 19:04'!waitForBMMessageEvery: seconds	"Wait for data to arrive, asking the user periodically if they wish to keep waiting. If they don't wish to keep waiting, destroy the socket and raise an error."	| gotData |	gotData _ false.	[gotData]		whileFalse: [			gotData _ self waitForDataUntil: (Socket deadlineSecs: seconds).			gotData ifFalse: [				self isConnected ifFalse: [					self destroy.					"self error: 'server closed connection'."					ScratchFrameMorph displayMessageDialog: '12'." Display error message dialog "					^ false.				] ifTrue: [					self destroy.					"self error: 'no response from server'"					ScratchFrameMorph displayMessageDialog: '11'." Display error message dialog "					^ false.				].			]		].	^ true.! !!SimpleUCDClientSocket methodsFor: 'private' stamp: 'KK 11/13/2017 16:14'!waitForBMMessageEvery: seconds	"Wait for data to arrive, asking the user periodically if they wish to keep waiting. If they don't wish to keep waiting, destroy the socket and raise an error."	| gotData |	gotData _ false.	[gotData]		whileFalse: [			gotData _ self waitForDataUntil: (Socket deadlineSecs: seconds).			gotData ifFalse: [				^ false.			].		].	^ true.! !!SimpleUCDClientSocket methodsFor: 'entry points' stamp: 'KK 11/13/2017 16:35'!getBMResponseFor: seconds	| line idx |	line _ WriteStream on: String new.	buffer ifNil: [		buffer _ String new.		bufferPos _ 0 ].	[		"look for a LF in the buffer"		idx _ buffer indexOf: Character lf startingAt: bufferPos+1 ifAbsent: [ 0 ].		idx > 0 ifTrue: [			"found it!! we have a line"			line nextPutAll: (buffer copyFrom: bufferPos+1 to: idx-1).			bufferPos _ idx.			^line contents ].				"didn't find it.  add the whole buffer to the line, and retrieve some more data"		line nextPutAll: (buffer copyFrom: bufferPos+1 to: buffer size).		bufferPos _ 0.		buffer _ String new.		(self waitForBMMessageEvery: seconds) ifTrue: [			buffer _ self getData.		] ifFalse: [			self isConnected ifFalse: [				self destroy.				 ^ 'NETDISCON'			] ifTrue: [^ '-1'.]		].		true	] whileTrue.! !!SpriteArgMorph methodsFor: 'event handling' stamp: 'KK 7/12/2017 15:28'!mouseDown: evt	self presentMenu.! !!SpriteArgMorph methodsFor: 'event handling' stamp: 'KK 8/17/2017 14:32'!presentMenu	"Let the user select a Scratch object or the special value #mouse."	| frame sel objList menu choice |	(frame _ self ownerThatIsA: ScratchFrameMorph) ifNil: [^ self].	(owner isKindOf: CommandBlockMorph) ifTrue: [sel _ owner selector].	objList _ frame scratchObjects.	objList sort: [:obj1 :obj2 | obj1 objName asLowercase < obj2 objName asLowercase].	menu _ CustomMenu new.	sel = #getAttribute:of:		ifTrue: [			menu add: ('Stage' localized asUTF8) action: frame workPane]		ifFalse: [			menu add: 'mouse-pointer' localized asUTF8 action: #mouse.			sel = #touching: ifTrue: [menu add: 'edge' localized asUTF8 action: #edge].			objList _ objList copyWithout: owner receiver.		].	" If objList include ArduinoScratchSpriteMorph object, I delete the object name from menu "	(objList size - 1) > 0 ifTrue: [menu addLine].	objList do: [:obj |		((sel = #touching:) | (sel = #distanceTo:) | (sel = #getAttribute:of:) | (sel = #pointTowards:) | (sel = #gotoSpriteOrMouse:)) ifTrue: [			(obj isMemberOf: ArduinoScratchSpriteMorph) ifFalse: [ menu add: obj objName action: obj ].		].	].	(choice _ menu startUp) ifNil: [^ self].	morph _ choice.	self fixGetAttribueBlock.	self updateLabel.! !!SpriteArgMorph methodsFor: 'other' stamp: 'KK 8/2/2013 12:59'!printArduArgOn: aStream	"Print this argument morph on the given stream."	aStream nextPutAll: 's['.	aStream nextPutAll: self labelMorph contents.	aStream nextPut: $].! !!SpriteArgMorph methodsFor: 'other' stamp: 'KK 8/2/2013 13:01'!printArgOn: aStream	"Print this argument morph on the given stream."	aStream nextPutAll: self labelMorph contents.! !!StandardFileStream class methodsFor: 'file creation' stamp: 'KK 8/21/2013 15:01'!newScratchFileNamed: fileName	"Create a new file with the given name, and answer a stream opened for writing on that file. If the file already exists, ask the user what to do."	| dir localName choice newName fullName result ext |	fullName _ self fullName: fileName.	(self isAFileNamed: fullName) ifFalse: [		result _ self new open: fullName forWrite: true.		result ifNil: [DialogBoxMorph inform: 'Could not write file' withDetails: 'Is the folder read-only?' localized].		^ result].	"file already exists:"	dir _ FileDirectory forFileName: fullName.	localName _ FileDirectory localNameFor: fullName.	choice _ DialogBoxMorph		askWithCancel: 'The file name already exists. Overwrite existing file?'.	choice = #cancelled ifTrue: [^ nil].	choice		ifTrue: [			dir deleteFileNamed: localName ifAbsent: [].			result _ self new open: fullName forWrite: true.			result ifNil: [DialogBoxMorph inform: 'Could not write file' withDetails: 'Is the folder read-only?' localized].			^ result]		ifFalse: [			newName _ StringDialog askWithCancel: 'New file name?'.			newName size = 0 ifTrue: [^ nil].			fullName _ dir fullNameFor: newName.			ext _ FileDirectory extensionFor: fileName.			(ext size > 0 and: [(newName endsWith: ext) not]) ifTrue: [				fullName _ fullName, '.', ext].			^ self newScratchFileNamed: fullName].! !!CrLfFileStream class methodsFor: 'class initialization' stamp: 'KK 1/7/2015 17:23'!newScratchFileNamed: fileName	"Create a new file with the given name, and answer a stream opened for writing on that file. If the file already exists, ask the user what to do."	| dir localName choice newName fullName result ext |	fullName _ self fullName: fileName.	(self isAFileNamed: fullName) ifFalse: [		result _ self new open: fullName forWrite: true.		result ifNil: [DialogBoxMorph inform: 'Could not write file' withDetails: 'Is the folder read-only?' localized].		^ result].	"file already exists:"	dir _ FileDirectory forFileName: fullName.	localName _ FileDirectory localNameFor: fullName.	choice _ DialogBoxMorph		askWithCancel: 'The file name already exists. Overwrite existing file?'.	choice = #cancelled ifTrue: [^ nil].	choice		ifTrue: [			dir deleteFileNamed: localName ifAbsent: [].			result _ self new open: fullName forWrite: true.			result ifNil: [DialogBoxMorph inform: 'Could not write file' withDetails: 'Is the folder read-only?' localized].			^ result]		ifFalse: [			newName _ StringDialog askWithCancel: 'New file name?'.			newName size = 0 ifTrue: [^ nil].			fullName _ dir fullNameFor: newName.			ext _ FileDirectory extensionFor: fileName.			(ext size > 0 and: [(newName endsWith: ext) not]) ifTrue: [				fullName _ fullName, '.', ext].			^ self newScratchFileNamed: fullName].! !!String methodsFor: 'converting' stamp: 'KK 2/13/2018 18:22'!sansSemicolonSuffix	"Return a copy of the receiver up to, but not including, the first period.  If the receiver's *first* character is a period, then just return the entire receiver. "	| likely |	likely _ self copyUpTo: $;.	^ likely size == 0		ifTrue:	[self]		ifFalse:	[likely]! !!StringDialog methodsFor: 'initialization' stamp: 'KK 9/1/2014 12:01'!initialize	"Similar to my superclass, but with a string field for the user's response."	super initialize.	self title: '?'.	"create and position typeinMorph"	ValueOrList ifTrue: [	" Value or list "		mainColumn			addMorph: (Morph new extent: (5@6); color: Color transparent);			addMorph: (typeinMorph _ AlphamericFieldMorph				new client: self;				borderWidth: 2;				color: (Color r: (211/255) g: (214/255) b: (216/255)));			addMorph: (Morph new extent: (5@6); color: Color transparent).	] ifFalse: [	" Not value or list "		mainColumn			addMorph: (Morph new extent: (5@6); color: Color transparent);			addMorph: (typeinMorph _ StringFieldMorph				new client: self;				borderWidth: 2;				color: (Color r: (211/255) g: (214/255) b: (216/255)));			addMorph: (Morph new extent: (5@6); color: Color transparent).	].		typeinMorph		font: (ScratchFrameMorph getFont: #StringDialogTypeIn);		width: 250.	tabFields add: typeinMorph.! !!StringDialog methodsFor: 'interaction' stamp: 'sk 2/20/2017 18:00'!getUserResponse	"Wait for the user to type in and accept a string, then report that string. Answer the empty string if the user cancels the operation."	"Details: This is invoked synchronously from the caller. In order to keep processing inputs and updating the screen while waiting for the user to respond, this method has its own version of the World's event loop."	| w |	self openInWorld.	TabletMode ifTrue: [		self topCenterOnScreen]	ifFalse: [		self centerOnScreen].	w _ self world.	w activeHand newKeyboardFocus: typeinMorph.	done _ false.	[done] whileFalse: [w doOneCycle].  "wait for user to press a button"	self delete.	w doOneCycle.  "erase myself from the screen"	response = #cancelled		ifTrue: [^ '']		ifFalse: [^ typeinMorph contents asString].! !!StringDialog class methodsFor: 'instance creation' stamp: 'KK 9/1/2014 11:39'!ask: questionString	"Put up an instance of me to ask the user for string input (such as file name). Answer the edited string."	^ self askWithCancel: questionString initialAnswer: ''! !!StringDialog class methodsFor: 'instance creation' stamp: 'KK 9/1/2014 11:39'!ask: questionString initialAnswer: aString	"Put up an instance of me to ask the user for string input (such as file name). The initial response text is set to the given string, which the user can replace or edit. Answer the edited string."	| dialogBox |	dialogBox _ self new		withButtonsForYes: false no: false okay: true cancel: false;		message: questionString;		initialAnswer: aString.	^ dialogBox getUserResponse! !!StringDialog class methodsFor: 'instance creation' stamp: 'KK 9/1/2014 11:39'!askWithCancel: questionString	"Like ask:, but with a cancel button. Answer the empty string if cancelled."	^ self askWithCancel: questionString initialAnswer: ''! !!StringDialog class methodsFor: 'instance creation' stamp: 'KK 12/17/2013 18:02'!askWithCancel: questionString initialAnswer: aString	"Put up an instance of me to ask the user for string input (such as file name). The initial response text is set to the given string, which the user can replace or edit. This version includes a cancel button. Answer the empty string if cancelled."	| dialogBox |	dialogBox _ self new		withButtonsForYes: false no: false okay: true cancel: true;		message: questionString;		initialAnswer: aString.	^ dialogBox getUserResponse! !!StringFieldMorph methodsFor: 'accessing' stamp: 'KK 2/5/2018 09:54'!color: c	color _ c.! !!StringFieldMorph methodsFor: 'event handling' stamp: 'KK 5/12/2014 17:00'!keyStroke: evt	| ch m |	ch _ evt unicodeChar.	ch = 0 ifTrue: [ch _ evt keyValue].	evt buttons = 64 ifTrue: [ch _ ch \\ 32].  "command (alt) key pressed; map to a control key"	(ch = 3) & (evt buttons = 0) ifTrue: [ch _ 13].  "map enter key to cr"	ch = 9 ifTrue: [  "tab"		(m _ self ownerThatIsA: DialogBoxMorph) ifNotNil: [m tabToNextField: evt].		(m _ self ownerThatIsA: CommandBlockMorph) ifNotNil: [m tabToNextField: evt].		^ self].	(ch = 10) | (ch = 13) ifTrue: [  "cr, lf, or enter key"		(m _ self ownerThatIsA: DialogBoxMorph) ifNotNil: [^ m enterKeyPressed: evt].		(m _ self ownerThatIsA: ScratchPrompterMorph) ifNotNil: [^ m enterKeyPressed].		(m _ self ownerThatIsA: NumericUpDownMorph) ifNotNil: [ ^ m enterKeyPressed].		evt hand newKeyboardFocus: nil.		^ self].	ch = 27 ifTrue: [  "escape key"		(m _ self ownerThatIsA: DialogBoxMorph) ifNotNil: [m escapeKeyPressed: evt].		^ self].	ch = 8 ifTrue: [^ self backspace].	ch = 127 ifTrue: [^ self deleteSelection].	(evt buttons = 64) | (evt buttons = 16) ifTrue: [	"ctrl (or alt) is pressed"		ch = 1 ifTrue: [self selectAll].		"ctrl-a"		ch = 3 ifTrue: [self copySelection]. 	"ctrl-c"		ch = 22 ifTrue: [self paste].			"ctrl-v"		ch = 24 ifTrue: [self cutSelection].	"ctrl-x"		ch = 26 ifTrue: [self undo]].			"ctrl-z"	evt buttons = 8 ifTrue: [ "shift is pressed"		ch = 28 ifTrue: [self moveCursorLeftAndSelect].  	"shift-left"		ch = 29 ifTrue: [self moveCursorRightAndSelect].	"shift-right"		ch = 1 ifTrue: [self moveCursorHomeAndSelect].	"home"		ch = 4 ifTrue: [self moveCursorEndAndSelect]].	"end"	evt buttons = 0 ifTrue: [		ch = 1 ifTrue: [self moveCursorHome].	"home"		ch = 4 ifTrue: [self moveCursorEnd].		"end"		ch = 28 ifTrue: [self moveCursorLeft].	"left"		ch = 29 ifTrue: [self moveCursorRight].	"right"		blinkState _ true].	ch >= 32 ifTrue: [self insertCharacter: ch].! !!StringFieldMorph methodsFor: 'text editing' stamp: 'sk 2/7/2017 09:07'!moveCursorAt: index	"Move the cursor to the specified index of the current line."	self recordUndoState.	selectionStart _ index within: 0 and: (stringMorph contents size).	selectionEnd _ selectionStart.	self changed.! !!StringFieldMorph methodsFor: 'private' stamp: 'sk 2/7/2017 09:11'!cursorPosition	^ selectionStart! !!AlphamericFieldMorph methodsFor: 'event handling' stamp: 'KK 9/17/2014 11:19'!keyStroke: evt	| ch m |	ch _ evt unicodeChar.	ch = 9 ifTrue: [  "tab"		(m _ self ownerThatIsA: DialogBoxMorph) ifNotNil: [m tabToNextField: evt].		(m _ self ownerThatIsA: CommandBlockMorph) ifNotNil: [m tabToNextField: evt].		^ self].	(ch = 10) | (ch = 13) ifTrue: [  "cr, lf, or enter key"		(m _ self ownerThatIsA: DialogBoxMorph) ifNotNil: [^ m enterKeyPressed: evt].		(m _ self ownerThatIsA: ScratchPrompterMorph) ifNotNil: [^ m enterKeyPressed].		(m _ self ownerThatIsA: NumericUpDownMorph) ifNotNil: [ ^ m enterKeyPressed].		evt hand newKeyboardFocus: nil.		^ self].	ch = 27 ifTrue: [  "escape key"		(m _ self ownerThatIsA: DialogBoxMorph) ifNotNil: [m escapeKeyPressed: evt].		^ self].	ch = 8 ifTrue: [^ self backspace].	ch = 127 ifTrue: [^ self deleteSelection].	(evt buttons = 64) | (evt buttons = 16) ifTrue: [	"ctrl (or alt) is pressed"		ch = 1 ifTrue: [self selectAll].		"ctrl-a"		ch = 3 ifTrue: [self copySelection]. 	"ctrl-c"		ch = 22 ifTrue: [self paste].			"ctrl-v"		ch = 24 ifTrue: [self cutSelection].	"ctrl-x"		ch = 26 ifTrue: [self undo]].			"ctrl-z"	evt buttons = 8 ifTrue: [ "shift is pressed"		ch = 28 ifTrue: [self moveCursorLeftAndSelect].  	"shift-left"		ch = 29 ifTrue: [self moveCursorRightAndSelect].	"shift-right"		ch = 1 ifTrue: [self moveCursorHomeAndSelect].	"home"		ch = 4 ifTrue: [self moveCursorEndAndSelect]].	"end"	evt buttons = 0 ifTrue: [		ch = 1 ifTrue: [self moveCursorHome].	"home"		ch = 4 ifTrue: [self moveCursorEnd].		"end"		ch = 28 ifTrue: [self moveCursorLeft].	"left"		ch = 29 ifTrue: [self moveCursorRight].	"right"		blinkState _ true].	" ch = [0-9][A-Z][a-z][_] ? "	( ((ch >= 48) & (ch <= 57)) | ((ch >= 65) & (ch <= 90)) | ((ch >= 97) & (ch <= 122)) | ((ch = 95))) ifFalse: [		^ self.	].	ch = 0 ifTrue: [ch _ evt keyValue].	evt buttons = 64 ifTrue: [ch _ ch \\ 32].  "command (alt) key pressed; map to a control key"	(ch = 3) & (evt buttons = 0) ifTrue: [ch _ 13].  "map enter key to cr"	ch >= 32 ifTrue: [self insertCharacter: ch].! !!StuduinoSensorBoardMorph methodsFor: 'private' stamp: 'KK 10/12/2017 12:10'!closeSocket	| |socket ifNotNil: [	socketCommand sendCommand: 'BREAK'.	socketCommand disconnect.	socketCommand destroy.	socketCommand _ nil.	" Send message "	Transcript show: '---------- Sending ----------'; cr.	socket sendCommand: 'BREAK'.	socket disconnect.	socket destroy.	socket _ nil].	currentState _ #idle.	sensorValues atAllPut: 0.	scratchBoardV3 _ false."	1 to: 8 do: [:i | (readouts at: i) contents: '0']."	1 to: readouts size do: [:i | (readouts at: i) contents: '0'].	scanState _ #off.! !!StuduinoSensorBoardMorph methodsFor: 'private' stamp: 'KK 10/12/2017 12:22'!convertAccelerometer: aValue	| val |	val _ aValue.	aValue > 127 ifTrue: [		val _ aValue - 256].	^ (val + 128) * 100 // 255! !!StuduinoSensorBoardMorph methodsFor: 'private' stamp: 'KK 12/23/2017 15:52'!convertGyro: aValue kind: id	| val |	val _ aValue.	((id = 9) | (id = 10) | (id = 11)) ifTrue: [		^ (((val / 16384.0 * 10) rounded) truncated) / 10.0."		^ val / 16384.0."	].	((id = 12) | (id = 13) | (id = 14)) ifTrue: [		^ (((val / 131.072 * 10) rounded) truncated) / 10.0."		^ val / 131.072."	].! !!StuduinoSensorBoardMorph methodsFor: 'private' stamp: 'KK 10/12/2017 12:23'!convertToCelcius: aValue	^ (((aValue / 1024) * 3.3) - 0.5) / 0.01! !!StuduinoSensorBoardMorph methodsFor: 'private' stamp: 'KK 10/12/2017 12:23'!processIncomingData	"Process incoming bytes from the serial port."	"Details: To work around a problem with the Prolific USB-Serial drivers on some Windows machines, a strict turn-taking polling protocol is used. A poll byte is sent, the ScratchBoard sends a response, and after a small delay (to be sure that all the data from the last poll has arrived, another poll is sent. The goal is to never allow more that few bytes to accumulate in the serial input buffer and to avoid sending a poll byte while data is arriving. However, since different versions of the ScratchBoard may send different amounts of data, we don't want to hard-code the number of reply bytes. Thus"	| buf msecsSinceLastPoll |	(self portIsOpen and: [#on = scanState]) ifFalse: [^ self].	useGoGoProtocol ifTrue: [		buf _ port readByteArray.		buf do: [:b | self processGoGoByte: b].		^ self].	msecsSinceLastPoll _ Time millisecondClockValue - lastPollMSecs.	msecsSinceLastPoll < 20 ifTrue: [^ self].	buf _ port readByteArray.	(buf size = 0) ifTrue: [	" The case of disconnection "		" Increment ResetCounter "		ResetCounter _ (ResetCounter + 1).		(ResetCounter = 20) ifTrue: [			ResetCounter _ 0.			self closeForDisconnection.			ScratchFrameMorph displayMessageDialog: '33']]	ifFalse: [		ResetCounter _ 0].	buf do: [:b | self processScratchByte: b]."	port nextPut: 1."	"send a ScratchBoard V4 poll byte"	lastPollMSecs _ Time millisecondClockValue.! !!StuduinoSensorBoardMorph methodsFor: 'private' stamp: 'KK 10/13/2017 18:13'!processIncomingData2	"Process incoming bytes from the socket."	| buf msecsSinceLastPoll |	(self socketIsOpen) ifFalse: [^ self].	msecsSinceLastPoll _ Time millisecondClockValue - lastPollMSecs.	msecsSinceLastPoll < 20 ifTrue: [^ self].	buf _ self readByteArrayFromSocket.	(buf size = 0) ifTrue: [	" The case of disconnection "		" Increment ResetCounter "		ResetCounter _ (ResetCounter + 1)."Transcript show:'[Reset counter]';show:ResetCounter;cr."		(ResetCounter = 20) ifTrue: [			ResetCounter _ 0.			self closeSocket.			ScratchFrameMorph displayMessageDialog: '33'.		].	] ifFalse: [		ResetCounter _ 0.	].	buf do: [:b |		self processScratchByte: b.		]."	port nextPut: 1."	"send a ScratchBoard V4 poll byte"	lastPollMSecs _ Time millisecondClockValue.! !!StuduinoSensorBoardMorph methodsFor: 'private' stamp: 'KK 12/23/2017 15:58'!processScratchByte: aByte	"Process one byte of the incoming data stream from a Scratch sensor board."	"Sensor messages are two bytes with the following format:		Byte1: <1><sensor number (4 bits)><sensor value high bits (3 bits)>		Byte2: <0><sensor value low bits (7 bits)>"	| sensorNum val dtype pos isExtendedRead obj |	(aByte bitShift: -5) = 4 ifTrue: [		dtype _ aByte bitAnd: 16r1F.		dtype = 0 ifTrue: [	"ACK"			resCommand _ 1].		dtype = 1 ifTrue: [	"NACK"			resCommand _ -1].		dtype = 16r1F ifTrue: [	"syncFinish"			onSyncServo _ false].		^ self].	" Not update if the data is dummy. (No sensor is selected but A0 dat comes as dummy.) "	(IOPort select: [:each | (each > 15) & (each < 26)]) size = 0		ifTrue: [^ self].	"Extended data coming."	isExtendedRead _ false.	(((aByte bitShift: -6) = 2) | ((aByte bitShift: -6) = 3)) ifTrue: [		isExtendedRead _ true].	currentState = #idle ifTrue: [  "wait for first byte of message"		(aByte bitShift: -6) = 0 ifTrue: [			currentState _ #firstByteSeen.			highByte _ aByte].		^ self].	currentState = #firstByteSeen ifTrue: [		(aByte bitShift: -6) = 0 ifTrue: [  "must have lost second byte; stay in firstByteSeen state"			highByte _ aByte.			^ self].		"good second byte: report the sensor value"		sensorNum _ ((highByte bitShift: -2) bitAnd: 16rF) + 1.		val _ ((highByte bitAnd: 3) bitShift: 6) + (aByte bitAnd: 16r3F).		" Checking an extended data. "		sensorNum <= 8 ifTrue: [			"Temperature sensor"			(IOPort at: (10 + sensorNum)) = 16r18 ifTrue: [				isExtendedRead ifFalse: [					secondByte _ aByte.					^ self				].				val _ ((highByte bitAnd: 3) bitShift: 6) + (secondByte bitAnd: 16r3F).				val _ val + ((aByte bitAnd: 16r3F) bitShift: 8)			]		] ifFalse: [			"Gyro sensor"			(IOPort at: 15) = 16r19 ifTrue: [				isExtendedRead ifFalse: [					secondByte _ aByte.					^ self.				] ifTrue: [					(((aByte bitShift: -6) bitAnd: 3) = 2) ifTrue: [						thirdByte _ aByte.						^ self					].				].				val _ ((highByte bitAnd: 3) bitShift: 6) + (secondByte bitAnd: 16r3F).				val _ val + ((thirdByte bitAnd: 16r1F) bitShift: 8).				val _ val + ((aByte bitAnd:16r07) bitShift: 13).				(val > 32767) ifTrue: [					val _ val - 65536.				].			]		].		(val = 128) ifTrue: [ ^ self ].		(val = 128) ifTrue: [ val _ 0. ].	" 128 is open port or output parts "				(BoardType = 1) & (sensorNum = (readouts size)) ifTrue: [			val _ (val / 10.0)].		sensorNum <= sensorValues size ifTrue: [			pos _ sensorNum.			((sensorNum = 7 ) | (sensorNum = 8))				ifTrue: [					(readouts size ) > 8 ifTrue: [ pos _ sensorNum + 1]. "A6/A7 position increment by Acc"					(readouts size ) > 10 ifTrue: [ pos _ sensorNum + 4]]. "A6/A7 position increment by Gyro"			sensorNum > 8				ifTrue: [					pos _ sensorNum - 4.  "Accelerometer readout position to I2C"					(IOPort at: 15) = StdnoPIDAcceleration ifTrue: [						val _ self convertAccelerometer: val					].					(IOPort at: 15) = StdnoPIDGyro ifTrue: [						val _ (self convertGyro: val kind: sensorNum).					].				] ifFalse: [					(IOPort at: (10 + sensorNum)) = 16r18						ifTrue: [							obj _ listTempBuf at: sensorNum.							val _ (obj average: (self convertToCelcius: val)) asFloat.]].			sensorValues at: pos put: val.			sensorNum = 16 ifTrue: [				(val == 3) | (val == 4) ifTrue: [					scratchBoardV3 _ true]]].  "ScratchBoard, version 3 or 4"		currentState _ #idle].! !!StuduinoSensorBoardMorph methodsFor: 'private' stamp: 'KK 10/12/2017 12:11'!readByteArray	"Answer true if a GoGoBoard is connected to my serial port."	| buf |	port flushInputBuffer.	^ buf _ port readByteArray.! !!StuduinoSensorBoardMorph methodsFor: 'private' stamp: 'KK 10/12/2017 12:11'!socket: mSocket	"Answer true if a GoGoBoard is connected to my serial port."	socket _ mSocket.	scanState _ #on.	"initialize polling state"	lastPollMSecs _ Time millisecondClockValue.! !!StuduinoSensorBoardMorph methodsFor: 'private' stamp: 'KK 10/12/2017 12:11'!socketCommand: mSocket	socketCommand _ mSocket.! !!StuduinoSensorBoardMorph methodsFor: 'private' stamp: 'KK 10/12/2017 12:12'!socketIsOpen	^ socket notNil! !!StuduinoSensorBoardMorph methodsFor: 'private' stamp: 'KK 10/12/2017 12:24'!updateTitle	"Update my title to reflect the current protocol and port number."	| s |	s _ (#on = scanState) ifTrue: ['Sensor Board' localized] ifFalse: ['Off' localized].	s = titleMorph contents ifFalse: [titleMorph contents: s].! !!StuduinoSensorBoardMorph methodsFor: 'object i/o' stamp: 'KK 10/12/2017 12:10'!disconnected	^ disconnected! !!StuduinoSensorBoardMorph methodsFor: 'object i/o' stamp: 'KK 10/12/2017 12:10'!disconnected: aBoolean	disconnected _ aBoolean.! !!StuduinoSensorBoardMorph methodsFor: 'event handling' stamp: 'KK 10/12/2017 12:22'!rightButtonMenu! !!StuduinoSensorBoardMorph methodsFor: 'serial port' stamp: 'KK 10/12/2017 12:18'!closeForDisconnection	self dummyStop.	disconnected _ true.	currentState _ #idle.	sensorValues atAllPut: 0.	scratchBoardV3 _ false.	readouts do: [:elm | elm contents: '0'].	scanState _ #off.	self step.! !!StuduinoSensorBoardMorph methodsFor: 'serial port' stamp: 'KK 10/12/2017 12:18'!closePort	self dummyStop.	port ifNotNil: [		"self data:0 msgID:7."	"Send End of Communication to PC"		port flushInputBuffer.		port close].	port _ nil.	currentState _ #idle.	sensorValues atAllPut: 0.	scratchBoardV3 _ false.	readouts do: [:elm | elm contents: '0'].	scanState _ #off.	self step.! !!StuduinoSensorBoardMorph methodsFor: 'serial port' stamp: 'KK 10/12/2017 12:19'!data: d msgID: id	"I make message and send it to board."	| mid high low msgh msgl msg carry sendMessage checksum |	(BoardType = 0) ifTrue: [		(self portIsOpen) ifFalse: [ ^0. ].]	ifFalse: [		(self socketIsOpen) ifFalse: [^0. ].].	mid _ id bitShift: 4.			 " mid = id << 4 "	high _ d bitShift: -8.		 " high = d >> 8""Transcript show:'high:'; show:high;cr."	carry _ d bitShift: -7.		 " low side carry = d >> 7""Transcript show:'carry:'; show:carry;cr."	carry _ carry bitAnd: 16r01.	 " carry = carry & 0x01""Transcript show:'carry:'; show:carry;cr."	high _ high + carry.		 " high = high + carry""Transcript show:'high:'; show:high;cr.""	high _ d bitShift: -7."	high _ high bitAnd: 16r0F.	" high = high & 0x0F"	low _ d bitAnd: 16r7F.		" low = d & 0x7F"	msgh _ 16r80 + mid + high.	" msgh = 0x80 + mid + high"	msgl _ low.					" msgl = low"	msg _ #(0 0 0) asByteArray.	msg at: 1 put:msgh.	msg at: 2 put: msgl.	(BoardType = 0) ifTrue: [		checksum _ (msgh + msgl) bitAnd: 16rFF.		msg at: 3 put: checksum.		self sendStuduinoData: msg ]	ifFalse: [		sendMessage _ String fromBytes: msg.		sendMessage _ 'REQSEND', sendMessage.		socketCommand sendCommand: sendMessage.		"self stopStepping."		socketCommand getResponseShowing: true.   "Waiting ACK"		"self startStepping.""		socket sendCommand: 'REQSEND'.		socket sendCommand: (String fromBytes: msg)."].! !!StuduinoSensorBoardMorph methodsFor: 'serial port' stamp: 'KK 10/12/2017 12:19'!dummySend	" Sending a dummy command repeatedly so that Studuino returning a response.	  It is necessary to prevent from being disconnected automatically. "	| msg |	" Making a dummy command (0xD4 0x00 0xD: version check command.) "	msg _ #(0 0 0) asByteArray.	msg at: 1 put: 16rD4.	msg at: 3 put: 16rD4.	processDummySend _ [		[true] whileTrue: [			self sendStuduinoData: msg.			(Delay forMilliseconds: 100) wait]] fork.! !!StuduinoSensorBoardMorph methodsFor: 'serial port' stamp: 'KK 10/12/2017 12:19'!dummyStop	processDummySend ifNotNil: [		processDummySend terminate.		processDummySend _ nil]! !!StuduinoSensorBoardMorph methodsFor: 'serial port' stamp: 'KK 10/12/2017 12:09'!isBoardSetup	"Answer true if a Arduino Board is connected to serial port."	| buf temp start timeOut |	temp _ port flushInputBuffer.	(temp = -1) ifTrue: [Transcript show:'error1';cr.		^ false.	].	self sendForInit.	buf _ port readByteArray.	(buf) ifNil: [Transcript show:'error2';cr.		^ false.	].	timeOut _ 4000.	start _ Time millisecondClockValue.	[buf size = 0] whileTrue: [		(Delay forMilliseconds: 500) wait.		self sendForInit.		buf _ port readByteArray.		(buf) ifNil: [			^ false.		].		(Time millisecondClockValue - start > timeOut) ifTrue: [			Transcript show: 'Time out'; cr.			^ false].	].	^ true.! !!StuduinoSensorBoardMorph methodsFor: 'serial port' stamp: 'KK 10/12/2017 12:20'!openPort: aString	"Close the serial port if it is open, then open the port with the given name and initialize streaming of sensor data. Answer true if the operation was successful."	| baudRate portNum numStart |	baudRate _ useGoGoProtocol ifTrue: [9600] ifFalse: [115200].	self closePort.	portName _ aString.	ScratchPlugin serialPortOpsAvailable		ifTrue: [			port _ SerialPort2 new openPortNamed: portName baud: baudRate.			port isOpen ifFalse: [port _ nil. ^ false].			port setOption: 20 to: 1.  "set DTR high"			port setOption: 21 to: 0]  "set RTS low"		ifFalse: [			portNum _ 1.			numStart _ (1 to: portName size) detect: [:i | (portName at: i) isDigit] ifNone: [0].			numStart > 0 ifTrue: [portNum _ (portName copyFrom: numStart to: portName size) asNumber].			port _ SerialPort new				baudRate: baudRate;				inputFlowControlType: 2;				openPort: portNum ifFail: [^ false]].	"initialize polling state"	lastPollMSecs _ Time millisecondClockValue.	^ true! !!StuduinoSensorBoardMorph methodsFor: 'serial port' stamp: 'KK 2/13/2018 19:07'!readByteArrayFromSocket	"Answer a ByteArray read from this serial port. Answer an empty ByteArray if no data is available. The socket must be open."	| buf line res |	socket ifNil: [^ ByteArray new].	socket sendCommand: 'REQDATA'.	line _ socket getResponseShowing: true.	res _ line sansSemicolonSuffix.	buf _ res asByteArray.	^ buf! !!StuduinoSensorBoardMorph methodsFor: 'serial port' stamp: 'KK 10/12/2017 12:20'!resetPort	"If the port is closed, do nothing. If it is open, close and reopen it. This can be used to reset the Prolific USB serial driver if it misbehaves."	self portIsOpen ifFalse: [^ self].	portName ifNil: [^ self].	self closePort.	self openPort: portName.	scanState _ #on.! !!StuduinoSensorBoardMorph methodsFor: 'serial port' stamp: 'KK 10/12/2017 12:21'!selectPort	| menu choice |	self stopReadingData.	self portNames size = 0 ifTrue: [^ DialogBoxMorph inform: 'No serial ports found'].	menu _ CustomMenu new.	self portNames do: [:n | menu add: n action: n].	choice _ menu startUp.	choice ifNil: [^ self].	self openPort: choice.	self startReadingData.	scanState _ #on.	ResetCounter _ 0.! !!StuduinoSensorBoardMorph methodsFor: 'serial port' stamp: 'KK 10/12/2017 12:09'!sendForInit	| msg |	msg _ #(0 0 0) asByteArray.	msg at: 1 put: 16rD4.	msg at: 2 put: 0.	msg at: 3 put: 16rD4.	port nextPutAll: msg.! !!StuduinoSensorBoardMorph methodsFor: 'serial port' stamp: 'KK 10/12/2017 12:21'!sendStuduinoData: aByteArray	| startTime |	lockSend critical: [		resCommand _ 0.		port nextPutAll: aByteArray.		startTime _ Time millisecondClockValue.		" Waiting a reponse with timeout of 100ms. "		[resCommand = 0 and: [(Time millisecondClockValue - startTime) < 100]]			whileTrue: [				self step.				Delay forMilliseconds: 20]]! !!StuduinoSensorBoardMorph methodsFor: 'accessing' stamp: 'KK 10/12/2017 12:08'!checkSvmFifo	| block |	(servoMotorBlockFIFO size = 0) ifTrue: [^ nil.].	block _ servoMotorBlockFIFO at:1.	^ block.! !!StuduinoSensorBoardMorph methodsFor: 'accessing' stamp: 'KK 10/12/2017 12:08'!initSyncProc	"Transcript show:'hello SensorBoardMorph::initSyncProc';cr."	servoMotorBlockFIFO _ OrderedCollection new.	onSyncServo _ false.	lockSend _ Semaphore forMutualExclusion.	lockSync _ Semaphore forMutualExclusion.! !!StuduinoSensorBoardMorph methodsFor: 'accessing' stamp: 'KK 10/12/2017 12:08'!isOnSyncServo	^ onSyncServo! !!StuduinoSensorBoardMorph methodsFor: 'accessing' stamp: 'KK 10/12/2017 12:08'!lockSync	^ lockSync! !!StuduinoSensorBoardMorph methodsFor: 'accessing' stamp: 'KK 10/12/2017 12:08'!popSvmFifo	| block |	(servoMotorBlockFIFO size = 0) ifTrue: [^ nil.].	block _ servoMotorBlockFIFO at:1.	servoMotorBlockFIFO removeFirst."Transcript show:servoMotorBlockFIFO contents;cr."	^ block.! !!StuduinoSensorBoardMorph methodsFor: 'accessing' stamp: 'KK 10/12/2017 12:08'!pushSvmFifo: block	" Push block to FIFO if block doesn't exist in FIFO. Return true: block is pushed in FIFO, false: block exists in FIFO."	| find |	find _ servoMotorBlockFIFO select: [:each | each = block].	((find size) = 0) ifTrue: [		servoMotorBlockFIFO add: block."		Transcript show:'<<<<';show:block;cr."		^ true.	] ifFalse: [		^ false.	].! !!StuduinoSensorBoardMorph methodsFor: 'accessing' stamp: 'KK 10/12/2017 12:08'!startSyncServo	onSyncServo _ true! !!StuduinoSensorBoardMorph methodsFor: 'stepping' stamp: 'KK 12/23/2017 16:03'!step	"Update my title and sensor readouts. If scanning for ports, keep scanning."	| frame i |	(BoardType = 0) ifTrue: [	#checkData = scanState ifTrue: [self scanForPort].	self portIsOpen		ifTrue: [self processIncomingData]		ifFalse: [port _ nil."Transcript show: '[SensorBoardMorph::setp] port is nil';cr."		].	]	ifFalse: [		self socketIsOpen ifTrue: [			self processIncomingData2]		ifFalse: [			port _ nil.			Transcript show: 'sb socket is not open.'; cr.	].].	self updateTitle."	1 to: 8 do: [:i |""	1 to: readouts size do: [:i |"	readouts do: [:item |		i _ readouts find: item.		(BoardType = 1 &  i = (readouts size)) ifTrue: [  " Only for Studuino mini Battery Voltage. "			item contents: (self privateSensor: i) printString]		ifFalse: [			item contents: (self privateSensor: i) printString.].		(scratchBoardV3 and: [i = 4])			ifTrue: [(readouts at: i) contents: ((self privateSensor: i) < 10) printString]. "button"		frame _ (readouts at: i) owner.		(frame respondsTo: #fixLayout) ifTrue: [frame fixLayoutForStuduino]	].! !!StuduinoSensorBoardMorph methodsFor: 'sensor ops' stamp: 'KK 10/12/2017 12:16'!privateSensor: sensorIndex 	"Read the virtual sensor with the given index permuted according to which Scratch board is plugged in and scaled if it is a known special sensor such as the light or sound sensor. If reportRaw is true then the raw sensor value (0..1023) is reported."	"This method does not call processIncomingData. It should only be used by the step method."	| i raw |	i _ (sensorIndex asInteger max: 1)				min: readouts size."	useGoGoProtocol		ifFalse: [scratchBoardV3				ifTrue: [i _ #(8 6 7 4 5 3 2 1 ) at: i]				ifFalse: [i _ #(1 2 3 4 5 6 7 8 9) at: i]]."	raw _ sensorValues at: i.	reportRaw _ true.			" return Rawdata "	reportRaw ifTrue: [^ raw].	scratchBoardV3		ifTrue: 			[i = 6 ifTrue: [^ self scaleLight: raw].			i = 7 ifTrue: [^ self scaleSound: raw]].	raw > 1020 ifTrue: [raw _ 1023].! !!StuduinoSensorBoardMorph methodsFor: 'initialization' stamp: 'KK 12/23/2017 15:50'!addReadoutLabeled: aString isSensor: kind	"Add a readout row with the given label. Answer the stringmorph that's the readout."	| row box readout colorName ratio |	row _ AlignmentMorph newRow color: column color; inset: 2.	row addMorphBack: (Morph new color: column color; extent: 1@3). "spacer"	row addMorphBack: (StringMorph contents: aString capitalized font: (StrikeFont fontName: 'VerdanaBold' size: 10)).	row addMorphBack: (AlignmentMorph new color: column color; extent: 10@1; hResizing: #spaceFill).  "spacer"	(kind = true) ifTrue:[	" Sensor "		colorName _ 'sensing'.	] ifFalse: [				" Not sensor "		colorName _ 'notSensing'.	].	ratio := ScratchTranslator renderScale.	box _ WatcherReadoutFrameMorph new		extent: 42@14;		width: 50 * (ratio);		color: (ScriptableScratchMorph blockColorFor: colorName).	readout _ StringMorph contents: '0' font: (StrikeFont fontName: 'VerdanaBold' size: 10).	readout color: Color white.	box addMorph: readout.	row addMorphBack: box.	column addMorphBack: row.	^ readout! !!StuduinoSensorBoardMorph methodsFor: 'initialization' stamp: 'KK 12/23/2017 15:52'!addReadouts	| readoutNames sensorID offset light touch sound infrared acceleration button setAcceleration open led buzzer colorLED kindOfSensor sizeAx tmp header cont temperature setGyro |	" Check IOPort ""	Transcript show:'[SensorBoardMorph::addReadouts] ';show:(IOPort);cr."	setGyro _ false.	" Set gyro sensor flag "	offset _ 10.		" Offset for sensor ID "	open _ 16r00.			" Not connected "	led _ 16r03.				" LED ID "	buzzer _ 16r04.			" Buzzer ID "	colorLED _ 16r05.		" Color LED ID "	light _ 16r10.			" Light sensor ID "	touch _ 16r11.			" Touch sensor ID "	sound _ 16r12.			" Sound sensor ID "	infrared _ 16r13.		" IR Photoreflector ID "	acceleration _ 16r14.		" Accelerometer ID "	button _ 16r15.			" Button sensor ID "	temperature _ 16r18.		" Temperature sensor ID "	setAcceleration _ false.	" Set acceleration sensor flag "	(BoardType = 0 or: [BoardType = 2]) ifTrue: [		sizeAx _ 8.]	ifFalse: [		sizeAx _ 6.].	readoutNames _ OrderedCollection new.	1 to: sizeAx do: [ :index |		sensorID _ IOPort at: (index + offset).		(sensorID = open) ifTrue: [	" Not connected "			readoutNames add:'[A', (index - 1) asString,']',' Not connected'.		].		(sensorID = led) ifTrue: [	" LED "			readoutNames add:'[A', (index - 1) asString,']',' LED'.		].		(sensorID = buzzer) ifTrue: [	" Buzzer "			readoutNames add:'[A', (index - 1) asString,']',' Buzzer'.		].		(sensorID = colorLED) ifTrue: [	" Color LED "			readoutNames add:'[A', (index - 1) asString,']',' Color LED'.		].		(sensorID = light) ifTrue: [	" Light Sensor "			readoutNames add:'[A', (index - 1) asString,']',' Light sensor'.		].		(sensorID = touch) ifTrue: [	" Touch Sensor "			readoutNames add:'[A', (index - 1) asString,']',' Touch sensor'.		].		(sensorID = sound) ifTrue: [	" Sound Sensor "			readoutNames add:'[A', (index - 1) asString,']',' Sound sensor'.		].		(sensorID = infrared) ifTrue: [	" IR Photoreflector "			readoutNames add:'[A', (index - 1) asString,']',' IR Photoreflector'.		].		(sensorID = acceleration) ifTrue: [	" Accelerometer "			(setAcceleration = false) ifTrue: [				readoutNames add:'[A4/A5] Accelerometer (X)'.				readoutNames add:'[A4/A5] Accelerometer (Y)'.				readoutNames add:'[A4/A5] Accelerometer (Z)'.				setAcceleration _ True.			].		].		(sensorID = temperature) ifTrue: [	" Temperature sensor "			readoutNames add:'[A', (index - 1) asString,']',' Temperature sensor'.			listTempBuf at: index put: (TemperatureSensor new).		].		(sensorID = StdnoPIDGyro) ifTrue: [	" Gyro Sensor "			(setGyro = false) ifTrue: [				readoutNames add:'[A4/A5] Gyro sensor (X(Acc))'.				readoutNames add:'[A4/A5] Gyro sensor (Y(Acc))'.				readoutNames add:'[A4/A5] Gyro sensor (Z(Acc))'.				readoutNames add:'[A4/A5] Gyro sensor (X(Gyro))'.				readoutNames add:'[A4/A5] Gyro sensor (Y(Gyro))'.				readoutNames add:'[A4/A5] Gyro sensor (Z(Gyro))'.				setGyro _ True.			].		].		(sensorID = button) ifTrue: [	" Button "			readoutNames add:'[A', (index - 1) asString,']',' Button'.		].	].	column _ AlignmentMorph newColumn		centering: #center;		hResizing: #spaceFill;		vResizing: #shrinkWrap;		color: (Color r: (193/255) g: (196/255) b: (199/255));		borderWidth: 2;		borderColor: (Color r: (148/255) g: (145/255) b: (145/255));		useRoundedCorners;		inset: 3.	titleMorph _ StringMorph		contents: ''		font: (StrikeFont fontName: 'VerdanaBold' size: 10).	column addMorph: titleMorph.	self updateTitle.	column addMorphBack: (Morph new color: column color; extent: 5@3).  "spacer"	self removeAllMorphs.	readouts _ readoutNames collect: [:i |		(((i findString: 'Not connected') ~= 0) | ((i findString: 'LED') ~= 0) | ((i findString: 'Buzzer') ~= 0)) ifTrue: [			kindOfSensor _ false.		] ifFalse: [			kindOfSensor _ true.		].		(i size = 1)			ifTrue:[self addReadoutLabeled: i isSensor: kindOfSensor]			ifFalse:[				tmp _ i findTokens: ' '.				header _ tmp at: 1.				cont _ ''.				2 to: (tmp size) do: [:index |					cont _ cont, (tmp at: index).					(index = tmp size) ifFalse: [cont _ cont, ' '].].				self addReadoutLabeled: (header localized, ' ', cont localized) isSensor: kindOfSensor.]	].	" For Studuino mini "	(BoardType = 1) ifTrue: [		readouts add: (self addReadoutLabeled: 'Onboard LightSensor' localized).		readouts add: (self addReadoutLabeled: 'Battery voltage [V]' localized).		clock _ ColorClock new].	column position: self position - 2.	self addMorph: column.	self extent: column extent - 4.! !!StuduinoSensorBoardMorph methodsFor: 'initialization' stamp: 'KK 10/12/2017 12:06'!clockBuzzer: bz For: time	| mid ival tmp |	mid _ 2.		" 2: Buzzer ID "	(clock isSounding) ifFalse: [		clock startBuzzerFor: time.		" set port and buzzer ON "		ival _ 16r0100.	" b0000 0001 0000 0000 "		tmp _ bz asNumber.		tmp _ tmp - 48.		(tmp > 47) & (tmp < 109) ifTrue: [ tmp _ 0. ].		ival _ ival + tmp.		"Transcript show:'ScriptableScratchMorph:: buzzerPin:freq:'; show: ival;cr."		^ self data:ival msgID:mid.]	ifTrue: [		clock isElapsed ifTrue: [			" set port and buzzer OFF "			ival _ 16r0040.	" b0000 0000 0100 0000 "			^ self data:ival msgID:mid].		].	^ self.! !!StuduinoSensorBoardMorph methodsFor: 'initialization' stamp: 'KK 10/12/2017 12:06'!clockDataSend: data	| msg d1 d2 d3 sendMessage |	msg _ #(0 0 0) asByteArray.	d1 _ ((data bitShift: -12) bitAnd: 16r0F).	d2 _ ((data bitShift: -5) bitAnd: 16r7F).	d3 _ ((data bitShift: 2) bitAnd: 16r7C).	msg at:1 put: (16rE0 + d1).	msg at:2 put: (16r80 + d2).	msg at:3 put: (16r00 + d3).	sendMessage _ String fromBytes: msg.	sendMessage _ 'REQSEND', sendMessage.Transcript show: 'D1: '; show: (msg at:1); cr.Transcript show: 'D2: '; show: (msg at:2); cr.Transcript show: 'D3: '; show: (msg at:3); cr.	socketCommand sendCommand: sendMessage.	socketCommand getResponseShowing: true.   "Waiting ACK"! !!StuduinoSensorBoardMorph methodsFor: 'initialization' stamp: 'KK 10/12/2017 12:07'!clockDataSend: data subID: id	| msg d1 d2 d3 sendMessage |	(BoardType = 0) ifTrue: [		(self portIsOpen) ifFalse: [ ^0. ].]	ifFalse: [		(self socketIsOpen) ifFalse: [^0. ].].	msg _ #(0 0 0) asByteArray.	d1 _ ((data bitShift: -12) bitAnd: 16r0F).	d2 _ ((data bitShift: -5) bitAnd: 16r7F).	d3 _ ((data bitShift: 2) bitAnd: 16r7C).	msg at:1 put: (16rE0 + d1).	msg at:2 put: (16r80 + d2).	msg at:3 put: (16r00 + d3 + id).	sendMessage _ String fromBytes: msg.	sendMessage _ 'REQSEND', sendMessage.Transcript show: 'D1: '; show: (msg at:1); cr.Transcript show: 'D2: '; show: (msg at:2); cr.Transcript show: 'D3: '; show: (msg at:3); cr.	socketCommand sendCommand: sendMessage.	socketCommand getResponseShowing: true.   "Waiting ACK"! !!StuduinoSensorBoardMorph methodsFor: 'initialization' stamp: 'KK 10/12/2017 12:07'!clockOnOff: val	| data |	data _ clock onoff: val.Transcript show: val; cr.	^  self clockDataSend: data subID: 1.! !!StuduinoSensorBoardMorph methodsFor: 'initialization' stamp: 'KK 10/12/2017 12:07'!clockR: rVal G: gVal B: bVal	| data |	data _ clock red: rVal green: gVal blue: bVal.	^  self clockDataSend: data subID: 1.! !!StuduinoSensorBoardMorph methodsFor: 'initialization' stamp: 'KK 10/16/2017 09:44'!initialize	listTempBuf _ Array new: 8.	disconnected _ false.	retrySend _ 3.	timeoutSend _ 50.	resCommand _ 0.	onSyncServo _ false.	lockSend _ Semaphore forMutualExclusion.	lockSync _ Semaphore forMutualExclusion.	super initialize.! !!StuduinoSensorBoardMorph methodsFor: 'initialization' stamp: 'KK 10/12/2017 12:07'!selectPort:  portNum	self stopReadingData.	self openPort: portNum.	self startReadingData.	scanState _ #on.	ResetCounter _ 0.! !!MotorCalibMorph2 methodsFor: 'initialization' stamp: 'KK 2/6/2018 15:50'!addDCReadoutLabeled: aString power: p field: clmn	"Add a readout row with the given label. Answer the stringmorph that's the readout."	| row slider power ratio |	ratio := ScratchTranslator renderScale."	cbRatio := 1.0.	ratio > 1.5 ifTrue: [ cbRatio := ratio - 0.2. ]."	row _ AlignmentMorph newRow		color: clmn color;		inset: 2.	row addMorphBack: (Morph new color: clmn color; extent: 1@3). "spacer"	row addMorphBack: (StringMorph contents: aString capitalized).	row addMorphBack: (Morph new color: clmn color; extent: 15@3). "spacer"	power _ StringMorph contents: p capitalized.	row addMorphBack: power.	slider _ DCSliderMorph2 new.	slider minVal: 0.5; maxVal: 1.0;		setValue: 1.0;		truncate: false;		extent: (128*ratio)@(10*ratio).	slider setPortName: aString.	slider setValue: 255.	row addMorphBack: (Morph new color: row color; extent: 10@3). "spacer"	row addMorphBack: slider.	Sliders add: row.	clmn addMorphBack: row.! !!MotorCalibMorph2 methodsFor: 'initialization' stamp: 'KK 2/5/2018 11:06'!addReadoutLabeled: aString field:clmn	"Add a readout row with the given label. Answer the stringmorph that's the readout."	| row box readout |	row _ AlignmentMorph newRow		color: clmn color;		inset: 2.	row addMorphBack: (Morph new color: clmn color; extent: 1@3). "spacer"	row addMorphBack: (StringMorph contents: aString capitalized font: (StrikeFont fontName: 'VerdanaBold' size: 10)).	row addMorphBack: (AlignmentMorph new color: clmn color; extent: 10@1; hResizing: #spaceFill). "spacer"	box _ NumericUpDownMorph new		extent: 42@14;		color: (ScriptableScratchMorph blockColorFor: 'sensing').	box setDefault: 0 min: -15 max: 15 width: 30 isEdit: false.	Boxes add: box.	" Set the box "	row addMorphBack: box.	row addMorphBack: (StringMorph contents: ('deg.' localized) font: (StrikeFont fontName: 'VerdanaBold' size: 10)).	readout _ StringMorph contents: '0' font: (StrikeFont fontName: 'VerdanaBold' size: 10).	readout color: Color white.	clmn addMorphBack: row.	ServoMotorField add: row.	^ readout! !!MotorCalibMorph2 methodsFor: 'initialization' stamp: 'KK 2/13/2018 13:09'!addReadouts	| buttonRow spacer svCalibMorph svCalibArea title svTitleAndButton button dcCalibArea dcTitleAndButton dcCalibMorph buttonStart buttonStop   buttonOK buttonCancelled |	Boxes _ OrderedCollection new.	Sliders _ OrderedCollection new.	ServoMotorField _ OrderedCollection new.	DCButtons _ OrderedCollection new.	DecisionButtons _ OrderedCollection new.	" Make all alignment column "	column _ AlignmentMorph newColumn		centering: #center;		hResizing: #spaceFill;		vResizing: #shrinkWrap;		color: (Color r: (193/255) g: (196/255) b: (199/255));		borderWidth: 2;		borderColor: (Color r: (148/255) g: (145/255) b: (145/255));		useRoundedCorners;		inset: 3.	" Make title morph and add column and update "	titleMorph _ StringMorph		contents: ''		font: (StrikeFont fontName: 'VerdanaBold' size: 14).	column addMorph: titleMorph.	self updateTitle.	column addMorphBack: (Morph new color: column color; extent: 5@3).  "spacer"	self removeAllMorphs.	" ----------------------------------------------------------------- "	" Make servomotors calibration's morpsh "	" ----------------------------------------------------------------- "	svCalibArea _ AlignmentMorph newColumn	" servormotor area "		centering: #left;		hResizing: #spaceFill;		vResizing: #shrinkWrap;		color: (Color r: (240/255) g: (128/255) b: (128/255));		borderWidth: 1;		borderColor: (Color r: (148/255) g: (145/255) b: (145/255));		useRoundedCorners;		inset: 3.	" --- Title And Button --- "	svTitleAndButton _ AlignmentMorph newRow		color: svCalibArea color.	title _ StringMorph		contents: ('Servomotor' localized)		font: (StrikeFont fontName: 'VerdanaBold' size: 12).	button _ self buttonLabel: 'Reset' localized action: #reset.	" --- Calibration --- "	svCalibMorph _ AlignmentMorph newRow		color: svCalibArea color.	self updateCalib: svCalibMorph.	" --- add to column --- "	column addMorphBack: svCalibArea.	svCalibArea addMorphBack: svTitleAndButton.	svCalibArea addMorphBack: svCalibMorph.	spacer _ (svCalibArea fullBounds corner)			 - (title fullBounds corner)			 - (button fullBounds corner).	spacer setX: ((spacer x)-10) setY:0.	svTitleAndButton addMorphBack: title.	svTitleAndButton addMorphBack: (Morph new extent:spacer).	svTitleAndButton addMorphBack: button.	" ----------------------------------------------------------------- "	"  Spacer "	" ----------------------------------------------------------------- "	column addMorphBack: (Morph new color: column color; extent: 5@5).	" ----------------------------------------------------------------- "	" Make DC motors calibration's morpsh "	" ----------------------------------------------------------------- "	dcCalibArea _ AlignmentMorph newColumn	" DC motor area "		centering: #left;		hResizing: #spaceFill;		vResizing: #shrinkWrap;		color: (Color r: (143/255) g: (188/255) b: (139/255));		borderWidth: 1;		borderColor: (Color r: (148/255) g: (145/255) b: (145/255));		useRoundedCorners;		inset: 3.	" --- Title And Button --- "	dcTitleAndButton _ AlignmentMorph newRow		color: dcCalibArea color.	title _ StringMorph		contents: ('DC motor' localized) 		font: (StrikeFont fontName: 'VerdanaBold' size: 12).	buttonStart _ self buttonLabel: 'Rotate' localized action: #start.	buttonStop _ self buttonLabel: 'Stop' localized action: #stop.	" --- Calibration --- "	dcCalibMorph _ AlignmentMorph newColumn		color: dcCalibArea color.	self updateDCCalib: dcCalibMorph.	column addMorphBack: dcCalibArea.	dcCalibArea addMorphBack: dcTitleAndButton.	dcCalibArea addMorphBack: dcCalibMorph.	spacer _ (svCalibArea fullBounds corner)			 - (title fullBounds corner)			 - (buttonStart fullBounds corner)			 - (buttonStop fullBounds corner).	spacer setX: ((spacer x)-15) setY:0.	dcTitleAndButton addMorphBack: title.	dcTitleAndButton addMorphBack: (Morph new extent:spacer).	dcTitleAndButton addMorphBack: buttonStart.	dcTitleAndButton addMorphBack: (Morph new extent:5@0).	dcTitleAndButton addMorphBack: buttonStop.	DCButtons add: buttonStart.	DCButtons add: buttonStop."	self updateCalib: dcCalibMorph."	" Make button alignment morph and add column and update "	buttonRow _ AlignmentMorph newRow		color: Color transparent;		hResizing: #shrinkWrap;		vResizing: #shrinkWrap;		height: 32.	column addMorphBack: buttonRow.	spacer _ Morph new extent: 10@5; color: Color transparent.	buttonRow removeAllMorphs.	buttonRow addMorphBack: spacer fullCopy.	buttonOK _ (self buttonLabel: 'OK' localized action: #yes).	buttonRow addMorphBack: buttonOK.	buttonRow addMorphBack: spacer fullCopy.	buttonCancelled _  (self buttonLabel: 'Cancel' localized action: #cancelled).	buttonRow addMorphBack: buttonCancelled.	DecisionButtons add: buttonOK.	DecisionButtons add: buttonCancelled.	column position: self position - 2.	self addMorph: column.	self extent: column extent - 4.	dcMotorCalibArea _ dcCalibArea.! !!MotorCalibMorph2 methodsFor: 'initialization' stamp: 'KK 1/30/2018 15:34'!getPortName	" Return port name. "	^ self portNames.! !!MotorCalibMorph2 methodsFor: 'initialization' stamp: 'KK 1/31/2018 10:03'!initialize"	self addReadouts."	super initialize.! !!MotorCalibMorph2 methodsFor: 'initialization' stamp: 'KK 2/7/2018 15:00'!setDCDefaultValue: data	| index def ratio |	index _ 1.	Sliders do: [:sliderInfo |		def _ data at:index.		sliderInfo submorphs do: [ :earch |			(earch isMemberOf: DCSliderMorph2) ifTrue: [				ratio _ def / 100.0.				earch setScaledValue: ratio.	" Set slider position. "				self motorNo: (earch getPortName) displayPower: ratio.			].		].		index _ index + 1.	].! !!MotorCalibMorph2 methodsFor: 'initialization' stamp: 'KK 1/30/2018 15:34'!setDefaultPosition	|  partsID box val dh dm dl |	3 to: 10 do: [ :i |		partsID _ IOPort at:i.		" Get Parts ID "		" Send only servomotor info to board "		(partsID = StdnoPIDServomotor) ifTrue: [			box _ Boxes at: (i-2).			val _ box getValue.			dh _ i - 3.			val _ val + 90.			dm _ (val bitShift: -6) bitAnd: 16r03.			dl _ val bitAnd: 16r3F.			self partsID: 1 high: dh middle: dm low: dl.		].	].! !!MotorCalibMorph2 methodsFor: 'initialization' stamp: 'KK 1/31/2018 10:09'!setDefaultValue: data	| index def |	index _ 1.	Boxes do: [:earch |		def _ data at: index.		earch setDefault: def.	" Set NumericUpDown value. "		index _ index + 1.	].! !!MotorCalibMorph2 methodsFor: 'private' stamp: 'KK 1/30/2018 15:52'!buttonLabel: labelString action: actionSelector	"Answer a new button with the given label and selector. The button target will be me and it will use my button forms."	"(DialogBoxMorph new buttonLabel: 'Yes' action: #beep) openInWorld"	| onForm offForm button overForm |	onForm _ ScratchFrameMorph skinAt: #btnPressed.	offForm _ ScratchFrameMorph skinAt: #btn.	overForm _ ScratchFrameMorph skinAt: #btn.	button _ ResizableToggleButton2 new		offForm: offForm		onForm: onForm		overForm: overForm.	^ button		padding: 20@10;		label: labelString font: (ScratchFrameMorph getFont: #DialogBoxButton);		target: self;		actionSelector: actionSelector;		setLabelColor: (Color gray: 0.15)! !!MotorCalibMorph2 methodsFor: 'private' stamp: 'KK 2/8/2018 14:33'!doNothing	" Do nothing "! !!MotorCalibMorph2 methodsFor: 'private' stamp: 'KK 1/30/2018 15:19'!updateCalib:  morph	"Update servomotor calibration."	|  readoutNames calbCol1 calbCol2 |	calbCol1 _ AlignmentMorph newColumn		centering: #center;		hResizing: #spaceFill;		vResizing: #shrinkWrap;		color: morph color;		borderColor:  morph color;		useRoundedCorners;		inset: 3.	readoutNames _ #(D2 D4 D7 D8).	readouts _ readoutNames collect: [:i |		(i size = 1)			ifTrue:[self addReadoutLabeled: i field: calbCol1]			ifFalse:[self addReadoutLabeled: i localized field: calbCol1]].	morph addMorph: calbCol1.	morph addMorphBack: (AlignmentMorph new color: morph color; extent: 10@1; hResizing: #spaceFill). "spacer"	calbCol2 _ AlignmentMorph newColumn		centering: #center;		hResizing: #spaceFill;		vResizing: #shrinkWrap;		color: morph color;		borderColor:  morph color;		useRoundedCorners;		inset: 3.	readoutNames _ #(D9 D10 D11 D12).	readouts _ readoutNames collect: [:i |		(i size = 1)			ifTrue:[self addReadoutLabeled: i field: calbCol2]			ifFalse:[self addReadoutLabeled: i localized field: calbCol2]].	morph addMorphBack: calbCol2.! !!MotorCalibMorph2 methodsFor: 'private' stamp: 'KK 2/2/2018 09:38'!updateDCCalib:  morph	"Update servomotor calibration."	|  calbCol1 |	calbCol1 _ AlignmentMorph newColumn		centering: #center;		hResizing: #spaceFill;		vResizing: #shrinkWrap;		color: morph color;		borderColor:  morph color;		useRoundedCorners;		inset: 3.	self addDCReadoutLabeled: ('M1' localized) power: ('255' localized) field: calbCol1.	self addDCReadoutLabeled: ('M2' localized) power: ('255' localized) field: calbCol1.	morph addMorph: calbCol1.! !!MotorCalibMorph2 methodsFor: 'private' stamp: 'KK 1/30/2018 15:19'!updateTitle	"Update my title to reflect the current protocol and port number."	| s  |	s _ 'Motor Calibration' localized.	s = titleMorph contents ifFalse: [titleMorph contents: s].! !!MotorCalibMorph2 methodsFor: 'event handling' stamp: 'KK 2/6/2018 13:37'!handlesMouseDown: evt	^ true! !!MotorCalibMorph2 methodsFor: 'event handling' stamp: 'KK 2/6/2018 13:38'!preemptsMouseDown: evt	^ false! !!MotorCalibMorph2 methodsFor: 'accessing' stamp: 'KK 2/8/2018 13:50'!initDCMotorCalibrationField: v	" Set calibration field to valid or invalid."	v ifTrue: [		MotorCalibMorph2 dcCalibStatus: 0.	" STOP status "		self setDCMotorCalibrationField.	] ifFalse: [		MotorCalibMorph2 dcCalibStatus: -1.	" INVALID status "		self setDCMotorCalibrationField.	].! !!MotorCalibMorph2 methodsFor: 'accessing' stamp: 'KK 2/8/2018 14:04'!invalidateSlider: v	v ifTrue: [		Sliders do: [ :slider |			slider submorphs do: [ :elm |				(elm isMemberOf: StringMorph) ifTrue: [					elm color: (Color gray: 0.5).				].				(elm isMemberOf: DCSliderMorph2) ifTrue: [					elm sliderColor: (Color gray: 0.5).				].			].		].	] ifFalse: [		Sliders do: [ :slider |			slider submorphs do: [ :elm |				(elm isMemberOf: StringMorph) ifTrue: [					elm color: (Color black).				].				(elm isMemberOf: DCSliderMorph2) ifTrue: [					elm sliderColor: (Color gray: 0.75).				].			].		].	].! !!MotorCalibMorph2 methodsFor: 'accessing' stamp: 'KK 1/30/2018 15:36'!isSketchActivated: time kind: id	"I receive notify of activation of sketch on Studuino "	| buf pollMSecs msecsSincePoll |	pollMSecs _ Time millisecondClockValue.	" Get current time. "	msecsSincePoll _ 0.	kindOfAck _ 0.	" Initialize result value "	[msecsSincePoll < time] whileTrue:[		msecsSincePoll _ Time millisecondClockValue - pollMSecs.	" Updtate counter. "		" Read buffer and if there is data, return data. "		buf _ port readByteArray.		buf do: [:b | self processScratchByte: b].		(kindOfAck > 0) ifTrue: [			(kindOfAck = id) ifTrue: [				^ true.			]		]	].	" Time over "	^ false.! !!MotorCalibMorph2 methodsFor: 'accessing' stamp: 'KK 2/8/2018 13:02'!motorNo: n calibrationPower: p	"Set Power the DC motor selected"	| mid ival tmp |	"Check argument."	n = '' ifTrue: [^0].	mid _ 0.		" 0: DC Motor ID "	(n = 'M1') ifTrue: [		tmp _ 16r0400.		"b0000 0100 0000 0000"	].	(n = 'M2') ifTrue: [		tmp _ 16r0C00.		"b0000 1100 0000 0000"	].	ival _ (p asNumber).	(ival >= 100)  ifTrue: [ ival _ 100. ].	(ival <= 0)	 ifTrue: [ ival _ 0.   ].	ival _ tmp + (ival rounded).				"b0000 n100 + val "	^self data:ival msgID:mid.! !!MotorCalibMorph2 methodsFor: 'accessing' stamp: 'KK 2/6/2018 15:51'!motorNo: n displayPower: r	| dcInfo |	"Display DC motor's power "	(n = 'M1') ifTrue: [		dcInfo _ Sliders at: 1.	] ifFalse: [		dcInfo _ Sliders at: 2.	].	dcInfo submorphs do: [ :elm |		(elm isMemberOf: StringMorph) ifTrue: [			(elm contents = n) ifFalse: [				elm contents: ((r * 255.0) truncated asString localized).			].		].	].	! !!MotorCalibMorph2 methodsFor: 'accessing' stamp: 'KK 1/31/2018 14:23'!motorNoOff:n	"Set On/Off the DC motor selected"	| mid ival |	"Check argument."	n = '' ifTrue: [^0].	mid _ 0.		" 0: DC Motor ID "	(n = 'M1') ifTrue: [ ival _ 16r0200. ].		"b0000 0010 0000 0000"	(n = 'M2') ifTrue: [ ival _ 16r0A00. ].	"b0000 1010 0000 0000"	ival _ ival + 0.		" break "	^self data:ival msgID:mid.! !!MotorCalibMorph2 methodsFor: 'accessing' stamp: 'KK 1/31/2018 14:20'!motorNoOn:n	"Set On/Off the DC motor selected"	| mid ival |	"Check argument."	n = '' ifTrue: [^0].	mid _ 0.		" 0: DC Motor ID "	(n = 'M1') ifTrue: [ ival _ 16r0100. ].		" b0000 0001 0000 0000 "	(n = 'M2') ifTrue: [ ival _ 16r0900. ].		" b0000 1001 0000 0000 "	ival _ ival + 0.	" ccw "	^self data:ival msgID:mid.! !!MotorCalibMorph2 methodsFor: 'accessing' stamp: 'KK 1/31/2018 18:28'!reflectCalibration: tar degree: car	" Reflect calibration to real servomotor "	| deg offset mid pin ival |	(self portIsOpen) ifFalse: [ ^ self. ].	" Create Angle "	offset _ car asNumber.	deg _ 90 + offset.	(deg >= 180)  ifTrue: [ deg _ 180. ].	(deg <= 0)	 ifTrue: [ deg _ 0.   ].	mid _ 1.		" 1 : Servo Motor ID"	pin _ -1.	((tar owner) submorphs) do: [ :kind |		(kind isMemberOf: StringMorph) ifTrue: [			(kind contents = 'D2') ifTrue: [ pin _ 0 ].			(kind contents = 'D4') ifTrue: [ pin _ 1 ].			(kind contents = 'D7') ifTrue: [ pin _ 2 ].			(kind contents = 'D8') ifTrue: [ pin _ 3 ].			(kind contents = 'D9') ifTrue: [ pin _ 4 ].			(kind contents = 'D10') ifTrue: [ pin _ 5 ].			(kind contents = 'D11') ifTrue: [ pin _ 6 ].			(kind contents = 'D12') ifTrue: [ pin _ 7 ].			(pin ~= -1) ifTrue: [				pin _ (pin bitShift: 9) bitAnd: 16r0E00.				ival _ pin + deg rounded.				^self data: ival msgID: mid.			].		].	].! !!MotorCalibMorph2 methodsFor: 'accessing' stamp: 'KK 2/5/2018 11:10'!setCalibrationField: i valid: v	" Set calibration field to valid or invalid."	| box field |	box _ Boxes at: i.	box setValid: v.	field _ ServoMotorField at: i.	field submorphs do: [ :elm |		(elm isMemberOf: StringMorph) ifTrue: [			v ifTrue: [ elm color: (Color black). ]			ifFalse:   [ elm color: (Color gray: 0.5). ].		].	].! !!MotorCalibMorph2 methodsFor: 'accessing' stamp: 'KK 2/8/2018 14:40'!setDCMotorCalibrationField	| |	" Set calibration field to valid or invalid."	(DCCalibStatus = -1) ifTrue: [	" invalidate "		self invalidateSlider: true.		(DCButtons at: 1) setLabelColor: (Color gray: 0.5); on; toggleButtonMode: true; toggleMode: false.		(DCButtons at: 2) setLabelColor: (Color gray: 0.5); on; toggleButtonMode: true; toggleMode: false.	].	(DCCalibStatus = 0) ifTrue: [	" stop "		self invalidateSlider: true.		(DCButtons at: 1) setLabelColor: (Color black); off; toggleButtonMode: false; toggleMode: true.		(DCButtons at: 2) setLabelColor: (Color gray: 0.5); on; toggleButtonMode: true; toggleMode: false.		(DecisionButtons at: 1) setLabelColor: (Color black);			off;			toggleButtonMode: false;			toggleMode: true.		(DecisionButtons at: 2) setLabelColor: (Color black);			off;			toggleButtonMode: false;			toggleMode: true.	].	(DCCalibStatus = 1) ifTrue: [	" start "		self invalidateSlider: false.		(DCButtons at: 1) setLabelColor: (Color gray: 0.5); on; toggleButtonMode: true; toggleMode: false.		(DCButtons at: 2) setLabelColor: (Color black); off; toggleButtonMode: false; toggleMode: true.		(DecisionButtons at: 1) setLabelColor: (Color gray: 0.5);			on;			toggleButtonMode: true;			toggleMode: false.		(DecisionButtons at: 2) setLabelColor: (Color gray: 0.5);			on;			toggleButtonMode: true;			toggleMode: false.	].! !!MotorCalibMorph2 methodsFor: 'interaction' stamp: 'KK 2/13/2018 09:52'!cancelled	" Only close port "	((DCCalibStatus = 0) | (DCCalibStatus = -1)) ifTrue: [	" if STOP or Invalid status... "		Smalltalk isMacOSX ifFalse: [			self stop.		].		self closePort.		self delete.		ScratchMenuTitleMorph setMenuEnable: true.		DuringCalib _ false.		].! !!MotorCalibMorph2 methodsFor: 'interaction' stamp: 'KK 1/30/2018 15:39'!reset	"Reset calibration"		Boxes do: [ :box |		box numExpression: 0.		box notifyOwner: 0.	].! !!MotorCalibMorph2 methodsFor: 'interaction' stamp: 'KK 2/7/2018 11:50'!saveCalibrationInfo	|  |	"Save calibration value temporary"		BoxesTemp _ OrderedCollection new.	SliderValueTemp _ OrderedCollection new.	Boxes do: [ :elm |		BoxesTemp add: (elm getValue).	].	Sliders do: [ :elm |		(elm submorphs) do: [ :slider |			(slider isMemberOf: DCSliderMorph2) ifTrue: [				SliderValueTemp add: (slider getScaledValue).			].		].	].! !!MotorCalibMorph2 methodsFor: 'interaction' stamp: 'KK 2/8/2018 14:45'!setCalibrationInfo	| index partsID box dcInfo |	"Set saved calibration value"		" Servo motor status "	3 to: 10 do: [ :i |		partsID _ IOPort at:i.		" Get Parts ID "		" Send only servomotor info to board "		(partsID = StdnoPIDServomotor) ifFalse: [			self setCalibrationField:(i-2) valid:false.		].	].	" Set DC motor status "	(((IOPort at: 1) = 0) | ((IOPort at: 2) = 0)) ifTrue: [		" Set Unusable "		self initDCMotorCalibrationField: false.	] ifFalse: [		self initDCMotorCalibrationField: true.	].	index _ 1.	BoxesTemp do: [ :elm |		box _ Boxes at: index.		box setDefault: elm. 		index _ index + 1.	].	index _ 1.	SliderValueTemp do: [ :ratio |		dcInfo _ Sliders at: index.		dcInfo submorphs do: [ :elm |			(elm isMemberOf: DCSliderMorph2) ifTrue: [				elm setScaledValue: ratio.				self motorNo: (elm getPortName) displayPower: ratio.			].		].		index _ index + 1.	].! !!MotorCalibMorph2 methodsFor: 'interaction' stamp: 'KK 2/7/2018 14:16'!setDCCalibration	"Set calibration"		| filename f index val |	Smalltalk isWindows ifTrue: [	" for Windows "		filename := '..\common\dc_calib_ini'.	] ifFalse: [	" for Unix / Mac "		filename := '../common/dc_calib_ini'.	].	f _ FileStream fileNamed: filename.	f binary.	index _ 1.		Sliders do: [ :sliderInfo |		sliderInfo submorphs do: [ :elm |			(elm isMemberOf: DCSliderMorph2) ifTrue: [				val _ (elm getScaledValue * 100) truncated.				DCCalib at: index put: val.				f nextPut: val.			].		].		index _ index + 1.	]."	m1Val _ ((Sliders at:1) getScaledValue * 100) truncated.	m2Val _ ((Sliders at:2) getScaledValue * 100) truncated.	DCCalib at: 1 put: m1Val.	DCCalib at: 2 put: m2Val.	f nextPut: m1Val.	f nextPut: m2Val."	f close.! !!MotorCalibMorph2 methodsFor: 'interaction' stamp: 'KK 1/30/2018 15:41'!setServoCalibration	"Set calibration"		| val filename f each |	Smalltalk isWindows ifTrue: [	" for Windows "		filename := '..\common\sv_offset_ini'.	] ifFalse: [	" for Unix / Mac "		filename := '../common/sv_offset_ini'.	].	f _ FileStream fileNamed: filename.	f binary.	" D9 - D12 "	5 to: 8 do: [:i |		each _ Boxes at: i.		" Get target  "		val _ each getValue.	" Get calibration degree "				SvCalib at:(i-4) put:val.		" Two's complement "		val < 0 ifTrue: [ val _ 256 + val. ].		f nextPut: val.	].	" D2 - D8 "	1 to: 4 do: [:i |		each _ Boxes at: i.		" Get target  "		val _ each getValue.	" Get calibration degree "				SvCalib at:(i+4) put:val.		" Two's complement "		val < 0 ifTrue: [ val _ 256 + val. ].		f nextPut: val.	].	f close.! !!MotorCalibMorph2 methodsFor: 'interaction' stamp: 'KK 2/8/2018 13:54'!start	| m1SliderInfo |	"Start DC motor"		(MotorCalibMorph2 dcCalibStatus = 0) ifTrue: [	" if STOP status... "		MotorCalibMorph2 dcCalibStatus: 1.	" Change START status. "		self setDCMotorCalibrationField.		m1SliderInfo _ Sliders at: 1.		m1SliderInfo submorphs do: [ :slider |			(slider isMemberOf: DCSliderMorph2) ifTrue: [				self motorNo: 'M1' calibrationPower: (slider getScaledValue) * 100.0.			].		].		m1SliderInfo _ Sliders at: 2.		m1SliderInfo submorphs do: [ :slider |			(slider isMemberOf: DCSliderMorph2) ifTrue: [				self motorNo: 'M2' calibrationPower: (slider getScaledValue) * 100.0.			].		].		self motorNoOn: 'M1'.		self motorNoOn: 'M2'.	].! !!MotorCalibMorph2 methodsFor: 'interaction' stamp: 'KK 2/8/2018 13:55'!stop	"Start DC motor"		(MotorCalibMorph2 dcCalibStatus = 1) ifTrue: [	" if START status... "		self motorNoOff: 'M1'.		self motorNoOff: 'M2'.		MotorCalibMorph2 dcCalibStatus: 0.	" change STOP status. "		self setDCMotorCalibrationField.	].! !!MotorCalibMorph2 methodsFor: 'interaction' stamp: 'KK 2/13/2018 09:53'!yes	"Set calibration"		((DCCalibStatus = 0) | (DCCalibStatus = -1)) ifTrue: [	" if STOP and Invalid status... "		Smalltalk isMacOSX ifFalse: [			self stop.		].		self setServoCalibration.		self setDCCalibration.		self closePort.		self delete.		ScratchMenuTitleMorph setMenuEnable: true.		DuringCalib _ false.	].! !!MotorCalibMorph2 methodsFor: 'sensor ops' stamp: 'KK 1/30/2018 15:42'!privateSensor: sensorIndex	"Read the virtual sensor with the given index permuted according to which Scratch board is plugged in and scaled if it is a known special sensor such as the light or sound sensor. If reportRaw is true then the raw sensor value (0..1023) is reported."	"This method does not call processIncomingData. It should only be used by the step method."	| i raw |	"map the sensor index to the corresponding channel"	i _ (sensorIndex asInteger max: 1) min: readouts size."	useGoGoProtocol ifFalse: [		scratchBoardV3			ifTrue: [i _ #(8 6 7 4 5 3 2 1) at: i] 			ifFalse: [i _ #(5 6 7 8 1 2 3 4) at: i]]."	raw _ sensorValues at: i.	reportRaw _ true.	" return Rawdata surely. "	reportRaw ifTrue: [^ raw].	" Following code unexecuted in which "	scratchBoardV3 ifTrue: [		i = 6 ifTrue: [^ self scaleLight: raw].		i = 7 ifTrue: [^ self scaleSound: raw]].	raw > 1020 ifTrue: [raw _ 1023].  "avoids jitter in the range 1021-1023"	^ (100.0 * raw) / 1023.0  ! !!MotorCalibMorph2 methodsFor: 'stepping' stamp: 'KK 1/30/2018 15:44'!step	"Update my title and sensor readouts. If scanning for ports, keep scanning."	| |	self updateTitle.! !!MotorCalibMorph2 methodsFor: 'serial port' stamp: 'KK 1/30/2018 15:45'!closePort	port ifNotNil: [		Smalltalk isMacOSX ifTrue: [			port setOption: 20 to: 0.  "set DTR high"			(Delay forMilliseconds:1)wait.			port setOption: 20 to: 1.  "set DTR high"		] ifFalse: [			self partsID: 7 high:0 middle:0 low:0.		].		port flushInputBuffer.		port close].	port _ nil.! !!MotorCalibMorph2 methodsFor: 'serial port' stamp: 'KK 1/30/2018 15:56'!partsID: id high: dh middle: dm low: dl	"I make message and send it to board."	| msg1 msg2 msg3 msg4 msg |"	Transcript show:'SensroBoardMorph::partsID: high: middle: low:';cr."	(self portIsOpen) ifFalse: [ ^0. ].	msg1 _ id bitOr: 16rC0.	msg2 _ (dh bitAnd: 16r3F) bitOr: 16r80.	msg3 _ (dm bitAnd: 16r3F) bitOr: 16r40.	msg4 _ (dl bitAnd: 16r3F).	msg _ #(0 0 0 0) asByteArray.	msg at: 1 put: msg1.	msg at: 2 put: msg2.	msg at: 3 put: msg3.	msg at: 4 put: msg4."	Transcript 		show:(msg at:1); show:', ';		show:(msg at:2); show:', ';		show:(msg at:3); show:', ';		show:(msg at:4); show:', ';		cr."	port nextPutAll: msg.! !!MotorCalibMorph2 methodsFor: 'serial port' stamp: 'KK 1/30/2018 15:55'!readFromPort	"receive data"	| buf |	buf _ port readByteArray.	port flushInputBuffer.	^ buf.! !!MotorCalibMorph2 methodsFor: 'serial port' stamp: 'KK 1/30/2018 15:55'!readFromPort: time	" receive data with timeout. "	" argument time is msec. "	| buf pollMSecs msecsSincePoll |	pollMSecs _ Time millisecondClockValue.	" Get current time. "	msecsSincePoll _ 0.	[msecsSincePoll < time] whileTrue:[		msecsSincePoll _ Time millisecondClockValue - pollMSecs.	" Updtate counter. "		" Read buffer and if there is data, return data. "		buf _ port readByteArray.		(buf size > 0) ifTrue: [			port flushInputBuffer.			^ buf.		].	].	" Time over "	^ nil.! !!MotorCalibMorph2 class methodsFor: 'accessing' stamp: 'KK 2/8/2018 13:44'!dcCalibStatus	^ DCCalibStatus.! !!MotorCalibMorph2 class methodsFor: 'accessing' stamp: 'KK 2/8/2018 13:44'!dcCalibStatus: s	DCCalibStatus _ s.! !!TemperatureSensor methodsFor: 'private' stamp: 'KK 9/26/2017 14:02'!init	ave _ 0.0.	total _ 0.! !!TemperatureSensor methodsFor: 'accessing' stamp: 'KK 9/26/2017 18:31'!average: v	total _ total + 1.	ave _ ave + ((v - ave) / total).	total > 150 ifTrue: [ total _ 100. ].	^ ((ave * 10) truncated ) / 10.0.! !!TemperatureSensor class methodsFor: 'instance creation' stamp: 'KK 9/26/2017 14:14'!new	"Answer a new instance of SharedQueue that has 10 elements."	^super new init! !!TextMorph methodsFor: 'editing' stamp: 'KK 8/30/2013 19:37'!handleInteraction: interactionBlock fromEvent: evt        | oldEditor oldParagraph |        "Perform the changes in interactionBlock, noting any change in selection"        "Also couple ParagraphEditor to Morphic keyboard events"        self editor sensor: (KeyboardBuffer new startingEvent: evt).        oldEditor _ editor.        oldParagraph _ paragraph.        self selectionChanged.  "Note old selection"                interactionBlock value.        oldParagraph == paragraph ifTrue: [     "this will not work if the paragraph changed"                editor _ oldEditor.     "since it may have been changed while in block"        ].        self selectionChanged.  "Note new selection"! !!ThumbnailCache methodsFor: 'other' stamp: 'KK 7/31/2017 13:19'!filesToUpdate	"Answer a list of image files that need to have their thumbnails updated."	| extensions imageFiles |	extensions _ #(gif jpeg jpg bmp png sprite studuinosprite) asSet.	imageFiles _ directory fileNames select: [:fn |		extensions includes: (FileDirectory extensionFor: fn) asLowercase asSymbol].	^ imageFiles select: [:fn | (dict includesKey: fn) not].! !!ThumbnailCache methodsFor: 'other' stamp: 'KK 7/31/2017 12:10'!updateThumbnails	"Update my dictionary by creating thumbnails for all the image files in my directory. If updates were needed, try to save save the thumbnails cache."	| didRemove fList n thumb buf fSize |	didRemove _ self removeObsoleteEntries.	fList _ self filesToUpdate.	fList size > 0 ifTrue: [		n _ 0.		('Updating thumbnails' localized, ScratchTranslator ellipsesSuffix)			displayProgressAt: Display center			from: 0 to: fList size			during: [:bar |				fList do: [:fn |					bar value: n.					thumb _ nil.					[						buf _ (FileStream readOnlyFileNamed: (directory fullNameFor: fn)) binary contentsOfEntireFile.						((fn asLowercase endsWith: '.sprite') | (fn asLowercase endsWith: '.studuinosprite'))							ifTrue: [thumb _ self thumbnailFromSpriteData: buf]							ifFalse: [thumb _ self thumbnailFromImageData: buf].					] ifError: [].					fSize _ fileSizes at: fn ifAbsent: [0].					thumb ifNotNil: [dict at: fn put: (Array with: fSize with: thumb colorReduced)].					n _ n + 1]]].	(didRemove | (fList size > 0) | (dict size = 0)) ifTrue: [self writeThumbnailFile].! !!ToggleButton methodsFor: 'accessing' stamp: 'KK 12/26/2017 16:49'!offStuduino	| paBoard |	"Turn myself off."	self off.	(owner notNil) ifTrue: [		paBoard _ (self ownerThatIsA: PinAssignMorph).		(paBoard notNil) ifTrue: [			paBoard notifyCheckChange: owner.		].	].! !!ToggleButton methodsFor: 'accessing' stamp: 'KK 12/26/2017 16:49'!onStuduino	| paBoard |	"Turn myself on."	self on.	(owner notNil) ifTrue: [		paBoard _ (self ownerThatIsA: PinAssignMorph).		(paBoard notNil) ifTrue: [			paBoard notifyCheckChange: owner.		].	].! !!ToggleButton methodsFor: 'event handling' stamp: 'sk 8/24/2015 17:00'!handlesMouseOver: evt	^ true! !!ToggleImage methodsFor: 'event handling' stamp: 'KK 11/9/2017 10:51'!mouseDown: evt	"If I am currently turned on, turn myself off and vice versa. If toggleMode is false, then do nothing if I am already on. If isMomentary, then turn myself off immediately. If I am to act when I'm pressed, then send my target my action selector."	^ self.! !!ToggleImage methodsFor: 'event handling' stamp: 'KK 11/9/2017 10:52'!mouseMove: evt	"Give feedback depending on whether the mouse is over me. If I was originally on, show my off image if the mouse is over me and my on image if not. Do the opposite if I was originally off."	^self.! !!WatcherMorph methodsFor: 'initialization' stamp: 'KK 8/9/2017 17:15'!buildReadout	"Build my readout component morphs."	readout _ UpdatingStringMorph new		contents: '';		floatPrecision: 0.1;		stepTime: 100.	readout		font: (ScratchFrameMorph getFont: #Watcher);		forceUnicodeRendering: true;		color: Color white;		kern: 1.	readoutFrame _ WatcherReadoutFrameMorph new addMorph: readout.! !!WatcherMorph methodsFor: 'private' stamp: 'KK 8/30/2013 20:16'!translatedName	"Answer the name for this watcher based on my selector and argument. The names of reporters are translated into the current language. The names of variables are left untouched."	| sel spec result param |	readout target ifNil: [^ 'xxx'].	sel _ readout getSelector.	#getVar: = sel ifTrue: [^ readout parameter].	spec _ readout target blockSpecForSelector: sel.	spec ifNil: [^ sel].	result _ ScratchTranslator translationFor: spec.	param _ readout parameter.	param ifNil: [param _ ''].	#sensor: = sel ifTrue: [		result _ self replace: '%H' with: (ScratchTranslator translationFor: param) in: result].	#sensorPressed: = sel ifTrue: [		result _ self replace: '%h' with: (ScratchTranslator translationFor: param) in: result].	^ result! !!WatcherReadoutFrameMorph methodsFor: 'drawing' stamp: 'KK 12/23/2017 16:01'!fixLayoutForStuduino	| watcher readout isLarge s e readoutWidth yOffset w inset |	((submorphs size = 1) and: [submorphs first isKindOf: StringMorph]) ifFalse: [^ self].	watcher _ self ownerThatIsA: WatcherMorph.	readout _ submorphs first.	isLarge _ watcher ifNil: [false] ifNotNil: [watcher isLarge].	s _ readout contents."	isLarge		ifTrue: [self width: 50]		ifFalse: [self width: 40]."	e _ ScratchTranslator stringExtent: s font: readout font.	readoutWidth _ e x."	(readoutWidth + 10) > self width ifTrue: [self width: readoutWidth + 12].	self width > (readoutWidth + 50) ifTrue: [self width: readoutWidth + 50]."	readout contents: (UTF8 withAll: readout contents).	"set height"	isLarge		ifTrue: [self height: (e y max: 23)]		ifFalse: [self height: (e y max: 14)].	yOffset _ (self height // 2) - (ScratchTranslator centerOffsetForButtonWithFont: readout font) + 1.	(((s indexOf: $.) = (s size - 2)) and: [((s indexOf: $.) = 0) not]) "one digit after the decimal point"		ifTrue: [  "right-justify the string"			w _ (ScratchTranslator stringExtent: (s copyUpTo: $.) font: readout font) x.			inset _ (ScratchTranslator stringExtent: '.0' font: readout font) x.			self isLarge ifTrue: [inset _ inset + 1].			readout position: self topRight - ((w + inset + 5) @ (-1 * yOffset))]		ifFalse: [			readout position: self position + (((self width - readoutWidth)-10) @ yOffset)].	(readout bottom > self bottom) ifTrue: [readout bottom: self bottom].	(readout top < self top) ifTrue: [readout top: self top].	isLarge ifFalse: [		watcher  ifNotNil: [watcher layoutForViewer]].	self layoutChanged.! !MotorCalibMorph2 class removeSelector: #dcMotorEnable!MotorCalibMorph2 class removeSelector: #dcMotorEnable:!MotorCalibMorph2 removeSelector: #addDCReadoutLabeled:field:!MotorCalibMorph2 removeSelector: #isBoardSetup!MotorCalibMorph2 removeSelector: #isScriptable!MotorCalibMorph2 removeSelector: #isSketchActivated!MotorCalibMorph2 removeSelector: #justDroppedInto:event:!MotorCalibMorph2 removeSelector: #justDroppedInto:event:xxx:!MotorCalibMorph2 removeSelector: #mouseDown:!MotorCalibMorph2 removeSelector: #mouseDown:xxx:!MotorCalibMorph2 removeSelector: #mouseHold:!MotorCalibMorph2 removeSelector: #mouseHold:xxx:!MotorCalibMorph2 removeSelector: #selectPort:!MotorCalibMorph2 removeSelector: #setDCCalibrationField:valid:!MotorCalibMorph2 removeSelector: #setDCMotorCalibrationField:!MotorCalibMorph2 removeSelector: #setDCMotorCalibrationField:valid:!DialogBoxMorph subclass: #StringDialog	instanceVariableNames: 'typeinMorph '	classVariableNames: ''	poolDictionaries: ''	category: 'Scratch-UI-Dialogs'!SensorBoardMorph removeSelector: #addSvmFifo:!SensorBoardMorph removeSelector: #pushvmFifo:!ScriptableScratchMorph subclass: #ScratchStageMorph	instanceVariableNames: 'zoom hPan vPan penTrailsForm lastPenPositions runningBlocks inProcessStep sensorBoard servoCalibrationBoard midiPortNum midiPort notePlayerDict obsoleteSavedState sprites scratchServer isQuarterSize cachedForm showMotorBlocks showStuduinoBlocks arduinoBoards arduinoSprites studuinoBoard motorCalibBoard '	classVariableNames: ''	poolDictionaries: ''	category: 'Scratch-Objects'!ScriptableScratchMorph removeSelector: #addList:value:!Morph subclass: #ScriptableScratchMorph	instanceVariableNames: 'objName vars lists blocksBin isClone media costume costumeChangeMSecs filterPack visibility volume tempoBPM sceneStates '	classVariableNames: 'BlockColorDict BlockSpecDict DefaultBackgroundForm DefaultSpriteForm DoubleSize Experimental ListBlockColor MeowSound OldMeowPrefixReversed PopSound RandomGen Recorder ScratchOrigin TimerStartMSecs '	poolDictionaries: ''	category: 'Scratch-Objects'!StringMorph subclass: #ScratchMenuTitleMorph	instanceVariableNames: 'target selector '	classVariableNames: 'MenuBarIsActive MenuEnable '	poolDictionaries: ''	category: 'Scratch-UI-Support'!ScratchFrameMorph initialize!ScratchFrameMorph removeSelector: #autoSaveScratchProject:file:!ScratchFrameMorph removeSelector: #displayErrorMessage:!ScratchFrameMorph removeSelector: #installS4AWorkpane:!ScratchFrameMorph removeSelector: #openScratchProjectS4A!ScratchFrameMorph removeSelector: #readAutosaveProgram!ScratchFrameMorph removeSelector: #saveScratchProjectS4A!Morph subclass: #ScratchFrameMorph	instanceVariableNames: 'topPane viewerPane scriptsPane stageFrame workPane titlePane libraryPane menuPanel stageButtonsPanel readoutPane logoMorph projectTitleMorph flagButton fillScreenFlag paintingInProgress projectDirectory projectName projectInfo author loginName loginPassword watcherPositions shuffledCostumeNames justSaved viewModeButtons viewMode lastViewMode viewModeButtonsPanel toolbarPanel lastWeDoPoll versionConflict keyPad fontButtons usbCSPanel serverProcess usbConnectionStatus paBoard '	classVariableNames: 'BoardStatus COMPort Clipboard DefaultArduinoSprite DefaultNotes DefaultSprite Fonts FontsXO IsXO LangDic NewScratchProject ScratchServers ScratchSkin ScratchSkinXO TakeOverScreen UseErrorCatcher Version VersionDate VisibleDrives WorkpaneExtent '	poolDictionaries: ''	category: 'Scratch-UI-Panes'!ReporterBlockMorph removeSelector: #canBecomeWatcher!ReporterBlockMorph removeSelector: #canBecomeWatcher2!ObjStream removeSelector: #readBPEFileHeader!ObjStream removeSelector: #writeBPEFileHeader!NumericUpDownMorph initialize!NumericUpDownMorph removeSelector: #defaultValue:!NumericUpDownMorph removeSelector: #evaluate!NumericUpDownMorph removeSelector: #handlesKeyboard:!NumericUpDownMorph removeSelector: #handlesMouseDown:!NumericUpDownMorph removeSelector: #handlesMouseOver:!NumericUpDownMorph removeSelector: #initFieldsFrom:version:!NumericUpDownMorph removeSelector: #keyStroke:!NumericUpDownMorph removeSelector: #menuSelector!NumericUpDownMorph removeSelector: #menuSelector:!NumericUpDownMorph removeSelector: #mouseDown:!NumericUpDownMorph removeSelector: #mouseLeave:!NumericUpDownMorph removeSelector: #mouseMove:!NumericUpDownMorph removeSelector: #mouseUp:!NumericUpDownMorph removeSelector: #nitialize!NumericUpDownMorph removeSelector: #setDefault:min:max:!NumericUpDownMorph removeSelector: #specialValue:!NumericUpDownMorph removeSelector: #step!NumericUpDownMorph removeSelector: #stepTime!NumericUpDownMorph removeSelector: #storeFieldsOn:!KeyPadMorph initialize!EventHatMorph removeSelector: #justDroppedInto:event:!EventHatMorph removeSelector: #rightButtonMenu!DividedImageFrameMorph removeSelector: #initFrontFromForm2:topSectionHeight:!DCSliderMorph2 class removeSelector: #enable:!DCSliderMorph2 class removeSelector: #enalbe:!DCSliderMorph2 removeSelector: #setValue:!"Postscript:Leave the line above, and replace the rest of this comment by a useful one.Executable statements should follow this comment, and shouldbe separated by periods, with no exclamation points (!!).Be sure to put any further comments in double-quotes, like this one."" Global Variables "Smalltalk at: #BoardType put: 0.ScratchFrameMorph readSkinFrom:(FileDirectory default directoryNamed: 'ScratchSkin').ScriptableScratchMorph buildBlockSpecDictionary.Smalltalk at: #DuringTest put: false.Smalltalk at: #DuringCalib put: false.Smalltalk at: #SvCalib put: nil.Smalltalk at: #DCCalib put: nil.Smalltalk at: #IOPort put: nil.IOPort ifNil: [	IOPort _ Array new:18.].Smalltalk at: #SvDegree put: nil.Smalltalk at: #SvDegreeTemp put: nil.Smalltalk at: #SvSentAlready put: nil.Smalltalk at: #ServomotorSynchroMotion put: false.Smalltalk at: #ResetCounter put: 0.!