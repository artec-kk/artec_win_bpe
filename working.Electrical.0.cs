'From MIT Squeak 0.9.4 (June 1, 2003) [No updates present.] on 1 December 2017 at 11:04:49 am'!Object subclass: #ColorClock	instanceVariableNames: 'red green blue onoff isSounding buzzerStartTime buzzerDuration '	classVariableNames: ''	poolDictionaries: ''	category: 'Studuino'!Object subclass: #DataCreation	instanceVariableNames: ''	classVariableNames: ''	poolDictionaries: ''	category: 'Studuino'!DataCreation class	instanceVariableNames: ''!Object subclass: #ErrorMessage	instanceVariableNames: ''	classVariableNames: ''	poolDictionaries: ''	category: 'Studuino'!ChoiceArgMorph subclass: #ChoiceArgMorphForStuduino	instanceVariableNames: 'isValid '	classVariableNames: 'FieldWidth '	poolDictionaries: ''	category: 'Scratch-Blocks'!Morph subclass: #ConfigureBoardMorph	instanceVariableNames: 'column titleMorph portName port readouts sensorValues currentState highByte useGoGoProtocol scratchBoardV3 reportRaw scanPorts scanState scanStartMSecs lastPollMSecs '	classVariableNames: ''	poolDictionaries: ''	category: 'Scratch-UI-Panes'!ImageFrameMorph subclass: #DividedImageFrameMorph	instanceVariableNames: 'topSectionHeight middleBarForm leftJointForm rightJointForm leftMargin rightMargin '	classVariableNames: ''	poolDictionaries: ''	category: 'Scratch-UI-Support'!Morph subclass: #I2CAssignMorph	instanceVariableNames: 'column column1 column2 titleMorph calibMorph portName port readouts sensorValues currentState highByte useGoGoProtocol scratchBoardV3 reportRaw scanPorts scanState scanStartMSecs lastPollMSecs motorButtonPAArea sensorPAArea pinInfo buttonTitleMorph servoTitleMorph sensorTitleMorph dcTitleMorph pinAssignTemporary frameMorph i2cPAArea '	classVariableNames: 'Boxes '	poolDictionaries: ''	category: 'Scratch-UI-Panes'!Morph subclass: #KeyPadMorph	instanceVariableNames: 'buttons lastContents targetField '	classVariableNames: 'BaseColor ButtonColor ButtonSize FontColor '	poolDictionaries: ''	category: 'Studuino'!KeyPadMorph class	instanceVariableNames: ''!Object subclass: #NotificationMessage	instanceVariableNames: ''	classVariableNames: ''	poolDictionaries: ''	category: 'Studuino'!ExpressionArgMorph subclass: #NumericUpDownMorph	instanceVariableNames: 'menuMorph getMenuSelector specialValue downMorph valid upMorph minimum maximum upButtonOn downButtonOn buttons '	classVariableNames: 'DownForm UpForm '	poolDictionaries: ''	category: 'Scratch-Blocks'!NumericUpDownMorph class	instanceVariableNames: ''!Morph subclass: #PinAssignMorph	instanceVariableNames: 'column column1 column2 titleMorph calibMorph portName port readouts sensorValues currentState highByte useGoGoProtocol scratchBoardV3 reportRaw scanPorts scanState scanStartMSecs lastPollMSecs motorButtonPAArea sensorPAArea pinInfo buttonTitleMorph servoTitleMorph sensorTitleMorph dcTitleMorph pinAssignTemporary frameMorph i2cBoard selectedBT selectedIR i2cBuff '	classVariableNames: 'BA0Index BA1Index BA2Index BA3Index Boxes SA0Index SA1Index SA2Index SA3Index SA4Index SA5Index SA6Index SA7Index '	poolDictionaries: ''	category: 'Scratch-UI-Panes'!DialogBoxMorph subclass: #ScratchFileChooserDialog	instanceVariableNames: 'scratchFrame list choosingFolder newFileTitle newFileName thumbnailFrameMorph thumbnailMorph authorLabelMorph authorMorph commentLabelMorph commentMorph readingScratchFile type newTitleBin fCursorOut '	classVariableNames: 'LastFolderForType UserHomeFolder '	poolDictionaries: ''	category: 'Scratch-UI-Dialogs'!Morph subclass: #ScratchFrameMorph	instanceVariableNames: 'topPane viewerPane scriptsPane stageFrame workPane titlePane libraryPane menuPanel stageButtonsPanel readoutPane logoMorph projectTitleMorph flagButton fillScreenFlag paintingInProgress projectDirectory projectName projectInfo author loginName loginPassword watcherPositions shuffledCostumeNames justSaved viewModeButtons viewMode lastViewMode viewModeButtonsPanel toolbarPanel lastWeDoPoll paBoard fontButtons versionConflict keyPad '	classVariableNames: 'BoardStatus COMPort Clipboard DefaultNotes DefaultSprite Fonts FontsXO IsXO LangDic NewScratchProject ScratchServers ScratchSkin ScratchSkinXO TakeOverScreen UseErrorCatcher Version VersionDate VisibleDrives WorkpaneExtent '	poolDictionaries: ''	category: 'Scratch-UI-Panes'!StringMorph subclass: #ScratchMenuTitleMorph	instanceVariableNames: 'target selector '	classVariableNames: 'Enable MenuBarIsActive MenuEnable '	poolDictionaries: ''	category: 'Scratch-UI-Support'!Object subclass: #ScratchProcess	instanceVariableNames: 'stackFrame topBlock readyToYield errorFlag readyToTerminate '	classVariableNames: 'BlockHighlightMSecs PrevBlock Times '	poolDictionaries: ''	category: 'Scratch-Execution Engine'!DividedImageFrameMorph subclass: #ScratchScriptEditorMorph	instanceVariableNames: 'thumbnailMorph nameMorph pageViewerMorph rotationButtons lockButton readoutMorphs penReadout currentCategory tabPaneMorph deleteButton '	classVariableNames: ''	poolDictionaries: ''	category: 'Scratch-UI-Panes'!!ScratchScriptEditorMorph commentStamp: '<historical>' prior: 0!I am a viewer for the scripts and media closet of a Scratch object. I have a heading row containing the object name (editable) and a drop-down menu icon. Below that is a scrollable content area.!Morph subclass: #ScriptableScratchMorph	instanceVariableNames: 'objName vars lists blocksBin isClone media costume costumeChangeMSecs filterPack visibility volume tempoBPM sceneStates '	classVariableNames: 'BlockColorDict BlockSpecDict DefaultBackgroundForm DefaultSpriteForm DoubleSize Experimental ListBlockColor MeowSound NumberOfdoRepeat OldMeowPrefixReversed PopSound RandomGen Recorder ScratchOrigin TimerStartMSecs '	poolDictionaries: ''	category: 'Scratch-Objects'!ScriptableScratchMorph subclass: #ScratchStageMorph	instanceVariableNames: 'zoom hPan vPan penTrailsForm lastPenPositions runningBlocks inProcessStep sensorBoard midiPortNum midiPort notePlayerDict obsoleteSavedState sprites scratchServer isQuarterSize cachedForm showMotorBlocks showOptionBlocks servoCalibrationBoard '	classVariableNames: ''	poolDictionaries: ''	category: 'Scratch-Objects'!Morph subclass: #SensorBoardMorph	instanceVariableNames: 'column titleMorph portName port readouts sensorValues currentState highByte useGoGoProtocol scratchBoardV3 reportRaw scanPorts scanState scanStartMSecs lastPollMSecs disconnected processDummySend retrySend resCommand lockSend lockSync socketCommand secondByte timeoutSend listTempBuf clock onSyncServo socket '	classVariableNames: ''	poolDictionaries: ''	category: 'Scratch-UI-Panes'!Morph subclass: #ServoCalibrateMorph	instanceVariableNames: 'column titleMorph portName port readouts sensorValues currentState highByte useGoGoProtocol scratchBoardV3 reportRaw scanPorts scanState scanStartMSecs lastPollMSecs '	classVariableNames: ''	poolDictionaries: ''	category: 'Scratch-UI-Panes'!Object subclass: #SettingMenu	instanceVariableNames: 'diag boxes '	classVariableNames: ''	poolDictionaries: ''	category: 'Studuino'!SettingMenu class	instanceVariableNames: ''!RectangleMorph subclass: #SimpleButtonMorph	instanceVariableNames: 'target actionSelector arguments actWhen oldColor drawToolTipAbove '	classVariableNames: ''	poolDictionaries: ''	category: 'Morphic-Widgets'!DialogBoxMorph subclass: #StringDialog	instanceVariableNames: 'typeinMorph '	classVariableNames: 'ValueOrListName '	poolDictionaries: ''	category: 'Scratch-UI-Dialogs'!StringFieldMorph subclass: #AlphamericFieldMorph	instanceVariableNames: ''	classVariableNames: ''	poolDictionaries: ''	category: 'Scratch-UI-Dialogs'!Object subclass: #TemperatureBuffer	instanceVariableNames: 'buffer currentPos isRounded '	classVariableNames: ''	poolDictionaries: ''	category: 'Studuino'!Object subclass: #TemperatureSensor	instanceVariableNames: 'ave total '	classVariableNames: ''	poolDictionaries: ''	category: 'Studuino'!ToggleButton subclass: #ToggleButtonForStuduino	instanceVariableNames: ''	classVariableNames: ''	poolDictionaries: ''	category: 'Scratch-UI-Support'!ToggleButtonForStuduino class	instanceVariableNames: ''!!Object methodsFor: 'error handling' stamp: 'KK 10/8/2013 19:19'!doesNotUnderstand: aMessage 	 "Error: an attempt was made to send the given message but the receiver does not understand this message. This message is sent by the virtual machine when a message is sent to an object that does not define a method for the message selector."	"Example: 3 width"	(aMessage selector = #flushInputBuffer) ifTrue: [		^ -1.	].	(aMessage selector = #readByteArray) ifTrue: [		^ nil.	]	ifFalse: [		self error: 'Message not understood: ', aMessage selector.		^ aMessage sentTo: self	].! !!ColorClock methodsFor: 'initialization' stamp: 'sk 4/25/2016 14:49'!initialize	"comment stating purpose of message"	red _ 15.	green _ 15.	blue _ 15.	onoff _ 0.	isSounding _ false.! !!ColorClock methodsFor: 'initialization' stamp: 'sk 4/25/2016 18:34'!isElapsed	(buzzerDuration < ((Time millisecondClockValue) - buzzerStartTime)) ifTrue: [		isSounding _ false.		^ true].	^ false! !!ColorClock methodsFor: 'initialization' stamp: 'sk 4/25/2016 15:54'!isSounding	^ isSounding! !!ColorClock methodsFor: 'initialization' stamp: 'sk 4/25/2016 11:54'!onoff: val	"comment stating purpose of message"	onoff _ val.	^ self testModeData! !!ColorClock methodsFor: 'initialization' stamp: 'sk 4/25/2016 11:54'!red: rVal green: gVal blue: bVal	"comment stating purpose of message"	red _ rVal.	green _ gVal.	blue _ bVal.	^ self testModeData! !!ColorClock methodsFor: 'initialization' stamp: 'sk 4/25/2016 14:51'!startBuzzer	"comment stating purpose of message"	isSounding _ true.	buzzerStartTime _ Time millisecondClockValue.! !!ColorClock methodsFor: 'initialization' stamp: 'sk 4/25/2016 18:31'!startBuzzerFor: time	"comment stating purpose of message"	isSounding _ true.	buzzerStartTime _ Time millisecondClockValue.	buzzerDuration _ time * 1000.! !!ColorClock methodsFor: 'initialization' stamp: 'sk 4/25/2016 12:47'!testModeData	"comment stating purpose of message"Transcript show: 'ONOFF: '; show: onoff; cr.	^ (onoff bitShift: 15) + (green bitShift: 8) + (red bitShift: 4)  + blue.! !!CustomMenu methodsFor: 'private' stamp: 'KK 9/14/2013 14:36'!preSelect: action	"Pre-select and highlight the menu item associated with the given action."	| i |	i _ selections indexOf: action ifAbsent: [^ self].	marker ifNil: [self computeForm].	marker _ marker		align: marker topLeft		with: (marker left)@(frame inside top + (marker height * (i - 1))).	selection _ i.! !!DataCreation class methodsFor: 'as yet unclassified' stamp: 'sk 5/17/2017 15:51'!getServoFor: pin degree: aValue	| deg |	deg _ aValue.	(aValue > 180) ifTrue: [deg _ 180].	(aValue < 0) ifTrue: [deg _ 0].	^ (pin bitShift: 9) + deg.! !!DataCreation class methodsFor: 'as yet unclassified' stamp: 'sk 5/17/2017 14:40'!getServoWithOffsetFor: pin degree: aValue	| index offset |	index _ self servoPinToCalibIndex: pin.	offset _ SvCalib at: index.	^ self getServoFor: pin degree: (aValue + offset)! !!DataCreation class methodsFor: 'as yet unclassified' stamp: 'sk 5/17/2017 14:12'!servoPinToCalibIndex: pin	" To change a pin# to a corresponding index of SvCalib.		SvCalib Index  1 2 3 4 5 6 7 8		pinNumber    4 5 6 7 0 1 2 3	"	^ (pin + 4) \\ 8 + 1! !!ErrorMessage class methodsFor: 'private' stamp: 'sk 9/28/2016 17:51'!show: msgID	"Displaying an error message for a given number."	| dialogBox title message errNo |	title _ 'Undifined error number.'.	message _ 'Unknown error.'.	(msgID = 0) ifTrue: [		title _ 'Could not access localhost'.		message _ 'Please save your project and restart this software.'.	].	(msgID = 1) ifTrue: [		title _ 'Could not access to Studuino'.		message _ 'Make sure Studuino is connected to the PC.'.	].	(msgID = 2) ifTrue: [		title _ 'Could not access to Studuino'.		message _ 'Serial port already in use.', String cr,			'Try quiting any programs that may be using it.'.	].	(msgID = 3) ifTrue: [		title _ 'Could not access to Studuino'.		message _ 'Studuino and PC failed to sync.', String cr,			'Save your project, exit this software, ', String cr,			'reset Studuino, and restart this software.'.	].	(msgID = 4) ifTrue: [		title _ 'Could not access to Studuino'.		message _ 'Disconnected.'.	].	(msgID = 5) ifTrue: [		title _ 'System error'.		message _ 'System file is corrupted.', String cr,			'Save your project, exit this software, ', String cr,			'reinstall Studuino programming environment.'.	].	(msgID = 6) ifTrue: [		title _ 'Could not access to Studuino'.		message _ 'COM port error.'.	].	(msgID = 7) ifTrue: [		title _ 'Build error'.		message _ 'Main function is not defined.'.	].	(msgID = 8) ifTrue: [		title _ 'Build error'.		message _ 'Script too big.'.	].	(msgID = 9) ifTrue: [		title _ 'Build error'.		message _ 'An error has occurred in the archiving process. Please re-install.'.	].	(msgID = 10) ifTrue: [		title _ 'Build error'.		message _ 'An error has occurred in the object copy1 process. Please re-install.'.	].	(msgID = 11) ifTrue: [		title _ 'Build error'.		message _ 'An error has occurred in the object copy2 process. Please re-install.'.	].	(msgID > 16) & (msgID < 24) ifTrue: [		errNo _ msgID bitAnd: 7.		"Mask error category"		title _ 'Build error'.		message _ nil.		(errNo bitAnd: 16r01) = 1 ifTrue: [			message isNil ifTrue: [				message _ 'Undefined function.']			ifFalse: [				message _ message, String cr, 'Undefined function.']].		((errNo bitShift: -1) bitAnd: 16r01) = 1 ifTrue: [			message isNil ifTrue: [				message _ 'Multiple functions with same name.']			ifFalse: [				message _ message, String cr, 'Multiple functions with same name.']].		((errNo bitShift: -2) bitAnd: 16r01) = 1 ifTrue: [			message isNil ifTrue: [				message _ 'Unknown error.']			ifFalse: [				message _ message, String cr, 'Unknown error.']]].	(msgID = 100) ifTrue: [		title _ 'Transfer failed'.		message _ 'Failed to transfer a program. Please retry.'].	(msgID = 101) ifTrue: [		title _ 'Time out error.'.		message _ 'Operation timed out.'].	(msgID = 200) ifTrue: [		title _ 'This script may not be able to properly open.'.		message _ 'Script you are trying to open is not compartible to current project.'].	(msgID = 201) ifTrue: [		title _ 'This script may not be able to properly open.'.		message _ 'Script you are trying to open might be ', String cr,			'using a block that can not be displayed ', String cr,			'in this programming environment. ', String cr,			'It is recommended that you update ', String cr,			'the programming environment ', String cr,			'to the latest version.'].	dialogBox _ DialogBoxMorph new.	dialogBox withButtonsForYes: false no: false okay: true cancel: false.	dialogBox title: title.	dialogBox message: message.	dialogBox openInWorld.		" Display Dialogbox "	dialogBox centerOnScreen.	" Set center position "	dialogBox world doOneCycle.! !!Morph methodsFor: 'initialization' stamp: 'KK 1/11/2013 14:01'!initialize	bounds _ 0@0 corner: 50@40.	owner _ nil.	submorphs _ Array empty.	fullBounds _ nil.	color _ Color blue.	flags _ 0.	properties _ nil.! !!BlockMorph methodsFor: 'accessing' stamp: 'KK 8/20/2014 11:51'!closestAttachTargetIn: newOwner	"Answer the closest block attachment point among the blocks and stack submorphs of the given morph. Answer nil if there are no blocks close enough to attach myself to."	| xThresh yThresh attachPoints best bestDist targetP dist ref topUsed bottomUsed target targetOwner connectionY |	xThresh _ 65.	((self isKindOf: CBlockMorph) and: [(self nestedBlockAt: (self top + self topBarHeight)) isNil])		ifTrue: [yThresh _ 25]		ifFalse: [yThresh _ 14].	topUsed _ false.	bottomUsed _ false.	attachPoints _ OrderedCollection new:100.	newOwner submorphsDo: [:m |		((m ~~ self) and:		 [(m ~~ (self bottomBlock)) and:		 [(m ~~ (self topBlock)) and:		 [(m ~~ (self owner)) and:		 [(m isKindOf: BlockMorph) and:		 [m isReporter not]]]]]) ifTrue: [			m blockAttachPoints: attachPoints]].	((self isKindOf: HatBlockMorph) or: [(self ownerThatIsA: HatBlockMorph) ~= nil]) ifTrue: [		"if I am a HatBlock or the bottom block of a HatBlock stack, I can only attach to the top block of a stack"		attachPoints _ attachPoints select: [:assoc |			(assoc value owner = newOwner) and:			[assoc key y = assoc value top]]].	(self isStop or:[self bottomBlock isStop]) ifTrue: [		"I am a stop block; I can't attach to the top of a stack"		attachPoints _ attachPoints select: [:assoc |			assoc key y ~= assoc value top]].	(self topBlock isForever not and: [self bottomBlock isForever]) ifTrue: [		"My bottom block is a forever; I can't attach to the top of a stack"		attachPoints _ attachPoints select: [:assoc |			assoc key y ~= assoc value top]].	best _ nil.	bestDist _ 10000.	attachPoints do: [:assoc |		targetP _ assoc key.		ScratchTranslator isRTL			ifTrue: [ref _ self right]			ifFalse: [ref _ self left].		((ref - targetP x) abs < xThresh)			ifTrue: [				(((self top - targetP y) abs < yThresh) or: [self nextBlock isNil and: [(self bottom - targetP y) abs < yThresh]])					ifTrue: [  "targetP is within sticking range"						ScratchTranslator isRTL							ifTrue: [dist _ (self topRight - targetP) r]							ifFalse: [dist _ (self position - targetP) r].						dist < bestDist ifTrue: [							((self top - targetP y) abs < yThresh) ifTrue: [topUsed _ true. bottomUsed _ false].							(self nextBlock isNil and: [(self bottom - targetP y) abs < yThresh]) ifTrue: [topUsed _ false. bottomUsed _ true].							best _ assoc.							bestDist _ dist]]]].	"special case for the servomotor blocks"	(self isKindOf: CommandBlockMorph) ifTrue: [	best ifNotNil: [		(self selector = #motorNo:degree:) ifTrue: [		" Top block is servomotor block "			(self isOnlyServo: self) ifFalse: [				" include other blocks. "				target _ best value.				(target isKindOf: CommandBlockMorph) ifTrue: [					(target selector = #motorNo:degree:) ifTrue: [					" Target block is servomotor block "						(targetOwner _ target ownerThatIsA: CBlockMorph) ifNotNil: [							((targetOwner selector = #doSvmSyncMotion) | (targetOwner selector = #doSvmSyncMotion2)) ifTrue: [	" included synchro-servo block "								(target position x = targetOwner position x) ifFalse: [									best _ nil.				" DnD invalid. "								].							].						].					].					((target selector = #doSvmSyncMotion) | (target selector = #doSvmSyncMotion2)) ifTrue: [						connectionY _ best key y.						((connectionY ~= target top) & (connectionY ~= target bottom)) ifTrue: [							best _ nil.				" DnD invalid. "						].					].				].			].		]		ifFalse: [										" Top block is not servomotor block "			target _ best value.			(target isKindOf: CommandBlockMorph) ifTrue: [				(target selector = #motorNo:degree:) ifTrue: [					" Target block is servomotor block "					(targetOwner _ target ownerThatIsA: CBlockMorph) ifNotNil: [						((targetOwner selector = #doSvmSyncMotion)  | (targetOwner selector = #doSvmSyncMotion2)) ifTrue: [	" included synchro-servo block "							(target position x = targetOwner position x) ifFalse: [								best _ nil.				" DnD invalid. "							].						].					].				].				((target selector = #doSvmSyncMotion) | (target selector = #doSvmSyncMotion2)) ifTrue: [					connectionY _ best key y.					((connectionY ~= target top) & (connectionY ~= target bottom)) ifTrue: [						best _ nil.				" DnD invalid. "					].				].			].		].	]].	"special case for the auto-wrapping of c-shaped/if-else blocks"	(self isKindOf: CBlockMorph) ifTrue: [	best ifNotNil: [		bottomUsed ifTrue: [				(best value owner isKindOf: BlockMorph) ifTrue: [				self stretchHeight: 0. ^ best _ nil]].		(self isStopOrForever or:[self bottomBlock isStopOrForever]) ifTrue: [			bottomUsed ifTrue: [					self stretchHeight: 0.					^ best _ nil]].		((best key y = best value top) and: [((self isForever or:[self bottomBlock isForever])) and: [(self nestedBlockAt: (best key y)) isNil not]])					ifTrue: [self stretchHeight: 0. ^ best _ nil].		(self nestedBlockAt: (best key y)) ifNil: [			bottomUsed ifTrue: [					self stretchHeight: 0.					(best key y = best value bottom) ifTrue: [^ best _ nil].					((best key y = best value top) and: [(best value owner isKindOf: BlockMorph)]) ifTrue: [^ best _ nil].					((best key y = best value bottom) and: [(best value owner isKindOf: BlockMorph) not]) ifTrue: [^ best _ nil]].			topUsed ifTrue: [				((best key y = best value bottom) and: [best value nextBlock isNil not]) ifTrue: [self stretchHeight: 0. ^ best _ nil].				"((best key y = best value top) and: [(best value owner isKindOf: BlockMorph)]) ifTrue: [self stretchHeight: 0. ^ best _ nil]."				(best key y = best value top) ifTrue: [					" If I am synchro motion morph... "					((self selector = #doSvmSyncMotion) | (self selector = #doSvmSyncMotion2)) ifTrue: [						(best value selector = #motorNo:degree:) ifFalse: [	" The bounded morph is not servomotor block. "							^ best _ nil.						]						ifTrue: [	" The bounded morph is servomotor block "							(best value isOnlyServo: best value) ifFalse: [	" with other block "								^ best _ nil.							]						].					].					self stretchHeight: best value fullBounds height - 17. ^ best				]			].			self stretchHeight: 0]].	best ifNil: [		self stretchHeight: 0]].	 ^ best! !!BlockMorph methodsFor: 'drawing' stamp: 'KK 8/29/2013 15:41'!drawOn: aCanvas 	| c |	self computeHighlightColors.	c _ FormCanvas extent: self extent depth: 32.	c _ c copyOffset: self topLeft negated.	self isReporter ifTrue: [		self drawSmoothTopEdgeOn: c.		self drawReporterBodyOn: c.		self drawSmoothBottomEdgeOn: c.		^ self].	self isStop ifTrue: [		self drawTopEdgeOn: c.		self drawStopBodyOn: c.		self drawSmoothBottomEdgeOn: c.		self drawFinalOn: aCanvas fromCanvas: c.		^ self].	self drawTopEdgeOn: c.	self drawBodyOn: c.	self drawBottomEdgeOn: c.	self drawFinalOn: aCanvas fromCanvas: c.! !!BlockMorph methodsFor: 'dropping/grabbing' stamp: 'KK 4/30/2014 10:57'!justDroppedInto: newOwner event: evt	"Handle being dropped into a new situation."	| frame targetAssoc targetP targetBlock bottomBlockUsed upperBlock |	bottomBlockUsed _ false.	(frame _ newOwner ownerThatIsA: ScratchFrameMorph)		ifNotNil: [frame projectModified].	((self ownerThatIsA: ScratchViewerMorph) notNil) ifTrue: [		"delete myself when dropped in the blocks palette area"		self delete.		self receiver blocksBin changed.		^ self].	"blocks cannot be dropped onto the stage"	(owner isKindOf: ScratchStageMorph) ifTrue: [		^ self rejectDropEvent: evt].	"okay to drop blocks into the world during development"	((owner == World) and: [Preferences noviceMode not]) ifTrue: [^ self].	((owner isKindOf: ScratchScriptsMorph) or:	 [(owner isKindOf: BlockMorph) or:	 [(owner isKindOf: ScratchStageMorph) and: [self isReporter]]]) ifFalse: [		^ self rejectDropEvent: evt].	self isReporter ifTrue: [^ self handleReporterDrop].	targetAssoc _ self closestAttachTargetIn: newOwner.	targetAssoc ifNil: [		(self bottomBlock isKindOf: CBlockMorph) ifFalse: [			targetAssoc _ self bottomBlock closestAttachTargetIn: newOwner.			targetAssoc ifNotNil:[				bottomBlockUsed _ true.				(targetAssoc value owner isKindOf: BlockMorph) ifTrue:[					targetAssoc _ nil]]]].	targetAssoc ifNil: [^ self].	"make sure no processes are running"	self = self topBlock ifTrue: [self stop].	targetP _ targetAssoc key.	targetBlock _ targetAssoc value.	targetP y = targetBlock top		ifTrue: [			"c-shaped block should nest the target block"			"((bottomBlockUsed not) and: [((targetBlock owner isKindOf: BlockMorph) not) and: [(self isKindOf: CBlockMorph)]]) ifTrue:["			((bottomBlockUsed not) and: [(self isKindOf: CBlockMorph)]) ifTrue:[				(targetBlock owner isKindOf: BlockMorph)					ifTrue: [(targetBlock owner) attachBlock: self]					ifFalse: [self position: (targetP x - self bracketThickness)@(targetP y - self topBarHeight - 3)].				self attachBlockNested: targetBlock. ^ self].			"for all other non-c-shaped blocks"			(bottomBlockUsed or:[((targetBlock owner isKindOf: BlockMorph) not) and: [(self isKindOf: CBlockMorph) not]]) ifTrue:[				ScratchTranslator isRTL					ifTrue: [self bottomBlock position: (targetP x - self bottomBlock width) @ (targetP y - (self bottomBlock height - 4))]					ifFalse: [self bottomBlock position: targetP x @ (targetP y - (self bottomBlock height - 4))].				upperBlock _ self bottomBlock owner.				[upperBlock isKindOf: BlockMorph] whileTrue: [					upperBlock nextBlock ifNotNil:[						ScratchTranslator isRTL							ifTrue: [upperBlock position: (targetP x - upperBlock width) @ (upperBlock nextBlock position y - (upperBlock height - 4))]							ifFalse: [upperBlock position: targetP x @ (upperBlock nextBlock position y - (upperBlock height - 4))].						upperBlock _ upperBlock owner]]].			((bottomBlockUsed not) and: [targetBlock owner isKindOf: BlockMorph]) ifTrue:[				ScratchTranslator isRTL					ifTrue: [self position: (targetP x - self width) @ (targetP y - (self height - 4))]					ifFalse: [self position: targetP x @ (targetP y - (self height - 4))]].			(targetBlock owner isKindOf: BlockMorph) ifTrue:[				ScratchTranslator isRTL					ifTrue: [self topBlock position: (targetP x - self topBlock width) @ targetP y]					ifFalse: [self topBlock position: targetP x @ targetP y].				targetBlock owner attachBlock: self topBlock].			ScratchTranslator isRTL				ifTrue: [targetBlock position: (targetP x - targetBlock width) @ (self bottomBlock position y + self bottomBlock height + 4)]				ifFalse: [targetBlock position: targetP x @ (self bottomBlock position y + self bottomBlock height + 4)].			((bottomBlockUsed not) and: [((targetBlock owner isKindOf: BlockMorph) not) and: [(self isKindOf: CBlockMorph)]]) ifFalse:[				self bottomBlock attachBlock: targetBlock]]		ifFalse: [			self assert: [(self isKindOf: HatBlockMorph) not].  "I am not a HatBlockMorph"			ScratchTranslator isRTL				ifTrue: [self position: (targetP - (self width @0))]				ifFalse: [self position: targetP].			targetBlock attachBlock: self].! !!BlockMorph methodsFor: 'event handling' stamp: 'sk 3/15/2017 13:13'!mouseDown: evt	"Handle a mouse click. Left button either drags or performs click action. Right button brings up a menu."	evt hand newKeyboardFocus: nil.	evt rightButtonPressed		ifTrue: [^ self rightButtonMenu]		ifFalse:	[evt hand waitForClicksOrDrag: self event: evt].! !!BlockMorph methodsFor: 'event handling' stamp: 'KK 10/9/2013 11:17'!rightButtonMenu	| menu |	menu _ CustomMenu new."	menu add: 'help' action: #presentHelpScreen."	(owner isKindOf: ScratchBlockPaletteMorph) ifFalse: [		menu addLine.		menu add: 'duplicate' action: #duplicate.			(self owner isKindOf: BlockMorph) ifFalse: [  "we can't yet delete a blocks inside a script"			menu add: 'delete' action: #delete]].	DebugMenu ifTrue: [		menu addLine.		menu add: 'show tuples' action: #showTuples].		menu localize; invokeOn: self.! !!BlockMorph methodsFor: 'event handling' stamp: 'KK 9/19/2017 20:08'!startDrag: evt	"ArTeC: If owner is ScratchBlockPaletteMorph then I check IOPort Array and decide DragNDrop. "	| startEvt rootForGrab partsID |	(owner isKindOf: ScratchBlockPaletteMorph) ifTrue:[		(self isKindOf: EventHatMorph) ifFalse: [			(self color = (Color r: 0.6 g: 0.6 b: 0.6)) ifTrue: [^ self.].			((self selector = 'motorNo:degree:') | 			 (self selector = 'motorNo:power:') | 			 (self selector = 'motorNo:dcMotorOn:') |			 (self selector = 'motorNo:dcMotorOff:') |			 (self selector = 'buzzerPin:freq:') |			 (self selector = 'buzzerPin:') |			 (self selector = 'ledPin:onOff:') |		 	 (self selector = 'lightSensor:') |		 	 (self selector = 'touchSensor:') |		 	 (self selector = 'soundSensor:') |		 	 (self selector = 'refPhotosensor:') |		 	 (self selector = 'accelerometer:') |		 	 (self selector = 'onBoardButton:')) ifTrue: [				self submorphs do: [ :sub |					(sub isKindOf: ChoiceArgMorph) ifTrue: [						sub choice = '' ifTrue: [							^ self.						]					]				]			].			(self selector = 'ledColor:onOff:') ifTrue: [				partsID _ 16r05.			" 01:DC 02:SV 03:LED 04:BZR 05:CLED 10:LS 11:TS 12:SS 13:IRS 14:3S 15:BTN"				" If colorLED connect with board, IOPort No.12 is sure to set colorLED ID(0x05)"				((IOPort at: 12) ~= partsID) ifTrue: [					^ self.				]			]		]	].	evt hand toolType ifNil: [		startEvt _ evt hand firstClickEvent.		startEvt ifNil: [startEvt _ evt].		rootForGrab _ self rootForGrabOf: self.		rootForGrab ifNil: [^ self].		evt hand grabMorph: rootForGrab.		rootForGrab position: evt hand position + (rootForGrab topLeft - startEvt cursorPoint)].	self handleTool: evt hand toolType hand: evt hand.! !!BlockMorph methodsFor: 'private' stamp: 'KK 8/2/2013 13:05'!printArduCodeOn: aStream indent: indent	"Append a human-readable string for this block on the given stream."	indent timesRepeat: [aStream nextPutAll: '    '].	aStream nextPutAll: self class name; cr.	self nextBlock ifNotNil: [self nextBlock printArduCodeOn: aStream indent: indent].! !!BlockMorph methodsFor: 'private' stamp: 'KK 9/20/2017 16:41'!printArduCodeSubmorph: aMorph on: aStream	(aMorph isKindOf: ArgMorph) ifTrue: [aMorph printArgOn: aStream].	(aMorph isKindOf: BlockMorph) ifTrue: [		aMorph printArduCodeOn: aStream indent: 0.		aStream skip: -1.  "remove carriage return"		].	(aMorph isKindOf: StringMorph) ifTrue: [		((self selector = 'motorNo:degree:') & ServomotorSynchroMotion) ifTrue: ["			Transcript show:aMorph contents;cr."			(aMorph contents = ', SVRANGE(') ifTrue: [				aStream					nextPutAll: 'degree[';					nextPutAll: ((ServomotorNumber-1) asString);					nextPutAll: '] = ';					nextPutAll: 'SVRANGE('.			].			(aMorph contents = '));') ifTrue: [				aStream					nextPutAll: ');'.			].			^ ''		].		(self selector = 'sensors:') ifTrue: [			^ ''		].		((aMorph contents = '?')) " | (aMorph contents = '%'))"			ifTrue: [aStream skip: -1].	"remove space before ? or %"		(aMorph contents = 'else') ifTrue: [ ^ ''].		aStream nextPutAll: aMorph contents.].! !!BlockMorph methodsFor: 'private' stamp: 'KK 1/14/2015 17:56'!printCodeSubmorph: aMorph on: aStream	(aMorph isKindOf: ArgMorph) ifTrue: [aMorph printArgOn: aStream].	(aMorph isKindOf: BlockMorph) ifTrue: [		aStream nextPut: $(.		aMorph printCodeOn: aStream indent: 0.		aStream skip: -1.  "remove carriage return"		aStream nextPut: $)].	(aMorph isKindOf: StringMorph) ifTrue: [		((aMorph contents = '?') | (aMorph contents = '%'))			ifTrue: [aStream skip: -1].	"remove space before ? or %"		aStream nextPutAll: aMorph contents].! !!BorderedMorph methodsFor: 'drawing' stamp: 'KK 4/25/2014 12:59'!drawOn: aCanvas 	"Draw a rectangle with a solid, inset, or raised border.	Note: the raised border color is generated from the receiver's own color,	while the inset border color is generated from the color of its owner.	This behavior is visually more consistent. Thanks to Hans-Martin Mosner."	| insetColor |	borderWidth = 0 ifTrue: [  "no border"		"Note: This is the hook for border styles.			When converting to the new borders we'll just put 0 into the borderWidth"		super drawOn: aCanvas.		^ self].	borderColor == #raised ifTrue: [		"Use a hack for now"		aCanvas fillRectangle: self bounds color: color.		^ aCanvas frameAndFillRectangle: bounds			fillColor: Color transparent			borderWidth: borderWidth			topLeftColor: (borderWidth = 1 ifTrue: [color twiceLighter]										ifFalse: [color lighter])			bottomRightColor: (borderWidth = 1 ifTrue: [color twiceDarker]										ifFalse: [color darker])].	borderColor == #inset ifTrue: [		insetColor _ owner colorForInsets.		aCanvas fillRectangle: self bounds color: color.		^ aCanvas frameAndFillRectangle: bounds			fillColor: Color transparent			borderWidth: borderWidth			topLeftColor: (borderWidth = 1 ifTrue: [insetColor twiceDarker]										ifFalse: [insetColor darker])			bottomRightColor: (borderWidth = 1 ifTrue: [insetColor twiceLighter]										ifFalse: [insetColor lighter])].	"solid color border"	aCanvas fillRectangle: (self bounds insetBy: borderWidth) color: color.	aCanvas frameAndFillRectangle: bounds		fillColor: Color transparent		borderWidth: borderWidth		borderColor: borderColor.! !!ArgMorph methodsFor: 'other' stamp: 'KK 5/1/2014 15:14'!labelMorph	^ labelMorph! !!ArgMorph methodsFor: 'other' stamp: 'KK 8/2/2013 12:58'!printArduArgOn: aStream	"Print this argument morph on the given stream."	| v |	self labelMorph ifNotNil: [		v _ self evaluate.		(v isKindOf: String)			ifTrue: [aStream nextPutAll: '"', v, '"']			ifFalse: [aStream nextPutAll: v asString]].! !!ArgMorph methodsFor: 'other' stamp: 'KK 7/7/2014 10:16'!printArgOn: aStream	"Print this argument morph on the given stream."	| v |	self labelMorph ifNotNil: [		v _ self evaluate.		((owner selector = 'motorNo:degree:') & ServomotorSynchroMotion) ifTrue: [			aStream				nextPutAll: (v asString).		]		ifFalse: [			(v isKindOf: String)				ifTrue: [aStream nextPutAll: v ]				ifFalse: [aStream nextPutAll: v asString]		].	].! !!BooleanArgMorph methodsFor: 'other' stamp: 'KK 8/2/2013 12:58'!printArduArgOn: aStream	"Print this argument morph on the given stream."	aStream nextPutAll: 'false'.! !!ChoiceArgMorph methodsFor: 'event handling' stamp: 'sk 9/21/2016 19:25'!handlesMouseDown: evt	^ evt hand toolType isNil and:		[(self topLeft corner: self bottomRight) containsPoint: evt cursorPoint]! !!ChoiceArgMorph methodsFor: 'other' stamp: 'KK 8/2/2013 12:58'!printArduArgOn: aStream	"Print this argument morph on the given stream."	aStream nextPutAll: '"', self labelMorph contents, '"'.! !!ChoiceArgMorph methodsFor: 'other' stamp: 'KK 9/21/2017 17:36'!printArgOn: aStream	| arg id offset pnum |	"Print this argument morph on the given stream."	arg _ self labelMorph contents.	((owner selector = 'motorNo:degree:') & (ServomotorSynchroMotion)) ifTrue: [		aStream			nextPutAll: 'port[';			nextPutAll: ((ServomotorNumber-1) asString);			nextPutAll: '] = PORT_';			nextPutAll: (arg asString);			nextPutAll: ';';			nextPutAll: String tab.		^ self.	].	" For science version. "	(owner selector = 'sensors:') ifTrue: [		offset _ 10.	" offset for IOPort index. "		pnum _ arg at: 2.	" port num "		id _ IOPort at: ((pnum digitValue) + offset + 1).		"  "		(id = 16r10) ifTrue: [			aStream				nextPutAll: 'LIGHT_SENSOR(PORT_';				nextPutAll: arg;				nextPutAll: ')'.		].		(id = 16r13) ifTrue: [			aStream				nextPutAll: 'IRPHOTOREFLECTOR(PORT_';				nextPutAll: arg;				nextPutAll: ')'.		].		(id = 16r18) ifTrue: [			aStream				nextPutAll: ' TEMPERATURE_SENSOR(PORT_';				nextPutAll: arg;				nextPutAll: ') '.		].		^ self.	].	((owner selector ~= 'setVar:to:') & (owner selector ~= 'changeVar:by:') &	 (owner selector ~= 'append:toList:') & (owner selector ~= 'deleteLine:ofList:') &	 (owner selector ~= 'insert:at:ofList:') & (owner selector ~= 'setLine:ofList:to:') &	 (owner selector ~= 'getLine:ofList:') & (owner selector ~= 'lineCountOfList:') &	 (owner selector ~= 'list:contains:'))	 ifTrue: [		((arg = 'abs') | (arg = 'sqrt') | (arg = 'sin') | (arg = 'cos') | (arg = 'tan') |		 (arg = 'asin') | (arg = 'acos') | (arg = 'atan') | (arg = 'ln') | (arg = 'log'))		ifTrue: [ arg _ arg asUppercase. ].		(arg = 'e ^') ifTrue:[ arg _ 'POWE'. ].		(arg = '10 ^') ifTrue: [ arg _ 'POW10'. ].		((arg = 'on') | (arg = 'off'))		ifTrue: [ arg _ arg asUppercase. ]."		(arg = 'D0') ifTrue:[ arg _ 'DIG0' ].		(arg = 'D1') ifTrue:[ arg _ 'DIG1' ].		(arg = 'D2') ifTrue:[ arg _ 'DIG2' ].		(arg = 'D3') ifTrue:[ arg _ 'DIG3' ].		(arg = 'D4') ifTrue:[ arg _ 'DIG4' ].		(arg = 'D5') ifTrue:[ arg _ 'DIG5' ].		(arg = 'D6') ifTrue:[ arg _ 'DIG6' ].		(arg = 'D7') ifTrue:[ arg _ 'DIG7' ].		(arg = 'D8') ifTrue:[ arg _ 'DIG8' ].		(arg = 'D9') ifTrue:[ arg _ 'DIG9' ].		(arg = 'D10') ifTrue:[ arg _ 'DIG10' ].		(arg = 'D11') ifTrue:[ arg _ 'DIG11' ].		(arg = 'D12') ifTrue:[ arg _ 'DIG12' ].		(arg = 'D13') ifTrue:[ arg _ 'DIG13' ].		(arg = 'D14') ifTrue:[ arg _ 'DIG14' ].		(arg = 'D15') ifTrue:[ arg _ 'DIG15' ].		(arg = 'D16') ifTrue:[ arg _ 'DIG16' ].		(arg = 'D17') ifTrue:[ arg _ 'DIG17' ].		(arg = 'D18') ifTrue:[ arg _ 'DIG18' ].		(arg = 'D19') ifTrue:[ arg _ 'DIG19' ].		(arg = 'A0') ifTrue:[ arg _ 'ANA0' ].		(arg = 'A1') ifTrue:[ arg _ 'ANA1' ].		(arg = 'A2') ifTrue:[ arg _ 'ANA2' ].		(arg = 'A3') ifTrue:[ arg _ 'ANA3' ].		(arg = 'A4') ifTrue:[ arg _ 'ANA4' ].		(arg = 'A5') ifTrue:[ arg _ 'ANA5' ].		(arg = 'A6') ifTrue:[ arg _ 'ANA6' ].		(arg = 'A7') ifTrue:[ arg _ 'ANA7' ]."	].	aStream nextPutAll: arg.! !!ChoiceArgMorphForStuduino methodsFor: 'initialization' stamp: 'KK 3/3/2015 09:55'!initialize	isValid _ true.	super initialize."	labelMorph _ StringFieldMorph new		forExpressionArg;		doResizing: true;		font: (ScratchFrameMorph getFont: #Arg);		color: Color black."! !!ChoiceArgMorphForStuduino methodsFor: 'initialization' stamp: 'KK 9/27/2017 18:25'!setFieldWidth: w	FieldWidth _ w.	self extent: (FieldWidth@30).	menuIconMorph position: (self right - borderWidth - 10)@(self top + borderWidth + 4).! !!ChoiceArgMorphForStuduino methodsFor: 'initialization' stamp: 'KK 9/27/2017 18:28'!setFieldWidth: w high: h	FieldWidth _ w.	self extent: (FieldWidth@h).	menuIconMorph position: (self right - borderWidth - 10)@(self top + borderWidth + 4).! !!ChoiceArgMorphForStuduino methodsFor: 'accessing' stamp: 'KK 3/27/2015 10:55'!choice: aSymbol	| selected tempExtent pinNo pinNoArray |	"Update the toggle button when an argument is changed within a block."	selected _ self choice.	" selected Parts ""Transcript show:'aSymbol';show:': ';show:aSymbol;cr.Transcript show:'selected';show:': ';show:selected;cr."	(selected = aSymbol) ifTrue:[ ^ self.].	" Check whether user is going to use the infrared receiving sensor and I2C devices at the same time "	(aSymbol = InfraredReceiverName) ifTrue: [		pinNoArray _ owner submorphs select: [:each | each isMemberOf: StringMorph. ].		pinNoArray ifNotNil: [ pinNo _ (pinNoArray at:1) contents. ].		((pinNo = 'A4') | (pinNo = 'A5')) ifFalse: [			((self ownerThatIsA: PinAssignMorph) canBeSelected: aSymbol) ifFalse: [				^ self.			]		].	].	(aSymbol = AccelerometerName) |	(aSymbol = GyroSensorName) |	(aSymbol = ColorSensorName) ifTrue: [		((self ownerThatIsA: PinAssignMorph) canBeSelected: aSymbol) ifFalse: [			^ self.		]	].	tempExtent _ self extent.	super choice: aSymbol.	(owner notNil) ifTrue: [		" ------------------------- Ultrasonic Sensor -------------------------"		(aSymbol = UltrasonicSensorName) ifTrue: [			(self ownerThatIsA: PinAssignMorph) notifyUltrasonicSelect: owner.		].		(selected = UltrasonicSensorName) ifTrue: [			(self ownerThatIsA: PinAssignMorph) notifyNotUltrasonicSelect: owner.		].		" --------------------------- Accelerometer ---------------------------"		(aSymbol = AccelerometerName) ifTrue: [			(self ownerThatIsA: PinAssignMorph) notifyAccelerometerSelect: owner.		].		(aSymbol = GyroSensorName) ifTrue: [			(self ownerThatIsA: PinAssignMorph) notifyGyroSensorSelect: owner.		].		(aSymbol = ColorSensorName) ifTrue: [			(self ownerThatIsA: PinAssignMorph) notifyColorSensorSelect: owner.		].		(selected = AccelerometerName) ifTrue: [			(self ownerThatIsA: PinAssignMorph) notifyNotToSelectAccelerometer: owner.		].		(selected = GyroSensorName) ifTrue: [			(self ownerThatIsA: PinAssignMorph) notifyNotToSelectGyroSensor: owner.		].		(selected = ColorSensorName) ifTrue: [			(self ownerThatIsA: PinAssignMorph) notifyNotToSelectColorSensor: owner.		].		" ------------------------- Infrare Receiver -------------------------"		(aSymbol = InfraredReceiverName) ifTrue: [			(self ownerThatIsA: PinAssignMorph) notifyInfrareReceiverSelect: owner.		].		(selected = InfraredReceiverName) ifTrue: [			(self ownerThatIsA: PinAssignMorph) notifyNotInfrareReceiverSelect: owner.		].		" ------------------------- Bluetooth -------------------------"		(aSymbol = BluetoothName) ifTrue: [			(self ownerThatIsA: PinAssignMorph) notifyBluetoothSelect: owner.		].		(selected = BluetoothName) ifTrue: [			(self ownerThatIsA: PinAssignMorph) notifyNotBluetoothSelect: owner.		].	].	self extent: tempExtent.	menuIconMorph position: (self right - borderWidth - 10)@(self top + borderWidth + 4).! !!ChoiceArgMorphForStuduino methodsFor: 'accessing' stamp: 'KK 3/27/2015 10:53'!choiceAccelerameter	| |	"Choice Accelerameter item in combo box."	self choice: AccelerometerName.! !!ChoiceArgMorphForStuduino methodsFor: 'accessing' stamp: 'KK 3/27/2015 10:45'!choiceColorSensor	| |	"Choice Accelerameter item in combo box."	self choice: ColorSensorName.	! !!ChoiceArgMorphForStuduino methodsFor: 'accessing' stamp: 'KK 3/27/2015 10:53'!choiceGyroSensor	| |	"Choice Gyro sensor item in combo box."	self choice: GyroSensorName.! !!ChoiceArgMorphForStuduino methodsFor: 'accessing' stamp: 'KK 1/5/2015 16:01'!choiceI2CDevice	| tempExtent |	"Choice Accelerameter item in combo box."	tempExtent _ self extent.	super choice: 'I2C device'.	self extent: tempExtent.	menuIconMorph position: (self right - borderWidth - 10)@(self top + borderWidth + 4).	! !!ChoiceArgMorphForStuduino methodsFor: 'accessing' stamp: 'KK 3/24/2015 11:46'!choiceLightSensor	| |	"Choice Accelerameter item in combo box."	self choice: LightSensorName.	! !!ChoiceArgMorphForStuduino methodsFor: 'accessing' stamp: 'KK 3/27/2015 10:54'!choiceUltrasonicSensor	| |	"Choice Accelerameter item in combo box."	self choice: UltrasonicSensorName.! !!ChoiceArgMorphForStuduino methodsFor: 'accessing' stamp: 'KK 3/3/2015 09:41'!valiable: fisValid _ f.! !!ChoiceArgMorphForStuduino methodsFor: 'event handling' stamp: 'KK 3/3/2015 09:56'!handlesMouseDown: evt	isValid ifNotNil: [		^ (evt hand toolType isNil) & (isValid) and:			[(self topLeft - (0@0) corner: self bottomRight) containsPoint: evt cursorPoint].	].! !!ColorArgMorph methodsFor: 'other' stamp: 'KK 8/2/2013 12:59'!printArduArgOn: aStream	"Print this argument morph on the given stream."	aStream nextPutAll: 'c[',		(self hexFor: color red),		(self hexFor: color green),		(self hexFor: color blue),		']'.! !!ColorArgMorph methodsFor: 'other' stamp: 'KK 8/2/2013 13:02'!printArgOn: aStream	"Print this argument morph on the given stream."	aStream nextPutAll:		(self hexFor: color red),		(self hexFor: color green),		(self hexFor: color blue).! !!CommandBlockMorph methodsFor: 'initialization' stamp: 'KK 9/20/2013 17:58'!initialize	super initialize.	commandSpec _ ''.	argMorphs _ OrderedCollection new.	receiver _ nil.	selector _ nil.	isTimed _ false.! !!CommandBlockMorph methodsFor: 'evaluation' stamp: 'KK 5/1/2014 17:09'!coerceArgs: argList	"Answer an arugments array in which all arguments that should be numbers have been coerced to numbers if necessary."	| args specialCommands numFlags |	args _ argList asArray.	specialCommands _ #(		append:toList: deleteLine:ofList: getLine:ofList: insert:at:ofList: list:contains: setLine:ofList:to:		lookLike: showBackground:		playSound: doPlaySoundAndWait		setVar:to:).	(specialCommands includes: selector) ifFalse: [		"ensure args are numbers where numbers are expected"		numFlags _ self numberArgFlags.		1 to: args size do: [:i |			(numFlags at: i) ifTrue: [args at: i put: (args at: i) asNumberNoError]]].	^ args! !!CommandBlockMorph methodsFor: 'evaluation' stamp: 'KK 5/1/2014 17:11'!evaluateWithArgs: rawArgs	"Evalue this block with the given argument list."	| args |	"special case for math and boolean infix operators"	selector isInfix ifTrue: [^ self evaluateInfixWithArgs: rawArgs].	args _ self coerceArgs: rawArgs..	"special case for unary operators"	(#(abs not rounded sqrt truncated) includes: selector) ifTrue: [^ args first perform: selector].	^ receiver perform: selector withArguments: args! !!CommandBlockMorph methodsFor: 'menus' stamp: 'KK 10/9/2013 11:15'!rightButtonMenu	| menu sFrame choice spec |	menu _ CustomMenu new."	menu add: 'help' action: #presentHelpScreen."	(owner isKindOf: ScratchBlockPaletteMorph) ifFalse: [		menu addLine.		(#(+ - * / \\) includes: selector) ifTrue: [			#(+ - * / mod) with: #(+ - * / \\) do: [:s :op | menu add: s action: op]].		(#(< = >) includes: selector) ifTrue: [			#(< = >) do: [:op | menu add: op action: op]].		(#(& |) includes: selector) ifTrue: [			#(and or) with: #(& |) do: [:s :op | menu add: s action: op]].		menu addLine.		menu add: 'duplicate' action: #duplicate.		(self owner isKindOf: BlockMorph) ifFalse: [  "can't yet delete a blocks inside a script"			menu add: 'delete' action: #delete]].	sFrame _ self ownerThatIsA: ScratchFrameMorph.	(sFrame notNil and: [#(sensor: sensorPressed:) includes: selector]) ifTrue: [		menu addLine.		menu add: 'show ScratchBoard watcher' action: #showSensorBoard."		sFrame workPane scratchServer			ifNil: [menu add: 'enable remote sensor connections' action: #enableRemoteSensors]			ifNotNil: [menu add: 'disable remote sensor connections' action: #exitScratchSession]"	].	DebugMenu ifTrue: [		menu addLine.		menu add: 'show tuples' action: #showTuples].		(choice _ menu localize; startUp) ifNil: [^ self].	(#(presentHelpScreen duplicate delete) includes: choice) ifTrue: [^ self perform: choice].	choice = #showSensorBoard ifTrue: [sFrame showSensorBoard. ^ self].	choice = #enableRemoteSensors ifTrue: [sFrame enableRemoteSensors. ^ self].	choice = #exitScratchSession ifTrue: [sFrame exitScratchSession. ^ self].	choice = #showTuples ifTrue: [^ self showTuples].	"change operator"	spec _ '%n ', choice, ' %n'.	'\\' = choice	ifTrue: [spec _ ScratchTranslator translationFor: '%n mod %n'].	'&' = choice	ifTrue: [spec _ ScratchTranslator translationFor: '%b and %b'].	'|' = choice	ifTrue: [spec _ ScratchTranslator translationFor: '%b or %b'].	self commandSpec: spec.	self selector: choice.! !!CommandBlockMorph methodsFor: 'private' stamp: 'sk 2/8/2016 20:24'!addCommandIcons	"Add additional icons to certain blocks. Do nothing if this isn't one of those blocks."	| f m |	#turnLeft: = selector ifTrue: [		f _ ScratchFrameMorph skinAt: #turnCCW ifAbsent: [^ self].		m _ self firstSubmorph delete.		self addMorphFront: (ImageMorph new form: f).		self addMorphFront: m].	#turnRight: = selector ifTrue: [		f _ ScratchFrameMorph skinAt: #turnCW ifAbsent: [^ self].		m _ self firstSubmorph delete.		self addMorphFront: (ImageMorph new form: f).		self addMorphFront: m].	#stopAll = selector ifTrue: [		f _ ScratchFrameMorph skinAt: #stopButton ifAbsent: [^ self].		self addMorphBack: (ImageMorph new form: f)].	#motorNo:degree: = selector ifTrue: [		f _ ScratchFrameMorph skinAt: #sv ifAbsent: [^ self].		self addMorphFront: (ImageMorph new form: f)].	#setServoSpeed:d2:d4:d7:d8:d9:d10:d11:d12: = selector ifTrue: [		f _ ScratchFrameMorph skinAt: #sv ifAbsent: [^ self].		self addMorphFront: (ImageMorph new form: f)].	#motorNo:power: = selector ifTrue: [		f _ ScratchFrameMorph skinAt: #DC1 ifAbsent: [^ self].		self addMorphFront: (ImageMorph new form: f)].	#motorNo:dcMotorOff: = selector ifTrue: [		f _ ScratchFrameMorph skinAt: #DC3 ifAbsent: [^ self].		self addMorphFront: (ImageMorph new form: f)].	#motorNo:dcMotorOn: = selector ifTrue: [		f _ ScratchFrameMorph skinAt: #DC2 ifAbsent: [^ self].		self addMorphFront: (ImageMorph new form: f)].	#buzzerPin:freq: = selector ifTrue: [		f _ ScratchFrameMorph skinAt: #buzzer ifAbsent: [^ self].		self addMorphFront: (ImageMorph new form: f)].	#buzzerPin: = selector ifTrue: [		f _ ScratchFrameMorph skinAt: #buzzer2 ifAbsent: [^ self].		self addMorphFront: (ImageMorph new form: f)].	#ledPin:onOff: = selector ifTrue: [		f _ ScratchFrameMorph skinAt: #LED1 ifAbsent: [^ self].		self addMorphFront: (ImageMorph new form: f)].	#boardLED:onOff: = selector ifTrue: [		f _ ScratchFrameMorph skinAt: #LED1 ifAbsent: [^ self].		self addMorphFront: (ImageMorph new form: f)].	#ledColor:onOff: = selector ifTrue: [		f _ ScratchFrameMorph skinAt: #LED2 ifAbsent: [^ self].		self addMorphFront: (ImageMorph new form: f)].! !!CommandBlockMorph methodsFor: 'private' stamp: 'KK 9/26/2013 17:23'!argMorphToReplace: aMorph	"Answer a new argument morph to be used to replace the given morph. Answer nil if the given morph is not one of my argMorphs."	| i argSpecs spec argM defaults v |	i _ argMorphs indexOf: aMorph ifAbsent: [^ nil].	argSpecs _ (CommandBlockMorph parseCommandSpec: commandSpec) select: [:s | CommandBlockMorph isArgSpec: s].	i > argSpecs size ifTrue: [^ nil].	argM _ self argMorphFor: (argSpecs at: i).	(#setVar:to: = selector and: [(argSpecs at: i) = '%n']) ifTrue: [		^ argM numExpression: 0].	spec _ ScriptableScratchMorph blockSpecDict at: selector ifAbsent: [^ argM].	defaults _ receiver defaultArgsFor: spec.	i <= defaults size ifTrue: [		v _ defaults at: (argPermutation indexOf: i).		(v isKindOf: String)			ifTrue: [				(argM isKindOf: ExpressionArgMorph)					ifTrue: [argM defaultValueFromSpec: v localized]					ifFalse: [argM defaultValue: v localized]]			ifFalse: [argM defaultValue: v]].	^ argM! !!CommandBlockMorph methodsFor: 'private' stamp: 'KK 8/29/2013 16:47'!canBecomeWatcher	"I determine which blocks can become watchers."	| i |	i _ selector asString findAnySubStr: #('mouse' 'key' 'touching' 'distance') startingAt: 1.	^ (self isReporter) &	   (self argumentCount <= 1) &	   ((#(not atRandom abs rounded lineCountOfList: stringLength:) includes: selector) not) &	   (i > selector asString size)! !!CommandBlockMorph methodsFor: 'private' stamp: 'KK 4/25/2014 16:47'!isOnlyServo: aMorph	" Blocks are mass of servomotor block ?  "	|  nextBlock |	nextBlock _ aMorph submorphs at:1.	" Check next blok is end of block "	(nextBlock isKindOf:CommandBlockMorph) ifTrue: [		" Next block is kind of CommandBlockMorph "		(nextBlock isKindOf: ReporterBlockMorph) ifTrue: [			" But, next block is kind of ReportBlockMorph "			" So, next block is nothing. "			^ true.		]	]	ifFalse: [		" Next block is NOT kind of CommandBlockMorph "		" So, next block is nothing. "		^ true.	].	" Next block is not servomoter "	(nextBlock selector = #motorNo:degree:) ifFalse: [ ^ false. ].	" Next block is servomotor. so, check after the next block... "	^ (self isOnlyServo: nextBlock).	! !!CommandBlockMorph methodsFor: 'private' stamp: 'KK 9/20/2017 16:39'!printArduCodeOn: aStream indent: indent	"Append a human-readable string for this block on the given stream."	| nextB hasFinalSpace |	indent timesRepeat: [aStream nextPutAll: '    '].	nextB _ self nextBlock.	hasFinalSpace _ false.	(self selector = 'contentsOfList:') ifTrue: [ aStream nextPutAll: 'listItem(&ARLIST_'. ].	(self isKindOf: VariableBlockMorph) ifTrue: [ aStream nextPutAll: 'ARVAL_'. ].	" To add offset degree info, copy PIN name to new ChoiceArgMorph "	(self selector = 'motorNo:degree:') ifTrue: [		ServomotorSynchroMotion ifTrue: [			ServomotorNumber _ ServomotorNumber + 1.		].	].	submorphs do: [:m |		m ~~ nextB ifTrue: [			self printArduCodeSubmorph: m on: aStream.			hasFinalSpace _ true.			"aStream space"]].	"hasFinalSpace ifTrue: [aStream skip: -1]."	(self selector = 'contentsOfList:') ifTrue: [ aStream nextPutAll: ',1)'. ].	(selector = 'ledColor:onOff:')	ifTrue: [		((IOPort at: 11) = 5) ifTrue: [ aStream nextPutAll: ', 0);' ]		ifFalse: [ aStream nextPutAll: ', 1);' ].	].		aStream cr.	self nextBlock ifNotNil: [self nextBlock printArduCodeOn: aStream indent: indent].! !!CommandBlockMorph methodsFor: 'private' stamp: 'KK 9/20/2017 11:06'!uncoloredArgMorphFor: t1 
	| t2 |

	" Check if a single character or a string."
	(t1 size = 2) ifTrue: [
		t2 _ t1 at: 2.	]
	ifFalse: [
		t2 _ t1 copyFrom: 2 to: (t1 size).].

	$a = t2 ifTrue: [^ AttributeArgMorph new choice: 'volume'].
	$b = t2 ifTrue: [^ BooleanArgMorph new].
	$B = t2 ifTrue: [^ ChoiceArgMorph new getOptionsSelector: #bzrPinNo;
		 choice: 'A0'].
	$c = t2 ifTrue: [^ ColorArgMorph new showPalette: true].
	$C = t2 ifTrue: [^ ColorArgMorph new showPalette: false].
	$d = t2 ifTrue: [^ ExpressionArgMorphWithMenu new numExpression: '0';
		 menuSelector: #directionMenu].
	$D = t2 ifTrue: [^ ExpressionArgMorphWithMenu new numExpression: '48';
		 menuSelector: #midiDrumMenu].
	$e = t2 ifTrue: [^ EventTitleMorph new].
	$E = t2 ifTrue: [^ NumericUpDownMorph new  setDefault:10 min:0 max:20 width:15 isEdit:true].
	$f = t2 ifTrue: [^ ChoiceArgMorph new getOptionsSelector: #mathFunctionNames;
		 choice: 'sqrt'].
	$F = t2 ifTrue: [^ NumericUpDownMorph new  setDefault:90 min:0 max:180 width:20 isEdit:true].
	$g = t2 ifTrue: [^ ChoiceArgMorph new getOptionsSelector: #graphicEffectNames;
		 choice: 'color'].
	$H = t2 ifTrue: [^ ChoiceArgMorph new getOptionsSelector: #hookupSensorNames].
	$h = t2 ifTrue: [^ ChoiceArgMorph new getOptionsSelector: #hookupBooleanSensorNames].
	$I = t2 ifTrue: [^ ExpressionArgMorphWithMenu new numExpression: '1';
		 menuSelector: #midiInstrumentMenu].
"	$i = t2 ifTrue: [^ ExpressionArgMorphWithMenu new numExpression: '1';
		 menuSelector: #listIndexMenu]."
	$i = t2 ifTrue: [^ ExpressionArgMorph new numExpression: '10'].
	$j = t2 ifTrue: [^ ChoiceArgMorph new getOptionsSelector: #dcMotorNo;
		 choice: 'PIN'].
	$J = t2 ifTrue: [^ ChoiceArgMorph new getOptionsSelector: #svMotorNo;
		 choice: 'PIN'].
	$k = t2 ifTrue: [^ ChoiceArgMorph new getOptionsSelector: #keyNames;
		 choice: 'space'].
	$L = t2 ifTrue: [^ ChoiceArgMorph new getOptionsSelector: #listVarMenu].
	$l = t2 ifTrue: [^ ChoiceOrExpressionArgMorph new getOptionsSelector: #costumeNames;
		 choice: 'costume1'].
	$m = t2 ifTrue: [^ SpriteArgMorph new].
	$M = t2 ifTrue: [^ ChoiceArgMorph new getOptionsSelector: #motorNames].
	$n = t2 ifTrue: [^ ExpressionArgMorph new numExpression: '10'].
	$N = t2 ifTrue: [^ ExpressionArgMorphWithMenu new numExpression: '60';
		 menuSelector: #noteSelector].
	$o = t2 ifTrue: [^ ChoiceArgMorph new getOptionsSelector: #ledOnOff;
		 choice: 'on'].
	$O = t2 ifTrue: [^ ChoiceArgMorph new getOptionsSelector: #hookupSoundPin].
	$p = t2 ifTrue: [^ ChoiceArgMorph new getOptionsSelector: #ledPinNo;
		 choice: 'A0'].
	'p1' = t2 ifTrue: [^ ChoiceArgMorph new getOptionsSelector: #boardLED;
			choice: 'Red(D5)'.].
	$P = t2 ifTrue: [^ ChoiceArgMorph new getOptionsSelector: #hookupLightPin].
	$q = t2 ifTrue: [^ ChoiceArgMorph new getOptionsSelector: #moveDirection;
		 choice: 'Forward'].
	$s = t2 ifTrue: [^ ExpressionArgMorph new stringExpression: ''].
	$S = t2 ifTrue: [^ ChoiceOrExpressionArgMorph new getOptionsSelector: #soundNames;
		 choice: 'pop'].
	$t = t2 ifTrue: [^ ChoiceArgMorph new getOptionsSelector: #dcMotorOn;
		 choice: 'cw.'].
	$T = t2 ifTrue: [^ ChoiceArgMorph new getOptionsSelector: #dcMotorOff;
		 choice: 'Brake'].
	$U = t2 ifTrue: [^ ChoiceArgMorph new getOptionsSelector: #hookupSensorsPin].
	$v = t2 ifTrue: [^ ChoiceArgMorph new getOptionsSelector: #varNamesMenu;
		 choice: ''].
	$V = t2 ifTrue: [^ ChoiceArgMorph new getOptionsSelector: #hookupTouchPin].
	$w = t2 ifTrue: [^ ChoiceArgMorph new getOptionsSelector: #temperaturePinNo].
	$W = t2 ifTrue: [^ ChoiceArgMorph new getOptionsSelector: #motorDirection].
	$x = t2 ifTrue: [^ ChoiceOrExpressionArgMorph new getOptionsSelector: #sceneNames;
		 choice: ''].
	$X = t2 ifTrue: [^ ChoiceArgMorph new getOptionsSelector: #hookupARButton].
"	$y = t2 ifTrue: [^ ExpressionArgMorphWithMenu new numExpression: '1';
		 menuSelector: #listIndexForDeleteMenu]."
	$y = t2 ifTrue: [^ ExpressionArgMorph new numExpression: '10'].
	$Y = t2 ifTrue: [^ ChoiceArgMorph new getOptionsSelector: #hookupARSensorXYZ].
	$z = t2 ifTrue: [^ ChoiceArgMorph new getOptionsSelector: #hookupARSensorNames].
	$Z = t2 ifTrue: [^ ChoiceArgMorph new getOptionsSelector: #hookupIRPin].
	'Z1' = t2 ifTrue: [^ ChoiceArgMorph new getOptionsSelector: #clockVars].
^ ExpressionArgMorph new numExpression: '10'! !!CBlockMorph methodsFor: 'drawing' stamp: 'KK 2/27/2015 13:55'!drawOn: aCanvas 	| c |	topBarBottom _ self top + self topBarHeight.	self isForever		ifTrue: [blockBottom _ self bottom - 3]		ifFalse: [blockBottom _ self bottom - 7].	self computeHighlightColors.	c _ FormCanvas extent: self extent depth: 32.	c _ c copyOffset: self topLeft negated.	self drawTopEdgeOn: c.	self drawTopBarOn: c.	self drawVerticalBarOn: c.	self drawBottomBarOn: c.	self drawFinalOn: aCanvas fromCanvas: c.! !!CBlockMorph methodsFor: 'private' stamp: 'KK 8/20/2014 11:46'!attachBlock: aBlockMorph	"Attach the given block to me. Assume the block has been positioned correctly."	aBlockMorph top >= (self bottom - CBlockBracketThickness)		ifTrue: [			self addMorph: aBlockMorph.			nextBlock _ aBlockMorph.		]		ifFalse: [			((self selector = #doSvmSyncMotion) | (self selector = #doSvmSyncMotion2)) ifTrue: [				" self is Servomotor synchro motion block. "				(aBlockMorph selector = #motorNo:degree:) ifTrue: [					" aBlockMorph is servomotor block. "					(self isOnlyServo: aBlockMorph) ifTrue: [						self addMorph: aBlockMorph.						nestedBlock _ aBlockMorph.					].				].			]			ifFalse: [				self addMorph: aBlockMorph.				nestedBlock _ aBlockMorph.			]		].! !!CBlockMorph methodsFor: 'private' stamp: 'sk 5/20/2016 21:21'!printArduCodeOn: aStream indent: indent	| localIndent localArg strDelayMsecPerDeg |	"Append a human-readable string for this block on the given stream."	indent timesRepeat: [aStream nextPutAll: '    '].	localIndent _ indent.	"if (T/F) for(;;)"	(selector = 'doForeverIf')	ifTrue: [		aStream nextPutAll: 'for(;;) {'.		aStream cr.		localIndent _ localIndent + 1.		(localIndent) timesRepeat: [aStream nextPutAll: '    '].	].	((selector = 'doSvmSyncMotion') | (selector = 'doSvmSyncMotion2'))	ifTrue: [		submorphs do: [:m |			(m ~~ nestedBlock) & (m ~~ nextBlock) & ((m isKindOf: StringMorph) not) ifTrue:	[				(m isKindOf: NumericUpDownMorph) ifTrue: [					ServomotorNumber _ 0.					ServomotorSynchroMotion _ true.					strDelayMsecPerDeg _ m labelMorph contents.				] ifFalse: [					localArg _ WriteStream on: (String new: 10000).					self printArduCodeSubmorph: m on: localArg.					strDelayMsecPerDeg _ localArg contents.					ServomotorNumber _ 0.					ServomotorSynchroMotion _ true.				].			].		].	] ifFalse: [		(selector = 'doRepeat') ifTrue: [			FirstSubMorphOfdoRepeat _ true.		" First sub morph? "			aStream nextPutAll: 'int loopCounter'.			aStream nextPutAll: NumberOfdoRepeat asString.			aStream nextPutAll: ' = '.			submorphs do: [:m |				(m ~~ nestedBlock) & (m ~~ nextBlock) ifTrue: [					self printArduCodeSubmorph: m on: aStream.					(FirstSubMorphOfdoRepeat) ifTrue: [						aStream nextPutAll: ';';cr.						indent timesRepeat: [aStream nextPutAll: '    '].						FirstSubMorphOfdoRepeat _ false.					].				].			].			" aStream is {for (int i = 0; i <} "			aStream nextPutAll: 'loopCounter'.			aStream nextPutAll: NumberOfdoRepeat asString.			aStream nextPutAll: '; i++) {'.			" Increment number of doRepeat Block "			NumberOfdoRepeat _ NumberOfdoRepeat + 1.			localIndent _ localIndent + 1.		]		ifFalse: [			submorphs do: [:m |				(m ~~ nestedBlock) & (m ~~ nextBlock) ifTrue: [					self printArduCodeSubmorph: m on: aStream.					aStream space ]].			localIndent _ localIndent + 1.		].	].	aStream cr.	nestedBlock ifNotNil: [nestedBlock printArduCodeOn: aStream indent: localIndent].	"if (T/F) for(;;)"	(selector = 'doForeverIf')	ifTrue: [		localIndent _ localIndent - 1.		(localIndent) timesRepeat: [aStream nextPutAll: '    '].		aStream nextPutAll: '}'; cr.	].	" For Studuino mini Clock. "	(BoardType = 1) ifTrue: [	((selector = 'doForever') & ((IOPort at: 19) = 6)) ifTrue: [		localIndent timesRepeat: [aStream nextPutAll: '    '].		aStream nextPutAll: 'board.sleep();'; cr.].].	"for(;;) / for(int i = 0;i < N;i++) / if (T/F) for(;;) / if(T/F) / while(T/F)"	((selector = 'doForever') | (selector = 'doRepeat') | (selector = 'doForeverIf') | (selector = 'doIf') | (selector = 'doUntil'))	ifTrue: [		localIndent _ localIndent - 1.		(localIndent) timesRepeat: [aStream nextPutAll: '    '].		aStream nextPutAll: '}'; cr.	].	(selector = 'doSvmSyncMotion')	ifTrue: [		ServomotorSynchroMotion _ false.		(localIndent) timesRepeat: [aStream nextPutAll: '    '].		aStream			nextPutAll: 'board.SyncServomotors(port, degree, ';			nextPutAll: ServomotorNumber asString;			nextPutAll: ', SYNCSVRANGE(scratchRound(';			nextPutAll: strDelayMsecPerDeg asString;			nextPutAll: '))+3);'; cr.	].	(selector = 'doSvmSyncMotion2')	ifTrue: [		ServomotorSynchroMotion _ false.		(localIndent) timesRepeat: [aStream nextPutAll: '    '].		aStream			nextPutAll: 'board.SyncServomotors(port, degree, ';			nextPutAll: ServomotorNumber asString;			nextPutAll: ', SYNCSVRANGE(scratchRound(20-';			nextPutAll: strDelayMsecPerDeg asString;			nextPutAll: '))+3);'; cr.	].	nextBlock ifNotNil: [nextBlock printArduCodeOn: aStream indent: indent].! !!CBlockMorph methodsFor: 'evaluation' stamp: 'KK 5/1/2014 17:12'!evaluateWithArgs: rawArgs	| |	^ receiver doSvmSyncMotion: rawArgs.! !!ConfigureBoardMorph methodsFor: 'initialization' stamp: 'KK 8/16/2013 17:29'!addReadoutLabeled: aString	"Add a readout row with the given label. Answer the stringmorph that's the readout."	| row box readout |	row _ AlignmentMorph newRow color: column color; inset: 2.	row addMorphBack: (Morph new color: column color; extent: 1@3). "spacer"	row addMorphBack: (StringMorph contents: aString capitalized font: (StrikeFont fontName: 'VerdanaBold' size: 10)).	row addMorphBack: (AlignmentMorph new color: column color; extent: 10@1; hResizing: #spaceFill).  "spacer"	box _ WatcherReadoutFrameMorph new		extent: 42@14;		color: (ScriptableScratchMorph blockColorFor: 'sensing').	readout _ StringMorph contents: '0' font: (StrikeFont fontName: 'VerdanaBold' size: 10).	readout color: Color white.	box addMorph: readout.	row addMorphBack: box.	column addMorphBack: row.	^ readout! !!ConfigureBoardMorph methodsFor: 'initialization' stamp: 'KK 8/16/2013 17:29'!addReadouts	| readoutNames |	readoutNames _ #(		'A0'		'A1'		'A2'		'A3'		'A4'		'A5'		'A6'		'A7'	).	column _ AlignmentMorph newColumn		centering: #center;		hResizing: #spaceFill;		vResizing: #shrinkWrap;		color: (Color r: (193/255) g: (196/255) b: (199/255));		borderWidth: 2;		borderColor: (Color r: (148/255) g: (145/255) b: (145/255));		useRoundedCorners;		inset: 3.	titleMorph _ StringMorph		contents: ''		font: (StrikeFont fontName: 'VerdanaBold' size: 10).	column addMorph: titleMorph.	self updateTitle.	column addMorphBack: (Morph new color: column color; extent: 5@3).  "spacer"	self removeAllMorphs.	readouts _ readoutNames collect: [:i |		(i size = 1)			ifTrue:[self addReadoutLabeled: i]			ifFalse:[self addReadoutLabeled: i localized]].	column position: self position - 2.	self addMorph: column.	self extent: column extent - 4.! !!ConfigureBoardMorph methodsFor: 'initialization' stamp: 'KK 8/16/2013 17:29'!data: d msgID: id	"I make message and send it to board."	| mid high low msgh msgl msg carry |"self halt."	mid _ id bitShift: 4.			" mid = id << 4 "	high _ d bitShift: -8.		" high = d >> 8"	carry _ d bitShift: -7.		" low side carry = d >> 7"	carry _ carry bitAnd: 16r01.	" carry = carry & 0x01"	high _ high + carry.		" high = high + carry"	high _ high bitAnd: 16r0F.	" high = high & 0x0F"	low _ d bitAnd: 16r7F.		" low = d & 0x7F"	msgh _ 16r80 + mid + high.	" msgh = 0x80 + mid + high"	msgl _ low.					" msgl = low"	msg _ #(0 0) asByteArray.	msg at: 1 put:msgh.	msg at: 2 put: msgl."Transcriptshow:msgh;show:', ';show:msgl;cr."	port nextPutAll: msg.! !!ConfigureBoardMorph methodsFor: 'initialization' stamp: 'KK 8/16/2013 18:23'!initialize	super initialize.	sensorValues _ Array new: 16 withAll: 0.	currentState _ #idle.	highByte _ 0.	useGoGoProtocol ifNil: [useGoGoProtocol _ false].	scratchBoardV3 _ false.	reportRaw _ false.	scanState _ #off.	self addReadouts.! !!ConfigureBoardMorph methodsFor: 'accessing' stamp: 'KK 8/16/2013 17:29'!isScriptable	"I am not scriptable."	^ false! !!ConfigureBoardMorph methodsFor: 'sensor ops' stamp: 'KK 8/16/2013 17:29'!privateSensor: t1 	| t2 t3 |	t2 _ (t1 asInteger max: 1)				min: 8.	useGoGoProtocol		ifFalse: [scratchBoardV3				ifTrue: [t2 _ #(8 6 7 4 5 3 2 1 ) at: t2]				ifFalse: [t2 _ #(1 2 3 4 5 6 7 8 ) at: t2]]."				ifFalse: [t2 _ #(5 6 7 8 1 2 3 4 ) at: t2]]."	t3 _ sensorValues at: t2.	reportRaw _ true.			" return Rawdata "	reportRaw ifTrue: [^ t3].	scratchBoardV3		ifTrue: 			[t2 = 6 ifTrue: [^ self scaleLight: t3].			t2 = 7 ifTrue: [^ self scaleSound: t3]].	t3 > 1020 ifTrue: [t3 _ 1023].! !!ConfigureBoardMorph methodsFor: 'sensor ops' stamp: 'KK 8/16/2013 17:29'!sensor: sensorIndex	"Answer the value of the virtual sensor with the given index. Sensors are numbered 1-8."	^ self privateSensor: sensorIndex! !!ConfigureBoardMorph methodsFor: 'sensor ops' stamp: 'KK 8/16/2013 17:29'!startReadingData	"Ensure that the serial port is open, turn off all motors and put them into a known state, and begin streaming sensor data."	self portIsOpen ifFalse: [^ self].  "could not open the serial port"	currentState _ #idle.	sensorValues atAllPut: 0.	scratchBoardV3 _ false.	self startStreamingSensors: 0.  "in case board was left in streaming mode"	port flushInputBuffer.	useGoGoProtocol ifTrue: [		1 to: 6 do: [:motor |			self turnOffMotor: motor.			self thisWayMotor: motor.			self setPower: 3 motor: motor.			self turnOffMotor: motor].		self startStreamingSensors: 16rFF].  "all 8 sensors"! !!ConfigureBoardMorph methodsFor: 'sensor ops' stamp: 'KK 8/16/2013 17:29'!stopReadingData	"Turn off all motors, stop streaming data, and close the port."	(port notNil and: [port isOpen]) ifTrue: [		useGoGoProtocol ifTrue: [			1 to: 6 do: [:motor | self turnOffMotor: motor].			self startStreamingSensors: 0]].  "turn off streaming"	self closePort.! !!ConfigureBoardMorph methodsFor: 'motor ops' stamp: 'KK 8/16/2013 17:29'!coastToStopMotor: motorNum	"Let the given motor coast to a stop."	self portIsOpen ifFalse: [^ self].	self selectMotor: motorNum.	port nextPutAll: #(84 254 84) asByteArray.! !!ConfigureBoardMorph methodsFor: 'motor ops' stamp: 'KK 8/16/2013 17:29'!reverseMotor: motorNum	"Reverse the direction of the given motor."	self portIsOpen ifFalse: [^ self].	self selectMotor: motorNum.	port nextPutAll: #(84 254 72) asByteArray.! !!ConfigureBoardMorph methodsFor: 'motor ops' stamp: 'KK 8/16/2013 17:29'!selectMotor: anInteger	"Select the motor to which subsequent motor commands will be addressed. Motors are numbered 1-6."	| motorNum msg |	motorNum _ (anInteger truncated - 1 max: 0) min: 7. "motor bit index"	msg _ #(84 254 128 0) asByteArray.	msg at: 4 put: (1 bitShift: motorNum).	port nextPutAll: msg.! !!ConfigureBoardMorph methodsFor: 'motor ops' stamp: 'KK 8/16/2013 17:29'!setPower: aNumber motor: motorNum	"Set the power of the given motor to 0 to 7."	| power msg |	self portIsOpen ifFalse: [^ self].	self selectMotor: motorNum.	power _ (aNumber truncated max: 0) min: 7.	msg _ #(84 254 0) asByteArray.	msg at: 3 put: 96 + (power bitShift: 2).	port nextPutAll: msg.! !!ConfigureBoardMorph methodsFor: 'motor ops' stamp: 'KK 8/16/2013 17:29'!thatWayMotor: motorNum	"Set motor direction to that way."	self portIsOpen ifFalse: [^ self].	self selectMotor: motorNum.	port nextPutAll: #(84 254 80) asByteArray.! !!ConfigureBoardMorph methodsFor: 'motor ops' stamp: 'KK 8/16/2013 17:29'!thisWayMotor: motorNum	"Set motor direction to this way."	self portIsOpen ifFalse: [^ self].	self selectMotor: motorNum.	port nextPutAll: #(84 254 76) asByteArray.! !!ConfigureBoardMorph methodsFor: 'motor ops' stamp: 'KK 8/16/2013 17:29'!turnOffMotor: motorNum	self portIsOpen ifFalse: [^ self].	self selectMotor: motorNum.	port nextPutAll: #(84 254 68) asByteArray.! !!ConfigureBoardMorph methodsFor: 'motor ops' stamp: 'KK 8/16/2013 17:29'!turnOnMotor: motorNum	self portIsOpen ifFalse: [^ self].	self selectMotor: motorNum.	port nextPutAll: #(84 254 64) asByteArray.! !!ConfigureBoardMorph methodsFor: 'stepping' stamp: 'KK 8/16/2013 17:29'!step	"Update my title and sensor readouts. If scanning for ports, keep scanning."	| frame |"Transcriptshow:'SensorBoardMorph::step';cr."	#checkData = scanState ifTrue: [self scanForPort].	self portIsOpen		ifTrue: [self processIncomingData]		ifFalse: [port _ nil].	self updateTitle.	1 to: 8 do: [:i |		(readouts at: i) contents: (self privateSensor: i) truncated printString.		(scratchBoardV3 and: [i = 4])			ifTrue: [(readouts at: i) contents: ((self privateSensor: i) < 10) printString]. "button"		frame _ (readouts at: i) owner.		(frame respondsTo: #fixLayout) ifTrue: [frame fixLayout]].! !!ConfigureBoardMorph methodsFor: 'stepping' stamp: 'KK 8/16/2013 17:29'!stepTime	^ 50! !!ConfigureBoardMorph methodsFor: 'serial port' stamp: 'KK 8/16/2013 17:29'!closePort	port ifNotNil: [		self data:0 msgID:7.	"Send End of Communication to PC"		port flushInputBuffer.		port close].	port _ nil.	currentState _ #idle.	sensorValues atAllPut: 0.	scratchBoardV3 _ false.	1 to: 8 do: [:i | (readouts at: i) contents: '0'].	scanState _ #off.	self step.! !!ConfigureBoardMorph methodsFor: 'serial port' stamp: 'KK 8/16/2013 17:29'!openPort: aString	"Close the serial port if it is open, then open the port with the given name and initialize streaming of sensor data. Answer true if the operation was successful."	| baudRate portNum numStart |	baudRate _ useGoGoProtocol ifTrue: [9600] ifFalse: [38400].	self closePort.	portName _ aString.	ScratchPlugin serialPortOpsAvailable		ifTrue: [			port _ SerialPort2 new openPortNamed: portName baud: baudRate.			port isOpen ifFalse: [port _ nil. ^ false].			port setOption: 20 to: 1.  "set DTR high"			port setOption: 21 to: 0]  "set RTS low"		ifFalse: [			portNum _ 1.			numStart _ (1 to: portName size) detect: [:i | (portName at: i) isDigit] ifNone: [0].			numStart > 0 ifTrue: [portNum _ (portName copyFrom: numStart to: portName size) asNumber].			port _ SerialPort new				baudRate: baudRate;				inputFlowControlType: 2;				openPort: portNum ifFail: [^ false]].	"initialize polling state"	lastPollMSecs _ Time millisecondClockValue.	^ true! !!ConfigureBoardMorph methodsFor: 'serial port' stamp: 'KK 8/16/2013 17:29'!portIsOpen	^ port notNil and: [port isOpen]! !!ConfigureBoardMorph methodsFor: 'serial port' stamp: 'KK 8/16/2013 17:29'!portNames	"Answer a collection of possible port names for the Scratch sensor board. Filter out modems and PDA cradles."	ScratchPlugin serialPortOpsAvailable ifFalse: [		^ (1 to: 32) collect: [:i | 'COM', i printString]].	^ SerialPort2 portNames reject: [:n |		(n asLowercase includesSubString: 'modem') or:		[n asLowercase includesSubString: 'pda-sync']].! !!ConfigureBoardMorph methodsFor: 'serial port' stamp: 'KK 8/16/2013 17:29'!resetPort	"If the port is closed, do nothing. If it is open, close and reopen it. This can be used to reset the Prolific USB serial driver if it misbehaves."	self portIsOpen ifFalse: [^ self].	portName ifNil: [^ self].	self closePort.	self openPort: portName.	scanState _ #on.	self step.! !!ConfigureBoardMorph methodsFor: 'serial port' stamp: 'KK 8/16/2013 17:29'!scanForPort	"Try to find the serial port that the sensor board is attached to. This is incremental--each time it is called it does the next task."	"Details: scanState is one of: #(off, start, checkData, on). scanPorts is a list of port names to try. Attempt to open each port in turn, then wait for a while and see if Scratch Sensor data of the right form has arrived."	| msecs buf i |	#off = scanState ifTrue: [self scanNextPort].	#on = scanState ifTrue: [  "if port is open, close it and start a new scan"		scanPorts _ nil.		self scanNextPort].	#start = scanState ifTrue: [		(scanPorts isNil or: [scanPorts size = 0]) ifTrue: [			scanPorts _ self portNames asOrderedCollection].		scanPorts size = 0 ifTrue: [^ self scanNextPort].		self openPort: scanPorts removeFirst.		self portIsOpen ifFalse: [^ self].		scanState _ #checkData.		scanStartMSecs _ Time millisecondClockValue.		^ self].	#checkData = scanState ifTrue: [		msecs _ Time millisecondClockValue - scanStartMSecs.		(self portIsOpen not or: [msecs > 4000]) ifTrue: [^ self scanNextPort].		port nextPut: 1.  "send poll byte"		((buf _ port readByteArray) size < 10) ifTrue: [^ self].  "no data yet"		"check that the data is in Scratch Sensor Board format"		i _ (buf first bitAnd: 128) > 0 ifTrue: [1] ifFalse: [2].		[i < (buf size - 1)] whileTrue: [			(((buf at: i) bitAnd: 128) > 0 and:			 [((buf at: i + 1) bitAnd: 128) = 0]) ifFalse: [^ self scanNextPort].			i _ i + 2].		scanState _ #on].! !!ConfigureBoardMorph methodsFor: 'serial port' stamp: 'KK 8/16/2013 17:29'!scanNextPort	"Called during port scanning. The current port does not seem to be a ScratchBoard. Close it and try the next port in the list."	self closePort.	scanState _ #start.! !!ConfigureBoardMorph methodsFor: 'serial port' stamp: 'KK 8/16/2013 17:29'!selectPort	| menu choice |	self stopReadingData.	self portNames size = 0 ifTrue: [^ DialogBoxMorph inform: 'No serial ports found'].	menu _ CustomMenu new.	self portNames do: [:n | menu add: n action: n].	choice _ menu startUp.	choice ifNil: [^ self].	self openPort: choice.	self startReadingData.	scanState _ #on.	ResetCounter _ 0.! !!ConfigureBoardMorph methodsFor: 'serial port' stamp: 'KK 8/16/2013 17:29'!tryToOpenPort	"Attempt to open the port. If successful, or if the port was open already, answer true. Otherwise, answer false."	(port notNil and: [port isOpen and: [scanState = #on]]) ifTrue: [^ true].  "already open"	self scanForPort.	^ port notNil and: [port isOpen]! !!ConfigureBoardMorph methodsFor: 'serial port' stamp: 'KK 8/16/2013 17:29'!useGoGoProtocol	self stopReadingData.	useGoGoProtocol _ true.	scratchBoardV3 _ false.	self startReadingData.! !!ConfigureBoardMorph methodsFor: 'serial port' stamp: 'KK 8/16/2013 17:29'!useScratchboardProtocol	self stopReadingData.	useGoGoProtocol _ false.	self startReadingData.! !!ConfigureBoardMorph methodsFor: 'event handling' stamp: 'KK 8/16/2013 17:29'!handlesMouseDown: evt	^ true! !!ConfigureBoardMorph methodsFor: 'event handling' stamp: 'KK 8/16/2013 17:29'!mouseDown: evt	evt rightButtonPressed | evt shiftPressed		ifTrue: [Sensor waitNoButton. ^ self rightButtonMenu].	evt hand toolType = 'CutTool' ifTrue: [		evt shiftPressed ifFalse: [evt hand toolType: nil].		ScratchFrameMorph putInClipboard: self.		^ self delete].	evt hand waitForClicksOrDrag: self event: evt.! !!ConfigureBoardMorph methodsFor: 'event handling' stamp: 'KK 8/16/2013 17:29'!mouseHold: evt	self rightButtonMenu.! !!ConfigureBoardMorph methodsFor: 'event handling' stamp: 'KK 8/16/2013 17:29'!preemptsMouseDown: evt	^ true! !!ConfigureBoardMorph methodsFor: 'event handling' stamp: 'KK 8/16/2013 17:29'!rightButtonMenu	| menu |	menu _ CustomMenu new.	Sensor shiftPressed		ifTrue: [			reportRaw				ifTrue: [menu add: 'stop reporting raw data' action: #toggleRawMode]				ifFalse: [menu add: 'report raw data' action: #toggleRawMode].			useGoGoProtocol				ifTrue: [menu add: 'use Scratch board' action: #useScratchboardProtocol]				ifFalse: [menu add: 'use GoGo board' action: #useGoGoProtocol]]		ifFalse: [			menu add: 'select serial/USB port' action: #selectPort.			self portIsOpen				ifTrue: [menu add: 'close port' action: #stopReadingData].			menu addLine.			menu add: 'hide' action: #delete].	menu localize; invokeOn: self.! !!ConfigureBoardMorph methodsFor: 'event handling' stamp: 'KK 8/16/2013 17:29'!toggleRawMode	reportRaw _ reportRaw not.! !!ConfigureBoardMorph methodsFor: 'dropping/grabbing' stamp: 'KK 8/16/2013 17:29'!justDroppedInto: newOwner event: evt	"Only allow embedding into the stage; otherwise, float (i.e. be a submorph of the world)."	(newOwner isKindOf: ScratchStageMorph) ifFalse: [ "only embed in the work pane"		self world addMorph: self].! !!ConfigureBoardMorph methodsFor: 'object i/o' stamp: 'KK 8/16/2013 17:29'!fieldsVersion	^ 1! !!ConfigureBoardMorph methodsFor: 'object i/o' stamp: 'KK 8/16/2013 17:29'!initFieldsFrom: anObjStream version: classVersion	super initFieldsFrom: anObjStream version: classVersion.	anObjStream nextField.  "skip old portNum field"	self addReadouts.! !!ConfigureBoardMorph methodsFor: 'object i/o' stamp: 'KK 8/16/2013 17:29'!storeFieldsOn: anObjStream	super storeFieldsOn: anObjStream.	anObjStream putField: 1.  "old portNum instance variable"! !!ConfigureBoardMorph methodsFor: 'private' stamp: 'KK 8/16/2013 17:29'!ping	"Answer true if a GoGoBoard is connected to my serial port."	| buf |	port flushInputBuffer.	port nextPutAll: #(84 254 0) asByteArray.	buf _ port next: 3.	^ buf = #(85 255 170) asByteArray! !!ConfigureBoardMorph methodsFor: 'private' stamp: 'KK 8/16/2013 17:29'!processGoGoByte: aByte	"Process one byte of the incoming data stream from a GoGoBoard."	"Details: This code recognizes three-byte sensor update messages starting with 16r0C using a simple, three-state finite state machine. We assume that sensor updates are always contiguous--that is, replies to motor or other GoGo board commands will not be inserted between the bytes of any given three-byte sensor update message. The sensor number is the top three bits of the byte two. The data value is the bottom two bits of byte two plus all eight bits of byte three."	| sensorNum val |	currentState = #idle ifTrue: [ 		aByte = 16r0C ifTrue: [currentState _ #startByteSeen].		^ self].	currentState = #startByteSeen ifTrue: [		highByte _ aByte.		currentState _ #highByteSeen.		^ self].	currentState = #highByteSeen ifTrue: [		"final byte of message: report the sensor value"		sensorNum _ (highByte bitShift: -5) + 1.		val _ ((highByte bitAnd: 3) bitShift: 8) + aByte.		(sensorNum between: 1 and: 8) ifTrue: [			sensorValues at: sensorNum put: val].		currentState _ #idle].! !!ConfigureBoardMorph methodsFor: 'private' stamp: 'KK 8/16/2013 17:29'!processIncomingData	"Process incoming bytes from the serial port."	"Details: To work around a problem with the Prolific USB-Serial drivers on some Windows machines, a strict turn-taking polling protocol is used. A poll byte is sent, the ScratchBoard sends a response, and after a small delay (to be sure that all the data from the last poll has arrived, another poll is sent. The goal is to never allow more that few bytes to accumulate in the serial input buffer and to avoid sending a poll byte while data is arriving. However, since different versions of the ScratchBoard may send different amounts of data, we don't want to hard-code the number of reply bytes. Thus"	| buf msecsSinceLastPoll |	(self portIsOpen and: [#on = scanState]) ifFalse: [^ self].	useGoGoProtocol ifTrue: [		buf _ port readByteArray.		buf do: [:b | self processGoGoByte: b].		^ self].	msecsSinceLastPoll _ Time millisecondClockValue - lastPollMSecs.	msecsSinceLastPoll < 20 ifTrue: [^ self].	buf _ port readByteArray."Transcriptshow:'SensorBoardMorph::processIncomingData';cr."	" Corresponding disconnection  "	(buf size = 0)	ifTrue: [	" The case of disconnection "Transcriptshow:'reset port : ';show:ResetCounter;cr.		" Increment ResetCounter "		ResetCounter _ (ResetCounter + 1).		(ResetCounter = 10) ifTrue: [				ResetCounter _ 0.	" Initialize ResetCounter "			self resetPort.		" reset port. "		].	]	ifFalse: [ 	" The case of connection "		ResetCounter _ 0.		" Initialize ResetCounter "	].	buf do: [:b | self processScratchByte: b]."	port nextPut: 1."	"send a ScratchBoard V4 poll byte"	lastPollMSecs _ Time millisecondClockValue.! !!ConfigureBoardMorph methodsFor: 'private' stamp: 'KK 8/16/2013 17:29'!processScratchByte: aByte	"Process one byte of the incoming data stream from a Scratch sensor board."	"Sensor messages are two bytes with the following format:		Byte1: <1><sensor number (4 bits)><sensor value high bits (3 bits)>		Byte2: <0><sensor value low bits (7 bits)>"	| sensorNum val |"Transcriptshow:'processScratchByte';cr."	currentState = #idle ifTrue: [  "wait for first byte of message"		(aByte bitAnd: 16r80) > 0 ifTrue: [			currentState _ #firstByteSeen.			highByte _ aByte].		^ self].	currentState = #firstByteSeen ifTrue: [		(aByte bitAnd: 16r80) > 0 ifTrue: [  "must have lost second byte; stay in firstByteSeen state"			highByte _ aByte.			^ self].		"good second byte: report the sensor value"		sensorNum _ ((highByte bitShift: -3) bitAnd: 16rF) + 1.		val _ ((highByte bitAnd: 7) bitShift: 7) + (aByte bitAnd: 16r7F).		sensorNum <= sensorValues size ifTrue: [			sensorValues at: sensorNum put: val.			sensorNum = 16 ifTrue: [				(val == 3) | (val == 4) ifTrue: [					scratchBoardV3 _ true]]].  "ScratchBoard, version 3 or 4"		currentState _ #idle].! !!ConfigureBoardMorph methodsFor: 'private' stamp: 'KK 8/16/2013 17:29'!scaleLight: val	val <= 25 ifTrue: [^ 100 - val].	^ ((1023 - val) * (75.0 / 998)) rounded! !!ConfigureBoardMorph methodsFor: 'private' stamp: 'KK 8/16/2013 17:29'!scaleSound: val	| n |	n _ ((val - 18) max: 0) min: 630.	n < 50 ifTrue: [^ n / 2.0].  "0 to 25"	^ 25.0 + ((n - 50) * (75.0 / 580.0))! !!ConfigureBoardMorph methodsFor: 'private' stamp: 'KK 8/16/2013 17:29'!startStreamingSensors: sensorByte	"Begin streaming data from the set of sensors specified by the bits of the given byte. Invoke this method with 0 to stop streaming. Incoming sensor data is processed by frequent calls to processIncomingData."	| cmd |	useGoGoProtocol ifFalse: [^ self].	port flushInputBuffer.	cmd _ #(84 254 160 0) asByteArray.	cmd at: 4 put: sensorByte.	port nextPutAll: cmd.! !!ConfigureBoardMorph methodsFor: 'private' stamp: 'KK 8/16/2013 17:29'!updateTitle	"Update my title to reflect the current protocol and port number."	| s |	s _ (#on = scanState) ifTrue: ['On' localized] ifFalse: ['Off' localized].	s = titleMorph contents ifFalse: [titleMorph contents: s].! !!DialogBoxMorph methodsFor: 'geometry' stamp: 'KK 9/21/2013 15:08'!fixLayoutForExtent: aPoint	| xPos yPos shortcutWidth |	shortcutColumn ifNil: [^ self].	xPos _ self left + 20.	yPos _ self top + 40.	"position and size the shortcut column"	shortcutColumn position: xPos@yPos.	shortcutWidth _ 0.	shortcutColumn submorphsDo: [: m |		shortcutWidth _ m width max: shortcutWidth].	shortcutColumn submorphsDo: [: m |		m width: shortcutWidth].	"position main column"	mainColumn position: (shortcutColumn right + 5)@yPos.	"position and size the fileInfo column""	fileInfoColumn position: (mainColumn right + 5)@yPos.	fileColumnWidth _ 0.	fileInfoColumn submorphsDo: [: m |		fileColumnWidth _ m width max: fileColumnWidth].	fileInfoColumn submorphsDo: [: m |		(m isKindOf: StringMorph)			ifFalse: [m width: fileColumnWidth]]."	"position and size title"	titleBin left: self left.	titleBin width: shortcutColumn width + mainColumn width + fileInfoColumn width + 55.	"add a bottom spacer to the tallest column"	bottomSpacer ifNil: [		bottomSpacer _ (Morph new extent: (5@22); color: Color transparent).		(shortcutColumn height > mainColumn height)			ifTrue: [shortcutColumn addMorphBack: bottomSpacer]			ifFalse: [(mainColumn height > fileInfoColumn height)				ifTrue: [mainColumn addMorphBack: bottomSpacer]				ifFalse: [fileInfoColumn addMorphBack: bottomSpacer]]].! !!DialogBoxMorph methodsFor: 'geometry' stamp: 'sk 2/6/2017 11:31'!topCenterOnScreen	"Center myself on the screen, if possible. Otherwise, adjust position so buttons are visible."	| w |	w _ self world.	self extent: self extent.  "force layout"	self position: ((w width // 2) - (self width // 2))@5.  "top center on screen but disregard the shadow on the bottom"	self bottom > w bottom ifTrue: [		self bottom: w bottom + 37.  "make sure cancel button is on screen"		self top > -2 ifTrue: [self top: -2]]. "make top flush with the top of the screen"	(self top < -2 and: [self top > -34]) ifTrue: [		"if title bar partway off screen, move it all the way off"		self top: -34].! !!DividedImageFrameMorph methodsFor: 'initialize' stamp: 'KK 4/18/2014 12:38'!initFrontFromForm2: aForm topSectionHeight: aNumber	| w h |	super initFrontFromForm: aForm.	topSectionHeight _ aNumber.	leftMargin _ 0.	rightMargin _ 0.	middleBarForm _ ScratchFrameMorph skinAt: #dividedImageFrameBar2.	w _ (middleBarForm width // 2) + 2.	h _ middleBarForm height.	leftJointForm _ middleBarForm copy: (0@0 extent: w@h).	rightJointForm _ middleBarForm copy: ((middleBarForm width - w) @ 0 extent: w@h).! !!DividedImageFrameMorph methodsFor: 'initialize' stamp: 'KK 4/18/2014 12:31'!initFrontFromForm: aForm topSectionHeight: aNumber	| w h |	super initFrontFromForm: aForm.	topSectionHeight _ aNumber.	leftMargin _ 0.	rightMargin _ 0.	middleBarForm _ ScratchFrameMorph skinAt: #dividedImageFrameBar.	w _ (middleBarForm width // 2) + 2.	h _ middleBarForm height.	leftJointForm _ middleBarForm copy: (0@0 extent: w@h).	rightJointForm _ middleBarForm copy: ((middleBarForm width - w) @ 0 extent: w@h).! !!DividedImageFrameMorph methodsFor: 'accessing' stamp: 'ee 10/30/2008 13:37'!middleBarLeftMargin: aNumber rightMargin: aNumber2	leftMargin _ aNumber.	rightMargin _ aNumber2.! !!DividedImageFrameMorph methodsFor: 'drawing' stamp: 'ee 1/28/2009 16:11'!drawDividerOn: aCanvas	"Draw my divider edge."	| w r f slice |	w _ self width - (leftJointForm width + rightJointForm width) - leftMargin - rightMargin.	r _ ((self left + leftJointForm width + leftMargin) @ (self top + topSectionHeight - 4))		extent: (w @ middleBarForm height).	f _ edgeCache at: 5.	(f isNil or: [f extent ~= r extent]) ifTrue: [		f _ Form extent: r extent depth: 32.		slice _ middleBarForm copy: (((middleBarForm width // 2) @ 0) extent: (1 @ r height)).		0 to: r width by: slice width do: [:x | slice displayOn: f at: x@0 rule: Form blend].		edgeCache at: 5 put: f].	aCanvas translucentImage: f at: r topLeft.! !!DividedImageFrameMorph methodsFor: 'drawing' stamp: 'ee 1/28/2009 16:11'!drawFrameOn: aCanvas	super drawFrameOn: aCanvas.	self drawDividerOn: aCanvas.	"draw middle bar left and right joints"	aCanvas		translucentImage: leftJointForm		at: self topLeft + (leftMargin@(topSectionHeight-4)).	aCanvas		translucentImage: rightJointForm		at: (self right - rightJointForm width - rightMargin) @ (self top + topSectionHeight - 4).! !!EventTitleMorph methodsFor: 'accessing' stamp: 'KK 8/2/2013 12:59'!printArduArgOn: aStream	"Print this argument morph on the given stream."	aStream nextPut: $".	aStream nextPutAll: self labelMorph contents.	aStream nextPut: $".! !!EventTitleMorph methodsFor: 'accessing' stamp: 'KK 8/2/2013 13:00'!printArgOn: aStream	"Print this argument morph on the given stream."	aStream nextPutAll: self labelMorph contents.! !!EventTitleMorph methodsFor: 'queries' stamp: 'sk 9/21/2016 15:59'!acceptsDroppedReporters	"Accept reporter blocks in broadcast blocks but not in 'when I receive' hat block."	^ false! !!EventTitleMorph methodsFor: 'event handling' stamp: 'sk 9/21/2016 19:27'!handlesMouseDown: evt	^ evt hand toolType isNil and:		[(self topLeft corner: self bottomRight) containsPoint: evt cursorPoint]! !!EventTitleMorph methodsFor: 'event handling' stamp: 'sk 3/22/2017 18:40'!presentMenu	"Pop up a menu of choices."	| eventNames sFrame menu choice s |	eventNames _ #().	(sFrame _ self ownerThatIsA: ScratchFrameMorph)		ifNotNil: [eventNames _ sFrame workPane allEventNames].	menu _ CustomMenu new.	eventNames do: [:n | menu add: n action: n asString].	menu addLine.	menu add: ('new' localized, ScratchTranslator ellipsesSuffix) action: #newEvent.	(choice _ menu startUp) ifNil: [^ self].	choice == #newEvent ifTrue: [		TabletMode ifTrue: [			sFrame sendMessageToBMnoBlocking: 'SHOWKEYPAD'].		ValueOrList _ true.		s _ StringDialog ask: 'Function name:(Only alphanumeric characters are allowed)'.		TabletMode ifTrue: [			sFrame sendMessageToBMnoBlocking: 'HIDEKEYPAD'].		s size = 0 ifTrue: [^ self].		^ self eventName: s].	self eventName: choice.! !!ExpressionArgMorph methodsFor: 'accessing' stamp: 'KK 9/18/2013 19:15'!defaultValue: anObject	anObject isNumber ifTrue: [self numExpression: anObject].	(anObject isKindOf: String) ifTrue: [self stringExpression: anObject].! !!ExpressionArgMorph methodsFor: 'accessing' stamp: 'KK 5/1/2014 17:10'!numExpression: aNumber	isNumber _ true.	labelMorph isNumeric: true.	aNumber isFloat		ifTrue: [labelMorph contents: aNumber printStringNoExponent]		ifFalse: [labelMorph contents: aNumber asString].	self fixArgLayout.! !!ExpressionArgMorphWithMenu methodsFor: 'accessing' stamp: 'sk 2/10/2017 16:53'!menuSelector: menuSelector	| scale |	"Add a drop-down menu button with the given selector. The selector should result in a menu whose action items are values that can be put into this type argument, typically numbers or strings."	scale _ ScratchTranslator renderScale rounded.	menuMorph _ ImageMorph new form: (DropDownMenuForm magnifyBy: scale).	getMenuSelector _ menuSelector.	self addMorphFront: menuMorph.	self fixArgLayout.! !!ExpressionArgMorphWithMenu methodsFor: 'event handling' stamp: 'sk 1/26/2017 12:57'!mouseDown: evt	| rcvr menu choice frame kw vPos |	menuMorph ifNil: [^ super mouseDown: evt].	(evt cursorPoint x < (menuMorph left - 1)) ifTrue: [^ super mouseDown: evt].	(getMenuSelector notNil and:	 [(owner isKindOf: BlockMorph) and: 	 [(rcvr _ owner receiver) notNil]]) ifFalse: [^ self beep].	menu _ rcvr perform: getMenuSelector.	(menu isKindOf: ScratchNoteSelector) ifTrue: [		"menu position: owner bottomLeft + (((owner width - menu width) // 2) @ -4)"		frame _ owner ownerThatIsA: ScratchFrameMorph.		kw _ (frame width * 0.04) truncated.		menu buildKeyboard: 2 baseOctave: 4 keyWidth: kw.		menu setUpNoteDisplay: (20 * kw // 13).		vPos _ owner bottom -4.		(vPos + (menu extent y)) > frame height ifTrue: [			vPos _ owner top + 4 - (menu extent y)].		menu position: ((frame width - menu width) // 2) @ vPos].	choice _ menu startUp.	choice ifNil: [^ self].	evt hand newKeyboardFocus: nil.  "close mini-editor, if any"	(#(listIndexMenu listIndexForDeleteMenu) includes: getMenuSelector) ifTrue: [		^ self specialValue: choice].	isNumber		ifTrue: [self numExpression: choice]		ifFalse: [self stringExpression: choice].! !!ExpressionArgMorphWithMenu methodsFor: 'private' stamp: 'sk 2/10/2017 16:36'!fixArgLayout	| dx |	dx _ 9 * (ScratchTranslator renderScale).	super fixArgLayout.	menuMorph ifNil: [^ self].	self width: self width + dx.	menuMorph position: (self right - dx - 2)@(self top + (self height // 3)).	(thisContext sender receiver isKindOf: StringFieldMorph) ifTrue: [		"clear only when user edit my label, but not on other arg layout changes"		specialValue _ nil].! !!HatBlockMorph methodsFor: 'private' stamp: 'sk 3/16/2017 17:46'!fixBlockLayout	"Update the positions of my submorphs."	| x centerY nextB nonBlockSubmorphs oldExtent oldPos |	blockLayoutNeeded ifFalse: [^ self].	super fixBlockLayout.	oldExtent _ self extent.	oldPos _ self position.	ScratchTranslator isRTL		ifTrue: [x _ self right - 8]		ifFalse: [x _ self left + 8].	centerY _ self top + 3 + ((self height) // 2).	self nonControlFlowSubmorphs do: [:m |		(m isKindOf: ArgMorph) ifTrue: [m fixArgLayout].		ScratchTranslator isRTL			ifTrue: [m position: (x - m width)@(centerY - (m height // 2)). 				x _ x - m width - 5]			ifFalse: [m position: x@(centerY - (m height // 2)). 				x _ x + m width + 5]].	ScratchTranslator isRTL		ifTrue: [x _ x - 4.			self width: ((self right - x) max: self hatTopForm width)]		ifFalse: [x + x + 4.			self width: ((x - self left) max: self hatTopForm width)].	ScratchTranslator isRTL ifTrue: [		self left: oldPos x + (oldExtent x - self width)].	nonBlockSubmorphs _ self submorphs select: [:m |		(m isKindOf: BlockMorph) not or: [m isKindOf: ArgMorph]].	self height: self hatTopForm height + (nonBlockSubmorphs inject: CBlockBracketThickness into: [:h :m | h max: (m height + 8)]).	(nextB _ self nextBlock) ifNotNil: [		ScratchTranslator isRTL			ifTrue: [nextB right: self right]			ifFalse: [nextB left: self left].		nextB top: self bottom - 4.		nextB fixBlockLayout].! !!HatBlockMorph methodsFor: 'private' stamp: 'sk 5/20/2016 21:22'!printArduCodeOn: aStream indent: indent	"Append a human-readable string for this block on the given stream."	indent timesRepeat: [aStream nextPutAll: '    '].	self printArduHatNameOn: aStream.	self nextBlock ifNotNil: [self nextBlock printArduCodeOn: aStream indent: indent + 1].	indent timesRepeat: [aStream nextPutAll: '    '].		(BoardType = 1) ifTrue: [	((IOPort at:19) = 6) ifTrue: [		(indent + 1) timesRepeat: [aStream nextPutAll: '    '].		aStream nextPutAll: 'board.sleep();'; cr].].	aStream nextPutAll: '}'; cr.! !!EventHatMorph methodsFor: 'initialization' stamp: 'KK 11/16/2017 10:37'!forStartEvent	| t1 t2 t3 |	super initialize.	self removeAllMorphs.	t1 _ ScratchTranslator labelPartsFor: '%m Start'.	t2 _ StringMorph new contents: t1 first;			 font: (ScratchFrameMorph getFont: #Label);			 color: Color white.	self addMorphBack: t2.	t3 _ ImageMorph new form: (ScratchFrameMorph skinAt: #goButton).	self addMorphBack: t3.	t2 _ t2 fullCopy contents: t1 second.	self addMorphBack: t2.	scriptNameMorph _ EventTitleMorph new eventName: 'Scratch-StartClicked'.	self fixBlockLayout! !!EventHatMorph methodsFor: 'initialization' stamp: 'KK 10/18/2013 13:31'!initialize	| parts label |	super initialize.	self removeAllMorphs.	parts _ ScratchTranslator labelPartsFor: '%e function'.	parts first size > 0 ifTrue: [		label _ StringMorph contents: parts first font: (ScratchFrameMorph getFont: #Label).		label color: Color white.		self addMorphBack: label].	scriptNameMorph _ EventTitleMorph new.	self addMorphBack: scriptNameMorph.	parts second size > 0 ifTrue: [		label _ (StringMorph contents: parts second font: (ScratchFrameMorph getFont: #Label)) color: Color white.		self addMorphBack: label].! !!EventHatMorph methodsFor: 'other' stamp: 'KK 9/2/2013 10:23'!printArduHatNameOn: aStream	"Append a human-readable string for this hat block's name to the given stream."	| evtName |	evtName _ self eventName.	evtName = 'Scratch-StartClicked'		ifTrue: [			aStream nextPutAll: '// ---------------------------------------'; cr.			aStream nextPutAll: '// Artec robot mainroutine'; cr.			aStream nextPutAll: '// ---------------------------------------'; cr.			aStream nextPutAll: 'void artecRobotMain() {'		]		ifFalse: [			aStream nextPutAll: '// ---------------------------------------'; cr.			aStream nextPutAll: '// Artec robot subroutine'; cr.			aStream nextPutAll: '// ---------------------------------------'; cr.			aStream nextPutAll: 'void ARSR_', evtName, '() {'		].	aStream cr.! !!EventHatMorph methodsFor: 'event handling' stamp: 'KK 9/23/2013 21:11'!rightButtonMenu	| evtName |	"Handle invalid rightButtonMenu of Start Hat Morph "	evtName _ self eventName.	evtName = 'Scratch-StartClicked'		ifTrue: [	" when green flag clicked ""			super rightButtonMenu."		]		ifFalse: [	" when I receive "			super rightButtonMenu.		].! !!EventHatMorph methodsFor: 'dropping/grabbing' stamp: 'KK 9/23/2013 17:35'!justDroppedInto: newOwner event: evt	| evtName |	"Handle being dropped into a new situation.""Transcript show:'[EventHatMorph::justDroppedInto: event:]';show: newOwner;show: ', ';show: evt;cr."	evtName _ self eventName.	evtName = 'Scratch-StartClicked'		ifTrue: [	" when green flag clicked "			"blocks cannot be dropped onto the palette"			(owner isKindOf: ScratchBlockPaletteMorph) ifTrue: [				self rejectDropEvent: evt			]			ifFalse: [				super justDroppedInto: newOwner event: evt			].		]		ifFalse: [	" when I receive "			super justDroppedInto: newOwner event: evt		].! !!I2CAssignMorph methodsFor: 'initialization' stamp: 'KK 1/5/2015 16:21'!addPACheckBox: area pinNames: pn	"Add a readout row with the given label. Answer the stringmorph that's the readout."	| row b temporary |	temporary _ OrderedCollection new.	pn do: [:pin |		row _ AlignmentMorph newRow color: area color; hResizing: #rigid; extent:45@30.		b _ ToggleButtonForStuduino			onForm: (ScratchFrameMorph skinAt: #watcherButtonPressed)			offForm: (ScratchFrameMorph skinAt: #watcherButton)			disabledForm: (ScratchFrameMorph skinAt: #watcherButton).		b actWhen: #buttonDown.		row addMorph:b.		row addMorphBack: (Morph new color: area color; extent: 5@3).  "spacer"		row addMorphBack: (StringMorph contents: pin font: (StrikeFont fontName: 'VerdanaBold' size: 12)).		area addMorphBack:row.		temporary add: row.	].	^ temporary.! !!I2CAssignMorph methodsFor: 'initialization' stamp: 'KK 1/6/2015 13:36'!addReadouts	| |	" Make all alignment column "	column _ AlignmentMorph newColumn		centering: #center;		color: (Color r: (240/255) g: (240/255) b: (240/255));		borderWidth: 2;		borderColor: (Color r: (148/255) g: (145/255) b: (145/255));		useRoundedCorners;		inset: 3.	" Make title morph and add column and update "	titleMorph _ StringMorph		contents: ''		font: (StrikeFont fontName: 'VerdanaBold' size: 12).	column addMorph: titleMorph.	self updateTitle.	column addMorphBack: (Morph new color: column color; extent: 5@3).  "spacer"	self removeAllMorphs.	" Make I2C device assign space "	i2cPAArea _ AlignmentMorph newRow color: column color.	column addMorphBack: i2cPAArea.	self updateI2CDeviceSelectorArea.	column position: self position - 2.	self addMorph: column.	self extent: column extent - 4.! !!I2CAssignMorph methodsFor: 'initialization' stamp: 'KK 9/25/2017 14:38'!initialize	super initialize.	pinInfo _ Array new: 2.	pinAssignTemporary _ Array new: 18.	self addReadouts.! !!I2CAssignMorph methodsFor: 'accessing' stamp: 'KK 1/5/2015 16:21'!exclusiveControlDC: dc servo1: sv1 servo2: sv2	| dcCB sv1CB sv2CB sv1Title sv2Title |	"comment stating purpose of message"	dcCB _ dc findA: ToggleButtonForStuduino.	" DC motor Toggle button "	sv1CB _ sv1 findA: ToggleButtonForStuduino.	" Servomotor1 Toggle button "	sv2CB _ sv2 findA: ToggleButtonForStuduino.	" Servomotor2 Toggle button "	sv1Title _ sv1 findA: StringMorph.			" Servomotor1 String morph "	sv2Title _ sv2 findA: StringMorph.			" Servomotor2 String morph "	(dcCB isOn) ifTrue: [		" DC motor Toggle button ON "		sv1CB isDisabled: true.	" Servomotor1 Disable "		sv1Title color: (Color gray).		sv2CB isDisabled: true.	" Servomotor2 Disable "		sv2Title color: (Color gray).	]	ifFalse: [		" DC motor Toggle button OFF "		sv1CB isDisabled: false.	" Servomotor1 Enable "		sv1Title color: (Color black).		sv2CB isDisabled: false.	" Servomotor2 Enable "		sv2Title color: (Color black).	].! !!I2CAssignMorph methodsFor: 'accessing' stamp: 'KK 1/5/2015 16:21'!exclusiveControlServo: sv1 servo2: sv2 dcMotor: dc	| sv1CB sv2CB dcCB dcTitle |	sv1CB _ sv1 findA: ToggleButtonForStuduino.	" Servo1 Toggle button "	sv2CB _ sv2 findA: ToggleButtonForStuduino.	" Servo2 Toggle button "	dcCB _ dc findA: ToggleButtonForStuduino.	" DC motor Toggle button "	dcTitle _ dc findA: StringMorph.				" DC motor String morph "	((sv1CB isOn) | (sv2CB isOn)) ifTrue: [		" Servo1 or Servo2 Toggle button ON "		dcCB isDisabled: true.		" DC motor Disable "		dcTitle color: (Color gray).	]	ifFalse: [		" Servo1 and Servo2 Toggle button OFF "		dcCB isDisabled: false.		" DC motor Enable "		dcTitle color: (Color black).	].! !!I2CAssignMorph methodsFor: 'accessing' stamp: 'KK 1/5/2015 16:21'!exclusiveSensor: s1 sensor: s2	| s1CB s2CB s2Title |	s1CB _ s1 findA: ToggleButtonForStuduino.		" Action side pin Toggle button "	s2CB _ s2 findA: ToggleButtonForStuduino.	" Reaction side pin Toggle button "	s2Title _ s2 findA: StringMorph.				" Reaction side pin String morph "	(s1CB isOn) ifTrue: [		" Action side pin Toggle button ON "		s2CB isDisabled: true.	" Reaction side pin Disable "		s2Title color: (Color gray).	]	ifFalse: [		"Action side pin Toggle button OFF "		s2CB isDisabled: false.	" Reaction side pin Enable "		s2Title color: (Color black).	].! !!I2CAssignMorph methodsFor: 'accessing' stamp: 'KK 1/5/2015 16:21'!getPortName	" Return port name. "	^ self portNames.! !!I2CAssignMorph methodsFor: 'accessing' stamp: 'KK 1/5/2015 16:21'!isScriptable	"I am not scriptable."	^ false! !!I2CAssignMorph methodsFor: 'accessing' stamp: 'KK 1/5/2015 16:21'!notifyI2CDeviceSelect: aSet 	| a4 a5 a4CB a5CB |	" ---------------------------------- "	"	A4 Pin (Sensor side)	"	" ---------------------------------- "	(aSet == (pinInfo at:19)) ifTrue: [		a5 _ pinInfo at:20.		a5CB _ a5 findA: ChoiceArgMorphForStuduino.	" A5 pin Toggle button "		a5CB choiceI2CDevice.	].	" ---------------------------------- "	"	A5 Pin (Sensor side)	"	" ---------------------------------- "	(aSet == (pinInfo at:20)) ifTrue: [		a4 _ pinInfo at:19.		a4CB _ a4 findA: ChoiceArgMorphForStuduino.	" A4 pin Toggle button "		a4CB choiceI2CDevice.	].! !!I2CAssignMorph methodsFor: 'accessing' stamp: 'KK 1/5/2015 16:21'!notifyNotI2CDeviceSelect: aSet 	| a4 a5 a4CB a5CB |	" ---------------------------------- "	"	A4 Pin (Sensor side)	"	" ---------------------------------- "	(aSet == (pinInfo at:19)) ifTrue: [		a5 _ pinInfo at:20.		a5CB _ a5 findA: ChoiceArgMorphForStuduino.	" A5 pin Toggle button "		a5CB choiceLightSensor.	].	" ---------------------------------- "	"	A5 Pin (Sensor side)	"	" ---------------------------------- "	(aSet == (pinInfo at:20)) ifTrue: [		a4 _ pinInfo at:19.		a4CB _ a4 findA: ChoiceArgMorphForStuduino.	" A4 pin Toggle button "		a4CB choiceLightSensor.	].! !!I2CAssignMorph methodsFor: 'accessing' stamp: 'KK 1/5/2015 16:21'!setAllOff	| cb |	" Set all checkbox off. "	pinInfo do: [ :pin |		cb _ pin findA: ToggleButtonForStuduino.	" Toggle button "		cb off.	].! !!I2CAssignMorph methodsFor: 'accessing' stamp: 'KK 1/7/2015 15:14'!setCheckBox: portNumber partsID: pID	| set cb |	" Set checkbox "	" If port connect nothing, do nothing. "	(pID = StdnoPIDOpen) ifTrue: [ ^ self. ].	" connect with something... "	set _ pinInfo at:portNumber.	" If the port connect with I2C device. "	cb _ set findA: ToggleButtonForStuduino.	" Toggle button "	cb on.! !!I2CAssignMorph methodsFor: 'accessing' stamp: 'KK 1/5/2015 16:21'!setFrameMorph: frame	" Set frame moprh. "	frameMorph _ frame.! !!I2CAssignMorph methodsFor: 'accessing' stamp: 'KK 1/5/2015 16:21'!toggleA0Action: act influence: inf	"comment stating purpose of message"! !!I2CAssignMorph methodsFor: 'interaction' stamp: 'KK 1/5/2015 16:21'!returnPinAssignInfo	| index |	"Return pin assignment from temporary buffer"		index _ 1.	pinAssignTemporary do: [ :parts |		self setCheckBox: index partsID:parts.		index _ index + 1.	].! !!I2CAssignMorph methodsFor: 'interaction' stamp: 'KK 1/5/2015 16:21'!savePinAssignInfo	"Set pin assignment to IOPort"		self setPinAssignInfo: pinAssignTemporary.! !!I2CAssignMorph methodsFor: 'interaction' stamp: 'KK 1/6/2015 17:08'!setPinAssignInfo: buf	"Set pin assignment"		| cb set |	" Initialize buf array "	1 to: (buf size) do: [:num |		buf at:num put:0.	].	" Set buf information "	1 to: (pinInfo size) do: [:index |		set _ pinInfo at:index.		cb _ set findA: ToggleButtonForStuduino.	" Toggle button "		(index = 1) ifTrue: [		" Accelerometer "			(cb isOn) ifTrue: [buf at:index put:StdnoPIDAcceleration.]		].		(index = 2) ifTrue: [		" Gyro "			(cb isOn) ifTrue: [buf at:index put:StdnoPIDGyro.]		].	].! !!I2CAssignMorph methodsFor: 'sensor ops' stamp: 'KK 1/5/2015 16:21'!privateSensor: sensorIndex	"Read the virtual sensor with the given index permuted according to which Scratch board is plugged in and scaled if it is a known special sensor such as the light or sound sensor. If reportRaw is true then the raw sensor value (0..1023) is reported."	"This method does not call processIncomingData. It should only be used by the step method."	| i raw |	"map the sensor index to the corresponding channel"	i _ (sensorIndex asInteger max: 1) min: readouts size."	useGoGoProtocol ifFalse: [		scratchBoardV3			ifTrue: [i _ #(8 6 7 4 5 3 2 1) at: i] 			ifFalse: [i _ #(5 6 7 8 1 2 3 4) at: i]]."	raw _ sensorValues at: i.	reportRaw _ true.	" return Rawdata surely. "	reportRaw ifTrue: [^ raw].	" Following code unexecuted in which "	scratchBoardV3 ifTrue: [		i = 6 ifTrue: [^ self scaleLight: raw].		i = 7 ifTrue: [^ self scaleSound: raw]].	raw > 1020 ifTrue: [raw _ 1023].  "avoids jitter in the range 1021-1023"	^ (100.0 * raw) / 1023.0  ! !!I2CAssignMorph methodsFor: 'sensor ops' stamp: 'KK 1/5/2015 16:21'!sensor: sensorIndex	"Answer the value of the virtual sensor with the given index. Sensors are numbered 1-8."	^ self privateSensor: sensorIndex! !!I2CAssignMorph methodsFor: 'sensor ops' stamp: 'KK 1/5/2015 16:21'!startReadingData	"Ensure that the serial port is open, turn off all motors and put them into a known state, and begin streaming sensor data."	self portIsOpen ifFalse: [^ self].  "could not open the serial port"	currentState _ #idle."	sensorValues atAllPut: 0."	scratchBoardV3 _ false.	self startStreamingSensors: 0.  "in case board was left in streaming mode"	port flushInputBuffer.	useGoGoProtocol ifTrue: [		1 to: 6 do: [:motor |			self turnOffMotor: motor.			self thisWayMotor: motor.			self setPower: 3 motor: motor.			self turnOffMotor: motor].		self startStreamingSensors: 16rFF].  "all 8 sensors"! !!I2CAssignMorph methodsFor: 'sensor ops' stamp: 'KK 1/5/2015 16:21'!stopReadingData	"Turn off all motors, stop streaming data, and close the port."	(port notNil and: [port isOpen]) ifTrue: [		useGoGoProtocol ifTrue: [			1 to: 6 do: [:motor | self turnOffMotor: motor].			self startStreamingSensors: 0]].  "turn off streaming"	self closePort.! !!I2CAssignMorph methodsFor: 'motor ops' stamp: 'KK 1/5/2015 16:21'!coastToStopMotor: motorNum	"Let the given motor coast to a stop."	self portIsOpen ifFalse: [^ self].	self selectMotor: motorNum.	port nextPutAll: #(84 254 84) asByteArray.! !!I2CAssignMorph methodsFor: 'motor ops' stamp: 'KK 1/5/2015 16:21'!reverseMotor: motorNum	"Reverse the direction of the given motor."	self portIsOpen ifFalse: [^ self].	self selectMotor: motorNum.	port nextPutAll: #(84 254 72) asByteArray.! !!I2CAssignMorph methodsFor: 'motor ops' stamp: 'KK 1/5/2015 16:21'!selectMotor: anInteger	"Select the motor to which subsequent motor commands will be addressed. Motors are numbered 1-6."	| motorNum msg |	motorNum _ (anInteger truncated - 1 max: 0) min: 7. "motor bit index"	msg _ #(84 254 128 0) asByteArray.	msg at: 4 put: (1 bitShift: motorNum).	port nextPutAll: msg.! !!I2CAssignMorph methodsFor: 'motor ops' stamp: 'KK 1/5/2015 16:21'!setPower: aNumber motor: motorNum	"Set the power of the given motor to 0 to 7."	| power msg |	self portIsOpen ifFalse: [^ self].	self selectMotor: motorNum.	power _ (aNumber truncated max: 0) min: 7.	msg _ #(84 254 0) asByteArray.	msg at: 3 put: 96 + (power bitShift: 2).	port nextPutAll: msg.! !!I2CAssignMorph methodsFor: 'motor ops' stamp: 'KK 1/5/2015 16:21'!thatWayMotor: motorNum	"Set motor direction to that way."	self portIsOpen ifFalse: [^ self].	self selectMotor: motorNum.	port nextPutAll: #(84 254 80) asByteArray.! !!I2CAssignMorph methodsFor: 'motor ops' stamp: 'KK 1/5/2015 16:21'!thisWayMotor: motorNum	"Set motor direction to this way."	self portIsOpen ifFalse: [^ self].	self selectMotor: motorNum.	port nextPutAll: #(84 254 76) asByteArray.! !!I2CAssignMorph methodsFor: 'motor ops' stamp: 'KK 1/5/2015 16:21'!turnOffMotor: motorNum	self portIsOpen ifFalse: [^ self].	self selectMotor: motorNum.	port nextPutAll: #(84 254 68) asByteArray.! !!I2CAssignMorph methodsFor: 'motor ops' stamp: 'KK 1/5/2015 16:21'!turnOnMotor: motorNum	self portIsOpen ifFalse: [^ self].	self selectMotor: motorNum.	port nextPutAll: #(84 254 64) asByteArray.! !!I2CAssignMorph methodsFor: 'stepping' stamp: 'KK 1/5/2015 16:21'!step	"Update my title and sensor readouts. If scanning for ports, keep scanning."	| |	#checkData = scanState ifTrue: [self scanForPort]."	self portIsOpen		ifTrue: [self processIncomingData]		ifFalse: [port _ nil]."	self updateTitle."	1 to: readouts size do: [:i |		(readouts at: i) contents: (self privateSensor: i) truncated printString.		(scratchBoardV3 and: [i = 4])			ifTrue: [(readouts at: i) contents: ((self privateSensor: i) < 10) printString].		frame _ (readouts at: i) owner.		(frame respondsTo: #fixLayout) ifTrue: [frame fixLayout]]."! !!I2CAssignMorph methodsFor: 'stepping' stamp: 'KK 1/5/2015 16:21'!stepTime	^ 50! !!I2CAssignMorph methodsFor: 'serial port' stamp: 'KK 1/5/2015 16:21'!closePort	port ifNotNil: [		self partsID: 7 high:0 middle:0 low:0.		port flushInputBuffer.		port close].	port _ nil."	currentState _ #idle.	sensorValues atAllPut: 0.	scratchBoardV3 _ false.	1 to: readouts size do: [:i | (readouts at: i) contents: '0'].	scanState _ #off.	self step."! !!I2CAssignMorph methodsFor: 'serial port' stamp: 'KK 1/5/2015 16:21'!openPort: aString	"Close the serial port if it is open, then open the port with the given name and initialize streaming of sensor data. Answer true if the operation was successful."	| baudRate portNum numStart  |	baudRate _ useGoGoProtocol ifTrue: [9600] ifFalse: [38400].	self closePort.	portName _ aString.	ScratchPlugin serialPortOpsAvailable		ifTrue: [			port _ SerialPort2 new openPortNamed: portName baud: baudRate.			port isOpen ifFalse: [port _ nil. ^ false].			port setOption: 20 to: 1.  "set DTR high"			port setOption: 21 to: 0]  "set RTS low"		ifFalse: [			portNum _ 1.			numStart _ (1 to: portName size) detect: [:i | (portName at: i) isDigit] ifNone: [0].			numStart > 0 ifTrue: [portNum _ (portName copyFrom: numStart to: portName size) asNumber].			port _ SerialPort new				baudRate: baudRate;				inputFlowControlType: 2;				openPort: portNum ifFail: [^ false]].	"initialize polling state"	lastPollMSecs _ Time millisecondClockValue.	^ true! !!I2CAssignMorph methodsFor: 'serial port' stamp: 'KK 1/5/2015 16:21'!partsID: id high: dh middle: dm low: dl	"I make message and send it to board."	| msg1 msg2 msg3 msg4 msg |	Transcript show:'SensroBoardMorph::partsID: high: middle: low:';cr.	(self portIsOpen) ifFalse: [ ^0. ].	msg1 _ id bitOr: 16rC0.	msg2 _ (dh bitAnd: 16r3F) bitOr: 16r80.	msg3 _ (dm bitAnd: 16r3F) bitOr: 16r40.	msg4 _ (dl bitAnd: 16r3F).	msg _ #(0 0 0 0) asByteArray.	msg at: 1 put: msg1.	msg at: 2 put: msg2.	msg at: 3 put: msg3.	msg at: 4 put: msg4.	Transcript 		show:(msg at:1); show:', ';		show:(msg at:2); show:', ';		show:(msg at:3); show:', ';		show:(msg at:4); show:', ';		cr.	port nextPutAll: msg.! !!I2CAssignMorph methodsFor: 'serial port' stamp: 'KK 1/5/2015 16:21'!portIsOpen	^ port notNil and: [port isOpen]! !!I2CAssignMorph methodsFor: 'serial port' stamp: 'KK 1/5/2015 16:21'!portNames	"Answer a collection of possible port names for the Scratch sensor board. Filter out modems and PDA cradles."	ScratchPlugin serialPortOpsAvailable ifFalse: [		^ (1 to: 32) collect: [:i | 'COM', i printString]].	^ SerialPort2 portNames reject: [:n |		(n asLowercase includesSubString: 'modem') or:		[n asLowercase includesSubString: 'pda-sync']].! !!I2CAssignMorph methodsFor: 'serial port' stamp: 'KK 1/5/2015 16:21'!readFromPort	"receive data"	| buf |	buf _ port readByteArray.	port flushInputBuffer.	^ buf.! !!I2CAssignMorph methodsFor: 'serial port' stamp: 'KK 1/5/2015 16:21'!readFromPort: time	" receive data with timeout. "	" argument time is msec. "	| buf pollMSecs msecsSincePoll |	pollMSecs _ Time millisecondClockValue.	" Get current time. "	msecsSincePoll _ 0.	[msecsSincePoll < time] whileTrue:[		msecsSincePoll _ Time millisecondClockValue - pollMSecs.	" Updtate counter. "		" Read buffer and if there is data, return data. "		buf _ port readByteArray.		(buf size > 0) ifTrue: [			port flushInputBuffer.			^ buf.		].	].	" Time over "	^ nil.! !!I2CAssignMorph methodsFor: 'serial port' stamp: 'KK 1/5/2015 16:21'!scanForPort	"Try to find the serial port that the sensor board is attached to. This is incremental--each time it is called it does the next task."	"Details: scanState is one of: #(off, start, checkData, on). scanPorts is a list of port names to try. Attempt to open each port in turn, then wait for a while and see if Scratch Sensor data of the right form has arrived."	| msecs buf i |	#off = scanState ifTrue: [self scanNextPort].	#on = scanState ifTrue: [  "if port is open, close it and start a new scan"		scanPorts _ nil.		self scanNextPort].	#start = scanState ifTrue: [		(scanPorts isNil or: [scanPorts size = 0]) ifTrue: [			scanPorts _ self portNames asOrderedCollection].		scanPorts size = 0 ifTrue: [^ self scanNextPort].		self openPort: scanPorts removeFirst.		self portIsOpen ifFalse: [^ self].		scanState _ #checkData.		scanStartMSecs _ Time millisecondClockValue.		^ self].	#checkData = scanState ifTrue: [		msecs _ Time millisecondClockValue - scanStartMSecs.		(self portIsOpen not or: [msecs > 4000]) ifTrue: [^ self scanNextPort].		port nextPut: 1.  "send poll byte"		((buf _ port readByteArray) size < 10) ifTrue: [^ self].  "no data yet"		"check that the data is in Scratch Sensor Board format"		i _ (buf first bitAnd: 128) > 0 ifTrue: [1] ifFalse: [2].		[i < (buf size - 1)] whileTrue: [			(((buf at: i) bitAnd: 128) > 0 and:			 [((buf at: i + 1) bitAnd: 128) = 0]) ifFalse: [^ self scanNextPort].			i _ i + 2].		scanState _ #on].! !!I2CAssignMorph methodsFor: 'serial port' stamp: 'KK 1/5/2015 16:21'!scanNextPort	"Called during port scanning. The current port does not seem to be a ScratchBoard. Close it and try the next port in the list."	self closePort.	scanState _ #start.! !!I2CAssignMorph methodsFor: 'serial port' stamp: 'KK 1/5/2015 16:21'!selectPort	| menu choice |	self stopReadingData.	self portNames size = 0 ifTrue: [^ DialogBoxMorph inform: 'No serial ports found'].	menu _ CustomMenu new.	self portNames do: [:n | menu add: n action: n].	choice _ menu startUp.	choice ifNil: [^ self].	self openPort: choice.	self startReadingData.	scanState _ #on.! !!I2CAssignMorph methodsFor: 'serial port' stamp: 'KK 1/5/2015 16:21'!selectPort:  portNum	self stopReadingData.	self openPort: portNum.	self startReadingData.	ResetCounter _ 0.! !!I2CAssignMorph methodsFor: 'serial port' stamp: 'KK 1/5/2015 16:21'!tryToOpenPort	"Attempt to open the port. If successful, or if the port was open already, answer true. Otherwise, answer false."	(port notNil and: [port isOpen and: [scanState = #on]]) ifTrue: [^ true].  "already open"	self scanForPort.	^ port notNil and: [port isOpen]! !!I2CAssignMorph methodsFor: 'serial port' stamp: 'KK 1/5/2015 16:21'!useGoGoProtocol	self stopReadingData.	useGoGoProtocol _ true.	scratchBoardV3 _ false.	self startReadingData.! !!I2CAssignMorph methodsFor: 'serial port' stamp: 'KK 1/5/2015 16:21'!useScratchboardProtocol	self stopReadingData.	useGoGoProtocol _ false.	self startReadingData.! !!I2CAssignMorph methodsFor: 'event handling' stamp: 'KK 1/5/2015 16:21'!handlesMouseDown: evt	^ true! !!I2CAssignMorph methodsFor: 'event handling' stamp: 'KK 1/5/2015 16:21'!mouseDown: evt"	evt rightButtonPressed | evt shiftPressed		ifTrue: [Sensor waitNoButton. ^ self rightButtonMenu].	evt hand toolType = 'CutTool' ifTrue: [		evt shiftPressed ifFalse: [evt hand toolType: nil].		ScratchFrameMorph putInClipboard: self.		^ self delete]."	evt hand waitForClicksOrDrag: self event: evt.! !!I2CAssignMorph methodsFor: 'event handling' stamp: 'KK 1/5/2015 16:21'!mouseHold: evt"	self rightButtonMenu."! !!I2CAssignMorph methodsFor: 'event handling' stamp: 'KK 1/5/2015 16:21'!preemptsMouseDown: evt	^ false! !!I2CAssignMorph methodsFor: 'event handling' stamp: 'KK 1/5/2015 16:21'!rightButtonMenu	| menu |	menu _ CustomMenu new.	Sensor shiftPressed		ifTrue: [			reportRaw				ifTrue: [menu add: 'stop reporting raw data' action: #toggleRawMode]				ifFalse: [menu add: 'report raw data' action: #toggleRawMode].			useGoGoProtocol				ifTrue: [menu add: 'use Scratch board' action: #useScratchboardProtocol]				ifFalse: [menu add: 'use GoGo board' action: #useGoGoProtocol]]		ifFalse: [			menu add: 'select serial/USB port' action: #selectPort.			self portIsOpen				ifTrue: [menu add: 'close port' action: #stopReadingData].			menu addLine.			menu add: 'hide' action: #delete].	menu localize; invokeOn: self.! !!I2CAssignMorph methodsFor: 'event handling' stamp: 'KK 1/5/2015 16:21'!toggleRawMode	reportRaw _ reportRaw not.! !!I2CAssignMorph methodsFor: 'dropping/grabbing' stamp: 'KK 1/5/2015 16:21'!justDroppedInto: newOwner event: evt	| |	"Only allow embedding into the stage; otherwise, float (i.e. be a submorph of the world)."	"Board cannot be dropped onto the starge""	(owner isKindOf: ScratchStageMorph) ifTrue: [		super justDroppedInto: newOwner event: evt	]	ifFalse: [		evt hand rejectDropMorph: self event: evt.	].	"	self world addMorph: self."	(newOwner isKindOf: ScratchStageMorph) ifFalse: [" "only embed in the work pane""		self world addMorph: self]."! !!I2CAssignMorph methodsFor: 'object i/o' stamp: 'KK 1/5/2015 16:21'!fieldsVersion	^ 1! !!I2CAssignMorph methodsFor: 'object i/o' stamp: 'KK 1/5/2015 16:21'!initFieldsFrom: anObjStream version: classVersion	super initFieldsFrom: anObjStream version: classVersion.	anObjStream nextField.  "skip old portNum field"	self addReadouts.! !!I2CAssignMorph methodsFor: 'object i/o' stamp: 'KK 1/5/2015 16:21'!storeFieldsOn: anObjStream	super storeFieldsOn: anObjStream.	anObjStream putField: 1.  "old portNum instance variable"! !!I2CAssignMorph methodsFor: 'private' stamp: 'KK 1/5/2015 16:21'!buttonLabel: labelString action: actionSelector	"Answer a new button with the given label and selector. The button target will be me and it will use my button forms."	"(DialogBoxMorph new buttonLabel: 'Yes' action: #beep) openInWorld"	| onForm offForm button overForm |	onForm _ ScratchFrameMorph skinAt: #btnPressed.	offForm _ ScratchFrameMorph skinAt: #btn.	overForm _ ScratchFrameMorph skinAt: #btn.	button _ ResizableToggleButton2 new		offForm: offForm		onForm: onForm		overForm: overForm.	^ button		padding: 20@10;		label: labelString font: (ScratchFrameMorph getFont: #DialogBoxButton);		target: self;		actionSelector: actionSelector;		setLabelColor: (Color gray: 0.15)! !!I2CAssignMorph methodsFor: 'private' stamp: 'KK 1/5/2015 16:21'!isBoardSetup	"Answer true if a Arduino Board is connected to serial port."	| buf |	port isOpen ifFalse: [^ false. ].	buf _ self readFromPort: 10000.	(buf isNil) ifTrue: [ ^ false. ]. 	^ true.! !!I2CAssignMorph methodsFor: 'private' stamp: 'KK 1/5/2015 16:21'!processGoGoByte: aByte	"Process one byte of the incoming data stream from a GoGoBoard."	"Details: This code recognizes three-byte sensor update messages starting with 16r0C using a simple, three-state finite state machine. We assume that sensor updates are always contiguous--that is, replies to motor or other GoGo board commands will not be inserted between the bytes of any given three-byte sensor update message. The sensor number is the top three bits of the byte two. The data value is the bottom two bits of byte two plus all eight bits of byte three."	| sensorNum val |	currentState = #idle ifTrue: [ 		aByte = 16r0C ifTrue: [currentState _ #startByteSeen].		^ self].	currentState = #startByteSeen ifTrue: [		highByte _ aByte.		currentState _ #highByteSeen.		^ self].	currentState = #highByteSeen ifTrue: [		"final byte of message: report the sensor value"		sensorNum _ (highByte bitShift: -5) + 1.		val _ ((highByte bitAnd: 3) bitShift: 8) + aByte.		(sensorNum between: 1 and: 8) ifTrue: [			sensorValues at: sensorNum put: val].		currentState _ #idle].! !!I2CAssignMorph methodsFor: 'private' stamp: 'KK 1/5/2015 16:21'!processIncomingData	"Process incoming bytes from the serial port."	"Details: To work around a problem with the Prolific USB-Serial drivers on some Windows machines, a strict turn-taking polling protocol is used. A poll byte is sent, the ScratchBoard sends a response, and after a small delay (to be sure that all the data from the last poll has arrived, another poll is sent. The goal is to never allow more that few bytes to accumulate in the serial input buffer and to avoid sending a poll byte while data is arriving. However, since different versions of the ScratchBoard may send different amounts of data, we don't want to hard-code the number of reply bytes. Thus"	| buf msecsSinceLastPoll |	(self portIsOpen and: [#on = scanState]) ifFalse: [^ self].	useGoGoProtocol ifTrue: [		buf _ port readByteArray.		buf do: [:b | self processGoGoByte: b].		^ self].	msecsSinceLastPoll _ Time millisecondClockValue - lastPollMSecs.	msecsSinceLastPoll < 20 ifTrue: [^ self].	buf _ port readByteArray.	buf do: [:b | self processScratchByte: b]."	port nextPut: 1."	"send a ScratchBoard V4 poll byte"	lastPollMSecs _ Time millisecondClockValue.! !!I2CAssignMorph methodsFor: 'private' stamp: 'KK 1/5/2015 16:21'!processScratchByte: aByte	"Process one byte of the incoming data stream from a Scratch sensor board."	"Sensor messages are two bytes with the following format:		Byte1: <1><sensor number (4 bits)><sensor value high bits (3 bits)>		Byte2: <0><sensor value low bits (7 bits)>"	| sensorNum val |	currentState = #idle ifTrue: [  "wait for first byte of message"		(aByte bitAnd: 16r80) > 0 ifTrue: [			currentState _ #firstByteSeen.			highByte _ aByte].		^ self].	currentState = #firstByteSeen ifTrue: [		(aByte bitAnd: 16r80) > 0 ifTrue: [  "must have lost second byte; stay in firstByteSeen state"			highByte _ aByte.			^ self].		"good second byte: report the sensor value"		sensorNum _ ((highByte bitShift: -3) bitAnd: 16rF) + 1.		val _ ((highByte bitAnd: 7) bitShift: 7) + (aByte bitAnd: 16r7F).		sensorNum <= sensorValues size ifTrue: [			sensorValues at: sensorNum put: val.			sensorNum = 16 ifTrue: [				(val == 3) | (val == 4) ifTrue: [					scratchBoardV3 _ true]]].  "ScratchBoard, version 3 or 4"		currentState _ #idle].! !!I2CAssignMorph methodsFor: 'private' stamp: 'KK 1/5/2015 16:21'!scaleLight: val	val <= 25 ifTrue: [^ 100 - val].	^ ((1023 - val) * (75.0 / 998)) rounded! !!I2CAssignMorph methodsFor: 'private' stamp: 'KK 1/5/2015 16:21'!scaleSound: val	| n |	n _ ((val - 18) max: 0) min: 630.	n < 50 ifTrue: [^ n / 2.0].  "0 to 25"	^ 25.0 + ((n - 50) * (75.0 / 580.0))! !!I2CAssignMorph methodsFor: 'private' stamp: 'KK 1/5/2015 16:21'!startStreamingSensors: sensorByte	"Begin streaming data from the set of sensors specified by the bits of the given byte. Invoke this method with 0 to stop streaming. Incoming sensor data is processed by frequent calls to processIncomingData."	| cmd |	useGoGoProtocol ifFalse: [^ self].	port flushInputBuffer.	cmd _ #(84 254 160 0) asByteArray.	cmd at: 4 put: sensorByte.	port nextPutAll: cmd.! !!I2CAssignMorph methodsFor: 'private' stamp: 'KK 1/6/2015 13:40'!updateI2CDeviceSelectorArea	"Update servomotor calibration."	|  devsSelectArea i2cPartsPA pn rowTemp |	" -------------------------------------------------------------------- "	" 	DC motor pin assign area. "	" -------------------------------------------------------------------- "	devsSelectArea _ AlignmentMorph newColumn		hResizing: #shrinkWrap;		vResizing: #spaceFill;		color: (Color r: (153/255) g: (180/255) b: (209/255));		borderWidth: 1;		borderColor: (Color r: (148/255) g: (145/255) b: (145/255));		useRoundedCorners;		inset: 3.	devsSelectArea addMorphBack: (Morph new color: devsSelectArea color; extent: 5@3).  "spacer"	i2cPartsPA _ AlignmentMorph newColumn		color:devsSelectArea color;		borderColor: (Color r: (148/255) g: (145/255) b: (145/255));		useRoundedCorners;		inset: 3.	devsSelectArea addMorphBack: i2cPartsPA.		pn _ #(Accelerometer Gyro).	rowTemp _ self addPACheckBox: i2cPartsPA pinNames: pn.	pinInfo at:1 put:(rowTemp at:1).		" Acceleromenter "	pinInfo at:2 put:(rowTemp at:2).		" Gyro "	i2cPAArea addMorphBack: devsSelectArea.	i2cPAArea addMorphBack: (Morph new color: i2cPAArea color; extent: 5@3).  "spacer"! !!I2CAssignMorph methodsFor: 'private' stamp: 'KK 1/5/2015 17:43'!updateTitle	"Update my title to reflect the current protocol and port number."	| s |	s _ (#on = scanState) ifTrue: ['On' localized] ifFalse: ['I2C Device' localized].	s = titleMorph contents ifFalse: [titleMorph contents: s].! !!IfElseBlockMorph methodsFor: 'drawing' stamp: 'KK 2/27/2015 13:55'!drawOn: aCanvas 	| c |	topBarBottom _ self top + self topBarHeight.	blockBottom _ self bottom - 7.	self computeHighlightColors.	c _ FormCanvas extent: self extent depth: 32.	c _ c copyOffset: self topLeft negated.	self drawTopEdgeOn: c.	self drawTopBarOn: c.	self drawVerticalBarOn: c.	self drawElseBarOn: c.	self drawBottomBarOn: c.	self drawFinalOn: aCanvas fromCanvas: c.! !!IfElseBlockMorph methodsFor: 'private' stamp: 'KK 8/2/2013 15:08'!printArduCodeOn: aStream indent: indent	"Append a human-readable string for this block on the given stream."	indent timesRepeat: [aStream nextPutAll: '    '].	submorphs do: [:m |		(m ~~ trueBlock) & (m ~~ falseBlock) & (m ~~ nextBlock) ifTrue: [			self printArduCodeSubmorph: m on: aStream.			aStream space].].	aStream cr.	trueBlock ifNotNil: [trueBlock printArduCodeOn: aStream indent: indent + 1].	indent timesRepeat: [aStream nextPutAll: '    '].	aStream nextPutAll: '} else {'; cr.	falseBlock ifNotNil: [falseBlock printArduCodeOn: aStream indent: indent + 1].	indent timesRepeat: [aStream nextPutAll: '    '].	aStream nextPutAll: '}'; cr.	nextBlock ifNotNil: [nextBlock printArduCodeOn: aStream indent: indent].! !!KeyPadMorph methodsFor: 'stepping and presenter' stamp: 'sk 3/14/2017 11:30'!step

	| keyPadTarget expArg dispPosition frame |
	keyPadTarget _ World activeHand keyboardFocus.
	(keyPadTarget isKindOf: StringFieldMorph) ifTrue: [
		lastContents _ keyPadTarget contents.
		self target: keyPadTarget.
		expArg _ keyPadTarget ownerThatIsA: ExpressionArgMorph.
		frame _ expArg ownerThatIsA: ScratchFrameMorph.

		dispPosition _ expArg bottomLeft.
		((dispPosition y) + (self height)) > frame height ifTrue: [
			dispPosition _ (dispPosition x)@((dispPosition y) - (expArg height) - (self height))].
		self position: dispPosition.
		self comeToFront]
	ifFalse: [
		self delete].
! !!KeyPadMorph methodsFor: 'stepping and presenter' stamp: 'sk 2/7/2017 10:16'!stepTime

	^ 50! !!KeyPadMorph methodsFor: 'initialization' stamp: 'sk 3/15/2017 14:40'!initialize

	| col row bt size |
	super initialize.

	self color: Color transparent.
	col _ AlignmentMorph new.
	col orientation: #vertical.
	col color: BaseColor.
	col useRoundedCorners.

	buttons _ OrderedCollection new.
	size _ (ButtonSize + (10 * ScratchTranslator renderScale)) truncated.
	#(
		#(#('-' 45) #(0 48) #('.' 46))
		#(#(7 55) #(8 56) #(9 57))
		#(#(4 52) #(5 53) #(6 54))
		#(#(1 49) #(2 50) #(3 51))
		) do: [:num1 |
		row _ AlignmentMorph new.
		row color: BaseColor.
		num1 reverseDo: [:num2 |
			bt _ (SimpleButtonMorph new)
				label: ((num2 at: 1) asString) font: (StrikeFont fontName: #Verdana size: 20);
				extent: (size@size);
				color: ButtonColor;
				borderWidth: 1;
				borderColor: FontColor;
				target: self;
				actionSelector: #input:;
				arguments: {num2 at: 2};				actWhen: #buttonDown.
			(bt findA: StringMorph) color: FontColor.
			buttons add: bt.
			row addMorph: bt.
			row addMorph: (Morph new extent: (2@40); color: (Color transparent))].
		col addMorph: row].

	row _ AlignmentMorph new.
	row color: BaseColor.

	bt _ IconicButton new labelGraphic: ((ScratchFrameMorph skinAt: #bs) magnifyBy: 0.5) borderWidth: 0.
	bt target: self;
		actionSelector: #deleteChar;		actWhen: #buttonDown.
	buttons add: bt.

	row addMorph: bt.
	row addMorph: (Morph new extent: (20@30); color: (Color transparent)).

	bt _ SimpleButtonMorph new
		label: 'C' font: (StrikeFont fontName: #Verdana size: 20);
		extent: (70@30);
		color: ButtonColor;
		borderWidth: 1;
		borderColor: FontColor;
		target: self;
		actionSelector: #clearTarget;		actWhen: #buttonDown.
	(bt findA: StringMorph) color: FontColor.
	"buttons add: bt."
	row addMorph: bt.
	col addMorph: row.

	"col addMorph: sf."   "For debug"
	self addMorph: col.
	self extent: col extent.! !!KeyPadMorph methodsFor: 'accessing' stamp: 'sk 2/7/2017 09:30'!clearTarget

	targetField selectAll; removeSelection.
	World activeHand newKeyboardFocus: targetField.
! !!KeyPadMorph methodsFor: 'accessing' stamp: 'sk 2/7/2017 09:26'!deleteChar

	| curPosition |
	targetField backspace.
	curPosition _ targetField cursorPosition.
	World activeHand newKeyboardFocus: targetField.
	targetField moveCursorAt: curPosition.
! !!KeyPadMorph methodsFor: 'accessing' stamp: 'sk 4/24/2017 10:02'!input: aValue

	| curPosition |
	targetField contents: lastContents.	" To avoid the leading character to be '0' except a decimal. "
	((aValue = 46) not & lastContents = '0') ifTrue: [
		targetField selectAll].

	targetField insertCharacter: aValue.	lastContents _ targetField contents.
	curPosition _ targetField cursorPosition.
	World activeHand newKeyboardFocus: targetField.
	targetField moveCursorAt: curPosition.
! !!KeyPadMorph methodsFor: 'accessing' stamp: 'sk 3/14/2017 11:52'!setLocation	| keyPadTarget expArg dispPosition frame |	keyPadTarget _ World activeHand keyboardFocus.	(keyPadTarget isKindOf: StringFieldMorph) ifTrue: [		expArg _ keyPadTarget ownerThatIsA: ExpressionArgMorph.		frame _ expArg ownerThatIsA: ScratchFrameMorph.		dispPosition _ expArg bottomLeft.		((dispPosition y) + (self height)) > frame height ifTrue: [			dispPosition _ (dispPosition x)@((dispPosition y) - (expArg height) - (self height))].		self position: dispPosition.		self comeToFront].! !!KeyPadMorph methodsFor: 'accessing' stamp: 'sk 2/6/2017 20:38'!target: aStringField

	targetField _ aStringField.

"	buttons do: [:bt |
		bt target: aStringField]
"! !!KeyPadMorph class methodsFor: 'class initialization' stamp: 'sk 2/20/2017 16:27'!initialize
	"self initialize"

	BaseColor _ Color r: 0.753 g: 0.764 b: 0.776.
	ButtonColor _ Color r: 0.3 g: 0.3 b: 0.3.
	FontColor _ Color white.
	ButtonSize _ 40.
! !!LibraryItemMorph methodsFor: 'drawing' stamp: 'KK 1/21/2013 19:20'!updateNameAndInfo	| w y |	self		setProperty: #balloonText		toValue: ((target objName asUTF8, ' (' asUTF8, 'Scripts' localized, ScratchTranslator colonSuffix, ' ' asUTF8, target scripts size printString asUTF8,')' asUTF8) asUTF8).	nameMorph ifNotNil:[		(target isKindOf: ScriptableScratchMorph) ifFalse: [			nameMorph contents: '<no object>'.			scriptCountMorph contents: ''.			^ self].		nameMorph contents = target objName ifFalse: [			nameMorph contents: self truncatedLabel.			nameMorph left: self left + ((self width - nameMorph width) // 2) + 1]].	scriptCountMorph ifNotNil: [		w _ 0.		target scripts size > 0			ifTrue: [				w > 0 ifTrue: [w _ w + 2].				scriptCountMorph contents: 'Scripts' localized, ScratchTranslator colonSuffix, ' ', target scripts size printString.				w _ w + scriptCountMorph width + 2]			ifFalse: [				scriptCountMorph contents: ''].		"layout info morph row"		y _ nameMorph bottom.		w > 0 ifTrue: [			scriptCountMorph position: (self left + ((self width - (scriptCountMorph width)) // 2))@y]].! !!LibraryItemMorph methodsFor: 'stepping' stamp: 'KK 1/21/2013 19:19'!step	"Optimization: Don't update unless the costume has changed."	| changeTime stage frame |	target ifNil: [		(frame _ (self ownerThatIsA: ScratchFrameMorph)) ifNotNil: [			(stage _ frame workPane) ifNotNil: [				stage updateSpritesList]].		^ self].	target world isNil ifTrue: [target _ nil. ^ self].	changeTime _ target costumeChangeMSecs.	changeTime = lastUpdateMSecs ifFalse: [		self updateThumbnail.		lastUpdateMSecs _ changeTime].	Sensor anyButtonPressed ifFalse: [self updateNameAndInfo].! !!LibraryItemMorph methodsFor: 'private' stamp: 'KK 1/21/2013 19:18'!truncatedLabel	"Answer the label string to used as the name morph."	| ellipses s w n |"	nameMorph contents = target objName ifFalse: [		n _ target objName.		ellipses _ ScratchTranslator ellipsesSuffix asUTF32.		1 to: n size do: [:i |			s _ n copyFrom: 1 to: i.			w _ nameMorph stringWidth: (s asUTF32, ellipses).			w > (self width - 3) ifTrue: [				^ (n copyFrom: 1 to: i - 1) asUTF32, ellipses]]]."	^ target objName! !!NotificationMessage class methodsFor: 'printing' stamp: 'sk 8/23/2016 09:02'!show: msgID	"Displaying a notification message for a given number and returning the dialogbox."	| dialogBox title message |	title _ 'Undifined error number.'.	message _ 'Unknown error.'.	(msgID = 16r10) ifTrue: [		title _ 'Building and updating...'.		message _ 'Do not disconnect Studuino from the PC.'].	(msgID = 16r11) ifTrue: [		title _ 'Shifting to Test mode...'.		message _ 'Do not disconnect Studuino from the PC.'].	(msgID = 16r12) ifTrue: [		title _ 'Shifting to calibration mode...'.		message _ 'Do not disconnect Studuino from the PC.'].	(msgID = 16r20) ifTrue: [		title _ 'Are you ready to transfer your program?'.		message _ 'Push a reset button on a board.'].	(msgID = 16r21) ifTrue: [		title _ 'Are you ready to transfer your program?2'.		message _ 'Push a reset button on a board.'].	dialogBox _ DialogBoxMorph new.	dialogBox title: title.	dialogBox message: message.	dialogBox openInWorld.		" Display Dialogbox "	dialogBox centerOnScreen.	" Set center position "	dialogBox world doOneCycle.	^ dialogBox! !!NumericUpDownMorph methodsFor: 'accessing' stamp: 'sk 3/17/2017 19:05'!addUpDownButton	| scale |	buttons _ AlignmentMorph new		hResizing: #shrinkWrap;		vResizing: #shrinkWrap;		inset: 0;		color: (Color transparent).	scale _ ScratchTranslator renderScale rounded.	upMorph _ IconicButton new labelGraphic: (UpForm magnifyBy: scale).	upMorph color: (Color transparent);		borderWidth: 0;		target: self;		height: (self height);		actWhen: #whilePressed;		actionSelector: #incValue.	buttons addMorphBack: upMorph.	downMorph _ IconicButton new labelGraphic: (DownForm magnifyBy: scale).	downMorph color: (Color transparent);		target: self;		borderWidth: 0;		height: (self height);		actWhen: #whilePressed;		actionSelector: #decValue.	buttons addMorphBack: downMorph.	self addMorphFront: buttons.	self fixArgLayout! !!NumericUpDownMorph methodsFor: 'accessing' stamp: 'sk 5/17/2017 15:43'!notifyOwner: d	" I notify message to the owner "	" The owner is servomotor calibration board. "	| block frame sb pin ival offset portArg n |	(block _ self ownerThatIsA: CommandBlockMorph).	block ifNotNil: [	" Owner is CommandBlockMorph "		(block selector = #motorNo:degree:) ifTrue: [	" Owner is servomotor block "			portArg _ block findA: ChoiceArgMorph.			n _ portArg choice.			" Check argument. "			n = '' ifTrue: [^self].			" Port is not open, return. "			frame _ self ownerThatIsA: ScratchFrameMorph.			sb  _ frame workPane sensorBoard.			(sb portIsOpen) ifFalse: [ ^ self. ].			offset _ 0.			(n = 'D2') ifTrue: [	" D2 "				pin _ 16r0000.			"b0000 0000 0000 0000"				offset _ SvCalib at:(5).	" Servomotor offset"			].			(n = 'D4') ifTrue: [	" D4 "				pin _ 16r0200.			"b0000 0010 0000 0000"				offset _ SvCalib at:(6).	" Servomotor offset"			].			(n = 'D7') ifTrue: [	" D7 "				pin _ 16r0400.			"b0000 0100 0000 0000"				offset _ SvCalib at:(7).	" Servomotor offset"			].			(n = 'D8') ifTrue: [	" D8 "				pin _ 16r0600.			"b0000 0110 0000 0000"				offset _ SvCalib at:(8).	" Servomotor offset"			].			(n = 'D9') ifTrue: [	" D9 "				pin _ 16r0800.			"b0000 1000 0000 0000"				offset _ SvCalib at:(1).	" Servomotor offset"			].			(n = 'D10') ifTrue: [	" D10 "				pin _ 16r0A00.			"b0000 1010 0000 0000"				offset _ SvCalib at:(2).	" Servomotor offset"			].			(n = 'D11') ifTrue: [	" D11 "				pin _ 16r0C00.			"b0000 1100 0000 0000"				offset _ SvCalib at:(3).	" Servomotor offset"			].			(n = 'D12') ifTrue: [" D12 "				pin _ 16r0E00.			"b0000 1110 0000 0000"				offset _ SvCalib at:(4).	" Servomotor offset"			].			ival _ d asNumber.			ival _ ival + offset.	" Calibration "			(ival >= 180)  ifTrue: [ ival _ 180. ].			(ival <= 0)	 ifTrue: [ ival _ 0.   ].			ival _ pin + ival rounded.			"Transcript show:'ScriptableScratchMorph:: motorNo:degree:'; show: ival;cr."			sb data:ival msgID:1.		].	].! !!NumericUpDownMorph methodsFor: 'other' stamp: 'sk 12/22/2016 12:42'!enterKeyPressed	| val tmp |	"Respond to the enter key being pressed in one of my input fields."	tmp _ World activeHand keyboardFocus.	World activeHand newKeyboardFocus: nil.	val _ labelMorph contents asNumber.	(val > maximum) ifTrue: [ val _ maximum ].	(val < minimum) ifTrue: [ val _ minimum ].	self numExpression: val.	self notifyOwner: val.	World activeHand newKeyboardFocus: tmp.! !!NumericUpDownMorph methodsFor: 'object i/o' stamp: 'KK 3/31/2014 13:20'!fieldsVersion	^ 2! !!NumericUpDownMorph methodsFor: 'private' stamp: 'sk 2/14/2017 18:57'!decValue	| val |	val _ self evaluate.	val _ val - 1.	self setNum: val.	! !!NumericUpDownMorph methodsFor: 'private' stamp: 'sk 3/17/2017 19:05'!fixArgLayout	| dx |	dx _ 9 * (ScratchTranslator renderScale).	super fixArgLayout.	upMorph ifNil: [^ self].	downMorph ifNil: [ ^ self].	dx _ upMorph width.	self width: self width + (dx * 2) + 5.	buttons position: (self right - (dx * 2) - 2)@(self top)."	upMorph position: (self right - dx - 2)@(self top + (self height // 3)).	downMorph position: (self right - (dx * 2) - 2)@(self top + (self height // 3))."! !!NumericUpDownMorph methodsFor: 'private' stamp: 'sk 2/14/2017 18:57'!incValue	| val |	val _ self evaluate.	val _ val + 1.	self setNum: val.! !!NumericUpDownMorph methodsFor: 'private' stamp: 'sk 2/16/2017 13:55'!setNum: aValue	| val |	aValue isNumber ifFalse: [^ self].	val _ aValue within: minimum and: maximum.	self numExpression: val.	self notifyOwner: val.! !!NumericUpDownMorph methodsFor: 'initialization' stamp: 'sk 12/22/2016 11:40'!setDefault: defVal min: minVal max: maxVal width:w isEdit: e	" Set initial value, minimum value, maximum value, and up/down button. "	minimum _ minVal.	maximum _ maxVal.	self numExpression: defVal.	labelMorph width: (w* (ScratchTranslator renderScale)).	labelMorph doResizing: false.	labelMorph rightJustify: true.	labelMorph isEditable: e.	self addUpDownButton.! !!NumericUpDownMorph class methodsFor: 'class initialization' stamp: 'KK 3/31/2014 13:53'!initialize	"self initialize"	DownForm _ Form		extent: 7@4		depth: 1		fromArray: #(4261412864 2080374784 939524096 268435456)		offset: 0@0.	DownForm _ DownForm colorReduced.  "become a ColorForm"	DownForm colors:		(Array with: Color transparent with: (Color gray: 0.25)).	UpForm _ Form		extent: 7@4		depth: 1		fromArray: #(268435456 939524096 2080374784 4261412864)		offset: 0@0.	UpForm _ UpForm colorReduced.  "become a ColorForm"	UpForm colors:		(Array with: Color transparent with: (Color gray: 0.25)).! !!ObjStream class methodsFor: 'class initialization' stamp: 'KK 8/16/2013 17:54'!userClasses	"Answer an array of (<class id>, <class name>) records for all version numbered user classes."	"The following finds obsolete user classes:"	"self initialize. self userClasses reject: [:rec | Smalltalk includesKey: rec second]"	^ #(		"id		class"		(100		Morph)		(101		BorderedMorph)		(102		RectangleMorph)		(103		EllipseMorph)		(104		AlignmentMorph)		(105		StringMorph)		(106		UpdatingStringMorph)		(107		SimpleSliderMorph)		(108		SimpleButtonMorph)		(109		SampledSound)		(110		ImageMorph)		(111		SketchMorph)		"(120	SpriteMorph)"		"(121		SoundMorph)"		"(122	ImageBoxMorph)"		(123		SensorBoardMorph)		(124		ScratchSpriteMorph)		(125		ScratchStageMorph)		(140		ChoiceArgMorph)		(141		ColorArgMorph)		(142		ExpressionArgMorph)		"(143	ParameterReferenceMorph)"		"(144	PositionArgMorph)"		(145		SpriteArgMorph)		"(146	VariableArgMorph)"		(147		BlockMorph)		(148		CommandBlockMorph)		(149		CBlockMorph)		"(150	MethodCallBlockMorph)"		(151		HatBlockMorph)		"(152	ScratchButtonMorph)"		(153		ScratchScriptsMorph)		(154		ScratchSliderMorph)		(155		WatcherMorph)		"(156	ParameterMorph)"		(157		SetterBlockMorph)		(158		EventHatMorph)		"(159	EventArgMorph)"		(160		VariableBlockMorph)		"(161		IACTHatBlock)"		(162		ImageMedia)		(163		MovieMedia)		(164		SoundMedia)		(165		KeyEventHatMorph)		(166		BooleanArgMorph)		(167		EventTitleMorph)		(168		MouseClickEventHatMorph)		(169		ExpressionArgMorphWithMenu)		(170		ReporterBlockMorph)		(171		MultilineStringMorph)		(172		ToggleButton)		(173		WatcherReadoutFrameMorph)		(174		WatcherSliderMorph)		(175		ScratchListMorph)		(176		ScrollingStringMorph)	)! !!PasteUpMorph methodsFor: 'dropping/grabbing' stamp: 'KK 9/23/2013 17:35'!acceptDroppingMorph: aMorph event: evt	aMorph submorphsDo: [:m | (m isKindOf: HaloMorph) ifTrue: [m delete]].	self addMorphFront: aMorph."Transcript show:'[PasteUpMorph::acceptDroppingMorph: event:]';show: aMorph;show: ', ';show: evt;cr."	self isPartsBin		ifTrue: [			aMorph isPartsDonor: true.			aMorph allMorphsDo: [:m | m stopStepping]]		ifFalse: [			self world startSteppingSubmorphsOf: aMorph].! !!PinAssignMorph methodsFor: 'initialization' stamp: 'KK 5/27/2014 11:12'!addPACheckBox: area pinNames: pn	"Add a readout row with the given label. Answer the stringmorph that's the readout."	| row b temporary |	temporary _ OrderedCollection new.	pn do: [:pin |		row _ AlignmentMorph newRow color: area color; hResizing: #rigid; extent:45@30.		b _ ToggleButtonForStuduino			onForm: (ScratchFrameMorph skinAt: #watcherButtonPressed)			offForm: (ScratchFrameMorph skinAt: #watcherButton)			disabledForm: (ScratchFrameMorph skinAt: #watcherButton).		b actWhen: #buttonDown.		row addMorph:b.		row addMorphBack: (Morph new color: area color; extent: 5@3).  "spacer"		row addMorphBack: (StringMorph contents: pin font: (StrikeFont fontName: 'VerdanaBold' size: 12)).		area addMorphBack:row.		temporary add: row.	].	^ temporary.! !!PinAssignMorph methodsFor: 'initialization' stamp: 'KK 9/27/2017 18:30'!addPACheckComboBox: area pinNames: pn	"Add a readout row with the given label. Answer the stringmorph that's the readout."	| row b c arg temporary fixFieldWidth fixFieldHigh temp |	temp _ ScratchTranslator renderScale.	fixFieldWidth _ 120 * temp.	fixFieldHigh _ 15 * temp.	temporary _ OrderedCollection new.	pn do: [:pin |		row _ AlignmentMorph newRow color: area color; hResizing: #rigid; extent:190@30.		b _ ToggleButtonForStuduino			onForm: (ScratchFrameMorph skinAt: #watcherButtonPressed)			offForm: (ScratchFrameMorph skinAt: #watcherButton)			disabledForm: (ScratchFrameMorph skinAt: #watcherButton).		b actWhen: #buttonDown.		row addMorph:b.		row addMorphBack: (Morph new color: area color; extent: 5@3).  "spacer"		row addMorphBack: (StringMorph contents: pin font: (StrikeFont fontName: 'VerdanaBold' size: 12)).		row addMorphBack: (Morph new color: area color; extent: 5@3).  "spacer"		((pin = 'A0') | (pin = 'A1') | (pin = 'A2') | (pin = 'A3')) ifTrue: [			c _ ChoiceArgMorphForStuduino new				getOptionsSelector: #sensorPartsName0123;				options: ScriptableScratchMorph new sensorPartsName0123.			c color: (Color r: (240/255) g: (240/255) b: (240/255)).			c setFieldWidth: fixFieldWidth high: fixFieldHigh.			arg _ c labelMorph.			arg font:(StrikeFont fontName: 'Verdana' size: 10).			arg color: Color black.		].		((pin = 'A4') | (pin = 'A5')) ifTrue: [			c _ ChoiceArgMorphForStuduino new				getOptionsSelector: #sensorPartsName45;				options: ScriptableScratchMorph new sensorPartsName45.			c color: (Color r: (240/255) g: (240/255) b: (240/255)).			c setFieldWidth: fixFieldWidth high: fixFieldHigh.			arg _ c labelMorph.			arg font:(StrikeFont fontName: 'Verdana' size: 10).			arg color: Color black.		].		((pin = 'A6') | (pin = 'A7')) ifTrue: [			c _ ChoiceArgMorphForStuduino new				getOptionsSelector: #sensorPartsName67;				options: ScriptableScratchMorph new sensorPartsName67.			c color: (Color r: (240/255) g: (240/255) b: (240/255)).			c setFieldWidth: fixFieldWidth high: fixFieldHigh.			arg _ c labelMorph.			arg font:(StrikeFont fontName: 'Verdana' size: 10).			arg color: Color black.		].		row addMorphBack: c.		row addMorphBack: (Morph new color: area color; extent: 15@3).  "spacer"		temporary add: row.		area addMorphBack:row.	].	^ temporary.! !!PinAssignMorph methodsFor: 'initialization' stamp: 'KK 4/7/2014 13:09'!addReadoutLabeled: aString	"Add a readout row with the given label. Answer the stringmorph that's the readout."	| row box readout |	row _ AlignmentMorph newRow color: column color; inset: 2.	row addMorphBack: (Morph new color: column color; extent: 1@3). "spacer"	row addMorphBack: (StringMorph contents: aString capitalized font: (StrikeFont fontName: 'VerdanaBold' size: 10)).	row addMorphBack: (AlignmentMorph new color: column color; extent: 10@1; hResizing: #spaceFill). "spacer"	box _ NumericUpDownMorph new		extent: 42@14;		color: (ScriptableScratchMorph blockColorFor: 'sensing').	box setDefault:0 min:-15 max:15.	row addMorphBack: box.	readout _ StringMorph contents: '0' font: (StrikeFont fontName: 'VerdanaBold' size: 10).	readout color: Color white.	column addMorphBack: row.	^ readout! !!PinAssignMorph methodsFor: 'initialization' stamp: 'KK 4/7/2014 13:09'!addReadoutLabeled: aString field:clmn	"Add a readout row with the given label. Answer the stringmorph that's the readout."	| row box readout |	row _ AlignmentMorph newRow color: column color; inset: 2.	row addMorphBack: (Morph new color: column color; extent: 1@3). "spacer"	row addMorphBack: (StringMorph contents: aString capitalized font: (StrikeFont fontName: 'VerdanaBold' size: 10)).	row addMorphBack: (AlignmentMorph new color: column color; extent: 10@1; hResizing: #spaceFill). "spacer"	box _ NumericUpDownMorph new		extent: 42@14;		color: (ScriptableScratchMorph blockColorFor: 'sensing').	box setDefault:0 min:-15 max:15.	Boxes add: box.	" Set the box "	row addMorphBack: box.	readout _ StringMorph contents: '0' font: (StrikeFont fontName: 'VerdanaBold' size: 10).	readout color: Color white.	clmn addMorphBack: row.	^ readout! !!PinAssignMorph methodsFor: 'initialization' stamp: 'KK 9/25/2017 17:53'!addReadouts	| buttonRow spacer button2 button3 buttonSpacer |	" Make all alignment column "	column _ AlignmentMorph newColumn		centering: #center;		color: (Color r: (240/255) g: (240/255) b: (240/255));		borderWidth: 2;		borderColor: (Color r: (148/255) g: (145/255) b: (145/255));		useRoundedCorners;		inset: 3.	" Make title morph and add column and update "	titleMorph _ StringMorph		contents: ''		font: (StrikeFont fontName: 'VerdanaBold' size: 12).	column addMorph: titleMorph.	self updateTitle.	column addMorphBack: (Morph new color: column color; extent: 5@3).  "spacer"	self removeAllMorphs.	" Make DC motor, servomotor, button assign space "	motorButtonPAArea _ AlignmentMorph newRow color: column color.	column addMorphBack: motorButtonPAArea.	self updateMotorButtonPAArea.	" Make sensor, LED, buzzer assign space "	sensorPAArea _ AlignmentMorph newColumn		color: (Color r: (153/255) g: (180/255) b: (209/255));		borderWidth: 1;		borderColor: (Color r: (148/255) g: (145/255) b: (145/255));		useRoundedCorners;		inset:3.	column addMorphBack: sensorPAArea.	self updateSensorPAArea.	" Make button alignment morph and add column and update "	buttonRow _ AlignmentMorph newRow		color: Color transparent;		hResizing: #shrinkWrap;		vResizing: #shrinkWrap;		height: 32.	column addMorphBack: buttonRow.	spacer _ Morph new extent: 10@5; color: Color transparent.	buttonRow removeAllMorphs.	" Bottommost Buttons ""	button1 _ (self buttonLabel: 'Uncheck All' localized action: #setAllOff)."	button2 _ (self buttonLabel: 'OK' localized action: #yes).	button3 _ (self buttonLabel: 'Cancel' localized action: #cancelled).	" Spacer between Uncheck All button and OK button "	buttonSpacer _ (sensorPAArea fullBounds corner) -				    ("(button1 fullBounds corner) + "(button2 fullBounds corner) + (button3 fullBounds corner)).	buttonSpacer setX: (buttonSpacer x - spacer extent x) setY:5.	" Set high "	" Locate buttons ""	buttonRow addMorphBack: button1."	buttonRow addMorphBack: (Morph new extent: buttonSpacer; color: Color transparent) fullCopy.	buttonRow addMorphBack: button2.	buttonRow addMorphBack: spacer fullCopy.	buttonRow addMorphBack: button3.	column position: self position - 2.	self addMorph: column.	self extent: column extent - 4.! !!PinAssignMorph methodsFor: 'initialization' stamp: 'KK 9/25/2017 14:38'!initialize	super initialize.	pinInfo _ Array new: 22.	" pinInfo position. "	BA0Index _ 11.	" Button A0 "	BA1Index _ 12.	" Button A1 "	BA2Index _ 13.	" Button A2 "	BA3Index _ 14.	" Button A3 "	SA0Index _ 15.	" Sensor A0 "	SA1Index _ 16.	" Sensor A1 "	SA2Index _ 17.	" Sensor A2 "	SA3Index _ 18.	" Sensor A3 "	SA4Index _ 19.	" Sensor A4 "	SA5Index _ 20.	" Sensor A5 "	SA6Index _ 21.	" Sensor A6 "	SA7Index _ 22.	" Sensor A7 "	pinAssignTemporary _ Array new: 18.	self addReadouts.	i2cBoard _ I2CAssignMorph new.	i2cBuff ifNil: [		i2cBuff _ Array new:2.	].! !!PinAssignMorph methodsFor: 'initialization' stamp: 'KK 4/7/2014 13:09'!setDefaultPosition	|  partsID box val dh dm dl |	3 to: 10 do: [ :i |		partsID _ IOPort at:i.		" Get Parts ID "		" Send only servomotor info to board "		(partsID = StdnoPIDServomotor) ifTrue: [			box _ Boxes at: (i-2).			val _ box getValue.			dh _ i - 3.			val _ val + 90.			dm _ (val bitShift: -6) bitAnd: 16r03.			dl _ val bitAnd: 16r3F.			self partsID: 1 high: dh middle: dm low: dl.		].	].! !!PinAssignMorph methodsFor: 'initialization' stamp: 'KK 3/4/2015 20:06'!setPartsSelector	(frameMorph workPane showOptionBlocks) ifTrue: [		self setPartsSelectorWithOption.	] ifFalse: [		self setPartsSelectorBaseSet.	]! !!PinAssignMorph methodsFor: 'initialization' stamp: 'KK 3/4/2015 20:08'!setPartsSelectorBaseSet! !!PinAssignMorph methodsFor: 'initialization' stamp: 'KK 3/4/2015 20:07'!setPartsSelectorWithOption! !!PinAssignMorph methodsFor: 'accessing' stamp: 'KK 3/26/2015 17:12'!canBeSelected: aSymbol 	| set combo index |	index _ 1.	(aSymbol = AccelerometerName) |	(aSymbol = GyroSensorName) |	(aSymbol = ColorSensorName) ifTrue: [		pinInfo do: [:each |			((index = SA4Index) | (index = SA5Index)) ifFalse: [				combo _ each findA: ChoiceArgMorphForStuduino.					combo ifNotNil: [					(combo choice = InfraredReceiverName) ifTrue: [						ScratchFrameMorph displayMessageDialog:'30'.						^ false.					].				].				index _ index + 1.			]		].	].	(aSymbol = InfraredReceiverName) ifTrue: [		set _ pinInfo at:SA4Index.		combo _ set findA: ChoiceArgMorphForStuduino.			(combo choice = AccelerometerName) |		(combo choice = GyroSensorName) |		(combo choice = ColorSensorName)  ifTrue: [			ScratchFrameMorph displayMessageDialog:'30'.			^ false.		]	].	^ true.! !!PinAssignMorph methodsFor: 'accessing' stamp: 'KK 3/3/2015 09:42'!changeSelectorStatus: s	| button selector |	button _ s findA: ToggleButtonForStuduino.	" Toggle button "	selector _ s findA: ChoiceArgMorphForStuduino.	" Combo morph "	(button isOn) ifTrue: [		"Action side pin Toggle button OFF "		selector ifNotNil: [selector color: (Color r: (240/255) g: (240/255) b: (240/255))].		selector valiable: true.	]	ifFalse: [		" Action side pin Toggle button ON "		selector ifNotNil: [selector color: Color gray].		selector valiable: false.	].! !!PinAssignMorph methodsFor: 'accessing' stamp: 'KK 9/25/2017 16:49'!exclusiveControlDC: dc servo1: sv1 servo2: sv2	| dcCB |	"comment stating purpose of message"	dcCB _ dc findA: ToggleButtonForStuduino.	" DC motor Toggle button ""	sv1CB _ sv1 findA: ToggleButtonForStuduino.	"" Servomotor1 Toggle button ""	sv2CB _ sv2 findA: ToggleButtonForStuduino.	"" Servomotor2 Toggle button ""	sv1Title _ sv1 findA: StringMorph.			"" Servomotor1 String morph ""	sv2Title _ sv2 findA: StringMorph.			"" Servomotor2 String morph "	(dcCB isOn) ifTrue: [		" DC motor Toggle button ON ""		sv1CB isDisabled: true.	"" Servomotor1 Disable ""		sv1Title color: (Color gray).""		sv2CB isDisabled: true.	"" Servomotor2 Disable ""		sv2Title color: (Color gray)."	]	ifFalse: [		" DC motor Toggle button OFF ""		sv1CB isDisabled: false.	"" Servomotor1 Enable ""		sv1Title color: (Color black).""		sv2CB isDisabled: false.	"" Servomotor2 Enable ""		sv2Title color: (Color black)."	].! !!PinAssignMorph methodsFor: 'accessing' stamp: 'KK 4/9/2014 18:38'!exclusiveControlServo: sv1 servo2: sv2 dcMotor: dc	| sv1CB sv2CB dcCB dcTitle |	sv1CB _ sv1 findA: ToggleButtonForStuduino.	" Servo1 Toggle button "	sv2CB _ sv2 findA: ToggleButtonForStuduino.	" Servo2 Toggle button "	dcCB _ dc findA: ToggleButtonForStuduino.	" DC motor Toggle button "	dcTitle _ dc findA: StringMorph.				" DC motor String morph "	((sv1CB isOn) | (sv2CB isOn)) ifTrue: [		" Servo1 or Servo2 Toggle button ON "		dcCB isDisabled: true.		" DC motor Disable "		dcTitle color: (Color gray).	]	ifFalse: [		" Servo1 and Servo2 Toggle button OFF "		dcCB isDisabled: false.		" DC motor Enable "		dcTitle color: (Color black).	].! !!PinAssignMorph methodsFor: 'accessing' stamp: 'KK 3/3/2015 15:00'!exclusiveSensor: s1 sensor: s2	| s1CB s2CB s2Title |	s1CB _ s1 findA: ToggleButtonForStuduino.		" Action side pin Toggle button "	s2CB _ s2 findA: ToggleButtonForStuduino.	" Reaction side pin Toggle button "	s2Title _ s2 findA: StringMorph.				" Reaction side pin String morph "	(s1CB isOn) ifTrue: [		" Action side pin Toggle button ON "		s2CB isDisabled: true.	" Reaction side pin Disable "		s2Title color: (Color gray).	]	ifFalse: [		"Action side pin Toggle button OFF "		s2CB isDisabled: false.	" Reaction side pin Enable "		s2Title color: (Color black).	].! !!PinAssignMorph methodsFor: 'accessing' stamp: 'KK 3/24/2015 11:51'!insertOption: aSet item: aString	" Insert the item to parts list when the item is not selected "	| sensors others combo newOption pinName |	" Get sensor's collection "	sensors _ pinInfo select: [:each| 		((each findA: ChoiceArgMorph) = nil) not].	" Get other's sensors "	others _ sensors select: [:each |(each = aSet) not].	others do: [:each |		combo _ each findA: ChoiceArgMorph.		pinName _ each findA: StringMorph.		newOption _ OrderedCollection new.		(combo options ) do: [:option|			(option = TemperatureSensorName) ifTrue: [				(aString = InfraredReceiverName) ifTrue: [					" IR receive sensor can't not connet A6/A7. "					(pinName contents = 'A6') | (pinName contents  = 'A7') ifFalse: [						newOption add:aString.					].				].				newOption add:option.				(aString = BluetoothName) ifTrue: [					newOption add:aString.				].			] ifFalse: [				newOption add:option.			].		].		combo options: newOption.	].! !!PinAssignMorph methodsFor: 'accessing' stamp: 'KK 4/7/2014 13:09'!isScriptable	"I am not scriptable."	^ false! !!PinAssignMorph methodsFor: 'accessing' stamp: 'KK 3/9/2015 10:58'!notifyAccelerometerSelect: aSet 	| set combo |	" ---------------------------------- "	"	A4 Pin (Sensor side)	"	" ---------------------------------- "	(aSet == (pinInfo at:SA4Index)) ifTrue: [		set _ pinInfo at:SA5Index.		combo _ set findA: ChoiceArgMorphForStuduino.	" A5 pin Toggle button "		combo choiceAccelerameter.	].	" ---------------------------------- "	"	A5 Pin (Sensor side)	"	" ---------------------------------- "	(aSet == (pinInfo at:SA5Index)) ifTrue: [		set _ pinInfo at:SA4Index.		combo _ set findA: ChoiceArgMorphForStuduino.	" A4 pin Toggle button "		combo choiceAccelerameter.	].! !!PinAssignMorph methodsFor: 'accessing' stamp: 'KK 3/24/2015 11:52'!notifyBluetoothSelect: aSet selectedBT _ true.self removeOption:aSet item:BluetoothName.! !!PinAssignMorph methodsFor: 'accessing' stamp: 'KK 9/25/2017 16:44'!notifyCheckChange: aSet 	(frameMorph workPane showOptionBlocks) ifTrue: [		self notifyCheckChangeWithOption: aSet.	] ifFalse: [		self notifyCheckChangeBaseSet: aSet.	]! !!PinAssignMorph methodsFor: 'accessing' stamp: 'KK 9/26/2017 09:19'!notifyCheckChangeBaseSet: aSet 	| dc sv1 sv2 ab as cmb |	" ---------------------------------- "	"	M1 Pin	"	" ---------------------------------- "	(aSet == (dc _ pinInfo at:1)) ifTrue: [		sv1 _ pinInfo at:3.		" D2 pin "		sv2 _ pinInfo at:4.		" D4 pin "		self exclusiveControlDC:dc servo1:sv1 servo2:sv2.	].		" ---------------------------------- "	"	M2 Pin	"	" ---------------------------------- "	(aSet == (dc _ pinInfo at:2)) ifTrue: [		sv1 _ pinInfo at:5.		" D7 pin "		sv2 _ pinInfo at:6.		" D8 pin "		self exclusiveControlDC:dc servo1:sv1 servo2:sv2.	].	" ---------------------------------- "	"	D2 or D4 Pin	"	" ---------------------------------- "	((aSet == (sv1 _ pinInfo at:3)) | (aSet == (sv2 _ pinInfo at:4))) ifTrue: [		dc _ pinInfo at:1.		" M1 pin "		self exclusiveControlServo: sv1 servo2: sv2 dcMotor: dc	].	" ---------------------------------- "	"	D7 or D8 Pin	"	" ---------------------------------- "	((aSet == (sv1 _ pinInfo at:5)) | (aSet == (sv2 _ pinInfo at:6))) ifTrue: [		dc _ pinInfo at:2.		" M2 pin "		self exclusiveControlServo: sv1 servo2: sv2 dcMotor: dc	].	" ---------------------------------- "	"	A0 Pin (Button side)	"	" ---------------------------------- "	(aSet == (ab _ pinInfo at:11)) ifTrue: [		as _ pinInfo at:15.		" A0(Sensor) pin "		self exclusiveSensor: ab sensor: as.	].	" ---------------------------------- "	"	A1 Pin (Button side)	"	" ---------------------------------- "	(aSet == (ab _ pinInfo at:12)) ifTrue: [		as _ pinInfo at:16.		" A1(Sensor) pin "		self exclusiveSensor: ab sensor: as.	].	" ---------------------------------- "	"	A2 Pin (Button side)	"	" ---------------------------------- "	(aSet == (ab _ pinInfo at:13)) ifTrue: [		as _ pinInfo at:17.		" A2(Sensor) pin "		self exclusiveSensor: ab sensor: as.	].	" ---------------------------------- "	"	A3 Pin (Button side)	"	" ---------------------------------- "	(aSet == (ab _ pinInfo at:14)) ifTrue: [		as _ pinInfo at:18.		" A3(Sensor) pin "		self exclusiveSensor: ab sensor: as.	].	" ---------------------------------- "	"	A0 Pin (Sensor side)	"	" ---------------------------------- "	(aSet == (as _ pinInfo at:15)) ifTrue: ["		ab _ pinInfo at:11."		" A0(Button) pin ""		self exclusiveSensor: as sensor: ab.""		self changeSelectorStatus: as."		" add menu "		cmb _ as findA: ChoiceArgMorph.		cmb options: ScriptableScratchMorph new sensorPartsName0123.	].	" ---------------------------------- "	"	A1 Pin (Sensor side)	"	" ---------------------------------- "	(aSet == (as _ pinInfo at:16)) ifTrue: ["		ab _ pinInfo at:12."		" A1(Button) pin ""		self exclusiveSensor: as sensor: ab."		self changeSelectorStatus: as.		" add menu "		cmb _ as findA: ChoiceArgMorph.		cmb options: ScriptableScratchMorph new sensorPartsName0123.	].	" ---------------------------------- "	"	A2 Pin (Sensor side)	"	" ---------------------------------- "	(aSet == (as _ pinInfo at:17)) ifTrue: ["		ab _ pinInfo at:13."		" A2(Button) pin ""		self exclusiveSensor: as sensor: ab."		self changeSelectorStatus: as.		" add menu "		cmb _ as findA: ChoiceArgMorph.		cmb options: ScriptableScratchMorph new sensorPartsName0123.	].! !!PinAssignMorph methodsFor: 'accessing' stamp: 'KK 3/27/2015 11:26'!notifyCheckChangeWithOption: aSet 	" aSet is the owner that has check box changed "	| dc sv1 sv2 ab as a4 a5 a4CB a5CB a4CmbB a5CmbB a0 a1 a0CB a1CB a0CmbB a1CmbB asCmbB setComb |	" ---------------------------------- "	"	M1 Pin	"	" ---------------------------------- "	(aSet == (dc _ pinInfo at:1)) ifTrue: [		sv1 _ pinInfo at:3.		" D2 pin "		sv2 _ pinInfo at:4.		" D4 pin "		self exclusiveControlDC:dc servo1:sv1 servo2:sv2.	].		" ---------------------------------- "	"	M2 Pin	"	" ---------------------------------- "	(aSet == (dc _ pinInfo at:2)) ifTrue: [		sv1 _ pinInfo at:5.		" D7 pin "		sv2 _ pinInfo at:6.		" D8 pin "		self exclusiveControlDC:dc servo1:sv1 servo2:sv2.	].	" ---------------------------------- "	"	D2 or D4 Pin	"	" ---------------------------------- "	((aSet == (sv1 _ pinInfo at:3)) | (aSet == (sv2 _ pinInfo at:4))) ifTrue: [		dc _ pinInfo at:1.		" M1 pin "		self exclusiveControlServo: sv1 servo2: sv2 dcMotor: dc	].	" ---------------------------------- "	"	D7 or D8 Pin	"	" ---------------------------------- "	((aSet == (sv1 _ pinInfo at:5)) | (aSet == (sv2 _ pinInfo at:6))) ifTrue: [		dc _ pinInfo at:2.		" M2 pin "		self exclusiveControlServo: sv1 servo2: sv2 dcMotor: dc	].	" ---------------------------------- "	"	A0 Pin (Button side)	"	" ---------------------------------- "	(aSet == (ab _ pinInfo at:11)) ifTrue: [		as _ pinInfo at:15.		" A0(Sensor) pin "		self exclusiveSensor: ab sensor: as.	].	" ---------------------------------- "	"	A1 Pin (Button side)	"	" ---------------------------------- "	(aSet == (ab _ pinInfo at:12)) ifTrue: [		as _ pinInfo at:16.		" A1(Sensor) pin "		self exclusiveSensor: ab sensor: as.	].	" ---------------------------------- "	"	A2 Pin (Button side)	"	" ---------------------------------- "	(aSet == (ab _ pinInfo at:13)) ifTrue: [		as _ pinInfo at:17.		" A2(Sensor) pin "		self exclusiveSensor: ab sensor: as.	].	" ---------------------------------- "	"	A3 Pin (Button side)	"	" ---------------------------------- "	(aSet == (ab _ pinInfo at:14)) ifTrue: [		as _ pinInfo at:18.		" A3(Sensor) pin "		self exclusiveSensor: ab sensor: as.	].	" ---------------------------------- "	"	A0 or A1 Pin (Sensor)	"	" ---------------------------------- "	((aSet == (a0 _ pinInfo at:SA0Index)) | (aSet == (a1 _ pinInfo at:SA1Index))) ifTrue: [		a0CB _ a0 findA: ToggleButtonForStuduino.	" A0 pin Toggle button "		a1CB _ a1 findA: ToggleButtonForStuduino.	" A1 pin Toggle button "		a0CmbB _ a0 findA: ChoiceArgMorph.		" A0 pin argment "		a1CmbB _ a1 findA: ChoiceArgMorph.		" A1 pin argment "		((a0CB isOn) & (a1CB isOn)) ifTrue: ["Transcript show:'[A01]A01OP';cr."			" Added accelerometer menu "			a0CmbB options: (self sensorPartsNameA01OP: (a0CmbB choice)).			a1CmbB options: (self sensorPartsNameA01OP: (a1CmbB choice)).		] ifFalse: ["Transcript show:'[A01]A23OP';cr."			" normal menu "			" If I select Infrared receiver or Bluttooth, select Light sensor and set flag to false. "			setComb _ aSet findA: ChoiceArgMorph.			(setComb choice = InfraredReceiverName) ifTrue: [				setComb choice: LightSensorName.				selectedIR _ false. 			].			(setComb choice = BluetoothName) ifTrue: [ 				setComb choice: LightSensorName.				selectedBT _ false.			].			a0CmbB options: (self sensorPartsNameA23OP: (a0CmbB choice)).			a1CmbB options:  (self sensorPartsNameA23OP: (a1CmbB choice)).		].		(aSet == (a0)) ifTrue: [			ab _ pinInfo at:BA0Index." A0(Button) pin "			self exclusiveSensor: a0 sensor: ab.			self changeSelectorStatus: a0.		].		(aSet == (a1)) ifTrue: [			ab _ pinInfo at:BA1Index." A0(Button) pin "			self exclusiveSensor: a1 sensor: ab.			self changeSelectorStatus: a1.		].	].	" ---------------------------------- "	"	A2 Pin (Sensor side)	"	" ---------------------------------- "	(aSet == (as _ pinInfo at:SA2Index)) ifTrue: ["Transcript show:'[A2]A23OP';cr."		asCmbB _ as findA: ChoiceArgMorph.			asCmbB options: self sensorPartsNameA23OP.		ab _ pinInfo at:13.		" A2(Button) pin "		self exclusiveSensor: as sensor: ab.		self changeSelectorStatus: as.	].	" ---------------------------------- "	"	A3 Pin (Sensor side)	"	" ---------------------------------- "	(aSet == (as _ pinInfo at:SA3Index)) ifTrue: ["Transcript show:'[A3]A23OP';cr."		asCmbB _ as findA: ChoiceArgMorph.			asCmbB options: self sensorPartsNameA23OP.		ab _ pinInfo at:14.		" A3(Button) pin "		self exclusiveSensor: as sensor: ab.		self changeSelectorStatus: as.	].	" ---------------------------------- "	"	A4 or A5 Pin (Sensor)	"	" ---------------------------------- "	((aSet == (a4 _ pinInfo at:SA4Index)) | (aSet == (a5 _ pinInfo at:SA5Index))) ifTrue: [		a4CB _ a4 findA: ToggleButtonForStuduino.	" A4 pin Toggle button "		a5CB _ a5 findA: ToggleButtonForStuduino.	" A5 pin Toggle button "		a4CmbB _ a4 findA: ChoiceArgMorph.		" A4 pin argment "		a5CmbB _ a5 findA: ChoiceArgMorph.		" A5 pin argment "		((a4CB isOn) & (a5CB isOn)) ifTrue: [			" Added accelerometer menu "			a4CmbB options: (self sensorPartsNameA45OP: (a4CmbB choice)).			a5CmbB options: (self sensorPartsNameA45OP: (a5CmbB choice)).		]		ifFalse: [			" normal menu "			" If I select Infrared receiver or Bluttooth, select Light sensor and set flag to false. "			setComb _ aSet findA: ChoiceArgMorph.			(setComb choice = InfraredReceiverName) ifTrue: [				setComb choice: LightSensorName.				selectedIR _ false. 			].			(setComb choice = BluetoothName) ifTrue: [ 				setComb choice: LightSensorName.				selectedBT _ false.			].			a4CmbB options: (self sensorPartsNameA23OP: (a4CmbB choice)).			a5CmbB options: (self sensorPartsNameA23OP: (a5CmbB choice)).		].		(aSet == (a4)) ifTrue: [ self changeSelectorStatus: a4. ].		(aSet == (a5)) ifTrue: [ self changeSelectorStatus: a5. ].	].	" ---------------------------------- "	"	A6 Pin (Sensor side)	"	" ---------------------------------- "	(aSet == (as _ pinInfo at:SA6Index)) ifTrue: ["Transcript show:'[A6]A67OP';cr."		asCmbB _ as findA: ChoiceArgMorph.			asCmbB options: self sensorPartsNameA67OP.		self changeSelectorStatus: as.	].	" ---------------------------------- "	"	A7 Pin (Sensor side)	"	" ---------------------------------- "	(aSet == (as _ pinInfo at:SA7Index)) ifTrue: ["Transcript show:'[A7]A67OP';cr."		asCmbB _ as findA: ChoiceArgMorph.			asCmbB options: self sensorPartsNameA67OP.		self changeSelectorStatus: as.	].! !!PinAssignMorph methodsFor: 'accessing' stamp: 'KK 3/27/2015 10:45'!notifyColorSensorSelect: aSet 	| set combo |	" ---------------------------------- "	"	A4 Pin (Sensor side)	"	" ---------------------------------- "	(aSet == (pinInfo at:SA4Index)) ifTrue: [		set _ pinInfo at:SA5Index.		combo _ set findA: ChoiceArgMorphForStuduino.	" A5 pin Toggle button "		combo choiceColorSensor.	].	" ---------------------------------- "	"	A5 Pin (Sensor side)	"	" ---------------------------------- "	(aSet == (pinInfo at:SA5Index)) ifTrue: [		set _ pinInfo at:SA4Index.		combo _ set findA: ChoiceArgMorphForStuduino.	" A4 pin Toggle button "		combo choiceColorSensor.	].! !!PinAssignMorph methodsFor: 'accessing' stamp: 'KK 3/27/2015 10:43'!notifyGyroSensorSelect: aSet 	| set combo |	" ---------------------------------- "	"	A4 Pin (Sensor side)	"	" ---------------------------------- "	(aSet == (pinInfo at:SA4Index)) ifTrue: [		set _ pinInfo at:SA5Index.		combo _ set findA: ChoiceArgMorphForStuduino.	" A5 pin Toggle button "		combo choiceGyroSensor.	].	" ---------------------------------- "	"	A5 Pin (Sensor side)	"	" ---------------------------------- "	(aSet == (pinInfo at:SA5Index)) ifTrue: [		set _ pinInfo at:SA4Index.		combo _ set findA: ChoiceArgMorphForStuduino.	" A4 pin Toggle button "		combo choiceGyroSensor.	].! !!PinAssignMorph methodsFor: 'accessing' stamp: 'KK 3/24/2015 11:53'!notifyInfrareReceiverSelect: aSet selectedIR _ true.self removeOption:aSet item:InfraredReceiverName.! !!PinAssignMorph methodsFor: 'accessing' stamp: 'KK 3/24/2015 11:54'!notifyNotBluetoothSelect: aSet selectedBT _ false.self insertOption:aSet item:BluetoothName.! !!PinAssignMorph methodsFor: 'accessing' stamp: 'KK 3/24/2015 11:54'!notifyNotInfrareReceiverSelect: aSet selectedIR _ false.self insertOption:aSet item:InfraredReceiverName.! !!PinAssignMorph methodsFor: 'accessing' stamp: 'KK 3/24/2015 11:54'!notifyNotToSelectAccelerometer: aSet 	| set combo |	" ---------------------------------- "	"	A4 Pin (Sensor side)	"	" ---------------------------------- "	(aSet == (pinInfo at:SA4Index)) ifTrue: [		set _ pinInfo at:SA5Index.		combo _ set findA: ChoiceArgMorphForStuduino.	" A5 pin Toggle button "		(combo evaluate) = AccelerometerName ifTrue: [			combo choiceLightSensor.		].	].	" ---------------------------------- "	"	A5 Pin (Sensor side)	"	" ---------------------------------- "	(aSet == (pinInfo at:SA5Index)) ifTrue: [		set _ pinInfo at:SA4Index.		combo _ set findA: ChoiceArgMorphForStuduino.	" A4 pin Toggle button "		(combo evaluate) = AccelerometerName ifTrue: [			combo choiceLightSensor.		].	].! !!PinAssignMorph methodsFor: 'accessing' stamp: 'KK 3/24/2015 11:55'!notifyNotToSelectColorSensor: aSet 	| set combo |	" ---------------------------------- "	"	A4 Pin (Sensor side)	"	" ---------------------------------- "	(aSet == (pinInfo at:SA4Index)) ifTrue: [		set _ pinInfo at:SA5Index.		combo _ set findA: ChoiceArgMorphForStuduino.	" A5 pin Toggle button "		(combo evaluate) = ColorSensorName ifTrue: [			combo choiceLightSensor.		].	].	" ---------------------------------- "	"	A5 Pin (Sensor side)	"	" ---------------------------------- "	(aSet == (pinInfo at:SA5Index)) ifTrue: [		set _ pinInfo at:SA4Index.		combo _ set findA: ChoiceArgMorphForStuduino.	" A4 pin Toggle button "		(combo evaluate) = ColorSensorName ifTrue: [			combo choiceLightSensor.		].	].! !!PinAssignMorph methodsFor: 'accessing' stamp: 'KK 3/24/2015 11:55'!notifyNotToSelectGyroSensor: aSet 	| set combo |	" ---------------------------------- "	"	A4 Pin (Sensor side)	"	" ---------------------------------- "	(aSet == (pinInfo at:SA4Index)) ifTrue: [		set _ pinInfo at:SA5Index.		combo _ set findA: ChoiceArgMorphForStuduino.	" A5 pin Toggle button "		(combo evaluate) = GyroSensorName ifTrue: [			combo choiceLightSensor.		].	].	" ---------------------------------- "	"	A5 Pin (Sensor side)	"	" ---------------------------------- "	(aSet == (pinInfo at:SA5Index)) ifTrue: [		set _ pinInfo at:SA4Index.		combo _ set findA: ChoiceArgMorphForStuduino.	" A4 pin Toggle button "		(combo evaluate) = GyroSensorName ifTrue: [			combo choiceLightSensor.		].	].! !!PinAssignMorph methodsFor: 'accessing' stamp: 'KK 3/24/2015 11:56'!notifyNotUltrasonicSelect: aSet 	| set combo |	" ---------------------------------- "	"	A0 Pin (Sensor side)	"	" ---------------------------------- "	(aSet == (pinInfo at:SA0Index)) ifTrue: [		set _ pinInfo at:SA1Index.		combo _ set findA: ChoiceArgMorphForStuduino.	" A1 pin Toggle button "		(combo evaluate) = UltrasonicSensorName ifTrue: [			combo choiceLightSensor.		].	].	" ---------------------------------- "	"	A1 Pin (Sensor side)	"	" ---------------------------------- "	(aSet == (pinInfo at:SA1Index)) ifTrue: [		set _ pinInfo at:SA0Index.		combo _ set findA: ChoiceArgMorphForStuduino.	" A0 pin Toggle button "		(combo evaluate) = UltrasonicSensorName ifTrue: [			combo choiceLightSensor.		].	].! !!PinAssignMorph methodsFor: 'accessing' stamp: 'KK 3/9/2015 10:54'!notifyUltrasonicSelect: aSet 	| set combo |	" ---------------------------------- "	"	A0 Pin (Sensor side)	"	" ---------------------------------- "	(aSet == (pinInfo at:SA0Index)) ifTrue: [		set _ pinInfo at:SA1Index.		combo _ set findA: ChoiceArgMorphForStuduino.	" A5 pin Toggle button "		combo choiceUltrasonicSensor.	].	" ---------------------------------- "	"	A1 Pin (Sensor side)	"	" ---------------------------------- "	(aSet == (pinInfo at:SA1Index)) ifTrue: [		set _ pinInfo at:SA0Index.		combo _ set findA: ChoiceArgMorphForStuduino.	" A4 pin Toggle button "		combo choiceUltrasonicSensor.	].! !!PinAssignMorph methodsFor: 'accessing' stamp: 'KK 3/9/2015 11:22'!removeOption: aSet item: aString	" Remove the item from parts list when the item selected "	| sensors others combo newOptions |	" Get sensor's collection "	sensors _ pinInfo select: [:each| 		((each findA: ChoiceArgMorph) = nil) not].	" Get other's sensors "	others _ sensors select: [:each |(each = aSet) not].	others do: [:each |		combo _ each findA: ChoiceArgMorph.		newOptions _ (combo options ) select: [:option|			(option = aString) not	].		combo options: newOptions.	].! !!PinAssignMorph methodsFor: 'accessing' stamp: 'KK 9/25/2017 17:16'!setAllOff	| cb combo |	" Set all checkbox off. "	selectedBT _ false.	selectedIR _false.	pinInfo do: [ :pin |		pin ifNotNil: [			combo _ pin findA: ChoiceArgMorphForStuduino.			combo ifNotNil: [				combo choice: LightSensorName.			].			cb _ pin findA: ToggleButtonForStuduino.	" Toggle button "			cb off.		].	].! !!PinAssignMorph methodsFor: 'accessing' stamp: 'KK 3/24/2015 13:03'!setCheckBox: portNumber partsID: pID	| set cb cmb |	" Set checkbox "	" If port connect nothing, do nothing. "	(pID = StdnoPIDOpen) ifTrue: [ ^ self. ].	" connect with something... "	(portNumber > 0) & (portNumber < 11) ifTrue: [	" M1 - D12 "		set _ pinInfo at:portNumber.		" If the port connect with motor, set checkbox on. "		cb _ set findA: ToggleButtonForStuduino.	" Toggle button "		cb on.	]	ifFalse: [	" A0 - A7 "		(pID = StdnoPIDButton) ifTrue: [			" Button "			set _ pinInfo at:portNumber.			cb _ set findA: ToggleButtonForStuduino.	"Toggle button "			cb on.		]		ifFalse: [			" Other Sensor or LED / Buzzer "			set _ pinInfo at:(portNumber + 4).			cb _ set findA: ToggleButtonForStuduino.			"Toggle button "			cmb _ set findA: ChoiceArgMorphForStuduino.	" Parts name combo box "			cb on.			(pID = StdnoPIDLightSensor) ifTrue: [				cmb choice:LightSensorName			].			(pID = StdnoPIDTouchSensor) ifTrue: [				cmb choice:TouchSensorName			].			(pID = StdnoPIDSoundSensor) ifTrue: [				cmb choice:SoundSensorName			].			(pID = StdnoPIDIR) ifTrue: [				cmb choice:IRPhotoreflectorName			].			(pID = StdnoPIDAcceleration) ifTrue: [				cmb choice:AccelerometerName.			].			(pID = StdnoPIDLED) ifTrue: [				cmb choice:LEDName.			].			(pID = StdnoPIDBuzzer) ifTrue: [				cmb choice:BuzzerName.			].			(pID = StdnoPIDI2C) ifTrue: [				cmb choice:I2CDeviceName.			].			(pID = StdnoPIDInfraredRecv) ifTrue: [				cmb choice:InfraredReceiverName.				selectedIR _ true.			].			(pID = StdnoPIDTemperature) ifTrue: [				cmb choice:TemperatureSensorName.			].			(pID = StdnoPIDGyro) ifTrue: [				cmb choice:GyroSensorName.			].			(pID = StdnoPIDUltrasonic) ifTrue: [				cmb choice:UltrasonicSensorName.			].			(pID = StdnoPIDColor) ifTrue: [				cmb choice:ColorSensorName.			].			(pID = StdnoPIDBluetooth) ifTrue: [				selectedBT _ true.				cmb choice:BluetoothName.			].		].	].! !!PinAssignMorph methodsFor: 'accessing' stamp: 'KK 9/25/2017 18:28'!setCheckBoxOn: portNumber partsID: pID	| set cb |	" Set checkbox "	" If port connect nothing, do nothing. "	(pID = StdnoPIDOpen) ifTrue: [ ^ self. ].	" connect with something... "	(portNumber > 0) & (portNumber < 11) ifTrue: [	" M1 - D12 "		set _ pinInfo at:portNumber.		set ifNotNil: [			" If the port connect with motor, set checkbox on. "			cb _ set findA: ToggleButtonForStuduino.	" Toggle button "			cb on.		].	]	ifFalse: [	" A0 - A7 "		(pID = StdnoPIDButton) ifTrue: [			" Button "			set _ pinInfo at:portNumber.			cb _ set findA: ToggleButtonForStuduino.	"Toggle button "			cb on.		]		ifFalse: [			" Other Sensor or LED / Buzzer "			set _ pinInfo at:(portNumber + 4).			cb _ set findA: ToggleButtonForStuduino.			"Toggle button "			cb on.		].	].! !!PinAssignMorph methodsFor: 'accessing' stamp: 'KK 9/25/2017 17:21'!setComboBox: portNumber partsID: pID	| set cmb |	" Set checkbox "	" If port connect nothing, do nothing. "	(pID = StdnoPIDOpen) ifTrue: [ ^ self. ].	" A0 - A7 "	" Other Sensor or LED / Buzzer "	set _ pinInfo at:(portNumber + 4).	set ifNotNil: [		cmb _ set findA: ChoiceArgMorphForStuduino.	" Parts name combo box "	].	(pID = StdnoPIDLightSensor) ifTrue: [		cmb choice: LightSensorName	].	(pID = StdnoPIDTouchSensor) ifTrue: [		cmb choice: TouchSensorName	].	(pID = StdnoPIDSoundSensor) ifTrue: [		cmb choice: SoundSensorName	].	(pID = StdnoPIDIR) ifTrue: [		cmb choice: IRPhotoreflectorName	].	(pID = StdnoPIDAcceleration) ifTrue: [		cmb choice: AccelerometerName.	].	(pID = StdnoPIDLED) ifTrue: [		cmb choice: LEDName.	].	(pID = StdnoPIDBuzzer) ifTrue: [		cmb choice: BuzzerName.	].	(pID = StdnoPIDI2C) ifTrue: [		cmb choice: I2CDeviceName.	].	(pID = StdnoPIDInfraredRecv) ifTrue: [		cmb choice: InfraredReceiverName.		selectedIR _ true.	].	(pID = StdnoPIDTemperature) ifTrue: [		cmb choice: TemperatureSensorName.	].	(pID = StdnoPIDGyro) ifTrue: [		cmb choice: GyroSensorName.	].	(pID = StdnoPIDUltrasonic) ifTrue: [		cmb choice: UltrasonicSensorName.	].	(pID = StdnoPIDColor) ifTrue: [		cmb choice: ColorSensorName.	].	(pID = StdnoPIDBluetooth) ifTrue: [		selectedBT _ true.		cmb choice: BluetoothName.	].! !!PinAssignMorph methodsFor: 'accessing' stamp: 'KK 1/6/2015 13:46'!setFrameMorph: frame	| |	" Set frame moprh. "	frameMorph _ frame.! !!PinAssignMorph methodsFor: 'interaction' stamp: 'KK 3/4/2015 12:01'!cancelled	| |	" Only close port "	i2cBoard delete.	self delete.	ScratchMenuTitleMorph setMenuEnable: true.! !!PinAssignMorph methodsFor: 'interaction' stamp: 'KK 5/28/2014 16:55'!returnPinAssignInfo	| index |	"Return pin assignment from temporary buffer"		index _ 1.	pinAssignTemporary do: [ :parts |		self setCheckBox: index partsID:parts.		index _ index + 1.	].! !!PinAssignMorph methodsFor: 'interaction' stamp: 'KK 5/28/2014 16:52'!savePinAssignInfo	"Set pin assignment to IOPort"		self setPinAssignInfo: pinAssignTemporary.! !!PinAssignMorph methodsFor: 'interaction' stamp: 'KK 9/25/2017 18:50'!setPinAssignInfo: buf	"Set pin assignment"		| cb name set i2cUsed a1 a2 |	" Initialize buf array "	1 to: (buf size) do: [:num |		buf at:num put:0.	].	" Initialize some sensor's used flag "	i2cUsed _ false.	InfraredReceiverUsed _ -1.	UltrasonicUsed _ false.	" Set buf information "	buf at: 1 put: StdnoPIDDCMotor.	" M1 "	a1 _ 16.	set _ pinInfo at: a1.					" A1 "	cb _ set findA: ToggleButtonForStuduino.	" Toggle button "	(cb isOn) ifTrue: [		" Get selected name. "		name _ (set findA: ChoiceArgMorphForStuduino) choice.		(name = LightSensorName) ifTrue: [ buf at: (a1-4) put: StdnoPIDLightSensor.].		(name = IRPhotoreflectorName) ifTrue: [ buf at: (a1-4) put: StdnoPIDIR.].		(name = TemperatureSensorName) ifTrue: [ buf at:(a1-4) put:StdnoPIDTemperature.].	].	a2 _ 17.	set _ pinInfo at: a2.					" A2 "	cb _ set findA: ToggleButtonForStuduino.	" Toggle button "	(cb isOn) ifTrue: [		" Get selected name. "		name _ (set findA: ChoiceArgMorphForStuduino) choice.		(name = LightSensorName) ifTrue: [ buf at: (a2-4) put: StdnoPIDLightSensor.].		(name = IRPhotoreflectorName) ifTrue: [ buf at: (a2-4) put: StdnoPIDIR.].		(name = TemperatureSensorName) ifTrue: [ buf at:(a2-4) put:StdnoPIDTemperature.].	].	 ^ i2cUsed.! !!PinAssignMorph methodsFor: 'interaction' stamp: 'KK 9/25/2017 14:39'!yes	| frame isUsedI2C |	"Set pin assignment to IOPort"		" Reflesh viewer pane "	frame _ frameMorph.	" If test mode on, test mode off "	(DuringTest = true) ifTrue: [	" During a test? "		frame testModeOff.	].	(DuringCalib = true) ifTrue: [	" During calibration? "		frame calibrationOff.	].	" Set pin assign to global information "	isUsedI2C _ self setPinAssignInfo: IOPort.	(isUsedI2C) ifFalse: [		i2cBoard setAllOff.	].	i2cBoard setPinAssignInfo: i2cBuff.	frame viewerPane refresh.	frame setLanguage: (ScratchTranslator currentLanguage).	i2cBoard delete.	self delete.		ScratchMenuTitleMorph setMenuEnable: true.! !!PinAssignMorph methodsFor: 'sensor ops' stamp: 'KK 4/7/2014 13:09'!privateSensor: sensorIndex	"Read the virtual sensor with the given index permuted according to which Scratch board is plugged in and scaled if it is a known special sensor such as the light or sound sensor. If reportRaw is true then the raw sensor value (0..1023) is reported."	"This method does not call processIncomingData. It should only be used by the step method."	| i raw |	"map the sensor index to the corresponding channel"	i _ (sensorIndex asInteger max: 1) min: readouts size."	useGoGoProtocol ifFalse: [		scratchBoardV3			ifTrue: [i _ #(8 6 7 4 5 3 2 1) at: i] 			ifFalse: [i _ #(5 6 7 8 1 2 3 4) at: i]]."	raw _ sensorValues at: i.	reportRaw _ true.	" return Rawdata surely. "	reportRaw ifTrue: [^ raw].	" Following code unexecuted in which "	scratchBoardV3 ifTrue: [		i = 6 ifTrue: [^ self scaleLight: raw].		i = 7 ifTrue: [^ self scaleSound: raw]].	raw > 1020 ifTrue: [raw _ 1023].  "avoids jitter in the range 1021-1023"	^ (100.0 * raw) / 1023.0  ! !!PinAssignMorph methodsFor: 'sensor ops' stamp: 'KK 4/7/2014 13:09'!sensor: sensorIndex	"Answer the value of the virtual sensor with the given index. Sensors are numbered 1-8."	^ self privateSensor: sensorIndex! !!PinAssignMorph methodsFor: 'sensor ops' stamp: 'KK 4/7/2014 13:09'!startReadingData	"Ensure that the serial port is open, turn off all motors and put them into a known state, and begin streaming sensor data."	self portIsOpen ifFalse: [^ self].  "could not open the serial port"	currentState _ #idle."	sensorValues atAllPut: 0."	scratchBoardV3 _ false.	self startStreamingSensors: 0.  "in case board was left in streaming mode"	port flushInputBuffer.	useGoGoProtocol ifTrue: [		1 to: 6 do: [:motor |			self turnOffMotor: motor.			self thisWayMotor: motor.			self setPower: 3 motor: motor.			self turnOffMotor: motor].		self startStreamingSensors: 16rFF].  "all 8 sensors"! !!PinAssignMorph methodsFor: 'sensor ops' stamp: 'KK 4/7/2014 13:09'!stopReadingData	"Turn off all motors, stop streaming data, and close the port."	(port notNil and: [port isOpen]) ifTrue: [		useGoGoProtocol ifTrue: [			1 to: 6 do: [:motor | self turnOffMotor: motor].			self startStreamingSensors: 0]].  "turn off streaming"	self closePort.! !!PinAssignMorph methodsFor: 'motor ops' stamp: 'KK 4/7/2014 13:09'!selectMotor: anInteger	"Select the motor to which subsequent motor commands will be addressed. Motors are numbered 1-6."	| motorNum msg |	motorNum _ (anInteger truncated - 1 max: 0) min: 7. "motor bit index"	msg _ #(84 254 128 0) asByteArray.	msg at: 4 put: (1 bitShift: motorNum).	port nextPutAll: msg.! !!PinAssignMorph methodsFor: 'motor ops' stamp: 'KK 4/7/2014 13:09'!setPower: aNumber motor: motorNum	"Set the power of the given motor to 0 to 7."	| power msg |	self portIsOpen ifFalse: [^ self].	self selectMotor: motorNum.	power _ (aNumber truncated max: 0) min: 7.	msg _ #(84 254 0) asByteArray.	msg at: 3 put: 96 + (power bitShift: 2).	port nextPutAll: msg.! !!PinAssignMorph methodsFor: 'motor ops' stamp: 'KK 4/7/2014 13:09'!thatWayMotor: motorNum	"Set motor direction to that way."	self portIsOpen ifFalse: [^ self].	self selectMotor: motorNum.	port nextPutAll: #(84 254 80) asByteArray.! !!PinAssignMorph methodsFor: 'motor ops' stamp: 'KK 4/7/2014 13:09'!thisWayMotor: motorNum	"Set motor direction to this way."	self portIsOpen ifFalse: [^ self].	self selectMotor: motorNum.	port nextPutAll: #(84 254 76) asByteArray.! !!PinAssignMorph methodsFor: 'motor ops' stamp: 'KK 4/7/2014 13:09'!turnOffMotor: motorNum	self portIsOpen ifFalse: [^ self].	self selectMotor: motorNum.	port nextPutAll: #(84 254 68) asByteArray.! !!PinAssignMorph methodsFor: 'stepping' stamp: 'KK 3/3/2015 15:50'!step	"Update my title and sensor readouts. If scanning for ports, keep scanning."	| |	#checkData = scanState ifTrue: [self scanForPort].	self updateTitle.! !!PinAssignMorph methodsFor: 'stepping' stamp: 'KK 4/7/2014 13:09'!stepTime	^ 50! !!PinAssignMorph methodsFor: 'serial port' stamp: 'KK 4/7/2014 13:09'!scanForPort	"Try to find the serial port that the sensor board is attached to. This is incremental--each time it is called it does the next task."	"Details: scanState is one of: #(off, start, checkData, on). scanPorts is a list of port names to try. Attempt to open each port in turn, then wait for a while and see if Scratch Sensor data of the right form has arrived."	| msecs buf i |	#off = scanState ifTrue: [self scanNextPort].	#on = scanState ifTrue: [  "if port is open, close it and start a new scan"		scanPorts _ nil.		self scanNextPort].	#start = scanState ifTrue: [		(scanPorts isNil or: [scanPorts size = 0]) ifTrue: [			scanPorts _ self portNames asOrderedCollection].		scanPorts size = 0 ifTrue: [^ self scanNextPort].		self openPort: scanPorts removeFirst.		self portIsOpen ifFalse: [^ self].		scanState _ #checkData.		scanStartMSecs _ Time millisecondClockValue.		^ self].	#checkData = scanState ifTrue: [		msecs _ Time millisecondClockValue - scanStartMSecs.		(self portIsOpen not or: [msecs > 4000]) ifTrue: [^ self scanNextPort].		port nextPut: 1.  "send poll byte"		((buf _ port readByteArray) size < 10) ifTrue: [^ self].  "no data yet"		"check that the data is in Scratch Sensor Board format"		i _ (buf first bitAnd: 128) > 0 ifTrue: [1] ifFalse: [2].		[i < (buf size - 1)] whileTrue: [			(((buf at: i) bitAnd: 128) > 0 and:			 [((buf at: i + 1) bitAnd: 128) = 0]) ifFalse: [^ self scanNextPort].			i _ i + 2].		scanState _ #on].! !!PinAssignMorph methodsFor: 'serial port' stamp: 'KK 4/7/2014 13:09'!scanNextPort	"Called during port scanning. The current port does not seem to be a ScratchBoard. Close it and try the next port in the list."	self closePort.	scanState _ #start.! !!PinAssignMorph methodsFor: 'serial port' stamp: 'KK 4/7/2014 13:09'!selectPort	| menu choice |	self stopReadingData.	self portNames size = 0 ifTrue: [^ DialogBoxMorph inform: 'No serial ports found'].	menu _ CustomMenu new.	self portNames do: [:n | menu add: n action: n].	choice _ menu startUp.	choice ifNil: [^ self].	self openPort: choice.	self startReadingData.	scanState _ #on.! !!PinAssignMorph methodsFor: 'serial port' stamp: 'KK 4/7/2014 13:09'!selectPort:  portNum	self stopReadingData.	self openPort: portNum.	self startReadingData.	ResetCounter _ 0.! !!PinAssignMorph methodsFor: 'serial port' stamp: 'KK 4/7/2014 13:09'!tryToOpenPort	"Attempt to open the port. If successful, or if the port was open already, answer true. Otherwise, answer false."	(port notNil and: [port isOpen and: [scanState = #on]]) ifTrue: [^ true].  "already open"	self scanForPort.	^ port notNil and: [port isOpen]! !!PinAssignMorph methodsFor: 'serial port' stamp: 'KK 4/7/2014 13:09'!useGoGoProtocol	self stopReadingData.	useGoGoProtocol _ true.	scratchBoardV3 _ false.	self startReadingData.! !!PinAssignMorph methodsFor: 'serial port' stamp: 'KK 4/7/2014 13:09'!useScratchboardProtocol	self stopReadingData.	useGoGoProtocol _ false.	self startReadingData.! !!PinAssignMorph methodsFor: 'event handling' stamp: 'KK 4/7/2014 13:09'!handlesMouseDown: evt	^ true! !!PinAssignMorph methodsFor: 'event handling' stamp: 'KK 7/7/2014 18:46'!mouseDown: evt"	evt rightButtonPressed | evt shiftPressed		ifTrue: [Sensor waitNoButton. ^ self rightButtonMenu].	evt hand toolType = 'CutTool' ifTrue: [		evt shiftPressed ifFalse: [evt hand toolType: nil].		ScratchFrameMorph putInClipboard: self.		^ self delete]."	evt hand waitForClicksOrDrag: self event: evt.! !!PinAssignMorph methodsFor: 'event handling' stamp: 'KK 7/7/2014 18:44'!mouseHold: evt"	self rightButtonMenu."! !!PinAssignMorph methodsFor: 'event handling' stamp: 'KK 4/7/2014 13:09'!preemptsMouseDown: evt	^ false! !!PinAssignMorph methodsFor: 'event handling' stamp: 'KK 4/7/2014 13:09'!rightButtonMenu	| menu |	menu _ CustomMenu new.	Sensor shiftPressed		ifTrue: [			reportRaw				ifTrue: [menu add: 'stop reporting raw data' action: #toggleRawMode]				ifFalse: [menu add: 'report raw data' action: #toggleRawMode].			useGoGoProtocol				ifTrue: [menu add: 'use Scratch board' action: #useScratchboardProtocol]				ifFalse: [menu add: 'use GoGo board' action: #useGoGoProtocol]]		ifFalse: [			menu add: 'select serial/USB port' action: #selectPort.			self portIsOpen				ifTrue: [menu add: 'close port' action: #stopReadingData].			menu addLine.			menu add: 'hide' action: #delete].	menu localize; invokeOn: self.! !!PinAssignMorph methodsFor: 'event handling' stamp: 'KK 4/7/2014 13:09'!toggleRawMode	reportRaw _ reportRaw not.! !!PinAssignMorph methodsFor: 'dropping/grabbing' stamp: 'KK 7/28/2014 12:59'!justDroppedInto: newOwner event: evt	| |	"Only allow embedding into the stage; otherwise, float (i.e. be a submorph of the world)."	"Board cannot be dropped onto the starge""	(owner isKindOf: ScratchStageMorph) ifTrue: [		super justDroppedInto: newOwner event: evt	]	ifFalse: [		evt hand rejectDropMorph: self event: evt.	].	"	self world addMorph: self."	(newOwner isKindOf: ScratchStageMorph) ifFalse: [" "only embed in the work pane""		self world addMorph: self]."! !!PinAssignMorph methodsFor: 'object i/o' stamp: 'KK 4/7/2014 13:09'!fieldsVersion	^ 1! !!PinAssignMorph methodsFor: 'object i/o' stamp: 'KK 4/7/2014 13:09'!initFieldsFrom: anObjStream version: classVersion	super initFieldsFrom: anObjStream version: classVersion.	anObjStream nextField.  "skip old portNum field"	self addReadouts.! !!PinAssignMorph methodsFor: 'object i/o' stamp: 'KK 4/7/2014 13:09'!storeFieldsOn: anObjStream	super storeFieldsOn: anObjStream.	anObjStream putField: 1.  "old portNum instance variable"! !!PinAssignMorph methodsFor: 'private' stamp: 'KK 4/7/2014 13:09'!buttonLabel: labelString action: actionSelector	"Answer a new button with the given label and selector. The button target will be me and it will use my button forms."	"(DialogBoxMorph new buttonLabel: 'Yes' action: #beep) openInWorld"	| onForm offForm button overForm |	onForm _ ScratchFrameMorph skinAt: #btnPressed.	offForm _ ScratchFrameMorph skinAt: #btn.	overForm _ ScratchFrameMorph skinAt: #btn.	button _ ResizableToggleButton2 new		offForm: offForm		onForm: onForm		overForm: overForm.	^ button		padding: 20@10;		label: labelString font: (ScratchFrameMorph getFont: #DialogBoxButton);		target: self;		actionSelector: actionSelector;		setLabelColor: (Color gray: 0.15)! !!PinAssignMorph methodsFor: 'private' stamp: 'KK 3/3/2015 11:35'!hideOptionBlocks	"hide option parts blocks"! !!PinAssignMorph methodsFor: 'private' stamp: 'KK 3/6/2015 18:19'!removeItem: order	| |	"Answer a collection of A0-A1 connectable parts name."	selectedIR ifFalse: [ order remove: 'Infrared receiver' ].	selectedBT ifFalse: [ order remove: 'Bluetooth' ].	^ order.! !!PinAssignMorph methodsFor: 'private' stamp: 'KK 4/7/2014 13:09'!scaleLight: val	val <= 25 ifTrue: [^ 100 - val].	^ ((1023 - val) * (75.0 / 998)) rounded! !!PinAssignMorph methodsFor: 'private' stamp: 'KK 4/7/2014 13:09'!scaleSound: val	| n |	n _ ((val - 18) max: 0) min: 630.	n < 50 ifTrue: [^ n / 2.0].  "0 to 25"	^ 25.0 + ((n - 50) * (75.0 / 580.0))! !!PinAssignMorph methodsFor: 'private' stamp: 'KK 3/24/2015 13:13'!sensorPartsNameA01OP	| myOrderedCollection |	"Answer a collection of A0-A1 connectable parts name."	myOrderedCollection _ OrderedCollection new.	myOrderedCollection add: 'Light sensor';		add: TouchSensorName;		add: SoundSensorName;		add: IRPhotoreflectorName;		add: LEDName;		add: BuzzerName;		add: '-';		add: UltrasonicSensorName.	selectedIR ifFalse: [ myOrderedCollection add: InfraredReceiverName ].	myOrderedCollection add: TemperatureSensorName.	selectedBT ifFalse: [ myOrderedCollection add: BluetoothName ].	^ myOrderedCollection.! !!PinAssignMorph methodsFor: 'private' stamp: 'KK 3/27/2015 11:12'!sensorPartsNameA01OP: selfOption	| myOrderedCollection |	"Answer a collection of A0-A1 connectable parts name."	myOrderedCollection _ OrderedCollection new.	myOrderedCollection add: 'Light sensor';		add: TouchSensorName;		add: SoundSensorName;		add: IRPhotoreflectorName;		add: LEDName;		add: BuzzerName;		add: '-';		add: UltrasonicSensorName.	selectedIR ifFalse: [ myOrderedCollection add: InfraredReceiverName ]	ifTrue: [		(selfOption = InfraredReceiverName) ifTrue: [			myOrderedCollection add: InfraredReceiverName ].	].	myOrderedCollection add: TemperatureSensorName.	selectedBT ifFalse: [ myOrderedCollection add: BluetoothName ]	ifTrue: [		(selfOption = BluetoothName) ifTrue: [			myOrderedCollection add: BluetoothName ].	].	^ myOrderedCollection.! !!PinAssignMorph methodsFor: 'private' stamp: 'KK 3/24/2015 13:15'!sensorPartsNameA23OP	| myOrderedCollection |	"Answer a collection of A0-A1 connectable parts name."	" ir : true(selected) / false(not select) "	" bt : true(selected) / false(not select) "	myOrderedCollection _ OrderedCollection new.	myOrderedCollection add: LightSensorName;		add: TouchSensorName;		add: SoundSensorName;		add: IRPhotoreflectorName;		add: LEDName;		add: BuzzerName;		add: '-'.	selectedIR ifFalse: [ myOrderedCollection add: InfraredReceiverName ].	myOrderedCollection add: TemperatureSensorName.	selectedBT ifFalse: [ myOrderedCollection add: BluetoothName ].	^ myOrderedCollection.! !!PinAssignMorph methodsFor: 'private' stamp: 'KK 3/26/2015 19:18'!sensorPartsNameA23OP: selfOption	| myOrderedCollection |	"Answer a collection of A0-A1 connectable parts name."	" ir : true(selected) / false(not select) "	" bt : true(selected) / false(not select) "	myOrderedCollection _ OrderedCollection new.	myOrderedCollection add: LightSensorName;		add: TouchSensorName;		add: SoundSensorName;		add: IRPhotoreflectorName;		add: LEDName;		add: BuzzerName;		add: '-'.	selectedIR ifFalse: [ myOrderedCollection add: InfraredReceiverName ]	ifTrue: [		(selfOption = InfraredReceiverName) ifTrue: [			myOrderedCollection add: InfraredReceiverName ].	].	myOrderedCollection add: TemperatureSensorName.	selectedBT ifFalse: [ myOrderedCollection add: BluetoothName ]	ifTrue: [		(selfOption = BluetoothName) ifTrue: [			myOrderedCollection add: BluetoothName ].	].	^ myOrderedCollection.! !!PinAssignMorph methodsFor: 'private' stamp: 'KK 3/24/2015 13:17'!sensorPartsNameA45OP	| myOrderedCollection |	"Answer a collection of A0-A1 connectable parts name."	" ir : true(selected) / false(not select) "	" bt : true(selected) / false(not select) "	myOrderedCollection _ OrderedCollection new.	myOrderedCollection add: LightSensorName;		add: TouchSensorName;		add: SoundSensorName;		add: IRPhotoreflectorName;		add: AccelerometerName;		add: LEDName;		add: BuzzerName;		add: '-'.	selectedIR ifFalse: [ myOrderedCollection add: InfraredReceiverName ].	myOrderedCollection add: TemperatureSensorName.	selectedBT ifFalse: [ myOrderedCollection add: BluetoothName ].	myOrderedCollection add: GyroSensorName;		add: ColorSensorName.	^ myOrderedCollection.! !!PinAssignMorph methodsFor: 'private' stamp: 'KK 3/26/2015 19:18'!sensorPartsNameA45OP: selfOption	| myOrderedCollection |	"Answer a collection of A0-A1 connectable parts name."	" ir : true(selected) / false(not select) "	" bt : true(selected) / false(not select) "Transcript show:selfOption.	myOrderedCollection _ OrderedCollection new.	myOrderedCollection add: LightSensorName;		add: TouchSensorName;		add: SoundSensorName;		add: IRPhotoreflectorName;		add: AccelerometerName;		add: LEDName;		add: BuzzerName;		add: '-'.	selectedIR ifFalse: [ myOrderedCollection add: InfraredReceiverName ]	ifTrue: [		(selfOption = InfraredReceiverName) ifTrue: [			myOrderedCollection add: InfraredReceiverName ].	].	myOrderedCollection add: TemperatureSensorName.	selectedBT ifFalse: [ myOrderedCollection add: BluetoothName ]	ifTrue: [		(selfOption = BluetoothName) ifTrue: [			myOrderedCollection add: BluetoothName ].	].	myOrderedCollection add: GyroSensorName;		add: ColorSensorName.	^ myOrderedCollection.! !!PinAssignMorph methodsFor: 'private' stamp: 'KK 3/24/2015 13:18'!sensorPartsNameA67OP	| myOrderedCollection |	"Answer a collection of A0-A1 connectable parts name."	" ir : true(selected) / false(not select) "	" bt : true(selected) / false(not select) "	myOrderedCollection _ OrderedCollection new.	myOrderedCollection add: LightSensorName;		add: SoundSensorName;		add: IRPhotoreflectorName;		add: '-'.	myOrderedCollection add: TemperatureSensorName.	selectedBT ifFalse: [ myOrderedCollection add: BluetoothName ].	^ myOrderedCollection.! !!PinAssignMorph methodsFor: 'private' stamp: 'KK 3/3/2015 11:34'!setOptionPartsFlag	"set option parts flag"! !!PinAssignMorph methodsFor: 'private' stamp: 'KK 3/3/2015 11:35'!showOptionBlocks	"show option parts blocks"! !!PinAssignMorph methodsFor: 'private' stamp: 'KK 4/7/2014 13:09'!startStreamingSensors: sensorByte	"Begin streaming data from the set of sensors specified by the bits of the given byte. Invoke this method with 0 to stop streaming. Incoming sensor data is processed by frequent calls to processIncomingData."	| cmd |	useGoGoProtocol ifFalse: [^ self].	port flushInputBuffer.	cmd _ #(84 254 160 0) asByteArray.	cmd at: 4 put: sensorByte.	port nextPutAll: cmd.! !!PinAssignMorph methodsFor: 'private' stamp: 'KK 5/26/2014 17:33'!updateButtonTitle	"Update my title to reflect the current protocol and port number."	| s |	s _ 'Button' localized.	s = buttonTitleMorph contents ifFalse: [buttonTitleMorph contents: s].! !!PinAssignMorph methodsFor: 'private' stamp: 'KK 5/26/2014 17:27'!updateDCTitle	"Update my title to reflect the current protocol and port number."	| s |	s _ 'DC motor' localized.	s = dcTitleMorph contents ifFalse: [dcTitleMorph contents: s].! !!PinAssignMorph methodsFor: 'private' stamp: 'KK 9/25/2017 18:26'!updateMotorButtonPAArea	"Update servomotor calibration."	|  |	" -------------------------------------------------------------------- "	" 	DC motor pin assign area. "	" -------------------------------------------------------------------- "	pinInfo at:1 put: nil.		" M1 "	pinInfo at:2 put: nil.		" M2 "	" -------------------------------------------------------------------- "	" 	Servomotor pin assign area. "	" -------------------------------------------------------------------- "	pinInfo at:3 put: nil.		" D2 "	pinInfo at:4 put: nil.		" D4 "	pinInfo at:5 put: nil.		" D7 "	pinInfo at:6 put: nil.		" D8 "	pinInfo at:7 put: nil.		" D9 "	pinInfo at:8 put: nil.		" D10 "	pinInfo at:9 put: nil.		" D11 "	pinInfo at:10 put: nil.		" D12 "	" -------------------------------------------------------------------- "	"	Button pin assign area. "	" -------------------------------------------------------------------- "	pinInfo at:11 put: nil.		" A0 "	pinInfo at:13 put: nil.		" A2 "	pinInfo at:12 put: nil.		" A1 "	pinInfo at:14 put: nil.		" A3 "! !!PinAssignMorph methodsFor: 'private' stamp: 'KK 9/25/2017 19:07'!updateSensorPAArea	"Update sensor pin assign. "	|  pn sensorPA rowTemp |	sensorTitleMorph _ StringMorph		contents: ''		font: (StrikeFont fontName: 'VerdanaBold' size: 10).	sensorPAArea addMorph: sensorTitleMorph.	self updateSensorTitle.	sensorPAArea addMorphBack: (Morph new color: sensorPAArea color; extent: 5@3).  "spacer"	pinInfo at:15 put: nil.	" A0 "	pinInfo at:19 put: nil.	" A4 "	sensorPA _ AlignmentMorph newRow		color:sensorPAArea color;		borderColor: (Color r: (148/255) g: (145/255) b: (145/255));		useRoundedCorners;		inset: 3.	sensorPAArea addMorphBack: sensorPA.		pn _ #(A1).	rowTemp _ self addPACheckComboBox: sensorPA pinNames: pn.	pinInfo at:16 put:(rowTemp at:1).		" A1 "	pinInfo at:20 put: nil.	" A5 "	sensorPA _ AlignmentMorph newRow		color:sensorPAArea color;		borderColor: (Color r: (148/255) g: (145/255) b: (145/255));		useRoundedCorners;		inset: 3.	sensorPAArea addMorphBack: sensorPA.		pn _ #(A2).	rowTemp _ self addPACheckComboBox: sensorPA pinNames: pn.	pinInfo at:17 put:(rowTemp at:1).		" A2 "	pinInfo at:21 put: nil.	" A6 "	pinInfo at:18 put: nil.	" A3 "	pinInfo at:22 put: nil.	" A7 "! !!PinAssignMorph methodsFor: 'private' stamp: 'KK 9/25/2017 17:59'!updateSensorTitle	"Update my title to reflect the current protocol and port number."	| s |	s _ 'Sensor' localized.	s = sensorTitleMorph contents ifFalse: [sensorTitleMorph contents: s].! !!PinAssignMorph methodsFor: 'private' stamp: 'KK 5/26/2014 17:33'!updateServoTitle	"Update my title to reflect the current protocol and port number."	| s |	s _ 'Servomotor' localized.	s = servoTitleMorph contents ifFalse: [servoTitleMorph contents: s].! !!PinAssignMorph methodsFor: 'private' stamp: 'KK 4/8/2014 17:41'!updateTitle	"Update my title to reflect the current protocol and port number."	| s |	s _ (#on = scanState) ifTrue: ['On' localized] ifFalse: ['Pin Assignment Board' localized].	s = titleMorph contents ifFalse: [titleMorph contents: s].! !!ReporterBlockMorph methodsFor: 'watcher' stamp: 'KK 8/19/2014 14:07'!canBecomeWatcher	"I determine which blocks can become watchers."	selector ifNotNil: [		(selector = #timer) ifTrue: [ ^ true.].	].	^ false.! !!ScratchBlockPaletteMorph methodsFor: 'initialization' stamp: 'KK 9/20/2013 17:28'!initialize	super initialize.	borderWidth _ 0.! !!ScratchBlockPaletteMorph methodsFor: 'other' stamp: 'KK 9/20/2013 17:25'!fixLayout	"Right align the blocks in the palette if RTL is set to true. The watcher toggle checkbox buttons are assumed to be about 18 pixels wide."	| offset r |	owner ifNil: [^ self].	ScratchTranslator isRTL ifTrue:[		self submorphs do: [:m |			(m isKindOf: BlockMorph) ifTrue: [				m canBecomeWatcher					ifTrue: [m position: (self right - m width - 18 - 10)@(m position y)]					ifFalse: [m position: (self right - m width - 10)@(m position y)].				m changed].			((m isKindOf: ToggleButton) or: [m isKindOf: ResizableToggleButton2]) ifTrue:[	"watcher checkbox case"				m position: (self right - m width - 10)@(m position y)].			(m isKindOf: ImageMorph) ifTrue: [				m position: (self right - m width - 10)@(m position y)]]].	offset _ self topLeft negated.	r _ 0@0 extent: 1@1.	self submorphsDo: [:m |		r _ r quickMerge: (m fullBounds translateBy: offset) truncated].	self width: (r width max: owner width).! !!ScratchBlockPaletteMorph methodsFor: 'other' stamp: 'KK 9/20/2013 11:35'!updateWatcherButtonsForFrame: frame	"Update the watcher button on this palette."	| reporter sprite selAndArg |	frame ifNil: [^ self].	submorphs do: [:b |		((b isKindOf: ToggleButton) and:		 [b target isKindOf: ReporterBlockMorph]) ifTrue: [			reporter _ b target.			sprite _ reporter getAssociatedSprite.			selAndArg _ reporter selectorAndArg.			(frame watcherShowingFor: sprite selectorAndArg: selAndArg)				ifTrue: [b on; setProperty: #balloonText toValue: 'Remove viewer from stage' localized]				ifFalse: [b off; setProperty: #balloonText toValue: 'View on stage' localized]]].! !!ScratchFileChooserDialog methodsFor: 'initialization' stamp: 'KK 9/21/2013 15:06'!addShortcutButtons	"Add shortcut buttons for my type to the shortcutColumn."	| spacer |	spacer _ Morph new extent: 5@5; color: Color transparent.	shortcutColumn removeAllMorphs.	shortcutColumn addMorphBack: (self shortcutButtonLabel: 'Computer' action: #myComp icon: #folderDiscsIcon).	shortcutColumn addMorphBack: spacer fullCopy.	shortcutColumn addMorphBack: (self shortcutButtonLabel: self labelForHomeFolder action: #myHome icon: #folderHouseIcon).	shortcutColumn addMorphBack: spacer fullCopy.	shortcutColumn addMorphBack: (self shortcutButtonLabel: 'Desktop' action: #myDesktop icon: #folderIcon).	shortcutColumn addMorphBack: spacer fullCopy.	#background = self type ifTrue: [		shortcutColumn addMorphBack:			(self shortcutButtonLabel: 'Backgrounds' action: #scratchBackgrounds icon: #folderCatIcon)].	#costume = self type ifTrue: [		shortcutColumn addMorphBack:			(self shortcutButtonLabel: 'Costumes' action: #scratchCostumes icon: #folderCatIcon)].	#project = self type ifTrue: ["		shortcutColumn addMorphBack:			(self shortcutButtonLabel: 'Examples' action: #sampleProjects icon: #folderCatIcon).		shortcutColumn addMorphBack: spacer fullCopy.		shortcutColumn addMorphBack:			(self shortcutButtonLabel: 'My Projects' action: #userProjects icon: #folderIcon)"].	#sound = self type ifTrue: [		shortcutColumn addMorphBack:			(self shortcutButtonLabel: 'Sounds' action: #scratchSounds icon: #folderCatIcon)].! !!ScratchFileChooserDialog methodsFor: 'initialization' stamp: 'KK 10/20/2017 16:52'!createScratchFileChooserFor: aScratchFrameMorph saving: savingFlag	"Create a Scratch file chooser dialog box with a project thumbnail and info box."	| labelFont contentsFont commentFont thumbnailHolder |	scratchFrame _ aScratchFrameMorph.	readingScratchFile _ savingFlag not.	list _ ScratchFilePicker new extensions: #(scratch bpde).	TabletMode ifTrue: [		list extent: 380@220].	self removeAllMorphs.	bottomSpacer delete.	bottomSpacer _ nil.	mainColumn addMorphBack: list.	savingFlag ifFalse: [		self title: 'Open Project'.		list scratchInfoClient: self].	labelFont _ (ScratchFrameMorph getFont: #FileChooserLabel).	contentsFont _ (ScratchFrameMorph getFont: #FileChooserContents).	commentFont _ (ScratchFrameMorph getFont: #FileChooserComment).	savingFlag ifTrue: [		self title: 'Save Project'.		newFileTitle _ StringMorph contents: ('New Filename:' localized, ' ') font: labelFont.		newFileTitle color: (Color gray: 0.3).		newFileName _ StringFieldMorph new			contents: scratchFrame projectName;			client: self;			font: contentsFont;			color: (Color r: (211/255) g: (214/255) b: (216/255));			width: 180.		tabFields add: newFileName.		newTitleBin			addMorphBack: newFileTitle;			addMorphBack: (Morph new extent: (5@5); color: Color transparent);			addMorphBack: newFileName;			addMorphBack: (AlignmentMorph newSpacer: Color transparent).		ScratchTranslator isRTL			ifTrue: [newTitleBin submorphs reversed do: [:m |				m delete.				newTitleBin addMorphBack: m]]].	mainColumn		addMorphBack: (Morph new extent: (5@9); color: Color transparent);		addMorphBack: newTitleBin.	thumbnailHolder _ AlignmentMorph newColumn		centering: #center;		color: Color transparent.	thumbnailFrameMorph _ ImageFrameMorph new		initFromForm: (ScratchFrameMorph skinAt: #dialogThumbnailFrame).	thumbnailFrameMorph extent: (170@130).	thumbnailHolder addMorph: thumbnailFrameMorph."	fileInfoColumn		addMorphBack: thumbnailHolder;		addMorphBack: (Morph new extent: (5@6); color: Color transparent)." "spacer"	thumbnailMorph _ ImageMorph new form: (Form extent: 160@120 depth: 1).	thumbnailFrameMorph addMorphFront: (thumbnailMorph position: ((thumbnailFrameMorph position) + (5@5))).	authorLabelMorph _ StringMorph contents: 'Project author:' localized font: labelFont.	authorLabelMorph color: (Color gray: 0.3)."	fileInfoColumn addMorphBack: authorLabelMorph."	savingFlag		ifTrue: [authorMorph _ StringFieldMorph new			useStringFieldFrame;			contents: '';			font: contentsFont.			tabFields add: authorMorph]		ifFalse: [fileInfoColumn addMorphBack: (Morph new extent: (5@6); color: Color transparent). "spacer"			authorMorph _ StringFieldMorph new				color: Color transparent;				borderWidth: 0;				contents: '';				isEditable: false;				font: contentsFont].	fileInfoColumn		addMorphBack: authorMorph;		addMorphBack: (Morph new extent: (5@6); color: Color transparent). "spacer"	commentLabelMorph _ StringMorph contents: 'About this project:' localized font: labelFont.	commentLabelMorph color: authorLabelMorph color."	fileInfoColumn addMorphBack: commentLabelMorph."	commentMorph _ ScrollingStringMorph new		borderWidth: 0;		contents: '';		font: commentFont;		extent: (210@110).	savingFlag		ifTrue: [commentMorph backForm: (ScratchFrameMorph skinAt: #stringFieldFrame).			tabFields add: commentMorph]		ifFalse: [commentMorph isEditable: false]."	fileInfoColumn addMorphBack: commentMorph.""	fileInfoColumn addMorphBack: buttonRow."	TabletMode ifTrue: [		newTitleBin addMorphBack: buttonRow]	ifFalse: [		mainColumn addMorphBack: buttonRow].	self		addMorphBack: shortcutColumn;		addMorphBack: mainColumn."		addMorphBack: fileInfoColumn."	savingFlag ifTrue: [		self scratchInfo: scratchFrame projectInfo.		thumbnailMorph form: scratchFrame workPane thumbnailForm.		"default author field to login name if known; else author"		(aScratchFrameMorph loginName size > 0)			ifTrue: [authorMorph contents: aScratchFrameMorph loginName]			ifFalse: [authorMorph contents: aScratchFrameMorph author]].! !!ScratchFileChooserDialog methodsFor: 'initialization' stamp: 'sk 2/20/2017 17:47'!getUserResponse	"Wait for the user to respond, then answer the full path name of the chosen file or #cancelled if the user cancels the operation. If opening a remote file for reading, answer a HTTPFetcher on the remote file."	"Details: This is invoked synchronously from the caller. In order to keep processing inputs and updating the screen while waiting for the user to respond, this method has its own version of the World's event loop."	| w |	self openInWorld.	w _ self world.	w activeHand newKeyboardFocus: (tabFields at: 1).	TabletMode ifTrue: [		self topCenterOnScreen]	ifFalse: [		self centerOnScreen].	newFileName ifNotNil: [w activeHand newKeyboardFocus: newFileName].	list getDirectoryContents.	response _ #cancelled.  "default response"	done _ false.	[done or: [list isFinalSelection]] whileFalse: [w doOneCycle].	self delete.	w doOneCycle.  "erase myself from the screen"	((response = #cancelled) and: [list isFinalSelection not]) ifTrue: [^ #cancelled].	list selectedFile ifNil: [^ #cancelled].	(thumbnailMorph notNil & readingScratchFile not) ifTrue: [  "save info in project"		scratchFrame author: authorMorph contents withBlanksTrimmed.		scratchFrame projectComment: commentMorph contents].	(list currentDirectory isKindOf: ScratchServerDirectory)		ifTrue: [^ list projectFetcher]		ifFalse: [^ list currentDirectory fullNameFor: list selectedFile].! !!ScratchFileChooserDialog methodsFor: 'initialization' stamp: 'sk 4/24/2017 09:49'!initialize	"Create the file chooser dialog box"	super initialize.	choosingFolder _ false.	scratchFrame _ nil.	readingScratchFile _ false.	fCursorOut _ true.	newTitleBin _ AlignmentMorph newRow		centering: #center;		color: Color transparent.	buttonRow hResizing: #spaceFill.	TabletMode ifTrue: [		mainColumn orientation: #horizontal.		newTitleBin orientation: #vertical].	self withButtonsForYes: false no: false okay: true cancel: true.! !!ScratchFileChooserDialog methodsFor: 'accessing' stamp: 'sk 2/20/2017 17:44'!createFileChooserLayout: allowNewFile	"Create the file chooser dialog box."	list _ ScratchFilePicker new.	self removeAllMorphs.	bottomSpacer delete.	bottomSpacer _ nil.	mainColumn addMorphBack: list.	self title: 'Open'.	allowNewFile ifTrue: [		self title: 'Save As'.		newFileTitle _ StringMorph new			contents: 'New Filename:' localized, ' ';			color: (Color gray: 0.3);			font: (ScratchFrameMorph getFont: #FileChooserNewFileTitle).		newFileName _ StringFieldMorph new			font: (ScratchFrameMorph getFont: #FileChooserNewFilename);			color: (Color r: (211/255) g: (214/255) b: (216/255));			width: 180.		newTitleBin			addMorphBack: newFileTitle;			addMorphBack: (Morph new extent: (5@5); color: Color transparent);			addMorphBack: newFileName;			addMorphBack: (AlignmentMorph newSpacer: Color transparent).			ScratchTranslator isRTL		ifTrue: [newTitleBin submorphs reversed do: [:m |			m delete.			newTitleBin addMorphBack: m]]].	TabletMode ifTrue: [		newTitleBin addMorphBack: buttonRow.		mainColumn addMorphBack: newTitleBin]	ifFalse: [		mainColumn addMorphBack: newTitleBin;			addMorphBack: buttonRow].	self		addMorphBack: shortcutColumn;		addMorphBack: mainColumn."		addMorphBack: fileInfoColumn."! !!ScratchFileChooserDialog methodsFor: 'interaction' stamp: 'sk 2/20/2017 17:49'!getUserResponseForNewFile	"Wait for the user to respond, then answer the full path name of the new file or #cancelled if the user cancels the operation."	"Details: This is invoked synchronously from the caller. In order to keep processing inputs and updating the screen while waiting for the user to respond, this method has its own version of the World's event loop."	| w fn |	self openInWorld.	w _ self world.	w activeHand newKeyboardFocus: (tabFields at: 1).	self extent: self extent.  "force layout"	TabletMode ifTrue: [		self position: ((w width // 2) - (self width // 2)@5)]	ifFalse: [		self position: w center - (self extent // 2) + (0@5)].    "center on screen but disregard the shadow on the bottom"	newFileName ifNotNil: [w activeHand newKeyboardFocus: newFileName].	list getDirectoryContents.	[true] whileTrue: [		done _ false.		[done] whileFalse: [w doOneCycle].		response = #cancelled ifTrue: [^ #cancelled].		thumbnailMorph ifNotNil: [  "save info in project"			scratchFrame author: authorMorph contents withBlanksTrimmed.			scratchFrame projectComment: commentMorph contents].		fn _ newFileName contents withBlanksTrimmed.		fn size > 0 ifTrue: [			fn _ fn collect: [:ch | ('\/:' includes: ch) ifTrue: [$-] ifFalse: [ch]].  "replace directory delimiters with dashes"			^ list currentDirectory pathName, FileDirectory pathNameDelimiter asString, fn].		newFileTitle color: Color red.		self openInWorld.		w activeHand newKeyboardFocus: newFileName].! !!ScratchFileChooserDialog methodsFor: 'geometry' stamp: 'sk 3/16/2017 14:40'!extent: aPoint	super extent: aPoint.	mainColumn ifNotNil: [		mainColumn submorphs do: [:elm |			elm class = ScratchFilePicker ifTrue: [				elm height: ((elm height) - 22)]]].! !!ScratchFileChooserDialog methodsFor: 'stepping and presenter' stamp: 'sk 4/24/2017 09:51'!step	| current |	newFileName ifNil: [^ self].	current _ World activeHand keyboardFocus.	(current isKindOf: StringFieldMorph) ifTrue: [		]	ifFalse: [		fCursorOut ifTrue: [			World activeHand firstClickEvent ifNotNil: [				self cancelled]]].! !!ScratchFileChooserDialog methodsFor: 'stepping and presenter' stamp: 'sk 1/23/2017 23:41'!stepTime	^ 200! !!ScratchFileChooserDialog methodsFor: 'event handling' stamp: 'sk 4/21/2017 12:35'!handlesMouseOver: evt	^ true! !!ScratchFileChooserDialog methodsFor: 'event handling' stamp: 'sk 4/24/2017 09:50'!mouseEnter: evt	"Handle a mouse down event. This default implementation does nothing."	fCursorOut _ false.! !!ScratchFileChooserDialog methodsFor: 'event handling' stamp: 'sk 4/24/2017 09:50'!mouseLeave: evt	"Handle a mouse down event. This default implementation does nothing."	fCursorOut _ true.! !!ScratchFileChooserDialog class methodsFor: 'instance creation' stamp: 'sk 3/16/2017 14:50'!chooseExistingFileType: type extensions: anArrayOrNil title: titleString	| m |	ScratchFileChooserDialog deleteDuplicates.	m _ self new		createFileChooserLayout: false;		type: type;		extensions: anArrayOrNil;		title: titleString.	TabletMode ifTrue: [		m listExtent: 380@220].	^ m getUserResponse! !!ScratchFileChooserDialog class methodsFor: 'instance creation' stamp: 'sk 3/16/2017 14:49'!chooseNewFileDefault: defaultName title: titleString type: type	| m |	ScratchFileChooserDialog deleteDuplicates.	m _ self new		createFileChooserLayout: true;		type: type;		defaultName: defaultName;		title: titleString.	TabletMode ifTrue: [		m listExtent: 380@220]	ifFalse: [		m listExtent: 400@280].	^ m getUserResponseForNewFile! !!ScratchFileChooserDialog class methodsFor: 'instance creation' stamp: 'KK 10/20/2017 16:53'!saveScratchFileFor: aScratchFrameMorph	"Choose a file for saving the current Scratch project file. Display the thumbnail and info string for the current project and allow the info string to be edited. Answer the full name of the file in which to save the project or #cancelled if the operation is cancelled."	"ScratchFileChooserDialog saveScratchFileFor: nil"	| m result |	ScratchFileChooserDialog deleteDuplicates.	m _ self new		createScratchFileChooserFor: aScratchFrameMorph saving: true;		type: #project;		redirectSavesToSampleFolder.	result _ m getUserResponseForNewFile.	result = #cancelled ifTrue: [^ result].	(result asLowercase endsWith: '.bpde') ifFalse: [result _ result, '.bpde'].	^ result! !!ScratchFileChooserDialog class methodsFor: 'utilities' stamp: 'KK 10/20/2017 16:53'!confirmFileOverwriteIfExisting: aFilename	"If the given file exists, ask the user if they want to overwrite it or pick a different file name."	| response fName |	fName _ aFilename.	(fName endsWith: '.bpde') ifFalse: [fName _ fName, '.bpde'].	(FileDirectory default fileExists: fName) ifFalse: [^ aFilename].	response _ DialogBoxMorph		askWithCancel: 'The file name already exists. Overwrite existing file?'.	response = #cancelled ifTrue: [^ #cancelled].	response ifTrue: [^ fName] ifFalse: [^ false].! !!ScratchFilePicker methodsFor: 'private' stamp: 'KK 9/1/2014 11:57'!newDirectory	"Create a new directory."	| name |	ValueOrList _ false.	name _ StringDialog askWithCancel: 'New folder name:'.	name = '' ifTrue: [^ self].	[self currentDirectory createDirectory: name] ifError: [:err :rcvr |		^ DialogBoxMorph warn: 'Could not create folder.'].	self currentDirectory: self currentDirectory.! !!ScratchFrameMorph methodsFor: 'intialization' stamp: 'sk 3/17/2017 18:34'!addShortcutButtonsTo: rowMorph	| buttonSpecs b |	buttonSpecs _ #(		"name		tool tip				selector"		(language	'Set language'		languageMenu:)		(save		'Save this project'	saveScratchProjectNoDialog)	).	buttonSpecs do: [:spec |		b _ ToggleButton			onForm: ((ScratchFrameMorph skinAt: (spec at: 1), 'ButtonOver') magnifyBy: FontMagnification)			offForm: ((ScratchFrameMorph skinAt: (spec at: 1), 'Button') magnifyBy: FontMagnification)			overForm: ((ScratchFrameMorph skinAt: (spec at: 1), 'ButtonOver') magnifyBy: FontMagnification).		b			target: self;			actionSelector: (spec at: 3);			setBalloonText: (spec at: 2) localized;			actWhen: #buttonUp;			isMomentary: true.				('language' = (spec at: 1)) ifTrue: [  "language special case"			b arguments: (Array with: b)].		('save' = (spec at: 1)) ifTrue: [  "spacer"			rowMorph addMorphBack: (Morph new extent: (10@5); color: Color transparent)].		rowMorph addMorphBack: b].	rowMorph addMorphBack: (Morph new extent: (20@5); color: Color transparent).! !!ScratchFrameMorph methodsFor: 'intialization' stamp: 'sk 6/15/2016 10:41'!createBasicPanes	"Create and add my palette (viewer), script editor, stage, and library panes."	topPane _ ImageFrameMorph new initFromForm: (ScratchFrameMorph skinAt: 'topPane').	viewerPane _ ScratchViewerMorph new rebuildCategorySelectors.		scriptsPane _ ScratchScriptEditorMorph new.	stageFrame _ ImageFrameMorph new initFromForm: (ScratchFrameMorph skinAt: 'spriteLibraryPaneFrameTransparent2').	titlePane _ ImageFrameMorph new initFromForm: (ScratchFrameMorph skinAt: 'titlePane').	workPane _ ScratchStageMorph new extent: WorkpaneExtent.	libraryPane _ ScratchLibraryMorph new.	"make panes sticky so clicking on them doesn't pick up entire frame"	self		addMorph: (topPane isSticky: true);		addMorph: (viewerPane isSticky: true);		addMorph: (scriptsPane isSticky: true);		addMorph: (workPane isSticky: true);		addMorph: (stageFrame isSticky: true);		addMorph: (titlePane isSticky: true);		addMorph: (libraryPane isSticky: true).	self createReadoutPane.	workPane comeToFront.! !!ScratchFrameMorph methodsFor: 'intialization' stamp: 'sk 3/16/2017 15:19'!createFontSizeButton	| bt |	fontButtons _ AlignmentMorph new			color: (Color transparent);			centering: #bottomRight.	#(1.0 1.5 2.0) do: [:fSize |		bt _ SimpleButtonMorph new			color: (Color gray);			borderColor: (Color white);			target: self;			actionSelector: #setFontMagnification:;			arguments: {fSize};			label: 'aA' font: (StrikeFont fontName: #Verdana size: fSize * 10);			extent: (fSize * 10 + 17)@(fSize * 10 + 17).		fontButtons addMorphBack: bt.		fontButtons addMorphBack: (Morph new extent: 5@0)].	fontButtons position: (topPane topRight).	topPane addMorph: fontButtons.! !!ScratchFrameMorph methodsFor: 'intialization' stamp: 'sk 6/15/2016 11:40'!createLogo	"Create and the Scratch logo."	logoMorph _ SketchMorph withForm: (ScratchFrameMorph skinAt: #studuinoLogo).	logoMorph position: topPane position + (12@8).	topPane addMorph: logoMorph.! !!ScratchFrameMorph methodsFor: 'intialization' stamp: 'KK 9/27/2017 17:34'!createMenuPanel	"Create and add a panel containing the menus and close button."	| menuSpecs m code |	"create panel"	menuPanel _ AlignmentMorph new		color: Color transparent;		centering: #center;		inset: 0;		height: 0.	"will grow as needed"	self addShortcutButtonsTo: menuPanel.	"menuSpecs defines the menus"	code _ ScratchTranslator currentLanguage.	(code = 'en') | (code = 'ja') | (code = 'ja_HIRA') ifTrue:[		menuSpecs _ #(			"name			selector"			(File			fileMenu:)			(Edit			editMenu:)			(Run			runMenu:)"			(Setting			settingMenu:)"			(Help			helpMenu:)		)]	ifFalse: [		menuSpecs _ #(			"name			selector"			(File			fileMenu:)			(Edit			editMenu:)			(Run			runMenu:)			(Help			helpMenu:)		)].	ScratchMenuTitleMorph setMenuEnable: true.	menuSpecs do: [:spec |		m _ ScratchMenuTitleMorph new			contents: (spec at: 1) localized;			target: self selector: (spec at: 2).		menuPanel addMorphBack: m.		#helpMenu: = (spec at: 2) ifFalse: [			menuPanel addMorphBack: (Morph new color: Color transparent; extent: 12@5)]].	topPane addMorph: menuPanel.! !!ScratchFrameMorph methodsFor: 'intialization' stamp: 'sk 6/15/2016 10:39'!createToolbar	"Create and add the toolbar."	| buttonSpecs bName button |	toolbarPanel _ AlignmentMorph new		hResizing: #shrinkWrap;		vResizing: #shrinkWrap;		color: Color transparent.			buttonSpecs _ #(		"name			selector"			"tooltip""		(copy			copyTool		'Duplicate')		(delete			cutTool			'Delete')		(zoomIn 		zoomInTool		'Grow sprite')		(zoomOut 		zoomOutTool		'Shrink sprite')"	).	buttonSpecs do: [:spec |		bName _ spec at: 1.		button _ ToggleButton			onForm: (ScratchFrameMorph skinAt: (bName, 'ButtonPressed') asSymbol)			offForm: (ScratchFrameMorph skinAt: (bName, 'Button') asSymbol)			overForm: (ScratchFrameMorph skinAt: (bName, 'ButtonOver') asSymbol).		button			target: self;			actionSelector: (spec at: 2);			isMomentary: true;			setProperty: #balloonText toValue: (spec at: 3) localized.		toolbarPanel addMorphBack: button].	self addMorph: toolbarPanel.! !!ScratchFrameMorph methodsFor: 'intialization' stamp: 'KK 9/19/2013 10:23'!createViewModeButtonsPanel	| specs bName button |	viewModeButtonsPanel _ AlignmentMorph newRow		hResizing: #shrinkWrap;		vResizing: #shrinkWrap;		color: Color transparent.	viewModeButtons _ OrderedCollection new.	specs _ OrderedCollection new."	specs add: #(quarter			enterQuarterMode		'Switch to small stage').""	specs add: #(normal			enterNormalMode		'Switch to full stage').""	specs add: #(presentation	enterPresentationMode	'Switch to presentation mode')."	specs do: [:spec |		bName _ spec first.		button _ ToggleButton new			onForm: (ScratchFrameMorph skinAt: bName, 'ViewModeOn')			offForm: (ScratchFrameMorph skinAt: bName, 'ViewMode')			overForm: (ScratchFrameMorph skinAt: bName, 'ViewModeOver').		button			target: self;			actionSelector: (spec at: 2);			alphaOn: true;			setProperty: #balloonText toValue: (spec at: 3) localized.		viewModeButtonsPanel			addMorphBack: button;			addMorphBack: (Morph new extent: 1@5; color: Color transparent).		viewModeButtons add: button].	self addMorph: viewModeButtonsPanel.! !!ScratchFrameMorph methodsFor: 'intialization' stamp: 'KK 9/25/2017 14:19'!initialize	super initialize.	fillScreenFlag _ false.	paintingInProgress _ false.	projectInfo _ Dictionary new.	watcherPositions _ Dictionary new.	justSaved _ false.	author _ ''.	loginName _ ''.	loginPassword _ ''.	viewMode _ #normal.	self createBasicPanes.	self createLogo.	self createMenuPanel.	self createFontSizeButton.	self createViewModeButtonsPanel.	self createStageButtonsPanel.	self createToolbar.	self extent: 1000@600.	libraryPane isHidden: true.	readoutPane isHidden: true.	paBoard _ PinAssignMorph new.! !!ScratchFrameMorph methodsFor: 'accessing' stamp: 'KK 12/11/2014 11:41'!importScripts: fileNameOrData	"Read the sprite or project file and merge into the current project."	| data f importedStage defaultForm defaultSound oldName oldPosition sub register |	data _ fileNameOrData.	(data isKindOf: String) ifTrue: [  "read the contents of a local file"		(FileDirectory default fileExists: fileNameOrData) ifFalse: [^ self].		f _ (FileStream readOnlyFileNamed: fileNameOrData) binary.		f ifNil: [^ self].		data _ f contentsOfEntireFile].	[importedStage _ self extractScriptFrom: data] ifError: [^ self].	"fix references to old stage"	importedStage allMorphsDo: [:m |		(m isKindOf: WatcherMorph) ifTrue: [m mapReceiver: importedStage to: workPane].		(m isKindOf: ScriptableScratchMorph) ifTrue: [			m blocksBin submorphs do: [:stack |				(stack isKindOf: BlockMorph) ifTrue: [					stack blockSequence do: [:b | 						" In the case of control start block "						(b isMemberOf: EventHatMorph) ifTrue: [							(b eventName = 'Scratch-StartClicked') ifTrue: [								" Change to the function call block "								sub _ b submorphs.								b initialize.								b eventName:'localScriptStart'.								(sub first isMemberOf: StringMorph) ifFalse: [									b addMorph: sub first.								].							].						].						b mapReceiver: importedStage to: workPane]]]]].	"add global variables from importated stage to my stage"	importedStage varNames do: [:v |		workPane addVariable: v value: (importedStage getVar: v)].	"add imported stage scripts"	importedStage blocksBin submorphs do: [:stack |		" I do not register if the imported script's Control-Start Hat does not have any blocks. "		register _ true.		(stack isMemberOf: EventHatMorph) ifTrue: [			(stack eventName = 'localScriptStart') ifTrue: [				sub _ stack submorphs.				(sub first isMemberOf: EventTitleMorph) ifTrue: [					register _ false.				].			].		].		register ifTrue: [			(stack isKindOf: BlockMorph) ifTrue: [				workPane addStack: stack fullCopy.			].		].	].	"add imported background costumes and scripts to my stage, filtering out default items"	defaultForm _ workPane defaultImageMedia form hibernate.	defaultSound _ SoundMedia new sound.	importedStage media do: [:media |		(media isImage and: [media form hibernate bits ~= defaultForm bits])			ifTrue: [workPane addMediaItem: media].		(media isSound and: [media sound samples ~= defaultSound samples])			ifTrue: [workPane addMediaItem: media]].	importedStage submorphs do: [:m |		(m isKindOf: ScratchSpriteMorph) ifTrue: [			oldName _ m objName.			oldPosition _ m position - m owner position + (47@55).  "jm: I am not sure why this offset is needed. It's the rotation center of the default costume..."			self addAndView: m.  "assigns a new name"			m objName: oldName.			m position: workPane topLeft + oldPosition]].	workPane layoutChanged.! !!ScratchFrameMorph methodsFor: 'accessing' stamp: 'KK 9/27/2017 13:14'!pinAssignBoard	"Answer pin assign board."	^ paBoard! !!ScratchFrameMorph methodsFor: 'menu/button actions' stamp: 'KK 8/20/2014 13:14'!aboutScratch	| dialogBox |	dialogBox _ DialogBoxMorph new		title: 'About Block Programming Environment';		withButtonsForYes: false no: false okay: true cancel: false.	dialogBox		message: 'Based on Scratch from the MIT Media Lab, v', Version, 'Copyright  2014 Artec co., Ltd.All rights reserved.Developed by Artec co., Ltd. with the help of open source software.http://www.artec-kk.co.jp/en/'		font: (ScratchFrameMorph getFont: #AboutScratch).	dialogBox getUserResponse.! !!ScratchFrameMorph methodsFor: 'menu/button actions' stamp: 'sk 8/26/2016 18:10'!calibrateMotor[	ScratchMenuTitleMorph setMenuEnable: false.	(BoardType = 0) ifTrue: [		self shiftToCalibrationMode].	(BoardType = 1) ifTrue: [		self shiftToCalibrationModeMini].	(BoardType = 2) ifTrue: [		self shiftToCalibrationModeMini].	ScratchMenuTitleMorph setMenuEnable: true.] fork.! !!ScratchFrameMorph methodsFor: 'menu/button actions' stamp: 'sk 8/9/2016 16:33'!calibrateSvMotor| notification |[	 | s line |	ScratchMenuTitleMorph setMenuEnable: false.	" Communicate with Board Manager "	s _ self createBMHandle.	s ifNil: [^ self].	" Success in connection "	" -------------------------------------------------------------------- "	" Send message "	" -------------------------------------------------------------------- "	Transcript show: '---------- Sending BM ----------'; cr.	s sendCommand: 'CALIB'.	" -------------------------------------------------------------------- "	" Display Status DialogBox "	" -------------------------------------------------------------------- "	" Shifting ot calibration mode "	notification _ NotificationMessage show: 16r12.	" Wait for program creation and updating to end  "	Transcript show: '---------- Recving BM ----------'; cr.	line _ self waitForBMResponse: s.	(line = '-1') ifTrue: [		notification ifNotNil: [notification no].		^ self].	Transcript show: '---------- Recv message: '; show:line; show:' ----------'; cr.	notification no.	line = 'CALIBRATE' ifFalse: [		" ---------------------------------------------------------------- "		" receive ERR "		" ---------------------------------------------------------------- "		" Get error number "		line _ self waitForBMResponse: s.		(line = '-1') ifTrue: [^ self].		Transcript show: '---------- Recv message: '; show:line; show:' ----------'; cr.		"Wait for finish "		line _ self waitForBMResponse: s.		(line = '-1') ifTrue: [^ self].		Transcript show: '---------- Recv message: '; show:line; show:' ----------'; cr.		" Send message "		Transcript show: '---------- Sending ----------'; cr.		s sendCommand: 'BREAK'.		ErrorMessage show: 1.		s disconnect.		s destroy.	]	ifTrue: [		" ---------------------------------------------------------------- "		" receive CALIBRATE "		" ---------------------------------------------------------------- "		BoardStatus _ 3.		"Wait for finish calibration"		line _ self waitForBMResponse: s For: 36000.		(line = '-1') ifTrue: [^ self].		Transcript show: '---------- Recv message: '; show:line; show:' ----------'; cr.		(line = 'ERR') ifTrue: [			" Disconnect !! "			ErrorMessage show: 1].		" Send message "		Transcript show: '---------- Sending ----------'; cr.		s sendCommand: 'BREAK'.		s disconnect.		s destroy.	].	ScratchMenuTitleMorph setMenuEnable: true.] fork.! !!ScratchFrameMorph methodsFor: 'menu/button actions' stamp: 'KK 10/18/2013 15:23'!displayErrorMessage: erroNo"I display error message by erroNo"| dialogBox |(erroNo = 0) ifTrue: [	"DialogBoxMorph inform: 'Could not access to loaclhost' title: ' Board Manager '"	dialogBox _ DialogBoxMorph new.	dialogBox withButtonsForYes: false no: false okay: true cancel: false.	dialogBox title: 'Could not access localhost'.	dialogBox message: 'Please save your project and restart this software.'.	dialogBox openInWorld.		" Display Dialogbox "	dialogBox centerOnScreen.	" Set center position "	dialogBox world doOneCycle.].(erroNo = 1) ifTrue: [	"DialogBoxMorph inform: 'Could not connect' title: ' Board Manager '"	dialogBox _ DialogBoxMorph new.	dialogBox withButtonsForYes: false no: false okay: true cancel: false.	dialogBox title: 'Could not connect to Studuino'.	dialogBox message: 'Please save your project and restart this software.'.	dialogBox openInWorld.		" Display Dialogbox "	dialogBox centerOnScreen.	" Set center position "	dialogBox world doOneCycle.].! !!ScratchFrameMorph methodsFor: 'menu/button actions' stamp: 'KK 9/25/2017 14:19'!editMenu: t1 	| t2 |	t2 _ CustomMenu new.	t2 add: 'Undelete' action: #undoTool.	t2 addLine.	ScratchProcess blockHighlightMSecs <= 1		ifTrue: [t2 add: 'Start Single Stepping' action: #toggleSingleStepping]		ifFalse: [t2 add: 'Stop Single Stepping' action: #toggleSingleStepping].	t2 add: 'Set Single Stepping' action: #setSingleStepping.	t2 addLine.	t2 add: 'Port Settings' action: #setPinAssign.	"t2 add: 'Board selection' action: #selectBoardType." "Uncomment if Board selection is needed.""	t2 add: 'Export Arduino Language' action: #translateArduLang."	t2 localize.	#(3 4) do: [:t3 | t2 labels at: t3 put: ((t2 labels at: t3)			copyFrom: 1 to: (t2 labels at: t3) size - 1)			, ScratchTranslator ellipsesSuffix].	t2 invokeOn: self at: t1 bottomLeft + (0 @ 10).! !!ScratchFrameMorph methodsFor: 'menu/button actions' stamp: 'KK 8/21/2013 10:31'!enableRemoteSensors	| t1 |	workPane scratchServer		ifNil: 			[t1 _ ScratchServer new userName: 'Scratch'.			t1 stage: workPane.			workPane scratchServer: t1].	workPane scratchServer startHosting.	DialogBoxMorph inform: 'Remote sensor connections enabled' localized! !!ScratchFrameMorph methodsFor: 'menu/button actions' stamp: 'KK 9/11/2017 14:19'!fileMenu: aMenuTitleMorph	| menu |	menu _ CustomMenu new.	menu add: 'New' action: #newScratchProject.	menu add: 'Open' action: #openScratchProject.	menu add: 'Save' action: #saveScratchProjectNoDialog.	menu add: 'Save As' action: #saveScratchProject.	Sensor shiftPressed ifTrue: [  "developer menu"		menu addLine.		fillScreenFlag			ifTrue: [				menu add: 'Exit User Mode' action: #fillScreenOff]			ifFalse: [				menu add: 'Enter User Mode' action: #fillScreenOn.				menu add: 'Save Image in User Mode' action: #saveImageForEndUser]].	menu addLine.	menu add: 'Quit' action: #quitScratch.	menu localize.		#(2 4) do: [:n |		menu labels at: n put:			((menu labels at: n) copyFrom: 1 to: (menu labels at: n) size - 1), ScratchTranslator ellipsesSuffix].	menu invokeOn: self at: aMenuTitleMorph bottomLeft + (0@10).! !!ScratchFrameMorph methodsFor: 'menu/button actions' stamp: 'KK 9/11/2017 14:23'!helpMenu: aMenuTitleMorph	| menu lang |	menu _ CustomMenu new.	menu add: 'About Studuino Block Programming Environment' action: #aboutScratch.	lang _ ScratchTranslator currentLanguage.	menu localize.	#(1) do: [:n |		menu labels at: n put:			((menu labels at: n) copyFrom: 1 to: (menu labels at: n) size - 1), ScratchTranslator ellipsesSuffix].	menu invokeOn: self at: aMenuTitleMorph bottomLeft + (0@10).! !!ScratchFrameMorph methodsFor: 'menu/button actions' stamp: 'sk 9/28/2016 17:19'!languageMenu: aToggleButtonMorph	"Present a menu of possible languages for blocks."	| bullet menu choice l msg code |	ScratchTranslator canRenderUnicode ifFalse: [		"try to find a Unicode plugin in case this is the first use after startup"		ScratchTranslator detectRenderPlugin].	bullet _ UTF8 withAll: ' '.	menu _ CustomMenu new.	ScratchTranslator languageNames do: [:lang |		code _ ScratchTranslator isoCodeForName: lang.		(BoardType = 1) | (BoardType = 2) ifTrue: [			(code = 'en') | (code = 'ja') | (code = 'ja_HIRA') ifTrue: [				(code = (ScratchTranslator currentLanguage))					ifTrue: [menu add: (bullet, lang) action: lang]					ifFalse: [menu add: lang action: lang]]]		ifFalse: [			(code = (ScratchTranslator currentLanguage))				ifTrue: [menu add: (bullet, lang) action: lang]				ifFalse: [menu add: lang action: lang]]].	choice _ menu startUp: nil withCaption: nil at: aToggleButtonMorph bottomLeft + (0@10).	choice ifNil: [^ self].	self stopAll.	self setLanguage: choice.	self recordLanguage: (ScratchTranslator currentLanguage).	l _ ScratchTranslator currentLanguage.	(LangDic includesKey: l)		ifTrue: [msg _ LangDic at: l.]		ifFalse: [msg _ 'LANGE'.].	self sendMessageToBM: msg.! !!ScratchFrameMorph methodsFor: 'menu/button actions' stamp: 'KK 8/19/2013 17:56'!launchHelpFile: aFilename	| helpDir subDir |	(FileDirectory default directoryNames includes: 'Help') ifFalse: [^ self beep].  "no help folder"	self stopAll.	helpDir _ FileDirectory default directoryNamed: 'Help'.	"use the English subfolder by default if it exists"	(helpDir directoryNames includes: 'en') ifTrue: [subDir _ helpDir directoryNamed: 'en'].	"use subfolder for the current language if it exists"	(helpDir directoryNames includes: ScratchTranslator currentLanguage) ifTrue: [		subDir _ helpDir directoryNamed: ScratchTranslator currentLanguage].	subDir ifNotNil: [helpDir _ subDir].	(helpDir fileExists: aFilename)		ifTrue: [Smalltalk isMacOSX			ifTrue: [ScratchPlugin primOpenURL: 'file://', (helpDir pathName, FileDirectory slash, aFilename) encodeForHTTP]			ifFalse: [ScratchPlugin primOpenURL: helpDir pathName, FileDirectory slash, aFilename]]		ifFalse: [			DialogBoxMorph inform: 'Scratch help file not found.' localized].! !!ScratchFrameMorph methodsFor: 'menu/button actions' stamp: 'sk 3/10/2016 22:19'!newScratchProject	"Make a new, blank Scratch project."	| response newProject |	self closeMediaEditorsAndDialogs ifFalse: [^ self].	self stopAll.	(DuringTest = true)	" During a test ? "	ifTrue: [ self testModeOff. ].	" yes -> off "	(justSaved or: [self projectIsEmpty]) ifFalse: [		"ask the user if they want to save the current project"		response _ DialogBoxMorph askWithCancel: 'Save the current project?'.		response = #cancelled ifTrue: [^ self].		response ifTrue: [self saveScratchProjectNoDialog.			justSaved ifFalse: [^ self]]].	projectDirectory _ ScratchFileChooserDialog getDefaultFolderForType: #project.	projectName _ ''.	projectInfo _ Dictionary new.	"self initIOPort." "Initializing Board.cfg & IOPort."	self initStuduinoGlobalVars.	"Initializing Board.cfg & IOPort."	newProject _ ScratchStageMorph new."	sprite _ ScratchFrameMorph defaultSprite fullCopy.	sprite position: (241@181) - sprite extent.	newProject addMorph: sprite."	self installNewProject: newProject.	self initializeWatcherPositions.	justSaved _ true.		self viewerPane refresh.	"self enterNormalMode."	scriptsPane cleanUp.! !!ScratchFrameMorph methodsFor: 'menu/button actions' stamp: 'sk 5/18/2017 18:27'!openFAQ	" Open the Studuino FAQ page on default web browser.	Japanese is only available at presetnt. "	ScratchPlugin primOpenURL: 'http://www.artec-kk.co.jp/studuino/ja/faq.php'! !!ScratchFrameMorph methodsFor: 'menu/button actions' stamp: 'sk 5/15/2017 17:15'!openStuduinoSettingMenu	| resp |	resp _ SettingMenu showWith: (CalibInfoLocation + 1).	resp ifNotNil: [		CalibInfoLocation _ resp - 1.		self recordCalibInfoLocation: (CalibInfoLocation asString)].! !!ScratchFrameMorph methodsFor: 'menu/button actions' stamp: 'sk 8/23/2016 18:23'!quitScratch	"Quit from Scratch. Ask the user if they want to save, first."	| response |	self closeMediaEditorsAndDialogs ifFalse: [^ self].	self stopAll.	(DuringTest = true)	" During a test ? "	ifTrue: [ self testModeOff. ].	" yes -> off "	(justSaved or: [self projectIsEmpty]) ifFalse: [		response _ ScratchCloseDialog new getUserResponse.		response = #cancelled ifTrue: [^ self].		response ifTrue: [			self saveScratchProjectNoDialog.			justSaved ifFalse: [^ self]]].	(self sendFinishToBM) ifFalse: [		Smalltalk snapshot: false andQuit: true].! !!ScratchFrameMorph methodsFor: 'menu/button actions' stamp: 'sk 4/27/2016 21:30'!runMenu: t1 	| t2 |	t2 _ CustomMenu new.	t2 add: 'Transfer' action: #runOnBoard.	(BoardType = 0) & (BoardStatus = 2)	ifTrue: [t2 add: 'Run ' action: #startProgram.]	ifFalse: [].	t2 addLine.	(DuringTest = true)	" During a test ? "	ifTrue: [ t2 add: 'Test OFF' action: #testModeOff. ]	" yes -> off "	ifFalse: [ t2 add: 'Test ON' action: #testMode. ].		" no -> start "	t2 localize."	#(3 ) do: [:t3 | t2 labels at: t3 put: ((t2 labels at: t3)				copyFrom: 1 to: (t2 labels at: t3) size - 1)				, ScratchTranslator ellipsesSuffix]."	t2 invokeOn: self at: t1 bottomLeft + (0 @ 10)! !!ScratchFrameMorph methodsFor: 'menu/button actions' stamp: 'sk 8/9/2016 16:41'!runOnBoard	"I create a source file written in Arduino language. 	 I make it and run on board in communication with board manager"	| s line dialogBox comPort msgID doBuild comNumber res |	" If test mode on, test mode off "	(DuringTest = true) ifTrue: [	" During a test? "		self testModeOff.	].	" Create a UserProgram.cpp "	doBuild _ self writeArduLangFile: 'user\artecRobot.cpp'.	(doBuild = false) ifTrue: [		" STOP Serial Communication "		^ self.	].	s _ self createBMHandle.	s ifNil: [^ self].	" Success in connection "	" Send message "	Transcript show: '---------- Sending ----------'; cr.	s sendCommand: 'RUN'.	" Display Status DialogBox "	dialogBox _ NotificationMessage show: 16r10.	"Building and updating"	" Waiting for BM's completing to build a program."	" Only if a board is Studuino mini. "	(BoardType = 1 or: [BoardType = 2]) ifTrue: [		Transcript show: '---------- Recving1 ----------'; cr.		line _ self waitForBMResponse: s.		(line = '-1') ifTrue: [			dialogBox ifNotNil: [dialogBox no].			^ self].		res _ line.		line _ self waitForBMResponse: s.		(line = '-1') ifTrue: [			dialogBox ifNotNil: [dialogBox no].			^ self].		msgID _ line. " Number "Transcript show: res; show: ' '; show: msgID; cr.		dialogBox no.		(res = 'OK') ifTrue: [			" Asking user to push a reset button. "			dialogBox _ NotificationMessage show: 16r20.	"Waiting for RESET"]		ifFalse: [	" Build error "			ErrorMessage show: msgID asNumber.			^ self.].	].	" Wait for program creation and updating to end  "	Transcript show: '---------- Recving2 ----------'; cr.	line _ self waitForBMResponse: s.	(line = '-1') ifTrue: [		dialogBox ifNotNil: [dialogBox no].		^ self].	comPort _ line.	COMPort _ comPort.	" set class value "	line _ self waitForBMResponse: s.	(line = '-1') ifTrue: [		dialogBox ifNotNil: [dialogBox no].		^ self].	msgID _ line sansPeriodSuffix.Transcript show:comPort; show:', '; show:msgID;cr.	" Display message "	" Hide Status DialogBox "	dialogBox no.	Transcript show:line;cr.	" Display message "	" Send message "	Transcript show: '---------- Sending ----------'; cr.	s sendCommand: 'BREAK'.	s disconnect.	s destroy.	BoardStatus _ 0.	(comPort ~= 'ERR') ifTrue: [		BoardStatus _ 2.	] ifFalse: [		(msgID = '2') ifTrue: [			" Close port if port was opened  by myself "			comNumber _ 1.			32 timesRepeat: [				ScratchPlugin closePort:comNumber.				comNumber _ comNumber + 1.			].		].		ErrorMessage show: msgID asNumber.	].! !!ScratchFrameMorph methodsFor: 'menu/button actions' stamp: 'KK 8/20/2013 10:55'!sendProgram	| |	"Create Arduino program and send it."	"Create Arduino program..."	self translateArduLang.! !!ScratchFrameMorph methodsFor: 'menu/button actions' stamp: 'sk 8/1/2016 10:28'!setBoardIO| result |[	 | s line filename f b i |	ScratchMenuTitleMorph setMenuEnable: false.	" Communicate with Board Manager "	s _ self createBMHandle.	s ifNil: [^ self].	" Success in connection "	" Send message "	Transcript show: '---------- Sending ----------'; cr.	s sendCommand: 'CONFIG'.	" Wait for program creation and updating to end  "	Transcript show: '---------- Recving ----------'; cr.	line _ self waitForBMResponse: s For: 36000.	(line = '-1') ifTrue: [^ self].	result _ line sansPeriodSuffix.	line _ self waitForBMResponse: s.	(line = '-1') ifTrue: [^ self].	Transcript show:line;cr.	" Display message "	" Send message "	Transcript show: '---------- Sending ----------'; cr.	s sendCommand: 'BREAK'.	"Delay forSeconds: 1."	"1000 timesRepeat: []."	s disconnect.	s destroy.	" If I/O Configuration is updated, update IOPort and TestMode OFF. "	result = 'UPDATE' ifTrue: [		" Get Configuration Info "		filename := 'Board.cfg'.		f _ FileStream fileNamed: filename.		f binary.		i _ 1.		[f atEnd] whileFalse: [			b _ f next.	" PartsID "			" I/O Port Configuration "			IOPort at:(i) put:b.			i _ i + 1.		].		(DuringTest = true)	" During a test ? "		ifTrue: [ self testModeOff. ].	" yes -> off "Transcript show:IOPort;cr.		self viewerPane refresh.		f close.		self setLanguage: (ScratchTranslator currentLanguage).	].	ScratchMenuTitleMorph setMenuEnable: true.] fork.! !!ScratchFrameMorph methodsFor: 'menu/button actions' stamp: 'KK 9/27/2017 17:30'!setPinAssign	| pab index |	" Set pin assing. "Transcript show:'[ScartchFrameMorph::setPinAssign] '; show:IOPort;cr.	pab _ paBoard.	pab setFrameMorph: self.	pab setAllOff.	" set all checkbox off "	" Set check box "	index _ 1.	IOPort do: [ :parts |		pab setCheckBoxOn: index partsID: parts.		index _ index + 1.	].	" Set combo box "	index _ 1.	IOPort do: [ :parts |		pab setComboBox: index partsID: parts.		index _ index + 1.	].	" Invalidate menu "	ScratchMenuTitleMorph setMenuEnable: false.	self showPinAssignBoard.! !!ScratchFrameMorph methodsFor: 'menu/button actions' stamp: 'sk 9/28/2016 17:05'!settingMenu: aMenuTitleMorph	| menu |	menu _ CustomMenu new.	menu add: 'Board selection' action: #selectBoardType.	menu localize.	menu invokeOn: self at: aMenuTitleMorph bottomLeft + (0@10).! !!ScratchFrameMorph methodsFor: 'menu/button actions' stamp: 'sk 4/19/2017 14:25'!shiftToCalibrationMode	"Move onto calibration mode for Studuino."	| s notification line |	" Communicate with Board Manager "	s _ self createBMHandle.	s ifNil: [^ self].	" Success in connection "	" -------------------------------------------------------------------- "	" Send message "	" -------------------------------------------------------------------- "	Transcript show: '---------- Sending BM ----------'; cr.	s sendCommand: 'CALIB'.	" -------------------------------------------------------------------- "	" Display Status DialogBox "	" -------------------------------------------------------------------- "	" Shifting ot calibration mode "	notification _ NotificationMessage show: 16r12.	" Wait for program creation and updating to end  "	Transcript show: '---------- Recving BM ----------'; cr.	line _ self waitForBMResponse: s.	(line = '-1') ifTrue: [		notification ifNotNil: [notification no].		^ self].	Transcript show: '---------- Recv message: '; show:line; show:' ----------'; cr.	notification no.	line = 'CALIBRATE' ifFalse: [		" ---------------------------------------------------------------- "		" receive ERR "		" ---------------------------------------------------------------- "		" Get error number "		line _ self waitForBMResponse: s.		(line = '-1') ifTrue: [^ self].		Transcript show: '---------- Recv message: '; show:line; show:' ----------'; cr.		"Wait for finish "		line _ self waitForBMResponse: s.		(line = '-1') ifTrue: [^ self].		Transcript show: '---------- Recv message: '; show:line; show:' ----------'; cr.		" Send message "		Transcript show: '---------- Sending ----------'; cr.		s sendCommand: 'BREAK'.		ErrorMessage show: 1.		s disconnect.		s destroy.	]	ifTrue: [		" ---------------------------------------------------------------- "		" receive CALIBRATE "		" ---------------------------------------------------------------- "		BoardStatus _ 3.		"Wait for finish calibration"		line _ self waitForBMResponse: s For: 36000.		(line = '-1') ifTrue: [^ self].		Transcript show: '---------- Recv message: '; show:line; show:' ----------'; cr.		(line = 'ERR') ifTrue: [			" Disconnect !! "			ErrorMessage show: 1].		self readCalibInfo.		" Send message "		Transcript show: '---------- Sending ----------'; cr.		s sendCommand: 'BREAK'.		s disconnect.		s destroy.	].! !!ScratchFrameMorph methodsFor: 'menu/button actions' stamp: 'sk 8/26/2016 18:11'!shiftToCalibrationModeMini	"Move onto calibration mode for Studuino mini."	| s notification res |	" Communicate with Board Manager "	s _ self createBMHandle.	s ifNil: [^ self].	" Asking user to push a reset button. "	notification _ NotificationMessage show: 16r20.	"Waiting for RESET"	" Success in connection "	" -------------------------------------------------------------------- "	" Send message "	" -------------------------------------------------------------------- "	s sendCommand: 'CALIB'.	" Waiting for BM to transfer a testmode program. "	Transcript show: '---------- Recving ----------'; cr.	res _ self waitForBMResponse: s.	(res = '-1') ifTrue: [		notification ifNotNil: [notification no].		^ self].	notification no.	(BoardType = 2) ifTrue: [		(res = 'OK') ifFalse: [			" Getting error number "			res _ self waitForBMResponse: s.			(res = '-1') ifTrue: [				notification ifNotNil: [notification no].				^ self].			" Notify timeout error. "			ErrorMessage show: res asNumber.			^ self].		" Asking user to push a reset button. - 2 - "		notification _ NotificationMessage show: 16r21.	"Waiting for RESET"		" Waiting for BM to transfer a testmode program. "		Transcript show: '---------- Recving1 ----------'; cr.		res _ self waitForBMResponse: s.		(res = '-1') ifTrue: [			notification ifNotNil: [notification no].			^ self].		notification no].	(res = 'OK') ifTrue: [		"Waiting INITOK"		res _ self waitForBMResponse: s.		(res = '-1') ifTrue: [			notification ifNotNil: [notification no].			^ self].		(res = 'INITOK') ifTrue: [			" Do nothing "]		ifFalse: [			notification no.			ErrorMessage show: 100.			^ self]]	ifFalse: [		" Notify error. "		Transcript show: '---------- Error ----------'; cr.		"Getting an error number."		notification no.		res _ self waitForBMResponse: s.		(res = '-1') ifTrue: [			notification ifNotNil: [notification no].			^ self].		ErrorMessage show: res asNumber.		^ self].		" ---------------------------------------------------------------- "		" Waiting for the calibration done.                          "		" ---------------------------------------------------------------- "		notification no.		BoardStatus _ 3.		"Wait for finish calibration"		res _ self waitForBMResponse: s For: 36000.		(res = '-1') ifTrue: [			notification ifNotNil: [notification no].			^ self].		Transcript show: '---------- Recv message: '; show:res; show:' ----------'; cr.		(res = 'ERR') ifTrue: [			" Disconnect !! "			ErrorMessage show: 1].		" Send message "		Transcript show: '---------- Sending ----------'; cr.		s sendCommand: 'BREAK'.		s disconnect.		s destroy.! !!ScratchFrameMorph methodsFor: 'menu/button actions' stamp: 'KK 9/5/2017 14:59'!shoutGo	"Broadcasts the start event to all objects and processes."	self stopAll.	workPane broadcastEventNamed: 'Scratch-StartClicked' with: 0.	flagButton on.	World displayWorldSafely.  "force button flash"	Delay waitMSecs: 20.! !!ScratchFrameMorph methodsFor: 'menu/button actions' stamp: 'KK 3/3/2015 11:58'!showOptionBlocks	workPane showOptionBlocks: true.	viewerPane currentCategory: 'sensing'.	viewerPane pageViewer vScrollRelative: 1.0.! !!ScratchFrameMorph methodsFor: 'menu/button actions' stamp: 'KK 9/27/2017 19:07'!showPinAssignBoard	| pab |	pab _ paBoard.	pab position: ((scriptsPane bounds origin) + (20@ 20)).	self world addMorph: pab.! !!ScratchFrameMorph methodsFor: 'menu/button actions' stamp: 'sk 3/16/2017 18:57'!showSensorBoard	| sb |	sb _ workPane sensorBoard.	sb position: stageFrame position - ((sb width)@0) + (-20@20).	sb openInWorld.	"self workPane addMorph: sb."	" Only if a board is Studuino. "	(BoardType = 0) ifTrue: [		sb tryToOpenPort.].	World startSteppingSubmorphsOf: sb.! !!ScratchFrameMorph methodsFor: 'menu/button actions' stamp: 'KK 9/14/2013 14:13'!startProgram	| sb |	"I restart program on board"	sb _ workPane sensorBoard.	sb openPort: COMPort.	sb closePort.! !!ScratchFrameMorph methodsFor: 'menu/button actions' stamp: 'KK 2/10/2014 10:28'!stopAll	"Tell my workPane to stop everything."	| oldJustSaved |	oldJustSaved _ justSaved.	workPane stopAll.	justSaved _ oldJustSaved.! !!ScratchFrameMorph methodsFor: 'menu/button actions' stamp: 'sk 6/10/2016 17:52'!testMode	| |	workPane stopAll.	(BoardType = 0) ifTrue: [		self shiftToTestMode.].	(BoardType = 1) ifTrue: [		self shiftToTestModeMini.].	(BoardType = 2) ifTrue: [		self shiftToTestModeMini2.].! !!ScratchFrameMorph methodsFor: 'menu/button actions' stamp: 'sk 3/24/2016 21:54'!testModeOff	| sb bmSocket |	workPane stopAll.	sb _ workPane sensorBoard.	(BoardType = 0) ifTrue: [ " Studuino "		" Close port "			sb closePort.]	ifFalse: [ " Studuino mini "		" Close socket "		bmSocket _ self createBMHandle.		bmSocket ifNotNil: [			bmSocket sendCommand: 'TEST2E'.			bmSocket getResponseShowing: true. "Waiting ACK"				bmSocket disconnect.			bmSocket destroy].		sb closeSocket.].	" Hide SensorBoard "	sb delete.	DuringTest _ false.! !!ScratchFrameMorph methodsFor: 'menu/button actions' stamp: 'KK 8/2/2013 11:41'!translateArduLang	"Translate block into Arduino language and write to a file."	self writeArduLangFile: ''.! !!ScratchFrameMorph methodsFor: 'menu/button actions' stamp: 'KK 8/19/2014 14:21'!uniqueSummaryFileName	| baseName fileName n |	baseName _ self projectName.	baseName size <= 1 ifTrue: [baseName _ 'newProject'].	fileName _ baseName, '.ino'.	n _ 1.	[FileDirectory default fileExists: fileName] whileTrue: [		fileName _ baseName, n printString, '.ino'.		n _ n + 1].	^ fileName! !!ScratchFrameMorph methodsFor: 'menu/button actions' stamp: 'sk 2/22/2017 11:51'!writeArduLangFile: fullFileName	"Translate block into Arduino language and write to a file."	| s sprites f fName ltmp dir headCode footCode dialogBox response  blocks |	"Convert to block sign"	ltmp _ ScratchTranslator currentLanguage.	"---------------------------------------------------------"	" Check hatless blocks "	"---------------------------------------------------------"	blocks _ workPane getHatlessBlocks.	(blocks size = 0) ifFalse: [	" exist hatless blocks "		" Display a hatless block in red "		blocks do: [:item |			item color: Color red.		].		" Warn the hatless block exists "		dialogBox  _ DialogBoxMorph new.		dialogBox withButtonsForYes: true no: true okay: false cancel: false.		dialogBox title: 'Unconnected blocks present'.		dialogBox openInWorld.		" Display Dialogbox "		dialogBox centerOnScreen.	" Set center position "		dialogBox world doOneCycle.		(fullFileName size = 0) ifFalse: [			" Transfer "			dialogBox message: 'These blocks will not be built.Do you wish to continue?'.		] ifTrue: [			" Export Arduino Language "			dialogBox message: 'These blocks will not be exported to Arduino Language.Do you wish to continue?'.		].		" Stop Building "		response _ dialogBox getUserResponse.		(response = false) ifTrue: [			self setLanguage: ltmp. 			 ^ false.		].	].	" Continue Building "	self setLanguage: ltmp. 	" Build... "	self setLanguage: 'atc'. 	s _ WriteStream on: (String new: 10000).	workPane printArduLangOn: s.	self setLanguage: ltmp. 	sprites _ workPane submorphs select: [:m | m isKindOf: ScratchSpriteMorph].	sprites do: [:m |		s skip: -2.  "remove last cr"		s nextPutAll: '--------'; cr.		m printSummaryOn: s]."	s nextPutAll: '--------'; cr."	ParagraphEditor clipboardTextPut: s contents asText.	fName _ fullFileName.	fullFileName size = 0		ifTrue: [			TabletMode ifTrue: [				self sendMessageToBMnoBlocking: 'SHOWKEYPAD'].			fName _ ScratchFileChooserDialog				chooseNewFileDefault: self uniqueSummaryFileName				title: 'File Name?'				type: #projectSummary.			TabletMode ifTrue: [				self sendMessageToBMnoBlocking: 'HIDEKEYPAD'].			fName = #cancelled ifTrue: [				"Turn setting laguage"				self setLanguage: ltmp. 				^ self].			f _ CrLfFileStream newScratchFileNamed: fName.		]		ifFalse: [			(StandardFileStream isAFileNamed: fName) ifTrue: [				" Exist file "				dir _ FileDirectory default directoryNamed: 'user'.	" Get target directory "				dir deleteFileNamed: 'artecRobot.cpp'.					" delete file "			].			f _ StandardFileStream new open: fName forWrite: true.		].	f ifNil: [		"Turn setting laguage"		self setLanguage: ltmp. 		^ self].	" Head and Footer file "	" Default English. "	headCode _ StandardFileStream new open: 'code\head_en.txt' forWrite: false.	footCode _ StandardFileStream new open: 'code\foot_en.txt' forWrite: false.	((ltmp = 'ja') | (ltmp = 'ja_HIRA')) ifTrue: [		Transcript show: '---------- Trans to Japan ----------'; cr.		(BoardType = 0 or: [BoardType = 2]) ifTrue: [			headCode _ StandardFileStream new open: 'code\head.txt' forWrite: false.]		ifFalse: [			headCode _ StandardFileStream new open: 'code\head_mini.txt' forWrite: false.].		footCode _ StandardFileStream new open: 'code\foot.txt' forWrite: false.	]	ifFalse: [		(ltmp = 'zh_CN') ifTrue: [			Transcript show: '---------- China ----------'; cr.			headCode _ StandardFileStream new open: 'code\head_zh.txt' forWrite: false.			footCode _ StandardFileStream new open: 'code\foot_zh.txt' forWrite: false.		]		ifFalse: [			(ltmp = 'ko') ifTrue: [				Transcript show: '---------- Korea ----------'; cr.				headCode _ StandardFileStream new open: 'code\head_ko.txt' forWrite: false.				footCode _ StandardFileStream new open: 'code\foot_ko.txt' forWrite: false.			]		].	].	[headCode atEnd] whileFalse: [		f nextPut: headCode next.	].	f nextPutAll: ((s contents) asUTF8).	[footCode atEnd] whileFalse: [		f nextPut: footCode next.	].	headCode close.	footCode close.	f close.	"Turn setting laguage"	self setLanguage: ltmp. ! !!ScratchFrameMorph methodsFor: 'geometry' stamp: 'sk 3/21/2017 13:50'!fixLayout	| stageExtent xyReadout w |	stageExtent _		workPane isQuarterSize			ifTrue: [(180@(self bottom)) - (0@(stageFrame top+42))]			ifFalse: [(180@(self bottom)) - (0@(stageFrame top+42))].	topPane		position: self topLeft;		width: self width;		height: (menuPanel height + 0 max: logoMorph height + 10).	stageFrame		extent: stageExtent + (14@42);		top: topPane bottom;		right: self right.	titlePane		position: stageFrame topLeft + (0@1);		width: stageFrame width - 6;		height: 36.	self fixProjectTitleMorphLayout.	scriptsPane fixLayout.	w _ (viewerPane catButtonsExtent x + 17)		within: 40		and: (self width - (scriptsPane bareMinimumWidth + stageFrame width)).	viewerPane position: topPane bottomLeft;		width: w;		height: self bottom - topPane bottom.	scriptsPane		position: viewerPane topRight;		width: self width - (stageFrame width + viewerPane width);		height: self bottom - topPane bottom;		fixLayout."	libraryPane position: stageFrame bottomLeft;		width: (self right - scriptsPane right);		height: self bottom - libraryPane top."	libraryPane delete.	menuPanel		left: logoMorph right + 18;		top: topPane top + ((topPane height - menuPanel height) // 2) + 2.	fontButtons		position: ((topPane topRight) - ((fontButtons width + 30)@0)).	viewModeButtonsPanel		right: stageFrame right - 8;		top: self top + 7.	stageButtonsPanel		position: (stageFrame left + 10)@(topPane bottom + 5);		width: stageFrame width - 28;		height: (workPane top - stageFrame top) - 8.	xyReadout _ readoutPane submorphs at: 1.	readoutPane		width: xyReadout width + 23;		height: xyReadout height + 15;		position: stageFrame bottomRight - ((readoutPane width + 6)@3).	xyReadout position: readoutPane position + (18@5).	toolbarPanel		left: (stageFrame left - 4 max: menuPanel right);		top: self top + ((topPane height - toolbarPanel height) // 2) + 3.	((toolbarPanel right - 5) > viewModeButtonsPanel left)		ifTrue: [toolbarPanel delete]		ifFalse: [			(toolbarPanel owner = self) ifFalse: [				self addMorphFront: toolbarPanel]].	workPane position: stageFrame topLeft + (4@37).	workPane height: stageExtent y - 20.	workPane width: 180.! !!ScratchFrameMorph methodsFor: 'stepping' stamp: 'KK 10/20/2017 16:54'!processDroppedFiles	"Process any files that have been dropped onto me."	| droppedFiles m dropPoint fName |	droppedFiles _ FileStream droppedFiles.	droppedFiles size = 0 ifTrue: [^ self].	(m _ self viewerPane target) ifNil: [^ self].	dropPoint _ droppedFiles first.	(droppedFiles copyFrom: 2 to: droppedFiles size) do: [:file |		file close.		fName _ file fullName.		((fName asLowercase endsWith: '.bpde'))			ifTrue: [self openScratchDroppedProjectNamed: fName]			ifFalse: [				(fName asLowercase endsWith: '.sprite')					ifTrue: [self importSpriteOrProject: fName]					ifFalse: [m importMedia: fName]]].! !!ScratchFrameMorph methodsFor: 'stepping' stamp: 'sk 3/14/2017 11:58'!step	"Run each process until it gives up control, then filter out any processes that have terminated."	| screenExtent oldJustSaved keyPadTarget |	fillScreenFlag ifTrue: [		screenExtent _ Display extent.		((self position = (0@0)) and: [self extent = screenExtent]) ifFalse: [			oldJustSaved _ justSaved.			self position: 0@0.			self extent: screenExtent.			self enterQuarterModeIfSmallScreen.			scriptsPane currentCategory: scriptsPane currentCategory.			justSaved _ oldJustSaved.			^ self]].	workPane ifNotNil: [		ScriptableScratchMorph scratchOrigin: workPane center.		viewerPane target isNil 			ifTrue: [workPane viewBlocksAndScripts]			ifFalse: [viewerPane target isInWorld ifFalse: [workPane viewBlocksAndScripts]]].	Sensor processOSMenuEvents.	paintingInProgress ifTrue: [^ self].	workPane scratchServer ifNotNil: [workPane scratchServer stepServer].	self checkForWeDo.	self updateToolButtons.	self processWhenConditions.	self processKeyboardEvents.	workPane stepProcesses.	workPane scratchServer ifNotNil: [workPane scratchServer stepServer].	self processDroppedFiles.	workPane processesToRun size > 0		ifTrue: [flagButton on]		ifFalse: [flagButton off].	(workPane sensorBoard disconnected) ifTrue: [Transcript show: 'disconnected'; cr.		self testModeOff.		workPane sensorBoard disconnected: false].	TabletMode ifTrue: [		keyPadTarget _ World activeHand keyboardFocus.		(keyPadTarget isKindOf: StringFieldMorph) ifTrue: [			(keyPadTarget ownerThatIsA: ExpressionArgMorph) ifNotNil: [				keyPad ifNil: [					keyPad _ KeyPadMorph new openInWorld]]]		ifFalse: [			keyPad _ nil]].! !!ScratchFrameMorph methodsFor: 'stepping' stamp: 'sk 7/29/2016 17:30'!waitForBMResponse: s For: seconds	| line |	" I receive message from Board Manager and return message"	line _ WriteStream on: String new.	line _ s getBMResponseFor: seconds.	^ line sansPeriodSuffix.! !!ScratchFrameMorph methodsFor: 'view mode' stamp: 'KK 9/4/2013 09:41'!enterNormalMode	"Go into normal (full-stage) mode."	(viewMode = #normal) ifTrue: [		self updateViewModeButtons.		^ self].	viewMode _ #normal.	workPane isQuarterSize: false.	workPane isInWorld		ifTrue: [self fixLayout]		ifFalse: [self exitPresentationMode].	stageFrame initFromForm: (ScratchFrameMorph skinAt: 'spriteLibraryPaneFrameTransparent2').	self removeAllMorphs.	self		addMorph: (topPane isSticky: true);		addMorph: (viewerPane isSticky: true);		addMorph: (scriptsPane isSticky: true);		addMorph: (stageFrame isSticky: true);		addMorph: (workPane isSticky: true);		addMorph: (titlePane isSticky: true);		addMorph: (libraryPane isSticky: true).	libraryPane delete.	self updatePanes.	self updateViewModeButtons.! !!ScratchFrameMorph methodsFor: 'view mode' stamp: 'KK 9/3/2013 16:42'!enterQuarterMode	"Go into quarter stage mode."	(viewMode = #quarter) ifTrue: [		self updateViewModeButtons.		^ self].	viewMode _ #quarter.	workPane isQuarterSize: true.	workPane isInWorld		ifTrue: [self fixLayout]		ifFalse: [self exitPresentationMode].	stageFrame initFromForm: (ScratchFrameMorph skinAt: 'spriteLibraryPaneFrameTransparent2').	self removeAllMorphs.	self		addMorph: (topPane isSticky: true);		addMorph: (viewerPane isSticky: true);		addMorph: (scriptsPane isSticky: true);		addMorph: (workPane isSticky: true);		addMorph: (stageFrame isSticky: true);		addMorph: (titlePane isSticky: true);		addMorph: (libraryPane isSticky: true).	libraryPane delete.	self updatePanes.	self updateViewModeButtons.! !!ScratchFrameMorph methodsFor: 'other' stamp: 'KK 10/2/2013 15:58'!view: aMorph tab: t category: c	"Add given morph to the work pane and view it."	scriptsPane target: aMorph.	scriptsPane tabPane currentTab: t.	viewerPane		target: aMorph;		currentCategory: c.! !!ScratchFrameMorph methodsFor: 'startup' stamp: 'sk 5/12/2017 19:02'!processSettingsFile	"Process settings from the Scratch.ini file."	| lang settings k ratio |	self class setVisibleDrives: nil.	lang _ nil.	ratio _ 1.	ScratchFileChooserDialog clearFolderCache. "clear homeDir and last folder cache"	settings _ self readSettingsFile.	settings associationsDo: [:assoc |		k _ assoc key.		k = 'calibinfostore' ifTrue: [self setCalibInfoLocation: assoc value asNumber].		k = 'fontmagnification' ifTrue: [ratio _ assoc value asNumber].		"k = 'tabletmode' ifTrue: [self setTabletMode: (assoc value) ~= '0']."		k = 'language' ifTrue: [lang _ assoc value].		k = 'home' ifTrue: [ScratchFileChooserDialog setHomeDir: assoc value].		k = 'visibledrives' ifTrue: [self class setVisibleDrives: assoc value]].	lang ifNil: [lang _ ScratchTranslator guessLanguage].	self setLanguage: lang.	self fontMagnifyBy: ratio.! !!ScratchFrameMorph methodsFor: 'startup' stamp: 'sk 3/9/2017 11:06'!readSettingsFile	"Read my settings file and answer a Dictionary of settings."	"ScratchFrameMorph new readSettingsFile"	| f dict s tokens k |	f _ FileStream readOnlyFileNamedOrNil: 'Block.ini'.	f ifNil: [^ Dictionary new].	dict _ Dictionary new.	f contentsOfEntireFile lines do: [:line |		s _ line collect: [:c | (c asciiValue < 32) ifTrue: [Character space] ifFalse: [c]].		tokens _ s findTokens: '='.		k _ tokens first withBlanksTrimmed asLowercase.		tokens size = 2			ifTrue: [dict at: k put: tokens second withBlanksTrimmed]			ifFalse: [dict at: k put: '1']].	^ dict! !!ScratchFrameMorph methodsFor: 'startup' stamp: 'KK 10/20/2017 16:55'!startup	| startupFileNames fileName arg presentationMode |	HostSystemMenus startUp.	HostSystemMenus menuBarControler reviseHostMenus.	ScriptableScratchMorph randomInit.	ScratchTranslator detectRenderPlugin.	ScratchTranslator importLanguagesList.	self processSettingsFile.	self readDefaultNotes.	self updateProjectName.	shuffledCostumeNames _ nil.	author _ ''.	loginName _ ''.	loginPassword _ ''.	justSaved _ true.	presentationMode _ false.	"Reset BoardStatus"	BoardStatus _ -1.	startupFileNames _ InputSensor startupFileNames asOrderedCollection.	2 to: 10 do: [:i |		arg _ Smalltalk getSystemAttribute: i.		(arg notNil and: [arg size > 0]) ifTrue: [			startupFileNames addLast: (ScratchPlugin primShortToLongPath: arg)]].	startupFileNames do: [:n |		(n asLowercase = 'presentation') ifTrue: [presentationMode _ true].		(n asLowercase = 'fullscreen') ifTrue: [TakeOverScreen _ true]].	TakeOverScreen ifTrue: [		Smalltalk fullScreenMode: true.		World restoreDisplay].	self enterQuarterModeIfSmallScreen.	fileName _ startupFileNames		detect: [:fn |			(fn asLowercase endsWith: '.bpde')]		ifNone: [nil].	fileName ifNotNil: [		presentationMode ifTrue: [Display fillColor: Color black].		self openScratchProjectNamed: fileName.		presentationMode ifTrue: [self enterPresentationMode; shoutGo].		^ self].	viewerPane currentCategory: 'motion'.	self setDefaultSprite.	self newScratchProject.	fileName _ startupFileNames		detect: [:fn | fn asLowercase endsWith: '.sprite']		ifNone: [^ self].	"open a .sprite file"	workPane submorphs do: [:m | (m isKindOf: ScratchSpriteMorph) ifTrue: [m deleteSprite]].	self importSpriteOrProject: fileName.! !!ScratchFrameMorph methodsFor: 'file read/write' stamp: 'KK 9/5/2013 16:41'!extractInfoFrom: aByteArray	"Answer a Scratch info dictionary from the given ByteArray. Answer an empty dictionary if it is an old project."	| s version |	s _ ReadStream on: aByteArray.	version _ ObjStream scratchFileVersionFrom: (s next: 10) asString.	(version = 1) | (version = 2)		ifTrue: [			s skip: IOPort size.			s skip: 4.  "skip info header byte count"			^ ObjStream new readObjFrom: s showProgress: false]		ifFalse: [^ Dictionary new].! !!ScratchFrameMorph methodsFor: 'file read/write' stamp: 'KK 4/20/2015 10:23'!extractProjectFrom: aByteArray	"Answer a Scratch project (i.e. a ScratchStageMorph possibly containing sprites) from the given ByteArray. Answer nil if the project cannot be unpacked."	| s version proj prev dialogBox |	s _ ReadStream on: aByteArray.	version _ ObjStream scratchFileVersionFrom: (s next: 10) asString.	version = 0 ifTrue: [		s position: 0.		proj _ ObjStream new readObjFrom: s showProgress: true].	(version = 1) | (version = 2) ifTrue: [		versionConflict _ false.		s _ self setIOPortFrom: s put: true.	" Copy pin assing information to IOPort Array "		"-----------------------------------"		" Skip header data and check BPE version "		s uint32.						" skip header size "		ObjStream new readObjFrom: s.	" skip Object Table "		prev _ s position.				" store current position "		versionConflict ifTrue: [			" Block Programming Environment ver1.X - "			" Display Message "			dialogBox _ DialogBoxMorph new.			dialogBox withButtonsForYes: false no: false okay: true cancel: false.			dialogBox title: 'This project may not be able to properly open.'.			dialogBox message: 'Project you are trying to open might be using a block that can not be displayed in this programming environment. It is recommended that you update the programming environment to the latest version.'.			dialogBox openInWorld.		" Display Dialogbox "			dialogBox centerOnScreen.	" Set center position "			dialogBox world doOneCycle.			s position:prev.	" Back to Object Table header "		]		ifFalse: [			" Block Programming Environment ver1.0 "			s position:prev.	" Back to Object Table header "		].		"-----------------------------------""		s skip: s uint32."  "skip header"		proj _ ObjStream new readObjFrom: s showProgress: true].	proj class = ScratchStageMorph ifFalse: [		version > 2			ifTrue: [self error: 'Project created by a later version of Scratch']			ifFalse: [self error: 'Problem reading project.'].		^ nil].	ScriptableScratchMorph buildBlockSpecDictionary.	proj allMorphsDo: [:m |		(m isKindOf: ScriptableScratchMorph) ifTrue: [  "covert to new blocks"			m convertStacksToTuples.			m convertTuplesToStacks]]."Transcript show:'ScratchFrameMorph::extractProjectFrom:';cr."	^ proj! !!ScratchFrameMorph methodsFor: 'file read/write' stamp: 'sk 9/28/2016 16:21'!extractScriptFrom: aByteArray	"Answer a Scratch project (i.e. a ScratchStageMorph possibly containing sprites) from the given ByteArray. Answer nil if the project cannot be unpacked."	| s version proj btype |	s _ ReadStream on: aByteArray.	version _ ObjStream scratchFileVersionFrom: (s next: 10) asString.	version = 0 ifTrue: [		s position: 0.		proj _ ObjStream new readObjFrom: s showProgress: true].	(version = 1) | (version = 2) ifTrue: [		versionConflict _ false.		btype _ self checkIO: s.		btype = BoardType ifFalse: [			ErrorMessage show: 200.			^ self error: 'Different board type.'].		versionConflict ifTrue: [			" Block Programming Environment ver1.X - "			ErrorMessage show: 201].		s skip: s uint32.  "skip header"		proj _ ObjStream new readObjFrom: s showProgress: true].	proj class = ScratchStageMorph ifFalse: [		version > 2			ifTrue: [self error: 'Project created by a later version of Scratch']			ifFalse: [self error: 'Problem reading project.'].		^ nil].	ScriptableScratchMorph buildBlockSpecDictionary.	proj allMorphsDo: [:m |		(m isKindOf: ScriptableScratchMorph) ifTrue: [  "covert to new blocks"			m convertStacksToTuples.			m convertTuplesToStacks]].	^ proj! !!ScratchFrameMorph methodsFor: 'file read/write' stamp: 'KK 10/20/2017 16:55'!importScripts	"Allow the user to select a project to open, then merge that project's sprites with thecurrent project."	| response ltmp |	self closeMediaEditorsAndDialogs ifFalse: [^ self].	self stopAll.	response _ ScratchFileChooserDialog		chooseExistingFileType: #project		extensions: #(bpde)		title: 'Import Project'.	response ifNil: [^ self].	self importScripts: response.	ltmp _ ScratchTranslator currentLanguage.	self setLanguage: 'atc'. 	self setLanguage: ltmp. ! !!ScratchFrameMorph methodsFor: 'file read/write' stamp: 'KK 10/2/2017 09:22'!installNewProject: newWorkpane	"Called after creating or reading a new project to clear the process scheduler, pick an object to view, clear the library thumbnails, and perform other housekeeping."	| viewTarget sb |	self stopAll.	IOPort ifNil: [ IOPort _ Array new:18. ].	SvCalib ifNil: [ SvCalib _ Array new:8. ].	DCCalib ifNil: [ DCCalib _ Array new:2. ].	SvDegree ifNil: [ SvDegree _ Array new:8. ].	SvDegreeTemp ifNil: [ SvDegreeTemp _ Array new:8. ].	SvSentAlready ifNil: [ SvSentAlready _ Array new:8. ].	SvCalib atAllPut: 0.	DCCalib atAllPut: 100.	SvDegree atAllPut: 90.	SvDegreeTemp atAllPut: 90.	SvSentAlready atAllPut: false.	ServomotorSynchroMotion _ false.	newWorkpane class = ScratchStageMorph		ifFalse: [^ self inform: 'Incompatible Scratch file format'].	"self exitScratchSession."	workPane scratchServer ifNotNil: [		workPane scratchServer clearCaches.		workPane scratchServer stage: newWorkpane.		newWorkpane scratchServer: workPane scratchServer].	newWorkpane isQuarterSize: workPane isQuarterSize.	newWorkpane bounds: workPane bounds.	newWorkpane midiPortNum: workPane midiPortNum.	workPane closeMIDI.	"use the same sensorboard for the new project"	sb _ workPane sensorBoard.	newWorkpane submorphs do: [:m |		(m isKindOf: SensorBoardMorph) ifTrue: [			sb position: m position.			newWorkpane replaceSubmorph: m by: sb.			sb tryToOpenPort]].	newWorkpane sensorBoard: sb.	workPane owner replaceSubmorph: workPane by: newWorkpane.	workPane _ newWorkpane.	self fixByteReversedSounds.	"fix sprite positions (backward compatability)"	workPane submorphs do: [:m |		(m isKindOf: WatcherMorph) ifTrue: [m convertFromOldWatcher].		(m respondsTo: #costume) ifTrue: [			m position: m position + m costume rotationCenter]. "fix up positions"		m layoutChanged].	workPane layoutChanged.	"reset timer"	ScriptableScratchMorph resetTimer.	"pick an object view, or view the background if there is no other"	viewTarget _ workPane.	workPane submorphs do: [:m |		(m respondsTo: #scripts) ifTrue: [			m scripts size >= viewTarget scripts size ifTrue: [viewTarget _ m]]].	viewTarget viewBlocksAndScripts.	"populate the sprites list if it is empty (backward compatability)"	workPane sprites isEmpty ifTrue: [		workPane submorphs do: [:m |			(m isKindOf: ScriptableScratchMorph) ifTrue: [workPane sprites addLast: m]]].	scriptsPane tabPane currentTab: 'Scripts'.	libraryPane clearLibrary.	workPane clearPenTrails.	self updateProjectName.	ScratchProcess blockHighlightMSecs: 60.	ScratchPrompterMorph clearLastAnswer.	(projectInfo at: 'isHosting' ifAbsent: [false]) ifTrue: [		self enableRemoteSensors].	(projectInfo at: 'hasMotorBlocks' ifAbsent: [false]) ifTrue: [		self showMotorBlocks].	(projectInfo includesKey: 'penTrails') ifTrue: [		workPane penTrailsForm: (projectInfo at: 'penTrails')].	Clipboard _ nil.	World cleanseStepList.  "make sure garbage collect can clean up the old sprites"	Smalltalk garbageCollect.  "get rid of old sprite instances"	self world ifNotNil: [self world startSteppingSubmorphsOf: self].	ScriptableScratchMorph scratchOrigin: workPane center.	justSaved _ true.! !!ScratchFrameMorph methodsFor: 'file read/write' stamp: 'KK 10/20/2017 16:56'!nameFromFileName: fileName	"Return the given Scratch file name without the trailing .sb or .scratch extension, if it has one. Ensure the the result is UTF8."	| s |	s _ fileName.	(s asLowercase endsWith: '.scratch') ifTrue: [s _ s copyFrom: 1 to: s size - 8].	(s asLowercase endsWith: '.sb') ifTrue: [s _ s copyFrom: 1 to: s size - 3].	(s asLowercase endsWith: '.bpde') ifTrue: [s _ s copyFrom: 1 to: s size - 5].	s isUnicode ifFalse: [s _ UTF8 withAll: s].	^ s! !!ScratchFrameMorph methodsFor: 'file read/write' stamp: 'KK 10/25/2013 13:56'!openScratchProject	"Allow the user to select a project to open, then open that project."	| response newProj |	self closeMediaEditorsAndDialogs ifFalse: [^ self].	self stopAll.	(DuringTest = true)	" During a test ? "	ifTrue: [ self testModeOff. ].	" yes -> off "	(justSaved or: [self projectIsEmpty]) ifFalse: [		"ask the user if they want to save the current project"		response _ DialogBoxMorph askWithCancel: 'Save the current project?'.		response = #cancelled ifTrue: [^ self].		response ifTrue: [self saveScratchProjectNoDialog]].	response _ ScratchFileChooserDialog openScratchFileFor: self.	response = #cancelled ifTrue: [^ self].	(response isKindOf: String) ifTrue: [  "read the contents of a local file"		^ self openScratchProjectNamed: response].	(response isKindOf: ByteArray) ifTrue: [		[projectInfo _ self extractInfoFrom: response] ifError: [projectInfo _ Dictionary new].		[newProj _ self extractProjectFrom: response] ifError: [^ self].		self installNewProject: newProj.		projectDirectory _ ScratchFileChooserDialog getDefaultFolderForType: #project].! !!ScratchFrameMorph methodsFor: 'file read/write' stamp: 'sk 5/2/2017 19:29'!openScratchProjectNamed: fName	"Open a Scratch project with the given name."	| f projData newProj dir fn |	self closeMediaEditorsAndDialogs ifFalse: [^ self].		fn _ fName.	f _ FileStream readOnlyFileNamedOrNil: fn. 	f ifNil: ["try a different encoding, fixes a Firefox bug, -Jens"		fn _ fName isoLatinToMac asUTF8.		f _ FileStream readOnlyFileNamedOrNil: fn.		f ifNil: [^ self inform: 'Could not read' withDetails: fName]].	[	projData _ f binary contentsOfEntireFile.		newProj _ self extractProjectFrom: projData.		projectInfo _ self extractInfoFrom: projData.	] ifError: [:err :rcvr |		err = 'unsupported0' ifTrue: [			^ self inform: 'Could not read project' withDetails: '(Project created by Studuino mini)'].		 ^ self inform: 'Could not read project; file may be damaged' withDetails: '(', err, ')'].	dir _ FileDirectory dirPathFor: fn.	projectDirectory _ FileDirectory on: dir.	ScratchFileChooserDialog setLastFolderTo: projectDirectory forType: #project.	projectName _ FileDirectory localNameFor: fn.	self installNewProject: newProj.	self initializeWatcherPositions.	viewerPane updateContents.	" updating I/O "	self updateIOInfo.	" updating calibration info "	CalibInfoLocation = 1 ifTrue: [		(projectInfo includesKey: 'calibsv') ifTrue: [			SvCalib _ (projectInfo at: 'calibsv')].		(projectInfo includesKey: 'calibdc') ifTrue: [			DCCalib _ (projectInfo at: 'calibdc')].		self updateCalibInfo].! !!ScratchFrameMorph methodsFor: 'file read/write' stamp: 'KK 10/20/2017 16:57'!saveScratchProject	| fName result |	self closeMediaEditorsAndDialogs ifFalse: [^ self].	self stopAll.	(DuringTest = true)	" During a test ? "	ifTrue: [ self testModeOff. ].	" yes -> off "	TabletMode ifTrue: [		self sendMessageToBMnoBlocking: 'SHOWKEYPAD'].	fName _ ScratchFileChooserDialog saveScratchFileFor: self.	TabletMode ifTrue: [		self sendMessageToBMnoBlocking: 'HIDEKEYPAD'].	(fName size = 0 or: [fName = #cancelled]) ifTrue: [^ self].	[(result _ ScratchFileChooserDialog confirmFileOverwriteIfExisting: fName) = false] whileTrue: [		TabletMode ifTrue: [			self sendMessageToBMnoBlocking: 'SHOWKEYPAD'].		fName _ ScratchFileChooserDialog saveScratchFileFor: self.		TabletMode ifTrue: [			self sendMessageToBMnoBlocking: 'HIDEKEYPAD'].		(fName size = 0 or: [fName = #cancelled]) ifTrue: [^ self]].	(result = #cancelled) ifTrue: [^ self].	self updateLastHistoryEntryIfNeeded.	fName _ (self nameFromFileName: fName), '.bpde'.	projectDirectory _ FileDirectory on: (FileDirectory dirPathFor: fName).	projectName _ FileDirectory localNameFor: fName.	projectInfo at: 'author' put: author.	" saving calibration info "	CalibInfoLocation = 1 ifTrue: [		projectInfo at: 'calibsv' put: SvCalib.		projectInfo at: 'calibdc' put: DCCalib].	self updateHistoryProjectName: projectName op: 'save'.	self writeScratchProject.! !!ScratchFrameMorph methodsFor: 'file read/write' stamp: 'KK 10/20/2017 16:57'!saveScratchProjectNoDialog	| fName dir |	(DuringTest = true)	" During a test ? "	ifTrue: [ self testModeOff. ].	" yes -> off "	self closeMediaEditorsAndDialogs ifFalse: [^ self].	projectName ifNil: [projectName _ ''].	fName _ self nameFromFileName: projectName.	dir _ ScratchFileChooserDialog getLastFolderForType: #project.	(fName size = 0 | (dir fileExists: fName , '.bpde') not) ifTrue: [^ self saveScratchProject].	ScratchFileChooserDialog lastFolderIsSampleProjectsFolder ifTrue:  [^ self saveScratchProject].	self updateLastHistoryEntryIfNeeded.	projectName _ FileDirectory localNameFor: (fName, '.bpde').  "ignore path, if any; save in the original project directory"	projectDirectory _ dir.	" saving calibration info "	CalibInfoLocation = 1 ifTrue: [		projectInfo at: 'calibsv' put: SvCalib.		projectInfo at: 'calibdc' put: DCCalib].	self updateHistoryProjectName: projectName op: 'save'.	self writeScratchProject.! !!ScratchFrameMorph methodsFor: 'file read/write' stamp: 'KK 10/20/2017 16:57'!setIOPortFrom: fileStream put: flag
	"Read I/O Port Information from .bpde file"

	| i id newBoardType |
	(self hasStandardIO: fileStream) ifTrue: [
		newBoardType _ 0.
		IOPort _ Array new: 18]
	ifFalse: [
		BoardType = 0 ifTrue: [
			self error: 'unsupported0'.
			^ nil].
		newBoardType _ 1.
		IOPort _ Array new: 19].

	newBoardType = BoardType ifFalse: [
		BoardType _ newBoardType.
		self sendBoardTypeToBM].

	i _ 1.
	IOPort size timesRepeat: [
		id _ fileStream next.
		flag ifTrue: [
			(id > 21 and: [(id = 16r18) not]) ifTrue: [
				id _ 0.
				versionConflict _ true.
			].
			IOPort at: i put: id.
		]
		ifFalse: [
			(id > 21 and: [(id = 16r18) not]) ifTrue: [
				versionConflict _ true.
			].
		].
		i _ i + 1.
	].
	^ fileStream.
! !!ScratchFrameMorph methodsFor: 'file read/write' stamp: 'KK 9/5/2013 15:34'!storeProjectInfoOn: aBinaryStream	| s |	projectInfo at: 'thumbnail' put: workPane thumbnailForm.	s _ WriteStream on: (ByteArray new: 100000).	ObjStream new storeObj: projectInfo on: s.	aBinaryStream uint32: s size.	" save data size "	aBinaryStream nextPutAll: s contents.! !!ScratchFrameMorph methodsFor: 'file read/write' stamp: 'sk 9/27/2016 09:02'!updateHistoryProjectName: projName op: operation	"The given user is about to save or upload a project with the given name. Update the project history. operation is a string specifying the operation."	| timestamp tab history platform osVersion |	projectInfo removeKey: 'organization' ifAbsent: [].	"obsolete"	projectInfo at: 'scratch-version' put: Version.	timestamp _ (Date today printFormat: #(3 2 1 $- 1 1)), ' ', Time now print24.	tab _ String tab.	history _ projectInfo at: 'history' ifAbsent: [''].	history _ history, timestamp, tab.	history _ history, operation, tab, (self nameFromFileName: projName), tab, loginName, tab, author.	history _ history, String cr.	projectInfo at: 'history' put: history.	"record other data"	projectInfo at: 'scratch-version' put: Version.	projectInfo at: 'language' put: ScratchTranslator currentLanguage.	platform _ Smalltalk platformName.	platform ifNil: [platform _ 'unknown'].	'linux' = platform ifTrue: [		Display extent = (1200@900) ifTrue: [platform _ 'XO']].	projectInfo at: 'platform' put: platform.	osVersion _ Smalltalk osVersion.	osVersion ifNil: [osVersion _ 'unknown'].	projectInfo at: 'os-version' put: osVersion.	(workPane scratchServer notNil and:	 [workPane scratchServer isHosting])		ifTrue: [projectInfo at: 'isHosting' put: true]		ifFalse: [projectInfo removeKey: 'isHosting' ifAbsent: []].	(self allBlocksString includesSubString: 'motor')		ifTrue: [projectInfo at: 'hasMotorBlocks' put: true]		ifFalse: [projectInfo removeKey: 'hasMotorBlocks' ifAbsent: []].	workPane penTrailsForm		ifNil: [projectInfo removeKey: 'penTrails' ifAbsent: []]		ifNotNil: [projectInfo at: 'penTrails' put: workPane penTrailsForm].	projectInfo at: 'boardType' put: BoardType.! !!ScratchFrameMorph methodsFor: 'file read/write' stamp: 'KK 9/5/2013 17:20'!writeScratchProject	"Write this Scratch project to the file named projectFile in the project directory. Called by saveScratchProject."	| oldScriptsTarget oldTab oldViewerCategory oldPosition saveError out |	self stopAll.	self world ifNotNil: [self world activeHand newKeyboardFocus: nil].  "terminates active editor"	"share duplicate sounds and images"	self canonicalizeSoundsBits: nil saveOriginal: false.	self canonicalizeImagesQuality: nil saveOriginal: false.	oldScriptsTarget _ scriptsPane target.	oldTab _ scriptsPane tabPane currentTab.	oldViewerCategory _ viewerPane currentCategory.	scriptsPane target: nil.	workPane updateSpritesList.	oldPosition _ workPane position.	workPane delete; position: 0@0.	self updatePenPositions.	ScriptableScratchMorph buildBlockSpecDictionary.	workPane allMorphsDo: [:m |		(m isKindOf: ScriptableScratchMorph) ifTrue: [			m blocksBin allMorphsDo: [:b |				(b isKindOf: BlockMorph) ifTrue: [b stop]].			m convertStacksToTuples]].	saveError _ nil.	[	out _ FileStream newFileNamed: (projectDirectory unusedNameStartingWith: 'tmp').		out			ifNil: [saveError _ 'Folder may be locked or read-only']			ifNotNil: [				out binary.				out nextPutAll: 'ScratchV02' asByteArray.				" Write I/O port contructure "				out nextPutAll: IOPort asByteArray.				self storeProjectInfoOn: out.				ObjStream new storeObj: workPane on: out.				out close].	] ifError: [:err :rcvr |		out ifNotNil: [			[	out close.				projectDirectory deleteFileNamed: out localName.			] ifError: []].  "clean up, ignoring any errors"		saveError _ err].	workPane allMorphsDo: [:m |		(m isKindOf: ScriptableScratchMorph) ifTrue: [			m convertTuplesToStacks]].	self addMorph: (workPane position: oldPosition).	oldScriptsTarget ifNil: [oldScriptsTarget _ workPane].	oldScriptsTarget viewBlocksAndScripts.	scriptsPane tabPane currentTab: oldTab.	viewerPane currentCategory: oldViewerCategory.	self updatePenPositions.	saveError		ifNil: [			justSaved _ true.			self updateProjectName.			projectDirectory deleteFileNamed: projectName.			[projectDirectory rename: out localName toBe: projectName]				ifError: [^ self inform: 'Save failed' withDetails: 'Is the folder read-only?' localized].			projectDirectory setMacFileNamed: projectName type: 'STsb' creator: 'MITS']		ifNotNil: [			projectName _ ''.			self inform: 'Save failed' withDetails: saveError].! !!ScratchFrameMorph methodsFor: 'uploading' stamp: 'sk 8/19/2016 12:50'!calibrateSvMotor2| notification res |[	 | s |	ScratchMenuTitleMorph setMenuEnable: false.	s _ self createBMHandle.	s ifNil: [^ self].	" Asking user to push a reset button. "	notification _ NotificationMessage show: 16r20.	"Waiting for RESET"	" Success in connection "	" -------------------------------------------------------------------- "	" Send message "	" -------------------------------------------------------------------- "	s sendCommand: 'CALIB'.	" Waiting for BM to transfer a testmode program. "	Transcript show: '---------- Recving ----------'; cr.	res _ self waitForBMResponse: s.	(res = '-1') ifTrue: [		notification ifNotNil: [notification no].		^ self].	notification no.	(BoardType = 2) ifTrue: [		(res = 'OK') ifFalse: [			" Getting error number "			res _ self waitForBMResponse: s.			(res = '-1') ifTrue: [				notification ifNotNil: [notification no].				^ self].			" Notify timeout error. "			ErrorMessage show: res asNumber.			^ self].		" Asking user to push a reset button. - 2 - "		notification _ NotificationMessage show: 16r20.	"Waiting for RESET"		" Waiting for BM to transfer a testmode program. "		Transcript show: '---------- Recving1 ----------'; cr.		res _ self waitForBMResponse: s.		(res = '-1') ifTrue: [			notification ifNotNil: [notification no].			^ self].		notification no].	(res = 'OK') ifTrue: [		"Waiting INITOK"		res _ self waitForBMResponse: s.		(res = '-1') ifTrue: [			notification ifNotNil: [notification no].			^ self].		(res = 'INITOK') ifTrue: [			" Do nothing "]		ifFalse: [			notification no.			ErrorMessage show: 100.			^ self]]	ifFalse: [		" Notify error. "		Transcript show: '---------- Error ----------'; cr.		"Getting an error number."		notification no.		res _ self waitForBMResponse: s.		(res = '-1') ifTrue: [			notification ifNotNil: [notification no].			^ self].		ErrorMessage show: res asNumber.		^ self].		" ---------------------------------------------------------------- "		" Waiting for the calibration done.                          "		" ---------------------------------------------------------------- "		notification no.		BoardStatus _ 3.		"Wait for finish calibration"		res _ self waitForBMResponse: s For: 36000.		(res = '-1') ifTrue: [			notification ifNotNil: [notification no].			^ self].		Transcript show: '---------- Recv message: '; show:res; show:' ----------'; cr.		(res = 'ERR') ifTrue: [			" Disconnect !! "			ErrorMessage show: 1].		" Send message "		Transcript show: '---------- Sending ----------'; cr.		s sendCommand: 'BREAK'.		s disconnect.		s destroy.	ScratchMenuTitleMorph setMenuEnable: true.] fork.! !!ScratchFrameMorph methodsFor: 'private' stamp: 'sk 9/14/2017 17:55'!checkIO: stream

	| newBoardType ioSize id |

	(self hasStandardIO: stream) ifTrue: [
		newBoardType _ 0.
		ioSize _ 18]
	ifFalse: [
		newBoardType _ 1.
		ioSize _ 19].

	ioSize timesRepeat: [
		id _ stream next.
		(id > 21 and: [(id = 16r18) not]) ifTrue: [
			versionConflict _ true]].

	^ newBoardType! !!ScratchFrameMorph methodsFor: 'private' stamp: 'sk 3/24/2016 17:58'!createBMHandle	| filename f port |	" I connect to Board Manager through localhost. "	" Get IP Port Number "	filename := 'portNumber.info'.	f _ FileStream fileNamed: filename.	f binary.	port _ f uint32.	f close.	^ self createBMHandle: port.! !!ScratchFrameMorph methodsFor: 'private' stamp: 'sk 3/24/2016 21:50'!createBMHandle: portNumber	| hostName hostAddr s |	" I connect to Board Manager through localhost. "	" Communicate with Board Manager "	Socket initializeNetwork.	hostName _ '127.0.0.1'.	" For interprocess communication "	hostAddr _ NetNameResolver addressForName: hostName timeout: 10.	hostAddr ifNil: [		ErrorMessage show: 0.		^ nil.	].	s _ SimpleClientSocket new.	Transcript show: '---------- Connecting BM ----------'; cr.	s connectTo: hostAddr port: portNumber.	s waitForConnectionUntil: "self standardDeadline" (Socket deadlineSecs: 10).	(s isConnected) ifFalse: [		s destroy.		ErrorMessage show: 1.		^ nil.	].	^ s.! !!ScratchFrameMorph methodsFor: 'private' stamp: 'KK 9/23/2013 21:15'!enterQuarterModeIfSmallScreen"	(Display width >= 980) & (Display height >= 555) ifTrue: [^ self].	viewMode = #normal ifTrue: [self enterQuarterMode]."! !!ScratchFrameMorph methodsFor: 'private' stamp: 'sk 3/14/2017 11:12'!fontMagnifyBy: ratio	| s baseScale buttons targetIndex |	FontMagnification _ ratio.	baseScale _ 1.	s _ ScratchTranslator translationDict at: 'Font-Scale' ifAbsent: [''].	s size > 0 ifTrue: [		baseScale _ s asString asNumberNoError.		baseScale = 0 ifTrue: [baseScale _ 1]].  "non-number string"	buttons _ fontButtons submorphs select: [:each | each class == SimpleButtonMorph].	targetIndex _ #(1 1.5 2.0) indexOf: ratio.	buttons do: [:elm |		(buttons indexOf: elm) = targetIndex ifTrue: [			elm color: (Color lightOrange)]		ifFalse: [			elm color: (Color gray)]].	self setScaling: (baseScale * ratio)! !!ScratchFrameMorph methodsFor: 'private' stamp: 'sk 9/27/2016 19:27'!hasStandardIO: fileStream	| current check header |	current _ fileStream position.	fileStream position: current + 18 + 4.   "Standard IOPort size + header size"	check _ fileStream next: 5.	fileStream position: current.Transcript show: check; cr.	header _ #(16r4F 16r62 16r6A 16r53 16r01).	1 to: (header size) do: [:index |		(check at: index) = (header at: index) ifFalse: [			Transcript show: 'NG'; cr.			^ false]].	^ true! !!ScratchFrameMorph methodsFor: 'private' stamp: 'sk 7/7/2016 19:35'!initIOPort	""	| f filename arrayID index |	(BoardType = 0 or: [BoardType = 2]) ifTrue: [ " Studuino "Transcript show: 'Studuino selected.'.		arrayID _ #(1 1 0 0 0 0 2 2 2 0 21 21 21 21 0 0 0 0).]	ifFalse: [ "BoardType 1: Studuino mini"Transcript show: 'Studuino mini selected.'.		arrayID _ #(0 0 5 5 5 2 2 0 0 0 0 0 0 0 0 0 16 16 0).].Transcript show: 'size: ', arrayID size asString; cr.	" Redefine IOPOrt basing on arrayID size."	IOPort _ Array new: (arrayID size).	filename := 'Board.cfg'.	f _ StandardFileStream new open: filename forWrite: true.	f binary.	index _ 1.	arrayID do: [:elm |		IOPort at: index put: elm.		f nextPut: elm.		index _ index + 1.].	f close.! !!ScratchFrameMorph methodsFor: 'private' stamp: 'KK 9/26/2017 09:33'!initStuduinoGlobalVars	""	| arrayID svSize id |	(BoardType = 0 or: [BoardType = 2]) ifTrue: [ " Studuino "		arrayID _ #(1 0 0 0 0 0 0 0 0 0 0 16r10 16r13 0 0 0 0 0).	" Set M1:DCMotor, A1:Light Sensor, A2: IRPhotoreflector "		svSize _ 8.]	ifFalse: [ "BoardType 1: Studuino mini"		arrayID _ #(0 0 5 5 5 2 2 0 0 0 0 0 0 0 0 0 0 0 0).		svSize _ 5.].	" Redefine IOPOrt basing on arrayID size."	" Initialize buf array "	1 to: (arrayID size) do: [:num |		id _ arrayID at: num.		IOPort at: num put: id.	].	self updateIOInfo."Transcript show: '[ScratchFrameMorph::initStuduinoGlobalVArs] '; show: IOPort; cr."	SvCalib _ Array new: svSize.	SvCalib atAllPut: 0.	DCCalib _ #(100 100).	CalibInfoLocation = 1 ifTrue: [		self updateCalibInfo].	SvDegree _ Array new: svSize.	SvDegree atAllPut: 90.	SvDegreeTemp _ Array new: svSize.	SvDegreeTemp atAllPut: 90.	SvSentAlready _ Array new: svSize.	SvSentAlready atAllPut: false.	ServomotorSynchroMotion _ false.! !!ScratchFrameMorph methodsFor: 'private' stamp: 'sk 10/21/2015 15:07'!isPortAvailable: portName	"Answer if the port indicated by portName is available."	| port result |	port _ SerialPort2 new openPortNamed: portName baud: 9600.	result _ port isOpen.	port close.	port _ nil.		^ result! !!ScratchFrameMorph methodsFor: 'private' stamp: 'sk 5/17/2017 14:38'!readCalibInfo	" Reading calibration info from files and updating the variables. [Files -> Variables] "	| filename f tmp tval |	"---------------------------------------------------------"	" Get Servomotor Info "	"---------------------------------------------------------"	filename _ '..\common\sv_offset_ini'.	f _ StandardFileStream fileNamed: filename.	f binary.	tmp _ OrderedCollection new.	[f atEnd] whileFalse: [		tval _ f next.		" Convert an unsigned value to singed one."		(tval > 127) ifTrue: [			tval _ tval - 256].		tmp add: tval].	f close.	SvCalib _ Array newFrom: tmp.	"---------------------------------------------------------"	" Get DC motor Info "	"---------------------------------------------------------"	filename _ '..\common\dc_calib_ini'.	f _ StandardFileStream fileNamed: filename.	f binary.	tmp _ OrderedCollection new.	[f atEnd] whileFalse: [		tmp add: (f next)].	f close.	DCCalib _ Array newFrom: tmp.! !!ScratchFrameMorph methodsFor: 'private' stamp: 'sk 5/15/2017 17:13'!recordCalibInfoLocation: aString	"Record a location of calibration information in the settings file."	| fName f sz settings all |	fName _ FileDirectory default fullNameFor: 'Block.ini'.	f _ FileStream concreteStream new open: fName forWrite: true.	f ifNil: [^ self].	sz _ f size.	settings _ (f next: sz) lines.	settings _ settings reject: [:s | s asLowercase beginsWith: 'calibinfostore='].	settings _ settings reject: [:s | all _ s asByteArray asSet. (all size = 1) and: [all asArray first = 0]].	settings _ settings copyWith: ('CalibInfoStore=', aString).	f position: 0.	settings do: [:s | f nextPutAll: s, String crlf].	[f position < sz] whileTrue: [f nextPut: 0 asCharacter].	f close.! !!ScratchFrameMorph methodsFor: 'private' stamp: 'sk 3/14/2017 10:14'!recordFontMagnification: aString	"Record font magnification in the settings file."	| fName f sz settings all |	fName _ FileDirectory default fullNameFor: 'Block.ini'.	f _ FileStream concreteStream new open: fName forWrite: true.	f ifNil: [^ self].	sz _ f size.	settings _ (f next: sz) lines.	settings _ settings reject: [:s | s asLowercase beginsWith: 'fontmagnification='].	settings _ settings reject: [:s | all _ s asByteArray asSet. (all size = 1) and: [all asArray first = 0]].	settings _ settings copyWith: ('FontMagnification=', aString).	f position: 0.	settings do: [:s | f nextPutAll: s, String crlf].	[f position < sz] whileTrue: [f nextPut: 0 asCharacter].	f close.! !!ScratchFrameMorph methodsFor: 'private' stamp: 'sk 3/9/2017 11:06'!recordLanguage: aString	"Record my language in the settings file."	"ScratchFrameMorph new recordLanguage: 'English'"	| fName f sz settings all |	fName _ FileDirectory default fullNameFor: 'Block.ini'.	f _ FileStream concreteStream new open: fName forWrite: true.	f ifNil: [^ self].	sz _ f size.	settings _ (f next: sz) lines.	settings _ settings reject: [:s | s asLowercase beginsWith: 'language='].	settings _ settings reject: [:s | all _ s asByteArray asSet. (all size = 1) and: [all asArray first = 0]].	settings _ settings copyWith: ('Language=', aString).	f position: 0.	settings do: [:s | f nextPutAll: s, String crlf].	[f position < sz] whileTrue: [f nextPut: 0 asCharacter].	f close.! !!ScratchFrameMorph methodsFor: 'private' stamp: 'sk 10/21/2015 17:17'!recordVerify: aString	"Record my verify flag in the settings file."	| fName f sz settings all |	fName _ FileDirectory default fullNameFor: 'Block.ini'.	f _ FileStream concreteStream new open: fName forWrite: true.	f ifNil: [^ self].	sz _ f size.	settings _ (f next: sz) lines.	settings _ settings reject: [:s | s asLowercase beginsWith: 'verify='].	settings _ settings reject: [:s | all _ s asByteArray asSet. (all size = 1) and: [all asArray first = 0]].	settings _ settings copyWith: ('Verify=', aString).	f position: 0.	settings do: [:s | f nextPutAll: s, String crlf].	[f position < sz] whileTrue: [f nextPut: 0 asCharacter].	f close.! !!ScratchFrameMorph methodsFor: 'private' stamp: 'sk 9/28/2016 17:35'!selectBoardType	"Sending a message to BM for changing a boardtype."	| menu type bullet boards |"	bullet _ UTF8 withAll: ' '."	bullet _ '* '.	boards _ #('Studuino' 'Studuino mini' 'Studuino & mini').	menu _ CustomMenu new title: 'Select a board type.'.	(BoardType = 0) ifTrue: [		menu add: (bullet, (boards at:1)) action: 0.		menu add: (boards at:2) action: 1."		menu add: (boards at:3) action: 2"].	(BoardType = 1) ifTrue: [		menu add: (boards at:1) action: 0.		menu add: (bullet, (boards at:2)) action: 1."		menu add: (boards at:3) action: 2"].	(BoardType = 2) ifTrue: [		menu add: (boards at:1) action: 0.		menu add: (boards at:2) action: 1.		menu add: (bullet, (boards at:3)) action: 2].	type _ menu localize startUp.	type ifNil: [^ self].	(DuringTest = true) ifTrue: [	" During a test? "		self testModeOff].	BoardType _ type.	BoardStatus _ -1.	self newScratchProject.	self sendBoardTypeToBM.! !!ScratchFrameMorph methodsFor: 'private' stamp: 'sk 9/28/2016 10:39'!sendBoardTypeToBM	| s btype res |	" Connect to BM "	s _ self createBMHandle.	s ifNil: [^ self].	" Success in connection "	" Send message "	Transcript show: '---------- Sending ----------'; cr.	(BoardType == 0) ifTrue: [Transcript show: 'standard'; cr.		btype _ 'BOARD0'].	(BoardType == 1) ifTrue: [Transcript show: 'mini'; cr.		btype _ 'BOARD1'].	(BoardType == 2) ifTrue: [Transcript show: 'standard + mini'; cr.		btype _ 'BOARD2'].	s sendCommand: btype.	" Wait for BM's response. "	Transcript show: '---------- Recving ----------'; cr.	res _ self waitForBMResponse: s.	(res = '-1') ifTrue: [		^ self].Transcript show: 'board changed to ', res, '.'; cr.	s sendCommand: 'BREAK'.	s disconnect.	s destroy.! !!ScratchFrameMorph methodsFor: 'private' stamp: 'sk 8/23/2016 18:22'!sendFinishToBM	| s line |	" Communicate with Board Manager "	s _ self createBMHandle.	s ifNil: [^ false].	" Success in connection "	" Send message "	Transcript show: '---------- Sending ----------'; cr.	s sendCommand: 'FINISH'.	line _ self waitForBMResponse: s For: 2.	(line = '-1') ifTrue: [^ false].	^ true! !!ScratchFrameMorph methodsFor: 'private' stamp: 'sk 7/27/2016 19:18'!sendMessageToBM: aMessage	 | s line result |	" Communicate with Board Manager "	s _ self createBMHandle.	s ifNil: [^ self].	" Success in connection "	" Send message "	Transcript show: '---------- Sending ----------'; cr.	s sendCommand: aMessage.	" Wait for program creation and updating to end  "	Transcript show: '---------- Recving ----------'; cr.	line _ self waitForBMResponse: s.	(line = '-1') ifTrue: [^ self].	result _ line sansPeriodSuffix.	line _ self waitForBMResponse: s.	(line = '-1') ifTrue: [^ self].	Transcript show:line;cr.	" Display message"	" Send message "	Transcript show: '---------- Sending BREAK----------'; cr.	s sendCommand: 'BREAK'.	s disconnect.	s destroy.! !!ScratchFrameMorph methodsFor: 'private' stamp: 'sk 1/24/2017 09:38'!sendMessageToBMnoBlocking: aMessage	 | s |	" Communicate with Board Manager "	s _ self createBMHandle.	s ifNil: [^ self].	" Success in connection "	" Send message "	Transcript show: '---------- Sending ----------'; cr.	s sendCommand: aMessage.	" Send message "	Transcript show: '---------- Sending BREAK----------'; cr.	s sendCommand: 'BREAK'.	s disconnect.	s destroy.! !!ScratchFrameMorph methodsFor: 'private' stamp: 'sk 5/2/2017 19:26'!setCalibInfoLocation: aNumber	CalibInfoLocation _ aNumber.! !!ScratchFrameMorph methodsFor: 'private' stamp: 'KK 9/27/2017 18:17'!setFontMagnification: aRatio	paBoard _ self pinAssignBoard.	paBoard cancelled.	self fontMagnifyBy: aRatio.	self recordFontMagnification: aRatio asString.! !!ScratchFrameMorph methodsFor: 'private' stamp: 'sk 3/14/2017 11:21'!setLanguage: aString	"Set my language and update my blocks."	| tempJustSaved |	tempJustSaved _ justSaved.	(workPane submorphs copyWith: workPane) do: [:m |		(m isKindOf: ScriptableScratchMorph) ifTrue: [			m convertStacksToTuples]].	ScratchTranslator setLanguage: (ScratchTranslator isoCodeForName: aString).	viewerPane rebuildCategorySelectors.	(workPane submorphs copyWith: workPane) do: [:m |		(m isKindOf: ScriptableScratchMorph) ifTrue: [			m convertTuplesToStacks]].	self updatePanes.	self		view: scriptsPane target		tab: scriptsPane tabPane currentTab		category: viewerPane currentCategory.	justSaved _ tempJustSaved.	self fontMagnifyBy: FontMagnification.! !!ScratchFrameMorph methodsFor: 'private' stamp: 'sk 2/7/2017 11:59'!setScaling: aNumber	"Set my language and update my blocks."	| tempJustSaved |	ScratchTranslator fontScale: aNumber.	tempJustSaved _ justSaved.	(workPane submorphs copyWith: workPane) do: [:m |		(m isKindOf: ScriptableScratchMorph) ifTrue: [			m convertStacksToTuples]].	"ScratchTranslator setLanguage: (ScratchTranslator isoCodeForName: aString)."	viewerPane rebuildCategorySelectors.	(workPane submorphs copyWith: workPane) do: [:m |		(m isKindOf: ScriptableScratchMorph) ifTrue: [			m convertTuplesToStacks]].	self updatePanes.	self		view: scriptsPane target		tab: scriptsPane tabPane currentTab		category: viewerPane currentCategory.	justSaved _ tempJustSaved.! !!ScratchFrameMorph methodsFor: 'private' stamp: 'sk 9/28/2017 17:35'!shiftToTestMode	"Move onto test mode for Studuino."	| s dialogBox line sb mid pin ival parts comPort msgID result partsID type |	(BoardStatus = 1) ifFalse: [		s _ self createBMHandle.		s ifNil: [^ self].		"---------- Success in connection ----------"		" Send message "		Transcript show: '---------- Sending ----------'; cr.		s sendCommand: 'TEST'.		" Display Status DialogBox "		dialogBox _ NotificationMessage show: 16r11.	"Shifting to testmode"						" Wait for program creation and updating to end  "		Transcript show: '---------- Recving ----------'; cr.		line _ self waitForBMResponse: s.		(line = '-1') ifTrue: [			dialogBox ifNotNil: [dialogBox no].			^ self].		comPort _ line sansPeriodSuffix.		COMPort _ comPort.	" set class value "		line _ self waitForBMResponse: s.		(line = '-1') ifTrue: [			dialogBox ifNotNil: [dialogBox no].			^ self].		msgID _ line sansPeriodSuffix.		" Hide Status DialogBox "Transcript show:comPort; show:', '; show:line;cr.	" Display message "		" Send message "		Transcript show: '---------- Sending ----------'; cr.		s sendCommand: 'BREAK'.		s disconnect.		s destroy.		BoardStatus _ 1.	] " End communication with Boardmanager."	ifTrue: [		comPort _ COMPort.		" Display Status DialogBox "		dialogBox _ NotificationMessage show: 16r11.	"Shifting to testmode"	].	(comPort = 'ERR') ifFalse: [	" Success to Transfer "		"Check if the port is available."		(self isPortAvailable: comPort) ifFalse: [			COMPort _ nil.			BoardStatus _ 0.			" Hide communication box "			dialogBox no.			self testMode.			^ self		].		" Connect with Arduino board ""sc _ workPane servoCalibrationBoard."		sb _ workPane sensorBoard.		sb portIsOpen ifTrue: [Transcript show:'[ScratchFrameMorph::testMode] close & open port';cr.			sb closePort.		].		sb selectPort: comPort.		" Wait for run arduino board "			result _ sb isBoardSetup.		result ifFalse: [			" Hide communication box "			dialogBox no.			sb closePort.			BoardStatus _ 0.			self testMode.		]		ifTrue: [			"  Set sensorboard items "			sb addReadouts.			" Send port configuration "			mid _ 5.			0 to: 7 do: [: index |				partsID _ IOPort at: (11 + index).				((partsID = 17) | (partsID = 21)) ifTrue: [					type _ 0]. "Digital"				((partsID = 16) | (partsID = 18) | (partsID = 19)) ifTrue: [					type _ 1]. "Analog"				(partsID = 20) ifTrue: [					type _ 2]. "Accelerometer"				(partsID = 24) ifTrue: [					type _ 3]. "Temperature"				(partsID > 15) & (partsID < 25) ifTrue: [					ival _ 16r0100 + (type bitShift: 4) + index.					sb data:ival msgID:mid.					Transcript show: ival; cr]].			" Start DummySend process if no sensor is selected. "			(IOPort select: [:each | (each > 15) & (each < 25)]) size = 0				ifTrue: [sb dummySend].			" Set Servomotors' degree connected Studuino. "			1 to: (SvDegree size) do: [ : i |				SvDegree at: i put: 90.				SvDegreeTemp at:i put:90.			].			ServomotorSynchroMotion _ false.			" Set servomotors 90 deg. with offsets. "			(3 to: 10) do: [:elm |				((IOPort at: elm) = 0) ifFalse: [					sb data: (DataCreation getServoWithOffsetFor: (elm - 3) degree: 90) msgID: 1]].			" Hide communication box "			dialogBox no.			self showSensorBoard.			DuringTest _ true.		]	]	ifTrue: [		" Hide communication box "		dialogBox no.		BoardStatus _ 0.		ErrorMessage show: msgID asNumber.	].! !!ScratchFrameMorph methodsFor: 'private' stamp: 'sk 8/8/2016 12:48'!shiftToTestModeMini	"Move onto test mode for Studuino mini."	| s line sb res socketCommand port notification portCommand portSensor socketSensor |	(BoardStatus = 1) ifFalse: [		s _ self createBMHandle.		s ifNil: [^ self].		" Asking user to push a reset button. "		notification _ NotificationMessage show: 16r20.	"Waiting for RESET"		"---------- Success in connection ----------"		" Send message "		Transcript show: '---------- Sending TEST----------'; cr.		s sendCommand: 'TEST'.		" Waiting for BM to transfer a testmode program. "		Transcript show: '---------- Recving ----------'; cr.		line _ self waitForBMResponse: s.		(line = '-1') ifTrue: [			notification ifNotNil: [notification no].			^ self].		res _ line.		notification no.		notification _ NotificationMessage show: 16r11.	"Shifting to testmode"						(res = 'OK') ifTrue: [			line _ self waitForBMResponse: s.			(line = '-1') ifTrue: [				notification ifNotNil: [notification no].				^ self].			res _ line.			(res = 'INITOK') ifTrue: [				Transcript show: '---------- Sending TEST2S----------'; cr.				s sendCommand: 'TEST2S'.				line _ self waitForBMResponse: s.				(line = '-1') ifTrue: [						notification ifNotNil: [notification no].					^ self].				res _ line. "Waiting port number."				port _ res asNumber.]			ifFalse: [				notification no.				ErrorMessage show: 100.				^ self].]		ifFalse: [			" Notify error. "			Transcript show: '---------- Error ----------'; cr.			notification no.			line _ self waitForBMResponse: s.			(line = '-1') ifTrue: [					notification ifNotNil: [notification no].				^ self].			ErrorMessage show: line asNumber.			^ self].	].Transcript show: res; cr.	(port > 0) ifTrue: [	" Success to Transfer "		"Check if the port is available."		portCommand _ (port asNumber) bitAnd: 16rFFFF.		portSensor _ portCommand + ((port asNumber) bitShift: -16).		sb _ workPane sensorBoard.		sb socketIsOpen ifTrue: [Transcript show:'[ScratchFrameMorph::testMode] close & open port';cr.			sb closeSocket.		]."		sb socket: s."		s sendCommand: 'BREAK'.		s disconnect.		s destroy.		socketSensor _ self createBMHandle: portSensor.		socketSensor ifNil: [^ self.].		sb socket: socketSensor.		socketCommand _ self createBMHandle: port.		socketCommand ifNil: [^ self.].		sb socketCommand: socketCommand.		"  Set sensorboard items "		sb addReadouts.		" Send port configuration "		self showSensorBoard.		DuringTest _ true.	].	notification no.! !!ScratchFrameMorph methodsFor: 'private' stamp: 'sk 8/23/2016 09:05'!shiftToTestModeMini2	"Move onto test mode for Studuino mini."	| s line sb res socketCommand port notification portCommand portSensor socketSensor |	(BoardStatus = 1) ifFalse: [		s _ self createBMHandle.		s ifNil: [^ self].		"---------- Success in connection ----------"		" Send message "		Transcript show: '---------- Sending TEST----------'; cr.		s sendCommand: 'TEST'.		" Asking user to push a reset button. - 1 - "		notification _ NotificationMessage show: 16r20.	"Waiting for RESET"		" Waiting for BM to transfer a testmode program. "		Transcript show: '---------- Recving1 ----------'; cr.		line _ self waitForBMResponse: s.		(line = '-1') ifTrue: [			notification ifNotNil: [notification no].			^ self].		res _ line.		notification no.		(res = 'OK') ifFalse: [			" Getting error number "			line _ self waitForBMResponse: s.			(line = '-1') ifTrue: [				notification ifNotNil: [notification no].				^ self].			" Notify timeout error. "			ErrorMessage show: line asNumber.			^ self].		" Asking user to push a reset button. - 2 - "		notification _ NotificationMessage show: 16r21.	"Waiting for RESET"		" Waiting for BM to transfer a testmode program. "		Transcript show: '---------- Recving1 ----------'; cr.		line _ self waitForBMResponse: s.		(line = '-1') ifTrue: [			notification ifNotNil: [notification no].			^ self].		res _ line.		notification no.		(res = 'OK') ifFalse: [			" Getting error number "			line _ self waitForBMResponse: s.			(line = '-1') ifTrue: [				notification ifNotNil: [notification no].				^ self].			" Notify timeout error. "			ErrorMessage show: line asNumber.			^ self].		Transcript show: '---------- Recving3 ----------'; cr.		"Waiting INITOK"		line _ self waitForBMResponse: s.		(line = '-1') ifTrue: [			notification ifNotNil: [notification no].			^ self].		res _ line sansPeriodSuffix.		(res = 'INITOK') ifTrue: [			Transcript show: '---------- Sending TEST2S----------'; cr.			s sendCommand: 'TEST2S'.			line _ self waitForBMResponse: s.			(line = '-1') ifTrue: [				notification ifNotNil: [notification no].				^ self].			port _ line asNumber.]		ifFalse: [			notification no.			ErrorMessage show: 100.			^ self].	].Transcript show: res; cr.	(port > 0) ifTrue: [	" Success to Transfer "		"Check if the port is available."		portCommand _ (port asNumber) bitAnd: 16rFFFF.		portSensor _ portCommand + ((port asNumber) bitShift: -16).		sb _ workPane sensorBoard.		sb socketIsOpen ifTrue: [Transcript show:'[ScratchFrameMorph::testMode] close & open port';cr.			sb closeSocket.		]."		sb socket: s."		s sendCommand: 'BREAK'.		s disconnect.		s destroy.		socketSensor _ self createBMHandle: portSensor.		socketSensor ifNil: [^ self.].		sb socket: socketSensor.		socketCommand _ self createBMHandle: port.		socketCommand ifNil: [^ self.].		sb socketCommand: socketCommand.		"  Set sensorboard items "		sb addReadouts.		" Send port configuration "		self showSensorBoard.		DuringTest _ true.	].	notification no.! !!ScratchFrameMorph methodsFor: 'private' stamp: 'sk 5/17/2017 15:12'!updateCalibInfo	" Updating calibration files with the latest info. [Variables -> Files] "	| filename f |	"---------------------------------------------------------"	" Get Servomotor Info "	"---------------------------------------------------------"	filename _ '..\common\sv_offset_ini'.	f _ StandardFileStream fileNamed: filename.	f binary.	SvCalib do: [:elm |		(elm < 0) ifTrue: [			f nextPut: elm + 256]		ifFalse: [			f nextPut: elm]].	f close.	"---------------------------------------------------------"	" Get DC motor Info "	"---------------------------------------------------------"	filename _ '..\common\dc_calib_ini'.	f _ StandardFileStream fileNamed: filename.	f binary.	DCCalib do: [:elm |		f nextPut: elm].	f close.! !!ScratchFrameMorph methodsFor: 'private' stamp: 'sk 4/25/2017 10:58'!updateIOInfo	" Updating an IOInfo file with the latest info. [Variable -> File] "	| filename f |	"---------------------------------------------------------"	" Write I/O configuration file "	"---------------------------------------------------------"	filename := 'Board.cfg'.	f _ FileStream fileNamed: filename.	f binary.	IOPort do: [ :elm |		f nextPut: elm].	f close.! !!ScratchFrameMorph methodsFor: 'private' stamp: 'KK 9/27/2017 13:44'!updatePanes	| p |	menuPanel delete.	self createMenuPanel."----------	toolbarPanel delete.	self createToolbar.----------"	viewModeButtonsPanel delete.	self createViewModeButtonsPanel.	stageButtonsPanel delete.	self createStageButtonsPanel.	titlePane addMorph: stageButtonsPanel."----------	scriptsPane tabPane delete.	scriptsPane createTabPane.	readoutPane delete.	self createReadoutPane.----------"	workPane sensorBoard owner		ifNil: [p _ nil]		ifNotNil: [p _ stageFrame position - ((workPane sensorBoard width)@0) + (-20@20)].	workPane sensorBoard addReadouts.	p ifNotNil:[		self showSensorBoard.		workPane sensorBoard position: p].	self pinAssignBoard addReadouts.	libraryPane clearLibrary.	self scratchWatchers do: [:w | w languageChanged].	self listWatchers do: [:w | w fixLayoutForNewLanguage].	World startSteppingSubmorphsOf: self.	self fixLayout.	scriptsPane fixLayout.	self updateViewModeButtons.! !!ScratchFrameMorph methodsFor: 'private' stamp: 'KK 10/9/2013 12:04'!updateProjectName	"Update the project name display in the Scratch title bar."	| s |	projectName ifNil: [projectName _ ''].	projectTitleMorph contents: (self nameFromFileName: projectName).	projectTitleMorph contents size > 0		ifTrue: [s _ projectTitleMorph contents, '- SPE BLOCK']		ifFalse: [s _ 'Studuino BLOCK Programming Environment'", Version"].	ScratchPlugin primSetWindowTitle: s.	self fixLayout.! !!ScratchFrameMorph methodsFor: 'private' stamp: 'sk 7/27/2016 19:08'!waitForBMResponse: s	| line |	" I receive message from Board Manager and return message"	line _ WriteStream on: String new.	line _ s getBMResponse.	^ line sansPeriodSuffix.! !!ScratchFrameMorph class methodsFor: 'class initialization' stamp: 'sk 3/23/2017 16:00'!initialize	|  |	"self initialize"	Clipboard _ nil.	WorkpaneExtent _ 480@360.	UseErrorCatcher _ true.	DefaultNotes _ ''.	IOPort ifNil: [ IOPort _ Array new:18. ].	SvCalib ifNil: [ SvCalib _ Array new:8. ].	DCCalib ifNil: [ DCCalib _ Array new:2. ].	SvDegree ifNil: [ SvDegree _ Array new:8. ].	LangDic ifNil: [ LangDic _ Dictionary new. ].	LangDic		at: 'ja' put: 'LANGJ';		at: 'ja_HIRA' put: 'LANGH';		at: 'zh_CN' put: 'LANGZ';		at: 'zh_TW' put: 'LANGZT';		at: 'ko' put: 'LANGK';		at: 'es' put: 'LANGES'.	self initFonts.! !!ScratchFrameMorph class methodsFor: 'scratch skin' stamp: 'KK 12/25/2012 18:33'!readSkinFrom: t1 	| t2 t3 t4 t5 |	t2 _ Dictionary new.	t5 _ Dictionary new.	t1 fileNames do: 		[:t6 | 		Cursor read showWhile: [t3 _ [Form fromFileNamed: (t1 fullNameFor: t6)]						ifError: []].		t3			ifNotNil: 				[t4 _ t6 findLast: [:t7 | t7 = $.].				t4 = 0 ifFalse: [t6 _ t6 copyFrom: 1 to: t4 - 1].				(t6 asLowercase endsWith: '_xo')					ifTrue: [t5 at: (t6 copyFrom: 1 to: t6 size - 3) asSymbol put: t3]					ifFalse: [t2 at: t6 asSymbol put: t3]]].	ScratchSkin _ t2.	ScratchSkinXO _ t5.	t3 _ ScratchSkin at: #scriptsPaneTexture ifAbsent: [].	(t3 notNil and: [t3 depth ~= 32])		ifTrue: [ScratchSkin at: #scriptsPaneTexture put: (t3 asFormOfDepth: 32)]! !!ScratchFrameMorph class methodsFor: 'utilities' stamp: 'sk 7/30/2015 16:11'!displayMessageDialog: msgID	" I display Dialog Message from number. "	| dialogBox |	(msgID = '0') ifTrue: [	" Could not access to BM "		dialogBox _ DialogBoxMorph new.		dialogBox withButtonsForYes: false no: false okay: true cancel: false.		dialogBox title: 'Could not access to Studuino'.		dialogBox message: 'Please save your project and restart this software.'.		dialogBox openInWorld.		" Display Dialogbox "		dialogBox centerOnScreen.	" Set center position "		dialogBox world doOneCycle.	].	(msgID = '1') ifTrue: [		dialogBox _ DialogBoxMorph new.		dialogBox withButtonsForYes: false no: false okay: true cancel: false.		dialogBox title: 'Could not access to Studuino'.		dialogBox message: 'Make sure Studuino is connected to the PC.'.		dialogBox openInWorld.		" Display Dialogbox "		dialogBox centerOnScreen.	" Set center position "		dialogBox world doOneCycle.	].	(msgID = '2') ifTrue: [		dialogBox _ DialogBoxMorph new.		dialogBox withButtonsForYes: false no: false okay: true cancel: false.		dialogBox title: 'Could not access to Studuino'.		dialogBox message: 'Serial port already in use.Try quiting any programs that may be using it.'.		dialogBox openInWorld.		" Display Dialogbox "		dialogBox centerOnScreen.	" Set center position "		dialogBox world doOneCycle.	].	(msgID = '3') ifTrue: [		dialogBox _ DialogBoxMorph new.		dialogBox withButtonsForYes: false no: false okay: true cancel: false.		dialogBox title: 'Could not access to Studuino'.		dialogBox message: 'Studuino and PC failed to sync.Save your project, exit this software, reset Studuino, and restart this software.'.		dialogBox openInWorld.		" Display Dialogbox "		dialogBox centerOnScreen.	" Set center position "		dialogBox world doOneCycle.	].	(msgID = '4') ifTrue: [		dialogBox _ DialogBoxMorph new.		dialogBox withButtonsForYes: false no: false okay: true cancel: false.		dialogBox title: 'Could not access to Studuino'.		dialogBox message: 'Disconnected.'.		dialogBox openInWorld.		" Display Dialogbox "		dialogBox centerOnScreen.	" Set center position "		dialogBox world doOneCycle.	].	(msgID = '5') ifTrue: [		dialogBox _ DialogBoxMorph new.		dialogBox withButtonsForYes: false no: false okay: true cancel: false.		dialogBox title: 'System error'.		dialogBox message: 'System file is corrupted.Save your project, exit this software, reinstall Studuino programming environment.'.		dialogBox openInWorld.		" Display Dialogbox "		dialogBox centerOnScreen.	" Set center position "		dialogBox world doOneCycle.	].	(msgID = '6') ifTrue: [		dialogBox _ DialogBoxMorph new.		dialogBox withButtonsForYes: false no: false okay: true cancel: false.		dialogBox title: 'Could not access to Studuino'.		dialogBox message: 'COM port error.'.		dialogBox openInWorld.		" Display Dialogbox "		dialogBox centerOnScreen.	" Set center position "		dialogBox world doOneCycle.	].	(msgID = '7') ifTrue: [		dialogBox _ DialogBoxMorph new.		dialogBox withButtonsForYes: false no: false okay: true cancel: false.		dialogBox title: 'Build error'.		dialogBox message: 'Main function is not defined.'.		dialogBox openInWorld.		" Display Dialogbox "		dialogBox centerOnScreen.	" Set center position "		dialogBox world doOneCycle.	].	(msgID = '8') ifTrue: [		dialogBox _ DialogBoxMorph new.		dialogBox withButtonsForYes: false no: false okay: true cancel: false.		dialogBox title: 'Build error'.		dialogBox message: 'Script too big.'.		dialogBox openInWorld.		" Display Dialogbox "		dialogBox centerOnScreen.	" Set center position "		dialogBox world doOneCycle.	].	(msgID = '9') ifTrue: [		dialogBox _ DialogBoxMorph new.		dialogBox withButtonsForYes: false no: false okay: true cancel: false.		dialogBox title: 'Build error'.		dialogBox message: 'An error has occurred in the archiving process. Please re-install.'.		dialogBox openInWorld.		" Display Dialogbox "		dialogBox centerOnScreen.	" Set center position "		dialogBox world doOneCycle.	].	(msgID = '10') ifTrue: [		dialogBox _ DialogBoxMorph new.		dialogBox withButtonsForYes: false no: false okay: true cancel: false.		dialogBox title: 'Build error'.		dialogBox message: 'An error has occurred in the object copy1 process. Please re-install.'.		dialogBox openInWorld.		" Display Dialogbox "		dialogBox centerOnScreen.	" Set center position "		dialogBox world doOneCycle.	].	(msgID = '11') ifTrue: [		dialogBox _ DialogBoxMorph new.		dialogBox withButtonsForYes: false no: false okay: true cancel: false.		dialogBox title: 'Could not access to Studuino'.		dialogBox message: 'Time-out error has occurred in the communication with Studuino board. If the same error occurs even replaced the USB port on the PC side, please restart your PC.'.		dialogBox openInWorld.		" Display Dialogbox "		dialogBox centerOnScreen.	" Set center position "		dialogBox world doOneCycle.	].	(msgID = '12') ifTrue: [		dialogBox _ DialogBoxMorph new.		dialogBox withButtonsForYes: false no: false okay: true cancel: false.		dialogBox title: 'Could not access to Studuino'.		dialogBox message: 'Timeout error occurred in the communication of the substrate. Please restart the programming environment.'.		dialogBox openInWorld.		" Display Dialogbox "		dialogBox centerOnScreen.	" Set center position "		dialogBox world doOneCycle.	].	" ------------------------------- "	" The value of Message ID 13, 14, 15 is usable. "	" ------------------------------- "	(msgID = '17') ifTrue: [		dialogBox _ DialogBoxMorph new.		dialogBox withButtonsForYes: false no: false okay: true cancel: false.		dialogBox title: 'Build error'.		dialogBox message: 'Undefined function.'.		dialogBox openInWorld.		" Display Dialogbox "		dialogBox centerOnScreen.	" Set center position "		dialogBox world doOneCycle.	].	(msgID = '18') ifTrue: [		dialogBox _ DialogBoxMorph new.		dialogBox withButtonsForYes: false no: false okay: true cancel: false.		dialogBox title: 'Build error'.		dialogBox message: 'There are blocks that are not connected.'.		dialogBox openInWorld.		" Display Dialogbox "		dialogBox centerOnScreen.	" Set center position "		dialogBox world doOneCycle.	].	" ------------------------------- "	" The value of Message ID 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30 is usable. "	" ------------------------------- "	(msgID = '30') ifTrue: [		dialogBox _ DialogBoxMorph new.		dialogBox withButtonsForYes: false no: false okay: true cancel: false.		dialogBox title: '!!'.		dialogBox message: 'Infrared receiving sensor and I2C devices (gyro sensor, acceleration sensor, color sensors) can not be used together.'.		dialogBox openInWorld.		" Display Dialogbox "		dialogBox centerOnScreen.	" Set center position "		dialogBox world doOneCycle.	].	(msgID = '31') ifTrue: [		dialogBox _ DialogBoxMorph new.		dialogBox withButtonsForYes: false no: false okay: true cancel: false.		dialogBox title: '!!'.		dialogBox message: 'That value is already in define.'.		dialogBox openInWorld.		" Display Dialogbox "		dialogBox centerOnScreen.	" Set center position "		dialogBox world doOneCycle.	].	(msgID = '32') ifTrue: [		dialogBox _ DialogBoxMorph new.		dialogBox withButtonsForYes: false no: false okay: true cancel: false.		dialogBox title: 'Could not access to Studuino'.		dialogBox message: 'There is no reply from Studuino.Reconnect Studuino to PC, reset Studuino, and execute a  same command.'.		dialogBox openInWorld.		" Display Dialogbox "		dialogBox centerOnScreen.	" Set center position "		dialogBox world doOneCycle.	].	(msgID = '33') ifTrue: [		dialogBox _ DialogBoxMorph new.		dialogBox withButtonsForYes: false no: false okay: true cancel: false.		dialogBox title: 'Could not access to Studuino'.		dialogBox message: 'Maybe Studuino and PC are not connecting.Finish this mode, reconnect Studuino and PC,reset Studuino, and retry.'.		dialogBox openInWorld.		" Display Dialogbox "		dialogBox centerOnScreen.	" Set center position "		dialogBox world doOneCycle.	].! !!ScratchLibraryMorph methodsFor: 'initialization' stamp: 'KK 1/10/2013 17:18'!buildPanes	"Build my scroll pane."	| bin |	stagePane _ Morph new		color: Color transparent;		position: self position + (7@0).	bin _ ScratchSpriteLibraryMorph new		color: Color transparent;		borderWidth: 0.	scrollPane _ ScrollFrameMorph2 new		color: Color transparent;		contents: bin;		showHorizontalScrollbar: false.	spritePane _ Morph new		color: Color gray;		position: self position.	spriteLabel _ self buildSpriteLabel.	buttonPane _ self makeNewSpriteButtons: (self ownerThatIsA: ScratchFrameMorph).	self addMorph: spritePane.	self addMorph: spriteLabel.	self addMorph: buttonPane.	self addMorph: scrollPane."	self addMorph: stagePane."! !!ScratchLibraryMorph methodsFor: 'initialization' stamp: 'KK 1/11/2013 09:50'!clearLibrary	"Remove all library items. My step method will re-add items for existing objects."	| sFrame |	stagePane removeAllMorphs.	scrollPane contents removeAllMorphs.	scrollPane vScrollRelative: 0.	spriteLabel delete.	spriteLabel _ self buildSpriteLabel.	sFrame _ self ownerThatIsA: ScratchFrameMorph.	(sFrame isNil or:	 [sFrame viewMode = #normal]) ifTrue: [		self addMorph: spriteLabel]."	buttonPane delete.	buttonPane _ self makeNewSpriteButtons: sFrame.	self addMorph: buttonPane."	topSectionHeight _ ((spriteLabel height + 10) max: 40).	self fixLayout.! !!ScratchLibraryMorph methodsFor: 'initialization' stamp: 'KK 1/10/2013 16:53'!makeNewSpriteButtons: aScratchFrameMorph	"Return a morph containing a set of new sprite buttons."	| panel buttonSpecs buttons button butonExtent x |	panel _ Morph new color: Color transparent.	buttonSpecs _ #(		"	icon name				selector					tooltip"		(newSpritePaint			paintSpriteMorph		'Paint new sprite')		(newSpriteLibrary		addSpriteMorph			'Choose new sprite from file')		(newSpriteSurprise 		surpriseSpriteMorph		'Get surprise sprite')	).	buttons _ buttonSpecs collect: [:spec |		button _ ToggleButton new			onForm: (ScratchFrameMorph skinAt: (spec at: 1))			offForm: (ScratchFrameMorph skinAt: (spec at: 1)).		button			target: aScratchFrameMorph;			actionSelector: (spec at: 2);			setProperty: #balloonText toValue: (spec at: 3) localized.		button].	butonExtent _ ScratchFrameMorph isXO ifTrue: [37@27] ifFalse: [37@27].	x _ 0.	buttons do: [:b |		b extent: butonExtent.		panel addMorph: (b position: x@1).		x _ x + 5 + b width].	panel extent: x@(butonExtent y + 1).	^ panel! !!ScratchMenuTitleMorph methodsFor: 'event handling' stamp: 'KK 9/10/2013 15:39'!handlesMouseDown: evt	MenuEnable ifTrue: [ ^ true ]	ifFalse:	[ ^ false ].! !!ScratchMenuTitleMorph methodsFor: 'event handling' stamp: 'KK 9/6/2013 11:03'!handlesMouseOver: evt	MenuEnable ifTrue: [ ^ true ]	ifFalse:	[ ^ false ].! !!ScratchMenuTitleMorph methodsFor: 'event handling' stamp: 'KK 9/6/2013 10:55'!mouseDown: evt	target isNil | selector isNil ifTrue: [^ self].	Cursor normal show.	MenuBarIsActive _ true.	target perform: selector with: self.  "invoke my menu"! !!ScratchMenuTitleMorph class methodsFor: 'as yet unclassified' stamp: 'KK 9/6/2013 10:45'!setMenuEnable:flag	MenuEnable _ flag.! !!ScratchNoteSelector methodsFor: 'initialization' stamp: 'sk 4/24/2017 09:52'!setUpNoteDisplay: aSize	| height rectMorph |	height _ aSize within:aSize and: 40.	"set up the rect morph which holds the note text"	rectMorph _ BorderedMorph new		color: Color white;		position: self bottomLeft - (0@2);		extent: (self width @ height).	self extent: self fullBounds extent.	self addMorph: rectMorph.	labelMorph _ StringMorph new.	labelMorph font: (ScratchFrameMorph getFont: #Label).	labelMorph position: rectMorph position + (0@4).	rectMorph addMorph: labelMorph.	self extent: self fullBounds extent.	self updateNoteDisplay: 60.! !!ScratchNoteSelector methodsFor: 'interaction' stamp: 'sk 3/15/2017 13:11'!startUp	"Waits for the user to click a value or to click outside, then returns the selected note or nil."	| w result |	self openInWorld.	w _ self world.	"Sensor waitNoButton."  "start with mouse up"	16 timesRepeat: [w doOneCycle].	"25ms x 16 = 400ms wait"	w activeHand newMouseFocus: self.	selectedVal _ nil.	done _ false.	[done] whileFalse: [		(w activeHand hasMouseFocus: self) ifFalse: [done _ true].		w doOneCycle].	result _ selectedVal.	self shutDown.	^ result! !!ScratchNoteSelector methodsFor: 'private' stamp: 'sk 3/21/2017 13:38'!updateNoteDisplay: noteNum	| s |	s _ #('C' 'C#' 'D' 'Eb' 'E' 'F' 'F#' 'G' 'G#' 'A' 'Bb' 'B') at: ((noteNum rem: 12) + 1).	labelMorph		contents: s, ' (' , noteNum asString, ')';		font: (StrikeFont fontName: 'VerdanaBold' size: 16);		centerInOwner.! !!ScratchPlugin class methodsFor: 'translation' stamp: 'KK 8/27/2013 19:29'!writePort: portNum data: buffer	"Write data from the given ByteArray or String to the given port and answer the number of bytes written."	"self writePort: 1 into: (ByteArray new: 10)"	<primitive: 'primWrite' module: 'ScratchPlugin'>	^ 0! !!ScratchPresenterMorph methodsFor: 'button actions' stamp: 'KK 9/5/2017 12:39'!shoutGo	frame ifNotNil: [frame shoutGo].	flagButton on.	World displayWorldSafely.  "force button flash"	Delay waitMSecs: 20.! !!ScratchProcess methodsFor: 'entry points' stamp: 'KK 9/6/2017 12:59'!stop	| |	"Permanently terminates this process."	stackFrame ifNotNil: [stackFrame stopMIDI; stopMotors; stopTalkThinkAsk].	readyToYield _ true.	readyToTerminate _ true.	topBlock ifNotNil: [topBlock scratchProc: nil].! !!ScratchProcess methodsFor: 'private-evaluation' stamp: 'KK 5/1/2014 17:08'!applyTimedCommand	"Applies the current command to the already evaluated list of arguments over a particular time interval."	| block arguments currentTime startTime args totalMSecs elapsedMSecs |	block _ stackFrame expression.	arguments _ stackFrame arguments.	"Do we still need to evaluate more arguments?"	arguments size < block argumentCount ifTrue: [^ self evaluateNextArgument].	arguments _ block coerceArgs: arguments.	"Record or get the time when command was first invoked."	currentTime _ Time millisecondClockValue.	startTime _ stackFrame startTime.	startTime ifNil: [  "first call; just set starting time and value"		args _ arguments asArray, (Array with: 0 with: nil).		stackFrame startValue: (block receiver perform: block selector withArguments: args).		stackFrame startTime: currentTime.		readyToYield _ true.		^ self].	"Call primitive time command with its arguments and the elapsed time in seconds"	totalMSecs _ arguments last * 1000.	block selector = #glideSecs:toX:y:elapsed:from: ifTrue: [totalMSecs _ arguments first * 1000].	block selector = #mwait:elapsed:from: ifTrue: [totalMSecs _ arguments last].	((block selector = #drum:duration:elapsed:from:) or:	 [block selector = #noteOn:duration:elapsed:from:])		ifTrue: [totalMSecs _ (60000 * arguments second) / block receiver tempo].	block selector = #rest:elapsed:from:		ifTrue: [totalMSecs _ (60000 * arguments first) / block receiver tempo].	elapsedMSecs _ currentTime - startTime.	currentTime < startTime ifTrue: [elapsedMSecs _ totalMSecs].  "clock wrap"	args _ arguments asArray, (Array with: elapsedMSecs with: stackFrame startValue).	block receiver perform: block selector withArguments: args.	"If not done, then we leave stack as is and yield."	elapsedMSecs < totalMSecs ifTrue: [		readyToYield _ true.		^ self].	"Pop this command off the stack and return."	self popStackFrame.! !!ScratchProcess methodsFor: 'private-evaluation' stamp: 'KK 5/1/2014 17:08'!evaluateCommandFor: aStageMorph	"Evaluates the current block. If the argument is non-nil, redraw the stage."	| expression |	expression _ stackFrame expression.	BlockHighlightMSecs > 1 ifTrue: [expression litUp: true].	expression isSpecialForm ifTrue: [^ self evaluateSpecialForm].	"evaluate arguments, if necessary"	stackFrame arguments size < expression argumentCount		ifTrue: [^ self evaluateNextArgument].	expression isTimed ifTrue: [^ self applyTimedCommand].	self applyPrimitive.	aStageMorph ifNotNil: [		aStageMorph updateTrailsForm.		BlockHighlightMSecs = 1 ifTrue: [  "normal (non-turbo) mode; redraw after each cmd"			World displayWorldSafely]].! !!ScratchProcess methodsFor: 'private-evaluation' stamp: 'KK 4/28/2014 10:47'!evaluateSpecialForm	"Evaluates the current special form expression.  Requires that no arguments have been evaluated, and that the current expression be a special form."	self perform: stackFrame expression selector.! !!ScratchProcess methodsFor: 'private-special forms' stamp: 'KK 9/5/2017 14:33'!doRepeat	"Handles one iteration of a repeat block."	| arguments argExp block counter frame |	block _ stackFrame expression.	arguments _ stackFrame arguments.	"If we haven't done so yet, evaluate the argument to repeat."	arguments size < 1		ifTrue:	[argExp _ block argumentAt: 1.				^self pushStackFrame: (ScratchStackFrame new expression: argExp)].	"If the number of times to repeat is 0, then we're done."	counter _ arguments first asNumberNoError.	counter <= 0 ifTrue:	[^ self popStackFrame].	"Pop this instruction from the stack."	self popStackFrameNoUnhightlight.	"At top of stack should now be:		1.  evaluate body of repeat block.		2.  yield.		3.  evaluate repeat block with decremented counter value.	Need to add these to the stack in reverse order."	"3.  evaluate repeat block with decremented counter value."	frame _ ScratchStackFrame new				expression:		block;				addArgument:	counter - 1.	self pushStackFrame: frame.	"2.  yield."	self pushStackFrame: (ScratchStackFrame new shouldYield: true).	"1.  evaluate body of repeat block."	self pushStackFrame: (ScratchStackFrame new expression: block firstBlockList).! !!ScratchProcess methodsFor: 'private-special forms' stamp: 'KK 8/20/2014 10:58'!doSvmSyncMotion	"Handles one iteration of a repeat block."	| arguments argExp block frame delay expr blockLabelSpec argPermutation defaultArgs maxDelta d1 d2 |	block _ stackFrame expression.	arguments _ stackFrame arguments.	"If we haven't done so yet, evaluate the argument to repeat."	arguments  size < 1		ifTrue:	[argExp _ block argumentAt: 1.				^self pushStackFrame: (ScratchStackFrame new expression: argExp)].	"If the number of times to repeat is 0, then we're done."	" Notify syncro motion start to the board. "	delay _ arguments first asNumberNoError.	(delay <= 0) & (ServomotorSynchroMotion) ifTrue:	[		block evaluateWithArgs: -1.		self popStackFrame.		" Make dummy wait block and push stack frame. "		blockLabelSpec _ ScratchTranslator translationFor: ('wait %n secs').		argPermutation _ CommandBlockMorph argPermutationForSpec: ('wait %n secs') withTranslation: blockLabelSpec.		defaultArgs _ Array with:3.		expr _ CommandBlockMorph new.		expr isTimed: true.		expr		argPermutation: argPermutation;		selector: #mwait:elapsed:from:;		commandSpec: blockLabelSpec;		defaultArgs: defaultArgs;		receiver: block receiver.		maxDelta _ 0.		1 to: (SvDegree size) do: [ : i |			d1 _ SvDegree at:i.			d2 _ SvDegreeTemp at:i.			(((d1 - d2) abs) > maxDelta) ifTrue: [				maxDelta _ ((d1 - d2) abs).			].			SvDegree at:i put:d2.		].		frame _ ScratchStackFrame new					expression:		expr;					addArgument:	(maxDelta * (DelayMsecPerDeg+1)) asNumber.		^ self pushStackFrame: frame.	].	block evaluateWithArgs: delay.	"Pop this instruction from the stack."	self popStackFrameNoUnhightlight.	"At top of stack should now be:		1.  evaluate body of repeat block.		2.  yield.		3.  evaluate repeat block with decremented counter value.	Need to add these to the stack in reverse order."	"3.  evaluate repeat block with decremented counter value."	frame _ ScratchStackFrame new				expression:		block;				addArgument:	-1.	self pushStackFrame: frame.	"2.  yield."	self pushStackFrame: (ScratchStackFrame new shouldYield: true).	"1.  evaluate body of repeat block."	self pushStackFrame: (ScratchStackFrame new expression: block firstBlockList).! !!ScratchProcess methodsFor: 'private-special forms' stamp: 'KK 9/6/2017 12:23'!doSvmSyncMotion2	"Handles one iteration of a repeat block."	| arguments argExp block frame delay maxDelta d1 d2 sb syncStat isPush svms |	block _ stackFrame expression.	arguments _ stackFrame arguments.	"If we haven't done so yet, evaluate the argument to repeat."	arguments  size < 1		ifTrue:	[argExp _ block argumentAt: 1.				^self pushStackFrame: (ScratchStackFrame new expression: argExp)].	"If the number of times to repeat is 0, then we're done."	" Notify syncro motion start to the board. "	delay _ arguments first asNumberNoError.	"Pop this instruction from the stack."	self popStackFrameNoUnhightlight.	sb _ (block receiver ownerThatIsA: ScratchStageMorph) sensorBoard.	sb lockSync critical: [		"3.  evaluate repeat block with decremented counter value."		syncStat _ sb isOnSyncServo.		syncStat ifTrue: [	" Stack block "			" Push servomotor syncro block to FIFO. "			sb pushSvmFifo: block.			" Push self to Scratch Stack. "			frame _ ScratchStackFrame new						expression:		block.			frame addArgument: delay.			self pushStackFrame: frame.		]		ifFalse: [	" Execute or Stack block "			((sb checkSvmFifo) = block) | ((sb checkSvmFifo) = nil) ifTrue: [	" Execute block "				"Transcript show:'>>>  run:';show:block;show:' ';show:delay;cr."				sb startSyncServo.	" Set status during servomotors moving. "				" Send servomotors synchronous start message. "				block evaluateWithArgs: (20-delay).				" Send servomotor's degress. "				svms _ block firstBlockList.				svms do: [: svm|					svm evaluateWithArgs: svm args.					BlockHighlightMSecs > 1 ifTrue: [svm litUp: true].					BlockHighlightMSecs > 1 ifTrue: [svm litUp: false].				].				" Send servomotors synchronous end message. "				block evaluateWithArgs: -1.				" Make dummy wait block and push stack frame. "				maxDelta _ 0.				1 to: (SvDegree size) do: [ : i |					d1 _ SvDegree at:i.					d2 _ SvDegreeTemp at:i.					(((d1 - d2) abs) > maxDelta) ifTrue: [maxDelta _ ((d1 - d2) abs).].					SvDegree at:i put:d2.				].				frame _ self makeNewWaitBlock: ((maxDelta * (DelayMsecPerDeg+1)) asNumber) receiver: block receiver.				self pushStackFrame: frame.				sb popSvmFifo.				PrevBlock _ nil.			]			ifFalse: [	" Stack block "				isPush _ sb pushSvmFifo: block.		" Try push block to FIFO "				(isPush) ifFalse: [	" block exist already "					PrevBlock ifNil: [ " First time "						PrevBlock _ block.					] ifNotNil: [						(PrevBlock = block) ifTrue: [		" lap, so pop from FIFO. "							"Transcript show:'Not exist in FIFO';cr."							sb popSvmFifo. 							PrevBlock _ nil.].					].				].				" Push self to Scratch Stack. "				frame _ ScratchStackFrame new						expression:		block.				frame addArgument: delay.				self pushStackFrame: frame.			]		].		"yield."		self pushStackFrame: (ScratchStackFrame new shouldYield: true).	].! !!ScratchProcess methodsFor: 'private-special forms' stamp: 'KK 9/6/2017 11:13'!makeNewWaitBlock: delay	| blockLabelSpec argPermutation defaultArgs expr block frame |	" Make dummy wait block. "	blockLabelSpec _ ScratchTranslator translationFor: ('wait %n secs').	argPermutation _ CommandBlockMorph argPermutationForSpec: ('wait %n secs') withTranslation: blockLabelSpec.	defaultArgs _ Array with:3.	expr _ CommandBlockMorph new.	expr isTimed: true.	expr	argPermutation: argPermutation;	selector: #mwait:elapsed:from:;	commandSpec: blockLabelSpec;	defaultArgs: defaultArgs;	receiver: block receiver.	frame _ ScratchStackFrame new				expression:		expr;				addArgument:	delay.	^ frame.! !!ScratchProcess methodsFor: 'private-special forms' stamp: 'KK 9/6/2017 11:16'!makeNewWaitBlock: delay receiver: recv	| blockLabelSpec argPermutation defaultArgs expr frame |	" Make dummy wait block. "	blockLabelSpec _ ScratchTranslator translationFor: ('wait %n secs').	argPermutation _ CommandBlockMorph argPermutationForSpec: ('wait %n secs') withTranslation: blockLabelSpec.	defaultArgs _ Array with:3.	expr _ CommandBlockMorph new.	expr isTimed: true.	expr		argPermutation: argPermutation;		selector: #mwait:elapsed:from:;		commandSpec: blockLabelSpec;		defaultArgs: defaultArgs;		receiver: recv.	frame _ ScratchStackFrame new				expression:		expr;				addArgument:	delay.	^ frame.! !!ScratchScriptEditorMorph methodsFor: 'initialization' stamp: 'KK 4/17/2014 15:31'!addNameBox	nameMorph _ UpdatingStringFieldMorph new		font: (ScratchFrameMorph getFont: #UpdatingStringField);		rightJustify: ScratchTranslator isRTL;		acceptWhenFocusLost: true;		position: thumbnailMorph topRight + (17@(thumbnailMorph height * 0.12))."	self addMorphBack: nameMorph."! !!ScratchScriptEditorMorph methodsFor: 'initialization' stamp: 'ee 12/5/2008 22:59'!createTabPane	| tabOnForm tabOffForm tabID tabLabel |	"create tab pane"	tabPaneMorph _ ScratchTabPaneMorph new.	tabPaneMorph		borderWidth: 0;		color: Color transparent;		targetPane: self.	tabOnForm _ (ScratchFrameMorph skinAt: #tabOn).	tabOffForm _ (ScratchFrameMorph skinAt: #tabOff).	"add the tabs"	#(Scripts Costumes Sounds) do: [:spec |		tabID _ spec asString.		tabLabel _ tabID localized.		tabPaneMorph			createTab: tabID			withLabel: tabLabel			onForm: tabOnForm			offForm: tabOffForm].	"set current tab and add to frame"	tabPaneMorph currentTab: 'Scripts'.	self addMorph: tabPaneMorph.! !!ScratchScriptEditorMorph methodsFor: 'initialization' stamp: 'KK 4/18/2014 12:38'!initialize	super initialize.	self		initFrontFromForm2: (ScratchFrameMorph skinAt: #scriptPaneFrameTransparent2)		topSectionHeight: 0.	self color: (Color r: (149/255) g: (154/255) b: (159/255)).	thumbnailMorph _ ScratchThumbnailMorph new."	self addMorph: (thumbnailMorph position: self position + (37@16))."	self addNameBox.	pageViewerMorph _ ScrollFrameMorph2 new		growthFraction: 0.1;		color: ScratchFrameMorph scriptsPaneColor.	self addMorph: (pageViewerMorph position: (self left @ (self top + topSectionHeight))).	rotationButtons _ #().	readoutMorphs _ #().	self target: nil.	thumbnailMorph extent: 50@50.	self extent: 300@400.	self createTabPane.! !!ScratchScriptEditorMorph methodsFor: 'accessing' stamp: 'jm 4/9/2009 10:09'!bareMinimumWidth	"Answer the bare minimum width for this pane to be useable."	lockButton ifNil: [^ 100].	^ lockButton right - self left! !!ScratchScriptEditorMorph methodsFor: 'accessing' stamp: 'jm 2/28/2005 17:07'!categoryChanged: aString	"If the given category is my current category, update my contents. Otherwise, do nothing."	self target ifNil: [^ self].	currentCategory = aString ifTrue: [self currentCategory: aString].! !!ScratchScriptEditorMorph methodsFor: 'accessing' stamp: 'jm 2/28/2005 14:29'!currentCategory	^ currentCategory! !!ScratchScriptEditorMorph methodsFor: 'accessing' stamp: 'jm 4/23/2008 12:43'!currentCategory: aString	| xOffset |	currentCategory _ aString.	self target ifNil: [^ self].	xOffset _ 0.	World activeHand newKeyboardFocus: nil.	currentCategory = 'Scripts' ifTrue: [		pageViewerMorph contents: self target blocksBin].	currentCategory = 'Costumes' ifTrue: [		pageViewerMorph contents: (self target costumesPage: xOffset)].	currentCategory = 'Sounds' ifTrue: [		pageViewerMorph contents: (self target soundsPage: xOffset)].	pageViewerMorph contents color: ScratchFrameMorph scriptsPaneColor.	self world ifNotNil: [self world startSteppingSubmorphsOf: pageViewerMorph contents].! !!ScratchScriptEditorMorph methodsFor: 'accessing' stamp: 'ee 8/11/2008 13:48'!getTabTop	"Used by ScratchFrameMorph when creating the tab pane. This returns the y position of where the top of the tabs should align. This situation is unfortunate (tabs should probaby be part of ScratchScriptEditorMorph), but we'll fix it later."	ScratchFrameMorph isXO ifTrue: [^ thumbnailMorph bottom + 20].	(readoutMorphs size > 0)		ifTrue: [^ (readoutMorphs at: 1) bottom + 6]		ifFalse: [^ nameMorph bottom + 5 + (ScratchTranslator stringExtent: '0' font: (ScratchFrameMorph getFont: #XYReadoutBold)) y + 6].! !!ScratchScriptEditorMorph methodsFor: 'accessing' stamp: 'ee 11/4/2008 11:44'!tabPane	^ tabPaneMorph! !!ScratchScriptEditorMorph methodsFor: 'accessing' stamp: 'ee 7/1/2003 12:58'!target	^ nameMorph target! !!ScratchScriptEditorMorph methodsFor: 'accessing' stamp: 'jm 7/2/2008 14:55'!target: aScratchObjectOrNil	"Start viewing the given object or no object."	| sFrame nameSel |	World activeHand newKeyboardFocus: nil.	(aScratchObjectOrNil isNil or:	 [aScratchObjectOrNil isScriptable not]) ifTrue: [		thumbnailMorph target: nil.		nameMorph target: nil; contents: 'no object '.		pageViewerMorph contents: (Morph new color: Color red).		(sFrame _ self ownerThatIsA: ScratchFrameMorph) ifNotNil: [			sFrame viewerPane target: nil].		self showOrHideReadouts.		^ self].	thumbnailMorph target: aScratchObjectOrNil.	nameSel _ (aScratchObjectOrNil isKindOf: ScratchStageMorph)		ifTrue: [nil]		ifFalse: [#objName:].	nameMorph		target: aScratchObjectOrNil;		getSelector: #objName;		putSelector: nameSel.	self showOrHideReadouts.	self fixLayout.! !!ScratchScriptEditorMorph methodsFor: 'drawing' stamp: 'ee 1/29/2009 10:12'!drawBackgroundOn: aCanvas	"Draw my background."	color isTransparent ifTrue: [^ self].	aCanvas		fillRectangle: (self topLeft corner: pageViewerMorph topRight)		color: color.! !!ScratchScriptEditorMorph methodsFor: 'drawing' stamp: 'ee 1/29/2009 10:35'!drawSubmorphsOn: aCanvas	"Display submorphs back to front."	submorphs reverseDo: [:m |		(m = tabPaneMorph) ifFalse: [aCanvas fullDrawMorph: m]].! !!ScratchScriptEditorMorph methodsFor: 'drawing' stamp: 'ee 1/29/2009 10:35'!fullDrawOn: aCanvas	"Draw my frame in front of my submorphs."	| clipC |	self isHidden ifTrue: [^ self].	(self hasProperty: #errorOnDraw) ifTrue:[^ self drawErrorOn: aCanvas].	(aCanvas isVisible: self fullBounds) ifFalse: [^ self].	"myBox has integer position and extent and has a potentially inset bottom"	myBox _ bounds truncated.	clipC _ aCanvas copyClipRect: myBox.	frameInFront		ifTrue: [			self drawOn: clipC.			self drawSubmorphsOn: clipC.			self drawFrameOn: clipC.			aCanvas fullDrawMorph: tabPaneMorph]		ifFalse: [			self drawOn: clipC.			self drawSubmorphsOn: clipC].! !!ScratchScriptEditorMorph methodsFor: 'event handling' stamp: 'ee 2/3/2009 13:28'!handlesMouseOverDragging: evt	| m |	evt hand submorphs size = 1 ifFalse: [^ false].	m _ evt hand firstSubmorph.	^ m isKindOf: BlockMorph.! !!ScratchScriptEditorMorph methodsFor: 'event handling' stamp: 'ee 2/8/2009 17:02'!mouseEnterDragging: evt	"Switch the tabs to script if a block is current being dragged"	(currentCategory = 'Scripts') ifFalse:[		self currentCategory: 'Scripts'.		tabPaneMorph currentTab: 'Scripts'].! !!ScratchScriptEditorMorph methodsFor: 'geometry' stamp: 'jm 10/28/2008 13:13'!extent: aPoint	super extent: aPoint.	pageViewerMorph ifNotNil: [		pageViewerMorph extent: self extent - (pageViewerMorph position - self position)].! !!ScratchScriptEditorMorph methodsFor: 'geometry' stamp: 'KK 4/17/2014 16:47'!fixLayout	| y x |	"layout readout morphs vertically"	y _ nameMorph bottom + 5.	readoutMorphs do: [:m |		m position: m left@y].	"layout readout and name morphs horizontally"	nameMorph position: (thumbnailMorph topRight + (17@(thumbnailMorph height * 0.12))).	x _ nameMorph left.	readoutMorphs do: [:m |		m position: x@m top.		x _ m right + 5].	"layout lock and pen morphs"	lockButton ifNotNil: [		lockButton position: (nameMorph right + 4)@(nameMorph top + ((nameMorph height - lockButton height) / 2)).		penReadout position: (lockButton right + 4)@(nameMorph top + ((nameMorph height - penReadout height) / 2))].	"place tab morph"	(readoutMorphs size > 1) ifTrue: [		topSectionHeight _ (readoutMorphs at: 1) bottom - self top + tabPaneMorph height + 5].	tabPaneMorph		width: self width;		position: (self left + 15) @ (self top + topSectionHeight - tabPaneMorph height + 1).	" Hide tab "	tabPaneMorph height: 0; width:0.	"place scripts scroll pane"	pageViewerMorph position: (self left @ (self top + topSectionHeight)).	self extent: self extent. "force resize of page viewer morph"! !!ScratchScriptEditorMorph methodsFor: 'stepping' stamp: 'ee 4/14/2008 15:01'!step	currentCategory = 'Costumes' ifTrue: [self updateCostumeSelection].	(penReadout isNil or: [penReadout owner ~= self]) ifTrue: [^ self].	self target penDown		ifTrue: [penReadout color: self target penColor]		ifFalse: [penReadout color: Color transparent].! !!ScratchScriptEditorMorph methodsFor: 'stepping' stamp: 'jm 1/5/2006 11:11'!stepTime	^ 50! !!ScratchScriptEditorMorph methodsFor: 'stepping' stamp: 'ee 4/14/2008 15:01'!updateCostumeSelection	"Update the currently selected costume if the costumes tab is selected."	| currentCostume |	currentCategory = 'Costumes' ifFalse: [^ self].	currentCostume _ self target costume.	pageViewerMorph contents submorphsDo: [:m |		((m isKindOf: MediaItemMorph) and:		 [m media isImage]) ifTrue: [			m highlight: (m media = currentCostume)]].! !!ScratchScriptEditorMorph methodsFor: 'menu/button ops' stamp: 'ee 5/14/2008 16:40'!addComment: aPosition	| c scriptsMorph |	scriptsMorph _ (pageViewerMorph allMorphs select: [: m | m isKindOf: ScratchScriptsMorph]) first.	scriptsMorph addMorph: (c _ ScratchCommentMorph new position: aPosition).	World activeHand newKeyboardFocus: c commentMorph.! !!ScratchScriptEditorMorph methodsFor: 'menu/button ops' stamp: 'jm 4/27/2007 16:12'!animateRotationStyle	| style thumbForm wasFlipped currentRotation pen center rotatedForm doFlip |	style _ self target rotationStyle.	thumbnailMorph updateThumbnail.	thumbForm _ thumbnailMorph form deepCopy.	currentRotation _ self target rotationDegrees rounded.	wasFlipped _ ((currentRotation \\ 360) >= 90) & ((currentRotation \\ 360) <= 270).	thumbnailMorph showDirection: false.	pen _ (Pen newOnForm: thumbnailMorph form) color: Color white.	center _ thumbnailMorph form center.	currentRotation to: currentRotation + 360 by: 12 do: [:i |		rotatedForm _ thumbForm.  "no rotation by default"		style = #normal ifTrue: [rotatedForm _ thumbForm rotateBy: i].		style = #leftRight ifTrue: [			doFlip _ ((i \\ 360) >= 90) & ((i \\ 360) <= 270).			wasFlipped ifTrue: [doFlip _ doFlip not].			doFlip ifTrue: [rotatedForm _ thumbForm flipBy: #horizontal centerAt: 0@0]].		thumbnailMorph form fill: thumbnailMorph form boundingBox fillColor: Color transparent.		rotatedForm			displayOn: thumbnailMorph form			at: (thumbnailMorph extent - rotatedForm extent) // 2			rule: Form paint.		pen place: center.		pen goto: center + (Point r: 22 degrees: i).		thumbnailMorph changed.		World displayWorldSafely.		Delay waitMSecs: 20].	thumbnailMorph showDirection: true.	thumbnailMorph updateThumbnail.! !!ScratchScriptEditorMorph methodsFor: 'menu/button ops' stamp: 'ee 11/5/2007 11:50'!cleanUp	"Align all scripts vertically in alphabetical order"	| scriptsMorph |	scriptsMorph _ (pageViewerMorph allMorphs select: [:c | c isKindOf: ScratchScriptsMorph]) first.	scriptsMorph cleanUp.	pageViewerMorph		updateContentsExtent;		updateScrollbars.! !!ScratchScriptEditorMorph methodsFor: 'menu/button ops' stamp: 'ee 2/12/2009 16:23'!deleteSprite	"Ask the user if they want to delete the currently selected sprite"	| response |	response _ DialogBoxMorph askWithCancel: 'Delete this sprite?' localized.	response = #cancelled ifTrue: [^ self].	response ifTrue: [thumbnailMorph target undoableDeleteSprite].! !!ScratchScriptEditorMorph methodsFor: 'menu/button ops' stamp: 'jens 3/9/2009 13:19'!saveScriptsToImage	"Take a snapshot of all scripts for a sprite and save as a GIF file"	| fName saveForm |	saveForm _ pageViewerMorph contents screenshot.	fName _ ScratchFileChooserDialog		chooseNewFileDefault: ''		title: 'Save Scripts Snapshot'		type: #scriptsSnapshot.	fName = #cancelled ifTrue: [^ self].	fName size = 0 ifTrue: [^ self].	(fName asLowercase endsWith: '.gif') ifFalse: [fName _ fName, '.gif'].	saveForm writeGIFFileNamed: fName.! !!ScratchScriptEditorMorph methodsFor: 'menu/button ops' stamp: 'jm 3/2/2009 13:00'!scriptsMenu: aPosition	"Present a menu of Scratch script operations."	| menu choice |	self target ifNil: [^ self].	menu _ CustomMenu new.	menu add: 'clean up' action: #cleanUp.	menu add: 'save picture of scripts' action: #saveScriptsToImage.	menu add: 'add comment' action: #addComment:.	choice _ menu localize startUp.	choice ifNil: [^ self].	choice = #addComment:		ifTrue: [self perform: choice with: aPosition]		ifFalse: [self perform: choice].! !!ScratchScriptEditorMorph methodsFor: 'menu/button ops' stamp: 'jm 4/27/2007 15:52'!setRotationStyle: aSymbol	aSymbol == #Smooth ifTrue: [self target rotationStyle: #normal].	aSymbol == #Flip ifTrue: [self target rotationStyle: #leftRight].	aSymbol == #None ifTrue: [self target rotationStyle: #none].	self updateRotationButtonHighlight.	(self target respondsTo: #rotationDegrees:) ifFalse: [^ self].	self animateRotationStyle.! !!ScratchScriptEditorMorph methodsFor: 'menu/button ops' stamp: 'jm 10/19/2007 11:35'!toggleSpriteDraggable	"Add buttons to set the rotation style."	self target draggable: self target draggable not.	self updateLockButton.! !!ScratchScriptEditorMorph methodsFor: 'private' stamp: 'jm 2/22/2009 21:37'!addDeleteButton	"Add button to delete sprite."	self deleteDeleteButton.	deleteButton _ ToggleButton		onForm: (ScratchFrameMorph skinAt: #deleteSprite)		offForm: (ScratchFrameMorph skinAt: #deleteSprite)		overForm: (ScratchFrameMorph skinAt: #deleteSprite).	deleteButton		target: self;		actionSelector: #deleteSprite;		setBalloonText: 'Delete this sprite' localized;		actWhen: #buttonUp;		isMomentary: true;		position: (lockButton right + 27)@(nameMorph top + ((nameMorph height - deleteButton height) / 2)).	self addMorph: deleteButton.! !!ScratchScriptEditorMorph methodsFor: 'private' stamp: 'ee 2/11/2009 14:13'!addLockButton	"Add button to set sprite locked status."	self deleteLockButton.	lockButton _ ToggleButton		onForm: (ScratchFrameMorph skinAt: #locked)		offForm: (ScratchFrameMorph skinAt: #unlocked).	lockButton		target: self;		actionSelector: #toggleSpriteDraggable;		setBalloonText: 'draggable on website?' localized;		actWhen: #buttonUp;		isMomentary: true;		position: (nameMorph right + 4)@(nameMorph top + ((nameMorph height - lockButton height) / 2)).	self addMorph: lockButton.	self updateLockButton.! !!ScratchScriptEditorMorph methodsFor: 'private' stamp: 'ee 2/20/2009 13:14'!addReadouts	"Add readouts for my target's position and direction."	| x y label readout s |	self deleteReadouts.	readoutMorphs _ OrderedCollection new.	x _ nameMorph left.	y _ nameMorph bottom + 5.	#(('x' xpos) ('y' ypos)('direction' heading)) do: [:spec |		(ScratchTranslator isRTL and: [(spec at: 1) = 'x' or: [(spec at: 1) = 'y']])			ifTrue: [s _ (':', spec first) asUTF8]			ifFalse: [s _ (spec first localized, ScratchTranslator colonSuffix)].		label _ StringMorph new			contents: s;			font: (ScratchFrameMorph getFont: #XYReadout);			position: x@y.		readout _ (UpdatingStringMorph on: self target selector: spec second)			font: (ScratchFrameMorph getFont: #XYReadoutBold);			forceUnicodeRendering: true;			color: (Color gray: 0.2);			contents: '-000';  "this sets the readout size"			growable: false;			stepTime: 100;			position: (label right + 4)@y.		ScratchTranslator isRTL ifTrue:[			readout rightJustify: true].		self addMorph: label; addMorph: readout.		readoutMorphs add: label; add: readout.		readout startStepping.		x _ readout right + 2].	ScratchTranslator isRTL ifTrue: [		readoutMorphs reversed do: [: m |			readoutMorphs remove: m.			readoutMorphs add: m]].	penReadout _ Morph new extent: 15@5.	penReadout position: (lockButton right + 4)@(nameMorph top + ((nameMorph height - penReadout height) / 2));		color: Color transparent.	self addMorph: penReadout.	readoutMorphs add: penReadout.	penReadout startStepping.	readoutMorphs _ readoutMorphs asArray.! !!ScratchScriptEditorMorph methodsFor: 'private' stamp: 'jm 3/21/2008 14:02'!addRotationButtons	"Add buttons to set the rotation style."	| specs x y style button |	self deleteRotationButtons.	(self target respondsTo: #rotationStyle:) ifFalse: [^ self].	specs _ #(		(Smooth		'can rotate')		(Flip		'only face left-right')		(None		'don''t rotate')).	x _ self left + 13.	y _ self top + 18.	specs do: [:pair |		style _ pair first.		button _ ToggleButton			onForm: (ScratchFrameMorph skinAt: ('rotStyle', style, 'On'))			offForm: (ScratchFrameMorph skinAt: ('rotStyle', style))			overForm: (ScratchFrameMorph skinAt: ('rotStyle', style, 'Over')).		button			target: self;			arguments: (Array with: style);			actionSelector: #setRotationStyle:;			setBalloonText: pair second localized;			actWhen: #buttonDown;			position: x@y.		self addMorph: button.		rotationButtons _ rotationButtons copyWith: button.		y _ y + button height + 2].	self updateRotationButtonHighlight.! !!ScratchScriptEditorMorph methodsFor: 'private' stamp: 'ee 2/12/2009 10:49'!deleteDeleteButton	"Delete my delete button."	deleteButton ifNotNil: [		deleteButton delete.		deleteButton _ nil].! !!ScratchScriptEditorMorph methodsFor: 'private' stamp: 'jm 10/3/2007 16:42'!deleteLockButton	"Delete my lock button."	lockButton ifNotNil: [		lockButton delete.		lockButton _ nil].! !!ScratchScriptEditorMorph methodsFor: 'private' stamp: 'jm 2/28/2005 17:46'!deleteReadouts	"Delete the position/rotation readouts."	readoutMorphs do: [:m | m delete].	readoutMorphs _ #().! !!ScratchScriptEditorMorph methodsFor: 'private' stamp: 'jm 2/28/2005 17:40'!deleteRotationButtons	"Delete the rotation style buttons."	rotationButtons do: [:m | m delete].	rotationButtons _ #().! !!ScratchScriptEditorMorph methodsFor: 'private' stamp: 'jm 7/3/2008 18:22'!showOrHideReadouts	"If this is a sprite, show the position and direction readouts and the rotation style buttons. Otherwise, hide them."	self deleteRotationButtons; deleteLockButton; deleteReadouts.	nameMorph		font: nameMorph font;		width: nameMorph height * 4;		rightJustify: ScratchTranslator isRTL.	(self target isKindOf: ScratchSpriteMorph) ifTrue: [		self addRotationButtons; addLockButton; addReadouts.		World ifNotNil: [World startSteppingSubmorphsOf: self]].! !!ScratchScriptEditorMorph methodsFor: 'private' stamp: 'jm 10/23/2007 15:24'!updateLockButton	lockButton ifNil: [^ self].	self target draggable		ifTrue: [lockButton off]		ifFalse: [lockButton on].! !!ScratchScriptEditorMorph methodsFor: 'private' stamp: 'jm 2/28/2005 17:33'!updateRotationButtonHighlight	"Highlight the appropriate rotation style button. Do nothing if my target is not a sprite."	| style sym |	(self target isKindOf: ScratchSpriteMorph) ifFalse: [^ self].	style _ self target rotationStyle.	style = #normal ifTrue: [sym _ #Smooth].	style = #leftRight ifTrue: [sym _ #Flip].	style = #none ifTrue: [sym _ #None].	rotationButtons do: [:m |		sym = m arguments first ifTrue: [m on] ifFalse: [m off]].! !!ScratchScriptsMorph methodsFor: 'initialization' stamp: 'KK 9/23/2013 18:57'!initialize	super initialize."Transcript show:'[ScratchScriptsMorph::initialize]';cr."	color _ Color white.	borderWidth _ 0.	self enableDragNDrop: true."(ConvertTuplesToStacks = true) ifFalse: [	self addMorphBack: (EventHatMorph new forStartEvent).].ConvertTuplesToStacks _ false."! !!ScratchScriptsMorph methodsFor: 'stepping' stamp: 'KK 4/30/2014 16:14'!step	"Give feedback about possible drop targets."	| feedbackColor h b targetArg targetAssoc targetP targetBlock |	feedbackMorph		ifNil: [feedbackMorph _ BorderedMorph new borderWidth: 3]  "create feedback morph if necessary"		ifNotNil: [feedbackMorph delete].  "remove old feedback"	feedbackColor _ Color white.	feedbackMorph useSquareCorners.	h _ World activeHand.	h toolType = 'CutTool' ifTrue: [^ self showDeleteFeedback].	(self bounds containsPoint: h position) ifFalse: [^ self].	h submorphCount = 1 ifFalse: [^ self].	b _ h firstSubmorph.	(b isKindOf: ScratchCommentMorph) ifTrue: [^ self showCommentDropFeedback].	(b isKindOf: BlockMorph) ifFalse: [^ self]."attempt at auto-scrolling (has some issues, commented out for now):	((self owner bounds containsPoint: h position) and:		[(h position x - self owner left) < 50 or: [			(self owner right - h position x) < 50 or: [				(self owner bottom - h position y) < 50 or: [					(h position y - self owner top) < 50]]]])		ifTrue:[self owner scrollMorphIntoView: h firstSubmorph].xxxxxxxx"	b isReporter ifTrue: [ "reporter block"		(targetArg _ self topArgMorphAt: b bounds exclude: nil) ifNil: [^ self].		(targetArg acceptsTypeOf: b) ifFalse: [^ self].		feedbackMorph			bounds: (targetArg bounds expandBy: 5);			color: (feedbackColor alpha: 0.4);			borderColor: feedbackColor;			useRoundedCorners.		^ self addMorphFront: feedbackMorph].	"non-reporter (i.e. command block or hat block)"	targetAssoc _ b closestAttachTargetIn: self.	targetAssoc ifNil: [		(b bottomBlock isKindOf: CBlockMorph) ifFalse: [			targetAssoc _ b bottomBlock closestAttachTargetIn: self.			targetAssoc ifNotNil:[				(targetAssoc value owner isKindOf: BlockMorph) ifTrue:[					targetAssoc _ nil]]]].	targetAssoc ifNil: [^ self].	targetP _ targetAssoc key.	targetBlock _ targetAssoc value.	feedbackMorph borderColor: feedbackColor; color: feedbackColor.	"subtract the attachment point x from the width so that the feedback in CBlock won't stick out"	ScratchTranslator isRTL		ifTrue: [feedbackMorph extent: (targetP x - targetBlock left)@5.			self addMorphFront: (feedbackMorph position: targetP - (feedbackMorph width@0))]		ifFalse: [feedbackMorph extent: (targetBlock right - targetP x)@5.			self addMorphFront: (feedbackMorph position: targetP)].! !!ScratchScriptsMorph methodsFor: 'event handling' stamp: 'sk 3/15/2017 13:50'!mouseDown: evt	| m |	evt hand newKeyboardFocus: nil.	evt hand toolType ifNotNil: [		"revert to normal cursor"		evt hand toolType: nil.		^ self].	evt rightButtonPressed ifTrue: [		"Sensor waitNoButton."		(m _ self ownerThatIsA: ScratchScriptEditorMorph) ifNil: [^ self].		(m target notNil and: [m currentCategory = 'Scripts'])			ifTrue: [m scriptsMenu: evt hand position].		^ self].	evt hand waitForClicksOrDrag: self event: evt.! !!ScratchServer methodsFor: 'server control' stamp: 'KK 8/20/2013 15:47'!joinSessionAt: ipAddressString	"Add an outgoing connection to the given address. Fail if a connection cannot be made in bounded amount of time. Answer true if the connection was added successfully."	| addr sock ok |	addr _ NetNameResolver addressForName: ipAddressString timeout: 5.	sock _ MessageSocket new.	ok _ sock connectTo: addr port: ScratchServer portNumber waitSecs: 5.	ok ifFalse: [sock destroy. ^ false].	sock sendMessage: 'peer-name ', userName.	peerSockets add: sock.	^ true! !!ScratchServer methodsFor: 'server control' stamp: 'KK 8/20/2013 14:28'!startHosting	"Open a socket on my port and start accepting connections."	Socket initializeNetwork.	self shutdownServer.	serverSocket _ Socket new.	serverSocket listenOn: self class portNumber backlogSize: 20.	incomingUDPSocket _ Socket newUDP setPort: self class portNumber.! !!ScratchServer methodsFor: 'private-server' stamp: 'KK 1/18/2013 09:47'!broadcastMessageFor: aString	"Answer a message to broadcast the given string."	| msg |	msg _ WriteStream on: String new.	msg nextPutAll: 'broadcast '.	self putString: aString on: msg.	^ msg contents! !!ScratchServer methodsFor: 'private-server' stamp: 'KK 1/18/2013 09:49'!sendOutgoingCommands	"Send broadcasts and variable updates to my peers."	| varUpdateMsg |	self someVariableHasChanged		ifTrue: [varUpdateMsg _ self variableUpdateMessage]		ifFalse: [varUpdateMsg _ nil].	peerSockets copy do: [:sock |		sock isConnected			ifTrue: [				varUpdateMsg ifNotNil: [sock sendMessage: varUpdateMsg].				outgoingBroadcasts do: [:evt | sock sendMessage: (self broadcastMessageFor: evt)].				sock sendData]			ifFalse: [				sock destroy.				peerSockets remove: sock ifAbsent: []]].	self recordVariableValues.! !!ScratchStackFrame methodsFor: 'accessing' stamp: 'KK 9/5/2017 14:53'!discardSvmFifo	| block sb |	block _ expression.	sb _ (block receiver ownerThatIsA: ScratchStageMorph) sensorBoard.	sb initSyncProc.! !!ScratchThread methodsFor: 'system cmds' stamp: 'KK 4/28/2014 11:21'!doRepeat	"Execute my enclosed blocks the number of times given by my argument. tmp is used to count down the iterations."	| cmd |	cmd _ cmds at: ip.	tmp ifNil: [  "first time"		tmp _ self evalArg: (cmd at: 2)].	tmp <= 0 ifTrue: [^ self].  "repeat is finished"	tmp _ tmp - 1.	self evalCmdList: (cmd at: 3).! !!ScratchTranslator class methodsFor: 'language translation' stamp: 'KK 8/30/2013 17:31'!setLanguage: aString	"Set the current language. If the language is not supported, use English (i.e. an empty translation dictionary)."	| dict |	"default to English"	Language _ 'en'.	TranslationDict _ Dictionary new.	HeaderString _ ''.	self setRenderingHints.  "clear rendering hints"	ScratchTranslator detectRenderPlugin.	aString = 'en' ifTrue: [^ self].	dict _ self importTranslation: aString, '.po'.	dict ifNotNil: [		Language _ aString.		TranslationDict _ dict.		HeaderString _ dict at: '' ifAbsent: [''].		dict removeKey: '' ifAbsent: [].		self setRenderingHints.		RenderWithSqueak ifTrue: [self convertToMacRoman].		self isRTL ifTrue: [self fixAmbigousRTLPunctuation].		self addSensorTranslations].! !!ScratchTranslator class methodsFor: 'rendering menu' stamp: 'sk 2/7/2017 11:58'!fontScale: aNumber	RenderScale _ aNumber.	self updateScratchUI.! !!ScratchTranslator class methodsFor: 'import/export' stamp: 'KK 8/30/2013 19:55'!exportStringsToTranslateFrom: aDictionary toFile: fName	"Export the strings to be translated either to Scratch.pot or an existing translation (.po) file."	"self resetUITranslationSet. self resetMIDITranslationSet. self exportStringsToTranslateFrom: nil toFile: nil"	"self resetMIDITranslationSet. self exportStringsToTranslateFrom: (self importTranslation: 'es.po') toFile: 'exportTest.po'"	| dir fn header f sections templateDict title keys comments |	self setLanguage: 'en'.	header _ HeaderString.	dir _ self translationDir.	fn _ fName.	fn ifNil: [fn _ self templateFilename].	(dir fileExists: fn) ifTrue: [  "extract the existing header, then delete the old .po file"		aDictionary ifNotNil: [			header _ aDictionary at: '' ifAbsent: [''].			dir deleteFileNamed: (dir fullNameFor: fn)]].	f _ FileStream newFileNamed: (dir fullNameFor: fn).	"f nextPutAll: #(239 187 191) asByteArray asString."  "UTF8 byte-order mark - removed for now (Pootle)"	"header comments are stored as '-comments' because the header key is the empty string"	aDictionary ifNotNil: [		comments _ aDictionary at: '-comments' ifAbsent: [#()].		comments do: [:s | f nextPutAll: s; crlf]].	"header is stored as a multi-line translation entry for the empty string"	self export: 'msgid' value: '' to: f.	self export: 'msgstr' value: header to: f.	f crlf.	sections _ {		{'FORMATTING'.			self formattingHeaderFields}.		{'BLOCKS'.				ScriptableScratchMorph blockSpecsForTranslation}.		{'USER INTERFACE'.		self uiTranslationSetAsSortedArray}. 		{'MIDI INSTRUMENTS'.	self midiTranslationSet asArray sort}	}.	aDictionary ifNotNil: [templateDict _ self importTranslation: self templateFilename].	sections do: [:pair |		title _ pair first.		keys _ pair second asOrderedCollection.		f nextPutAll: '############################################'; crlf.		f nextPutAll: '# ', title; crlf.		f nextPutAll: '############################################'; crlf.		f crlf.		((title = 'FORMATTING') and: [aDictionary isNil]) ifTrue: [			f nextPutAll: self formattingSectionForPOT.			keys _ OrderedCollection new].		keys removeAll: self doNotTranslate.		keys do: [:k |			(aDictionary isNil or: [templateDict includesKey: k]) ifTrue: [				"COMMENTS"				comments _ #().				(templateDict notNil and: [templateDict includesKey: k,'-comments'])					ifTrue: [ "use the comment from template .pot file if there is one"						comments _ (templateDict at: k, '-comments')]					ifFalse: [ "else use the comment from the translation file"						aDictionary ifNotNil: [							comments _ aDictionary at: k, '-comments' ifAbsent: [#()]]].				comments do: [:s | f nextPutAll: s; crlf].				"FUZZY TAG"				(aDictionary notNil and: [aDictionary includesKey: k, '-fuzzy'])					ifTrue: [f nextPutAll: '#, fuzzy'; crlf].				"KEY"				self export: 'msgid' value: k to: f.				"TRANSLATION"				(aDictionary notNil and: [aDictionary includesKey: k])					ifTrue: [						self export: 'msgstr' value: (aDictionary at: k) to: f]					ifFalse: [						(aDictionary notNil and: [aDictionary includesKey: k asLowercase])							ifTrue: [  "TEMPORARY CAPITALIZATION HACK"								self export: 'msgstr' value: (aDictionary at: k asLowercase) to: f]							ifFalse: [								(aDictionary notNil and: [(k endsWith: '?') and: [aDictionary includesKey: (k copyFrom: 1 to: k size - 1)]])									ifTrue: [  "TEMPORARY QUESTION HACK"										self export: 'msgstr' value: (aDictionary at: (k copyFrom: 1 to: k size - 1)) to: f]									ifFalse: [  "BLANK TRANSLATION"										self export: 'msgstr' value: '' to: f]]].				f crlf]]].	f close.! !!ScratchViewerMorph methodsFor: 'initialization' stamp: 'ee 1/29/2009 13:44'!initialize	super initialize.	self		initFrontFromForm: (ScratchFrameMorph skinAt: #blocksPaletteFrameTransparent2)		topSectionHeight: 120.	self middleBarLeftMargin: 5 rightMargin: 0.	color _ (Color r: 0.584 g: 0.603 b: 0.623).	pageViewer _ ScrollFrameMorph2 new growthFraction: 0.1.	self addMorphBack: (pageViewer position: self position + (0@120)).	self target: nil.	self extent: 214@500.! !!ScratchViewerMorph methodsFor: 'initialization' stamp: 'KK 9/28/2017 08:51'!rebuildCategorySelectors	| catList maxExtent buttons label offForm onForm overForm b pad leftColumnX rightColumnX x y |"xxx	catList _ #(		motion		control		looks		sensing		sound		operators		pen			variables)."	catList _ #("		motion		control					sensing					operators").	"First, delete the old category buttons"	submorphs do: [:m | (m isKindOf: ResizableToggleButton2) ifTrue: [m delete]].	"Create new buttons, keeping track of the maximum extent."	maxExtent _ 95@0.	buttons _ catList collect: [:cat |		label _ (ScratchTranslator translationFor: cat asString) capitalized.		offForm _ (ScratchFrameMorph skinAt: cat).		onForm _ (ScratchFrameMorph skinAt: (cat, 'Pressed')).		overForm _ (ScratchFrameMorph skinAt: (cat, 'Over')).		ScratchTranslator isRTL			ifTrue:[				b _ ResizableToggleButton2 new					offForm:	(offForm flipBy: #horizontal centerAt: offForm center)					onForm:		(onForm flipBy: #horizontal centerAt: onForm center)					overForm:	(overForm flipBy: #horizontal centerAt: overForm center)]			ifFalse:[				b _ ResizableToggleButton2 new					offForm:	offForm					onForm:		onForm					overForm:	overForm].		b			label: label font: (ScratchFrameMorph getFont: #Category);			setLabelColor: Color white;			target: self;			actionSelector: #currentCategory:;			arguments: (Array with: cat);			toggleButtonMode: true;			toggleMode: false.		ScratchTranslator isRTL			ifTrue:[b rightJustifyInset: 10]			ifFalse:[b leftJustifyInset: 10].		maxExtent _ maxExtent max: (b extent + (3 @ -6)).		b].	"calculate catButtonsExtent"	pad _ 25. "padding on left, right, and betwen the button columns"	catButtonsExtent _ ((2 * maxExtent x) + (3 * pad)) @ (((catList size // 2) * (maxExtent y + 6)) + 25).	"place the buttons"	leftColumnX _ self left + 12 + pad.	rightColumnX _ leftColumnX + maxExtent x + pad.	x _ leftColumnX.	y _ self top + 17.	1 to: buttons size do: [:i |		b _ buttons at: i.		b extent: maxExtent.		self addMorph: (b position: x@y).		i even			ifTrue: [x _ leftColumnX. y _ y + b height + 6]			ifFalse: [x _ rightColumnX]].	self width: catButtonsExtent x.	pageViewer position: self position + (0@catButtonsExtent y).	topSectionHeight _ catButtonsExtent y - 4.! !!ScratchViewerMorph methodsFor: 'private' stamp: 'jm 4/14/2008 17:52'!updateContents	| p |	self target ifNil: [		pageViewer contents: (Morph new color: ScratchFrameMorph palettePaneColor).		^ self].	p _ self target viewerPageForCategory: currentCategory.	p color: ScratchFrameMorph palettePaneColor.	pageViewer contents: p.	self isInWorld ifTrue: [self world startSteppingSubmorphsOf: p].	p fixLayout.	ScratchTranslator isRTL		ifTrue: [pageViewer hScrollPixels: (p right)].! !!ScriptableScratchMorph methodsFor: 'initialization' stamp: 'KK 9/23/2013 18:53'!initialize	| |	super initialize.	objName _ self nextInstanceName.	vars _ Dictionary new.	lists _ Dictionary new.	blocksBin _ ScratchScriptsMorph new.	"  ""	(ConvertTuplesToStacks = true) ifFalse: ["		blocksBin addMorphBack: (EventHatMorph new forStartEvent scriptOwner: super)."	].	ConvertTuplesToStacks _ false."	isClone _ false.	costume _ self defaultImageMedia.	media _ OrderedCollection new.	costumeChangeMSecs _ 0.	visibility _ 100.	volume _ 100.	tempoBPM _ 60.	sceneStates _ Dictionary new.! !!ScriptableScratchMorph methodsFor: 'looks ops' stamp: 'sk 3/25/2016 16:43'!boardLED	" Check I/O pin configuration and answer a collection of board leds. "	| leds |Transcript show: 'boardLED'.	leds _ OrderedCollection new.	(IOPort at: 3) = 5 ifTrue: [		leds add: 'Red(D5)'].	(IOPort at: 4) = 5 ifTrue: [		leds add: 'Yellow(D6)'].	(IOPort at: 5) = 5 ifTrue: [		leds add: 'Green(D9)'].	^ leds! !!ScriptableScratchMorph methodsFor: 'looks ops' stamp: 'kk 7/5/2013 15:26'!bzrLEDPinNo	"Answer a collection of Buzzer/LED connected pin number."	^ #(		'A0'		'A1'		'A2'		'A3'		'A4'		'A5'		)! !!ScriptableScratchMorph methodsFor: 'looks ops' stamp: 'KK 9/20/2013 15:57'!bzrPinNo	" Check I/O pin configuration and reflect for argument "	"Answer a collection of buzzer number."	| offset validBuzzerPin id |	offset _ 10.	validBuzzerPin _ OrderedCollection new.	1 to: 8 do: [ :index |		id _ IOPort at: (index + offset).		id = 16r04 ifTrue: [			validBuzzerPin add: 'A', (index-1) asString.		]	].		^ validBuzzerPin.! !!ScriptableScratchMorph methodsFor: 'looks ops' stamp: 'KK 9/23/2013 21:20'!dcMotorNo	" Check I/O pin configuration and reflect for argument "	"Answer a collection of DC motor number."	| dcPin offset validDCPin id |	dcPin _ Array new: 2.	dcPin		at: 1 put: 'M1';		at: 2 put: 'M2'.	offset _ 0.	validDCPin _ OrderedCollection new.	1 to: 2 do: [ :index |		id _ IOPort at: (index + offset).		id = 1 ifTrue: [			validDCPin add: (dcPin at: index).		]	].		^ validDCPin."	^ #('M1' 'M2')	"! !!ScriptableScratchMorph methodsFor: 'looks ops' stamp: 'KK 2/12/2013 17:19'!dcMotorOff	"Answer a collection of DC motor Off."	^ #(		'Brake'		'Coast')! !!ScriptableScratchMorph methodsFor: 'looks ops' stamp: 'KK 2/12/2013 17:19'!dcMotorOn	"Answer a collection of DC motor On."	^ #(		'cw.'		'ccw.')! !!ScriptableScratchMorph methodsFor: 'looks ops' stamp: 'KK 9/4/2013 09:11'!ledColor	"Answer a collection of Buzzer/LED connected pin number."	^ #(		'White'		'Red'		'Green'		'Blue'		'Cyan'		'Magenta'		'Yellow'		)! !!ScriptableScratchMorph methodsFor: 'looks ops' stamp: 'kk 7/5/2013 15:24'!ledOnOff	"Answer a collection of LED On/Off."	^ #(		'on'		'off')! !!ScriptableScratchMorph methodsFor: 'looks ops' stamp: 'KK 9/20/2013 15:58'!ledPinNo	" Check I/O pin configuration and reflect for argument "	"Answer a collection of LED number."	| offset validLEDPin id |	offset _ 10.	validLEDPin _ OrderedCollection new.	1 to: 8 do: [ :index |		id _ IOPort at: (index + offset).		id = 16r03 ifTrue: [			validLEDPin add: 'A', (index-1) asString.		]	].		^ validLEDPin.! !!ScriptableScratchMorph methodsFor: 'looks ops' stamp: 'KK 12/26/2012 10:39'!motorOnOff	"Answer a collection of DC motor number."	^ #(		'on'		'off')! !!ScriptableScratchMorph methodsFor: 'looks ops' stamp: 'KK 1/24/2014 18:41'!moveDirection	"Answer a collection of move."	^ #(		'Forward'		'Back'		'Left front'		'Right front'		'Left rear'		'Right rear'		'cw.'		'ccw.'		)! !!ScriptableScratchMorph methodsFor: 'looks ops' stamp: 'sk 7/7/2016 19:38'!svMotorNo	" Check I/O pin configuration and reflect for argument "	"Answer a collection of servo motor number."	| servoPin offset validServoPin id |	(BoardType = 0 or: [BoardType = 2]) ifTrue: [		servoPin _ #('D2' 'D4' 'D7' 'D8' 'D9' 'D10' 'D11' 'D12').]	ifFalse: [		servoPin _ #('D5' 'D6' 'D9' 'D10' 'D11').].	offset _ 2.	validServoPin _ OrderedCollection new.	1 to: (servoPin size) do: [ :index |		id _ IOPort at: (index + offset).		id = 2 ifTrue: [			validServoPin add: (servoPin at: index).		]	].	^ validServoPin."	^ #('D2' 'D4' 'D7' 'D8' 'D9' 'D10' 'D11' 'D12')	"! !!ScriptableScratchMorph methodsFor: 'sensing ops' stamp: 'KK 8/31/2013 11:11'!accelerometer: sensorName	"Answer the value of the given sensor, or zero if the sensorboard is not available."	^ self sensor: sensorName.! !!ScriptableScratchMorph methodsFor: 'sensing ops' stamp: 'sk 4/14/2016 16:32'!clockValue: type	^ 0! !!ScriptableScratchMorph methodsFor: 'sensing ops' stamp: 'sk 2/18/2016 10:12'!clockVars	| varNames |	varNames _ #(		'Hour'		'Minute'		'Year'		'Month'		'Day'		'Temperature'		'Alarm hour'		'Alarm minute'	).	^ varNames! !!ScriptableScratchMorph methodsFor: 'sensing ops' stamp: 'KK 9/20/2013 09:37'!hookupARButton	" Check I/O pin configuration and reflect for argument "	"Answer a collection of button number."	| offset validButton id |	offset _ 10.	validButton _ OrderedCollection new.	1 to: 4 do: [ :index |		id _ IOPort at: (index + offset).		id = 16r15 ifTrue: [			validButton add: 'A', (index-1) asString.		]	].		^ validButton.! !!ScriptableScratchMorph methodsFor: 'sensing ops' stamp: 'sk 4/1/2016 09:57'!hookupARSensorNames	| sensorNames offset light touch sound infrared acceleration button setAcceleration sensorID |	" Check IOPort "	Transcript show:(IOPort);cr.	offset _ 11.		" Offset for sensor ID "	light _ 16r10.			" Light sensor ID "	touch _ 16r11.			" Touch sensor ID "	sound _ 16r12.			" Sound sensor ID "	infrared _ 16r13.		" IR Photoreflector ID "	acceleration _ 16r14.		" Acceleration sensor ID "	button _ 16r15.			" Button sensor ID "	setAcceleration _ false.	" Set acceleration sensor flag "	sensorNames _ OrderedCollection new.	0 to: 7 do: [ :index |		sensorID _ IOPort at: (index + offset).		(sensorID < 16r10) ifTrue: [		] ifFalse: [			(sensorID = light) ifTrue: [	" Light Sensor "				sensorNames add:'[A',index asString,']',' Light sensor'.			].			(sensorID = touch) ifTrue: [	" Touch Sensor "				sensorNames add:'[A',index asString,']',' Touch sensor'.			].			(sensorID = sound) ifTrue: [	" Sound Sensor "				sensorNames add:'[A',index asString,']',' Sound sensor'.			].			(sensorID = infrared) ifTrue: [	" IR Photoreflector "				sensorNames add:'[A',index asString,']',' IR Photoreflector'.			].			(sensorID = acceleration) ifTrue: [	" Acceleration Sensor "				(setAcceleration = false) ifTrue: [					sensorNames add:'[A4/A5] Acceleration sensor (X)'.					sensorNames add:'[A4/A5] Acceleration sensor (Y)'.					sensorNames add:'[A4/A5] Acceleration sensor (Z)'.					setAcceleration _ True.				].			].			(sensorID = button) ifTrue: [	" Button "				sensorNames add:'[A',index asString,']',' Button'.			].		].	]."	sensorNames _ #(		'A0'		'A1'		'A2'		'A3'		'A4'		'A5'		'A6'		'A7'	)."	^ sensorNames! !!ScriptableScratchMorph methodsFor: 'sensing ops' stamp: 'KK 8/23/2013 13:35'!hookupARSensorPinID	| sensorNames |	sensorNames _ #(		'A0'		'A1'		'A2'		'A3'		'A4'		'A5'		'A6'		'A7'	).	^ sensorNames! !!ScriptableScratchMorph methodsFor: 'sensing ops' stamp: 'KK 8/23/2013 13:36'!hookupARSensorPinID1	| sensorNames |	sensorNames _ #(		'A0'		'A1'		'A2'		'A3'		'A4'		'A5'		'A6'		'A7'	).	^ sensorNames! !!ScriptableScratchMorph methodsFor: 'sensing ops' stamp: 'KK 8/31/2013 11:18'!hookupARSensorPinID2	^ #(		'A0'		'A1'		'A2'		'A3'		'A4'		'A5'	).! !!ScriptableScratchMorph methodsFor: 'sensing ops' stamp: 'KK 8/29/2013 17:32'!hookupARSensorXYZ	| sensorNames |	sensorNames _ #(		'X'		'Y'		'Z'	).	^ sensorNames! !!ScriptableScratchMorph methodsFor: 'sensing ops' stamp: 'KK 9/20/2013 09:26'!hookupIRPin	" Check I/O pin configuration and reflect for argument "	"Answer a collection of light sensor number."	| offset validIRPin id |	offset _ 10.	validIRPin _ OrderedCollection new.	1 to: 8 do: [ :index |		id _ IOPort at: (index + offset).		id = 16r13 ifTrue: [			validIRPin add: 'A', (index-1) asString.		]	].		^ validIRPin.! !!ScriptableScratchMorph methodsFor: 'sensing ops' stamp: 'KK 9/19/2017 20:00'!hookupLightPin	" Check I/O pin configuration and reflect for argument "	"Answer a collection of light sensor number."	| offset validLightPin id |	offset _ 10.	validLightPin _ OrderedCollection new.	1 to: 8 do: [ :index |		id _ IOPort at: (index + offset).		id = 16r10 ifTrue: [			validLightPin add: 'A', (index-1) asString.		].		id = 16r13 ifTrue: [			validLightPin add: 'A', (index-1) asString.		].		id = 16r18 ifTrue: [			validLightPin add: 'A', (index-1) asString.		].	].		^ validLightPin.! !!ScriptableScratchMorph methodsFor: 'sensing ops' stamp: 'KK 9/20/2013 09:13'!hookupSensorIDPin	| offset validServoPin id |	offset _ 10.	validServoPin _ OrderedCollection new.	1 to: 8 do: [ :index |		id _ IOPort at: (index + offset).		id = 16r10 ifTrue: [			validServoPin add: 'Light sensor(A', (index-1) asString, ')'.		]	].		^ validServoPin.! !!ScriptableScratchMorph methodsFor: 'sensing ops' stamp: 'KK 9/20/2017 09:48'!hookupSensorsPin	" Check I/O pin configuration and reflect for argument "	"Answer a collection of light sensor number."	| offset validSensorPin id |	offset _ 10.	validSensorPin _ OrderedCollection new.	1 to: 8 do: [ :index |		id _ IOPort at: (index + offset).		id = 16r10 ifTrue: [			validSensorPin add: 'A', (index-1) asString.		].		id = 16r13 ifTrue: [			validSensorPin add: 'A', (index-1) asString.		].		id = 16r18 ifTrue: [			validSensorPin add: 'A', (index-1) asString.		].	].		^ validSensorPin.! !!ScriptableScratchMorph methodsFor: 'sensing ops' stamp: 'KK 9/20/2013 09:38'!hookupSoundPin	" Check I/O pin configuration and reflect for argument "	"Answer a collection of sound sensor number."	| offset validSoundPin id |	offset _ 10.	validSoundPin _ OrderedCollection new.	1 to: 8 do: [ :index |		id _ IOPort at: (index + offset).		id = 16r12 ifTrue: [			validSoundPin add: 'A', (index-1) asString.		]	].		^ validSoundPin.! !!ScriptableScratchMorph methodsFor: 'sensing ops' stamp: 'KK 9/20/2013 09:33'!hookupTouchPin	" Check I/O pin configuration and reflect for argument "	"Answer a collection of touch sensor number."	| offset validTouchPin id |	offset _ 10.	validTouchPin _ OrderedCollection new.	1 to: 8 do: [ :index |		id _ IOPort at: (index + offset).		id = 16r11 ifTrue: [			validTouchPin add: 'A', (index-1) asString.		]	].		^ validTouchPin.! !!ScriptableScratchMorph methodsFor: 'sensing ops' stamp: 'KK 10/3/2013 14:29'!indexForSensorName: sensorName	| sensorID acceleration |	"Answer the index for the given sensor name."	sensorName startsWithDigit ifTrue: [^ sensorName asNumberNoError].	sensorID _ IOPort at: (15).	" 14 and 15 : Acceleration ? "	acceleration _ 16r14.			" Acceleration sensor ID "	'A0' = sensorName		ifTrue: [^ 1].	'A1' = sensorName		ifTrue: [^ 2].	'A2' = sensorName		ifTrue: [^ 3].	'A3' = sensorName		ifTrue: [^ 4].	(sensorID = acceleration) ifFalse: [		'A4' = sensorName		ifTrue: [^ 5].		'A5' = sensorName		ifTrue: [^ 6].		'A6' = sensorName		ifTrue: [^ 7].		'A7' = sensorName		ifTrue: [^ 8].	] ifTrue: [		'X' = sensorName		ifTrue: [^ 5].		'Y' = sensorName		ifTrue: [^ 6].		'Z' = sensorName		ifTrue: [^ 7].		'A6' = sensorName		ifTrue: [^ 8].		'A7' = sensorName		ifTrue: [^ 9].	]."	'Light(Left)' = sensorName		ifTrue: [^ 1].	'Light(Right)' = sensorName			ifTrue: [^ 2].	'sound' = sensorName		ifTrue: [^ 3].	(sensorName includesSubString: 'button') ifTrue: [^ 4].	'Button(Left)' = sensorName		ifTrue: [^ 5].	'Button(Center)' = sensorName	ifTrue: [^ 6].	'Button(Right)' = sensorName	ifTrue: [^ 7].	'Button(Enter)' = sensorName		ifTrue: [^ 8].	(sensorName includes: $A)	ifTrue: [^ 5].	(sensorName includes: $B)	ifTrue: [^ 6].	(sensorName includes: $C)	ifTrue: [^ 7].	(sensorName includes: $D)	ifTrue: [^ 8]."	^ 1! !!ScriptableScratchMorph methodsFor: 'sensing ops' stamp: 'sk 7/6/2016 10:10'!isInAlarm	^ true! !!ScriptableScratchMorph methodsFor: 'sensing ops' stamp: 'KK 8/30/2013 16:34'!lightSensor: sensorName	"Answer the value of the given sensor, or zero if the sensorboard is not available."	^ self sensor: sensorName.! !!ScriptableScratchMorph methodsFor: 'sensing ops' stamp: 'KK 12/19/2012 18:40'!motor: n deg: d| stage |! !!ScriptableScratchMorph methodsFor: 'sensing ops' stamp: 'KK 8/31/2013 11:11'!onBoardButton: sensorName	"Answer the value of the given sensor, or zero if the sensorboard is not available."	^ self sensor: sensorName.! !!ScriptableScratchMorph methodsFor: 'sensing ops' stamp: 'sk 3/1/2016 15:52'!onBoardLightSensor	"Answer the value of on-board light sensor value."	^ self sensor: 'A6'.! !!ScriptableScratchMorph methodsFor: 'sensing ops' stamp: 'sk 3/1/2016 15:53'!power	"Answer the value of battery voltage."	^ self sensor: 'A7'.! !!ScriptableScratchMorph methodsFor: 'sensing ops' stamp: 'KK 8/31/2013 11:11'!refPhotosensor: sensorName	"Answer the value of the given sensor, or zero if the sensorboard is not available."	^ self sensor: sensorName.! !!ScriptableScratchMorph methodsFor: 'sensing ops' stamp: 'sk 10/19/2016 13:33'!sensor: sensorName	"Answer the value of the given sensor, or zero if the sensorboard is not available."	| stage v sb |	(stage _ self ownerThatIsA: ScratchStageMorph) ifNil: [^ 0].	stage scratchServer ifNotNil: [		v _ stage scratchServer sensorValueFor: sensorName.		v ifNotNil: [^ v]].	'tilt' = sensorName ifTrue: [^ WeDoPlugin tilt].	'distance' = sensorName ifTrue: [^ WeDoPlugin distance].	sb _ stage sensorBoard.	(BoardType = 0) ifTrue: [		"sb tryToOpenPort ifFalse: [^ 0]."]  "could not open"	ifFalse: [		sb socketIsOpen ifFalse: [^ 0]].	^ sb sensor: (self indexForSensorName: sensorName)! !!ScriptableScratchMorph methodsFor: 'sensing ops' stamp: 'KK 9/20/2017 10:49'!sensors: sensorName	"Answer the value of the given sensor, or zero if the sensorboard is not available."	^ self sensor: sensorName.! !!ScriptableScratchMorph methodsFor: 'sensing ops' stamp: 'KK 8/31/2013 11:11'!soundSensor: sensorName	"Answer the value of the given sensor, or zero if the sensorboard is not available."	^ self sensor: sensorName.! !!ScriptableScratchMorph methodsFor: 'sensing ops' stamp: 'sk 9/8/2017 16:53'!temperaturePinNo
	" Check I/O pin configuration and reflect for argument "
	"Answer a collection of button number."

	| offset id validPin |

	offset _ 10.
	validPin _ OrderedCollection new.
	1 to: 8 do: [ :index |
		id _ IOPort at: (index + offset).
		id = 16r18 ifTrue: [
			validPin add: 'A', (index-1) asString.
		]
	].	

	^ validPin.
! !!ScriptableScratchMorph methodsFor: 'sensing ops' stamp: 'sk 9/14/2017 15:08'!temperatureSensor: sensorName
	"Answer the value of the given sensor, or zero if the sensorboard is not available."

	^ self sensor: sensorName.
! !!ScriptableScratchMorph methodsFor: 'sensing ops' stamp: 'KK 8/31/2013 11:10'!touchSensor: sensorName	"Answer the value of the given sensor, or zero if the sensorboard is not available."	^ self sensor: sensorName.! !!ScriptableScratchMorph methodsFor: 'list ops' stamp: 'sk 2/22/2017 10:55'!addGlobalList	| sFrame listName |	(sFrame _ self ownerThatIsA: ScratchFrameMorph) ifNil: [^ self beep].		ValueOrList _ true.	TabletMode ifTrue: [		sFrame sendMessageToBMnoBlocking: 'SHOWKEYPAD'].	listName _ StringDialog ask: 'List name?(Only alphanumeric characters are allowed)'.	TabletMode ifTrue: [		sFrame sendMessageToBMnoBlocking: 'HIDEKEYPAD'].	listName size = 0 ifTrue: [^ self].	sFrame workPane createListNamed: listName.	sFrame viewerPane categoryChanged: 'variables'.! !!ScriptableScratchMorph methodsFor: 'list ops' stamp: 'sk 2/8/2017 13:49'!createListNamed: listName	| list stage n |	(self variableNameInUse: listName) ifTrue: [		self beep.		DialogBoxMorph warn: 'That variable name is already in use'.		^ self].	lists at: listName put: (list _ ScratchListMorph new listName: listName target: self).	(stage _ self ownerThatIsA: ScratchStageMorph) ifNotNil: [		n _ (stage submorphs select: [:m | m isKindOf: ScratchListMorph]) size.		"stage addMorph: (list position: stage topRight - ((list width + 10)@0) + (0@(10+(20*n))))."		stage addMorph: (list position: stage topLeft + (10@(10+(20*n)+(stage height // 2)))).		list startStepping].! !!ScriptableScratchMorph methodsFor: 'list ops' stamp: 'KK 9/20/2017 10:57'!defaultArgsFor: blockSpec
	"Answer the default argument for the given block specification."

	| defaultArgs stage sel currentSize list offset isDetect partsID arrPort |
	defaultArgs _ blockSpec copyFrom: 4 to: blockSpec size.  "may be empty"
	stage _ self ownerThatIsA: ScratchStageMorph.

	sel _ (blockSpec at: 3) asSymbol.
	#gotoX:y: = sel ifTrue: [
		defaultArgs _ Array
			with: self referencePosition x rounded
			with: self referencePosition y rounded].

	#glideSecs:toX:y:elapsed:from: = sel ifTrue: [
		defaultArgs _ Array
			with: 1
			with: self referencePosition x rounded
			with: self referencePosition y rounded].

	#motor:direction: = self ifTrue: [
		defaultArgs _ Array with: 'reverse' localized with: 'this way' localized with: 'that way'].

	#setSizeTo: = sel ifTrue: [
		currentSize _ (100.0 * (self scalePoint x max: self scalePoint y)) rounded.
		defaultArgs _ Array with: currentSize].

	#getAttribute:of: = sel ifTrue: [
		(stage _ self ownerThatIsA: ScratchStageMorph) ifNotNil: [
			list _ stage submorphs select: [:m | m isKindOf: ScratchSpriteMorph].
			list sort: [:s1 :s2 | s1 objName asLowercase < s2 objName asLowercase].
			list size > 0
				ifTrue: [defaultArgs _ Array with: 'x position' with: list first]
				ifFalse: [defaultArgs _ Array with: 'background #' with: stage]]
		ifNil:[defaultArgs _ Array with: 'x position' with: self]].

	#concatenate:with: = sel ifTrue: [
		defaultArgs _ Array with: 'hello ' localized with: 'world' localized].

	#doAsk = sel ifTrue: [
		defaultArgs _ Array with: 'What''s your name?' localized].

	#letter:of: = sel ifTrue: [
		defaultArgs _ Array with: 1 with: 'world' localized].

	#stringLength: = sel ifTrue: [
		defaultArgs _ Array with: 'world' localized].

	#say:duration:elapsed:from: = sel ifTrue: [
		defaultArgs _ Array with: 'Hello!!' localized with: 2].

	#say: = sel ifTrue: [
		defaultArgs _ Array with: 'Hello!!' localized].

	#think:duration:elapsed:from: = sel ifTrue: [
		defaultArgs _ Array with: 'Hmm...' localized with: 2].

	#think: = sel ifTrue: [
		defaultArgs _ Array with: 'Hmm...' localized].

	(#(lookLike: showBackground:) includes: sel) ifTrue: [
		defaultArgs _ Array with: self costumeNames last].

	(#(playSound: doPlaySoundAndWait) includes: sel) ifTrue: [
		list _ self soundNames.
		defaultArgs _ list size <= 2
			ifTrue: [Array with: '']
			ifFalse: [Array with: (list at: (list size - 2))]].

	(#(broadcast: doBroadcastAndWait) includes: sel) ifTrue: [
		stage ifNotNil: [defaultArgs _ Array with: stage defaultEventName]].

	(#(append:toList: deleteLine:ofList: insert:at:ofList:) includes: sel) ifTrue: [
		defaultArgs size >= 1 ifTrue: [
			defaultArgs at: 1 put: (defaultArgs at: 1) localized]].

	(#(append:toList: deleteLine:ofList: getLine:ofList: insert:at:ofList: lineCountOfList:)
		includes: sel) ifTrue: [
			defaultArgs _ defaultArgs copyWith: self defaultListName].

	#setLine:ofList:to: = sel ifTrue: [
		defaultArgs size >= 3 ifTrue: [
			defaultArgs at: 2 put: self defaultListName.
			defaultArgs at: 3 put: (defaultArgs at: 3) localized]].

	#appendLettersOf:toList: = sel ifTrue: [
		defaultArgs size >= 2 ifTrue: [
			defaultArgs at: 1 put: (defaultArgs at: 1) localized.
			defaultArgs at: 2 put: self defaultListName]].

	#list:contains: = sel ifTrue: [
		defaultArgs size >= 2 ifTrue: [
			defaultArgs at: 1 put: self defaultListName.
			defaultArgs at: 2 put: (defaultArgs at: 2) localized]].

	((#motorNo:power: = sel) | (#motorNo:dcMotorOn: = sel) | (#motorNo:dcMotorOff: = sel)) ifTrue: [
		isDetect _ false.			" detect DC motor? "
		offset _ 0.				" 1-2:DC 3-10:SV 11-18:Sensor "
		partsID _ 16r01.			" 01:DC 02:SV 03:LED 04:BZR 05:CLED 10:LS 11:TS 12:SS 13:IRS 14:3S 15:BTN"
		defaultArgs at: 1 put: ''.
		1 to: 2 do: [ :index |
			(((IOPort at: (index+offset)) = partsID) & (isDetect = false)) ifTrue: [
				(index = 1) ifTrue: [ defaultArgs at: 1 put: 'M1'. isDetect _ true. ].
				(index = 2) ifTrue: [ defaultArgs at: 1 put: 'M2'. isDetect _ true. ].
			]
		].
	].

	#motorNo:degree: = sel ifTrue: [
		isDetect _ false.			" detect servo motor? "
		offset _ 2.				" 1-2:DC 3-10:SV 11-18:Sensor "
		partsID _ 16r02.			" 01:DC 02:SV 03:LED 04:BZR 05:CLED 10:LS 11:TS 12:SS 13:IRS 14:3S 15:BTN"
		defaultArgs at: 1 put: ''.	""
		(BoardType = 0 or: [BoardType = 2]) ifTrue: [
			arrPort _ #('D2' 'D4' 'D7' 'D8' 'D9' 'D10' 'D11' 'D12').]
		ifFalse: [ " Studuino mini "
			arrPort _ #('D5' 'D6' 'D9' 'D10' 'D11').].

		1 to: (arrPort size) do: [:index |
			((IOPort at: (index + offset)) = partsID) ifTrue: [
				defaultArgs at: 1 put: (arrPort at: index).
				^ defaultArgs.].].
"
		1 to: 8 do: [ :index |
			(((IOPort at: (index+offset)) = partsID) & (isDetect = false)) ifTrue: [
				(index = 1) ifTrue: [ defaultArgs at: 1 put: 'D2'. isDetect _ true. ].
				(index = 2) ifTrue: [ defaultArgs at: 1 put: 'D4'. isDetect _ true. ].
				(index = 3) ifTrue: [ defaultArgs at: 1 put: 'D7'. isDetect _ true. ].
				(index = 4) ifTrue: [ defaultArgs at: 1 put: 'D8'. isDetect _ true. ].
				(index = 5) ifTrue: [ defaultArgs at: 1 put: 'D9'. isDetect _ true. ].
				(index = 6) ifTrue: [ defaultArgs at: 1 put: 'D10'. isDetect _ true. ].
				(index = 7) ifTrue: [ defaultArgs at: 1 put: 'D11'. isDetect _ true. ].
				(index = 8) ifTrue: [ defaultArgs at: 1 put: 'D12'. isDetect _ true. ].
			]
		].
"
	].

	(#ledPin:onOff: = sel) ifTrue: [
		isDetect _ false.			" detect buzzer? "
		offset _ 10.				" 1-2:DC 3-10:SV 11-18:Sensor "
		partsID _ 16r03.			" 01:DC 02:SV 03:LED 04:BZR 05:CLED 10:LS 11:TS 12:SS 13:IRS 14:3S 15:BTN"
		defaultArgs at: 1 put: ''.
		1 to: 6 do: [ :index |
			(((IOPort at: (index+offset)) = partsID) & (isDetect = false)) ifTrue: [
				defaultArgs at: 1 put: ('A', (index-1) asString).
				isDetect _ true.
			]
		].
	].

	((#buzzerPin:freq: = sel) | (#buzzerPin: = sel)) ifTrue: [
		isDetect _ false.			" detect buzzer? "
		offset _ 10.				" 1-2:DC 3-10:SV 11-18:Sensor "
		partsID _ 16r04.			" 01:DC 02:SV 03:LED 04:BZR 05:CLED 10:LS 11:TS 12:SS 13:IRS 14:3S 15:BTN"
		defaultArgs at: 1 put: ''.
		1 to: 6 do: [ :index |
			(((IOPort at: (index+offset)) = partsID) & (isDetect = false)) ifTrue: [
				defaultArgs at: 1 put: ('A', (index-1) asString).
				isDetect _ true.
			]
		].
	].

	(#lightSensor: = sel) ifTrue: [
		isDetect _ false.			" detect buzzer? "
		offset _ 10.				" 1-2:DC 3-10:SV 11-18:Sensor "
		partsID _ 16r10.			" 01:DC 02:SV 03:LED 04:BZR 05:CLED 10:LS 11:TS 12:SS 13:IRS 14:3S 15:BTN"
		defaultArgs at: 1 put: ''.
		(BoardType = 0 or: [BoardType = 2]) ifTrue: [
			arrPort _ #('A0' 'A1' 'A2' 'A3' 'A4' 'A5' 'A6' 'A7').]
		ifFalse: [ " Studuino mini "
			arrPort _ #('A0' 'A1' 'A2' 'A3' 'A4' 'A5').].

		1 to: (arrPort size) do: [:index |
			((IOPort at: (index + offset)) = partsID) ifTrue: [
				defaultArgs at: 1 put: (arrPort at: index).
				^ defaultArgs.].].
"
		1 to: 8 do: [ :index |
			(((IOPort at: (index+offset)) = partsID) & (isDetect = false)) ifTrue: [
				defaultArgs at: 1 put: ('A', (index-1) asString).
				isDetect _ true.
			]
		].
"
	].

	(#touchSensor: = sel) ifTrue: [
		isDetect _ false.			" detect buzzer? "
		offset _ 10.				" 1-2:DC 3-10:SV 11-18:Sensor "
		partsID _ 16r11.			" 01:DC 02:SV 03:LED 04:BZR 05:CLED 10:LS 11:TS 12:SS 13:IRS 14:3S 15:BTN"
		defaultArgs at: 1 put: ''.
		1 to: 6 do: [ :index |
			(((IOPort at: (index+offset)) = partsID) & (isDetect = false)) ifTrue: [
				defaultArgs at: 1 put: ('A', (index-1) asString).
				isDetect _ true.
			]
		].
	].

	(#soundSensor: = sel) ifTrue: [
		isDetect _ false.			" detect buzzer? "
		offset _ 10.				" 1-2:DC 3-10:SV 11-18:Sensor "
		partsID _ 16r12.			" 01:DC 02:SV 03:LED 04:BZR 05:CLED 10:LS 11:TS 12:SS 13:IRS 14:3S 15:BTN"
		defaultArgs at: 1 put: ''.
		1 to: 8 do: [ :index |
			(((IOPort at: (index+offset)) = partsID) & (isDetect = false)) ifTrue: [
				defaultArgs at: 1 put: ('A', (index-1) asString).
				isDetect _ true.
			]
		].
	].

	(#refPhotosensor: = sel) ifTrue: [
		isDetect _ false.			" detect buzzer? "
		offset _ 10.				" 1-2:DC 3-10:SV 11-18:Sensor "
		partsID _ 16r13.			" 01:DC 02:SV 03:LED 04:BZR 05:CLED 10:LS 11:TS 12:SS 13:IRS 14:3S 15:BTN"
		defaultArgs at: 1 put: ''.
		1 to: 8 do: [ :index |
			(((IOPort at: (index+offset)) = partsID) & (isDetect = false)) ifTrue: [
				defaultArgs at: 1 put: ('A', (index-1) asString).
				isDetect _ true.
			]
		].
	].

	(#accelerometer: = sel) ifTrue: [
		isDetect _ false.			" detect buzzer? "
		offset _ 10.				" 1-2:DC 3-10:SV 11-18:Sensor "
		partsID _ 16r14.			" 01:DC 02:SV 03:LED 04:BZR 05:CLED 10:LS 11:TS 12:SS 13:IRS 14:3S 15:BTN"
		defaultArgs at: 1 put: ''.
		1 to: 8 do: [ :index |
			(((IOPort at: (index+offset)) = partsID) & (isDetect = false)) ifTrue: [
				defaultArgs at: 1 put: 'X'.
				isDetect _ true.
			]
		].
	].

	(#onBoardButton: = sel) ifTrue: [
		isDetect _ false.			" detect buzzer? "
		offset _ 10.				" 1-2:DC 3-10:SV 11-18:Sensor "
		partsID _ 16r15.			" 01:DC 02:SV 03:LED 04:BZR 05:CLED 10:LS 11:TS 12:SS 13:IRS 14:3S 15:BTN"
		defaultArgs at: 1 put: ''.
		1 to: 4 do: [ :index |
			(((IOPort at: (index+offset)) = partsID) & (isDetect = false)) ifTrue: [
				defaultArgs at: 1 put: ('A', (index-1) asString).
				isDetect _ true.
			]
		].
	].

	(#temperatureSensor: = sel) ifTrue: [
		isDetect _ false.			" detect buzzer? "
		offset _ 10.				" 1-2:DC 3-10:SV 11-18:Sensor "
		partsID _ 16r18.
		defaultArgs at: 1 put: ''.
		1 to: 8 do: [ :index |
			(((IOPort at: (index+offset)) = partsID) & (isDetect = false)) ifTrue: [
				defaultArgs at: 1 put: ('A', (index-1) asString).
				isDetect _ true.
			]
		].
	].

	(#boardLED:onOff: = sel) ifTrue: [
		isDetect _ false.			" detect buzzer? "
		partsID _ 16r05.			" 01:DC 02:SV 03:LED 04:BZR 05:CLED 10:LS 11:TS 12:SS 13:IRS 14:3S 15:BTN"
Transcript show: (IOPort at: 3); cr.
		defaultArgs at: 1 put: ''.
		((IOPort at: 3) = partsID) & (isDetect not) ifTrue: [
			defaultArgs at: 1 put: 'Red(D5)'.
			isDetect _ true].
		((IOPort at: 4) = partsID) & (isDetect not) ifTrue: [
			defaultArgs at: 1 put: 'Yellow(D6)'.
			isDetect _ true].
		((IOPort at: 5) = partsID) & (isDetect not) ifTrue: [
			defaultArgs at: 1 put: 'Green(D9)'.
			isDetect _ true].
	].
	(#sensors: = sel) ifTrue: [		isDetect _ false.			" detect buzzer? "		offset _ 10.				" 1-2:DC 3-10:SV 11-18:Sensor "		partsID _ 16r10.			" 01:DC 02:SV 03:LED 04:BZR 05:CLED 10:LS 11:TS 12:SS 13:IRS 14:3S 15:BTN"		defaultArgs at: 1 put: ''.		(BoardType = 0 or: [BoardType = 2]) ifTrue: [			arrPort _ #('A0' 'A1' 'A2' 'A3' 'A4' 'A5' 'A6' 'A7').]		ifFalse: [ " Studuino mini "			arrPort _ #('A0' 'A1' 'A2' 'A3' 'A4' 'A5').].		1 to: (arrPort size) do: [:index |			partsID _ IOPort at: (index + offset).			(partsID = 16r10) | (partsID = 16r13) | (partsID = 16r18) ifTrue: [				defaultArgs at: 1 put: (arrPort at: index).				^ defaultArgs.].].	].
	^ defaultArgs
! !!ScriptableScratchMorph methodsFor: 'motor ops' stamp: 'KK 9/15/2017 16:06'!m1DCMotorOff	"Set On/Off the DC motor selected"	self motorNo: 'M1' dcMotorOff: 'Brake'.! !!ScriptableScratchMorph methodsFor: 'motor ops' stamp: 'KK 9/15/2017 16:07'!m1DCMotorOn:n"Set On/Off the DC motor selected"	" Set M1 DC Motor Power. "	self motorNo: 'M1' power: n.	" M1 DC Motor On CCW. "	self motorNo: 'M1' dcMotorOn: 'ccw.'.! !!ScriptableScratchMorph methodsFor: 'motor ops' stamp: 'KK 11/20/2013 18:31'!motorNo:n dcMotorOff:s"Set On/Off the DC motor selected"| stage sb mid ival |"Check argument."n = '' ifTrue: [^0].(stage := self ownerThatIsA: ScratchStageMorph) ifNil: [^0].sb _ stage sensorBoard."sb tryToOpenPort ifFalse:[^0]."mid _ 0.		" 0: DC Motor ID "(n = 'M1') ifTrue: [ ival _ 16r0200. ].		"b0000 0010 0000 0000"(n = 'M2') ifTrue: [ ival _ 16r0A00. ].	"b0000 1010 0000 0000"(s = 'Brake') ifTrue: [ ival _ ival + 0. ].		" b0000 n010 0000 0000"(s = 'Coast') ifTrue: [ ival _ ival + 1. ].		" b0000 n010 0000 0001 "^sb data:ival msgID:mid.! !!ScriptableScratchMorph methodsFor: 'motor ops' stamp: 'KK 11/20/2013 18:30'!motorNo:n dcMotorOn:s"Set On/Off the DC motor selected"| stage sb mid ival |"Check argument."n = '' ifTrue: [^0].(stage := self ownerThatIsA: ScratchStageMorph) ifNil: [^0].sb _ stage sensorBoard."sb tryToOpenPort ifFalse:[^0]."mid _ 0.		" 0: DC Motor ID "(n = 'M1') ifTrue: [ ival _ 16r0100. ].		" b0000 0001 0000 0000 "(n = 'M2') ifTrue: [ ival _ 16r0900. ].		" b0000 1001 0000 0000 "(s = 'cw.') ifTrue: [ ival _ ival + 0. ].	" b0000 n001 0000 0000 "(s = 'ccw.') ifTrue: [ ival _ ival + 1. ].	" b0000 n001 0000 0001 "^sb data:ival msgID:mid.! !!ScriptableScratchMorph methodsFor: 'motor ops' stamp: 'sk 5/17/2017 15:44'!motorNo:n degree:d"Set degree the servo motor selected"| stage sb mid ival pin offset index svPort |" Check argument. "n = '' ifTrue: [^0].(stage := self ownerThatIsA: ScratchStageMorph) ifNil: [^0].sb _ stage sensorBoard."sb tryToOpenPort ifFalse:[^0]."offset _ 0.mid _ 1.		" 1 : Servo Motor ID"index _ 1.	(BoardType = 0 or: [BoardType = 2]) ifTrue: [(n = 'D2') ifTrue: [	pin _ 16r0000.			"b0000 0000 0000 0000"	offset _ SvCalib at:(5).	" Servomotor offset"	index _ 1.].(n = 'D4') ifTrue: [	pin _ 16r0200.			"b0000 0010 0000 0000"	offset _ SvCalib at:(6).	" Servomotor offset"	index _ 2.].(n = 'D7') ifTrue: [	pin _ 16r0400.			"b0000 0100 0000 0000"	offset _ SvCalib at:(7).	" Servomotor offset"	index _ 3.].(n = 'D8') ifTrue: [	pin _ 16r0600.			"b0000 0110 0000 0000"	offset _ SvCalib at:(8).	" Servomotor offset"	index _ 4.].(n = 'D9') ifTrue: [	pin _ 16r0800.			"b0000 1000 0000 0000"	offset _ SvCalib at:(1).	" Servomotor offset"	index _ 5.	(SvSentAlready at:index) ifTrue: [	] ifFalse: [		SvSentAlready at:index put:true.	].].(n = 'D10') ifTrue: [	pin _ 16r0A00.			"b0000 1010 0000 0000"	offset _ SvCalib at:(2).	" Servomotor offset"	index _ 6.].(n = 'D11') ifTrue: [	pin _ 16r0C00.			"b0000 1100 0000 0000"	offset _ SvCalib at:(3).	" Servomotor offset"	index _ 7.].(n = 'D12') ifTrue: [	pin _ 16r0E00.			"b0000 1110 0000 0000"	offset _ SvCalib at:(4).	" Servomotor offset"	index _ 8.].ival _ d asNumber.ival _ ival + offset.	" Calibration "(ival >= 180)  ifTrue: [ ival _ 180. ].(ival <= 0)	 ifTrue: [ ival _ 0.   ].ServomotorSynchroMotion ifTrue: [ SvDegreeTemp at:index put:ival. ]ifFalse: [	SvDegreeTemp at:index put:ival. 	SvDegree at:index put:ival.].ival _ pin + ival rounded.	]	ifFalse: [		svPort _ #(D5 D6 D9 D10 D11).		index _ svPort asOrderedCollection find: n.		ival _ ((index - 1) bitShift: 9) + d.].^sb data:ival msgID:mid.! !!ScriptableScratchMorph methodsFor: 'motor ops' stamp: 'KK 8/29/2013 12:35'!motorNo:n onOff:s"Set On/Off the DC motor selected"| stage sb mid ival |(stage := self ownerThatIsA: ScratchStageMorph) ifNil: [^0].sb _ stage sensorBoard."sb tryToOpenPort ifFalse:[^0]."(n = 'M1') ifTrue: [ mid _ 0. ].(n = 'M2') ifTrue: [ mid _ 1. ].(s = 'on') ifTrue: [ ival _ 1. ].(s = 'off') ifTrue: [ ival _ 0. ].^sb data:ival msgID:mid.! !!ScriptableScratchMorph methodsFor: 'motor ops' stamp: 'KK 4/21/2015 15:08'!motorNo:n power: p"Set Power the DC motor selected"| stage sb mid ival tmp ratio |"Check argument."n = '' ifTrue: [^0].(stage := self ownerThatIsA: ScratchStageMorph) ifNil: [^0].sb _ stage sensorBoard."sb tryToOpenPort ifFalse:[^0]."mid _ 0.		" 0: DC Motor ID "(n = 'M1') ifTrue: [	ratio _ (DCCalib at:1) / 100.0.	tmp _ 16r0400.		"b0000 0100 0000 0000"].(n = 'M2') ifTrue: [	ratio _ (DCCalib at:2) / 100.0.	tmp _ 16r0C00.		"b0000 1100 0000 0000"].ival _ (p asNumber) * ratio.(ival >= 100)  ifTrue: [ ival _ 100. ].(ival <= 0)	 ifTrue: [ ival _ 0.   ].ival _ tmp + (ival rounded).				"b0000 n100 + val "^sb data:ival msgID:mid.! !!ScriptableScratchMorph methodsFor: 'motor ops' stamp: 'KK 4/24/2014 15:48'!setServoSpeed:s d2:dg2 d4:dg4 d7:dg7 d8:dg8 d9:dg9 d10:dg10 d11:dg11 d12:dg12	"Set degree the servo motor selected"	| stage sb id pin offset ival d mid |Transcript show:'ScriptableScratchMorph::setServoSpeed:d2:d4:d7:d8:d9:d10:d11:d12';cr.	(stage := self ownerThatIsA: ScratchStageMorph) ifNil: [^0].	sb _ stage sensorBoard.	" Set degrees "	mid _ 5.		" Multi servomotors start!! "	ival _ s.	" Set speed "	sb data:ival msgID:mid.	mid _ 1.		" Set servomotor's degree "	3 to: 10 do: [ :index | 		id _ IOPort at:index.	" Get port ID "		id = 2 ifTrue: [			(index = 3) ifTrue: [	" D2 "				pin _ 16r0000.			"b0000 0000 0000 0000"				offset _ SvCalib at:(5).	" Servomotor offset"				d _ dg2.			].			(index = 4) ifTrue: [	" D4 "				pin _ 16r0200.			"b0000 0010 0000 0000"				offset _ SvCalib at:(6).	" Servomotor offset"				d _ dg4.			].			(index = 5) ifTrue: [	" D7 "				pin _ 16r0400.			"b0000 0100 0000 0000"				offset _ SvCalib at:(7).	" Servomotor offset"				d _ dg7.			].			(index = 6) ifTrue: [	" D8 "				pin _ 16r0600.			"b0000 0110 0000 0000"				offset _ SvCalib at:(8).	" Servomotor offset"				d _ dg8.			].			(index = 7) ifTrue: [	" D9 "				pin _ 16r0800.			"b0000 1000 0000 0000"				offset _ SvCalib at:(1).	" Servomotor offset"				d _ dg9.			].			(index = 8) ifTrue: [	" D10 "				pin _ 16r0A00.			"b0000 1010 0000 0000"				offset _ SvCalib at:(2).	" Servomotor offset"				d _ dg10.			].			(index = 9) ifTrue: [	" D11 "				pin _ 16r0C00.			"b0000 1100 0000 0000"				offset _ SvCalib at:(3).	" Servomotor offset"				d _ dg11.			].			(index = 10) ifTrue: [" D12 "				pin _ 16r0E00.			"b0000 1110 0000 0000"				offset _ SvCalib at:(4).	" Servomotor offset"				d _ dg12.			].			" Convert unsigned to singed "			(offset > 127) ifTrue: [				offset _ offset - 256.			].			ival _ d asNumber.			ival _ ival + offset.	" Calibration "			(ival >= 180)  ifTrue: [ ival _ 180. ].			(ival <= 0)	 ifTrue: [ ival _ 0.   ].			ival _ pin + ival rounded.			"Transcript show:'ScriptableScratchMorph:: motorNo:degree:'; show: ival;cr."			sb data:ival msgID:mid.		].	].	mid _ 5.			" Multi servomotors Finish!! "	ival _ 16r0040.	"b0000 0000 0100 0000"	sb data:ival msgID:mid.	(Delay forMilliseconds: 3000 ) wait.! !!ScriptableScratchMorph methodsFor: 'other ops' stamp: 'sk 4/14/2016 15:42'!alhour:h almin:m	| stage sb data |	(stage := self ownerThatIsA: ScratchStageMorph) ifNil: [^0].	sb _ stage sensorBoard.	data _ (16r2000) + (m bitShift: 5) + h.   "subID1: 2"Transcript show: data; cr.	^sb clockDataSend: data subID: 1.! !!ScriptableScratchMorph methodsFor: 'other ops' stamp: 'sk 3/7/2016 18:24'!boardLED:n onOff:s"Set On/Off the LED selected"| stage sb mid ival |"Check argument."n = '' ifTrue: [^0].(stage := self ownerThatIsA: ScratchStageMorph) ifNil: [^0].sb _ stage sensorBoard."sb tryToOpenPort ifFalse:[^0]."mid _ 3.		" 3: LED ID "Transcript show:' board LED'; cr.(n = 'Red(D5)') ifTrue: [ ival _ 16r0040. ].		" b0000 0000 0000 0000 "(n = 'Yellow(D6)') ifTrue: [ ival _ 16r0240. ].		" b0000 0010 0000 0000 "(n = 'Green(D9)') ifTrue: [ ival _ 16r0440. ].		" b0000 0100 0000 0000 "(s = 'off') ifTrue: [ ival _ ival + 16r0000. ].	" b0000 xxx0 0000 0000 "(s = 'on') ifTrue: [ ival _ ival + 16r0100. ].	" b0000 xxx1 0000 0000 "^sb data:ival msgID:mid.! !!ScriptableScratchMorph methodsFor: 'other ops' stamp: 'KK 11/20/2013 18:34'!buzzerPin:n"Set Off the buzzer selected"| stage sb mid ival |"Check argument."n = '' ifTrue: [^0].(stage := self ownerThatIsA: ScratchStageMorph) ifNil: [^0].sb _ stage sensorBoard."sb tryToOpenPort ifFalse:[^0]."mid _ 2.		" 2: Buzzer ID "" set port and buzzer ON "(n = 'A0') ifTrue: [ ival _ 16r0000. ].		" b0000 0000 0000 0000 "(n = 'A1') ifTrue: [ ival _ 16r0200. ].		" b0000 0010 0000 0000 "(n = 'A2') ifTrue: [ ival _ 16r0400. ].		" b0000 0100 0000 0000 "(n = 'A3') ifTrue: [ ival _ 16r0600. ].		" b0000 0110 0000 0000 "(n = 'A4') ifTrue: [ ival _ 16r0800. ].		" b0000 1000 0000 0000 "(n = 'A5') ifTrue: [ ival _ 16r0A00. ].		" b0000 1010 0000 0000 "^sb data:ival msgID:mid.! !!ScriptableScratchMorph methodsFor: 'other ops' stamp: 'sk 8/31/2017 12:02'!buzzerPin:n freq:s"Set frequency the buzzer selected"| stage sb mid ival tmp |"Check argument."n = '' ifTrue: [^0].(stage := self ownerThatIsA: ScratchStageMorph) ifNil: [^0].sb _ stage sensorBoard."sb tryToOpenPort ifFalse:[^0]."mid _ 2.		" 2: Buzzer ID "" set port and buzzer ON "(n = 'A0') ifTrue: [ ival _ 16r0100. ].		" b0000 0001 0000 0000 "(n = 'A1') ifTrue: [ ival _ 16r0300. ].		" b0000 0011 0000 0000 "(n = 'A2') ifTrue: [ ival _ 16r0500. ].		" b0000 0101 0000 0000 "(n = 'A3') ifTrue: [ ival _ 16r0700. ].		" b0000 0111 0000 0000 "(n = 'A4') ifTrue: [ ival _ 16r0900. ].		" b0000 1001 0000 0000 "(n = 'A5') ifTrue: [ ival _ 16r0B00. ].		" b0000 1011 0000 0000 "tmp _ s asNumber.(tmp < 48) ifTrue: [ tmp _ 48. ].(tmp > 108) ifTrue: [ tmp _ 108. ].tmp _ tmp - 24. "For new firmware"ival _ ival + tmp."Transcript show:'ScriptableScratchMorph:: buzzerPin:freq:'; show: ival;cr."^sb data:ival msgID:mid.! !!ScriptableScratchMorph methodsFor: 'other ops' stamp: 'sk 4/25/2016 12:42'!clkBackLight: onoff	| stage sb data |	(stage := self ownerThatIsA: ScratchStageMorph) ifNil: [^0].	sb _ stage sensorBoard.	(onoff = 'on') ifTrue: [data _ 1]	ifFalse: [data _ 0]."	data _ 0.""	data _ (rVal bitShift: 12) + (gVal bitShift: 8) + (16r80) + bVal.""Transcript show: data; cr."	^sb clockOnOff: data.! !!ScriptableScratchMorph methodsFor: 'other ops' stamp: 'sk 4/15/2016 20:03'!clkBackLightOff	| stage sb data |	(stage := self ownerThatIsA: ScratchStageMorph) ifNil: [^0].	sb _ stage sensorBoard.	data _ 0."	data _ (rVal bitShift: 12) + (gVal bitShift: 8) + (16r80) + bVal."Transcript show: data; cr.	^sb clockDataSend: data subID: 1.! !!ScriptableScratchMorph methodsFor: 'other ops' stamp: 'sk 2/22/2016 10:07'!clkBuzzerOFF! !!ScriptableScratchMorph methodsFor: 'other ops' stamp: 'sk 4/11/2016 22:18'!clkBuzzerOff| mid ival sb stage |(stage := self ownerThatIsA: ScratchStageMorph) ifNil: [^0].sb _ stage sensorBoard.mid _ 2.		" 2: Buzzer ID "" set port and buzzer ON "ival _ 16r0040.	" b0000 0000 0100 0000 "^sb data:ival msgID:mid.! !!ScriptableScratchMorph methodsFor: 'other ops' stamp: 'sk 4/11/2016 22:20'!clkBuzzerOnFreq: frequency| stage sb mid ival tmp |"Check argument.""n = '' ifTrue: [^0]."(stage := self ownerThatIsA: ScratchStageMorph) ifNil: [^0].sb _ stage sensorBoard."sb tryToOpenPort ifFalse:[^0]."mid _ 2.		" 2: Buzzer ID "" set port and buzzer ON "ival _ 16r0100.	" b0000 0001 0000 0000 "tmp _ frequency asNumber.tmp _ tmp - 48.(tmp > 47) & (tmp < 109) ifTrue: [ tmp _ 0. ].ival _ ival + tmp."Transcript show:'ScriptableScratchMorph:: buzzerPin:freq:'; show: ival;cr."^sb data:ival msgID:mid.! !!ScriptableScratchMorph methodsFor: 'other ops' stamp: 'sk 4/25/2016 18:27'!clkBuzzerOnFreq: frequency For: duration elapsed: elapsed from: ignored| stage sb |"Check argument.""n = '' ifTrue: [^0]."(stage := self ownerThatIsA: ScratchStageMorph) ifNil: [^0].sb _ stage sensorBoard.^sb clockBuzzer: frequency For: duration! !!ScriptableScratchMorph methodsFor: 'other ops' stamp: 'KK 9/6/2017 09:57'!doSvmSyncMotion: delay"Set Off the buzzer selected"	| mid ival sb stage temp|	(stage := self ownerThatIsA: ScratchStageMorph) ifNil: [^0.].	sb _ stage sensorBoard.	delay >= 0.0		ifTrue: [temp _ (delay + 0.5) truncated]		ifFalse: [temp _ (delay - 0.5) truncated].	(ServomotorSynchroMotion) ifTrue: [		(temp < 0) ifTrue: [			" Servomotors' synchro motion end. "			mid _ 5.			" Multi servomotors Finish!! "			ival _ 16r0040.	"b0000 0000 0100 0000"			sb data:ival msgID:mid.			ServomotorSynchroMotion _ false.		].	] ifFalse: [		" floor "		(temp < 0) ifTrue: [			temp _ 0.		].		" ceil "		(temp > 20) ifTrue: [			temp _ 20.		].		" Servomotors' synchro motion start. "		mid _ 5.			" Multi servomotors start!! "		ival _ temp + 3.	" Set speed "		sb data:ival msgID:mid.		ServomotorSynchroMotion _ true.		DelayMsecPerDeg _ temp + 3."		1 to: 8 do: [:index |			SvSentAlready at: index put: false.		].	"	].! !!ScriptableScratchMorph methodsFor: 'other ops' stamp: 'sk 4/14/2016 15:06'!hour:h min:m	| stage sb data |	(stage := self ownerThatIsA: ScratchStageMorph) ifNil: [^0].	sb _ stage sensorBoard.	data _ (16r1000) + (m bitShift: 5) + h.Transcript show: data; cr.	^sb clockDataSend: data subID: 1.! !!ScriptableScratchMorph methodsFor: 'other ops' stamp: 'KK 9/11/2013 12:52'!ledColor:n onOff:s"Set On/Off the LED selected"| stage sb mid ival p |(stage := self ownerThatIsA: ScratchStageMorph) ifNil: [^0].sb _ stage sensorBoard."sb tryToOpenPort ifFalse:[^0]."mid _ 5.		" 5: Color LED ID "(n = 'White') ifTrue: [ ival _ 16r0000. ].		" b0000 0000 0000 0000 "(n = 'Red') ifTrue: [ ival _ 16r0200. ].		" b0000 0010 0000 0000 "(n = 'Green') ifTrue: [ ival _ 16r0400. ].		" b0000 0100 0000 0000 "(n = 'Blue') ifTrue: [ ival _ 16r0600. ].		" b0000 0110 0000 0000 "(n = 'Cyan') ifTrue: [ ival _ 16r0800. ].		" b0000 1000 0000 0000 "(n = 'Magenta') ifTrue: [ ival _ 16r0A00. ].	" b0000 1010 0000 0000 "(n = 'Yellow') ifTrue: [ ival _ 16r0C00. ].		" b0000 1100 0000 0000 "(s = 'off') ifTrue: [ ival _ ival + 16r0000. ].	" b0000 xxx0 0000 0000 "(s = 'on') ifTrue: [ ival _ ival + 16r0100. ].	" b0000 xxx1 0000 0000 "" check connected port. "p _ IOPort at:11.(p = 5) ifTrue: [ " A0, A1, A2 ""Transcript show:'A0 : '; show: ival; cr."	^sb data:ival msgID:mid.] ifFalse: [	p _ IOPort at: 14.	(p = 5) ifTrue: [ " A1, A2, A3 "		ival _ ival + 16r0001."Transcript show:'A1 : '; show: ival; cr."		^sb data:ival msgID:mid.	]]! !!ScriptableScratchMorph methodsFor: 'other ops' stamp: 'sk 4/15/2016 19:55'!ledPin:n onOff:s"Set On/Off the LED selected"| stage sb mid ival |"Check argument."n = '' ifTrue: [^0].(stage := self ownerThatIsA: ScratchStageMorph) ifNil: [^0].sb _ stage sensorBoard."sb tryToOpenPort ifFalse:[^0]."mid _ 3.		" 3: LED ID "(n = 'A0') ifTrue: [ ival _ 16r0000. ].		" b0000 0000 0000 0000 "(n = 'A1') ifTrue: [ ival _ 16r0200. ].		" b0000 0010 0000 0000 "(n = 'A2') ifTrue: [ ival _ 16r0400. ].		" b0000 0100 0000 0000 "(n = 'A3') ifTrue: [ ival _ 16r0600. ].		" b0000 0110 0000 0000 "(n = 'A4') ifTrue: [ ival _ 16r0800. ].		" b0000 1000 0000 0000 "(n = 'A5') ifTrue: [ ival _ 16r0A00. ].		" b0000 1010 0000 0000 "(s = 'off') ifTrue: [ ival _ ival + 16r0000. ].	" b0000 xxx0 0000 0000 "(s = 'on') ifTrue: [ ival _ ival + 16r0100. ].	" b0000 xxx1 0000 0000 "^sb data:ival msgID:mid.! !!ScriptableScratchMorph methodsFor: 'other ops' stamp: 'KK 9/28/2013 13:54'!mathFunctionNames	"Answer a collection of math function names."	^ #(		'abs'		'sqrt'		'sin'		'cos'		'tan'"		'asin'		'acos'		'atan'"		'ln'		'log'		'e ^'		'10 ^')! !!ScriptableScratchMorph methodsFor: 'other ops' stamp: 'sk 4/15/2016 19:52'!month:m day:d year:y	| stage sb data |	(stage := self ownerThatIsA: ScratchStageMorph) ifNil: [^0].	sb _ stage sensorBoard.	data _ (m bitShift: 12) + ((y - 2000) bitShift: 5)  + d.Transcript show: data; cr.	^sb clockDataSend: data subID: 0.! !!ScriptableScratchMorph methodsFor: 'other ops' stamp: 'KK 8/29/2013 12:36'!pinNo:n onOff:s"Set On/Off the LED selected"| stage sb mid ival |(stage := self ownerThatIsA: ScratchStageMorph) ifNil: [^0].sb _ stage sensorBoard."sb tryToOpenPort ifFalse:[^0]."self halt.mid _ 3.		" 3: LED ID "(n = 'A0') ifTrue: [ ival _ 16r0000. ].		" b0000 0000 0000 0000 "(n = 'A1') ifTrue: [ ival _ 16r0200. ].		" b0000 0010 0000 0000 "(n = 'A2') ifTrue: [ ival _ 16r0400. ].		" b0000 0100 0000 0000 "(n = 'A3') ifTrue: [ ival _ 16r0600. ].		" b0000 0110 0000 0000 "(n = 'A4') ifTrue: [ ival _ 16r0800. ].		" b0000 1000 0000 0000 "(n = 'A5') ifTrue: [ ival _ 16r0A00. ].		" b0000 1010 0000 0000 "(s = 'off.') ifTrue: [ ival _ ival + 16r0000. ].	" b0000 xxx0 0000 0000 "(s = 'on.') ifTrue: [ ival _ ival + 16r0100. ].	" b0000 xxx1 0000 0000 "^sb data:ival msgID:mid.! !!ScriptableScratchMorph methodsFor: 'other ops' stamp: 'sk 1/23/2017 09:54'!randomFrom: start to: stop	"Answer a random number within the given range. If both min and max are integers, the result is rounded to the nearest integer."	| min max result |	min _ (start min: stop) truncated.	max _ (start max: stop) truncated.	result _ (RandomGen next * (max - min)) + min.	min isInteger & max isInteger		ifTrue: [result _ (RandomGen next * ((max + 1) - min)) truncated + min]		ifFalse: [result _ (RandomGen next * (max - min)) + min].	^ result! !!ScriptableScratchMorph methodsFor: 'other ops' stamp: 'sk 4/25/2016 12:37'!red: rVal green: gVal blue: bVal	| stage sb |	(stage := self ownerThatIsA: ScratchStageMorph) ifNil: [^0].	sb _ stage sensorBoard."	data _ (16r8000) + (gVal bitShift: 8) + (rVal bitShift: 4)  + bVal.""	data _ (rVal bitShift: 12) + (gVal bitShift: 8) + (16r80) + bVal.""Transcript show: data; cr.""	^sb clockDataSend: data subID: 1."	^sb clockR: rVal G: gVal B: bVal.! !!ScriptableScratchMorph methodsFor: 'other ops' stamp: 'KK 9/25/2017 18:36'!sensorPartsName0123	"Answer a collection of A0-A3 connectable parts name."	^ #(		'Light sensor'		'IR photoreflector'		'Temperature sensor'		)! !!ScriptableScratchMorph methodsFor: 'other ops' stamp: 'KK 3/3/2015 19:20'!sensorPartsName23WithOption	"Answer a collection of A0-A3 connectable parts name."	^ #(		'Light sensor'		'Touch sensor'		'Sound sensor'		'IR photoreflector'		'LED'		'Buzzer'		'Temperature sensor'		'Infrared receiver'		'Bluetooth'		)! !!ScriptableScratchMorph methodsFor: 'other ops' stamp: 'KK 3/3/2015 20:18'!sensorPartsName45	"Answer a collection of A4,A5 connectable parts name."	^ #(		'Light sensor'		'Touch sensor'		'Sound sensor'		'IR photoreflector'		'Accelerometer'		'LED'		'Buzzer'		)! !!ScriptableScratchMorph methodsFor: 'other ops' stamp: 'KK 3/3/2015 19:20'!sensorPartsName45WithOption	"Answer a collection of A0-A3 connectable parts name."	^ #(		'Light sensor'		'Touch sensor'		'Sound sensor'		'IR photoreflector'		'Accelerometer'		'LED'		'Buzzer'		'Temperature sensor'		'Infrared receiver'		'Gyro sensor'		'Color sensor'		'Bluetooth'		)! !!ScriptableScratchMorph methodsFor: 'other ops' stamp: 'KK 3/3/2015 20:18'!sensorPartsName67	"Answer a collection of A6,A7 connectable parts name."	^ #(		'Light sensor'		'Sound sensor'		'IR photoreflector'		)! !!ScriptableScratchMorph methodsFor: 'other ops' stamp: 'KK 3/3/2015 20:15'!sensorPartsName67WithOption	"Answer a collection of A6,A7 connectable parts name."	^ #(		'Light sensor'		'Sound sensor'		'IR photoreflector'		'Temperature sensor'		'Bluetooth'		)! !!ScriptableScratchMorph methodsFor: 'other ops' stamp: 'KK 3/6/2015 13:44'!sensorPartsNameA01IR: ir bluetooth: bt	| myOrderedCollection |	"Answer a collection of A0-A1 connectable parts name."	" ir : true(selected) / false(not select) "	" bt : true(selected) / false(not select) "	myOrderedCollection _ OrderedCollection new.	myOrderedCollection add: 'Light sensor';		add: 'Touch sensor';		add: 'Sound sensor';		add: 'IR photoreflector';		add: 'LED';		add: 'Buzzer';		add: 'Temperature sensor';		add: 'Ultrasonic sensor'.	ir ifFalse: [ myOrderedCollection add: 'Infrared receiver' ].	bt ifFalse: [ myOrderedCollection add: 'Bluetooth' ].	^ myOrderedCollection.! !!ScriptableScratchMorph methodsFor: 'other ops' stamp: 'KK 3/6/2015 13:46'!sensorPartsNameA23IR: ir bluetooth: bt	| myOrderedCollection |	"Answer a collection of A0-A1 connectable parts name."	" ir : true(selected) / false(not select) "	" bt : true(selected) / false(not select) "	myOrderedCollection _ OrderedCollection new.	myOrderedCollection add: 'Light sensor';		add: 'Touch sensor';		add: 'Sound sensor';		add: 'IR photoreflector';		add: 'LED';		add: 'Buzzer';		add: 'Temperature sensor'.	ir ifFalse: [ myOrderedCollection add: 'Infrared receiver' ].	bt ifFalse: [ myOrderedCollection add: 'Bluetooth' ].	^ myOrderedCollection.! !!ScriptableScratchMorph methodsFor: 'other ops' stamp: 'KK 3/6/2015 15:38'!sensorPartsNameA45IR: ir bluetooth: bt	| myOrderedCollection |	"Answer a collection of A0-A1 connectable parts name."	" ir : true(selected) / false(not select) "	" bt : true(selected) / false(not select) "	myOrderedCollection _ OrderedCollection new.	myOrderedCollection add: 'Light sensor';		add: 'Touch sensor';		add: 'Sound sensor';		add: 'IR photoreflector';		add: 'Accelerometer';		add: 'LED';		add: 'Buzzer';		add: 'Temperature sensor';		add: 'Gyro sensor';		add: 'Color sensor'.	ir ifFalse: [ myOrderedCollection add: 'Infrared receiver' ].	bt ifFalse: [ myOrderedCollection add: 'Bluetooth' ].	^ myOrderedCollection.! !!ScriptableScratchMorph methodsFor: 'other ops' stamp: 'KK 3/6/2015 15:39'!sensorPartsNameA67IR: ir bluetooth: bt	| myOrderedCollection |	"Answer a collection of A0-A1 connectable parts name."	" ir : true(selected) / false(not select) "	" bt : true(selected) / false(not select) "	myOrderedCollection _ OrderedCollection new.	myOrderedCollection add: 'Light sensor';		add: 'Touch sensor';		add: 'Sound sensor';		add: 'IR photoreflector';		add: 'Temperature sensor'.	bt ifFalse: [ myOrderedCollection add: 'Bluetooth' ].	^ myOrderedCollection.! !!ScriptableScratchMorph methodsFor: 'other ops' stamp: 'KK 4/30/2014 17:45'!wait: duration elapsed: elapsed from: ignored	"Do nothing; just wait for the time interval to elapse."	^ nil! !!ScriptableScratchMorph methodsFor: 'other ops' stamp: 'sk 2/18/2016 11:50'!year:y month:m day:d! !!ScriptableScratchMorph methodsFor: 'variables' stamp: 'sk 2/22/2017 10:56'!addGlobalVariable	"Ask the user for a variable name, then add a background (global) variable of that name."	| sFrame varName |	(sFrame _ self ownerThatIsA: ScratchFrameMorph) ifNil: [^ self beep].	ValueOrList _ true.	TabletMode ifTrue: [		sFrame sendMessageToBMnoBlocking: 'SHOWKEYPAD'].	varName _ StringDialog ask: 'Variable name?(Only alphanumeric characters are allowed)'.	TabletMode ifTrue: [		sFrame sendMessageToBMnoBlocking: 'HIDEKEYPAD'].	varName size = 0 ifTrue: [^ self].	varName _ varName asUTF8.	(sFrame workPane variableNameInUse: varName) ifTrue: [		self beep.		DialogBoxMorph warn: 'That variable name is already in use'.		^ self].	sFrame workPane addVariable: varName.	sFrame viewerPane categoryChanged: 'variables'.	self addWatcherForNewVariable: varName withScope: sFrame workPane.! !!ScriptableScratchMorph methodsFor: 'variables' stamp: 'KK 9/18/2013 19:17'!addVariable: varName	"Add a new user variable with the given name to this object. Do nothing if the variable already exists or is built in."	(vars includesKey: varName asString) ifFalse: [		vars at: varName asString put: 0].	self isClone: false.! !!ScriptableScratchMorph methodsFor: 'scripts' stamp: 'KK 12/10/2014 13:22'!addStack: aBlockStack	"Aligns the newly added script below the lowest script in the pane."	| y bottom |	y _ 10.	blocksBin submorphsDo: [:m |		bottom _  (m fullBounds bottom) - (blocksBin position y).		(bottom > y) ifTrue: 			[y _ bottom]].	aBlockStack position: blocksBin position + (20@(y+10)).	aBlockStack newScriptOwner: self.	blocksBin addMorph: aBlockStack.! !!ScriptableScratchMorph methodsFor: 'blocks' stamp: 'KK 9/18/2013 19:30'!addGenericVariableBlocksTo: page x: x y: startY	"Add the generic variable blocks to the given page starting at the given y offset. Answer the new y."	| y vName stage block varBlocks |	y _ startY.	"pick a default variable name"	vName _ nil.	stage _ self ownerThatIsA: ScratchStageMorph.	(stage notNil and: [stage varNames size > 0])		ifTrue: [			vName _ stage varNames first]		ifFalse: [			self varNames size = 0 ifTrue: [^ y].			vName _ self varNames first].	varBlocks _ OrderedCollection new.	block _ SetterBlockMorph new		initSetterForVar: vName;		receiver: self blockReceiver.	block expressionArg numExpression: '0'.	varBlocks add: block.	block _ SetterBlockMorph new		initChangerForVar: vName;		receiver: self blockReceiver.	block expressionArg numExpression: '1'.	varBlocks add: block.	(self blocksFor: 'variables') do: [:b |		b defaultArgs: (Array with: vName).		varBlocks add: b].	varBlocks do: [:b |		b color: self variableBlockColor.		page addMorph: (b position: x@y).		y _ b bottom + 3].	^ y! !!ScriptableScratchMorph methodsFor: 'blocks' stamp: 'KK 8/30/2013 20:15'!blockCategories	"Answer a list of block categories."	^ (self class blockSpecs select: [:el |		(el isKindOf: String) and: [el ~= '-' and: [el ~= '~']]]) asArray! !!ScriptableScratchMorph methodsFor: 'blocks' stamp: 'sk 4/27/2016 21:20'!blockFromSpec: spec color: blockColor	"Create a block from the given block specification. Answer nil if I don't implement the block spec selector."	| blockLabelSpec blockType selector defaultArgs block rcvr argPermutation dispBlockColor isDetect offset partsID invalidR invalidG invalidB |	invalidR _ 0.6.	invalidG _ 0.6.	invalidB _ 0.6.	blockLabelSpec _ ScratchTranslator translationFor: (spec at: 1).	argPermutation _ CommandBlockMorph argPermutationForSpec: (spec at: 1) withTranslation: blockLabelSpec.	blockType _ spec at: 2.	selector _ (spec at: 3) asSymbol.	defaultArgs _ self defaultArgsFor: spec.	dispBlockColor _ blockColor.	((defaultArgs size ~= 0) & (#doBroadcastAndWait ~= selector)) ifTrue: [		((defaultArgs at: 1) = '') ifTrue: [			dispBlockColor _ (Color r: invalidR g: invalidG b: invalidB).		]	].	(BoardType = 1) ifTrue: [	" Clock's validity check. "	((IOPort at: 19) ~= 6) ifTrue: [		(#hour:min: = selector) ifTrue: [			dispBlockColor _ (Color r: invalidR g: invalidG b: invalidB).].		(#month:day:year: = selector) ifTrue: [			dispBlockColor _ (Color r: invalidR g: invalidG b: invalidB).].		(#alhour:almin: = selector) ifTrue: [			dispBlockColor _ (Color r: invalidR g: invalidG b: invalidB).].		(#red:green:blue: = selector) ifTrue: [			dispBlockColor _ (Color r: invalidR g: invalidG b: invalidB).].		(#clkBackLight: = selector) ifTrue: [			dispBlockColor _ (Color r: invalidR g: invalidG b: invalidB).].		(#clkBuzzerOnFreq:For:elapsed:from: = selector) ifTrue: [			dispBlockColor _ (Color r: invalidR g: invalidG b: invalidB).].		(#clkBuzzerOff = selector) ifTrue: [			dispBlockColor _ (Color r: invalidR g: invalidG b: invalidB).].		(#clockValue: = selector) ifTrue: [			dispBlockColor _ (Color r: invalidR g: invalidG b: invalidB).].		(#isInAlarm = selector) ifTrue: [			dispBlockColor _ (Color r: invalidR g: invalidG b: invalidB).].].].	" Color LED is used ? "	(#ledColor:onOff: = selector) ifTrue: [		isDetect _ false.			" detect buzzer? "		offset _ 10.				" 1-2:DC 3-10:SV 11-18:Sensor "		partsID _ 16r05.			" 01:DC 02:SV 03:LED 04:BZR 05:CLED 10:LS 11:TS 12:SS 13:IRS 14:3S 15:BTN"		1 to: 4 do: [ :index |			(((IOPort at: (index+offset)) = partsID) & (isDetect = false)) ifTrue: [				isDetect _ true.			]		].		isDetect = false ifTrue: [			dispBlockColor _ (Color r: invalidR g: invalidG b: invalidB).		].	].	(#(E K M S W) includes: blockType) ifTrue: [		^ (self hatBlockType: blockType) color: blockColor].	"basic block type: normal or C-shaped"	(blockType includes: $c)		ifTrue:	[			selector = #doIfElse				ifTrue: [block _ IfElseBlockMorph new isSpecialForm: true]				ifFalse: [block _ CBlockMorph new isSpecialForm: true]]		ifFalse:	[			(blockType includes: $r) | (blockType includes: $b)				ifTrue: [block _ ReporterBlockMorph new]				ifFalse: [block _ CommandBlockMorph new]].	(blockType includes: $b) ifTrue: [block isBoolean: true].	(blockType includes: $s) ifTrue: [block isSpecialForm: true].	(blockType includes: $t) ifTrue: [block isTimed: true].	(ScriptableScratchMorph isSpriteSpecificTarget: self selector: selector)		ifTrue: [rcvr _ self]		ifFalse: [rcvr _ self ownerThatIsA: ScratchStageMorph].	^ block		argPermutation: argPermutation;"		color: blockColor;"		color: dispBlockColor;		selector: selector;		commandSpec: blockLabelSpec;		defaultArgs: defaultArgs;		receiver: rcvr! !!ScriptableScratchMorph methodsFor: 'blocks' stamp: 'KK 9/18/2013 19:01'!blockFromTuple: tuple receiver: scriptOwner	"Answer a new block for the given tuple."	| k spec blockColor block argCount arg argBlock |"Transcript show:'[ScriptableScratchMorph::blockFromTuple:receiver:]';cr."	k _ tuple first.	(#(readVariable changeVariable) includes: k) ifTrue: [		^ self variableBlockFromTuple: tuple receiver: scriptOwner].	#contentsOfList: = k ifTrue: [		^ ListContentsBlockMorph new			color: ScriptableScratchMorph listBlockColor;			receiver: scriptOwner;			commandSpec: tuple second;			selector: #contentsOfList:].	(#(EventHatMorph KeyEventHatMorph MouseClickEventHatMorph WhenHatBlockMorph) includes: k) ifTrue: [		block _ self hatBlockFromTuple: tuple receiver: scriptOwner.		(block isKindOf: WhenHatBlockMorph) ifTrue: [block color: Color red].		^ block].	#scratchComment = k ifTrue: [		block _ ScratchCommentMorph new.		tuple size > 1 ifTrue: [block commentMorph contents: (tuple at: 2)].		tuple size > 2 ifTrue: [(tuple at: 3) ifFalse: [block toggleShowing]].		tuple size > 3 ifTrue: [block width: (tuple at: 4)].		tuple size > 4 ifTrue: [block anchor: (self blockWithID: (tuple at: 5))].		^ block].	#comment: = k ifTrue: [		block _ CommentBlockMorph new.		tuple size > 1 ifTrue: [block comment: (tuple at: 2)].		tuple size > 2 ifTrue: [(tuple at: 3) ifFalse: [block toggleShowing]].		block color: (Color r: 0.8 g: 0 b: 0).  "obsolete"		^ block]."Transcript show:'[ScriptableScratchMorph::blockFromTuple:receiver:]';cr.Transcript show:BlockSpecDict;cr."	spec _ BlockSpecDict at: k ifAbsent: [nil].	spec ifNil: ["Transcript show:'[ScriptableScratchMorph::blockFromTuple:receiver:] spec ifNill';cr."		^ scriptOwner			blockFromSpec: #('obsolete!!' - yourself)			color: Color red].	blockColor _ BlockColorDict at: k ifAbsent: [Color red].	block _ scriptOwner blockFromSpec: spec color: blockColor.	(block isKindOf: CommandBlockMorph) ifTrue: [		argCount _ block argumentCount min: tuple size - 1.		1 to: argCount do: [:i |			((#(+ - / * =) includes: block selector) and: [ScratchTranslator isRTLMath]) "RTLMath operators are RTL"				ifTrue: [arg _ tuple at: ((argCount + 1) - (i - 1))]				ifFalse: [arg _ tuple at: i + 1].			(arg isKindOf: Array)				ifTrue: [  "argument is a block"					((arg size = 1) and: [arg first isKindOf: Array]) ifTrue: [arg _ arg first].					argBlock _ self blockFromTuple: arg receiver: scriptOwner.					block replaceArgMorph: (block argumentAt: i) by: argBlock]				ifFalse: [  "argument is a value"					(block argumentAt: i) defaultValue: arg]].		(block isKindOf: CBlockMorph) ifTrue: [			(tuple last isKindOf: Array) ifTrue: [				block firstBlockList: (self stackFromTupleList: tuple last receiver: scriptOwner)]].		(block isKindOf: IfElseBlockMorph) ifTrue: [			arg _ tuple at: tuple size - 1.			(arg isKindOf: Array) ifTrue: [				block trueBlock: (self stackFromTupleList: arg receiver: scriptOwner)].			arg _ tuple at: tuple size.			(arg isKindOf: Array) ifTrue: [				block falseBlock: (self stackFromTupleList: arg receiver: scriptOwner)]].		(block isKindOf: ReporterBlockMorph) ifTrue: ["Transcript show:'[ScriptableScratchMorph::blockFromTuple:receiver:] ReporterBlockMorph';cr.Transcript show:'[ScriptableScratchMorph::blockFromTuple:receiver:] '; show: spec;cr."			((spec at: 2) includes: $b) ifTrue: [block isBoolean: true]]].	^ block! !!ScriptableScratchMorph methodsFor: 'blocks' stamp: 'KK 8/28/2013 20:30'!blockSpecForSelector: aSymbol	"Answer a block specification string (in English) for the give selector or nil if there is no spec that has the given selector."	self class blockSpecs do: [:spec |		((spec isKindOf: Array) and: [(spec at: 3) = aSymbol])			ifTrue: [^ spec first]].	^ nil! !!ScriptableScratchMorph methodsFor: 'blocks' stamp: 'sk 3/8/2016 13:53'!checkBlockValidity: spec	| blockType selector defaultArgs |	"Answer a copy of me for exporting."	blockType _ spec at: 2.	selector _ (spec at: 3) asSymbol.	defaultArgs _ self defaultArgsFor: spec.	((defaultArgs size ~= 0) & (#hour:min: = selector)) ifTrue: [		((IOPort at: 19) = 6) ifTrue: [Transcript show: 'hoge'; cr.			^ false.		]	].! !!ScriptableScratchMorph methodsFor: 'blocks' stamp: 'KK 9/28/2017 08:27'!commonViewerPageForMotion: bin ypos: yp	"Answer a morph containing mtion blocks for the given category for use in the given ScratchViewer."	| isStage addMotorBlocks s x y |	(self isKindOf: ScratchStageMorph)		ifTrue: [			isStage _ true.			addMotorBlocks _ self showMotorBlocks]		ifFalse: [			isStage _ false.			s _ self ownerThatIsA: ScratchStageMorph.			addMotorBlocks _ s notNil and: [s showMotorBlocks]].	addMotorBlocks _ true.	(isStage & addMotorBlocks not) ifTrue: [ ^ bin ].	x _ 12.	y _ yp.	(self blocksFor: 'motion') do: [:blockOrSym |		(blockOrSym = #-) | (blockOrSym = #~)			ifTrue: [				(blockOrSym = #-) ifTrue: [y _ y + 15].  "insert a full space"				(blockOrSym = #~) ifTrue: [y _ y + 5]]  "insert a half space"			ifFalse: [				y _ self createBlock: blockOrSym atPosition: x@y onPage: bin]].	addMotorBlocks ifFalse: [^ bin].	isStage ifFalse: [		y _ y + 7.		bin addMorph: ((ImageMorph new form: (ScratchFrameMorph skinAt: #connector)) position: x@y).		y _ y + 20].	(self blocksFor: 'motor') do: [:blockOrSym |		(blockOrSym = #-) | (blockOrSym = #~)			ifTrue: [				(blockOrSym = #-) ifTrue: [y _ y + 15].  "insert a full space"				(blockOrSym = #~) ifTrue: [y _ y + 5]]  "insert a half space"			ifFalse: [				y _ self createBlock: blockOrSym atPosition: x@y onPage: bin]].	" Only for Studuino mini "	(BoardType = 1) ifTrue: [		(self blocksFor: 'motion mini') do: [:blockOrSym |			(blockOrSym = #-) | (blockOrSym = #~)				ifTrue: [					(blockOrSym = #-) ifTrue: [y _ y + 15].  "insert a full space"					(blockOrSym = #~) ifTrue: [y _ y + 5]]  "insert a half space"				ifFalse: [					y _ self createBlock: blockOrSym atPosition: x@y onPage: bin]].].	^ y! !!ScriptableScratchMorph methodsFor: 'blocks' stamp: 'KK 9/28/2017 08:32'!commonViewerPageForSensing: bin ypos: yp	"Answer a morph containing mtion blocks for the given category for use in the given ScratchViewer."	| x y |	x _ 12.	y _ yp.	(self blocksFor: 'sensing') do: [:blockOrSym |		(blockOrSym = #-) | (blockOrSym = #~)			ifTrue: [				(blockOrSym = #-) ifTrue:[y _ y + 15]. "insert a full space"				(blockOrSym = #~) ifTrue: [					y _ y + 7.					bin addMorph: ((ImageMorph new form: (ScratchFrameMorph skinAt: #connector)) position: x@y).					y _ y + 20]]			ifFalse: [				y _ self createBlock: blockOrSym atPosition: x@y onPage: bin]].	" Only for Studuino mini "	(BoardType = 1) ifTrue: [		(self blocksFor: 'sensing mini') do: [:blockOrSym |			(blockOrSym = #-) | (blockOrSym = #~)				ifTrue: [					(blockOrSym = #-) ifTrue:[y _ y + 15]. "insert a full space"					(blockOrSym = #~) ifTrue: [						y _ y + 7.						bin addMorph: ((ImageMorph new form: (ScratchFrameMorph skinAt: #connector)) position: x@y).						y _ y + 20]]				ifFalse: [					y _ self createBlock: blockOrSym atPosition: x@y onPage: bin]].].	^ y! !!ScriptableScratchMorph methodsFor: 'blocks' stamp: 'KK 12/10/2014 11:47'!convertStacksToTuples	"Convert my blocks bin from a morph containing block stack into a collection of (<point>, <tuple>) pairs the represent the same stacks in compact, language-independent form."	| stacks blocks comments |	(blocksBin isKindOf: Array) ifTrue: [^ self].  "already converted"	stacks _ (blocksBin submorphs select: [:m | m respondsTo: #tupleSequence]).	blocks _ stacks select: [:m | m isKindOf: BlockMorph].	comments _ stacks select: [:m | m isKindOf: ScratchCommentMorph].	blocks _ blocks collect: [:blockM |		Array			with: blockM position - blocksBin position			with: blockM tupleSequence].	comments _ comments collect: [:blockM |		Array			with: blockM position - blocksBin position			with: blockM tupleSequence].	blocksBin _ blocks, comments.! !!ScriptableScratchMorph methodsFor: 'blocks' stamp: 'KK 9/23/2013 16:44'!convertTuplesToStacks	"Convert my blocks bin from a collection of (<point>, <tuple>) pairs into a morph containing a number of block stacks."	| tuplesList stack |	(blocksBin isKindOf: Array) ifFalse: [^ self].  "already converted"	tuplesList _ blocksBin.ConvertTuplesToStacks _ true.	blocksBin _ ScratchScriptsMorph new.	tuplesList do: [:pair |		stack _ self stackFromTupleList: pair second receiver: self.		stack position: pair first.		blocksBin addMorph: stack].! !!ScriptableScratchMorph methodsFor: 'blocks' stamp: 'KK 8/29/2013 16:41'!createBlock: block atPosition: pos onPage: page	"Creates a block on the given page. If the block is one that can become a watcher, then a toggle button is created as well."	| x y changingX toggleButton yOffset frame |	x _ pos x.	y _ pos y.	changingX _ x.	block canBecomeWatcher ifTrue: [		toggleButton _ self createToggleButtonFor: block.		yOffset _ (block fullBounds height - toggleButton fullBounds height) // 2.		page addMorphBack: (toggleButton position: x@(y+yOffset)).		changingX _ x + toggleButton fullBounds width + 4].	block fixBlockLayout; position: changingX@y.	page addMorphBack: block.	block canBecomeWatcher ifTrue: [		frame _ self ownerThatIsA: ScratchFrameMorph.		page updateWatcherButtonsForFrame: frame].	^ y + block height + 3! !!ScriptableScratchMorph methodsFor: 'blocks' stamp: 'KK 9/23/2013 18:49'!hatBlockType: blockType	| stage evtName |	'E' = blockType ifTrue: [		evtName _ ''.		(stage _ self ownerThatIsA: ScratchStageMorph)			ifNotNil: [evtName _ stage defaultEventName].		^ EventHatMorph new scriptOwner: self; eventName: evtName].	'K' = blockType ifTrue: [^ KeyEventHatMorph new scriptOwner: self].	'M' = blockType ifTrue: [^ MouseClickEventHatMorph new scriptOwner: self].	'S' = blockType ifTrue: [ ^ EventHatMorph new forStartEvent scriptOwner: self].	'W' = blockType ifTrue: [^ WhenHatBlockMorph new scriptOwner: self].! !!ScriptableScratchMorph methodsFor: 'blocks' stamp: 'KK 9/18/2013 19:02'!variableBlockFromTuple: tuple receiver: scriptOwner	"Answer a new block for the given variable reference tuple."	| varName rcvr bg selector block arg argBlock |	varName _ tuple at: 2.	rcvr _ scriptOwner.	(scriptOwner varNames includes: varName) ifFalse: [		bg _ scriptOwner ownerThatIsA: ScratchStageMorph.		bg			ifNil: [scriptOwner addVariable: varName]			ifNotNil: [				bg addVariable: varName.				rcvr _ bg]].	tuple first = #readVariable ifTrue: [		^ VariableBlockMorph new			commandSpec: varName;			receiver: rcvr].	tuple first = #changeVariable ifTrue: [		selector _ tuple at: 3.		"update selector if necessary (backward compatibility):"		(selector = #set:to:) ifTrue: [selector _ #setVar:to:].		block _ SetterBlockMorph new receiver: rcvr.		selector = #setVar:to:			ifTrue: [block initSetterForVar: varName]			ifFalse: [block initChangerForVar: varName].		arg _ tuple at: 4.		(arg isKindOf: Array)			ifTrue: [  "argument is a block"				((arg size = 1) and: [arg first isKindOf: Array]) ifTrue: [arg _ arg first].				argBlock _ self blockFromTuple: arg receiver: scriptOwner.				block replaceArgMorph: block expressionArg by: argBlock]			ifFalse: [ "argument is a value"				block expressionArg defaultValue: arg].		^ block].	self error: 'unknown variable spec'! !!ScriptableScratchMorph methodsFor: 'blocks' stamp: 'KK 9/28/2017 08:41'!viewerPageForCategory: aCategoryName	"Answer a morph containing blocks for the given category for use in the given ScratchViewer."	| bin y x |	bin _ ScratchBlockPaletteMorph new.	y _ 10.	y _ self commonViewerPageForMotion: bin ypos: y.	y _ y + 10.	y _ self commonViewerPageForSensing: bin ypos: y.	x _ 12.	y _ y + 10.	(self blocksFor: 'control') do: [:blockOrSym |		(blockOrSym = #-) | (blockOrSym = #~)			ifTrue: [				(blockOrSym = #-) ifTrue: [y _ y + 15].  "insert a full space"				(blockOrSym = #~) ifTrue: [y _ y + 5]]  "insert a half space"			ifFalse: [				y _ self createBlock: blockOrSym atPosition: x@y onPage: bin]].	x _ 12.	y _ y + 10.	(self blocksFor: 'operators') do: [:blockOrSym |		(blockOrSym = #-) | (blockOrSym = #~)			ifTrue: [				(blockOrSym = #-) ifTrue: [y _ y + 15].  "insert a full space"				(blockOrSym = #~) ifTrue: [y _ y + 5]]  "insert a half space"			ifFalse: [				y _ self createBlock: blockOrSym atPosition: x@y onPage: bin]].	^ bin! !!ScriptableScratchMorph methodsFor: 'blocks' stamp: 'sk 2/23/2016 21:29'!viewerPageForMotion	"Answer a morph containing mtion blocks for the given category for use in the given ScratchViewer."	| bin isStage addMotorBlocks s x y |	bin _ ScratchBlockPaletteMorph new.	(self isKindOf: ScratchStageMorph)		ifTrue: [			isStage _ true.			addMotorBlocks _ self showMotorBlocks]		ifFalse: [			isStage _ false.			s _ self ownerThatIsA: ScratchStageMorph.			addMotorBlocks _ s notNil and: [s showMotorBlocks]].	addMotorBlocks _ true.	(isStage & addMotorBlocks not) ifTrue: [ ^ bin ]."		font _ (ScratchFrameMorph getFont: #ViewerPage).		x _ 20.		y _ 12.		m _ StringMorph contents: 'Stage selected:' localized font: font.		bin addMorph: (m color: Color white; position: x@y).		m _ StringMorph contents: 'No motion blocks' localized font: font.		bin addMorph: (m color: Color white; position: x@(y + 17)).		^ bin]."	x _ 12.	y _ 10.	(self blocksFor: 'motion') do: [:blockOrSym |		(blockOrSym = #-) | (blockOrSym = #~)			ifTrue: [				(blockOrSym = #-) ifTrue: [y _ y + 15].  "insert a full space"				(blockOrSym = #~) ifTrue: [y _ y + 5]]  "insert a half space"			ifFalse: [				y _ self createBlock: blockOrSym atPosition: x@y onPage: bin]].	addMotorBlocks ifFalse: [^ bin].	isStage ifFalse: [		y _ y + 7.		bin addMorph: ((ImageMorph new form: (ScratchFrameMorph skinAt: #connector)) position: x@y).		y _ y + 20].	(self blocksFor: 'motor') do: [:blockOrSym |		(blockOrSym = #-) | (blockOrSym = #~)			ifTrue: [				(blockOrSym = #-) ifTrue: [y _ y + 15].  "insert a full space"				(blockOrSym = #~) ifTrue: [y _ y + 5]]  "insert a half space"			ifFalse: [				y _ self createBlock: blockOrSym atPosition: x@y onPage: bin]].	" Only for Studuino mini "	(BoardType = 1) ifTrue: [		(self blocksFor: 'motion mini') do: [:blockOrSym |			(blockOrSym = #-) | (blockOrSym = #~)				ifTrue: [					(blockOrSym = #-) ifTrue: [y _ y + 15].  "insert a full space"					(blockOrSym = #~) ifTrue: [y _ y + 5]]  "insert a half space"				ifFalse: [					y _ self createBlock: blockOrSym atPosition: x@y onPage: bin]].].	^ bin! !!ScriptableScratchMorph methodsFor: 'blocks' stamp: 'sk 2/26/2016 20:58'!viewerPageForSensing	"Answer a morph containing mtion blocks for the given category for use in the given ScratchViewer."	| bin x y |	bin _ ScratchBlockPaletteMorph new.	x _ 12.	y _ 10.	(self blocksFor: 'sensing') do: [:blockOrSym |		(blockOrSym = #-) | (blockOrSym = #~)			ifTrue: [				(blockOrSym = #-) ifTrue:[y _ y + 15]. "insert a full space"				(blockOrSym = #~) ifTrue: [					y _ y + 7.					bin addMorph: ((ImageMorph new form: (ScratchFrameMorph skinAt: #connector)) position: x@y).					y _ y + 20]]			ifFalse: [				y _ self createBlock: blockOrSym atPosition: x@y onPage: bin]].	" Only for Studuino mini "	(BoardType = 1) ifTrue: [		(self blocksFor: 'sensing mini') do: [:blockOrSym |			(blockOrSym = #-) | (blockOrSym = #~)				ifTrue: [					(blockOrSym = #-) ifTrue:[y _ y + 15]. "insert a full space"					(blockOrSym = #~) ifTrue: [						y _ y + 7.						bin addMorph: ((ImageMorph new form: (ScratchFrameMorph skinAt: #connector)) position: x@y).						y _ y + 20]]				ifFalse: [					y _ self createBlock: blockOrSym atPosition: x@y onPage: bin]].].	^ bin! !!ScriptableScratchMorph methodsFor: 'event handling' stamp: 'KK 9/19/2013 10:32'!doubleClick: evt	"Show my viewer and script editor."		| hand |	hand _ self world activeHand.	hand toolType ifNotNil: [		^ self handleTool: hand toolType hand: hand]."	self viewBlocksAndScripts."! !!ScriptableScratchMorph methodsFor: 'object i/o' stamp: 'KK 1/21/2013 19:19'!storeFieldsOn: anObjStream	| oldBlockBinOwner |	super storeFieldsOn: anObjStream.	(blocksBin isKindOf: Morph) ifTrue: [		oldBlockBinOwner _ blocksBin owner.		blocksBin delete].	self storeFieldsNamed: #(		objName		vars		blocksBin		isClone		media		costume	) on: anObjStream.	oldBlockBinOwner ifNotNil: [oldBlockBinOwner addMorph: blocksBin].! !!ScriptableScratchMorph methodsFor: 'private' stamp: 'KK 2/27/2015 15:16'!getHatlessBlocks	| stacks aloneBlocks |	aloneBlocks _ nil.	stacks _ blocksBin submorphs select: [:m | m isKindOf: BlockMorph].	stacks size = 0 ifTrue: [		^ aloneBlocks].	aloneBlocks _ stacks select: [:m | (m isKindOf: HatBlockMorph) not].	^ aloneBlocks! !!ScriptableScratchMorph methodsFor: 'private' stamp: 'sk 9/15/2017 15:58'!printArduLangOn: aStream 

	| stacks hats evtName index partsName portName offset f j b initCode |

	stacks _ blocksBin submorphs select: [:m | m isKindOf: BlockMorph].
	stacks size = 0 ifTrue: [
		^ self].

	hats _ stacks select: [:m | m isKindOf: HatBlockMorph].

	" Include file declaration "

	aStream nextPutAll: '// ---------------------------------------'; cr.
	aStream nextPutAll: '// Servomotor calibration data'; cr.
	aStream nextPutAll: '// ---------------------------------------'; cr.
	aStream nextPutAll: 'char SvCalibrationData[] = { '.

	(BoardType = 0 or: [BoardType = 2]) ifTrue: [
		5 to: 8 do: [:i|
			offset _ SvCalib at:(i).
			aStream nextPutAll: offset asString, ', '].
		1 to: 4 do: [:i|
			offset _ SvCalib at:(i).
			aStream nextPutAll: offset asString, ', ']]
	ifFalse: [ " Studuino mini "
		SvCalib do: [:elm |
			offset _ elm.
			aStream nextPutAll: offset asString, ', '.]	].

	aStream nextPutAll: ' };'; cr.
	aStream nextPutAll: '// ---------------------------------------'; cr.
	aStream nextPutAll: '// DC motor calibration data'; cr.
	aStream nextPutAll: '// ---------------------------------------'; cr.
	aStream nextPutAll: 'byte DCCalibrationData[] = { '.
	offset _ DCCalib at:(1).
	aStream nextPutAll: offset asString, ', '.
	offset _ DCCalib at:(2).
	aStream nextPutAll: offset asString.
	aStream nextPutAll: ' };'; cr.

	" Prototype declaration "
	aStream nextPutAll: '// ---------------------------------------'; cr.
	aStream nextPutAll: '// prototype declaration'; cr.
	aStream nextPutAll: '// ---------------------------------------'; cr.
	hats do: [:item |
		evtName _ item eventName.
		evtName = 'Scratch-StartClicked'
			ifTrue: [aStream nextPutAll: 'void artecRobotMain();']
			ifFalse: [aStream nextPutAll: 'void ARSR_', evtName, '();'].
		aStream cr.
	].


	aStream nextPutAll: '// ---------------------------------------'; cr.
	aStream nextPutAll: '// Global variable'; cr.
	aStream nextPutAll: '// ---------------------------------------'; cr.
	"Define value"
	self varNames do: [:v |
		aStream nextPutAll: 'float ARVAL_' , v, ';'.
		aStream cr.
	].
	"Define list"
	self listVarNames do: [:v |
		aStream nextPutAll: 'cell ARLIST_' , v, ';'.
		aStream cr.
	].
	aStream nextPutAll: 'byte port[8];';cr.
	aStream nextPutAll: 'byte degree[8];';cr.

	aStream nextPutAll: '// ---------------------------------------'; cr.
	aStream nextPutAll: '// Artec robot setup routine'; cr.
	aStream nextPutAll: '// ---------------------------------------'; cr.
	aStream nextPutAll: 'void artecRobotSetup() {'; cr.

	"For Studuino mini clock initialization."
	(BoardType == 1) ifTrue: [
		((IOPort at: 19) = 6) ifTrue: [ "Clock is enabled."
			aStream nextPutAll: '    board.InitClock();'; cr.].].

	index _ 0.
	IOPort do: [ :partsID |
		(partsID ~= 0) ifTrue: [
			(index = 0) ifTrue: [
				aStream nextPutAll: '    board.InitDCMotorPort(PORT_M1);'; cr.
"Transcript show: 'initDCMotor('; show:index; show: ');'; cr."
			].
			(index = 1) ifTrue: [
				aStream nextPutAll: '    board.InitDCMotorPort(PORT_M2);'; cr.
"Transcript show: 'initDCMotor('; show:index; show: ');'; cr."
			].

	" Board selection "
	(BoardType = 0 or: [BoardType = 2]) ifTrue: [	" For Studuino "
			(index = 2) ifTrue: [
				aStream nextPutAll: '    board.InitServomotorPort(PORT_D2);'; cr.
			].
			(index = 3) ifTrue: [
				aStream nextPutAll: '    board.InitServomotorPort(PORT_D4);'; cr.
			].
			(index = 4) ifTrue: [
				aStream nextPutAll: '    board.InitServomotorPort(PORT_D7);'; cr.
			].
			(index = 5) ifTrue: [
				aStream nextPutAll: '    board.InitServomotorPort(PORT_D8);'; cr.
			].
			(index = 6) ifTrue: [
				aStream nextPutAll: '    board.InitServomotorPort(PORT_D9);'; cr.
			].
			(index = 7) ifTrue: [
				aStream nextPutAll: '    board.InitServomotorPort(PORT_D10);'; cr.
			].
			(index = 8) ifTrue: [
				aStream nextPutAll: '    board.InitServomotorPort(PORT_D11);'; cr.
			].
			(index = 9) ifTrue: [
				aStream nextPutAll: '    board.InitServomotorPort(PORT_D12);'; cr.
			].]
	ifFalse: [	" For Studuino mini "
		((index > 1) & (index < 10)) ifTrue: [
			(partsID = 2) ifTrue: [
				initCode _ '    board.InitServomotorPort(']
			ifFalse: [
				initCode _ '    board.InitDigitalPort('].

			(index = 2) ifTrue: [
				initCode _ initCode, 'PORT_D5'.].
			(index = 3) ifTrue: [
				initCode _ initCode, 'PORT_D6'.].
			(index = 4) ifTrue: [
				initCode _ initCode, 'PORT_D9'.].
			(index = 5) ifTrue: [
				initCode _ initCode, 'PORT_D10'.].
			(index = 6) ifTrue: [
				initCode _ initCode, 'PORT_D11'.].
			(partsID = 5) ifTrue: [
				initCode _ initCode, ', PIDLED'.].
			aStream nextPutAll: initCode, ');'; cr.].].

"
			((index > 1) & (index < 10)) ifTrue: [
				aStream nextPutAll: '    initSVMotor('.
				aStream nextPutAll: (index-2) asString.
				aStream nextPutAll: ');'; cr.
			].
"
			(index > 9) & (index < 18) ifTrue: [
				(partsID = 16r03) ifTrue: [ partsName _ 'PIDLED' ].
				(partsID = 16r04) ifTrue: [ partsName _ 'PIDBUZZER' ].
				(partsID = 16r05) ifTrue: [ partsName _ 'PIDCOLORLED' ].
				(partsID = 16r10) ifTrue: [ partsName _ 'PIDLIGHTSENSOR' ].
				(partsID = 16r11) ifTrue: [ partsName _ 'PIDTOUCHSENSOR' ].
				(partsID = 16r12) ifTrue: [ partsName _ 'PIDSOUNDSENSOR' ].
				(partsID = 16r13) ifTrue: [ partsName _ 'PIDIRPHOTOREFLECTOR' ].
				(partsID = 16r14) ifTrue: [ partsName _ 'PIDACCELEROMETER' ].
				(partsID = 16r15) ifTrue: [ partsName _ 'PIDPUSHSWITCH' ].
				(partsID = 16r18) ifTrue: [ partsName _ 'PIDTEMPERATURESENSOR' ].

				(index = 10) ifTrue: [ portName _ 'PORT_A0' ].
				(index = 11) ifTrue: [ portName _ 'PORT_A1' ].
				(index = 12) ifTrue: [ portName _ 'PORT_A2' ].
				(index = 13) ifTrue: [ portName _ 'PORT_A3' ].
				(index = 14) ifTrue: [ portName _ 'PORT_A4' ].
				(index = 15) ifTrue: [ portName _ 'PORT_A5' ].
				(index = 16) ifTrue: [ portName _ 'PORT_A6' ].
				(index = 17) ifTrue: [ portName _ 'PORT_A7' ].

				aStream nextPutAll: '    board.InitSensorPort('.
				aStream nextPutAll: portName.
				aStream nextPutAll: ', '.
				aStream nextPutAll: partsName.
				aStream nextPutAll: ');'; cr.

"Transcript show: 'initSensorPin('; show:(index-10); show: ', '; show:partsName; show: ');'; cr."
			].
		].
		index _ index + 1.
	].

	aStream nextPutAll: '    board.SetServomotorCalibration(SvCalibrationData);'; cr.
	aStream nextPutAll: '    board.SetDCMotorCalibration(DCCalibrationData);'; cr.
	aStream nextPutAll: '}'; cr.

	NumberOfdoRepeat _ 0.
	hats do: [:item |
		item printArduCodeOn: aStream indent: 0.
		(item isKindOf: ReporterBlockMorph) ifTrue: [aStream cr].
		aStream cr].

! !!ScratchSpriteMorph methodsFor: 'accessing' stamp: 'KK 1/28/2013 11:37'!referencePosition	| p s |	p _ (bounds origin + offsetWhenRotated) - ScratchOrigin.	"adjust when in Hand in quartersize mode:"	((owner isKindOf: HandMorph) and:	 [((s _ owner formerOwner) isKindOf: ScratchStageMorph) and:	 [s isQuarterSize]]) ifTrue: [		"Note: this is not quite right when rotation center is offset"		p _ (p * 2) + (240@180)].	^ p x @ p y negated! !!ScratchStageMorph methodsFor: 'initialization' stamp: 'KK 9/25/2017 14:24'!initialize	super initialize.	color _ Color white.	self enableDragNDrop: true.	objName _ 'Stage' localized.	costume _ self defaultImageMedia.	media _ OrderedCollection with: costume with: SoundMedia new.	zoom _ 1.0.	hPan _ 0.	vPan _ 0.	runningBlocks _ OrderedCollection new.	inProcessStep _ false.	sensorBoard _ SensorBoardMorph new.	midiPortNum _ -1.	notePlayerDict _ Dictionary new.	obsoleteSavedState _ nil.	sprites _ OrderedCollection new.	showMotorBlocks _ false.	showOptionBlocks _ false.	servoCalibrationBoard _ SensorBoardMorph new.! !!ScratchStageMorph methodsFor: 'accessing' stamp: 'KK 1/21/2013 19:20'!objName	^ 'ArTec Block Robot Programming Environment' localized! !!ScratchStageMorph methodsFor: 'accessing' stamp: 'KK 3/21/2015 11:40'!showOptionBlocks	^ showOptionBlocks! !!ScratchStageMorph methodsFor: 'event handling' stamp: 'KK 9/19/2013 10:21'!containsPoint: aPoint	self isQuarterSize ifTrue: [^ (self position extent: self extent // 2)  containsPoint: aPoint].	^ self bounds containsPoint: aPoint! !!ScratchStageMorph methodsFor: 'event handling' stamp: 'KK 9/19/2013 10:20'!fullContainsPoint: aPoint	"Answer true if the given point is in my visible bounds. In quarterSize mode, my visible bounds is only half of my extent."	| r |	r _ self isQuarterSize		ifTrue: [self position extent: bounds extent // 2]		ifFalse: [bounds].	^ r containsPoint: aPoint! !!ScratchStageMorph methodsFor: 'drawing' stamp: 'KK 9/3/2013 16:42'!drawQuarterSizeOn: aCanvas	"Draw myself and my submorphs to an offscreen canvas, then scale down to quarter size and draw that on the given canvas."	| r srcR c |	cachedForm ifNil: [cachedForm _ Form extent: self extent depth: 32].	r _ aCanvas clipRect intersect: (bounds origin extent:  (bounds extent x // 2 @ bounds extent y)).	srcR _ ((r origin - bounds origin) * 2.0) truncated extent: (r extent * 2.0) rounded.	c _ (FormCanvas on: cachedForm)		copyOrigin: self position negated		clipRect: srcR.	super fullDrawOn: c.	ScratchPlugin halfSize: cachedForm into: Display srcPoint: srcR origin dstRect: r."xxx	cachedForm unhibernate.	LowResPlugin		primHalf2Average: cachedForm bits w: cachedForm width h: cachedForm height		into: Display bits w: Display width h: Display height		srcX: srcR left srcY: srcR top		dstX: r left dstY: r top dstW: r width dstH: r height.	(WarpBlt toForm: Display)		sourceForm: cachedForm;		combinationRule: Form over;		clipRect: aCanvas clipRect;		cellSize: 2;		copyQuad: srcR corners toRect: r.xxx"	"the following scales down entire stage:""	LowResPlugin scale: cachedForm into: aCanvas form at: aCanvas origin + self position."! !!ScratchStageMorph methodsFor: 'menus' stamp: 'KK 9/19/2013 10:05'!rightButtonMenu	"Present the right button menu."	| |"	menu _ CustomMenu new.	menu add: 'grab screen region for new sprite' action: #grabSpriteFromScreen.	menu addLine.	menu add: 'save picture of stage...' action: #stageShot.	menu localize; invokeOn: self."! !!ScriptableScratchMorph class methodsFor: 'block specs' stamp: 'sk 2/23/2016 21:30'!blockColorFor: aCategory	"Answer the block color for the given category."	'control' = aCategory ifTrue: [^ (Color h: 41 s: 0.85 v: 0.9)].	'motion' = aCategory ifTrue: [^ (Color h: 225 s: 0.65 v: 0.83)].	'motor' = aCategory ifTrue: [^ (Color h: 220 s: 0.85 v: 0.725)].	'motion mini' = aCategory ifTrue: [^ (Color h: 220 s: 0.85 v: 0.725)].	'looks' = aCategory ifTrue: [^ (Color h: 264 s: 0.62 v: 0.89)].	'pen' = aCategory ifTrue: [^ (Color h: 165 s: 1 v: 0.63)].	'operators' = aCategory ifTrue: [^ (Color h: 93 s: 0.9 v: 0.76)].	'sound' = aCategory ifTrue: [^ (Color h: 296 s: 0.66 v: 0.85)].	'sensing' = aCategory ifTrue: [^ (Color h: 200 s: 0.98 v: 0.86)].	'sensing mini' = aCategory ifTrue: [^ (Color h: 200 s: 0.98 v: 0.86)].	'variables' = aCategory ifTrue: [^ (Color h: 25 s: 0.88 v: 0.95)].	'list' = aCategory ifTrue: [^ ListBlockColor].	'notSensing' = aCategory ifTrue: [^ (Color h: 0 s: 0 v: 0.5)].	'compatible' = aCategory ifTrue: [^ (Color h: 28 s: 0.61 v: 0.96)].	^ (Color h: 0 s: 0.81 v: 0.83)  "a shade of red"! !!ScriptableScratchMorph class methodsFor: 'block specs' stamp: 'KK 11/16/2017 10:29'!blockSpecs	"Answer a collection of block specifications for the blocks that are common to all objects. Block specificatons (Arrays) are interspersed with category names (Strings). A block specification is an Array of the form: (<block spec string> <block type> <selector> [optional initial argument values]).	Explanation of flags:		-	no flags		b	boolean reporter		c	c-shaped block containing a sequence of commands (always special form)		r	reporter		s	special form command with its own evaluation rule		t	timed command, like wait or glide		E	message event hat		K	key event hat		M	mouse-click event hat		S	start event hat		W	when <condition> hat (obsolete)"	| blocks |	blocks _ #(		'control'"			('%e function'			E	-)			('call %e function'			s	doBroadcastAndWait)			-"			('wait %n secs'					t	wait:elapsed:from: 1)			-			('forever'						c	doForever)			('repeat %n'						c	doRepeat 10)			-"			('broadcast %e'					-	broadcast:)			('forever if %b'					c	doForeverIf)"			('if %b'							c	doIf)			('if %b'							c	doIfElse)			('wait until %b'					s	doWaitUntil)			('repeat until %b'				c	doUntil)"			-			('stop script'					s	doReturn)			('stop all'						-	stopAll)""			('Servomotor synchro motion speed:%E'						c	doSvmSyncMotion2 10)		'compatible'			('Servomotor synchro motion delay:%E'						c	doSvmSyncMotion 10)"		'operators'			('%n + %n'						r	+ - -)			('%n - %n'						r	- - -)			('%n * %n'						r	* - -)			('%n / %n'						r	/ - -)"			-			('pick random %n to %n'		r	randomFrom:to: 1 10)"			-			('%n < %n'						b	< - -)			('%n = %n'						b	= - -)			('%n > %n'						b	> - -)			-			('%b and %b'					b	&)			('%b or %b'						b	|)			('not %b'						b	not)"			-			('join %s %s'					r	concatenate:with: 'hello ' 'world')			('letter %n of %s'				r	letter:of: 1 'world')			('length of %s'					r	stringLength: 'world')			-			('%n mod %n'					r	\\ - -)			('round %n'						r	rounded -)			-			('%f of %n'						r	computeFunction:of: 'sqrt' 10)"		'sound'"xxx			('play sound %S'				-	playSound:)			('play sound %S until done'		s	doPlaySoundAndWait)			('stop all sounds'				-	stopAllSounds)			-			('play drum %D for %n beats'	t 	drum:duration:elapsed:from: 48 0.2)			('rest for %n beats'				t 	rest:elapsed:from: 0.2)			-			('play note %N for %n beats'	t	noteOn:duration:elapsed:from: 60 0.5)			('set instrument to %I'			- 	midiInstrument: 1)			-			('change volume by %n'		- 	changeVolumeBy: -10)			('set volume to %n%'			- 	setVolumeTo: 100)			('volume'						r 	volume)			-			('change tempo by %n'			- 	changeTempoBy: 20)			('set tempo to %n bpm'			- 	setTempoTo: 60)			('tempo'							r 	tempo)"		'motor'"			('motor on for %n secs'			t	motorOnFor:elapsed:from: 1)			('motor on'						-	allMotorsOn)			('motor off'						-	allMotorsOff)			('motor power %n'				-	startMotorPower: 100)			('motor direction %W'			-	setMotorDirection: 'this way')			('Set servomotor %J to %F degrees'			-	motorNo:degree: 'PIN' 90)"			('Electrify M1 by %n %'			-	m1DCMotorOn: 100)			('Cut off electricity'				-	m1DCMotorOff)"			('Buzzer %B on frequency %N'	-	buzzerPin:freq: 'PIN' 60)			('Buzzer %B off'					-	buzzerPin: 'PIN')			('LED %p %o'					-	ledPin:onOff: 'PIN' 'on')"		'motion mini'			('Onboard LED %p1 %o'			-	boardLED:onOff: 'Red(D5)' 'on')			('Set time %nh %nm'			-	hour:min: 0 0)			('Set date %n/%n/%n'			-	month:day:year: 1 1 2016)			('Set alarm %nh %nm'			-	alhour:almin: 0 0)			('Set backlight R%n G%n B%n'	-	red:green:blue: 0 0 0)			('Backlight %o'					-	clkBackLight: 'on')			('Clock''s buzzer on frequency %N for %n'	t	clkBuzzerOnFreq:For:elapsed:from: 60 1)"			('Clock''s buzzer off'				-	clkBuzzerOff)""			('Color LED %w %o'				-	ledColor:onOff: 'White' 'on')"			-"			('Move %q for %n msec at %n power and %T'	-	direct:time:power:stop 'Forward' 100  100 'Brake')""			('Set servomotors %E ms/deg, D2:%F D4:%F D7:%F D8:%F D9:%F D10:%F D11:%F D12:%F' - setServoSpeed:d2:d4:d7:d8:d9:d10:d11:d12: 10 90 90 90 90 90 90 90 90)"			-		'variables'"			('show variable %v'				-	showVariable:)			('hide variable %v'				-	hideVariable:)"		'list'			('add %n to %L'					-	append:toList: 0)			-			('delete %y of %L'				-	deleteLine:ofList: 1)			('insert %n at %i of %L'			-	insert:at:ofList: 0 1)			('replace item %i of %L with %n'		-	setLine:ofList:to: 1 'list' 0)			-			('item %i of %L'					r	getLine:ofList: 1)			('length of %L'					r	lineCountOfList:)			('%L contains %n'				b	list:contains: 'list' 0)	).	^ blocks, self obsoleteBlockSpecs! !!ScriptableScratchMorph class methodsFor: 'block specs' stamp: 'KK 9/5/2013 16:33'!buildBlockSpecDictionary	"self buildBlockSpecDictionary"	| blockColor sel |	BlockSpecDict _ IdentityDictionary new: 250.	BlockColorDict _ IdentityDictionary new: 250."Transcript show:'[ScriptableScratchMorph::buildBlockSpecDictionary]';cr."	self withAllSubclassesDo: [:cl |		blockColor _ Color blue.		cl blockSpecs do: [:spec |			((spec isKindOf: String) and: [spec size > 1]) ifTrue: [				"set color  for this category"				blockColor _ self blockColorFor: spec].			(spec isMemberOf: Array) ifTrue: [				sel _ spec at: 3.				BlockSpecDict at: sel put: spec.				BlockColorDict at: sel put: blockColor]]].! !!ScratchSpriteMorph class methodsFor: 'block specs' stamp: 'KK 8/31/2013 11:01'!blockSpecs	| blocks |	blocks _ #(		'motion'			('move %n steps'				-	forward:)			('turn %n degrees'				-	turnRight: 15)	"icon shows turn direction"			('turn %n degrees'				-	turnLeft: 15)	"icon shows turn direction"			-			('point in direction %d'			-	heading: 90)			('point towards %m'				-	pointTowards:)			-			('go to x:%n y:%n'				-	gotoX:y: 0 0)			('go to %m'						-	gotoSpriteOrMouse:)			('glide %n secs to x:%n y:%n'	t	glideSecs:toX:y:elapsed:from: 1 50 50)			-			('change x by %n'				-	changeXposBy: 10)			('set x to %n'					-	xpos: 0)			('change y by %n'				-	changeYposBy: 10)			('set y to %n'					-	ypos: 0)			-			('if on edge, bounce'			-	bounceOffEdge)			-			('x position'						r	xpos)			('y position'						r	ypos)			('direction'						r	heading)		'pen'			('clear'							-	clearPenTrails)			-			('pen down'						-	putPenDown)			('pen up'						-	putPenUp)			-			('set pen color to %c'			-	penColor:)			('change pen color by %n'		-	changePenHueBy:)			('set pen color to %n'			-	setPenHueTo: 0)			-			('change pen shade by %n'		-	changePenShadeBy:)			('set pen shade to %n'			-	setPenShadeTo: 50)			-			('change pen size by %n'		-	changePenSizeBy: 1)			('set pen size to %n'				-	penSize: 1)			-			('stamp'							-	stampCostume)	).	blocks _ blocks, #(		'looks'			('switch to costume %l'			-	lookLike:)			('next costume'					-	nextCostume)			('costume #'						r	costumeIndex)			-			('say %s for %n secs'			t	say:duration:elapsed:from: 'Hello!!' 2)			('say %s'						-	say: 'Hello!!')			('think %s for %n secs'			t	think:duration:elapsed:from: 'Hmm...' 2)			('think %s'						-	think: 'Hmm...')			-			('change %g effect by %n'		-	changeGraphicEffect:by: 'color' 25)			('set %g effect to %n'			-	setGraphicEffect:to: 'color' 0)			('clear graphic effects'			-	filterReset)			-			('change size by %n'			-	changeSizeBy:)			('set size to %n%'				-	setSizeTo: 100)			('size'							r	scale)			-			('show'							-	show)			('hide'							-	hide)			-			('go to front'					-	comeToFront)			('go back %n layers'			-	goBackByLayers: 1)		'sensing'			('touching %m?' 				b	touching:)			('touching color %C?' 			b	touchingColor:)			('color %C is touching %C?'		b	color:sees:)			-			('ask %s and wait'				s	doAsk 'What''s your name?')			('answer'						r	answer)			-			('mouse x'						r	mouseX)			('mouse y'						r	mouseY)			('mouse down?'					b	mousePressed)			-			('key %k pressed?'				b	keyPressed: 'space')			-			('distance to %m'				r	distanceTo:)			-			('reset timer'					-	timerReset)			('timer'							r	timer)			-			('%a of %m'						r	getAttribute:of:)			-			('loudness'						r	soundLevel)			('loud?'							b	isLoud)			~			('%H sensor value'				r	sensor: 'slider')			('sensor %h?'					b	sensorPressed: 'button pressed')"			('Light Sensor %Z value'		r	lightSensor: 'A0')			('Touch Sensor %V value'	r	touchSensor: 'A0')			('Sound Sensor %Z value'	r	sensor: 'A0')			('Reflective Photosensor %Z value'	r	sensor: 'A0')			('3-Axis Digital Accelerometer %Y value'	r	sensor: 'X')			('Button %X value'	r	sensor: 'A0')"		).	^ blocks, super blockSpecs! !!ScratchStageMorph class methodsFor: 'block specs' stamp: 'KK 11/16/2017 10:31'!blockSpecs

	| blocks |
	blocks _ #(
		'sensing'
"
			('ask %s and wait'			s	doAsk 'What''s your name?')
			('answer'					r	answer)
			-
			('mouse x'					r	mouseX)
			('mouse y'					r	mouseY)
			('mouse down?'				b	mousePressed)
			-
			('key %k pressed?'			b	keyPressed: 'space')
			-
			('reset timer'				-	timerReset)
			('timer'						r	timer)
			-
			('%a of %m'					r	getAttribute:of:)
			-
			('loudness'					r	soundLevel)
			('loud?'						b	isLoud)
			~
			('%H sensor value'			r	sensor: 'slider')
			('sensor %h?'				b	sensorPressed: 'button pressed')
			~
"
"
			('set servo motor %J to %n degrees'			-	motorNo:degree: 'No.1' 90)
			('set DC motor %j  %z'		-	motorNo:onOff: 'No.1' 'on')			('%z sensor value'			r	sensor: 'A0')
			('Light Sensor %P value'		r	lightSensor: 'PIN')			('Touch Sensor %V value'	r	touchSensor: 'PIN')
			('Sound Sensor %O value'	r	soundSensor: 'PIN')
			('IR Photoreflector %Z value'	r	refPhotosensor: 'PIN')
			('Temperature sensor %w value'	r	temperatureSensor: 'PIN')
			('3-Axis Digital Accelerometer %Y value'	r	accelerometer: 'AXIS')
			('Button %X value'	r		onBoardButton: 'PIN')
"
			('Sensor %U value'		r	sensors: 'PIN')
"			~
			('reset timer'				-	timerReset)
			('timer'						r	timer)
			~
"
		'sensing mini'
			('Clock''s %Z1'	r	clockValue: 'Hour')
			('becoming in alarm time'		b	isInAlarm)
			('Onboard Light Sensor value'	r		onBoardLightSensor)
			('Power value'	r		power)
		'looks'
"xxx
			('switch to background %l'	-	showBackground: 'background1')
			('next background'			-	nextBackground)
			('background #'				r	backgroundIndex)
			-
			('change %g effect by %n'	-	changeGraphicEffect:by: 'color' 25)
			('set %g effect to %n'		-	setGraphicEffect:to: 'color' 0)
			('clear graphic effects'		-	filterReset)
			-
"
"xxx			('place sprites for scene %x'	-	showScene:) "
		'pen'
"xxx
			('clear'						-	clearPenTrails)
"
	).

	^ blocks, super blockSpecs
! !!SensorBoardMorph methodsFor: 'initialization' stamp: 'KK 8/28/2013 17:12'!addReadoutLabeled: aString	"Add a readout row with the given label. Answer the stringmorph that's the readout."	| row box readout |	row _ AlignmentMorph newRow color: column color; inset: 2."	row _ AlignmentMorph newRow color: (Color r: (255/255) g: (0/255) b: (0/255)); inset: 2."	row addMorphBack: (Morph new color: column color; extent: 1@3). "spacer"	row addMorphBack: (StringMorph contents: aString capitalized font: (StrikeFont fontName: 'VerdanaBold' size: 10)).	row addMorphBack: (AlignmentMorph new color: column color; extent: 10@1; hResizing: #spaceFill).  "spacer"	box _ WatcherReadoutFrameMorph new		extent: 42@14;		color: (ScriptableScratchMorph blockColorFor: 'sensing').	readout _ StringMorph contents: '0' font: (StrikeFont fontName: 'VerdanaBold' size: 10).	readout color: Color white.	box addMorph: readout.	row addMorphBack: box.	column addMorphBack: row.	^ readout! !!SensorBoardMorph methodsFor: 'initialization' stamp: 'KK 8/28/2013 18:50'!addReadoutLabeled: aString isSensor: kind	"Add a readout row with the given label. Answer the stringmorph that's the readout."	| row box readout colorName |	row _ AlignmentMorph newRow color: column color; inset: 2.	row addMorphBack: (Morph new color: column color; extent: 1@3). "spacer"	row addMorphBack: (StringMorph contents: aString capitalized font: (StrikeFont fontName: 'VerdanaBold' size: 10)).	row addMorphBack: (AlignmentMorph new color: column color; extent: 10@1; hResizing: #spaceFill).  "spacer"	(kind = true) ifTrue:[	" Sensor "		colorName _ 'sensing'.	] ifFalse: [				" Not sensor "		colorName _ 'notSensing'.	].	box _ WatcherReadoutFrameMorph new		extent: 42@14;		color: (ScriptableScratchMorph blockColorFor: colorName).	readout _ StringMorph contents: '0' font: (StrikeFont fontName: 'VerdanaBold' size: 10).	readout color: Color white.	box addMorph: readout.	row addMorphBack: box.	column addMorphBack: row.	^ readout! !!SensorBoardMorph methodsFor: 'initialization' stamp: 'KK 9/26/2017 14:05'!addReadouts

	| readoutNames sensorID offset light touch sound infrared acceleration button setAcceleration open led buzzer colorLED kindOfSensor sizeAx tmp header cont temperature |

	" Check IOPort "
"	Transcript show:'[SensorBoardMorph::addReadouts] ';show:(IOPort);cr."

	offset _ 10.		" Offset for sensor ID "
	open _ 16r00.			" Not connected "
	led _ 16r03.				" LED ID "
	buzzer _ 16r04.			" Buzzer ID "
	colorLED _ 16r05.		" Color LED ID "
	light _ 16r10.			" Light sensor ID "
	touch _ 16r11.			" Touch sensor ID "
	sound _ 16r12.			" Sound sensor ID "
	infrared _ 16r13.		" IR Photoreflector ID "
	acceleration _ 16r14.		" Accelerometer ID "
	button _ 16r15.			" Button sensor ID "
	temperature _ 16r18.		" Temperature sensor ID "
	setAcceleration _ false.	" Set acceleration sensor flag "

	(BoardType = 0 or: [BoardType = 2]) ifTrue: [
		sizeAx _ 8.]
	ifFalse: [
		sizeAx _ 6.].
	readoutNames _ OrderedCollection new.
	1 to: sizeAx do: [ :index |
		sensorID _ IOPort at: (index + offset).
		(sensorID = open) ifTrue: [	" Not connected "
			readoutNames add:'[A', (index - 1) asString,']',' Not connected'.
		].
		(sensorID = led) ifTrue: [	" LED "
			readoutNames add:'[A', (index - 1) asString,']',' LED'.
		].
		(sensorID = buzzer) ifTrue: [	" Buzzer "
			readoutNames add:'[A', (index - 1) asString,']',' Buzzer'.
		].
		(sensorID = colorLED) ifTrue: [	" Color LED "
			readoutNames add:'[A', (index - 1) asString,']',' Color LED'.
		].
		(sensorID = light) ifTrue: [	" Light Sensor "
			readoutNames add:'[A', (index - 1) asString,']',' Sensor'.
		].
		(sensorID = touch) ifTrue: [	" Touch Sensor "
			readoutNames add:'[A', (index - 1) asString,']',' Touch sensor'.
		].
		(sensorID = sound) ifTrue: [	" Sound Sensor "
			readoutNames add:'[A', (index - 1) asString,']',' Sound sensor'.
		].
		(sensorID = infrared) ifTrue: [	" IR Photoreflector "
			readoutNames add:'[A', (index - 1) asString,']',' Sensor'.
		].
		(sensorID = acceleration) ifTrue: [	" Accelerometer "
			(setAcceleration = false) ifTrue: [
				readoutNames add:'[A4/A5] Accelerometer (X)'.
				readoutNames add:'[A4/A5] Accelerometer (Y)'.
				readoutNames add:'[A4/A5] Accelerometer (Z)'.
				setAcceleration _ True.
			].
		].
		(sensorID = temperature) ifTrue: [	" Temperature sensor "
			readoutNames add:'[A', (index - 1) asString,']',' Sensor'.
			listTempBuf at: index put: (TemperatureSensor new).
		].
		(sensorID = button) ifTrue: [	" Button "
			readoutNames add:'[A', (index - 1) asString,']',' Button'.
		].
	].
	column _ AlignmentMorph newColumn
		centering: #center;
		hResizing: #spaceFill;
		vResizing: #shrinkWrap;
		color: (Color r: (193/255) g: (196/255) b: (199/255));
		borderWidth: 2;
		borderColor: (Color r: (148/255) g: (145/255) b: (145/255));
		useRoundedCorners;
		inset: 3.

	titleMorph _ StringMorph
		contents: ''
		font: (StrikeFont fontName: 'VerdanaBold' size: 10).
	column addMorph: titleMorph.
	self updateTitle.
	column addMorphBack: (Morph new color: column color; extent: 5@3).  "spacer"

	self removeAllMorphs.
	readouts _ readoutNames collect: [:i |
		(((i findString: 'Not connected') ~= 0) | ((i findString: 'LED') ~= 0) | ((i findString: 'Buzzer') ~= 0)) ifTrue: [
			kindOfSensor _ false.
		] ifFalse: [
			kindOfSensor _ true.
		].

		(i size = 1)
			ifTrue:[self addReadoutLabeled: i isSensor: kindOfSensor]
			ifFalse:[
				tmp _ i findTokens: ' '.
				header _ tmp at: 1.
				cont _ ''.
				2 to: (tmp size) do: [:index |
					cont _ cont, (tmp at: index).
					(index = tmp size) ifFalse: [cont _ cont, ' '].].
				self addReadoutLabeled: (header localized, ' ', cont localized) isSensor: kindOfSensor.]
	].

	" For Studuino mini "
	(BoardType = 1) ifTrue: [
		readouts add: (self addReadoutLabeled: 'Onboard LightSensor' localized).
		readouts add: (self addReadoutLabeled: 'Battery voltage [V]' localized).
		clock _ ColorClock new].

	column position: self position - 2.
	self addMorph: column.
	self extent: column extent - 4.

! !!SensorBoardMorph methodsFor: 'initialization' stamp: 'sk 4/25/2016 18:42'!clockBuzzer: bz For: time	| mid ival tmp |	mid _ 2.		" 2: Buzzer ID "	(clock isSounding) ifFalse: [		clock startBuzzerFor: time.		" set port and buzzer ON "		ival _ 16r0100.	" b0000 0001 0000 0000 "		tmp _ bz asNumber.		tmp _ tmp - 48.		(tmp > 47) & (tmp < 109) ifTrue: [ tmp _ 0. ].		ival _ ival + tmp.		"Transcript show:'ScriptableScratchMorph:: buzzerPin:freq:'; show: ival;cr."		^ self data:ival msgID:mid.]	ifTrue: [		clock isElapsed ifTrue: [			" set port and buzzer OFF "			ival _ 16r0040.	" b0000 0000 0100 0000 "			^ self data:ival msgID:mid].		].	^ self.! !!SensorBoardMorph methodsFor: 'initialization' stamp: 'sk 4/14/2016 14:39'!clockDataSend: data	| msg d1 d2 d3 sendMessage |	msg _ #(0 0 0) asByteArray.	d1 _ ((data bitShift: -12) bitAnd: 16r0F).	d2 _ ((data bitShift: -5) bitAnd: 16r7F).	d3 _ ((data bitShift: 2) bitAnd: 16r7C).	msg at:1 put: (16rE0 + d1).	msg at:2 put: (16r80 + d2).	msg at:3 put: (16r00 + d3).	sendMessage _ String fromBytes: msg.	sendMessage _ 'REQSEND', sendMessage.Transcript show: 'D1: '; show: (msg at:1); cr.Transcript show: 'D2: '; show: (msg at:2); cr.Transcript show: 'D3: '; show: (msg at:3); cr.	socketCommand sendCommand: sendMessage.	socketCommand getResponseShowing: true.   "Waiting ACK"! !!SensorBoardMorph methodsFor: 'initialization' stamp: 'sk 4/15/2016 19:54'!clockDataSend: data subID: id	| msg d1 d2 d3 sendMessage |	(BoardType = 0) ifTrue: [		(self portIsOpen) ifFalse: [ ^0. ].]	ifFalse: [		(self socketIsOpen) ifFalse: [^0. ].].	msg _ #(0 0 0) asByteArray.	d1 _ ((data bitShift: -12) bitAnd: 16r0F).	d2 _ ((data bitShift: -5) bitAnd: 16r7F).	d3 _ ((data bitShift: 2) bitAnd: 16r7C).	msg at:1 put: (16rE0 + d1).	msg at:2 put: (16r80 + d2).	msg at:3 put: (16r00 + d3 + id).	sendMessage _ String fromBytes: msg.	sendMessage _ 'REQSEND', sendMessage.Transcript show: 'D1: '; show: (msg at:1); cr.Transcript show: 'D2: '; show: (msg at:2); cr.Transcript show: 'D3: '; show: (msg at:3); cr.	socketCommand sendCommand: sendMessage.	socketCommand getResponseShowing: true.   "Waiting ACK"! !!SensorBoardMorph methodsFor: 'initialization' stamp: 'sk 4/25/2016 12:45'!clockOnOff: val	| data |	data _ clock onoff: val.Transcript show: val; cr.	^  self clockDataSend: data subID: 1.! !!SensorBoardMorph methodsFor: 'initialization' stamp: 'sk 4/25/2016 12:33'!clockR: rVal G: gVal B: bVal	| data |	data _ clock red: rVal green: gVal blue: bVal.	^  self clockDataSend: data subID: 1.! !!SensorBoardMorph methodsFor: 'initialization' stamp: 'sk 9/13/2017 14:46'!initialize

	super initialize.
	sensorValues _ Array new: 16 withAll: 0.
	listTempBuf _ Array new: 8.
	currentState _ #idle.
	highByte _ 0.
	useGoGoProtocol ifNil: [useGoGoProtocol _ false].
	scratchBoardV3 _ false.
	reportRaw _ false.
	scanState _ #off.
	self addReadouts.
	disconnected _ false.
	retrySend _ 3.
	timeoutSend _ 50.
	resCommand _ 0.
	onSyncServo _ false.
	lockSend _ Semaphore forMutualExclusion.
	lockSync _ Semaphore forMutualExclusion.
! !!SensorBoardMorph methodsFor: 'initialization' stamp: 'KK 8/27/2013 19:58'!selectPort:  portNum	self stopReadingData.	self openPort: portNum.	self startReadingData.	scanState _ #on.	ResetCounter _ 0.! !!SensorBoardMorph methodsFor: 'accessing' stamp: 'KK 9/5/2017 12:29'!checkSvmFifo	| block |	(servoMotorBlockFIFO size = 0) ifTrue: [^ nil.].	block _ servoMotorBlockFIFO at:1.	^ block.! !!SensorBoardMorph methodsFor: 'accessing' stamp: 'KK 9/6/2017 13:04'!initSyncProc	"Transcript show:'hello SensorBoardMorph::initSyncProc';cr."	servoMotorBlockFIFO _ OrderedCollection new.	onSyncServo _ false.	lockSend _ Semaphore forMutualExclusion.	lockSync _ Semaphore forMutualExclusion.! !!SensorBoardMorph methodsFor: 'accessing' stamp: 'sk 8/31/2017 08:49'!isOnSyncServo	^ onSyncServo! !!SensorBoardMorph methodsFor: 'accessing' stamp: 'sk 8/31/2017 09:43'!lockSync	^ lockSync! !!SensorBoardMorph methodsFor: 'accessing' stamp: 'KK 9/6/2017 11:48'!popSvmFifo	| block |	(servoMotorBlockFIFO size = 0) ifTrue: [^ nil.].	block _ servoMotorBlockFIFO at:1.	servoMotorBlockFIFO removeFirst."Transcript show:servoMotorBlockFIFO contents;cr."	^ block.! !!SensorBoardMorph methodsFor: 'accessing' stamp: 'KK 9/6/2017 12:18'!pushSvmFifo: block	" Push block to FIFO if block doesn't exist in FIFO. Return true: block is pushed in FIFO, false: block exists in FIFO."	| find |	find _ servoMotorBlockFIFO select: [:each | each = block].	((find size) = 0) ifTrue: [		servoMotorBlockFIFO add: block."		Transcript show:'<<<<';show:block;cr."		^ true.	] ifFalse: [		^ false.	].! !!SensorBoardMorph methodsFor: 'accessing' stamp: 'sk 8/31/2017 12:13'!startSyncServo	onSyncServo _ true! !!SensorBoardMorph methodsFor: 'sensor ops' stamp: 'KK 8/29/2013 13:43'!privateSensor: t1 	| t2 t3 |	t2 _ (t1 asInteger max: 1)				min: readouts size."	useGoGoProtocol		ifFalse: [scratchBoardV3				ifTrue: [t2 _ #(8 6 7 4 5 3 2 1 ) at: t2]				ifFalse: [t2 _ #(1 2 3 4 5 6 7 8 9) at: t2]]."	t3 _ sensorValues at: t2.	reportRaw _ true.			" return Rawdata "	reportRaw ifTrue: [^ t3].	scratchBoardV3		ifTrue: 			[t2 = 6 ifTrue: [^ self scaleLight: t3].			t2 = 7 ifTrue: [^ self scaleSound: t3]].	t3 > 1020 ifTrue: [t3 _ 1023].! !!SensorBoardMorph methodsFor: 'stepping' stamp: 'sk 9/13/2017 13:59'!step
	"Update my title and sensor readouts. If scanning for ports, keep scanning."

	| frame i |
	(BoardType = 0) ifTrue: [

	#checkData = scanState ifTrue: [self scanForPort].
	self portIsOpen
		ifTrue: [self processIncomingData]
		ifFalse: [port _ nil.
"Transcript show: '[SensorBoardMorph::setp] port is nil';cr."
		].

	]
	ifFalse: [
		self socketIsOpen ifTrue: [
			self processIncomingData2]
		ifFalse: [
			port _ nil.
			Transcript show: 'sb socket is not open.'; cr.	].].

	self updateTitle.

"	1 to: 8 do: [:i |"
"	1 to: readouts size do: [:i |"
	readouts do: [:item |
		i _ readouts find: item.
		(BoardType = 1 &  i = (readouts size)) ifTrue: [  " Only for Studuino mini Battery Voltage. "
			item contents: (self privateSensor: i) printString]
		ifFalse: [
			item contents: (self privateSensor: i) printString].
		(scratchBoardV3 and: [i = 4])
			ifTrue: [(readouts at: i) contents: ((self privateSensor: i) < 10) printString]. "button"
		frame _ (readouts at: i) owner.
		(frame respondsTo: #fixLayout) ifTrue: [frame fixLayout]].

! !!SensorBoardMorph methodsFor: 'serial port' stamp: 'sk 9/28/2017 17:50'!closeForDisconnection	self dummyStop.	disconnected _ true.	currentState _ #idle.	sensorValues atAllPut: 0.	scratchBoardV3 _ false.	readouts do: [:elm | elm contents: '0'].	scanState _ #off.	self step.! !!SensorBoardMorph methodsFor: 'serial port' stamp: 'sk 9/28/2017 17:50'!closePort	self dummyStop.	port ifNotNil: [		"self data:0 msgID:7."	"Send End of Communication to PC"		port flushInputBuffer.		port close].	port _ nil.	currentState _ #idle.	sensorValues atAllPut: 0.	scratchBoardV3 _ false.	readouts do: [:elm | elm contents: '0'].	scanState _ #off.	self step.! !!SensorBoardMorph methodsFor: 'serial port' stamp: 'sk 9/28/2017 18:31'!data: d msgID: id	"I make message and send it to board."	| mid high low msgh msgl msg carry sendMessage checksum |	(BoardType = 0) ifTrue: [		(self portIsOpen) ifFalse: [ ^0. ].]	ifFalse: [		(self socketIsOpen) ifFalse: [^0. ].].	mid _ id bitShift: 4.			 " mid = id << 4 "	high _ d bitShift: -8.		 " high = d >> 8""Transcript show:'high:'; show:high;cr."	carry _ d bitShift: -7.		 " low side carry = d >> 7""Transcript show:'carry:'; show:carry;cr."	carry _ carry bitAnd: 16r01.	 " carry = carry & 0x01""Transcript show:'carry:'; show:carry;cr."	high _ high + carry.		 " high = high + carry""Transcript show:'high:'; show:high;cr.""	high _ d bitShift: -7."	high _ high bitAnd: 16r0F.	" high = high & 0x0F"	low _ d bitAnd: 16r7F.		" low = d & 0x7F"	msgh _ 16r80 + mid + high.	" msgh = 0x80 + mid + high"	msgl _ low.					" msgl = low"	msg _ #(0 0 0) asByteArray.	msg at: 1 put:msgh.	msg at: 2 put: msgl.	(BoardType = 0) ifTrue: [		checksum _ (msgh + msgl) bitAnd: 16rFF.		msg at: 3 put: checksum.		self sendStuduinoData: msg ]	ifFalse: [		sendMessage _ String fromBytes: msg.		sendMessage _ 'REQSEND', sendMessage.		socketCommand sendCommand: sendMessage.		"self stopStepping."		socketCommand getResponseShowing: true.   "Waiting ACK"		"self startStepping.""		socket sendCommand: 'REQSEND'.		socket sendCommand: (String fromBytes: msg)."].! !!SensorBoardMorph methodsFor: 'serial port' stamp: 'sk 9/28/2017 18:40'!dummySend	" Sending a dummy command repeatedly so that Studuino returning a response.	  It is necessary to prevent from being disconnected automatically. "	| msg |	" Making a dummy command (0xD4 0x00 0xD: version check command.) "	msg _ #(0 0 0) asByteArray.	msg at: 1 put: 16rD4.	msg at: 3 put: 16rD4.	processDummySend _ [		[true] whileTrue: [			self sendStuduinoData: msg.			(Delay forMilliseconds: 100) wait]] fork.! !!SensorBoardMorph methodsFor: 'serial port' stamp: 'sk 9/28/2017 17:49'!dummyStop	processDummySend ifNotNil: [		processDummySend terminate.		processDummySend _ nil]! !!SensorBoardMorph methodsFor: 'serial port' stamp: 'sk 8/31/2017 11:51'!isBoardSetup	"Answer true if a Arduino Board is connected to serial port."	| buf temp start timeOut |	temp _ port flushInputBuffer.	(temp = -1) ifTrue: [Transcript show:'error1';cr.		^ false.	].	self sendForInit.	buf _ port readByteArray.	(buf) ifNil: [Transcript show:'error2';cr.		^ false.	].	timeOut _ 4000.	start _ Time millisecondClockValue.	[buf size = 0] whileTrue: [		(Delay forMilliseconds: 500) wait.		self sendForInit.		buf _ port readByteArray.		(buf) ifNil: [			^ false.		].		(Time millisecondClockValue - start > timeOut) ifTrue: [			Transcript show: 'Time out'; cr.			^ false].	].	^ true.! !!SensorBoardMorph methodsFor: 'serial port' stamp: 'sk 8/30/2017 15:33'!openPort: aString	"Close the serial port if it is open, then open the port with the given name and initialize streaming of sensor data. Answer true if the operation was successful."	| baudRate portNum numStart |	baudRate _ useGoGoProtocol ifTrue: [9600] ifFalse: [115200].	self closePort.	portName _ aString.	ScratchPlugin serialPortOpsAvailable		ifTrue: [			port _ SerialPort2 new openPortNamed: portName baud: baudRate.			port isOpen ifFalse: [port _ nil. ^ false].			port setOption: 20 to: 1.  "set DTR high"			port setOption: 21 to: 0]  "set RTS low"		ifFalse: [			portNum _ 1.			numStart _ (1 to: portName size) detect: [:i | (portName at: i) isDigit] ifNone: [0].			numStart > 0 ifTrue: [portNum _ (portName copyFrom: numStart to: portName size) asNumber].			port _ SerialPort new				baudRate: baudRate;				inputFlowControlType: 2;				openPort: portNum ifFail: [^ false]].	"initialize polling state"	lastPollMSecs _ Time millisecondClockValue.	^ true! !!SensorBoardMorph methodsFor: 'serial port' stamp: 'sk 8/9/2016 15:51'!processIncomingData	"Process incoming bytes from the serial port."	"Details: To work around a problem with the Prolific USB-Serial drivers on some Windows machines, a strict turn-taking polling protocol is used. A poll byte is sent, the ScratchBoard sends a response, and after a small delay (to be sure that all the data from the last poll has arrived, another poll is sent. The goal is to never allow more that few bytes to accumulate in the serial input buffer and to avoid sending a poll byte while data is arriving. However, since different versions of the ScratchBoard may send different amounts of data, we don't want to hard-code the number of reply bytes. Thus"	| buf msecsSinceLastPoll |	(self portIsOpen and: [#on = scanState]) ifFalse: [^ self].	useGoGoProtocol ifTrue: [		buf _ port readByteArray.		buf do: [:b | self processGoGoByte: b].		^ self].	msecsSinceLastPoll _ Time millisecondClockValue - lastPollMSecs.	msecsSinceLastPoll < 20 ifTrue: [^ self].	buf _ port readByteArray.	(buf size = 0) ifTrue: [	" The case of disconnection "		" Increment ResetCounter "		ResetCounter _ (ResetCounter + 1).		(ResetCounter = 20) ifTrue: [			ResetCounter _ 0.			self closeForDisconnection.			ScratchFrameMorph displayMessageDialog: '33']]	ifFalse: [		ResetCounter _ 0].	buf do: [:b | self processScratchByte: b]."	port nextPut: 1."	"send a ScratchBoard V4 poll byte"	lastPollMSecs _ Time millisecondClockValue.! !!SensorBoardMorph methodsFor: 'serial port' stamp: 'sk 3/3/2016 12:08'!processIncomingData2	"Process incoming bytes from the socket."	| buf msecsSinceLastPoll |	(self socketIsOpen) ifFalse: [^ self].	msecsSinceLastPoll _ Time millisecondClockValue - lastPollMSecs.	msecsSinceLastPoll < 20 ifTrue: [^ self].	buf _ self readByteArrayFromSocket.	(buf size = 0) ifTrue: [	" The case of disconnection "		" Increment ResetCounter "		ResetCounter _ (ResetCounter + 1)."Transcript show:'[Reset counter]';show:ResetCounter;cr."		(ResetCounter = 20) ifTrue: [			ResetCounter _ 0.			self closeSocket.			ScratchFrameMorph displayMessageDialog: '33'.		].	] ifFalse: [		ResetCounter _ 0.	].	buf do: [:b |		self processScratchByte: b.Transcript show: b; cr.		]."	port nextPut: 1."	"send a ScratchBoard V4 poll byte"	lastPollMSecs _ Time millisecondClockValue.! !!SensorBoardMorph methodsFor: 'serial port' stamp: 'sk 3/9/2016 19:27'!readByteArrayFromSocket	"Answer a ByteArray read from this serial port. Answer an empty ByteArray if no data is available. The socket must be open."	| buf line res |	socket ifNil: [^ ByteArray new].	socket sendCommand: 'REQDATA'.	line _ socket getResponseShowing: true.	res _ line sansPeriodSuffix.	buf _ res asByteArray.	^ buf! !!SensorBoardMorph methodsFor: 'serial port' stamp: 'KK 9/9/2013 11:55'!resetPort	"If the port is closed, do nothing. If it is open, close and reopen it. This can be used to reset the Prolific USB serial driver if it misbehaves."	self portIsOpen ifFalse: [^ self].	portName ifNil: [^ self].Transcript show: '[SensorBoardMorph::resetPort] before closePort';cr.	self closePort.	self openPort: portName.	scanState _ #on."Transcript show: '[SensorBoardMorph::resetPort] before step';cr.	self step."! !!SensorBoardMorph methodsFor: 'serial port' stamp: 'KK 8/16/2013 14:41'!selectPort	| menu choice |	self stopReadingData.	self portNames size = 0 ifTrue: [^ DialogBoxMorph inform: 'No serial ports found'].	menu _ CustomMenu new.	self portNames do: [:n | menu add: n action: n].	choice _ menu startUp.	choice ifNil: [^ self].	self openPort: choice.	self startReadingData.	scanState _ #on.	ResetCounter _ 0.! !!SensorBoardMorph methodsFor: 'serial port' stamp: 'sk 8/31/2017 11:42'!sendForInit	| msg |	msg _ #(0 0 0) asByteArray.	msg at: 1 put: 16rD4.	msg at: 2 put: 0.	msg at: 3 put: 16rD4.	port nextPutAll: msg.! !!SensorBoardMorph methodsFor: 'serial port' stamp: 'sk 9/28/2017 18:42'!sendStuduinoData: aByteArray	| startTime |	lockSend critical: [		resCommand _ 0.		3 timesRepeat: [	" Retry when a response is not 'ACK'. "			port nextPutAll: aByteArray.			startTime _ Time millisecondClockValue.			" Waiting a reponse with timeout of 100ms. "			[resCommand = 0 and: [(Time millisecondClockValue - startTime) > 100]]				whileTrue: [					self processIncomingData.					Delay forMilliseconds: 10	].			(resCommand = 1) ifTrue: [^ self]]]! !!SensorBoardMorph methodsFor: 'event handling' stamp: 'KK 9/21/2013 16:55'!rightButtonMenu	| |"	menu _ CustomMenu new.	Sensor shiftPressed		ifTrue: [			reportRaw				ifTrue: [menu add: 'stop reporting raw data' action: #toggleRawMode]				ifFalse: [menu add: 'report raw data' action: #toggleRawMode].			useGoGoProtocol				ifTrue: [menu add: 'use Scratch board' action: #useScratchboardProtocol]				ifFalse: [menu add: 'use GoGo board' action: #useGoGoProtocol]]		ifFalse: [			menu add: 'select serial/USB port' action: #selectPort.			self portIsOpen				ifTrue: [menu add: 'close port' action: #stopReadingData].			menu addLine.			menu add: 'hide' action: #delete].	menu localize; invokeOn: self."! !!SensorBoardMorph methodsFor: 'object i/o' stamp: 'sk 6/8/2016 14:26'!disconnected	^ disconnected! !!SensorBoardMorph methodsFor: 'object i/o' stamp: 'sk 6/8/2016 14:33'!disconnected: aBoolean	disconnected _ aBoolean.! !!SensorBoardMorph methodsFor: 'private' stamp: 'sk 3/24/2016 21:15'!closeSocket	| |socket ifNotNil: [	socketCommand sendCommand: 'BREAK'.	socketCommand disconnect.	socketCommand destroy.	socketCommand _ nil.	" Send message "	Transcript show: '---------- Sending ----------'; cr.	socket sendCommand: 'BREAK'.	socket disconnect.	socket destroy.	socket _ nil].	currentState _ #idle.	sensorValues atAllPut: 0.	scratchBoardV3 _ false."	1 to: 8 do: [:i | (readouts at: i) contents: '0']."	1 to: readouts size do: [:i | (readouts at: i) contents: '0'].	scanState _ #off.! !!SensorBoardMorph methodsFor: 'private' stamp: 'sk 9/14/2017 17:22'!convertAccelerometer: aValue

	| val |
	val _ aValue.
	aValue > 127 ifTrue: [
		val _ aValue - 256].
	^ (val + 128) * 100 // 255
! !!SensorBoardMorph methodsFor: 'private' stamp: 'sk 9/14/2017 14:05'!convertToCelcius: aValue

	^ (((aValue / 1024) * 3.3) - 0.5) / 0.01! !!SensorBoardMorph methodsFor: 'private' stamp: 'KK 9/26/2017 14:26'!processScratchByte: aByte
	"Process one byte of the incoming data stream from a Scratch sensor board."
	"Sensor messages are two bytes with the following format:
		Byte1: <1><sensor number (4 bits)><sensor value high bits (3 bits)>
		Byte2: <0><sensor value low bits (7 bits)>"

	| sensorNum val dtype isExtendedRead pos obj |
"
Transcript
show:'processScratchByte';cr.
"
	(aByte bitShift: -6) = 2 ifTrue: [
		dtype _ aByte bitAnd: 16r3F.
		dtype = 0 ifTrue: [	"ACK"
			resCommand _ 1].
		dtype = 1 ifTrue: [	"NACK"
			resCommand _ -1].
		dtype = 16r3F ifTrue: [	"syncFinish"
			onSyncServo _ false].
		^ self].

	"Extended data coming."
	isExtendedRead _ false.
	(aByte bitShift: -6) = 3 ifTrue: [
		isExtendedRead _ true].

	currentState = #idle ifTrue: [  "wait for first byte of message"
		(aByte bitShift: -6) = 0 ifTrue: [
			currentState _ #firstByteSeen.
			highByte _ aByte].
		^ self].

	currentState = #firstByteSeen ifTrue: [
		(aByte bitShift: -6) = 0 ifTrue: [  "must have lost second byte; stay in firstByteSeen state"
			highByte _ aByte.
			^ self].

		"good second byte: report the sensor value"
		sensorNum _ ((highByte bitShift: -2) bitAnd: 16rF) + 1.
		val _ ((highByte bitAnd: 3) bitShift: 6) + (aByte bitAnd: 16r3F).

		" Checking an extended data. "
		sensorNum <= 8 ifTrue: [
			(IOPort at: (10 + sensorNum)) = 16r18  "Temperature sensor"
				ifTrue: [
					isExtendedRead
						ifFalse: [
							secondByte _ aByte.
							^ self].
					val _ ((highByte bitAnd: 3) bitShift: 6) + (secondByte bitAnd: 16r3F).
					val _ val + ((aByte bitAnd: 16r3F) bitShift: 8)]].

(val = 128) ifTrue: [
"
Transcript
show:'[SensorBoardMorph::processScratchByte:] ';
show:sensorNum; show:', '; show:val;cr.
"
^ self.
].

		(val = 128) ifTrue: [ val _ 0. ].	" 128 is open port or output parts "
		
		(BoardType = 1) & (sensorNum = (readouts size)) ifTrue: [
			val _ (val / 10.0)].

		sensorNum <= sensorValues size ifTrue: [
			pos _ sensorNum.
			((sensorNum = 7 ) | (sensorNum = 8))
				ifTrue: [
					(readouts size ) > 8 ifTrue: [ pos _ sensorNum + 1]]. "A6/A7 position increment"
			sensorNum > 8
				ifTrue: [
					pos _ sensorNum - 4.  "Accelerometer readout position to 4/5/6"
					val _ self convertAccelerometer: val]
				ifFalse: [
					(IOPort at: (10 + sensorNum)) = 16r18
						ifTrue: [
							obj _ listTempBuf at: sensorNum.
							val _ (obj average: (self convertToCelcius: val)) asFloat.]].
			sensorValues at: pos put: val.
			sensorNum = 16 ifTrue: [
				(val == 3) | (val == 4) ifTrue: [
					scratchBoardV3 _ true]]].  "ScratchBoard, version 3 or 4"

		currentState _ #idle].
! !!SensorBoardMorph methodsFor: 'private' stamp: 'KK 8/28/2013 08:51'!readByteArray	"Answer true if a GoGoBoard is connected to my serial port."	| buf |	port flushInputBuffer.	^ buf _ port readByteArray.! !!SensorBoardMorph methodsFor: 'private' stamp: 'sk 3/25/2016 20:17'!socket: mSocket	"Answer true if a GoGoBoard is connected to my serial port."	socket _ mSocket.	scanState _ #on.	"initialize polling state"	lastPollMSecs _ Time millisecondClockValue.! !!SensorBoardMorph methodsFor: 'private' stamp: 'sk 3/10/2016 19:52'!socketCommand: mSocket	socketCommand _ mSocket.! !!SensorBoardMorph methodsFor: 'private' stamp: 'sk 3/3/2016 10:49'!socketIsOpen	^ socket notNil! !!SensorBoardMorph methodsFor: 'private' stamp: 'KK 9/21/2013 17:04'!updateTitle	"Update my title to reflect the current protocol and port number."	| s |	s _ (#on = scanState) ifTrue: ['Sensor Board' localized] ifFalse: ['Off' localized].	s = titleMorph contents ifFalse: [titleMorph contents: s].! !!SerialPort methodsFor: 'input/output' stamp: 'KK 8/9/2013 19:00'!readByteArray	"Answer a ByteArray read from this serial port. Answer an empty ByteArray if no data is available. The port must be open."	| buf count |	buf _ ByteArray new: 2000.	count _ self primReadPort: port into: buf startingAt: 1 count: buf size.	count <= 0 ifTrue: [^ ByteArray new].	^ buf copyFrom: 1 to: count! !!SerialPort2 methodsFor: 'input/output' stamp: 'KK 8/28/2013 08:34'!nextPutAll: aStringOrByteArray	"Send the given bytes out this serial port. The port must be open."	self isOpen ifFalse: [^ self].	ScratchPlugin writePort: portNum data: aStringOrByteArray.! !!SerialPort2 methodsFor: 'input/output' stamp: 'KK 9/6/2013 11:49'!readByteArray	"Answer a ByteArray read from this serial port. Answer an empty ByteArray if no data is available. The port must be open."	| buf count |	self isOpen ifFalse: [^ ByteArray new].	buf _ ByteArray new: 2000.	count _ ScratchPlugin readPort: portNum into: buf.	count <= 0 ifTrue: [^ ByteArray new].	^ buf copyFrom: 1 to: count! !!SetterBlockMorph methodsFor: 'initialization' stamp: 'KK 9/18/2013 19:10'!initSetterForVar: varName	self commandSpec: (ScratchTranslator translationFor: 'set %v to %n').	argPermutation _ CommandBlockMorph argPermutationForSpec: 'set %v to %n' withTranslation: commandSpec.	self selector: #setVar:to:.	self variable: varName.! !!SettingMenu methodsFor: 'accessing' stamp: 'sk 5/15/2017 11:20'!select: aNumber	(boxes at: aNumber) on! !!SettingMenu methodsFor: 'accessing' stamp: 'sk 5/15/2017 11:16'!selected	boxes do: [:elm |		elm isOn ifTrue: [			^ boxes indexOf: elm]]! !!SettingMenu methodsFor: 'display' stamp: 'sk 5/15/2017 09:51'!show	| resp |	resp _ diag getUserResponse.! !!SettingMenu methodsFor: 'display' stamp: 'sk 5/15/2017 11:32'!showAndWaitingResponse	| resp |	resp _ diag getUserResponse.	resp = #cancelled ifTrue: [		^ nil]	ifFalse: [		^ self selected]! !!SettingMenu methodsFor: 'initialization' stamp: 'sk 5/23/2017 16:40'!initialize	| setting calib0 calib1 |	diag _ DialogBoxMorph new		withButtonsForYes: false no: false okay: true cancel: true;		title: 'Calibration Setting Options';		message: ''.	boxes _ OrderedCollection new.	calib0 _ 'PC (default)', String cr,		'Keep your Sermotor calibrations even when you restart your computer or make a new program by saving them to your PC.'.	calib1 _ 'File', String cr,		'Save your Servomotor calibrations to a file. You''ll need to calibrate them each time you restart your PC or open a new file.'.	setting _ OrderedCollection new.	setting add: calib0; add: calib1.	self addEntries: setting.! !!SettingMenu methodsFor: 'private' stamp: 'sk 5/22/2017 15:28'!addEntries: aList	| cont title |	cont _ AlignmentMorph new.	cont orientation: #Vertical;		borderWidth: 1;		color: (Color transparent)."	title _ StringMorph contents: 'Motor calibration store location.' localized				font: (ScratchFrameMorph getFont: #Label).	cont addMorphBack: title."	aList do: [: elm |		cont addMorphBack: (self cboxWithDescription: elm)].	diag addMessageLine: cont.! !!SettingMenu methodsFor: 'private' stamp: 'sk 5/22/2017 15:30'!cboxWithDescription: aDescription	"comment stating purpose of message"	| al cbox descMorph |	al _ AlignmentMorph new centering: #center.	al color: (Color transparent).	cbox _ ToggleButton new		onForm: (ScratchFrameMorph skinAt: #radioButtonOn)		offForm: (ScratchFrameMorph skinAt: #radioButton)		overForm: nil		disabledForm: (ScratchFrameMorph skinAt: #radioButtonOn).	cbox target: self; actionSelector: #check:; arguments: (Array with: cbox).	boxes add: cbox.	descMorph _ MultilineStringMorph new		isEditable: false;		borderWidth: 0;		extent: (300@0);		growWithText: true;		contents: aDescription localized.	al addMorph: cbox.	al addMorphBack: (Morph new extent: 10@0).	al addMorphBack: descMorph.	^ al! !!SettingMenu methodsFor: 'private' stamp: 'sk 5/15/2017 10:47'!check: aBox	| |	boxes do: [: elm|		elm == aBox ifTrue: [			elm isDisabled: true]		ifFalse: [			elm off.			elm isDisabled: false]]! !!SettingMenu class methodsFor: 'instance creation' stamp: 'sk 5/15/2017 11:20'!showWith: aNumber	^ self new select: aNumber; showAndWaitingResponse.! !!SimpleButtonMorph methodsFor: 'initialization' stamp: 'KK 9/27/2017 17:21'!initialize	self initializeAllButLabel.	self setDefaultLabel.! !!SimpleButtonMorph methodsFor: 'events' stamp: 'KK 9/27/2017 17:25'!mouseDown: evt	| now dt |	oldColor _ color.	now _ Time millisecondClockValue.	actWhen == #buttonDown		ifTrue: [self doButtonAction].	dt _ Time millisecondClockValue - now max: 0.  "Time it took to do"	dt < 200 ifTrue: [(Delay forMilliseconds: 200-dt) wait]! !!SimpleClientSocket methodsFor: 'entry points' stamp: 'sk 7/29/2016 17:38'!getBMResponse	^ self getBMResponseFor: 30! !!SimpleClientSocket methodsFor: 'entry points' stamp: 'sk 7/29/2016 17:28'!getBMResponseFor: seconds	| line idx |	line _ WriteStream on: String new.	buffer ifNil: [		buffer _ String new.		bufferPos _ 0 ].	[		"look for a LF in the buffer"		idx _ buffer indexOf: Character lf startingAt: bufferPos+1 ifAbsent: [ 0 ].		idx > 0 ifTrue: [			"found it!! we have a line"			line nextPutAll: (buffer copyFrom: bufferPos+1 to: idx-1).			bufferPos _ idx.			^line contents ].				"didn't find it.  add the whole buffer to the line, and retrieve some more data"		line nextPutAll: (buffer copyFrom: bufferPos+1 to: buffer size).		bufferPos _ 0.		buffer _ String new.		(self waitForBMMessageEvery: seconds) ifTrue: [			buffer _ self getData.		] ifFalse: [			^ '-1'.		].		true	] whileTrue.! !!SimpleClientSocket methodsFor: 'private' stamp: 'sk 7/27/2016 19:04'!waitForBMMessageEvery: seconds	"Wait for data to arrive, asking the user periodically if they wish to keep waiting. If they don't wish to keep waiting, destroy the socket and raise an error."	| gotData |	gotData _ false.	[gotData]		whileFalse: [			gotData _ self waitForDataUntil: (Socket deadlineSecs: seconds).			gotData ifFalse: [				self isConnected ifFalse: [					self destroy.					"self error: 'server closed connection'."					ScratchFrameMorph displayMessageDialog: '12'." Display error message dialog "					^ false.				] ifTrue: [					self destroy.					"self error: 'no response from server'"					ScratchFrameMorph displayMessageDialog: '11'." Display error message dialog "					^ false.				].			]		].	^ true.! !!SpriteArgMorph methodsFor: 'other' stamp: 'KK 8/2/2013 12:59'!printArduArgOn: aStream	"Print this argument morph on the given stream."	aStream nextPutAll: 's['.	aStream nextPutAll: self labelMorph contents.	aStream nextPut: $].! !!SpriteArgMorph methodsFor: 'other' stamp: 'KK 8/2/2013 13:01'!printArgOn: aStream	"Print this argument morph on the given stream."	aStream nextPutAll: self labelMorph contents.! !!StandardFileStream class methodsFor: 'file creation' stamp: 'KK 8/21/2013 15:01'!newScratchFileNamed: fileName	"Create a new file with the given name, and answer a stream opened for writing on that file. If the file already exists, ask the user what to do."	| dir localName choice newName fullName result ext |	fullName _ self fullName: fileName.	(self isAFileNamed: fullName) ifFalse: [		result _ self new open: fullName forWrite: true.		result ifNil: [DialogBoxMorph inform: 'Could not write file' withDetails: 'Is the folder read-only?' localized].		^ result].	"file already exists:"	dir _ FileDirectory forFileName: fullName.	localName _ FileDirectory localNameFor: fullName.	choice _ DialogBoxMorph		askWithCancel: 'The file name already exists. Overwrite existing file?'.	choice = #cancelled ifTrue: [^ nil].	choice		ifTrue: [			dir deleteFileNamed: localName ifAbsent: [].			result _ self new open: fullName forWrite: true.			result ifNil: [DialogBoxMorph inform: 'Could not write file' withDetails: 'Is the folder read-only?' localized].			^ result]		ifFalse: [			newName _ StringDialog askWithCancel: 'New file name?'.			newName size = 0 ifTrue: [^ nil].			fullName _ dir fullNameFor: newName.			ext _ FileDirectory extensionFor: fileName.			(ext size > 0 and: [(newName endsWith: ext) not]) ifTrue: [				fullName _ fullName, '.', ext].			^ self newScratchFileNamed: fullName].! !!CrLfFileStream class methodsFor: 'class initialization' stamp: 'KK 1/7/2015 17:23'!newScratchFileNamed: fileName	"Create a new file with the given name, and answer a stream opened for writing on that file. If the file already exists, ask the user what to do."	| dir localName choice newName fullName result ext |	fullName _ self fullName: fileName.	(self isAFileNamed: fullName) ifFalse: [		result _ self new open: fullName forWrite: true.		result ifNil: [DialogBoxMorph inform: 'Could not write file' withDetails: 'Is the folder read-only?' localized].		^ result].	"file already exists:"	dir _ FileDirectory forFileName: fullName.	localName _ FileDirectory localNameFor: fullName.	choice _ DialogBoxMorph		askWithCancel: 'The file name already exists. Overwrite existing file?'.	choice = #cancelled ifTrue: [^ nil].	choice		ifTrue: [			dir deleteFileNamed: localName ifAbsent: [].			result _ self new open: fullName forWrite: true.			result ifNil: [DialogBoxMorph inform: 'Could not write file' withDetails: 'Is the folder read-only?' localized].			^ result]		ifFalse: [			newName _ StringDialog askWithCancel: 'New file name?'.			newName size = 0 ifTrue: [^ nil].			fullName _ dir fullNameFor: newName.			ext _ FileDirectory extensionFor: fileName.			(ext size > 0 and: [(newName endsWith: ext) not]) ifTrue: [				fullName _ fullName, '.', ext].			^ self newScratchFileNamed: fullName].! !!StringDialog methodsFor: 'initialization' stamp: 'KK 9/1/2014 12:01'!initialize	"Similar to my superclass, but with a string field for the user's response."	super initialize.	self title: '?'.	"create and position typeinMorph"	ValueOrList ifTrue: [	" Value or list "		mainColumn			addMorph: (Morph new extent: (5@6); color: Color transparent);			addMorph: (typeinMorph _ AlphamericFieldMorph				new client: self;				borderWidth: 2;				color: (Color r: (211/255) g: (214/255) b: (216/255)));			addMorph: (Morph new extent: (5@6); color: Color transparent).	] ifFalse: [	" Not value or list "		mainColumn			addMorph: (Morph new extent: (5@6); color: Color transparent);			addMorph: (typeinMorph _ StringFieldMorph				new client: self;				borderWidth: 2;				color: (Color r: (211/255) g: (214/255) b: (216/255)));			addMorph: (Morph new extent: (5@6); color: Color transparent).	].		typeinMorph		font: (ScratchFrameMorph getFont: #StringDialogTypeIn);		width: 250.	tabFields add: typeinMorph.! !!StringDialog methodsFor: 'interaction' stamp: 'sk 2/20/2017 18:00'!getUserResponse	"Wait for the user to type in and accept a string, then report that string. Answer the empty string if the user cancels the operation."	"Details: This is invoked synchronously from the caller. In order to keep processing inputs and updating the screen while waiting for the user to respond, this method has its own version of the World's event loop."	| w |	self openInWorld.	TabletMode ifTrue: [		self topCenterOnScreen]	ifFalse: [		self centerOnScreen].	w _ self world.	w activeHand newKeyboardFocus: typeinMorph.	done _ false.	[done] whileFalse: [w doOneCycle].  "wait for user to press a button"	self delete.	w doOneCycle.  "erase myself from the screen"	response = #cancelled		ifTrue: [^ '']		ifFalse: [^ typeinMorph contents asString].! !!StringDialog class methodsFor: 'instance creation' stamp: 'KK 9/1/2014 11:39'!ask: questionString	"Put up an instance of me to ask the user for string input (such as file name). Answer the edited string."	^ self askWithCancel: questionString initialAnswer: ''! !!StringDialog class methodsFor: 'instance creation' stamp: 'KK 9/1/2014 11:39'!ask: questionString initialAnswer: aString	"Put up an instance of me to ask the user for string input (such as file name). The initial response text is set to the given string, which the user can replace or edit. Answer the edited string."	| dialogBox |	dialogBox _ self new		withButtonsForYes: false no: false okay: true cancel: false;		message: questionString;		initialAnswer: aString.	^ dialogBox getUserResponse! !!StringDialog class methodsFor: 'instance creation' stamp: 'KK 9/1/2014 11:39'!askWithCancel: questionString	"Like ask:, but with a cancel button. Answer the empty string if cancelled."	^ self askWithCancel: questionString initialAnswer: ''! !!StringDialog class methodsFor: 'instance creation' stamp: 'KK 12/17/2013 18:02'!askWithCancel: questionString initialAnswer: aString	"Put up an instance of me to ask the user for string input (such as file name). The initial response text is set to the given string, which the user can replace or edit. This version includes a cancel button. Answer the empty string if cancelled."	| dialogBox |	dialogBox _ self new		withButtonsForYes: false no: false okay: true cancel: true;		message: questionString;		initialAnswer: aString.	^ dialogBox getUserResponse! !!StringFieldMorph methodsFor: 'event handling' stamp: 'KK 5/12/2014 17:00'!keyStroke: evt	| ch m |	ch _ evt unicodeChar.	ch = 0 ifTrue: [ch _ evt keyValue].	evt buttons = 64 ifTrue: [ch _ ch \\ 32].  "command (alt) key pressed; map to a control key"	(ch = 3) & (evt buttons = 0) ifTrue: [ch _ 13].  "map enter key to cr"	ch = 9 ifTrue: [  "tab"		(m _ self ownerThatIsA: DialogBoxMorph) ifNotNil: [m tabToNextField: evt].		(m _ self ownerThatIsA: CommandBlockMorph) ifNotNil: [m tabToNextField: evt].		^ self].	(ch = 10) | (ch = 13) ifTrue: [  "cr, lf, or enter key"		(m _ self ownerThatIsA: DialogBoxMorph) ifNotNil: [^ m enterKeyPressed: evt].		(m _ self ownerThatIsA: ScratchPrompterMorph) ifNotNil: [^ m enterKeyPressed].		(m _ self ownerThatIsA: NumericUpDownMorph) ifNotNil: [ ^ m enterKeyPressed].		evt hand newKeyboardFocus: nil.		^ self].	ch = 27 ifTrue: [  "escape key"		(m _ self ownerThatIsA: DialogBoxMorph) ifNotNil: [m escapeKeyPressed: evt].		^ self].	ch = 8 ifTrue: [^ self backspace].	ch = 127 ifTrue: [^ self deleteSelection].	(evt buttons = 64) | (evt buttons = 16) ifTrue: [	"ctrl (or alt) is pressed"		ch = 1 ifTrue: [self selectAll].		"ctrl-a"		ch = 3 ifTrue: [self copySelection]. 	"ctrl-c"		ch = 22 ifTrue: [self paste].			"ctrl-v"		ch = 24 ifTrue: [self cutSelection].	"ctrl-x"		ch = 26 ifTrue: [self undo]].			"ctrl-z"	evt buttons = 8 ifTrue: [ "shift is pressed"		ch = 28 ifTrue: [self moveCursorLeftAndSelect].  	"shift-left"		ch = 29 ifTrue: [self moveCursorRightAndSelect].	"shift-right"		ch = 1 ifTrue: [self moveCursorHomeAndSelect].	"home"		ch = 4 ifTrue: [self moveCursorEndAndSelect]].	"end"	evt buttons = 0 ifTrue: [		ch = 1 ifTrue: [self moveCursorHome].	"home"		ch = 4 ifTrue: [self moveCursorEnd].		"end"		ch = 28 ifTrue: [self moveCursorLeft].	"left"		ch = 29 ifTrue: [self moveCursorRight].	"right"		blinkState _ true].	ch >= 32 ifTrue: [self insertCharacter: ch].! !!StringFieldMorph methodsFor: 'text editing' stamp: 'sk 2/7/2017 09:07'!moveCursorAt: index	"Move the cursor to the specified index of the current line."	self recordUndoState.	selectionStart _ index within: 0 and: (stringMorph contents size).	selectionEnd _ selectionStart.	self changed.! !!StringFieldMorph methodsFor: 'private' stamp: 'sk 2/7/2017 09:11'!cursorPosition	^ selectionStart! !!AlphamericFieldMorph methodsFor: 'event handling' stamp: 'KK 9/17/2014 11:19'!keyStroke: evt	| ch m |	ch _ evt unicodeChar.	ch = 9 ifTrue: [  "tab"		(m _ self ownerThatIsA: DialogBoxMorph) ifNotNil: [m tabToNextField: evt].		(m _ self ownerThatIsA: CommandBlockMorph) ifNotNil: [m tabToNextField: evt].		^ self].	(ch = 10) | (ch = 13) ifTrue: [  "cr, lf, or enter key"		(m _ self ownerThatIsA: DialogBoxMorph) ifNotNil: [^ m enterKeyPressed: evt].		(m _ self ownerThatIsA: ScratchPrompterMorph) ifNotNil: [^ m enterKeyPressed].		(m _ self ownerThatIsA: NumericUpDownMorph) ifNotNil: [ ^ m enterKeyPressed].		evt hand newKeyboardFocus: nil.		^ self].	ch = 27 ifTrue: [  "escape key"		(m _ self ownerThatIsA: DialogBoxMorph) ifNotNil: [m escapeKeyPressed: evt].		^ self].	ch = 8 ifTrue: [^ self backspace].	ch = 127 ifTrue: [^ self deleteSelection].	(evt buttons = 64) | (evt buttons = 16) ifTrue: [	"ctrl (or alt) is pressed"		ch = 1 ifTrue: [self selectAll].		"ctrl-a"		ch = 3 ifTrue: [self copySelection]. 	"ctrl-c"		ch = 22 ifTrue: [self paste].			"ctrl-v"		ch = 24 ifTrue: [self cutSelection].	"ctrl-x"		ch = 26 ifTrue: [self undo]].			"ctrl-z"	evt buttons = 8 ifTrue: [ "shift is pressed"		ch = 28 ifTrue: [self moveCursorLeftAndSelect].  	"shift-left"		ch = 29 ifTrue: [self moveCursorRightAndSelect].	"shift-right"		ch = 1 ifTrue: [self moveCursorHomeAndSelect].	"home"		ch = 4 ifTrue: [self moveCursorEndAndSelect]].	"end"	evt buttons = 0 ifTrue: [		ch = 1 ifTrue: [self moveCursorHome].	"home"		ch = 4 ifTrue: [self moveCursorEnd].		"end"		ch = 28 ifTrue: [self moveCursorLeft].	"left"		ch = 29 ifTrue: [self moveCursorRight].	"right"		blinkState _ true].	" ch = [0-9][A-Z][a-z][_] ? "	( ((ch >= 48) & (ch <= 57)) | ((ch >= 65) & (ch <= 90)) | ((ch >= 97) & (ch <= 122)) | ((ch = 95))) ifFalse: [		^ self.	].	ch = 0 ifTrue: [ch _ evt keyValue].	evt buttons = 64 ifTrue: [ch _ ch \\ 32].  "command (alt) key pressed; map to a control key"	(ch = 3) & (evt buttons = 0) ifTrue: [ch _ 13].  "map enter key to cr"	ch >= 32 ifTrue: [self insertCharacter: ch].! !!TemperatureBuffer methodsFor: 'private' stamp: 'sk 9/13/2017 13:25'!init: size
	buffer _ Array new: size.
	currentPos _ 1.
	isRounded _ false.! !!TemperatureBuffer methodsFor: 'accessing' stamp: 'KK 9/20/2017 20:04'!average
	| sum last |
	isRounded
		ifTrue: [last _ buffer size]
		ifFalse: [
			currentPos = 1 ifTrue: [^ nil ].
			last _ currentPos - 1].
	sum _ 0.	
	1 to: last do: [:elm|
			sum _ sum + (buffer at: elm)].
	^ ((sum * 10 / last) truncated ) / 10
! !!TemperatureBuffer methodsFor: 'accessing' stamp: 'sk 9/13/2017 13:25'!clear
	self init: (buffer size)! !!TemperatureBuffer methodsFor: 'accessing' stamp: 'sk 9/13/2017 13:25'!nextPut: aValue

	buffer at: currentPos put: aValue.
	currentPos _ currentPos + 1.
	currentPos > buffer size ifTrue: [
		isRounded _ true.
		currentPos _ 1].! !!TemperatureBuffer class methodsFor: 'instance creation' stamp: 'sk 9/13/2017 13:48'!new
	"Answer a new instance of SharedQueue that has 10 elements."

	^self new: 10! !!TemperatureBuffer class methodsFor: 'instance creation' stamp: 'sk 9/13/2017 13:47'!new: anInteger 
	^super new init: anInteger! !!TemperatureSensor methodsFor: 'private' stamp: 'KK 9/26/2017 14:02'!init	ave _ 0.0.	total _ 0.! !!TemperatureSensor methodsFor: 'accessing' stamp: 'KK 9/26/2017 18:31'!average: v	total _ total + 1.	ave _ ave + ((v - ave) / total).	total > 150 ifTrue: [ total _ 100. ].	^ ((ave * 10) truncated ) / 10.0.! !!TemperatureSensor class methodsFor: 'instance creation' stamp: 'KK 9/26/2017 14:14'!new
	"Answer a new instance of SharedQueue that has 10 elements."

	^super new init! !!TextMorph methodsFor: 'editing' stamp: 'KK 8/30/2013 19:37'!handleInteraction: interactionBlock fromEvent: evt        | oldEditor oldParagraph |        "Perform the changes in interactionBlock, noting any change in selection"        "Also couple ParagraphEditor to Morphic keyboard events"        self editor sensor: (KeyboardBuffer new startingEvent: evt).        oldEditor _ editor.        oldParagraph _ paragraph.        self selectionChanged.  "Note old selection"                interactionBlock value.        oldParagraph == paragraph ifTrue: [     "this will not work if the paragraph changed"                editor _ oldEditor.     "since it may have been changed while in block"        ].        self selectionChanged.  "Note new selection"! !!ToggleButton methodsFor: 'event handling' stamp: 'sk 8/24/2015 17:00'!handlesMouseOver: evt	^ true! !!ToggleButtonForStuduino methodsFor: 'accessing' stamp: 'KK 3/20/2015 16:16'!off	| paBoard |	"Turn myself off."	super off.	(owner notNil) ifTrue: [		paBoard _ (self ownerThatIsA: PinAssignMorph).		(paBoard notNil) ifTrue: [			paBoard notifyCheckChange: owner.		].	].! !!ToggleButtonForStuduino methodsFor: 'accessing' stamp: 'KK 3/20/2015 16:13'!on	| paBoard |	"Turn myself on."	super on.	(owner notNil) ifTrue: [		paBoard _ (self ownerThatIsA: PinAssignMorph).		(paBoard notNil) ifTrue: [			paBoard notifyCheckChange: owner.		].	].! !!ToggleButtonForStuduino methodsFor: 'event handling' stamp: 'KK 4/8/2014 19:35'!handlesMouseOver: evt	^ true! !!ToggleButtonForStuduino methodsFor: 'event handling' stamp: 'KK 4/10/2014 13:05'!mouseDown: evt	| |	"If I am currently turned on, turn myself off and vice versa. If toggleMode is false, then do nothing if I am already on. If isMomentary, then turn myself off immediately. If I am to act when I'm pressed, then send my target my action selector."	evt hand toolType: nil.	isDisabled ifTrue: [^ self].	wasOn _ isOn.	actWhen == #buttonDown ifTrue: [		self doButtonAction.		wasOn ifTrue: [self off] ifFalse: [self on]].! !!ToggleButtonForStuduino methodsFor: 'initialization' stamp: 'KK 4/10/2014 13:18'!onForm: f1 offForm: f2 disabledForm: f4	onForm _ f1.	offForm _ f2.	disabledForm _ f4.	self on; off.! !!ToggleButtonForStuduino class methodsFor: 'instance creation' stamp: 'KK 4/9/2014 11:52'!onForm: f1 offForm: f2 disabledForm: f4	"Set the forms used for my on and off states."	^ self new onForm: f1 offForm: f2 disabledForm: f4! !!ToggleButtonForStuduino class methodsFor: 'instance creation' stamp: 'KK 4/9/2014 11:52'!onForm: f1 offForm: f2 overForm: f3	"Set the forms used for my on and off states."	^ self new onForm: f1 offForm: f2 overForm: f3! !!WatcherMorph methodsFor: 'private' stamp: 'KK 8/30/2013 20:16'!translatedName	"Answer the name for this watcher based on my selector and argument. The names of reporters are translated into the current language. The names of variables are left untouched."	| sel spec result param |	readout target ifNil: [^ 'xxx'].	sel _ readout getSelector.	#getVar: = sel ifTrue: [^ readout parameter].	spec _ readout target blockSpecForSelector: sel.	spec ifNil: [^ sel].	result _ ScratchTranslator translationFor: spec.	param _ readout parameter.	param ifNil: [param _ ''].	#sensor: = sel ifTrue: [		result _ self replace: '%H' with: (ScratchTranslator translationFor: param) in: result].	#sensorPressed: = sel ifTrue: [		result _ self replace: '%h' with: (ScratchTranslator translationFor: param) in: result].	^ result! !TemperatureSensor class removeSelector: #new:!TemperatureSensor removeSelector: #average!TemperatureSensor removeSelector: #clear!TemperatureSensor removeSelector: #init:!TemperatureSensor removeSelector: #nextPut:!TemperatureBuffer removeSelector: #init!DialogBoxMorph subclass: #StringDialog	instanceVariableNames: 'typeinMorph '	classVariableNames: ''	poolDictionaries: ''	category: 'Scratch-UI-Dialogs'!SimpleButtonMorph class removeSelector: #setButtonEnable:!SimpleButtonMorph removeSelector: #disabel!SimpleButtonMorph removeSelector: #disable!SimpleButtonMorph removeSelector: #enable!Morph subclass: #SensorBoardMorph	instanceVariableNames: 'socket socketCommand column titleMorph portName port readouts sensorValues currentState highByte secondByte useGoGoProtocol scratchBoardV3 reportRaw scanPorts scanState scanStartMSecs lastPollMSecs clock disconnected resCommand onSyncServo lockSend lockSync retrySend timeoutSend listTempBuf processDummySend '	classVariableNames: ''	poolDictionaries: ''	category: 'Scratch-UI-Panes'!ScriptableScratchMorph subclass: #ScratchStageMorph	instanceVariableNames: 'zoom hPan vPan penTrailsForm lastPenPositions runningBlocks inProcessStep sensorBoard servoCalibrationBoard midiPortNum midiPort notePlayerDict obsoleteSavedState sprites scratchServer isQuarterSize cachedForm showMotorBlocks showOptionBlocks '	classVariableNames: ''	poolDictionaries: ''	category: 'Scratch-Objects'!ScriptableScratchMorph removeSelector: #commonViewerPageForMotion:!ScriptableScratchMorph removeSelector: #viewerPageForMotion:!ScriptableScratchMorph removeSelector: #viewerPageForSensing:!Morph subclass: #ScriptableScratchMorph	instanceVariableNames: 'objName vars lists blocksBin isClone media costume costumeChangeMSecs filterPack visibility volume tempoBPM sceneStates '	classVariableNames: 'BlockColorDict BlockSpecDict DefaultBackgroundForm DefaultSpriteForm DoubleSize Experimental ListBlockColor MeowSound OldMeowPrefixReversed PopSound RandomGen Recorder ScratchOrigin TimerStartMSecs '	poolDictionaries: ''	category: 'Scratch-Objects'!StringMorph subclass: #ScratchMenuTitleMorph	instanceVariableNames: 'target selector '	classVariableNames: 'MenuBarIsActive MenuEnable '	poolDictionaries: ''	category: 'Scratch-UI-Support'!ScratchFrameMorph initialize!Morph subclass: #ScratchFrameMorph	instanceVariableNames: 'topPane viewerPane scriptsPane stageFrame workPane titlePane libraryPane menuPanel stageButtonsPanel readoutPane logoMorph projectTitleMorph flagButton fillScreenFlag paintingInProgress projectDirectory projectName projectInfo author loginName loginPassword watcherPositions shuffledCostumeNames justSaved viewModeButtons viewMode lastViewMode viewModeButtonsPanel toolbarPanel lastWeDoPoll versionConflict keyPad fontButtons paBoard '	classVariableNames: 'BoardStatus COMPort Clipboard DefaultNotes DefaultSprite Fonts FontsXO IsXO LangDic NewScratchProject ScratchServers ScratchSkin ScratchSkinXO TakeOverScreen UseErrorCatcher Version VersionDate VisibleDrives WorkpaneExtent '	poolDictionaries: ''	category: 'Scratch-UI-Panes'!NumericUpDownMorph initialize!NumericUpDownMorph removeSelector: #defaultValue:!NumericUpDownMorph removeSelector: #evaluate!NumericUpDownMorph removeSelector: #handlesKeyboard:!NumericUpDownMorph removeSelector: #handlesMouseDown:!NumericUpDownMorph removeSelector: #handlesMouseOver:!NumericUpDownMorph removeSelector: #initFieldsFrom:version:!NumericUpDownMorph removeSelector: #keyStroke:!NumericUpDownMorph removeSelector: #menuSelector!NumericUpDownMorph removeSelector: #menuSelector:!NumericUpDownMorph removeSelector: #mouseDown:!NumericUpDownMorph removeSelector: #mouseLeave:!NumericUpDownMorph removeSelector: #mouseMove:!NumericUpDownMorph removeSelector: #mouseUp:!NumericUpDownMorph removeSelector: #nitialize!NumericUpDownMorph removeSelector: #setDefault:!NumericUpDownMorph removeSelector: #setDefault:min:max:!NumericUpDownMorph removeSelector: #specialValue:!NumericUpDownMorph removeSelector: #step!NumericUpDownMorph removeSelector: #stepTime!NumericUpDownMorph removeSelector: #storeFieldsOn:!KeyPadMorph initialize!"Postscript:Leave the line above, and replace the rest of this comment by a useful one.Executable statements should follow this comment, and shouldbe separated by periods, with no exclamation points (!!).Be sure to put any further comments in double-quotes, like this one."" Global Variables "Smalltalk at: #BoardType put: 0.ScratchFrameMorph readSkinFrom:(FileDirectory default directoryNamed: 'ScratchSkin').ScriptableScratchMorph buildBlockSpecDictionary.Smalltalk at: #DuringTest put: false.Smalltalk at: #DuringCalib put: false.Smalltalk at: #SvCalib put: nil.Smalltalk at: #DCCalib put: nil.Smalltalk at: #IOPort put: nil.IOPort ifNil: [	IOPort _ Array new:18.].Smalltalk at: #SvDegree put: nil.Smalltalk at: #SvDegreeTemp put: nil.Smalltalk at: #SvSentAlready put: nil.Smalltalk at: #ServomotorSynchroMotion put: false.Smalltalk at: #ResetCounter put: 0.dnoPIDServomotor put: 16r02.Smalltalk at: #StdnoPIDLED put: 16r03.Smalltalk at: #StdnoPIDBuzzer put: 16r04.Smalltalk at: #StdnoPIDLightSensor put: 16r10.Smalltalk at: #StdnoPIDTouchSensor put: 16r11.Smalltalk at: #StdnoPIDSoundSensor put: 16r12.Smalltalk at: #StdnoPIDIR put: 16r13.Smalltalk at: #StdnoPIDAcceleration put: 16r14.Smalltalk at: #StdnoPIDButton put: 16r15.Smalltalk at: #StdnoPIDI2C put: 16r16.Smalltalk at: #StdnoPIDInfraredRecv put: 16r17.Smalltalk at: #StdnoPIDTemperature put: 16r18.Smalltalk at: #StdnoPIDGyro put: 16r19.Smalltalk at: #StdnoPIDUltrasonic put: 16r1A.Smalltalk at: #StdnoPIDColor put: 16r1B.Smalltalk at: #StdnoPIDBluetooth put: 16r1C.Smalltalk at: #LEDName put: 'LED'.Smalltalk at: #BuzzerName put: 'Buzzer'.Smalltalk at: #LightSensorName put: 'Light sensor'.Smalltalk at: #TouchSensorName put: 'Touch sensor'.Smalltalk at: #SoundSensorName put: 'Sound sensor'.Smalltalk at: #IRPhotoreflectorName put: 'IR photoreflector'.Smalltalk at: #UltrasonicSensorName put: 'Ultrasonic sensor'.Smalltalk at: #AccelerometerName put: 'Accelerometer'.Smalltalk at: #GyroSensorName put: 'Gyro sensor'.Smalltalk at: #ColorSensorName put: 'Color sensor'.Smalltalk at: #InfraredReceiverName put: 'Infrared receiver'.Smalltalk at: #BluetoothName put: 'Bluetooth'.Smalltalk at: #TemperatureSensorName put: 'Temperature sensor'.Smalltalk at: #I2CDeviceName put: 'I2C device'.Smalltalk at: #InfraredReceiverUsed put:-1.Smalltalk at: #UltrasonicUsed put:false.!